<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Period Filter Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding: 2rem;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        #custom-date-range {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.95) 100%);
            border: 1px solid rgba(0, 123, 255, 0.2);
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            margin-left: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .log-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="text-center mb-4">
            <i class="fas fa-chart-line text-primary me-2"></i>
            Period Filter Test
        </h1>
        
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">Time Period Filter</h5>
                    <small class="text-muted">
                        <i class="fas fa-globe-asia me-1"></i>
                        Test the new dropdown filter functionality
                    </small>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div class="dropdown">
                        <select class="form-select form-select-sm" id="period-filter" style="width: auto; min-width: 150px;">
                            <option value="week" selected>This Week</option>
                            <option value="month">This Month</option>
                            <option value="last_month">Last Month</option>
                            <option value="year">This Year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <!-- Custom Date Range Picker (initially hidden) -->
                    <div id="custom-date-range" class="d-flex align-items-center gap-2" style="display: none;">
                        <div class="input-group input-group-sm" style="width: auto;">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-calendar text-muted" style="font-size: 0.75rem;"></i>
                            </span>
                            <input type="date" class="form-control" id="custom-date-from" style="width: 140px;" title="From Date">
                        </div>
                        <span class="text-muted">to</span>
                        <div class="input-group input-group-sm" style="width: auto;">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-calendar text-muted" style="font-size: 0.75rem;"></i>
                            </span>
                            <input type="date" class="form-control" id="custom-date-to" style="width: 140px;" title="To Date">
                        </div>
                        <button class="btn btn-sm btn-primary" id="apply-custom-range" title="Apply Custom Range">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="cancel-custom-range" title="Cancel">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Current Selection:</h6>
                        <div class="alert alert-info" id="current-selection">
                            <i class="fas fa-calendar-alt me-2"></i>
                            This Week
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Simulated API Call:</h6>
                        <div class="alert alert-secondary" id="api-call">
                            <code>/mb-admin/api/statistics/?period=week</code>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-terminal me-2"></i>
                    Event Log
                </h6>
            </div>
            <div class="card-body">
                <div id="event-log" class="log-section">
                    <div class="text-muted">üéØ Period filter test initialized...</div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-outline-danger btn-sm" id="clear-log">
                        <i class="fas fa-trash me-1"></i>Clear Log
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Timezone utility functions for Dhaka, Bangladesh (UTC +6)
        const DHAKA_TIMEZONE_OFFSET = 6 * 60; // 6 hours in minutes
        
        function getDhakaTime() {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const dhakaTime = new Date(utc + (DHAKA_TIMEZONE_OFFSET * 60000));
            return dhakaTime;
        }
        
        function formatDhakaDate(date) {
            if (!date) date = getDhakaTime();
            return date.toISOString().split('T')[0]; // YYYY-MM-DD format
        }
        
        function getFirstDayOfMonth(date) {
            if (!date) date = getDhakaTime();
            return new Date(date.getFullYear(), date.getMonth(), 1);
        }
        
        // Current period selection
        let currentPeriod = 'week';
        
        function logEvent(message, type = 'info') {
            const log = document.getElementById('event-log');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            log.innerHTML += `<div class="mb-1">[${timestamp}] ${icon} ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }
        
        function updateDisplay(period, customRange = null) {
            const selectionDiv = document.getElementById('current-selection');
            const apiCallDiv = document.getElementById('api-call');
            
            let displayText = '';
            let apiUrl = `/mb-admin/api/statistics/?period=${period}`;
            
            switch(period) {
                case 'week':
                    displayText = 'This Week';
                    break;
                case 'month':
                    displayText = 'This Month';
                    break;
                case 'last_month':
                    displayText = 'Last Month';
                    break;
                case 'year':
                    displayText = 'This Year';
                    break;
                case 'custom':
                    if (customRange) {
                        displayText = `Custom Range: ${customRange.from} to ${customRange.to}`;
                        apiUrl += `&date_from=${customRange.from}&date_to=${customRange.to}`;
                    } else {
                        displayText = 'Custom Range (not applied)';
                    }
                    break;
                default:
                    displayText = 'Unknown Period';
            }
            
            selectionDiv.innerHTML = `<i class="fas fa-calendar-alt me-2"></i>${displayText}`;
            apiCallDiv.innerHTML = `<code>${apiUrl}</code>`;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            logEvent('DOM loaded, setting up event listeners...');
            
            // Set up event listener for period dropdown
            document.getElementById('period-filter').addEventListener('change', function() {
                const selectedPeriod = this.value;
                logEvent(`Period changed to: ${selectedPeriod}`);
                
                if (selectedPeriod === 'custom') {
                    // Show custom date range picker
                    document.getElementById('custom-date-range').style.display = 'flex';
                    logEvent('Custom date range picker shown');
                    
                    // Set default date range (current month) using Dhaka timezone
                    const today = getDhakaTime();
                    const firstDayOfMonth = getFirstDayOfMonth(today);
                    document.getElementById('custom-date-from').value = formatDhakaDate(firstDayOfMonth);
                    document.getElementById('custom-date-to').value = formatDhakaDate(today);
                    
                    logEvent(`Default dates set: ${formatDhakaDate(firstDayOfMonth)} to ${formatDhakaDate(today)}`);
                } else {
                    // Hide custom date range picker
                    document.getElementById('custom-date-range').style.display = 'none';
                    logEvent('Custom date range picker hidden');
                    
                    // Update current period and display
                    currentPeriod = selectedPeriod;
                    updateDisplay(currentPeriod);
                    logEvent(`Statistics would be loaded for period: ${currentPeriod}`, 'success');
                }
            });
            
            // Set up event listeners for custom date range
            document.getElementById('apply-custom-range').addEventListener('click', function() {
                const dateFrom = document.getElementById('custom-date-from').value;
                const dateTo = document.getElementById('custom-date-to').value;
                
                logEvent(`Applying custom range: ${dateFrom} to ${dateTo}`);
                
                if (!dateFrom || !dateTo) {
                    logEvent('Error: Please select both start and end dates', 'error');
                    return;
                }
                
                if (new Date(dateFrom) > new Date(dateTo)) {
                    logEvent('Error: Start date cannot be after end date', 'error');
                    return;
                }
                
                // Update display and simulate API call
                currentPeriod = 'custom';
                const customRange = { from: dateFrom, to: dateTo };
                updateDisplay(currentPeriod, customRange);
                logEvent(`Custom statistics would be loaded for: ${dateFrom} to ${dateTo}`, 'success');
            });
            
            document.getElementById('cancel-custom-range').addEventListener('click', function() {
                // Hide custom date range picker and reset dropdown
                document.getElementById('custom-date-range').style.display = 'none';
                document.getElementById('period-filter').value = currentPeriod === 'custom' ? 'week' : currentPeriod;
                
                if (currentPeriod === 'custom') {
                    currentPeriod = 'week';
                    updateDisplay(currentPeriod);
                    logEvent('Custom range cancelled, reverted to This Week', 'warning');
                } else {
                    logEvent('Custom range cancelled', 'warning');
                }
            });
            
            // Clear log button
            document.getElementById('clear-log').addEventListener('click', function() {
                document.getElementById('event-log').innerHTML = '<div class="text-muted">üßπ Log cleared...</div>';
            });
            
            // Initialize display
            updateDisplay(currentPeriod);
            logEvent('Test interface ready! üöÄ', 'success');
        });
    </script>
</body>
</html>