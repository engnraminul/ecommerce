{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Category Management - Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 text-gray-800">Category Management</h1>
    <div class="d-flex gap-2">
        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
            <i class="fas fa-plus me-1"></i> Add New Category
        </button>
        <button class="btn btn-sm btn-secondary" id="refreshCategoriesBtn">
            <i class="fas fa-sync-alt me-1"></i> Refresh
        </button>
    </div>
</div>

<!-- Filters and Search -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="m-0 fw-bold text-primary">
            <i class="fas fa-filter me-1"></i> Filters & Search
        </h6>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="searchCategories" class="form-label">Search Categories</label>
                <input type="text" class="form-control" id="searchCategories" placeholder="Search by name or description...">
            </div>
            <div class="col-md-3">
                <label for="statusFilter" class="form-label">Status</label>
                <select class="form-select" id="statusFilter">
                    <option value="">All Status</option>
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="parentFilter" class="form-label">Parent Category</label>
                <select class="form-select" id="parentFilter">
                    <option value="">All Categories</option>
                    <option value="null">Root Categories Only</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-primary btn-sm w-100" id="applyFiltersBtn">
                    <i class="fas fa-search me-1"></i> Apply
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Categories Table -->
<div class="card shadow">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 fw-bold text-primary">
            <i class="fas fa-list me-1"></i> Categories
            <span class="badge bg-secondary ms-2" id="categoriesTotalCount">0</span>
        </h6>
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-download me-1"></i> Export
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" id="exportCategoriesBtn">
                    <i class="fas fa-file-csv me-1"></i> Export as CSV
                </a></li>
            </ul>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Parent Category</th>
                        <th>Products</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="categoriesTableBody">
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading categories...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
<nav aria-label="Categories pagination" class="mt-4">
    <ul class="pagination justify-content-center" id="categoriesPagination">
        <!-- Pagination will be populated by JavaScript -->
    </ul>
</nav>

<!-- Category Details Modal -->
<div class="modal fade" id="categoryDetailsModal" tabindex="-1" aria-labelledby="categoryDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryDetailsModalLabel">Category Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-4 mb-md-0">
                        <div class="category-image-container mb-3">
                            <img id="categoryDetailImage" src="#" alt="Category Image" class="img-thumbnail" style="max-width: 200px; max-height: 200px; display: none; object-fit: cover;">
                            <div id="categoryDefaultImage" class="bg-light border rounded d-flex align-items-center justify-content-center" style="width: 200px; height: 200px;">
                                <i class="fas fa-folder fa-4x text-secondary"></i>
                            </div>
                        </div>
                        <h5 id="categoryDetailName" class="mb-1"></h5>
                        <p id="categoryDetailSlug" class="text-muted small mb-3"></p>
                        <div class="d-grid gap-2">
                            <button class="btn btn-sm btn-outline-primary" id="editCategoryBtn">
                                <i class="fas fa-edit me-1"></i> Edit Category
                            </button>
                            <button class="btn btn-sm btn-outline-danger" id="deleteCategoryBtn">
                                <i class="fas fa-trash-alt me-1"></i> Delete Category
                            </button>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="mb-3 text-primary">Basic Information</h6>
                                <dl class="row">
                                    <dt class="col-sm-5">Name</dt>
                                    <dd class="col-sm-7" id="categoryDetailNameField"></dd>
                                    
                                    <dt class="col-sm-5">Description</dt>
                                    <dd class="col-sm-7" id="categoryDetailDescription"></dd>
                                    
                                    <dt class="col-sm-5">Parent Category</dt>
                                    <dd class="col-sm-7" id="categoryDetailParent"></dd>
                                    
                                    <dt class="col-sm-5">Status</dt>
                                    <dd class="col-sm-7" id="categoryDetailStatus"></dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <h6 class="mb-3 text-primary">SEO Information</h6>
                                <dl class="row">
                                    <dt class="col-sm-5">Meta Title</dt>
                                    <dd class="col-sm-7" id="categoryDetailMetaTitle"></dd>
                                    
                                    <dt class="col-sm-5">Meta Description</dt>
                                    <dd class="col-sm-7" id="categoryDetailMetaDescription"></dd>
                                    
                                    <dt class="col-sm-5">Created</dt>
                                    <dd class="col-sm-7" id="categoryDetailCreated"></dd>
                                    
                                    <dt class="col-sm-5">Updated</dt>
                                    <dd class="col-sm-7" id="categoryDetailUpdated"></dd>
                                </dl>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <h6 class="mb-3 text-primary">Products in Category <span class="badge bg-secondary" id="categoryProductCount">0</span></h6>
                        <div id="categoryProductsList" class="list-group" style="max-height: 200px; overflow-y: auto;">
                            <!-- Products will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editCategoryBtnFooter">
                    <i class="fas fa-edit me-1"></i> Edit Category
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCategoryModalLabel">Add New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm">
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="mb-3 text-primary">Basic Information</h6>
                            
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label for="categoryName" class="form-label">Category Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="categoryName" name="name" required>
                                    <div class="invalid-feedback">Category name is required</div>
                                </div>
                                <div class="col-md-4">
                                    <label for="categorySlug" class="form-label">Slug</label>
                                    <input type="text" class="form-control" id="categorySlug" name="slug" placeholder="Auto-generated">
                                    <small class="form-text text-muted">Leave blank to auto-generate</small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="categoryDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="categoryDescription" name="description" rows="3" placeholder="Enter category description..."></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="categoryParent" class="form-label">Parent Category</label>
                                <select class="form-select" id="categoryParent" name="parent">
                                    <option value="">None (Root Category)</option>
                                </select>
                                <small class="form-text text-muted">Select a parent category to create a subcategory</small>
                            </div>

                            <h6 class="mb-3 text-primary mt-4">SEO Information</h6>
                            
                            <div class="mb-3">
                                <label for="categoryMetaTitle" class="form-label">Meta Title</label>
                                <input type="text" class="form-control" id="categoryMetaTitle" name="meta_title" maxlength="200" placeholder="SEO meta title...">
                                <div class="form-text">Recommended: 50-60 characters</div>
                            </div>

                            <div class="mb-3">
                                <label for="categoryMetaDescription" class="form-label">Meta Description</label>
                                <textarea class="form-control" id="categoryMetaDescription" name="meta_description" rows="2" maxlength="300" placeholder="SEO meta description..."></textarea>
                                <div class="form-text">Recommended: 150-160 characters</div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <h6 class="mb-3 text-primary">Settings</h6>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="categoryIsActive" name="is_active" checked>
                                    <label class="form-check-label" for="categoryIsActive">Active Category</label>
                                </div>
                            </div>

                            <hr>
                            
                            <h6 class="mb-3 text-primary">Category Image</h6>
                            <div class="mb-3">
                                <label for="categoryImage" class="form-label">Upload Image</label>
                                <input type="file" class="form-control" id="categoryImage" name="image" accept="image/*">
                                <small class="form-text text-muted">Max file size: 5MB</small>
                            </div>

                            <div class="text-center mb-3">
                                <img id="categoryImagePreview" src="#" alt="Category Preview" class="img-thumbnail" style="max-width: 150px; display: none;">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCategoryBtn">
                    <i class="fas fa-save me-1"></i> Save Category
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCategoryModalLabel">Edit Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCategoryForm">
                    <input type="hidden" id="editCategoryId">
                    
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="mb-3 text-primary">Basic Information</h6>
                            
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <label for="editCategoryName" class="form-label">Category Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editCategoryName" name="name" required>
                                    <div class="invalid-feedback">Category name is required</div>
                                </div>
                                <div class="col-md-4">
                                    <label for="editCategorySlug" class="form-label">Slug</label>
                                    <input type="text" class="form-control" id="editCategorySlug" name="slug">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="editCategoryDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="editCategoryDescription" name="description" rows="3"></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="editCategoryParent" class="form-label">Parent Category</label>
                                <select class="form-select" id="editCategoryParent" name="parent">
                                    <option value="">None (Root Category)</option>
                                </select>
                            </div>

                            <h6 class="mb-3 text-primary mt-4">SEO Information</h6>
                            
                            <div class="mb-3">
                                <label for="editCategoryMetaTitle" class="form-label">Meta Title</label>
                                <input type="text" class="form-control" id="editCategoryMetaTitle" name="meta_title" maxlength="200">
                            </div>

                            <div class="mb-3">
                                <label for="editCategoryMetaDescription" class="form-label">Meta Description</label>
                                <textarea class="form-control" id="editCategoryMetaDescription" name="meta_description" rows="2" maxlength="300"></textarea>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <h6 class="mb-3 text-primary">Settings</h6>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="editCategoryIsActive" name="is_active">
                                    <label class="form-check-label" for="editCategoryIsActive">Active Category</label>
                                </div>
                            </div>

                            <hr>
                            
                            <h6 class="mb-3 text-primary">Category Image</h6>
                            <div class="mb-3">
                                <label for="editCategoryImage" class="form-label">Upload New Image</label>
                                <input type="file" class="form-control" id="editCategoryImage" name="image" accept="image/*">
                                <small class="form-text text-muted">Leave blank to keep current image</small>
                            </div>

                            <div class="text-center mb-3">
                                <img id="editCategoryImagePreview" src="#" alt="Current Image" class="img-thumbnail" style="max-width: 150px; display: none;">
                            </div>

                            <hr>

                            <h6 class="mb-3 text-primary">System Information</h6>
                            <div class="mb-2">
                                <small class="text-muted">Category ID:</small>
                                <div id="editCategoryIdDisplay" class="fw-bold">-</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Created:</small>
                                <div id="editCategoryCreated" class="fw-bold">-</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Last Updated:</small>
                                <div id="editCategoryUpdated" class="fw-bold">-</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateCategoryBtn">
                    <i class="fas fa-save me-1"></i> Update Category
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let selectedCategoryId = null;
    
    // Event listeners
    document.getElementById('refreshCategoriesBtn').addEventListener('click', function() {
        loadCategories(1);
    });
    
    document.getElementById('applyFiltersBtn').addEventListener('click', function() {
        loadCategories(1);
    });
    
    document.getElementById('saveCategoryBtn').addEventListener('click', saveCategory);
    document.getElementById('updateCategoryBtn').addEventListener('click', updateCategory);
    document.getElementById('deleteCategoryBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to delete this category? This action cannot be undone.')) {
            deleteCategory(selectedCategoryId);
        }
    });
    
    document.getElementById('editCategoryBtn').addEventListener('click', function() {
        loadCategoryForEdit(selectedCategoryId);
    });
    
    document.getElementById('editCategoryBtnFooter').addEventListener('click', function() {
        loadCategoryForEdit(selectedCategoryId);
    });
    
    // Event delegation for dynamically created buttons
    document.addEventListener('click', function(e) {
        // Handle view category button clicks
        if (e.target.closest('.view-category-btn')) {
            const btn = e.target.closest('.view-category-btn');
            const categoryId = btn.dataset.categoryId;
            selectedCategoryId = categoryId;
            loadCategoryDetails(categoryId);
        }
        
        // Handle edit category button clicks
        if (e.target.closest('.edit-category-btn')) {
            const btn = e.target.closest('.edit-category-btn');
            const categoryId = btn.dataset.categoryId;
            loadCategoryForEdit(categoryId);
        }
        
        // Handle delete category button clicks
        if (e.target.closest('.delete-category-btn')) {
            const btn = e.target.closest('.delete-category-btn');
            const categoryId = btn.dataset.categoryId;
            if (confirm('Are you sure you want to delete this category? This action cannot be undone.')) {
                deleteCategory(categoryId);
            }
        }
    });
    
    // Image preview functionality
    document.getElementById('categoryImage').addEventListener('change', function() {
        const file = this.files[0];
        const preview = document.getElementById('categoryImagePreview');
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            preview.style.display = 'none';
        }
    });
    
    document.getElementById('editCategoryImage').addEventListener('change', function() {
        const file = this.files[0];
        const preview = document.getElementById('editCategoryImagePreview');
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Auto-generate slug from name
    document.getElementById('categoryName').addEventListener('input', function() {
        const slug = this.value.toLowerCase()
            .replace(/[^a-z0-9 -]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .trim('-');
        document.getElementById('categorySlug').value = slug;
    });
    
    document.getElementById('editCategoryName').addEventListener('input', function() {
        const slug = this.value.toLowerCase()
            .replace(/[^a-z0-9 -]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .trim('-');
        document.getElementById('editCategorySlug').value = slug;
    });
    
    // Search functionality
    let searchTimeout;
    document.getElementById('searchCategories').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            loadCategories(1);
        }, 500);
    });
    
    // Load initial data
    loadCategories(1);
    loadParentCategories();
    
    function loadCategories(page = 1) {
        currentPage = page;
        
        // Build URL with filters
        let url = `/mb-admin/api/categories/?page=${page}`;
        
        const search = document.getElementById('searchCategories').value;
        if (search) {
            url += `&search=${encodeURIComponent(search)}`;
        }
        
        const status = document.getElementById('statusFilter').value;
        if (status) {
            url += `&is_active=${status}`;
        }
        
        const parent = document.getElementById('parentFilter').value;
        if (parent === 'null') {
            url += `&parent__isnull=true`;
        } else if (parent) {
            url += `&parent=${parent}`;
        }
        
        // Show loading indicator
        document.getElementById('categoriesTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading categories...</p>
                </td>
            </tr>
        `;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                displayCategories(data.results || data);
                updatePagination(data);
                document.getElementById('categoriesTotalCount').textContent = data.count || 0;
            })
            .catch(error => {
                console.error('Error loading categories:', error);
                document.getElementById('categoriesTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>Error loading categories. Please try again.</p>
                        </td>
                    </tr>
                `;
            });
    }
    
    function displayCategories(categories) {
        const tbody = document.getElementById('categoriesTableBody');
        tbody.innerHTML = '';
        
        if (!categories || categories.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <i class="fas fa-folder-open fa-2x text-muted mb-3"></i>
                        <p class="text-muted">No categories found.</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        categories.forEach(category => {
            const tr = document.createElement('tr');
            
            const statusBadge = category.is_active ? 
                '<span class="badge bg-success">Active</span>' : 
                '<span class="badge bg-danger">Inactive</span>';
            
            const parentName = category.parent_name || '-';
            const productCount = category.product_count || 0;
            
            tr.innerHTML = `
                <td>${category.id}</td>
                <td>
                    <div class="d-flex align-items-center">
                        ${category.image ? 
                            `<img src="${category.image}" alt="${category.name}" class="rounded me-2" style="width: 32px; height: 32px; object-fit: cover;">` :
                            '<i class="fas fa-folder text-secondary me-2"></i>'
                        }
                        <div>
                            <strong>${category.name}</strong>
                            ${category.description ? `<br><small class="text-muted">${category.description.substring(0, 50)}${category.description.length > 50 ? '...' : ''}</small>` : ''}
                        </div>
                    </div>
                </td>
                <td>${parentName}</td>
                <td>
                    <span class="badge bg-info">${productCount}</span>
                </td>
                <td>${statusBadge}</td>
                <td>${new Date(category.created_at).toLocaleDateString()}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary view-category-btn" data-category-id="${category.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary edit-category-btn" data-category-id="${category.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger delete-category-btn" data-category-id="${category.id}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </td>
            `;
            
            tbody.appendChild(tr);
        });
    }
    
    function updatePagination(data) {
        const pagination = document.getElementById('categoriesPagination');
        pagination.innerHTML = '';
        
        if (!data.count || data.count <= 10) {
            return; // No pagination needed
        }
        
        const totalPages = Math.ceil(data.count / 10);
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${!data.previous ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
        pagination.appendChild(prevLi);
        
        // Page numbers
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            pagination.appendChild(li);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${!data.next ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
        pagination.appendChild(nextLi);
        
        // Add click handlers
        pagination.querySelectorAll('.page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.dataset.page);
                if (page > 0 && page <= totalPages) {
                    loadCategories(page);
                }
            });
        });
    }
    
    // Category details
    function loadCategoryDetails(categoryId) {
        fetch(`/mb-admin/api/categories/${categoryId}/`)
            .then(response => response.json())
            .then(category => {
                displayCategoryDetails(category);
                
                // Load products in this category
                return fetch(`/mb-admin/api/products/?category=${categoryId}`)
                    .then(response => response.json())
                    .then(data => {
                        displayCategoryProducts(data.results || data);
                    });
            })
            .catch(error => {
                console.error('Error loading category details:', error);
                showAlert('Failed to load category details.', 'danger');
            });
    }
    
    function displayCategoryDetails(category) {
        // Set category details
        document.getElementById('categoryDetailName').textContent = category.name;
        document.getElementById('categoryDetailSlug').textContent = `/${category.slug}/`;
        document.getElementById('categoryDetailNameField').textContent = category.name;
        document.getElementById('categoryDetailDescription').textContent = category.description || '-';
        document.getElementById('categoryDetailParent').textContent = category.parent_name || 'Root Category';
        document.getElementById('categoryDetailStatus').innerHTML = category.is_active ? 
            '<span class="badge bg-success">Active</span>' : 
            '<span class="badge bg-danger">Inactive</span>';
        document.getElementById('categoryDetailMetaTitle').textContent = category.meta_title || '-';
        document.getElementById('categoryDetailMetaDescription').textContent = category.meta_description || '-';
        document.getElementById('categoryDetailCreated').textContent = new Date(category.created_at).toLocaleDateString();
        document.getElementById('categoryDetailUpdated').textContent = new Date(category.updated_at).toLocaleDateString();
        
        // Category image
        const categoryImage = document.getElementById('categoryDetailImage');
        const defaultImage = document.getElementById('categoryDefaultImage');
        
        if (category.image) {
            categoryImage.src = category.image;
            categoryImage.style.display = 'block';
            defaultImage.style.display = 'none';
        } else {
            categoryImage.style.display = 'none';
            defaultImage.style.display = 'flex';
        }
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('categoryDetailsModal'));
        modal.show();
    }
    
    function displayCategoryProducts(products) {
        const productsList = document.getElementById('categoryProductsList');
        const productCount = document.getElementById('categoryProductCount');
        
        productCount.textContent = products.length;
        productsList.innerHTML = '';
        
        if (!products || products.length === 0) {
            productsList.innerHTML = '<p class="text-muted text-center py-3">No products in this category.</p>';
            return;
        }
        
        products.slice(0, 10).forEach(product => { // Show only first 10 products
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            item.innerHTML = `
                <div>
                    <strong>${product.name}</strong>
                    <br><small class="text-muted">SKU: ${product.sku || 'N/A'}</small>
                </div>
                <span class="badge bg-primary">$${product.price}</span>
            `;
            productsList.appendChild(item);
        });
        
        if (products.length > 10) {
            const moreItem = document.createElement('div');
            moreItem.className = 'list-group-item text-center text-muted';
            moreItem.innerHTML = `<small>... and ${products.length - 10} more products</small>`;
            productsList.appendChild(moreItem);
        }
    }
    
    function loadParentCategories() {
        fetch('/mb-admin/api/categories/?page_size=1000')
            .then(response => response.json())
            .then(data => {
                const categories = data.results || data;
                const parentSelects = ['categoryParent', 'editCategoryParent', 'parentFilter'];
                
                parentSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    const currentOptions = Array.from(select.options).slice(1); // Keep first option
                    currentOptions.forEach(option => option.remove());
                    
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        select.appendChild(option);
                    });
                });
            })
            .catch(error => {
                console.error('Error loading parent categories:', error);
            });
    }
    
    function loadCategoryForEdit(categoryId) {
        fetch(`/mb-admin/api/categories/${categoryId}/`)
            .then(response => response.json())
            .then(category => {
                // Close details modal if open
                const detailsModal = bootstrap.Modal.getInstance(document.getElementById('categoryDetailsModal'));
                if (detailsModal) {
                    detailsModal.hide();
                }
                
                // Populate edit form
                document.getElementById('editCategoryId').value = category.id;
                document.getElementById('editCategoryName').value = category.name;
                document.getElementById('editCategorySlug').value = category.slug;
                document.getElementById('editCategoryDescription').value = category.description || '';
                document.getElementById('editCategoryParent').value = category.parent || '';
                document.getElementById('editCategoryMetaTitle').value = category.meta_title || '';
                document.getElementById('editCategoryMetaDescription').value = category.meta_description || '';
                document.getElementById('editCategoryIsActive').checked = category.is_active;
                
                // Display system information
                document.getElementById('editCategoryIdDisplay').textContent = category.id;
                document.getElementById('editCategoryCreated').textContent = new Date(category.created_at).toLocaleDateString();
                document.getElementById('editCategoryUpdated').textContent = new Date(category.updated_at).toLocaleDateString();
                
                // Current image
                const imagePreview = document.getElementById('editCategoryImagePreview');
                if (category.image) {
                    imagePreview.src = category.image;
                    imagePreview.style.display = 'block';
                } else {
                    imagePreview.style.display = 'none';
                }
                
                // Clear file input
                document.getElementById('editCategoryImage').value = '';
                
                // Show edit modal
                const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading category for edit:', error);
                showAlert('Failed to load category details for editing.', 'danger');
            });
    }
    
    function saveCategory() {
        const form = document.getElementById('addCategoryForm');
        const formData = new FormData(form);
        
        fetch('/mb-admin/api/categories/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(JSON.stringify(data));
                });
            }
            return response.json();
        })
        .then(data => {
            // Close modal and refresh list
            const modal = bootstrap.Modal.getInstance(document.getElementById('addCategoryModal'));
            modal.hide();
            form.reset();
            
            // Clear image preview
            document.getElementById('categoryImagePreview').style.display = 'none';
            
            loadCategories();
            loadParentCategories(); // Refresh parent categories list
            showAlert('Category created successfully!', 'success');
        })
        .catch(error => {
            console.error('Error creating category:', error);
            showAlert('Failed to create category. ' + error.message, 'danger');
        });
    }
    
    function updateCategory() {
        const form = document.getElementById('editCategoryForm');
        const categoryId = document.getElementById('editCategoryId').value;
        const formData = new FormData(form);
        
        fetch(`/mb-admin/api/categories/${categoryId}/`, {
            method: 'PUT',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(JSON.stringify(data));
                });
            }
            return response.json();
        })
        .then(data => {
            // Close modal and refresh list
            const modal = bootstrap.Modal.getInstance(document.getElementById('editCategoryModal'));
            modal.hide();
            
            loadCategories(currentPage);
            loadParentCategories(); // Refresh parent categories list
            
            // Refresh category details if viewing
            if (selectedCategoryId === categoryId) {
                loadCategoryDetails(categoryId);
            }
            
            showAlert('Category updated successfully!', 'success');
        })
        .catch(error => {
            console.error('Error updating category:', error);
            showAlert('Failed to update category. ' + error.message, 'danger');
        });
    }
    
    function deleteCategory(categoryId) {
        fetch(`/mb-admin/api/categories/${categoryId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete category');
            }
            
            // Hide category details modal if currently viewing
            if (selectedCategoryId === categoryId) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('categoryDetailsModal'));
                if (modal) {
                    modal.hide();
                }
                selectedCategoryId = null;
            }
            
            // Refresh categories list
            loadCategories(currentPage);
            loadParentCategories(); // Refresh parent categories list
            
            showAlert('Category deleted successfully!', 'success');
        })
        .catch(error => {
            console.error('Error deleting category:', error);
            showAlert('Failed to delete category.', 'danger');
        });
    }
    
    function showAlert(message, type) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}