{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}MB Admin - Manage Variants for {{ product.name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboard:home' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'dashboard:product_list' %}">Products</a></li>
<li class="breadcrumb-item"><a href="{% url 'dashboard:product_detail' product.id %}">{{ product.name }}</a></li>
<li class="breadcrumb-item active">Manage Variants</li>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1>Manage Variants for {{ product.name }}</h1>
    </div>
    <div class="col-md-4 text-end">
        <div class="btn-group">
            <a href="{% url 'dashboard:product_detail' product.id %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Product
            </a>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addVariantModal">
                <i class="fas fa-plus me-1"></i> Add Variant
            </button>
        </div>
    </div>
</div>

<!-- Variant Options -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Variant Options</h5>
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addOptionModal">
                    <i class="fas fa-plus"></i> Add Option
                </button>
            </div>
            <div class="card-body">
                {% if variant_options %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Option Name</th>
                                <th>Values</th>
                                <th style="width: 120px">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for option in variant_options %}
                            <tr>
                                <td>{{ option.name }}</td>
                                <td>
                                    {% for value in option.values.all %}
                                    <span class="badge bg-light text-dark me-1 mb-1">{{ value.value }}</span>
                                    {% endfor %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editOptionModal{{ option.id }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger"
                                                data-bs-toggle="modal"
                                                data-bs-target="#deleteOptionModal{{ option.id }}">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Edit Option Modal -->
                                    <div class="modal fade" id="editOptionModal{{ option.id }}" tabindex="-1" aria-labelledby="editOptionModalLabel{{ option.id }}" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="editOptionModalLabel{{ option.id }}">Edit Option</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <form action="{% url 'dashboard:edit_variant_option' option.id %}" method="post">
                                                    {% csrf_token %}
                                                    <div class="modal-body">
                                                        <div class="mb-3">
                                                            <label for="option_name{{ option.id }}" class="form-label">Option Name</label>
                                                            <input type="text" class="form-control" id="option_name{{ option.id }}" name="name" value="{{ option.name }}" required>
                                                            <small class="form-text text-muted">
                                                                Examples: Color, Size, Material, etc.
                                                            </small>
                                                        </div>
                                                        <div class="mb-0">
                                                            <label for="option_values{{ option.id }}" class="form-label">Option Values</label>
                                                            <input type="text" class="form-control" id="option_values{{ option.id }}" name="values" value="{% for value in option.values.all %}{{ value.value }}{% if not forloop.last %}, {% endif %}{% endfor %}" required>
                                                            <small class="form-text text-muted">
                                                                Comma-separated list (e.g., Small, Medium, Large)
                                                            </small>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-primary">Save Changes</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Delete Option Modal -->
                                    <div class="modal fade" id="deleteOptionModal{{ option.id }}" tabindex="-1" aria-labelledby="deleteOptionModalLabel{{ option.id }}" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="deleteOptionModalLabel{{ option.id }}">Delete Option</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="alert alert-warning">
                                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                                        <strong>Warning:</strong> Deleting this option will remove all variants using it.
                                                    </div>
                                                    <p>Are you sure you want to delete the <strong>{{ option.name }}</strong> option?</p>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                    <form action="{% url 'dashboard:delete_variant_option' option.id %}" method="post">
                                                        {% csrf_token %}
                                                        <button type="submit" class="btn btn-danger">Delete</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-th-large fa-3x mb-3 text-muted"></i>
                    <p class="mb-3">No variant options defined yet.</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOptionModal">
                        <i class="fas fa-plus me-1"></i> Add First Option
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Variants List -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Product Variants</h5>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" id="generateVariantsBtn" {% if variant_options|length < 1 %}disabled{% endif %}>
                        <i class="fas fa-magic me-1"></i> Generate All Combinations
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="bulkUpdateBtn" {% if not variants %}disabled{% endif %}>
                        <i class="fas fa-edit me-1"></i> Bulk Update
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if variants %}
                <div class="table-responsive">
                    <form id="bulkUpdateForm" action="{% url 'dashboard:bulk_update_variants' product.id %}" method="post">
                        {% csrf_token %}
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 40px">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="selectAllVariants">
                                        </div>
                                    </th>
                                    <th style="width: 80px">Image</th>
                                    <th>Variant</th>
                                    <th>SKU</th>
                                    <th>Stock</th>
                                    <th>Price</th>
                                    <th style="width: 120px">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for variant in variants %}
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input variant-checkbox" type="checkbox" name="selected_variants" value="{{ variant.id }}">
                                        </div>
                                    </td>
                                    <td>
                                        {% if variant.image %}
                                        <img src="{{ variant.image.url }}" alt="{{ variant.get_variant_name }}" class="img-fluid" style="max-width: 60px; max-height: 60px;">
                                        {% else %}
                                        <div class="bg-light" style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-image text-muted"></i>
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td>{{ variant.get_variant_name }}</td>
                                    <td>{{ variant.sku }}</td>
                                    <td>
                                        {% if variant.stock == 0 %}
                                        <span class="text-danger">Out of Stock</span>
                                        {% elif variant.stock < 10 %}
                                        <span class="text-warning">Low ({{ variant.stock }})</span>
                                        {% else %}
                                        {{ variant.stock }}
                                        {% endif %}
                                    </td>
                                    <td>${{ variant.price|floatformat:2 }}</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'dashboard:edit_variant' variant.id %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteVariantModal{{ variant.id }}">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                        
                                        <!-- Delete Variant Modal -->
                                        <div class="modal fade" id="deleteVariantModal{{ variant.id }}" tabindex="-1" aria-labelledby="deleteVariantModalLabel{{ variant.id }}" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="deleteVariantModalLabel{{ variant.id }}">Delete Variant</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <p>Are you sure you want to delete the variant <strong>{{ variant.get_variant_name }}</strong>?</p>
                                                        <p class="text-danger mb-0">This action cannot be undone.</p>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                        <form action="{% url 'dashboard:delete_variant' variant.id %}" method="post">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-danger">Delete</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </form>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-cube fa-3x mb-3 text-muted"></i>
                    <p class="mb-3">No variants created yet.</p>
                    {% if variant_options|length > 0 %}
                    <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addVariantModal">
                        <i class="fas fa-plus me-1"></i> Add Variant
                    </button>
                    <button class="btn btn-outline-primary" id="generateVariantsBtn">
                        <i class="fas fa-magic me-1"></i> Generate All Combinations
                    </button>
                    {% else %}
                    <div class="alert alert-info d-inline-block">
                        <i class="fas fa-info-circle me-2"></i>
                        Add at least one option (like Size or Color) before creating variants
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add Option Modal -->
<div class="modal fade" id="addOptionModal" tabindex="-1" aria-labelledby="addOptionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addOptionModalLabel">Add Variant Option</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'dashboard:add_variant_option' product.id %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="option_name" class="form-label">Option Name</label>
                        <input type="text" class="form-control" id="option_name" name="name" required>
                        <small class="form-text text-muted">
                            Examples: Color, Size, Material, etc.
                        </small>
                    </div>
                    <div class="mb-0">
                        <label for="option_values" class="form-label">Option Values</label>
                        <input type="text" class="form-control" id="option_values" name="values" required>
                        <small class="form-text text-muted">
                            Comma-separated list (e.g., Small, Medium, Large)
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Option</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Variant Modal -->
<div class="modal fade" id="addVariantModal" tabindex="-1" aria-labelledby="addVariantModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addVariantModalLabel">Add Variant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'dashboard:add_variant' product.id %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="variant_sku" class="form-label">SKU*</label>
                                <input type="text" class="form-control" id="variant_sku" name="sku" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="variant_price" class="form-label">Price*</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="variant_price" name="price" step="0.01" min="0" value="{{ product.price }}" required>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="variant_stock" class="form-label">Stock*</label>
                                <input type="number" class="form-control" id="variant_stock" name="stock" min="0" value="0" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="variant_image" class="form-label">Image</label>
                                <input class="form-control" type="file" id="variant_image" name="image" accept="image/*">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Options</label>
                                {% for option in variant_options %}
                                <div class="mb-3">
                                    <label for="option_{{ option.id }}" class="form-label">{{ option.name }}</label>
                                    <select class="form-select" id="option_{{ option.id }}" name="option_{{ option.id }}" required>
                                        <option value="">Select {{ option.name }}</option>
                                        {% for value in option.values.all %}
                                        <option value="{{ value.id }}">{{ value.value }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                {% empty %}
                                <div class="alert alert-warning mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    No options defined. Please create at least one option first.
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" {% if not variant_options %}disabled{% endif %}>Add Variant</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Update Modal -->
<div class="modal fade" id="bulkUpdateModal" tabindex="-1" aria-labelledby="bulkUpdateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkUpdateModalLabel">Bulk Update Variants</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Update properties for all selected variants at once.
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Update Price</label>
                    <div class="input-group mb-2">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" name="bulk_price" id="bulk_price" step="0.01" min="0">
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="apply_price" name="apply_price" value="1">
                        <label class="form-check-label" for="apply_price">Apply price update</label>
                    </div>
                </div>
                
                <div class="mb-0">
                    <label class="form-label">Update Stock</label>
                    <input type="number" class="form-control mb-2" name="bulk_stock" id="bulk_stock" min="0">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="apply_stock" name="apply_stock" value="1">
                        <label class="form-check-label" for="apply_stock">Apply stock update</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary" form="bulkUpdateForm">Update Selected</button>
            </div>
        </div>
    </div>
</div>

<!-- Generate Combinations Modal -->
<div class="modal fade" id="generateCombinationsModal" tabindex="-1" aria-labelledby="generateCombinationsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateCombinationsModalLabel">Generate All Variant Combinations</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'dashboard:generate_all_variants' product.id %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        This will generate all possible variant combinations based on the options you've defined.
                    </div>
                    
                    <div class="mb-3">
                        <label for="base_price" class="form-label">Base Price for All Variants</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="base_price" name="base_price" step="0.01" min="0" value="{{ product.price }}" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="base_stock" class="form-label">Initial Stock for All Variants</label>
                        <input type="number" class="form-control" id="base_stock" name="base_stock" min="0" value="0" required>
                    </div>
                    
                    <div class="form-check mb-0">
                        <input class="form-check-input" type="checkbox" id="skip_existing" name="skip_existing" checked>
                        <label class="form-check-label" for="skip_existing">
                            Skip existing combinations
                        </label>
                        <small class="form-text text-muted d-block">
                            If unchecked, existing variants may be overwritten
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Generate Variants</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle select all variants
    const selectAllCheckbox = document.getElementById('selectAllVariants');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            document.querySelectorAll('.variant-checkbox').forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkUpdateButton();
        });
    }
    
    // Update bulk update button state
    function updateBulkUpdateButton() {
        const bulkUpdateBtn = document.getElementById('bulkUpdateBtn');
        const hasSelected = [...document.querySelectorAll('.variant-checkbox')].some(cb => cb.checked);
        
        if (bulkUpdateBtn) {
            bulkUpdateBtn.disabled = !hasSelected;
        }
    }
    
    // Individual checkbox changes
    document.querySelectorAll('.variant-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkUpdateButton);
    });
    
    // Bulk update button click
    const bulkUpdateBtn = document.getElementById('bulkUpdateBtn');
    if (bulkUpdateBtn) {
        bulkUpdateBtn.addEventListener('click', function() {
            const hasSelected = [...document.querySelectorAll('.variant-checkbox')].some(cb => cb.checked);
            
            if (hasSelected) {
                const bulkUpdateModal = new bootstrap.Modal(document.getElementById('bulkUpdateModal'));
                bulkUpdateModal.show();
            } else {
                alert('Please select at least one variant to update.');
            }
        });
    }
    
    // Add hidden inputs to form before submit
    document.getElementById('bulkUpdateForm').addEventListener('submit', function(e) {
        const applyPrice = document.getElementById('apply_price').checked;
        const applyStock = document.getElementById('apply_stock').checked;
        
        if (!applyPrice && !applyStock) {
            e.preventDefault();
            alert('Please select at least one property to update.');
            return;
        }
        
        if (applyPrice) {
            const priceInput = document.createElement('input');
            priceInput.type = 'hidden';
            priceInput.name = 'bulk_price';
            priceInput.value = document.getElementById('bulk_price').value;
            this.appendChild(priceInput);
        }
        
        if (applyStock) {
            const stockInput = document.createElement('input');
            stockInput.type = 'hidden';
            stockInput.name = 'bulk_stock';
            stockInput.value = document.getElementById('bulk_stock').value;
            this.appendChild(stockInput);
        }
    });
    
    // Generate variants button
    const generateVariantsBtn = document.getElementById('generateVariantsBtn');
    if (generateVariantsBtn) {
        generateVariantsBtn.addEventListener('click', function() {
            const generateModal = new bootstrap.Modal(document.getElementById('generateCombinationsModal'));
            generateModal.show();
        });
    }
});
</script>
{% endblock %}
