{% extends 'dashboard/base.html' %}

{% block title %}Users - MB Admin{% endblock %}

{% block page_title %}Users Management{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">All Users</h5>
        <div>
            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal">
                <i class="fas fa-plus-circle me-1"></i> Add User
            </button>
            <button class="btn btn-sm btn-secondary" id="refreshUsersBtn">
                <i class="fas fa-sync-alt me-1"></i> Refresh
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <div class="row g-2">
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm" id="userSearchInput" placeholder="Search by name, email...">
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" id="roleFilter">
                        <option value="">All Roles</option>
                        <option value="true">Staff</option>
                        <option value="false">Customer</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary btn-sm w-100" id="applyFiltersBtn">
                        <i class="fas fa-filter me-1"></i> Filter
                    </button>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Email Verified</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading users...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <span id="usersTotalCount">0</span> users
            </div>
            <div>
                <nav aria-label="Users pagination">
                    <ul class="pagination pagination-sm" id="usersPagination"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1" aria-labelledby="userDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userDetailsModalLabel">User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-3 text-center mb-4 mb-md-0">
                        <div class="avatar-container mb-3">
                            <div id="userProfilePictureContainer">
                                <img id="userProfilePicture" src="#" alt="Profile Picture" class="img-thumbnail rounded-circle" style="width: 120px; height: 120px; display: none; object-fit: cover;">
                                <i id="userDefaultAvatar" class="fas fa-user-circle fa-6x text-secondary"></i>
                            </div>
                        </div>
                        <h5 id="userDetailUsername" class="mb-1"></h5>
                        <p id="userDetailRole" class="badge bg-primary mb-3"></p>
                        <div class="d-grid gap-2">
                            <button class="btn btn-sm btn-outline-primary" id="editUserBtn">
                                <i class="fas fa-edit me-1"></i> Edit User
                            </button>
                            <button class="btn btn-sm btn-outline-danger" id="deleteUserBtn">
                                <i class="fas fa-trash-alt me-1"></i> Delete User
                            </button>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="mb-3 text-primary">Personal Information</h6>
                                <dl class="row">
                                    <dt class="col-sm-5">First Name</dt>
                                    <dd class="col-sm-7" id="userDetailFirstName"></dd>
                                    
                                    <dt class="col-sm-5">Last Name</dt>
                                    <dd class="col-sm-7" id="userDetailLastName"></dd>
                                    
                                    <dt class="col-sm-5">Email</dt>
                                    <dd class="col-sm-7" id="userDetailEmail"></dd>
                                    
                                    <dt class="col-sm-5">Phone</dt>
                                    <dd class="col-sm-7" id="userDetailPhone"></dd>
                                    
                                    <dt class="col-sm-5">Date of Birth</dt>
                                    <dd class="col-sm-7" id="userDetailDateOfBirth"></dd>
                                </dl>
                                
                                <h6 class="mb-3 text-primary mt-4">Address Information</h6>
                                <dl class="row">
                                    <dt class="col-sm-5">Address</dt>
                                    <dd class="col-sm-7" id="userDetailAddress"></dd>
                                    
                                    <dt class="col-sm-5">City</dt>
                                    <dd class="col-sm-7" id="userDetailCity"></dd>
                                    
                                    <dt class="col-sm-5">State</dt>
                                    <dd class="col-sm-7" id="userDetailState"></dd>
                                    
                                    <dt class="col-sm-5">Country</dt>
                                    <dd class="col-sm-7" id="userDetailCountry"></dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <h6 class="mb-3 text-primary">Account Information</h6>
                                <dl class="row">
                                    <dt class="col-sm-5">Email Verified</dt>
                                    <dd class="col-sm-7" id="userDetailEmailVerified"></dd>
                                    
                                    <dt class="col-sm-5">Status</dt>
                                    <dd class="col-sm-7" id="userDetailStatus"></dd>
                                    
                                    <dt class="col-sm-5">Staff Member</dt>
                                    <dd class="col-sm-7" id="userDetailIsStaff"></dd>
                                    
                                    <dt class="col-sm-5">Administrator</dt>
                                    <dd class="col-sm-7" id="userDetailIsAdmin"></dd>
                                    
                                    <dt class="col-sm-5">Joined</dt>
                                    <dd class="col-sm-7" id="userDetailJoined"></dd>
                                    
                                    <dt class="col-sm-5">Last Login</dt>
                                    <dd class="col-sm-7" id="userDetailLastLogin"></dd>
                                </dl>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <h6 class="mb-3 text-primary">Recent Orders</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Order #</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Total</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="userOrdersTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center py-3">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <span class="ms-2">Loading orders...</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editUserBtnFooter">
                    <i class="fas fa-edit me-1"></i> Edit User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <!-- Basic Information Tab -->
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="mb-3 text-primary">Basic Information</h6>
                            
                            <!-- Mandatory Fields -->
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="username" name="username" required>
                                    <div class="invalid-feedback">Username is required</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="email" name="email" required>
                                    <div class="invalid-feedback">Valid email is required</div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="firstName" class="form-label">First Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="firstName" name="first_name" required>
                                    <div class="invalid-feedback">First name is required</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="lastName" class="form-label">Last Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="lastName" name="last_name" required>
                                    <div class="invalid-feedback">Last name is required</div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="phone" class="form-label">Phone <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" id="phone" name="phone" required>
                                    <div class="invalid-feedback">Phone number is required</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="dateOfBirth" class="form-label">Date of Birth</label>
                                    <input type="date" class="form-control" id="dateOfBirth" name="date_of_birth">
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="password" class="form-label">Password <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="password" name="password" required minlength="8">
                                    <div class="invalid-feedback">Password is required (minimum 8 characters)</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="confirmPassword" class="form-label">Confirm Password <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                                    <div class="invalid-feedback" id="passwordMismatch">Passwords do not match</div>
                                </div>
                            </div>

                            <h6 class="mb-3 text-primary mt-4">Address Information</h6>
                            
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label for="addressLine1" class="form-label">Address Line 1</label>
                                    <input type="text" class="form-control" id="addressLine1" name="address_line_1">
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label for="addressLine2" class="form-label">Address Line 2</label>
                                    <input type="text" class="form-control" id="addressLine2" name="address_line_2">
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="city" class="form-label">City</label>
                                    <input type="text" class="form-control" id="city" name="city">
                                </div>
                                <div class="col-md-6">
                                    <label for="state" class="form-label">State/Province</label>
                                    <input type="text" class="form-control" id="state" name="state">
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="postalCode" class="form-label">Postal Code</label>
                                    <input type="text" class="form-control" id="postalCode" name="postal_code">
                                </div>
                                <div class="col-md-6">
                                    <label for="country" class="form-label">Country</label>
                                    <input type="text" class="form-control" id="country" name="country">
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <h6 class="mb-3 text-primary">Account Settings</h6>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="isActive" name="is_active" checked>
                                    <label class="form-check-label" for="isActive">Active Account</label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="isEmailVerified" name="is_email_verified">
                                    <label class="form-check-label" for="isEmailVerified">Email Verified</label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="isStaff" name="is_staff">
                                    <label class="form-check-label" for="isStaff">Staff Member</label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="isSuperuser" name="is_superuser">
                                    <label class="form-check-label" for="isSuperuser">Administrator</label>
                                </div>
                            </div>

                            <hr>
                            
                            <h6 class="mb-3 text-primary">Profile Picture</h6>
                            <div class="mb-3">
                                <label for="profilePicture" class="form-label">Upload Image</label>
                                <input type="file" class="form-control" id="profilePicture" name="profile_picture" accept="image/*">
                                <small class="form-text text-muted">Max file size: 5MB</small>
                            </div>

                            <div class="text-center mb-3">
                                <img id="profilePreview" src="#" alt="Profile Preview" class="img-thumbnail" style="max-width: 150px; display: none;">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveUserBtn">
                    <i class="fas fa-save me-1"></i> Save User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="mb-3 text-primary">Basic Information</h6>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="editUsername" class="form-label">Username <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editUsername" name="username" required>
                                    <div class="invalid-feedback">Username is required</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="editEmail" class="form-label">Email <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="editEmail" name="email" required>
                                    <div class="invalid-feedback">Valid email is required</div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="editFirstName" class="form-label">First Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editFirstName" name="first_name" required>
                                    <div class="invalid-feedback">First name is required</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="editLastName" class="form-label">Last Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editLastName" name="last_name" required>
                                    <div class="invalid-feedback">Last name is required</div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="editPhone" class="form-label">Phone <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" id="editPhone" name="phone" required>
                                    <div class="invalid-feedback">Phone number is required</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="editDateOfBirth" class="form-label">Date of Birth</label>
                                    <input type="date" class="form-control" id="editDateOfBirth" name="date_of_birth">
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="newPassword" class="form-label">New Password</label>
                                    <input type="password" class="form-control" id="newPassword" name="password" minlength="8">
                                    <small class="form-text text-muted">Leave blank to keep current password</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                                    <input type="password" class="form-control" id="confirmNewPassword" name="confirmNewPassword">
                                    <div class="invalid-feedback" id="editPasswordMismatch">Passwords do not match</div>
                                </div>
                            </div>

                            <h6 class="mb-3 text-primary mt-4">Address Information</h6>
                            
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label for="editAddressLine1" class="form-label">Address Line 1</label>
                                    <input type="text" class="form-control" id="editAddressLine1" name="address_line_1">
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label for="editAddressLine2" class="form-label">Address Line 2</label>
                                    <input type="text" class="form-control" id="editAddressLine2" name="address_line_2">
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="editCity" class="form-label">City</label>
                                    <input type="text" class="form-control" id="editCity" name="city">
                                </div>
                                <div class="col-md-6">
                                    <label for="editState" class="form-label">State/Province</label>
                                    <input type="text" class="form-control" id="editState" name="state">
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="editPostalCode" class="form-label">Postal Code</label>
                                    <input type="text" class="form-control" id="editPostalCode" name="postal_code">
                                </div>
                                <div class="col-md-6">
                                    <label for="editCountry" class="form-label">Country</label>
                                    <input type="text" class="form-control" id="editCountry" name="country">
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <h6 class="mb-3 text-primary">Account Settings</h6>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="editIsActive" name="is_active">
                                    <label class="form-check-label" for="editIsActive">Active Account</label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="editIsEmailVerified" name="is_email_verified">
                                    <label class="form-check-label" for="editIsEmailVerified">Email Verified</label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="editIsStaff" name="is_staff">
                                    <label class="form-check-label" for="editIsStaff">Staff Member</label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="editIsSuperuser" name="is_superuser">
                                    <label class="form-check-label" for="editIsSuperuser">Administrator</label>
                                </div>
                            </div>

                            <hr>
                            
                            <h6 class="mb-3 text-primary">Profile Picture</h6>
                            <div class="mb-3">
                                <label for="editProfilePicture" class="form-label">Upload New Image</label>
                                <input type="file" class="form-control" id="editProfilePicture" name="profile_picture" accept="image/*">
                                <small class="form-text text-muted">Max file size: 5MB</small>
                            </div>

                            <div class="text-center mb-3">
                                <img id="editProfilePreview" src="#" alt="Current Profile" class="img-thumbnail" style="max-width: 150px; display: none;">
                            </div>

                            <hr>

                            <h6 class="mb-3 text-primary">System Information</h6>
                            <div class="mb-2">
                                <small class="text-muted">User ID:</small>
                                <div id="editUserIdDisplay" class="fw-bold">-</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Joined:</small>
                                <div id="editUserJoined" class="fw-bold">-</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Last Login:</small>
                                <div id="editUserLastLogin" class="fw-bold">-</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">Last Updated:</small>
                                <div id="editUserUpdated" class="fw-bold">-</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateUserBtn">
                    <i class="fas fa-save me-1"></i> Update User
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let selectedUserId = null;
    
    // Event listeners
    document.getElementById('refreshUsersBtn').addEventListener('click', function() {
        loadUsers(1);
    });
    
    document.getElementById('applyFiltersBtn').addEventListener('click', function() {
        loadUsers(1);
    });
    
    document.getElementById('saveUserBtn').addEventListener('click', saveUser);
    document.getElementById('updateUserBtn').addEventListener('click', updateUser);
    document.getElementById('deleteUserBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
            deleteUser(selectedUserId);
        }
    });
    
    document.getElementById('editUserBtn').addEventListener('click', function() {
        loadUserForEdit(selectedUserId);
    });
    
    document.getElementById('editUserBtnFooter').addEventListener('click', function() {
        loadUserForEdit(selectedUserId);
    });
    
    // Event delegation for dynamically created buttons
    document.addEventListener('click', function(e) {
        // Handle view user button clicks
        if (e.target.closest('.view-user-btn')) {
            const btn = e.target.closest('.view-user-btn');
            const userId = btn.dataset.userId;
            console.log('View user button clicked for userId:', userId);
            selectedUserId = userId;
            loadUserDetails(userId);
        }
        
        // Handle edit user button clicks
        if (e.target.closest('.edit-user-btn')) {
            const btn = e.target.closest('.edit-user-btn');
            const userId = btn.dataset.userId;
            console.log('Edit user button clicked for userId:', userId);
            loadUserForEdit(userId);
        }
        
        // Handle delete user button clicks
        if (e.target.closest('.delete-user-btn')) {
            const btn = e.target.closest('.delete-user-btn');
            const userId = btn.dataset.userId;
            console.log('Delete user button clicked for userId:', userId);
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                deleteUser(userId);
            }
        }
        
        // Handle view order button clicks
        if (e.target.closest('.view-order-btn')) {
            const btn = e.target.closest('.view-order-btn');
            const orderId = btn.dataset.orderId;
            console.log('View order button clicked for orderId:', orderId);
            // Add order viewing functionality here if needed
        }
    });
    
    // Password confirmation validation for Add User
    document.getElementById('confirmPassword').addEventListener('input', function() {
        const password = document.getElementById('password').value;
        const confirmPassword = this.value;
        
        if (password !== confirmPassword) {
            this.classList.add('is-invalid');
            document.getElementById('passwordMismatch').style.display = 'block';
        } else {
            this.classList.remove('is-invalid');
            document.getElementById('passwordMismatch').style.display = 'none';
        }
    });
    
    // Password confirmation validation for Edit User
    document.getElementById('confirmNewPassword').addEventListener('input', function() {
        const password = document.getElementById('newPassword').value;
        const confirmPassword = this.value;
        
        if (password && password !== confirmPassword) {
            this.classList.add('is-invalid');
            document.getElementById('editPasswordMismatch').style.display = 'block';
        } else {
            this.classList.remove('is-invalid');
            document.getElementById('editPasswordMismatch').style.display = 'none';
        }
    });
    
    // Profile picture preview for Add User
    document.getElementById('profilePicture').addEventListener('change', function() {
        const file = this.files[0];
        const preview = document.getElementById('profilePreview');
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            preview.style.display = 'none';
        }
    });
    
    // Profile picture preview for Edit User
    document.getElementById('editProfilePicture').addEventListener('change', function() {
        const file = this.files[0];
        const preview = document.getElementById('editProfilePreview');
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Initial data loading
    loadUsers(1);
    
    // Load users with pagination and filtering
    function loadUsers(page = 1) {
        currentPage = page;
        const searchTerm = document.getElementById('userSearchInput').value.trim();
        const statusFilter = document.getElementById('statusFilter').value;
        const roleFilter = document.getElementById('roleFilter').value;
        
        let url = `/mb-admin/api/users/?page=${page}`;
        
        if (searchTerm) {
            url += `&search=${encodeURIComponent(searchTerm)}`;
        }
        
        if (statusFilter !== '') {
            url += `&is_active=${statusFilter}`;
        }
        
        if (roleFilter !== '') {
            url += `&is_staff=${roleFilter}`;
        }
        
        // Show loading indicator
        document.getElementById('usersTableBody').innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading users...</p>
                </td>
            </tr>
        `;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                displayUsers(data.results || data);
                updatePagination(data);
                document.getElementById('usersTotalCount').textContent = data.count || 0;
            })
            .catch(error => {
                console.error('Error loading users:', error);
                document.getElementById('usersTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>Error loading users. Please try again.</p>
                        </td>
                    </tr>
                `;
            });
    }
    
    function displayUsers(users) {
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';
        
        if (!users || users.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">No users found.</td>
                </tr>
            `;
            return;
        }
        
        users.forEach(user => {
            const tr = document.createElement('tr');
            
            const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || '-';
            const roleBadge = user.is_staff ? 
                '<span class="badge bg-primary">Staff</span>' : 
                '<span class="badge bg-secondary">Customer</span>';
            const statusBadge = user.is_active ? 
                '<span class="badge bg-success">Active</span>' : 
                '<span class="badge bg-danger">Inactive</span>';
            const emailVerifiedBadge = user.is_email_verified ? 
                '<span class="badge bg-success"><i class="fas fa-check"></i> Verified</span>' : 
                '<span class="badge bg-warning"><i class="fas fa-exclamation-triangle"></i> Unverified</span>';
            
            tr.innerHTML = `
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td>${fullName}</td>
                <td>${user.email}</td>
                <td>${emailVerifiedBadge}</td>
                <td>${roleBadge}</td>
                <td>${statusBadge}</td>
                <td>${new Date(user.date_joined).toLocaleDateString()}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary view-user-btn" data-user-id="${user.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary edit-user-btn" data-user-id="${user.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger delete-user-btn" data-user-id="${user.id}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Event listeners are now handled by event delegation at the document level
        // This prevents duplicate listeners and improves performance
    }
    
    function updatePagination(data) {
        const pagination = document.getElementById('usersPagination');
        pagination.innerHTML = '';
        
        const totalPages = Math.ceil(data.count / data.results.length);
        if (totalPages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
        pagination.appendChild(prevLi);
        
        // Page numbers
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            pagination.appendChild(li);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
        pagination.appendChild(nextLi);
        
        // Add event listeners to pagination links
        document.querySelectorAll('#usersPagination .page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.dataset.page);
                loadUsers(page);
            });
        });
    }
    
    // User details
    function loadUserDetails(userId) {
        console.log('Loading user details for userId:', userId);
        
        fetch(`/mb-admin/api/users/${userId}/`)
            .then(response => {
                console.log('User API response status:', response.status);
                return response.json();
            })
            .then(user => {
                console.log('User data received:', user);
                displayUserDetails(user);
                
                // Load user's orders
                console.log('Loading orders for user:', userId);
                return fetch(`/mb-admin/api/orders/?user=${userId}`)
                    .then(response => {
                        console.log('Orders API response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Orders data received:', data);
                        displayUserOrders(data.results || data);
                    });
            })
            .catch(error => {
                console.error('Error loading user details:', error);
                showAlert('Failed to load user details.', 'danger');
            });
    }
    
    function displayUserDetails(user) {
        // Set user details
        document.getElementById('userDetailUsername').textContent = user.username;
        document.getElementById('userDetailRole').textContent = user.is_staff ? 'Staff' : 'Customer';
        document.getElementById('userDetailFirstName').textContent = user.first_name || '-';
        document.getElementById('userDetailLastName').textContent = user.last_name || '-';
        document.getElementById('userDetailEmail').textContent = user.email;
        document.getElementById('userDetailPhone').textContent = user.phone || '-';
        document.getElementById('userDetailDateOfBirth').textContent = user.date_of_birth || '-';
        
        // Address Information
        const addressLine1 = user.address_line_1 || '';
        const addressLine2 = user.address_line_2 || '';
        const fullAddress = [addressLine1, addressLine2].filter(Boolean).join(', ') || '-';
        document.getElementById('userDetailAddress').textContent = fullAddress;
        document.getElementById('userDetailCity').textContent = user.city || '-';
        document.getElementById('userDetailState').textContent = user.state || '-';
        document.getElementById('userDetailCountry').textContent = user.country || '-';
        
        // Account Information
        document.getElementById('userDetailEmailVerified').innerHTML = user.is_email_verified ? 
            '<span class="badge bg-success">Verified</span>' : 
            '<span class="badge bg-warning">Not Verified</span>';
        document.getElementById('userDetailStatus').innerHTML = user.is_active ? 
            '<span class="badge bg-success">Active</span>' : 
            '<span class="badge bg-danger">Inactive</span>';
        document.getElementById('userDetailJoined').textContent = new Date(user.date_joined).toLocaleDateString();
        document.getElementById('userDetailLastLogin').textContent = user.last_login ? 
            new Date(user.last_login).toLocaleDateString() : 'Never';
        document.getElementById('userDetailIsStaff').textContent = user.is_staff ? 'Yes' : 'No';
        document.getElementById('userDetailIsAdmin').textContent = user.is_superuser ? 'Yes' : 'No';
        
        // Profile Picture
        const profilePicture = document.getElementById('userProfilePicture');
        const defaultAvatar = document.getElementById('userDefaultAvatar');
        
        if (user.profile_picture) {
            profilePicture.src = user.profile_picture;
            profilePicture.style.display = 'block';
            defaultAvatar.style.display = 'none';
        } else {
            profilePicture.style.display = 'none';
            defaultAvatar.style.display = 'block';
        }
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
        modal.show();
    }
    
    function displayUserOrders(orders) {
        const tbody = document.getElementById('userOrdersTableBody');
        tbody.innerHTML = '';
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No orders found for this user.</td></tr>';
            return;
        }
        
        orders.forEach(order => {
            const tr = document.createElement('tr');
            
            let statusBadgeClass;
            switch (order.status) {
                case 'pending':
                    statusBadgeClass = 'bg-warning text-dark';
                    break;
                case 'processing':
                    statusBadgeClass = 'bg-info';
                    break;
                case 'shipped':
                    statusBadgeClass = 'bg-primary';
                    break;
                case 'delivered':
                    statusBadgeClass = 'bg-success';
                    break;
                case 'cancelled':
                    statusBadgeClass = 'bg-danger';
                    break;
                default:
                    statusBadgeClass = 'bg-secondary';
            }
            
            tr.innerHTML = `
                <td>${order.order_number}</td>
                <td>${new Date(order.created_at).toLocaleDateString()}</td>
                <td><span class="badge ${statusBadgeClass}">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</span></td>
                <td>$${parseFloat(order.total_amount || 0).toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-primary view-order-btn" data-order-id="${order.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(tr);
        });
        
        // Add event listeners to view order buttons
        document.querySelectorAll('.view-order-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.dataset.orderId;
                window.location.href = '/mb-admin/orders/?order=' + orderId;
            });
        });
    }
    
    // User CRUD operations
    function loadUserForEdit(userId) {
        fetch(`/mb-admin/api/users/${userId}/`)
            .then(response => response.json())
            .then(user => {
                // Basic Information
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editUsername').value = user.username;
                document.getElementById('editEmail').value = user.email;
                document.getElementById('editFirstName').value = user.first_name || '';
                document.getElementById('editLastName').value = user.last_name || '';
                document.getElementById('editPhone').value = user.phone || '';
                document.getElementById('editDateOfBirth').value = user.date_of_birth || '';
                
                // Address Information
                document.getElementById('editAddressLine1').value = user.address_line_1 || '';
                document.getElementById('editAddressLine2').value = user.address_line_2 || '';
                document.getElementById('editCity').value = user.city || '';
                document.getElementById('editState').value = user.state || '';
                document.getElementById('editPostalCode').value = user.postal_code || '';
                document.getElementById('editCountry').value = user.country || '';
                
                // Account Settings
                document.getElementById('editIsActive').checked = user.is_active;
                document.getElementById('editIsEmailVerified').checked = user.is_email_verified;
                document.getElementById('editIsStaff').checked = user.is_staff;
                document.getElementById('editIsSuperuser').checked = user.is_superuser;
                
                // Profile Picture
                const profilePreview = document.getElementById('editProfilePreview');
                if (user.profile_picture) {
                    profilePreview.src = user.profile_picture;
                    profilePreview.style.display = 'block';
                } else {
                    profilePreview.style.display = 'none';
                }
                
                // System Information
                document.getElementById('editUserIdDisplay').textContent = user.id;
                document.getElementById('editUserJoined').textContent = user.date_joined ? new Date(user.date_joined).toLocaleDateString() : '-';
                document.getElementById('editUserLastLogin').textContent = user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never';
                document.getElementById('editUserUpdated').textContent = user.updated_at ? new Date(user.updated_at).toLocaleDateString() : '-';
                
                // Clear password fields
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';
                
                // Clear file input
                document.getElementById('editProfilePicture').value = '';
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading user for edit:', error);
                showAlert('Failed to load user details for editing.', 'danger');
            });
    }
    
    function saveUser() {
        const form = document.getElementById('addUserForm');
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        // Validate passwords match
        if (password !== confirmPassword) {
            document.getElementById('confirmPassword').classList.add('is-invalid');
            document.getElementById('passwordMismatch').style.display = 'block';
            return;
        }
        
        // Collect form data
        const formData = new FormData(form);
        
        // Handle profile picture upload
        const profilePictureFile = document.getElementById('profilePicture').files[0];
        if (profilePictureFile) {
            // Use FormData for file upload
            formData.delete('confirmPassword'); // Remove confirm password field
            
            fetch('/mb-admin/api/users/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            })
            .then(handleCreateResponse)
            .then(handleCreateSuccess)
            .catch(handleCreateError);
        } else {
            // Use JSON for text data only
            const userData = {
                username: formData.get('username'),
                email: formData.get('email'),
                password: formData.get('password'),
                first_name: formData.get('first_name'),
                last_name: formData.get('last_name'),
                phone: formData.get('phone'),
                date_of_birth: formData.get('date_of_birth') || null,
                address_line_1: formData.get('address_line_1'),
                address_line_2: formData.get('address_line_2'),
                city: formData.get('city'),
                state: formData.get('state'),
                postal_code: formData.get('postal_code'),
                country: formData.get('country'),
                is_active: document.getElementById('isActive').checked,
                is_email_verified: document.getElementById('isEmailVerified').checked,
                is_staff: document.getElementById('isStaff').checked,
                is_superuser: document.getElementById('isSuperuser').checked
            };
            
            fetch('/mb-admin/api/users/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(userData)
            })
            .then(handleCreateResponse)
            .then(handleCreateSuccess)
            .catch(handleCreateError);
        }
        
        function handleCreateResponse(response) {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(JSON.stringify(data));
                });
            }
            return response.json();
        }
        
        function handleCreateSuccess(data) {
            // Close modal and refresh user list
            const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
            modal.hide();
            form.reset();
            
            // Clear profile picture preview
            document.getElementById('profilePreview').style.display = 'none';
            
            loadUsers();
            showAlert('User created successfully!', 'success');
        }
        
        function handleCreateError(error) {
            console.error('Error creating user:', error);
            showAlert('Failed to create user. ' + error.message, 'danger');
        }
    }
    
    function updateUser() {
        const form = document.getElementById('editUserForm');
        const userId = document.getElementById('editUserId').value;
        
        // Validate passwords match if provided
        const password = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmNewPassword').value;
        
        if (password && password !== confirmPassword) {
            document.getElementById('confirmNewPassword').classList.add('is-invalid');
            document.getElementById('editPasswordMismatch').style.display = 'block';
            return;
        }
        
        // Collect form data
        const formData = new FormData(form);
        const userData = {
            username: formData.get('username'),
            email: formData.get('email'),
            first_name: formData.get('first_name'),
            last_name: formData.get('last_name'),
            phone: formData.get('phone'),
            date_of_birth: formData.get('date_of_birth') || null,
            address_line_1: formData.get('address_line_1'),
            address_line_2: formData.get('address_line_2'),
            city: formData.get('city'),
            state: formData.get('state'),
            postal_code: formData.get('postal_code'),
            country: formData.get('country'),
            is_active: document.getElementById('editIsActive').checked,
            is_email_verified: document.getElementById('editIsEmailVerified').checked,
            is_staff: document.getElementById('editIsStaff').checked,
            is_superuser: document.getElementById('editIsSuperuser').checked
        };
        
        // Add password only if provided
        if (password) {
            userData.password = password;
        }
        
        // Handle profile picture upload
        const profilePictureFile = document.getElementById('editProfilePicture').files[0];
        if (profilePictureFile) {
            formData.append('profile_picture', profilePictureFile);
            // Use FormData for file upload
            formData.delete('confirmNewPassword'); // Remove confirm password field
            
            fetch(`/mb-admin/api/users/${userId}/`, {
                method: 'PUT',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            })
            .then(handleUpdateResponse)
            .catch(handleUpdateError);
        } else {
            // Use JSON for text data only
            fetch(`/mb-admin/api/users/${userId}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(userData)
            })
            .then(handleUpdateResponse)
            .catch(handleUpdateError);
        }
        
        function handleUpdateResponse(response) {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(JSON.stringify(data));
                });
            }
            return response.json();
        }
        
        function handleUpdateError(error) {
            console.error('Error updating user:', error);
            showAlert('Failed to update user. ' + error.message, 'danger');
        }
        
        function handleUpdateSuccess(data) {
            // Close modal and refresh user list
            const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
            modal.hide();
            
            // Refresh user list
            loadUsers(currentPage);
            
            // Refresh user details if viewing
            if (selectedUserId === userId) {
                loadUserDetails(userId);
            }
            
            showAlert('User updated successfully!', 'success');
        }
        
        // Update the promise chain
        if (profilePictureFile) {
            fetch(`/mb-admin/api/users/${userId}/`, {
                method: 'PUT',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            })
            .then(handleUpdateResponse)
            .then(handleUpdateSuccess)
            .catch(handleUpdateError);
        } else {
            fetch(`/mb-admin/api/users/${userId}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(userData)
            })
            .then(handleUpdateResponse)
            .then(handleUpdateSuccess)
            .catch(handleUpdateError);
        }
    }
    
    function deleteUser(userId) {
        fetch(`/mb-admin/api/users/${userId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete user');
            }
            
            // Hide user details modal if currently viewing
            if (selectedUserId === userId) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('userDetailsModal'));
                if (modal) {
                    modal.hide();
                }
                selectedUserId = null;
            }
            
            // Refresh user list
            loadUsers(currentPage);
            
            showAlert('User deleted successfully!', 'success');
        })
        .catch(error => {
            console.error('Error deleting user:', error);
            showAlert('Failed to delete user.', 'danger');
        });
    }
    
    // Helper functions
    function showAlert(message, type) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Insert at the top of the content area
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                const bsAlert = bootstrap.Alert.getOrCreateInstance(alertDiv);
                bsAlert.close();
            }
        }, 5000);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}