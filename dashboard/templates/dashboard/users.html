{% extends 'dashboard/base.html' %}

{% block title %}Users - MB Admin{% endblock %}

{% block page_title %}Users Management{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">All Users</h5>
        <div>
            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal">
                <i class="fas fa-plus-circle me-1"></i> Add User
            </button>
            <button class="btn btn-sm btn-secondary" id="refreshUsersBtn">
                <i class="fas fa-sync-alt me-1"></i> Refresh
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <div class="row g-2">
                <div class="col-md-4">
                    <input type="text" class="form-control form-control-sm" id="userSearchInput" placeholder="Search by name, email...">
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" id="roleFilter">
                        <option value="">All Roles</option>
                        <option value="true">Staff</option>
                        <option value="false">Customer</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary btn-sm w-100" id="applyFiltersBtn">
                        <i class="fas fa-filter me-1"></i> Filter
                    </button>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading users...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <span id="usersTotalCount">0</span> users
            </div>
            <div>
                <nav aria-label="Users pagination">
                    <ul class="pagination pagination-sm" id="usersPagination"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- User details section -->
<div class="card" id="userDetailsCard" style="display: none;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">User Details</h5>
        <button type="button" class="btn-close" id="closeUserDetailsBtn" aria-label="Close"></button>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3 text-center mb-4 mb-md-0">
                <div class="avatar-container mb-3">
                    <i class="fas fa-user-circle fa-6x text-secondary"></i>
                </div>
                <h5 id="userDetailUsername" class="mb-1"></h5>
                <p id="userDetailRole" class="badge bg-primary mb-3"></p>
                <div class="d-grid gap-2">
                    <button class="btn btn-sm btn-outline-primary" id="editUserBtn">
                        <i class="fas fa-edit me-1"></i> Edit User
                    </button>
                    <button class="btn btn-sm btn-outline-danger" id="deleteUserBtn">
                        <i class="fas fa-trash-alt me-1"></i> Delete User
                    </button>
                </div>
            </div>
            <div class="col-md-9">
                <h6 class="mb-3">Personal Information</h6>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">First Name</dt>
                            <dd class="col-sm-8" id="userDetailFirstName"></dd>
                            
                            <dt class="col-sm-4">Last Name</dt>
                            <dd class="col-sm-8" id="userDetailLastName"></dd>
                            
                            <dt class="col-sm-4">Email</dt>
                            <dd class="col-sm-8" id="userDetailEmail"></dd>
                            
                            <dt class="col-sm-4">Status</dt>
                            <dd class="col-sm-8" id="userDetailStatus"></dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">Joined</dt>
                            <dd class="col-sm-8" id="userDetailJoined"></dd>
                            
                            <dt class="col-sm-4">Last Login</dt>
                            <dd class="col-sm-8" id="userDetailLastLogin"></dd>
                            
                            <dt class="col-sm-4">Staff</dt>
                            <dd class="col-sm-8" id="userDetailIsStaff"></dd>
                            
                            <dt class="col-sm-4">Admin</dt>
                            <dd class="col-sm-8" id="userDetailIsAdmin"></dd>
                        </dl>
                    </div>
                </div>
                
                <h6 class="mb-3">Recent Orders</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userOrdersTableBody">
                            <tr>
                                <td colspan="5" class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="ms-2">Loading orders...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="col-md-6">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="col-md-6">
                            <label for="confirmPassword" class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                            <div class="invalid-feedback" id="passwordMismatch">Passwords do not match</div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="firstName" name="first_name">
                        </div>
                        <div class="col-md-6">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="lastName" name="last_name">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isActive" name="is_active" checked>
                                <label class="form-check-label" for="isActive">
                                    Active
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isStaff" name="is_staff">
                                <label class="form-check-label" for="isStaff">
                                    Staff
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveUserBtn">Save User</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="editUsername" name="username" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editEmail" name="email" required>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editFirstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="editFirstName" name="first_name">
                        </div>
                        <div class="col-md-6">
                            <label for="editLastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="editLastName" name="last_name">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="editIsActive" name="is_active">
                            <label class="form-check-label" for="editIsActive">Active</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="editIsStaff" name="is_staff">
                            <label class="form-check-label" for="editIsStaff">Staff</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="editIsSuperuser" name="is_superuser">
                            <label class="form-check-label" for="editIsSuperuser">Admin</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password (leave blank to keep current)</label>
                        <input type="password" class="form-control" id="newPassword" name="password">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateUserBtn">Update User</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let selectedUserId = null;
    
    // Event listeners
    document.getElementById('refreshUsersBtn').addEventListener('click', function() {
        loadUsers(1);
    });
    
    document.getElementById('applyFiltersBtn').addEventListener('click', function() {
        loadUsers(1);
    });
    
    document.getElementById('closeUserDetailsBtn').addEventListener('click', function() {
        document.getElementById('userDetailsCard').style.display = 'none';
    });
    
    document.getElementById('saveUserBtn').addEventListener('click', saveUser);
    document.getElementById('updateUserBtn').addEventListener('click', updateUser);
    document.getElementById('deleteUserBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
            deleteUser(selectedUserId);
        }
    });
    
    document.getElementById('editUserBtn').addEventListener('click', function() {
        loadUserForEdit(selectedUserId);
    });
    
    // Password confirmation validation
    document.getElementById('confirmPassword').addEventListener('input', function() {
        const password = document.getElementById('password').value;
        const confirmPassword = this.value;
        
        if (password !== confirmPassword) {
            this.classList.add('is-invalid');
            document.getElementById('passwordMismatch').style.display = 'block';
        } else {
            this.classList.remove('is-invalid');
            document.getElementById('passwordMismatch').style.display = 'none';
        }
    });
    
    // Initial data loading
    loadUsers(1);
    
    // Load users with pagination and filtering
    function loadUsers(page = 1) {
        currentPage = page;
        const searchTerm = document.getElementById('userSearchInput').value.trim();
        const statusFilter = document.getElementById('statusFilter').value;
        const roleFilter = document.getElementById('roleFilter').value;
        
        let url = `/mb-admin/api/users/?page=${page}`;
        
        if (searchTerm) {
            url += `&search=${encodeURIComponent(searchTerm)}`;
        }
        
        if (statusFilter !== '') {
            url += `&is_active=${statusFilter}`;
        }
        
        if (roleFilter !== '') {
            url += `&is_staff=${roleFilter}`;
        }
        
        // Show loading indicator
        document.getElementById('usersTableBody').innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading users...</p>
                </td>
            </tr>
        `;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                displayUsers(data.results || data);
                updatePagination(data);
                document.getElementById('usersTotalCount').textContent = data.count || 0;
            })
            .catch(error => {
                console.error('Error loading users:', error);
                document.getElementById('usersTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>Error loading users. Please try again.</p>
                        </td>
                    </tr>
                `;
            });
    }
    
    function displayUsers(users) {
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';
        
        if (!users || users.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">No users found.</td>
                </tr>
            `;
            return;
        }
        
        users.forEach(user => {
            const tr = document.createElement('tr');
            
            const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || '-';
            const roleBadge = user.is_staff ? 
                '<span class="badge bg-primary">Staff</span>' : 
                '<span class="badge bg-secondary">Customer</span>';
            const statusBadge = user.is_active ? 
                '<span class="badge bg-success">Active</span>' : 
                '<span class="badge bg-danger">Inactive</span>';
            
            tr.innerHTML = `
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td>${fullName}</td>
                <td>${user.email}</td>
                <td>${roleBadge}</td>
                <td>${statusBadge}</td>
                <td>${new Date(user.date_joined).toLocaleDateString()}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary view-user-btn" data-user-id="${user.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary edit-user-btn" data-user-id="${user.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger delete-user-btn" data-user-id="${user.id}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Add event listeners to action buttons
        document.querySelectorAll('.view-user-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.dataset.userId;
                selectedUserId = userId;
                loadUserDetails(userId);
            });
        });
        
        document.querySelectorAll('.edit-user-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.dataset.userId;
                loadUserForEdit(userId);
            });
        });
        
        document.querySelectorAll('.delete-user-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.dataset.userId;
                if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                    deleteUser(userId);
                }
            });
        });
    }
    
    function updatePagination(data) {
        const pagination = document.getElementById('usersPagination');
        pagination.innerHTML = '';
        
        const totalPages = Math.ceil(data.count / data.results.length);
        if (totalPages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
        pagination.appendChild(prevLi);
        
        // Page numbers
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            pagination.appendChild(li);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
        pagination.appendChild(nextLi);
        
        // Add event listeners to pagination links
        document.querySelectorAll('#usersPagination .page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.dataset.page);
                loadUsers(page);
            });
        });
    }
    
    // User details
    function loadUserDetails(userId) {
        fetch(`/mb-admin/api/users/${userId}/`)
            .then(response => response.json())
            .then(user => {
                displayUserDetails(user);
                
                // Load user's orders
                return fetch(`/mb-admin/api/orders/?user=${userId}`)
                    .then(response => response.json())
                    .then(data => {
                        displayUserOrders(data.results || data);
                    });
            })
            .catch(error => {
                console.error('Error loading user details:', error);
                showAlert('Failed to load user details.', 'danger');
            });
    }
    
    function displayUserDetails(user) {
        // Show user details card
        document.getElementById('userDetailsCard').style.display = 'block';
        
        // Set user details
        document.getElementById('userDetailUsername').textContent = user.username;
        document.getElementById('userDetailRole').textContent = user.is_staff ? 'Staff' : 'Customer';
        document.getElementById('userDetailFirstName').textContent = user.first_name || '-';
        document.getElementById('userDetailLastName').textContent = user.last_name || '-';
        document.getElementById('userDetailEmail').textContent = user.email;
        
        const statusHtml = user.is_active ? 
            '<span class="badge bg-success">Active</span>' : 
            '<span class="badge bg-danger">Inactive</span>';
        document.getElementById('userDetailStatus').innerHTML = statusHtml;
        
        document.getElementById('userDetailJoined').textContent = new Date(user.date_joined).toLocaleString();
        document.getElementById('userDetailLastLogin').textContent = user.last_login ? new Date(user.last_login).toLocaleString() : 'Never';
        document.getElementById('userDetailIsStaff').textContent = user.is_staff ? 'Yes' : 'No';
        document.getElementById('userDetailIsAdmin').textContent = user.is_superuser ? 'Yes' : 'No';
    }
    
    function displayUserOrders(orders) {
        const tbody = document.getElementById('userOrdersTableBody');
        tbody.innerHTML = '';
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No orders found for this user.</td></tr>';
            return;
        }
        
        orders.forEach(order => {
            const tr = document.createElement('tr');
            
            let statusBadgeClass;
            switch (order.status) {
                case 'pending':
                    statusBadgeClass = 'bg-warning text-dark';
                    break;
                case 'processing':
                    statusBadgeClass = 'bg-info';
                    break;
                case 'shipped':
                    statusBadgeClass = 'bg-primary';
                    break;
                case 'delivered':
                    statusBadgeClass = 'bg-success';
                    break;
                case 'cancelled':
                    statusBadgeClass = 'bg-danger';
                    break;
                default:
                    statusBadgeClass = 'bg-secondary';
            }
            
            tr.innerHTML = `
                <td>${order.order_number}</td>
                <td>${new Date(order.created_at).toLocaleDateString()}</td>
                <td><span class="badge ${statusBadgeClass}">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</span></td>
                <td>$${order.total_amount.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-primary view-order-btn" data-order-id="${order.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(tr);
        });
        
        // Add event listeners to view order buttons
        document.querySelectorAll('.view-order-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.dataset.orderId;
                window.location.href = '/mb-admin/orders/?order=' + orderId;
            });
        });
    }
    
    // User CRUD operations
    function loadUserForEdit(userId) {
        fetch(`/mb-admin/api/users/${userId}/`)
            .then(response => response.json())
            .then(user => {
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editUsername').value = user.username;
                document.getElementById('editEmail').value = user.email;
                document.getElementById('editFirstName').value = user.first_name || '';
                document.getElementById('editLastName').value = user.last_name || '';
                document.getElementById('editIsActive').checked = user.is_active;
                document.getElementById('editIsStaff').checked = user.is_staff;
                document.getElementById('editIsSuperuser').checked = user.is_superuser;
                
                // Clear password field
                document.getElementById('newPassword').value = '';
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading user for edit:', error);
                showAlert('Failed to load user details for editing.', 'danger');
            });
    }
    
    function saveUser() {
        const form = document.getElementById('addUserForm');
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        // Validate passwords match
        if (password !== confirmPassword) {
            document.getElementById('confirmPassword').classList.add('is-invalid');
            document.getElementById('passwordMismatch').style.display = 'block';
            return;
        }
        
        // Collect form data
        const formData = new FormData(form);
        const userData = {
            username: formData.get('username'),
            email: formData.get('email'),
            password: formData.get('password'),
            first_name: formData.get('first_name'),
            last_name: formData.get('last_name'),
            is_active: formData.get('is_active') === 'on',
            is_staff: formData.get('is_staff') === 'on'
        };
        
        fetch('/mb-admin/api/users/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(userData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(JSON.stringify(data));
                });
            }
            return response.json();
        })
        .then(data => {
            // Close modal and refresh user list
            const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
            modal.hide();
            form.reset();
            loadUsers();
            showAlert('User created successfully!', 'success');
        })
        .catch(error => {
            console.error('Error creating user:', error);
            showAlert('Failed to create user. ' + error.message, 'danger');
        });
    }
    
    function updateUser() {
        const form = document.getElementById('editUserForm');
        const userId = document.getElementById('editUserId').value;
        
        // Collect form data
        const formData = new FormData(form);
        const userData = {
            username: formData.get('username'),
            email: formData.get('email'),
            first_name: formData.get('first_name'),
            last_name: formData.get('last_name'),
            is_active: formData.get('is_active') === 'on',
            is_staff: formData.get('is_staff') === 'on',
            is_superuser: formData.get('is_superuser') === 'on'
        };
        
        // Add password only if provided
        const password = formData.get('password');
        if (password) {
            userData.password = password;
        }
        
        fetch(`/mb-admin/api/users/${userId}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(userData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(JSON.stringify(data));
                });
            }
            return response.json();
        })
        .then(data => {
            // Close modal and refresh user list
            const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
            modal.hide();
            
            // Refresh user list
            loadUsers(currentPage);
            
            // Refresh user details if viewing
            if (selectedUserId === userId) {
                loadUserDetails(userId);
            }
            
            showAlert('User updated successfully!', 'success');
        })
        .catch(error => {
            console.error('Error updating user:', error);
            showAlert('Failed to update user. ' + error.message, 'danger');
        });
    }
    
    function deleteUser(userId) {
        fetch(`/mb-admin/api/users/${userId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete user');
            }
            
            // Hide user details if currently viewing
            if (selectedUserId === userId) {
                document.getElementById('userDetailsCard').style.display = 'none';
                selectedUserId = null;
            }
            
            // Refresh user list
            loadUsers(currentPage);
            
            showAlert('User deleted successfully!', 'success');
        })
        .catch(error => {
            console.error('Error deleting user:', error);
            showAlert('Failed to delete user.', 'danger');
        });
    }
    
    // Helper functions
    function showAlert(message, type) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Insert at the top of the content area
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                const bsAlert = bootstrap.Alert.getOrCreateInstance(alertDiv);
                bsAlert.close();
            }
        }, 5000);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}