{% extends 'dashboard/base.html' %}

{% block title %}Statistics - MB Admin{% endblock %}

{% block page_title %}
    Sales & Performance Statistics 
    <small class="text-muted">
        <i class="fas fa-clock me-1"></i>
        Dhaka, Bangladesh Time (UTC +6)
    </small>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-3">
                    <div>
                        <h5 class="mb-0">Time Period</h5>
                        <small class="text-muted">
                            <i class="fas fa-globe-asia me-1"></i>
                            All times shown in Dhaka timezone
                        </small>
                    </div>
                    <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center gap-2 gap-sm-3 w-sm-auto">
                        <div class="dropdown w-100 w-sm-auto">
                            <select class="form-select form-select-sm" id="period-filter" style="min-width: 150px;">
                                <option value="week">This Week</option>
                                <option value="month" selected>This Month</option>
                                <option value="last_month">Last Month</option>
                                <option value="year">This Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <!-- Custom Date Range Picker (initially hidden) -->
                        <div id="custom-date-range" class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center gap-2 w-100 w-sm-auto" style="display: none;">
                            <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center gap-2 w-100 w-sm-auto">
                                <div class="input-group input-group-sm w-100" style="max-width: 140px;">
                                    <span class="input-group-text bg-light">
                                        <i class="fas fa-calendar text-muted" style="font-size: 0.75rem;"></i>
                                    </span>
                                    <input type="date" class="form-control" id="custom-date-from" title="From Date">
                                </div>
                                <span class="text-muted d-none d-sm-inline">to</span>
                                <span class="text-muted d-sm-none small">to</span>
                                <div class="input-group input-group-sm w-100" style="max-width: 140px;">
                                    <span class="input-group-text bg-light">
                                        <i class="fas fa-calendar text-muted" style="font-size: 0.75rem;"></i>
                                    </span>
                                    <input type="date" class="form-control" id="custom-date-to" title="To Date">
                                </div>
                            </div>
                            <div class="d-flex gap-2 w-100 w-sm-auto">
                                <button class="btn btn-sm btn-primary flex-fill flex-sm-grow-0" id="apply-custom-range" title="Apply Custom Range">
                                    <i class="fas fa-check"></i>
                                    <span class="d-sm-none ms-1">Apply</span>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary flex-fill flex-sm-grow-0" id="cancel-custom-range" title="Cancel">
                                    <i class="fas fa-times"></i>
                                    <span class="d-sm-none ms-1">Cancel</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 mb-3">
        <div class="card stat-card h-100 border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="flex-grow-1">
                        <div class="stat-icon-wrapper sales mb-3">
                            <i class="fas fa-money-bill-wave fa-lg"></i>
                        </div>
                        <h2 class="stat-value mb-1" id="total-sales-stat">$0.00</h2>
                        <h6 class="stat-title mb-2">Total Sales Amount</h6>
                        <div class="stat-description">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Delivered + Shipped + Partial Returns
                            </small>
                        </div>
                    </div>
                    <div class="stat-trend">
                        <span class="trend-indicator trend-up" id="sales-trend">
                            <i class="fas fa-arrow-up"></i>
                            <span>12.5%</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="card-footer stat-footer sales-footer">
                <div class="progress" style="height: 3px;">
                    <div class="progress-bar" role="progressbar" style="width: 75%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 mb-3">
        <div class="card stat-card h-100 border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="flex-grow-1">
                        <div class="stat-icon-wrapper orders mb-3">
                            <i class="fas fa-shopping-cart fa-lg"></i>
                        </div>
                        <h2 class="stat-value mb-1" id="total-orders-stat">0</h2>
                        <h6 class="stat-title mb-2">Total Orders</h6>
                        <div class="stat-description">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                All order count
                            </small>
                        </div>
                    </div>
                    <div class="stat-trend">
                        <span class="trend-indicator trend-up" id="orders-trend">
                            <i class="fas fa-arrow-up"></i>
                            <span>8.3%</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="card-footer stat-footer orders-footer">
                <div class="progress" style="height: 3px;">
                    <div class="progress-bar" role="progressbar" style="width: 60%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 mb-3">
        <div class="card stat-card h-100 border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="flex-grow-1">
                        <div class="stat-icon-wrapper expenses mb-3">
                            <i class="fas fa-receipt fa-lg"></i>
                        </div>
                        <h2 class="stat-value mb-1" id="total-expenses-stat">$0.00</h2>
                        <h6 class="stat-title mb-2">Total Expenses</h6>
                        <div class="stat-description">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Business expenses + Courier charges
                            </small>
                        </div>
                    </div>
                    <div class="stat-trend">
                        <span class="trend-indicator trend-down" id="expenses-trend">
                            <i class="fas fa-arrow-down"></i>
                            <span>3.2%</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="card-footer stat-footer expenses-footer">
                <div class="progress" style="height: 3px;">
                    <div class="progress-bar" role="progressbar" style="width: 45%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 mb-3">
        <div class="card stat-card h-100 border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="flex-grow-1">
                        <div class="stat-icon-wrapper revenue mb-3">
                            <i class="fas fa-chart-line fa-lg"></i>
                        </div>
                        <h2 class="stat-value mb-1" id="total-revenue-stat">$0.00</h2>
                        <h6 class="stat-title mb-2">Total Revenue</h6>
                        <div class="stat-description">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Sales - (Expenses + Product Cost)
                            </small>
                        </div>
                    </div>
                    <div class="stat-trend">
                        <span class="trend-indicator trend-up" id="revenue-trend">
                            <i class="fas fa-arrow-up"></i>
                            <span>15.7%</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="card-footer stat-footer revenue-footer">
                <div class="progress" style="height: 3px;">
                    <div class="progress-bar" role="progressbar" style="width: 85%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 mb-3">
        <div class="card detail-stat-card h-100 border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="d-flex align-items-start">
                    <div class="detail-stat-icon courier me-3">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="detail-stat-title mb-0">Total Courier Charge</h6>
                            <span class="badge bg-primary-subtle text-primary rounded-pill">Active</span>
                        </div>
                        <h3 class="detail-stat-value detail-stat-value-courier mb-2" id="total-courier-charge-stat">$0.00</h3>
                        <div class="detail-stat-description">
                            <small class="text-muted d-block">
                                <i class="fas fa-box me-1"></i>
                                Delivered + Shipped + Returned + Partially Returned
                            </small>
                        </div>
                        <div class="mt-3">
                            <div class="progress" style="height: 4px; border-radius: 2px;">
                                <div class="progress-bar bg-primary" style="width: 68%"></div>
                            </div>
                            <small class="text-muted mt-1 d-block">68% of total expenses</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 mb-3">
        <div class="card detail-stat-card h-100 border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="d-flex align-items-start">
                    <div class="detail-stat-icon dashboard me-3">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="detail-stat-title mb-0">Dashboard Expenses</h6>
                            <span class="badge bg-info-subtle text-info rounded-pill">Operational</span>
                        </div>
                        <h3 class="detail-stat-value detail-stat-value-dashboard mb-2" id="dashboard-expenses-stat">$0.00</h3>
                        <div class="detail-stat-description">
                            <small class="text-muted d-block">
                                <i class="fas fa-building me-1"></i>
                                Business operational expenses
                            </small>
                        </div>
                        <div class="mt-3">
                            <div class="progress" style="height: 4px; border-radius: 2px;">
                                <div class="progress-bar bg-info" style="width: 32%"></div>
                            </div>
                            <small class="text-muted mt-1 d-block">32% of total expenses</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 mb-3">
        <div class="card detail-stat-card h-100 border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="d-flex align-items-start">
                    <div class="detail-stat-icon product me-3">
                        <i class="fas fa-box-open"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="detail-stat-title mb-0">Product Cost</h6>
                            <span class="badge bg-success-subtle text-success rounded-pill">Cost of Goods</span>
                        </div>
                        <h3 class="detail-stat-value detail-stat-value-product mb-2" id="product-cost-stat">$0.00</h3>
                        <div class="detail-stat-description">
                            <small class="text-muted d-block">
                                <i class="fas fa-tags me-1"></i>
                                Cost of goods for delivered & shipped orders
                            </small>
                        </div>
                        <div class="mt-3">
                            <div class="progress" style="height: 4px; border-radius: 2px;">
                                <div class="progress-bar bg-success" style="width: 55%"></div>
                            </div>
                            <small class="text-muted mt-1 d-block">55% of total revenue</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 mb-3">
        <div class="card detail-stat-card h-100 border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="d-flex align-items-start">
                    <div class="detail-stat-icon margin me-3">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="detail-stat-title mb-0">Profit Margin</h6>
                            <span class="badge bg-warning-subtle text-warning rounded-pill" id="margin-status-badge">Healthy</span>
                        </div>
                        <h3 class="detail-stat-value detail-stat-value-margin mb-2" id="profit-margin-stat">0%</h3>
                        <div class="detail-stat-description">
                            <small class="text-muted d-block">
                                <i class="fas fa-chart-pie me-1"></i>
                                Revenue as % of sales
                            </small>
                        </div>
                        <div class="mt-3">
                            <div class="progress" style="height: 4px; border-radius: 2px;">
                                <div class="progress-bar bg-warning" style="width: 0%" id="margin-progress"></div>
                            </div>
                            <small class="text-muted mt-1 d-block" id="margin-indicator">Target: 15-25%</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card h-100 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center bg-gradient-primary text-white">
                <div class="d-flex align-items-center">
                    <i class="fas fa-chart-line me-2"></i>
                    <h5 class="mb-0">Financial Performance Overview</h5>
                </div>
                <div class="d-flex gap-2">
                    <!-- Year Filter -->
                    <select class="form-select form-select-sm" id="year-filter" style="width: auto; min-width: 120px;">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="all">All Years</option>
                    </select>
                    
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light dropdown-toggle" type="button" id="salesChartDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-cog me-1"></i> Options
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="salesChartDropdown">
                            <li><h6 class="dropdown-header">Chart Type</h6></li>
                            <li><a class="dropdown-item chart-type-option active" data-type="line" href="#">
                                <i class="fas fa-chart-line me-2"></i> Line Chart
                            </a></li>
                            <li><a class="dropdown-item chart-type-option" data-type="bar" href="#">
                                <i class="fas fa-chart-bar me-2"></i> Bar Chart
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">View Options</h6></li>
                            <li><a class="dropdown-item" href="#" id="toggle-grid">
                                <i class="fas fa-border-all me-2"></i> Toggle Grid
                            </a></li>
                            <li><a class="dropdown-item" href="#" id="toggle-animation">
                                <i class="fas fa-play me-2"></i> Toggle Animation
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body p-3">
                <!-- Legend with custom styling -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="d-flex flex-wrap justify-content-center gap-3">
                            <div class="legend-item d-flex align-items-center">
                                <div class="legend-color" style="background: linear-gradient(45deg, #28a745, #20c997); width: 16px; height: 16px; border-radius: 50%; margin-right: 8px; box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);"></div>
                                <span class="badge bg-success-subtle text-success fw-medium">Sales Revenue</span>
                            </div>
                            <div class="legend-item d-flex align-items-center">
                                <div class="legend-color" style="background: linear-gradient(45deg, #dc3545, #fd7e14); width: 16px; height: 16px; border-radius: 50%; margin-right: 8px; box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);"></div>
                                <span class="badge bg-danger-subtle text-danger fw-medium">Total Expenses</span>
                            </div>
                            <div class="legend-item d-flex align-items-center">
                                <div class="legend-color" style="background: linear-gradient(45deg, #007bff, #6f42c1); width: 16px; height: 16px; border-radius: 50%; margin-right: 8px; box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);"></div>
                                <span class="badge bg-primary-subtle text-primary fw-medium">Net Revenue</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="height: 400px; position: relative;">
                    <canvas id="salesChart"></canvas>
                    <!-- Loading overlay -->
                    <div id="chart-loading" class="position-absolute top-50 start-50 translate-middle d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading chart data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Sales by Category</h5>
            </div>
            <div class="card-body">
                <div style="height: 350px;">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Product Performance</h5>
                <div class="d-flex gap-2 align-items-center">
                    <select class="form-select form-select-sm" id="products-sort" style="width: auto;">
                        <option value="orders">Sort by Orders</option>
                        <option value="delivered">Sort by Delivered</option>
                        <option value="revenue">Sort by Revenue</option>
                        <option value="name">Sort by Name</option>
                    </select>
                    <button class="btn btn-sm btn-outline-secondary" id="products-refresh">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Search and Date Filter Controls -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="products-search" placeholder="Search products...">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                            <input type="date" class="form-control" id="products-date-from" title="From Date">
                            <input type="date" class="form-control" id="products-date-to" title="To Date">
                        </div>
                    </div>
                </div>
                
                <!-- Results Summary -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted" id="products-summary">Loading products...</small>
                    <div class="d-flex gap-1">
                        <button class="btn btn-xs btn-outline-primary" id="products-clear-filters" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">
                            Clear Filters
                        </button>
                        <button class="btn btn-xs btn-outline-success" id="products-export" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-sm table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th style="cursor: pointer;" data-sort="name">
                                    Product Name 
                                    <i class="fas fa-sort text-muted ms-1"></i>
                                </th>
                                <th style="cursor: pointer;" data-sort="orders" class="text-center">
                                    Orders 
                                    <i class="fas fa-sort text-muted ms-1"></i>
                                </th>
                                <th style="cursor: pointer;" data-sort="delivered" class="text-center">
                                    Delivered 
                                    <i class="fas fa-sort text-muted ms-1"></i>
                                </th>
                                <th style="cursor: pointer;" data-sort="revenue" class="text-end">
                                    Revenue 
                                    <i class="fas fa-sort text-muted ms-1"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="top-products-table">
                            <tr>
                                <td colspan="4" class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="ms-2">Loading product data...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <nav aria-label="Products pagination" class="mt-3">
                    <ul class="pagination pagination-sm justify-content-center mb-0" id="products-pagination">
                        <!-- Pagination will be generated by JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-gradient-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Order Status Breakdown
                    </h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light dropdown-toggle" type="button" id="statusChartDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-cog"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="statusChartDropdown">
                            <li><a class="dropdown-item status-chart-type" data-type="pie" href="#">
                                <i class="fas fa-chart-pie me-2"></i>Pie Chart
                            </a></li>
                            <li><a class="dropdown-item status-chart-type active" data-type="doughnut" href="#">
                                <i class="fas fa-dot-circle me-2"></i>Doughnut Chart
                            </a></li>
                            <li><a class="dropdown-item status-chart-type" data-type="bar" href="#">
                                <i class="fas fa-chart-bar me-2"></i>Bar Chart
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Date Filter Controls for Order Status -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="status-filter-controls">
                            <div class="d-flex gap-2 align-items-center flex-wrap">
                            <small class="text-muted fw-medium me-2">
                                <i class="fas fa-calendar-alt me-1"></i>Filter by Date:
                            </small>
                            <div class="input-group input-group-sm" style="width: auto; min-width: 140px;">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-calendar text-muted" style="font-size: 0.75rem;"></i>
                                </span>
                                <input type="date" class="form-control border-start-0" id="status-date-from" 
                                       title="From Date" placeholder="From Date">
                            </div>
                            <span class="text-muted mx-1">to</span>
                            <div class="input-group input-group-sm" style="width: auto; min-width: 140px;">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-calendar text-muted" style="font-size: 0.75rem;"></i>
                                </span>
                                <input type="date" class="form-control border-start-0" id="status-date-to" 
                                       title="To Date" placeholder="To Date">
                            </div>
                            <button class="btn btn-sm btn-outline-primary" id="status-apply-filter" title="Apply Date Filter">
                                <i class="fas fa-filter"></i> Apply
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="status-clear-filter" title="Clear Date Filter">
                                <i class="fas fa-times"></i> Clear
                            </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container position-relative" style="height: 280px;">
                            <canvas id="orderStatusChart"></canvas>
                            <!-- Loading overlay for chart -->
                            <div id="status-chart-loading" class="position-absolute top-50 start-50 translate-middle d-none">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- Status Summary Cards -->
                        <div class="mb-3">
                            <div class="row g-2" id="status-summary-cards">
                                <div class="col-12">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2 mb-0 text-muted">Loading status summary...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                    </div>
                    <!-- Detailed Status Table -->
                        <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th><i class="fas fa-tag me-1"></i>Status</th>
                                        <th class="text-center"><i class="fas fa-hashtag me-1"></i>Count</th>
                                        <th class="text-end"><i class="fas fa-percentage me-1"></i>%</th>
                                    </tr>
                                </thead>
                                <tbody id="order-status-table">
                                    <tr>
                                        <td colspan="3" class="text-center py-3">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <span class="ms-2">Loading data...</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                </div>
                
                <!-- Additional Status Insights -->
                <div class="row mt-3 pt-3 border-top">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                Last updated: <span id="status-last-updated">-</span>
                            </small>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="refresh-status" title="Refresh Data">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm" id="export-status" title="Export Status Data">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Sales Analytics</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card border mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Customer Retention Rate</h6>
                                <div class="d-flex align-items-center">
                                    <div class="display-4 me-3" id="retention-rate">-%</div>
                                    <div class="flex-grow-1">
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 0%;" id="retention-progress"></div>
                                        </div>
                                    </div>
                                </div>
                                <small class="text-muted">Percentage of repeat customers</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card border mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Conversion Rate</h6>
                                <div class="d-flex align-items-center">
                                    <div class="display-4 me-3" id="conversion-rate">-%</div>
                                    <div class="flex-grow-1">
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar bg-primary" role="progressbar" style="width: 0%;" id="conversion-progress"></div>
                                        </div>
                                    </div>
                                </div>
                                <small class="text-muted">Orders to site visits ratio</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card border mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Inventory Turnover</h6>
                                <div class="d-flex align-items-center">
                                    <div class="display-4 me-3" id="inventory-turnover">-</div>
                                    <div class="flex-grow-1">
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar bg-info" role="progressbar" style="width: 0%;" id="inventory-progress"></div>
                                        </div>
                                    </div>
                                </div>
                                <small class="text-muted">Sales to inventory ratio</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="mb-3">Recommendations</h6>
                        <div class="list-group" id="recommendations-list">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Analyzing data for recommendations...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6 class="mb-3">Download Reports</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" id="download-sales-report-btn">
                                <i class="fas fa-file-excel me-2"></i> Sales Report
                            </button>
                            <button class="btn btn-outline-primary" id="download-product-report-btn">
                                <i class="fas fa-file-excel me-2"></i> Product Performance Report
                            </button>
                            <button class="btn btn-outline-primary" id="download-customer-report-btn">
                                <i class="fas fa-file-excel me-2"></i> Customer Analysis Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Details Modal -->
<div class="modal fade" id="productDetailsModal" tabindex="-1" aria-labelledby="productDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="productDetailsModalLabel">
                    <i class="fas fa-box me-2"></i>Product Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="productDetailsContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading product details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editProductBtn" style="display: none;">
                    <i class="fas fa-edit me-2"></i>Edit Product
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Professional Statistics Cards Design */
    :root {
        --primary-color: #930000;
        --secondary-color: #334155;
        --dark-color: #1e293b;
        --light-color: #f8fafc;
        --white: #ffffff;
        --border-color: #e2e8f0;
        --success-color: #059669;
        --danger-color: #dc2626;
        --warning-color: #d97706;
        --info-color: #0284c7;
        --border-radius: 12px;
        --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.05);
        --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.1);
        --shadow-heavy: 0 8px 25px rgba(0, 0, 0, 0.15);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Modern Statistics Cards */
    .stat-card {
        background: linear-gradient(135deg, #ffffff 0%, #fefefe 100%);
        border: 1px solid #e2e8f0;
        border-radius: var(--border-radius);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .text-muted {
        color: #7e8188 !important;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color) 0%, #b91c1c 100%);
        opacity: 0;
        transition: var(--transition);
    }

    .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--shadow-heavy) !important;
        border-color: rgba(147, 0, 0, 0.2);
    }

    .stat-card:hover::before {
        opacity: 1;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1f2937;
        line-height: 1.1;
        margin: 0;
    }

    .stat-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: #d39090;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 0;
    }

    .stat-description {
        font-size: 0.8rem;
        line-height: 1.4;
        color: #9ca3af;
    }

    /* Icon Wrappers with Theme Colors */
    .stat-icon-wrapper {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }

    .stat-icon-wrapper::before {
        content: '';
        position: absolute;
        inset: 0;
        background: currentColor;
        opacity: 0.12;
        border-radius: inherit;
    }

    .stat-icon-wrapper.sales {
        color: #059669;
        background: rgba(5, 150, 105, 0.08);
    }

    .stat-icon-wrapper.orders {
        color: #930000;
        background: rgba(147, 0, 0, 0.08);
    }

    .stat-icon-wrapper.expenses {
        color: #d97706;
        background: rgba(217, 119, 6, 0.08);
    }

    .stat-icon-wrapper.revenue {
        color: #0284c7;
        background: rgba(2, 132, 199, 0.08);
    }

    /* Trend Indicators */
    .trend-indicator {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: var(--transition);
    }

    .trend-up {
        background: rgba(34, 197, 94, 0.15);
        color: #16a34a;
        border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .trend-down {
        background: rgba(239, 68, 68, 0.15);
        color: #dc2626;
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    /* Progress Bars in Card Footers */
    .stat-footer {
        padding: 0;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border: none;
        border-top: 1px solid #e2e8f0;
    }

    .stat-footer .progress {
        border-radius: 0;
        height: 4px;
        background: rgba(0, 0, 0, 0.05);
    }

    .sales-footer .progress-bar {
        background: linear-gradient(90deg, #059669, #10b981);
        box-shadow: 0 2px 4px rgba(5, 150, 105, 0.3);
    }

    .orders-footer .progress-bar {
        background: linear-gradient(90deg, #930000, #b91c1c);
        box-shadow: 0 2px 4px rgba(147, 0, 0, 0.3);
    }

    .expenses-footer .progress-bar {
        background: linear-gradient(90deg, #d97706, #f59e0b);
        box-shadow: 0 2px 4px rgba(217, 119, 6, 0.3);
    }

    .revenue-footer .progress-bar {
        background: linear-gradient(90deg, #0284c7, #0ea5e9);
        box-shadow: 0 2px 4px rgba(2, 132, 199, 0.3);
    }

    /* Detailed Statistics Cards */
    .detail-stat-card {
        background: linear-gradient(135deg, #ffffff 0%, #fefefe 100%);
        border: 1px solid #e2e8f0;
        border-radius: var(--border-radius);
        transition: var(--transition);
        border-left: 4px solid #e5e7eb;
    }

    .detail-stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-medium);
        border-left-color: #930000;
        border-color: rgba(147, 0, 0, 0.2);
    }

    .detail-stat-icon {
        width: 45px;
        height: 45px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        position: relative;
        border: 1px solid currentColor;
    }

    .detail-stat-icon::before {
        content: '';
        position: absolute;
        inset: 0;
        background: currentColor;
        opacity: 0.08;
        border-radius: inherit;
    }

    .detail-stat-icon.courier {
        color: #930000;
        border-color: rgba(147, 0, 0, 0.3);
    }

    .detail-stat-icon.dashboard {
        color: #0284c7;
        border-color: rgba(2, 132, 199, 0.3);
    }

    .detail-stat-icon.product {
        color: #059669;
        border-color: rgba(5, 150, 105, 0.3);
    }

    .detail-stat-icon.margin {
        color: #d97706;
        border-color: rgba(217, 119, 6, 0.3);
    }

    .detail-stat-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: #d39090;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .detail-stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: #1f2937;
        line-height: 1.1;
    }

    /* Specific color variants for detail-stat-value matching progress bar colors */
    .detail-stat-value-courier {
        color: #930000 !important; /* Primary color matching bg-primary progress bar */
    }

    .detail-stat-value-dashboard {
        color: #0284c7 !important; /* Info color matching bg-info progress bar */
    }

    .detail-stat-value-product {
        color: #059669 !important; /* Success color matching bg-success progress bar */
    }

    .detail-stat-value-margin {
        color: #d97706 !important; /* Warning color matching bg-warning progress bar */
    }

    .detail-stat-description {
        line-height: 1.4;
        color: #9ca3af;
    }

    /* Modern Badges */
    .bg-primary-subtle {
        background-color: rgba(147, 0, 0, 0.12) !important;
        border: 1px solid rgba(147, 0, 0, 0.2) !important;
    }

    .text-primary {
        color: #930000 !important;
        font-weight: 600;
    }

    .bg-success-subtle {
        background-color: rgba(5, 150, 105, 0.12) !important;
        border: 1px solid rgba(5, 150, 105, 0.2) !important;
    }

    .text-success {
        color: #059669 !important;
        font-weight: 600;
    }

    .bg-info-subtle {
        background-color: rgba(2, 132, 199, 0.12) !important;
        border: 1px solid rgba(2, 132, 199, 0.2) !important;
    }

    .text-info {
        color: #0284c7 !important;
        font-weight: 600;
    }

    .bg-warning-subtle {
        background-color: rgba(217, 119, 6, 0.12) !important;
        border: 1px solid rgba(217, 119, 6, 0.2) !important;
    }

    .text-warning {
        color: #d97706 !important;
        font-weight: 600;
    }

    /* Custom styles for the financial chart */
    .bg-gradient-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--dark-color) 100%) !important;
    }
    
    .bg-gradient-info {
        background: linear-gradient(135deg, var(--info-color) 0%, #0369a1 100%) !important;
    }
    
    .legend-item {
        transition: var(--transition);
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 8px;
    }
    
    .legend-item:hover {
        transform: translateY(-2px);
        background-color: rgba(147, 0, 0, 0.05);
    }
    
    .badge {
        font-size: 0.75rem;
        padding: 0.5em 0.75em;
        border-radius: 0.5rem;
        font-weight: 500;
    }
    
    .shadow-sm {
        box-shadow: var(--shadow-light) !important;
    }
    
    .card-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
    }
    
    .dropdown-menu {
        border: none;
        box-shadow: var(--shadow-medium);
        border-radius: var(--border-radius);
    }
    
    .dropdown-item {
        padding: 0.75rem 1.25rem;
        transition: var(--transition);
        border-radius: 8px;
        margin: 2px 8px;
    }
    
    .dropdown-item:hover {
        background-color: rgba(147, 0, 0, 0.1);
        color: var(--primary-color);
    }
    
    .dropdown-header {
        color: var(--secondary-color);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 0.75rem 1.25rem 0.5rem;
    }
    
    /* Custom date range picker styles */
    #custom-date-range {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.95) 100%);
        border: 1px solid rgba(147, 0, 0, 0.2);
        border-radius: var(--border-radius);
        padding: 0.75rem 1rem;
        margin-left: 0.75rem;
        box-shadow: var(--shadow-light);
        animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-10px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateX(0) scale(1);
        }
    }
    
    #custom-date-range .input-group-text {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #ced4da;
        color: var(--secondary-color);
        font-size: 0.75rem;
        border-radius: 8px 0 0 8px;
    }
    
    #custom-date-range .form-control {
        border-left: none;
        font-size: 0.85rem;
        transition: var(--transition);
        border-radius: 0 8px 8px 0;
    }
    
    #custom-date-range .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(147, 0, 0, 0.15);
    }
    
    #custom-date-range .btn {
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
        transition: var(--transition);
        border-radius: 8px;
        min-width: 40px;
        font-weight: 500;
    }
    
    #custom-date-range .btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-light);
    }
    
    #period-filter {
        transition: var(--transition);
        border: 1px solid #ced4da;
        border-radius: 8px;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        font-weight: 500;
    }
    
    #period-filter:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(147, 0, 0, 0.15);
    }
    
    /* Responsive adjustments for date picker */
    @media (max-width: 768px) {
        #custom-date-range {
            width: 100% !important;
            margin-left: 0;
            margin-top: 1rem;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 249, 250, 0.98) 100%);
            border: 1px solid rgba(147, 0, 0, 0.2);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
        }
        
        #custom-date-range .input-group {
            margin-bottom: 0.75rem;
            width: 100% !important;
            max-width: none !important;
        }
        
        #custom-date-range .d-flex.gap-2 {
            width: 100%;
            margin-top: 0.75rem;
        }
        
        .card-header .d-flex {
            align-items: flex-start !important;
        }

        .stat-card {
            margin-bottom: 1rem;
        }

        .stat-value {
            font-size: 2rem;
        }
        
        /* Make the period filter full width on mobile */
        #period-filter {
            width: 100% !important;
            min-width: unset !important;
        }
        
        /* Improve spacing for mobile */
        .card-header {
            padding: 1rem;
        }
        
        .card-header h5 {
            font-size: 1.1rem;
        }
        
        .card-header small {
            font-size: 0.8rem;
        }

       
    }
    
    /* Responsive for tablets */
    @media (max-width: 992px) and (min-width: 769px) {
        .stat-value {
            font-size: 2.2rem;
        }
        
        .detail-stat-value {
            font-size: 1.6rem;
        }
    }
    
    #chart-loading, #status-chart-loading {
        background: rgba(255, 255, 255, 0.95);
        border-radius: var(--border-radius);
        padding: 3rem;
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(147, 0, 0, 0.1);
    }
    
    /* Order Status specific styles */
    .status-summary-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.98) 100%);
        border: 1px solid #e2e8f0;
        border-radius: var(--border-radius);
        padding: 1rem;
        transition: var(--transition);
        cursor: pointer;
        min-height: 70px;
        display: flex;
        align-items: center;
    }
    
    .status-summary-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-medium);
        border-color: rgba(147, 0, 0, 0.2);
    }
    
    .status-summary-card.pending {
        border-left: 4px solid #f59e0b;
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.08) 0%, rgba(255, 255, 255, 0.98) 100%);
    }
    
    .status-summary-card.confirmed {
        border-left: 4px solid #930000;
        background: linear-gradient(135deg, rgba(147, 0, 0, 0.08) 0%, rgba(255, 255, 255, 0.98) 100%);
    }
    
    .status-summary-card.processing {
        border-left: 4px solid #0284c7;
        background: linear-gradient(135deg, rgba(2, 132, 199, 0.08) 0%, rgba(255, 255, 255, 0.98) 100%);
    }
    
    .status-summary-card.shipped {
        border-left: 4px solid #10b981;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(255, 255, 255, 0.98) 100%);
    }
    
    .status-summary-card.delivered {
        border-left: 4px solid #059669;
        background: linear-gradient(135deg, rgba(5, 150, 105, 0.08) 0%, rgba(255, 255, 255, 0.98) 100%);
    }
    
    .status-summary-card.cancelled {
        border-left: 4px solid #dc2626;
        background: linear-gradient(135deg, rgba(220, 38, 38, 0.08) 0%, rgba(255, 255, 255, 0.98) 100%);
    }
    
    .status-summary-card.returned {
        border-left: 4px solid #6b7280;
        background: linear-gradient(135deg, rgba(107, 114, 128, 0.08) 0%, rgba(255, 255, 255, 0.98) 100%);
    }
    
    .status-summary-card.partial_return {
        border-left: 4px solid #f97316;
        background: linear-gradient(135deg, rgba(249, 115, 22, 0.08) 0%, rgba(255, 255, 255, 0.98) 100%);
    }
    
    .status-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
        font-size: 1rem;
        position: relative;
        overflow: hidden;
        border: 2px solid currentColor;
    }

    .status-icon::before {
        content: '';
        position: absolute;
        inset: 0;
        background: currentColor;
        opacity: 0.12;
        border-radius: inherit;
    }
    
    .status-icon.pending {
        color: #f59e0b;
    }
    
    .status-icon.confirmed {
        color: #930000;
    }
    
    .status-icon.processing {
        color: #0284c7;
    }
    
    .status-icon.shipped {
        color: #10b981;
    }
    
    .status-icon.delivered {
        color: #059669;
    }
    
    .status-icon.cancelled {
        color: #dc2626;
    }
    
    .status-icon.returned {
        color: #6b7280;
    }
    
    .status-icon.partial_return {
        color: #f97316;
    }
    
    /* Animation for chart container */
    .card {
        transition: var(--transition);
        border-radius: var(--border-radius);
        border: 1px solid rgba(226, 232, 240, 0.8);
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium) !important;
    }
    
    /* Product table enhancements */
    .table-dark th {
        background: linear-gradient(135deg, #1f2937 0%, #374151 100%) !important;
        border-color: rgba(255, 255, 255, 0.15) !important;
        font-weight: 600;
        font-size: 0.85rem;
        color: #f9fafb !important;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(147, 0, 0, 0.08);
        color: #1f2937;
    }
    
    .table tbody td {
        color: #374151;
        border-color: #e5e7eb;
    }
    
    .btn-xs {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        border-radius: 6px;
        font-weight: 500;
    }
    
    .input-group-sm .input-group-text {
        font-size: 0.85rem;
        padding: 0.375rem 0.75rem;
        border-radius: 8px 0 0 8px;
    }
    
    /* Status date filter controls */
    .status-filter-controls {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.95) 100%);
        border: 1px solid rgba(2, 132, 199, 0.2);
        border-radius: var(--border-radius);
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .status-filter-controls .input-group-sm {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: var(--shadow-light);
    }
    
    .status-filter-controls .input-group-text {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #ced4da;
        color: var(--secondary-color);
        font-size: 0.8rem;
    }
    
    .status-filter-controls .form-control {
        border-left: none;
        font-size: 0.85rem;
        transition: var(--transition);
    }
    
    .status-filter-controls .form-control:focus {
        border-color: var(--info-color);
        box-shadow: 0 0 0 0.2rem rgba(2, 132, 199, 0.15);
    }
    
    .status-filter-controls .btn {
        font-size: 0.85rem;
        padding: 0.5rem 1rem;
        transition: var(--transition);
        border-radius: 8px;
        font-weight: 500;
    }
    
    .status-filter-controls .btn:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-light);
    }
    
    .pagination-sm .page-link {
        padding: 0.375rem 0.75rem;
        font-size: 0.85rem;
        border-radius: 6px;
        margin: 0 2px;
        border: 1px solid #dee2e6;
        transition: var(--transition);
    }

    .pagination-sm .page-link:hover {
        background-color: rgba(147, 0, 0, 0.1);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    /* Sort icons */
    th[data-sort] {
        user-select: none;
        transition: var(--transition);
        cursor: pointer;
    }
    
    th[data-sort]:hover {
        background-color: rgba(255, 255, 255, 0.1) !important;
    }
    
    /* Product image and modal styles */
    .product-thumbnail {
        transition: var(--transition);
        border-radius: 6px;
    }
    
    .product-thumbnail:hover {
        transform: scale(1.05);
    }
    
    .product-name-link {
        color: var(--dark-color);
        transition: var(--transition);
        font-weight: 500;
    }
    
    .product-name-link:hover {
        color: var(--primary-color) !important;
        text-decoration: underline !important;
    }
    
    .modal-lg {
        max-width: 900px;
    }
    
    .modal-body .table th {
        background-color: var(--light-color);
        border-top: none;
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--dark-color);
    }
    
    .modal-body .badge {
        font-size: 0.75rem;
        font-weight: 500;
    }

    /* Loading states */
    .spinner-border {
        width: 2rem;
        height: 2rem;
        border-width: 3px;
    }

    .spinner-border-sm {
        width: 1.5rem;
        height: 1.5rem;
        border-width: 2px;
    }

    /* Accessibility improvements */
    .btn:focus-visible,
    .form-control:focus-visible,
    .form-select:focus-visible {
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
    }

    /* Dark mode support (if needed in future) */
    @media (prefers-color-scheme: dark) {
        .stat-card {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .stat-value,
        .detail-stat-value {
            color: var(--white);
        }

        .stat-title,
        .detail-stat-title {
        color: #d39090;
;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Timezone utility functions for Dhaka, Bangladesh (UTC +6)
    const DHAKA_TIMEZONE_OFFSET = 6 * 60; // 6 hours in minutes
    
    function getDhakaTime() {
        const now = new Date();
        const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
        const dhakaTime = new Date(utc + (DHAKA_TIMEZONE_OFFSET * 60000));
        return dhakaTime;
    }
    
    function formatDhakaDate(date) {
        if (!date) date = getDhakaTime();
        return date.toISOString().split('T')[0]; // YYYY-MM-DD format
    }
    
    function formatDhakaDateTime(date) {
        if (!date) date = getDhakaTime();
        return date.toLocaleString('en-US', {
            timeZone: 'Asia/Dhaka',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        });
    }
    
    function getFirstDayOfMonth(date) {
        if (!date) date = getDhakaTime();
        return new Date(date.getFullYear(), date.getMonth(), 1);
    }
    
    // Initialize chart objects
    let salesChart, categoryChart, orderStatusChart;
    
    // Current period selection
    let currentPeriod = 'month';
    let currentYear = getDhakaTime().getFullYear().toString();
    let customDateRange = { from: null, to: null };
    
    // Products filtering and pagination
    let productsCurrentPage = 1;
    let productsPerPage = 10;
    let productsAllData = [];
    let productsFilteredData = [];
    let productsSortBy = 'orders';
    let productsSortOrder = 'desc';
    
    // Set current year as default in dropdown
    document.getElementById('year-filter').value = currentYear;
    
    // Set default date range (current month) using Dhaka timezone
    const today = getDhakaTime();
    const firstDayOfMonth = getFirstDayOfMonth(today);
    document.getElementById('products-date-from').value = formatDhakaDate(firstDayOfMonth);
    document.getElementById('products-date-to').value = formatDhakaDate(today);
    
    // Set default date range for status section (current month) using Dhaka timezone
    document.getElementById('status-date-from').value = formatDhakaDate(firstDayOfMonth);
    document.getElementById('status-date-to').value = formatDhakaDate(today);
    
    // Load initial data
    loadStatistics(currentPeriod);
    
    // Set up event listener for period dropdown
    document.getElementById('period-filter').addEventListener('change', function() {
        const selectedPeriod = this.value;
        
        if (selectedPeriod === 'custom') {
            // Show custom date range picker
            document.getElementById('custom-date-range').style.display = 'flex';
            // Set default date range (current month) using Dhaka timezone
            const today = getDhakaTime();
            const firstDayOfMonth = getFirstDayOfMonth(today);
            document.getElementById('custom-date-from').value = formatDhakaDate(firstDayOfMonth);
            document.getElementById('custom-date-to').value = formatDhakaDate(today);
        } else {
            // Hide custom date range picker
            document.getElementById('custom-date-range').style.display = 'none';
            // Load data for selected period
            currentPeriod = selectedPeriod;
            loadStatistics(currentPeriod);
        }
    });
    
    // Set up event listeners for custom date range
    document.getElementById('apply-custom-range').addEventListener('click', function() {
        const dateFrom = document.getElementById('custom-date-from').value;
        const dateTo = document.getElementById('custom-date-to').value;
        
        if (!dateFrom || !dateTo) {
            showAlert('Please select both start and end dates.', 'warning');
            return;
        }
        
        if (new Date(dateFrom) > new Date(dateTo)) {
            showAlert('Start date cannot be after end date.', 'warning');
            return;
        }
        
        // Store custom date range
        customDateRange.from = dateFrom;
        customDateRange.to = dateTo;
        
        // Load data for custom range
        currentPeriod = 'custom';
        loadStatisticsWithCustomRange(dateFrom, dateTo);
    });
    
    document.getElementById('cancel-custom-range').addEventListener('click', function() {
        // Hide custom date range picker and reset dropdown
        document.getElementById('custom-date-range').style.display = 'none';
        document.getElementById('period-filter').value = currentPeriod === 'custom' ? 'week' : currentPeriod;
        if (currentPeriod === 'custom') {
            currentPeriod = 'week';
            loadStatistics(currentPeriod);
        }
    });
    
    // Set up event listener for year filter
    document.getElementById('year-filter').addEventListener('change', function() {
        currentYear = this.value;
        loadStatistics(currentPeriod);
    });
    
    // Set up event listeners for status chart options
    document.querySelectorAll('.status-chart-type').forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update active class
            document.querySelectorAll('.status-chart-type').forEach(o => o.classList.remove('active'));
            this.classList.add('active');
            
            // Update chart type
            const chartType = this.dataset.type;
            updateOrderStatusChartType(chartType);
        });
    });
    
    // Status chart refresh and export
    document.getElementById('refresh-status').addEventListener('click', function() {
        loadStatistics(currentPeriod);
    });
    
    document.getElementById('export-status').addEventListener('click', function() {
        exportOrderStatusData();
    });
    
    // Set up event listeners for status date filters
    document.getElementById('status-apply-filter').addEventListener('click', function() {
        loadOrderStatusWithDateFilter();
    });
    
    document.getElementById('status-clear-filter').addEventListener('click', function() {
        // Reset date filters to current month using Dhaka timezone
        const today = getDhakaTime();
        const firstDayOfMonth = getFirstDayOfMonth(today);
        document.getElementById('status-date-from').value = formatDhakaDate(firstDayOfMonth);
        document.getElementById('status-date-to').value = formatDhakaDate(today);
        loadOrderStatusWithDateFilter();
    });
    
    // Set up event listeners for chart options
    document.querySelectorAll('.chart-type-option').forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update active class
            document.querySelectorAll('.chart-type-option').forEach(o => o.classList.remove('active'));
            this.classList.add('active');
            
            // Update chart type
            const chartType = this.dataset.type;
            updateSalesChartType(chartType);
        });
    });
    
    // Chart view options
    document.getElementById('toggle-grid').addEventListener('click', function(e) {
        e.preventDefault();
        if (salesChart) {
            const gridDisplay = salesChart.options.scales.x.grid.display;
            salesChart.options.scales.x.grid.display = !gridDisplay;
            salesChart.options.scales.y.grid.display = !gridDisplay;
            salesChart.update();
        }
    });
    
    document.getElementById('toggle-animation').addEventListener('click', function(e) {
        e.preventDefault();
        if (salesChart) {
            const animationEnabled = salesChart.options.animation.duration > 0;
            salesChart.options.animation.duration = animationEnabled ? 0 : 1000;
            salesChart.update();
        }
    });
    
    // Set up event listeners for report download buttons
    document.getElementById('download-sales-report-btn').addEventListener('click', function() {
        downloadReport('sales', currentPeriod);
    });
    
    document.getElementById('download-product-report-btn').addEventListener('click', function() {
        downloadReport('products', currentPeriod);
    });
    
    document.getElementById('download-customer-report-btn').addEventListener('click', function() {
        downloadReport('customers', currentPeriod);
    });
    
    // Set up event listeners for product filtering
    document.getElementById('products-sort').addEventListener('change', function() {
        productsSortBy = this.value;
        sortAndFilterProducts();
    });
    
    document.getElementById('products-search').addEventListener('input', function() {
        productsCurrentPage = 1; // Reset to first page
        sortAndFilterProducts();
    });
    
    document.getElementById('products-date-from').addEventListener('change', function() {
        productsCurrentPage = 1;
        loadProductsWithFilters();
    });
    
    document.getElementById('products-date-to').addEventListener('change', function() {
        productsCurrentPage = 1;
        loadProductsWithFilters();
    });
    
    document.getElementById('products-refresh').addEventListener('click', function() {
        loadProductsWithFilters();
    });
    
    document.getElementById('products-clear-filters').addEventListener('click', function() {
        document.getElementById('products-search').value = '';
        document.getElementById('products-sort').value = 'orders';
        const today = getDhakaTime();
        const firstDayOfMonth = getFirstDayOfMonth(today);
        document.getElementById('products-date-from').value = formatDhakaDate(firstDayOfMonth);
        document.getElementById('products-date-to').value = formatDhakaDate(today);
        productsSortBy = 'orders';
        productsCurrentPage = 1;
        loadProductsWithFilters();
    });
    
    document.getElementById('products-export').addEventListener('click', function() {
        exportProductsData();
    });
    
    // Table header sorting - Fix the selector to target the table parent
    document.querySelector('.table-responsive').addEventListener('click', function(e) {
        if (e.target.closest('th[data-sort]')) {
            const sortField = e.target.closest('th').dataset.sort;
            if (productsSortBy === sortField) {
                productsSortOrder = productsSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                productsSortBy = sortField;
                productsSortOrder = 'desc';
            }
            document.getElementById('products-sort').value = sortField;
            sortAndFilterProducts();
        }
    });
    
    // Function to load statistics for the selected period
    function loadStatistics(period) {
        console.log(`Loading statistics for period: ${period}`);
        fetch(`/mb-admin/api/statistics/?period=${period}`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
            .then(response => {
                console.log(`Statistics API response status: ${response.status}`);
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error(`Statistics API error: ${response.status} ${response.statusText}`, text);
                        throw new Error(`HTTP ${response.status}: ${response.statusText} - ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Statistics data received:', data);
                // Update summary statistics
                updateSummaryStats(data);
                
                // Update charts with real data
                updateSalesChart(data, period);
                updateCategoryChart(data.sales_by_category || []);
                updateOrderStatusChart(data.orders_by_status || []);
                
                // Update tables
                updateTopProductsTable(data.popular_products || []);
                updateOrderStatusTable(data.orders_by_status || []);
                
                // Load detailed products data with current filters
                loadProductsWithFilters();
                
                // Update analytics metrics
                updateAnalyticsMetrics(data.analytics || {});
                
                // Update recommendations
                updateRecommendations(data.recommendations || []);
            })
            .catch(error => {
                console.error('Error loading statistics:', error);
                showAlert(`Failed to load statistics data: ${error.message}`, 'danger');
                // Show additional debug information
                if (error.message.includes('403')) {
                    showAlert('Access denied. Please make sure you are logged in as an admin user.', 'warning');
                } else if (error.message.includes('500')) {
                    showAlert('Server error. Check the browser console for more details.', 'danger');
                }
            });
    }
    
    // Function to load statistics with custom date range
    function loadStatisticsWithCustomRange(dateFrom, dateTo) {
        console.log(`Loading statistics for custom range: ${dateFrom} to ${dateTo}`);
        fetch(`/mb-admin/api/statistics/?period=custom&date_from=${dateFrom}&date_to=${dateTo}`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
            .then(response => {
                console.log(`Custom range API response status: ${response.status}`);
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error(`Custom range API error: ${response.status} ${response.statusText}`, text);
                        throw new Error(`HTTP ${response.status}: ${response.statusText} - ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Custom range statistics data received:', data);
                // Update summary statistics
                updateSummaryStats(data);
                
                // Update charts with real data
                updateSalesChart(data, 'custom');
                updateCategoryChart(data.sales_by_category || []);
                updateOrderStatusChart(data.orders_by_status || []);
                
                // Update tables
                updateTopProductsTable(data.popular_products || []);
                updateOrderStatusTable(data.orders_by_status || []);
                
                // Load detailed products data with current filters
                loadProductsWithFilters();
                
                // Update analytics metrics
                updateAnalyticsMetrics(data.analytics || {});
                
                // Update recommendations
                updateRecommendations(data.recommendations || []);
                
                // Show success message
                showAlert(`Statistics loaded for custom range: ${dateFrom} to ${dateTo}`, 'success');
            })
            .catch(error => {
                console.error('Error loading custom statistics:', error);
                showAlert(`Failed to load custom date range statistics: ${error.message}`, 'danger');
                // Show additional debug information
                if (error.message.includes('403')) {
                    showAlert('Access denied. Please make sure you are logged in as an admin user.', 'warning');
                } else if (error.message.includes('500')) {
                    showAlert('Server error. Check the browser console for more details.', 'danger');
                }
            });
    }
    
    // Update summary statistics
    function updateSummaryStats(data) {
        document.getElementById('total-sales-stat').textContent = `$${data.total_sales.toFixed(2)}`;
        document.getElementById('total-orders-stat').textContent = data.orders_count;
        document.getElementById('total-expenses-stat').textContent = `$${data.total_expenses.toFixed(2)}`;
        document.getElementById('total-revenue-stat').textContent = `$${data.total_revenue.toFixed(2)}`;
        
        // Update detailed expense breakdown
        document.getElementById('total-courier-charge-stat').textContent = `$${data.courier_expenses.toFixed(2)}`;
        document.getElementById('dashboard-expenses-stat').textContent = `$${data.dashboard_expenses.toFixed(2)}`;
        document.getElementById('product-cost-stat').textContent = `$${data.total_product_cost.toFixed(2)}`;
        document.getElementById('profit-margin-stat').textContent = `${data.profit_margin}%`;
        
        // Update revenue color based on positive/negative value
        const revenueElement = document.getElementById('total-revenue-stat');
        const revenueCard = revenueElement.closest('.card');
        const revenueIcon = revenueCard.querySelector('i');
        
        if (data.total_revenue < 0) {
            revenueElement.style.color = '#dc3545'; // Red for negative
            revenueIcon.className = 'fas fa-chart-line-down fa-2x text-danger';
        } else {
            revenueElement.style.color = '#28a745'; // Green for positive
            revenueIcon.className = 'fas fa-chart-line fa-2x text-success';
        }
        
        // Update profit margin color based on percentage
        const profitMarginElement = document.getElementById('profit-margin-stat');
        if (data.profit_margin < 0) {
            profitMarginElement.style.color = '#dc3545'; // Red for negative
        } else if (data.profit_margin < 10) {
            profitMarginElement.style.color = '#ffc107'; // Yellow for low margin
        } else {
            profitMarginElement.style.color = '#28a745'; // Green for healthy margin
        }
    }
    
    // Update financial comparison chart - ONLY REAL DATA
    function updateSalesChart(statisticsData, period) {
        const ctx = document.getElementById('salesChart').getContext('2d');
        
        // Show loading
        document.getElementById('chart-loading').classList.remove('d-none');
        
        // Use ONLY real data from API
        const currentSales = statisticsData.total_sales || 0;
        const currentExpenses = statisticsData.total_expenses || 0;
        const currentRevenue = statisticsData.total_revenue || 0;
        
        // For now, show only current period data (no historical mock data)
        const currentDate = getDhakaTime();
        let chartLabel = '';
        
        // Determine the appropriate label based on selected year and current date
        if (currentYear === 'all') {
            chartLabel = 'All Time';
        } else {
            const selectedYearInt = parseInt(currentYear);
            if (selectedYearInt === currentDate.getFullYear()) {
                chartLabel = `Current (${currentDate.toLocaleDateString('en-US', { 
                    month: 'short', 
                    year: 'numeric',
                    timeZone: 'Asia/Dhaka'
                })})`;
            } else {
                chartLabel = `Year ${currentYear}`;
            }
        }
        
        // Single data point with actual API data
        const periods = [chartLabel];
        const salesValues = [Math.round(currentSales)];
        const expenseValues = [Math.round(currentExpenses)];
        const revenueValues = [Math.round(currentRevenue)];
        
        const chartData = {
            labels: periods,
            datasets: [
                {
                    label: 'Sales Revenue',
                    data: salesValues,
                    borderColor: 'rgba(40, 167, 69, 1)',
                    backgroundColor: 'rgba(40, 167, 69, 0.3)',
                    borderWidth: 3,
                    tension: 0.4,
                    pointBackgroundColor: 'rgba(40, 167, 69, 1)',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 3,
                    pointRadius: 8,
                    pointHoverRadius: 12,
                    pointHoverBackgroundColor: 'rgba(40, 167, 69, 1)',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 4,
                    fill: false
                },
                {
                    label: 'Total Expenses',
                    data: expenseValues,
                    borderColor: 'rgba(220, 53, 69, 1)',
                    backgroundColor: 'rgba(220, 53, 69, 0.3)',
                    borderWidth: 3,
                    tension: 0.4,
                    pointBackgroundColor: 'rgba(220, 53, 69, 1)',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 3,
                    pointRadius: 8,
                    pointHoverRadius: 12,
                    pointHoverBackgroundColor: 'rgba(220, 53, 69, 1)',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 4,
                    fill: false,
                    borderDash: [5, 5]
                },
                {
                    label: 'Net Revenue',
                    data: revenueValues,
                    borderColor: currentRevenue >= 0 ? 'rgba(0, 123, 255, 1)' : 'rgba(255, 99, 132, 1)',
                    backgroundColor: currentRevenue >= 0 ? 'rgba(0, 123, 255, 0.3)' : 'rgba(255, 99, 132, 0.3)',
                    borderWidth: 4,
                    tension: 0.4,
                    pointBackgroundColor: currentRevenue >= 0 ? 'rgba(0, 123, 255, 1)' : 'rgba(255, 99, 132, 1)',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 3,
                    pointRadius: 10,
                    pointHoverRadius: 14,
                    pointHoverBackgroundColor: currentRevenue >= 0 ? 'rgba(0, 123, 255, 1)' : 'rgba(255, 99, 132, 1)',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 4,
                    fill: false
                }
            ]
        };
        
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: false // We're using custom legend
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#333',
                    bodyColor: '#666',
                    borderColor: 'rgba(0, 0, 0, 0.1)',
                    borderWidth: 1,
                    cornerRadius: 12,
                    displayColors: true,
                    usePointStyle: true,
                    padding: 12,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        title: function(context) {
                            return `Current Data: ${context[0].label}`;
                        },
                        label: function(context) {
                            const value = context.parsed.y;
                            const label = context.dataset.label;
                            return `${label}: $${value.toLocaleString()}`;
                        },
                        afterLabel: function(context) {
                            if (context.datasetIndex === 2) { // Revenue
                                const salesValue = chartData.datasets[0].data[context.dataIndex];
                                if (salesValue > 0) {
                                    const margin = ((context.parsed.y / salesValue) * 100).toFixed(1);
                                    return `Profit Margin: ${margin}%`;
                                }
                            }
                            return null;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)',
                        lineWidth: 1
                    },
                    ticks: {
                        color: '#666',
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)',
                        lineWidth: 1
                    },
                    ticks: {
                        color: '#666',
                        font: {
                            size: 11
                        },
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            },
            elements: {
                line: {
                    tension: 0.4
                },
                point: {
                    hoverRadius: 12
                }
            }
        };
        
        // Destroy existing chart if it exists
        if (salesChart) {
            salesChart.destroy();
        }
        
        // Create new chart with a slight delay for smooth transition
        setTimeout(() => {
            salesChart = new Chart(ctx, {
                type: 'bar', // Use bar chart for single data points
                data: chartData,
                options: chartOptions
            });
            
            // Hide loading
            document.getElementById('chart-loading').classList.add('d-none');
        }, 300);
    }
    
    // Update chart type (line or bar) 
    function updateSalesChartType(chartType) {
        if (salesChart) {
            salesChart.config.type = chartType;
            
            // Adjust styling for different chart types
            if (chartType === 'bar') {
                // For bar chart, increase background opacity
                salesChart.data.datasets.forEach(dataset => {
                    dataset.backgroundColor = dataset.backgroundColor.replace('0.3', '0.7');
                });
            } else {
                // For line chart, reduce background opacity  
                salesChart.data.datasets.forEach(dataset => {
                    dataset.backgroundColor = dataset.backgroundColor.replace('0.7', '0.3');
                });
            }
            
            salesChart.update();
        }
    }
    
    // Update category chart
    function updateCategoryChart(categoryData) {
        const ctx = document.getElementById('categoryChart').getContext('2d');
        
        const chartData = {
            labels: categoryData.map(item => item.category_name),
            datasets: [{
                data: categoryData.map(item => item.sales),
                backgroundColor: [
                    'rgba(52, 152, 219, 0.7)',
                    'rgba(46, 204, 113, 0.7)',
                    'rgba(155, 89, 182, 0.7)',
                    'rgba(230, 126, 34, 0.7)',
                    'rgba(231, 76, 60, 0.7)',
                    'rgba(52, 73, 94, 0.7)',
                    'rgba(241, 196, 15, 0.7)'
                ],
                borderWidth: 1
            }]
        };
        
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        boxWidth: 15
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            return label + ': $' + value.toFixed(2);
                        }
                    }
                }
            }
        };
        
        // Destroy existing chart if it exists
        if (categoryChart) {
            categoryChart.destroy();
        }
        
        // Create new chart
        categoryChart = new Chart(ctx, {
            type: 'doughnut',
            data: chartData,
            options: chartOptions
        });
    }
    
    // Update order status chart
    function updateOrderStatusChart(statusData) {
        const ctx = document.getElementById('orderStatusChart').getContext('2d');
        
        // Show loading
        document.getElementById('status-chart-loading').classList.remove('d-none');
        
        // Define status colors and icons
        const statusConfig = {
            'pending': { color: 'rgba(255, 193, 7, 0.8)', icon: 'fas fa-clock' },
            'confirmed': { color: 'rgba(0, 123, 255, 0.8)', icon: 'fas fa-check' },
            'processing': { color: 'rgba(23, 162, 184, 0.8)', icon: 'fas fa-cog' },
            'shipped': { color: 'rgba(32, 201, 151, 0.8)', icon: 'fas fa-shipping-fast' },
            'delivered': { color: 'rgba(40, 167, 69, 0.8)', icon: 'fas fa-check-circle' },
            'cancelled': { color: 'rgba(220, 53, 69, 0.8)', icon: 'fas fa-times-circle' },
            'returned': { color: 'rgba(108, 117, 125, 0.8)', icon: 'fas fa-undo' },
            'partial_return': { color: 'rgba(253, 126, 20, 0.8)', icon: 'fas fa-exclamation-triangle' },
            'partially_returned': { color: 'rgba(253, 126, 20, 0.8)', icon: 'fas fa-exclamation-triangle' }
        };
        
        const chartData = {
            labels: statusData.map(item => item.status.charAt(0).toUpperCase() + item.status.slice(1).replace('_', ' ')),
            datasets: [{
                data: statusData.map(item => item.count),
                backgroundColor: statusData.map(item => {
                    const config = statusConfig[item.status] || statusConfig['pending'];
                    return config.color;
                }),
                borderColor: statusData.map(item => {
                    const config = statusConfig[item.status] || statusConfig['pending'];
                    return config.color.replace('0.8', '1');
                }),
                borderWidth: 2,
                hoverBorderWidth: 3,
                hoverBorderColor: '#ffffff'
            }]
        };
        
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12,
                        padding: 15,
                        font: {
                            size: 11
                        },
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#333',
                    bodyColor: '#666',
                    borderColor: 'rgba(0, 0, 0, 0.1)',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: true,
                    usePointStyle: true,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0';
                            return `${label}: ${value} orders (${percentage}%)`;
                        }
                    }
                },
                datalabels: false
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        };
        
        // Destroy existing chart if it exists
        if (orderStatusChart) {
            orderStatusChart.destroy();
        }
        
        // Create new chart with a slight delay for smooth transition
        setTimeout(() => {
            orderStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: chartData,
                options: chartOptions
            });
            
            // Hide loading
            document.getElementById('status-chart-loading').classList.add('d-none');
            
            // Update last updated timestamp using Dhaka timezone
            document.getElementById('status-last-updated').textContent = formatDhakaDateTime();
        }, 300);
    }
    
    // Load order status data with date filter
    function loadOrderStatusWithDateFilter() {
        const dateFrom = document.getElementById('status-date-from').value;
        const dateTo = document.getElementById('status-date-to').value;
        
        // Show loading
        document.getElementById('status-chart-loading').classList.remove('d-none');
        
        // Build URL with date parameters
        let url = `/mb-admin/api/order-status-breakdown/?period=${currentPeriod}`;
        if (dateFrom) url += `&date_from=${dateFrom}`;
        if (dateTo) url += `&date_to=${dateTo}`;
        
        fetch(url, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            // Update order status chart with filtered data
            updateOrderStatusChart(data.orders_by_status || []);
            
            // Update order status table with filtered data  
            updateOrderStatusTable(data.orders_by_status || []);
        })
        .catch(error => {
            console.error('Error loading filtered order status data:', error);
            document.getElementById('status-chart-loading').classList.add('d-none');
            showAlert('Failed to load filtered order status data.', 'danger');
        });
    }
    
    // Load products with filters
    function loadProductsWithFilters() {
        const dateFrom = document.getElementById('products-date-from').value;
        const dateTo = document.getElementById('products-date-to').value;
        
        // Show loading
        const tbody = document.getElementById('top-products-table');
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Loading filtered data...</span>
                </td>
            </tr>
        `;
        
        let url = `/mb-admin/api/products-performance/?period=${currentPeriod}`;
        if (dateFrom) url += `&date_from=${dateFrom}`;
        if (dateTo) url += `&date_to=${dateTo}`;
        
        fetch(url, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            productsAllData = data.products || [];
            sortAndFilterProducts();
        })
        .catch(error => {
            console.error('Error loading products:', error);
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Failed to load product data</td></tr>';
            document.getElementById('products-summary').textContent = 'Error loading data';
        });
    }
    
    // Sort and filter products based on current settings
    function sortAndFilterProducts() {
        const searchTerm = document.getElementById('products-search').value.toLowerCase().trim();
        
        // Filter by search term
        productsFilteredData = productsAllData.filter(product => {
            return product.product_name.toLowerCase().includes(searchTerm);
        });
        
        // Sort the data
        productsFilteredData.sort((a, b) => {
            let aVal, bVal;
            
            switch(productsSortBy) {
                case 'name':
                    aVal = a.product_name.toLowerCase();
                    bVal = b.product_name.toLowerCase();
                    return productsSortOrder === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                case 'orders':
                    aVal = a.orders || 0;
                    bVal = b.orders || 0;
                    break;
                case 'delivered':
                    aVal = a.delivered_quantity || 0;
                    bVal = b.delivered_quantity || 0;
                    break;
                case 'revenue':
                    aVal = a.revenue || 0;
                    bVal = b.revenue || 0;
                    break;
                default:
                    aVal = a.orders || 0;
                    bVal = b.orders || 0;
            }
            
            return productsSortOrder === 'asc' ? aVal - bVal : bVal - aVal;
        });
        
        updateProductsTable();
        updateProductsPagination();
        updateProductsSummary();
        updateSortIcons();
    }
    
    // Update products table with current page data
    function updateProductsTable() {
        const tbody = document.getElementById('top-products-table');
        
        if (productsFilteredData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">No products found</td></tr>';
            return;
        }
        
        const startIndex = (productsCurrentPage - 1) * productsPerPage;
        const endIndex = startIndex + productsPerPage;
        const pageData = productsFilteredData.slice(startIndex, endIndex);
        
        tbody.innerHTML = '';
        
        pageData.forEach((product, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <div class="me-2">
                            <img src="${product.image_url || '/media/default.webp'}" 
                                 alt="${product.product_name}" 
                                 class="product-thumbnail rounded"
                                 style="width: 40px; height: 40px; object-fit: cover; border: 1px solid #dee2e6;"
                                 onerror="this.src='/media/default.webp'">
                        </div>
                        <div>
                            <div class="fw-medium">
                                <a href="#" class="text-decoration-none product-name-link" 
                                   data-product-id="${product.id}" 
                                   data-product-name="${product.product_name}">
                                    ${product.product_name}
                                </a>
                            </div>
                            ${product.category ? `<small class="text-muted">${product.category}</small>` : ''}
                        </div>
                    </div>
                </td>
                <td class="text-center">
                    <span class="badge bg-info">${product.orders || 0}</span>
                </td>
                <td class="text-center">
                    <span class="badge bg-success">${product.delivered_quantity || 0}</span>
                </td>
                <td class="text-end">
                    <strong class="text-primary">$${(product.revenue || 0).toFixed(2)}</strong>
                    ${product.orders > 0 ? `<br><small class="text-muted">$${(product.revenue / product.orders).toFixed(2)}/order</small>` : ''}
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Add click event listeners to product names
        tbody.querySelectorAll('.product-name-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const productId = this.dataset.productId;
                const productName = this.dataset.productName;
                showProductDetailsModal(productId, productName);
            });
        });
    }
    
    // Show product details modal
    function showProductDetailsModal(productId, productName) {
        const modal = new bootstrap.Modal(document.getElementById('productDetailsModal'));
        const modalTitle = document.getElementById('productDetailsModalLabel');
        const modalContent = document.getElementById('productDetailsContent');
        
        modalTitle.innerHTML = `<i class="fas fa-box me-2"></i>${productName}`;
        modalContent.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading product details...</p>
            </div>
        `;
        
        modal.show();
        
        // Load product details
        loadProductDetails(productId);
    }
    
    // Load product details from API
    function loadProductDetails(productId) {
        fetch(`/mb-admin/api/products/${productId}/`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            displayProductDetails(data);
        })
        .catch(error => {
            console.error('Error loading product details:', error);
            document.getElementById('productDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed to load product details. Please try again.
                </div>
            `;
        });
    }
    
    // Display product details in modal
    function displayProductDetails(product) {
        const modalContent = document.getElementById('productDetailsContent');
        
        let variantsHtml = '';
        if (product.variants && product.variants.length > 0) {
            variantsHtml = `
                <div class="row">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-layer-group me-2"></i>Product Variants (${product.variants.length})
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead class="table-light">
                                    <tr>
                                        <th>Image</th>
                                        <th>Variant</th>
                                        <th>Price</th>
                                        <th>Cost Price</th>
                                        <th>Stock</th>
                                        <th>Sales Count</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${product.variants.map(variant => `
                                        <tr>
                                            <td>
                                                <img src="${variant.image_url || product.image_url || '/media/default.webp'}" 
                                                     alt="${variant.name || 'Variant'}" 
                                                     class="rounded"
                                                     style="width: 30px; height: 30px; object-fit: cover;"
                                                     onerror="this.src='/media/default.webp'">
                                            </td>
                                            <td>
                                                <strong>${variant.name || 'Default'}</strong>
                                                ${variant.size ? `<br><small class="text-muted">Size: ${variant.size}</small>` : ''}
                                                ${variant.color ? `<br><small class="text-muted">Color: ${variant.color}</small>` : ''}
                                            </td>
                                            <td>
                                                <span class="text-success fw-bold">$${parseFloat(variant.price || 0).toFixed(2)}</span>
                                            </td>
                                            <td>
                                                <span class="text-warning">$${parseFloat(variant.cost_price || 0).toFixed(2)}</span>
                                            </td>
                                            <td>
                                                <span class="badge ${variant.stock_quantity > 10 ? 'bg-success' : variant.stock_quantity > 0 ? 'bg-warning' : 'bg-danger'}">
                                                    ${variant.stock_quantity || 0}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">
                                                    ${variant.sales_count || 0} sold
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge ${variant.is_active ? 'bg-success' : 'bg-secondary'}">
                                                    ${variant.is_active ? 'Active' : 'Inactive'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        } else {
            variantsHtml = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    This product has no variants configured.
                </div>
            `;
        }
        
        modalContent.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <div class="position-relative">
                        <img src="${getProductMainImage(product)}" 
                             alt="${product.name}" 
                             class="img-fluid rounded border product-main-image"
                             style="max-height: 250px; object-fit: cover; width: 100%; cursor: pointer;"
                             onerror="handleImageError(this, '${product}')"
                             onclick="showImageFullScreen(this.src)">
                        <div class="position-absolute top-0 end-0 p-2">
                            <span class="badge bg-primary">Main Image</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <h5 class="text-primary">${product.name}</h5>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-sm-6">
                            <label class="form-label text-muted">Category</label>
                            <div class="fw-medium">${product.category_name || 'Uncategorized'}</div>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label text-muted">Status</label>
                            <div>
                                <span class="badge ${product.is_active ? 'bg-success' : 'bg-secondary'}">
                                    ${product.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label text-muted">Base Price</label>
                            <div class="fw-bold text-success">$${parseFloat(product.price || 0).toFixed(2)}</div>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label text-muted">Cost Price</label>
                            <div class="fw-bold text-warning">$${parseFloat(product.cost_price || 0).toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <hr class="my-4">
            
            ${variantsHtml}
        `;
        
        // Show edit button
        document.getElementById('editProductBtn').style.display = 'inline-block';
        document.getElementById('editProductBtn').onclick = function() {
            window.open(`/mb-admin/products/?edit=${product.id}`, '_blank');
        };
    }
    
    // Helper function to get the best available product image
    function getProductMainImage(product) {
        // Priority order for image selection:
        // 1. Product main image_url
        // 2. First variant image if available
        // 3. Default fallback image
        
        if (product.image_url && product.image_url !== 'null' && product.image_url !== null) {
            return product.image_url;
        }
        
        // Try to get first variant image
        if (product.variants && product.variants.length > 0) {
            for (let variant of product.variants) {
                if (variant.image_url && variant.image_url !== 'null' && variant.image_url !== null) {
                    return variant.image_url;
                }
            }
        }
        
        return '/media/default.webp';
    }
    
    // Handle image loading errors with multiple fallbacks
    function handleImageError(imgElement, productData) {
        const product = typeof productData === 'string' ? JSON.parse(productData) : productData;
        
        // If already showing default, don't try again
        if (imgElement.src.includes('default.webp')) {
            return;
        }
        
        // Try variant images as fallback
        if (product.variants && product.variants.length > 0) {
            for (let variant of product.variants) {
                if (variant.image_url && variant.image_url !== 'null' && 
                    variant.image_url !== null && !imgElement.src.includes(variant.image_url)) {
                    imgElement.src = variant.image_url;
                    return;
                }
            }
        }
        
        // Final fallback to default
        imgElement.src = '/media/default.webp';
    }
    
    // Show image in full screen (optional enhancement)
    function showImageFullScreen(imageSrc) {
        if (imageSrc.includes('default.webp')) return; // Don't show default image in fullscreen
        
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content bg-transparent border-0">
                    <div class="modal-body text-center p-0">
                        <img src="${imageSrc}" class="img-fluid rounded" style="max-height: 80vh;">
                        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" 
                                data-bs-dismiss="modal" aria-label="Close" style="filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));"></button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Remove modal from DOM when hidden
        modal.addEventListener('hidden.bs.modal', function() {
            document.body.removeChild(modal);
        });
    }
    
    // Update pagination
    function updateProductsPagination() {
        const totalPages = Math.ceil(productsFilteredData.length / productsPerPage);
        const pagination = document.getElementById('products-pagination');
        
        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }
        
        let paginationHTML = '';
        
        // Previous button
        paginationHTML += `
            <li class="page-item ${productsCurrentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${productsCurrentPage - 1}">Previous</a>
            </li>
        `;
        
        // Page numbers
        const startPage = Math.max(1, productsCurrentPage - 2);
        const endPage = Math.min(totalPages, productsCurrentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <li class="page-item ${i === productsCurrentPage ? 'active' : ''}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                </li>
            `;
        }
        
        // Next button
        paginationHTML += `
            <li class="page-item ${productsCurrentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${productsCurrentPage + 1}">Next</a>
            </li>
        `;
        
        pagination.innerHTML = paginationHTML;
        
        // Add event listeners to pagination links
        pagination.querySelectorAll('.page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                if (!this.closest('.page-item').classList.contains('disabled') && 
                    !this.closest('.page-item').classList.contains('active')) {
                    productsCurrentPage = parseInt(this.dataset.page);
                    updateProductsTable();
                    updateProductsPagination();
                }
            });
        });
    }
    
    // Update products summary
    function updateProductsSummary() {
        const totalProducts = productsFilteredData.length;
        const totalRevenue = productsFilteredData.reduce((sum, product) => sum + (product.revenue || 0), 0);
        const totalOrders = productsFilteredData.reduce((sum, product) => sum + (product.orders || 0), 0);
        const totalDelivered = productsFilteredData.reduce((sum, product) => sum + (product.delivered_quantity || 0), 0);
        
        const searchTerm = document.getElementById('products-search').value.trim();
        const hasFilters = searchTerm || 
                          document.getElementById('products-date-from').value || 
                          document.getElementById('products-date-to').value;
        
        let summaryText = `${totalProducts} products`;
        if (hasFilters) summaryText += ' (filtered)';
        summaryText += ` • ${totalOrders} orders • ${totalDelivered} delivered • $${totalRevenue.toFixed(2)} revenue`;
        
        document.getElementById('products-summary').textContent = summaryText;
    }
    
    // Update sort icons in table headers
    function updateSortIcons() {
        document.querySelectorAll('th[data-sort] i').forEach(icon => {
            icon.className = 'fas fa-sort text-muted ms-1';
        });
        
        const activeHeader = document.querySelector(`th[data-sort="${productsSortBy}"] i`);
        if (activeHeader) {
            activeHeader.className = `fas fa-sort-${productsSortOrder === 'asc' ? 'up' : 'down'} text-primary ms-1`;
        }
    }
    
    // Export products data
    function exportProductsData() {
        const dateFrom = document.getElementById('products-date-from').value;
        const dateTo = document.getElementById('products-date-to').value;
        const searchTerm = document.getElementById('products-search').value;
        
        let url = `/mb-admin/api/export-products/?period=${currentPeriod}&sort=${productsSortBy}&order=${productsSortOrder}`;
        if (dateFrom) url += `&date_from=${dateFrom}`;
        if (dateTo) url += `&date_to=${dateTo}`;
        if (searchTerm) url += `&search=${encodeURIComponent(searchTerm)}`;
        
        // Create a temporary link to download
        const link = document.createElement('a');
        link.href = url;
        link.download = 'products_performance.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert('Products export started...', 'info');
    }
    
    // Legacy function for backward compatibility - now loads with filters
    function updateTopProductsTable(productsData) {
        // Store the data and apply current filters
        productsAllData = productsData || [];
        sortAndFilterProducts();
    }
    
    // Update order status table
    // Update order status table with enhanced styling and summary cards
    function updateOrderStatusTable(statusData) {
        const tbody = document.getElementById('order-status-table');
        const summaryContainer = document.getElementById('status-summary-cards');
        
        tbody.innerHTML = '';
        summaryContainer.innerHTML = '';
        
        if (statusData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">No status data available</td></tr>';
            summaryContainer.innerHTML = `
                <div class="col-12">
                    <div class="text-center py-3 text-muted">
                        <i class="fas fa-info-circle me-2"></i>No order status data available
                    </div>
                </div>
            `;
            return;
        }
        
        // Calculate total
        const totalOrders = statusData.reduce((sum, item) => sum + item.count, 0);
        
        // Status configuration for icons and colors
        const statusConfig = {
            'pending': { 
                icon: 'fas fa-clock', 
                class: 'pending', 
                label: 'Pending',
                iconColor: '#ffc107',
                textColor: '#856404'
            },
            'confirmed': { 
                icon: 'fas fa-check', 
                class: 'confirmed', 
                label: 'Confirmed',
                iconColor: '#007bff',
                textColor: '#004085'
            },
            'processing': { 
                icon: 'fas fa-cog fa-spin', 
                class: 'processing', 
                label: 'Processing',
                iconColor: '#17a2b8',
                textColor: '#0c5460'
            },
            'shipped': { 
                icon: 'fas fa-shipping-fast', 
                class: 'shipped', 
                label: 'Shipped',
                iconColor: '#20c997',
                textColor: '#0a3622'
            },
            'delivered': { 
                icon: 'fas fa-check-circle', 
                class: 'delivered', 
                label: 'Delivered',
                iconColor: '#28a745',
                textColor: '#155724'
            },
            'cancelled': { 
                icon: 'fas fa-times-circle', 
                class: 'cancelled', 
                label: 'Cancelled',
                iconColor: '#dc3545',
                textColor: '#721c24'
            },
            'returned': { 
                icon: 'fas fa-undo', 
                class: 'returned', 
                label: 'Returned',
                iconColor: '#6c757d',
                textColor: '#383d41'
            },
            'partial_return': { 
                icon: 'fas fa-exclamation-triangle', 
                class: 'partial_return', 
                label: 'Partial Return',
                iconColor: '#fd7e14',
                textColor: '#7a3e0d'
            },
            'partially_returned': { 
                icon: 'fas fa-exclamation-triangle', 
                class: 'partial_return', 
                label: 'Partially Returned',
                iconColor: '#fd7e14',
                textColor: '#7a3e0d'
            }
        };
        
        // Create summary cards for top statuses
        const topStatuses = statusData.slice(0, 3); // Show top 3 statuses
        topStatuses.forEach(status => {
            const config = statusConfig[status.status] || statusConfig['pending'];
            const percentage = totalOrders > 0 ? ((status.count / totalOrders) * 100).toFixed(1) : 0;
            
            const cardDiv = document.createElement('div');
            cardDiv.className = 'col-12 mb-2';
            cardDiv.innerHTML = `
                <div class="status-summary-card ${config.class}" data-status="${status.status}">
                    <div class="status-icon ${config.class}">
                        <i class="${config.icon}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold text-dark" style="font-size: 0.9rem;">${config.label}</div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">${status.count} orders</small>
                            <span class="badge bg-secondary">${percentage}%</span>
                        </div>
                    </div>
                </div>
            `;
            summaryContainer.appendChild(cardDiv);
        });
        
        // Add total summary if there are more than 3 statuses
        if (statusData.length > 3) {
            const otherCount = statusData.slice(3).reduce((sum, item) => sum + item.count, 0);
            if (otherCount > 0) {
                const otherPercentage = ((otherCount / totalOrders) * 100).toFixed(1);
                const cardDiv = document.createElement('div');
                cardDiv.className = 'col-12 mb-2';
                cardDiv.innerHTML = `
                    <div class="status-summary-card" style="border-left: 4px solid #6c757d;">
                        <div class="status-icon" style="background: rgba(108, 117, 125, 0.2); color: #6c757d;">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold text-dark" style="font-size: 0.9rem;">Others</div>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">${otherCount} orders</small>
                                <span class="badge bg-secondary">${otherPercentage}%</span>
                            </div>
                        </div>
                    </div>
                `;
                summaryContainer.appendChild(cardDiv);
            }
        }
        
        // Populate detailed table
        statusData.forEach(status => {
            const config = statusConfig[status.status] || statusConfig['pending'];
            const percentage = totalOrders > 0 ? ((status.count / totalOrders) * 100).toFixed(1) : 0;
            
            const tr = document.createElement('tr');
            tr.className = 'table-row-hover';
            tr.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <i class="${config.icon} me-2" style="width: 16px; color: ${config.iconColor};"></i>
                        <span class="fw-medium" style="color: ${config.textColor};">${config.label}</span>
                    </div>
                </td>
                <td class="text-center">
                    <span class="badge bg-light text-dark">${status.count}</span>
                </td>
                <td class="text-end">
                    <div class="d-flex align-items-center justify-content-end">
                        <div class="progress me-2" style="width: 50px; height: 8px;">
                            <div class="progress-bar" style="width: ${percentage}%; background-color: ${config.iconColor};"></div>
                        </div>
                        <small class="fw-bold" style="color: ${config.textColor};">${percentage}%</small>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Add total row
        if (statusData.length > 1) {
            const totalTr = document.createElement('tr');
            totalTr.className = 'table-info fw-bold';
            totalTr.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-calculator me-2"></i>
                        <span>Total Orders</span>
                    </div>
                </td>
                <td class="text-center">
                    <span class="badge bg-primary">${totalOrders}</span>
                </td>
                <td class="text-end">
                    <span class="fw-bold">100%</span>
                </td>
            `;
            tbody.appendChild(totalTr);
        }
        
        // Add click events to summary cards for filtering/highlighting
        summaryContainer.querySelectorAll('.status-summary-card').forEach(card => {
            card.addEventListener('click', function() {
                const statusName = this.dataset.status;
                highlightStatusInChart(statusName);
            });
        });
    }
    
    // Add helper functions for the enhanced order status features
    function updateOrderStatusChartType(chartType) {
        if (orderStatusChart) {
            orderStatusChart.config.type = chartType;
            
            // Adjust options based on chart type
            if (chartType === 'bar') {
                orderStatusChart.options.plugins.legend.position = 'top';
                orderStatusChart.options.scales = {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                };
            } else {
                orderStatusChart.options.plugins.legend.position = 'bottom';
                if (orderStatusChart.options.scales) {
                    delete orderStatusChart.options.scales;
                }
            }
            
            orderStatusChart.update();
        }
    }
    
    function highlightStatusInChart(statusName) {
        if (orderStatusChart && orderStatusChart.data.labels) {
            // Find the index of the status
            const statusIndex = orderStatusChart.data.labels.findIndex(label => 
                label.toLowerCase().replace(' ', '_') === statusName
            );
            
            if (statusIndex !== -1) {
                // Temporarily highlight the segment
                const originalColors = [...orderStatusChart.data.datasets[0].backgroundColor];
                const highlightColors = originalColors.map((color, index) => 
                    index === statusIndex ? color : color.replace('0.8', '0.3')
                );
                
                orderStatusChart.data.datasets[0].backgroundColor = highlightColors;
                orderStatusChart.update();
                
                // Restore original colors after 2 seconds
                setTimeout(() => {
                    orderStatusChart.data.datasets[0].backgroundColor = originalColors;
                    orderStatusChart.update();
                }, 2000);
            }
        }
    }
    
    function exportOrderStatusData() {
        if (!orderStatusChart || !orderStatusChart.data.labels) {
            showAlert('No status data available to export', 'warning');
            return;
        }
        
        const csvContent = "data:text/csv;charset=utf-8," + 
            "Status,Count,Percentage\n" +
            orderStatusChart.data.labels.map((label, index) => {
                const count = orderStatusChart.data.datasets[0].data[index];
                const total = orderStatusChart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0';
                return `${label},${count},${percentage}%`;
            }).join("\n");
            
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `order_status_breakdown_${formatDhakaDate()}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert('Order status data exported successfully!', 'success');
    }
    
    // Update analytics metrics
    function updateAnalyticsMetrics(analytics) {
        // Default values if data is not available
        const retention = analytics.customer_retention_rate || 0;
        const conversion = analytics.conversion_rate || 0;
        const inventory = analytics.inventory_turnover || 0;
        
        // Update retention rate
        document.getElementById('retention-rate').textContent = `${retention}%`;
        document.getElementById('retention-progress').style.width = `${retention}%`;
        
        // Update conversion rate
        document.getElementById('conversion-rate').textContent = `${conversion}%`;
        document.getElementById('conversion-progress').style.width = `${conversion}%`;
        
        // Update inventory turnover
        document.getElementById('inventory-turnover').textContent = inventory.toFixed(1);
        document.getElementById('inventory-progress').style.width = `${Math.min(inventory * 10, 100)}%`;
    }
    
    // Update recommendations
    function updateRecommendations(recommendations) {
        const list = document.getElementById('recommendations-list');
        list.innerHTML = '';
        
        if (recommendations.length === 0) {
            list.innerHTML = '<div class="alert alert-info">No recommendations available at this time.</div>';
            return;
        }
        
        recommendations.forEach(recommendation => {
            const item = document.createElement('div');
            item.className = 'list-group-item';
            
            let iconClass = 'info';
            switch(recommendation.type) {
                case 'warning':
                    iconClass = 'warning text-warning';
                    break;
                case 'success':
                    iconClass = 'check-circle text-success';
                    break;
                case 'danger':
                    iconClass = 'exclamation-triangle text-danger';
                    break;
            }
            
            item.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${iconClass} me-3"></i>
                    <div>
                        <h6 class="mb-1">${recommendation.title}</h6>
                        <p class="mb-0 small">${recommendation.description}</p>
                    </div>
                </div>
            `;
            
            list.appendChild(item);
        });
    }
    
    // Download reports
    function downloadReport(reportType, period) {
        const url = `/mb-admin/api/reports/${reportType}/?period=${period}`;
        
        // Show a loading message
        showAlert(`Generating ${reportType} report...`, 'info');
        
        // Redirect to download URL
        window.location.href = url;
    }
    
    // Helper function to show alerts
    function showAlert(message, type) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Insert at the top of the content area
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                const bsAlert = bootstrap.Alert.getOrCreateInstance(alertDiv);
                bsAlert.close();
            }
        }, 5000);
    }
    
    // Helper function to get CSRF cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}
