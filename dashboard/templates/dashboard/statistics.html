{% extends 'dashboard/base.html' %}

{% block title %}Statistics - MB Admin{% endblock %}

{% block page_title %}Sales & Performance Statistics{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Time Period</h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary period-btn active" data-period="week">Week</button>
                    <button type="button" class="btn btn-sm btn-outline-primary period-btn" data-period="month">Month</button>
                    <button type="button" class="btn btn-sm btn-outline-primary period-btn" data-period="year">Year</button>
                    <button type="button" class="btn btn-sm btn-outline-primary period-btn" data-period="all">All Time</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card card-stats h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0" id="total-sales-stat">$0.00</h3>
                        <p class="text-white mb-0">Total Sales Amount</p>
                        <small class="text-muted">Delivered + Shipped + Partial Returns</small>
                    </div>
                    <div>
                        <i class="fas fa-money-bill-wave fa-2x text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card card-stats h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0" id="total-orders-stat">0</h3>
                        <p class="text-white mb-0">Total Orders</p>
                        <small class="text-muted">All order count</small>
                    </div>
                    <div>
                        <i class="fas fa-shopping-cart fa-2x text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card card-stats h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0" id="total-expenses-stat">$0.00</h3>
                        <p class="text-white mb-0">Total Expenses</p>
                        <small class="text-muted">Business expenses + Courier charges</small>
                    </div>
                    <div>
                        <i class="fas fa-receipt fa-2x text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card card-stats h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0" id="total-revenue-stat">$0.00</h3>
                        <p class="text-white mb-0">Total Revenue</p>
                        <small class="text-muted">Sales - (Expenses + Product Cost)</small>
                    </div>
                    <div>
                        <i class="fas fa-chart-line fa-2x text-info"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-left-primary h-100">
            <div class="card-body">
                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                    Total Courier Charge
                </div>
                <div class="h5 mb-0 font-weight-bold" id="total-courier-charge-stat">$0.00</div>
                <small class="text-muted">Delivered + Shipped + Returned + Partially Returned</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-left-info h-100">
            <div class="card-body">
                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                    Dashboard Expenses
                </div>
                <div class="h5 mb-0 font-weight-bold" id="dashboard-expenses-stat">$0.00</div>
                <small class="text-muted">Business operational expenses</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-left-success h-100">
            <div class="card-body">
                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                    Product Cost
                </div>
                <div class="h5 mb-0 font-weight-bold" id="product-cost-stat">$0.00</div>
                <small class="text-muted">Cost of goods for delivered & shipped orders</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-left-warning h-100">
            <div class="card-body">
                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                    Profit Margin
                </div>
                <div class="h5 mb-0 font-weight-bold" id="profit-margin-stat">0%</div>
                <small class="text-muted">Revenue as % of sales</small>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card h-100 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center bg-gradient-primary text-white">
                <div class="d-flex align-items-center">
                    <i class="fas fa-chart-line me-2"></i>
                    <h5 class="mb-0">Financial Performance Overview</h5>
                </div>
                <div class="d-flex gap-2">
                    <!-- Year Filter -->
                    <select class="form-select form-select-sm" id="year-filter" style="width: auto; min-width: 120px;">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="all">All Years</option>
                    </select>
                    
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light dropdown-toggle" type="button" id="salesChartDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-cog me-1"></i> Options
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="salesChartDropdown">
                            <li><h6 class="dropdown-header">Chart Type</h6></li>
                            <li><a class="dropdown-item chart-type-option active" data-type="line" href="#">
                                <i class="fas fa-chart-line me-2"></i> Line Chart
                            </a></li>
                            <li><a class="dropdown-item chart-type-option" data-type="bar" href="#">
                                <i class="fas fa-chart-bar me-2"></i> Bar Chart
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header">View Options</h6></li>
                            <li><a class="dropdown-item" href="#" id="toggle-grid">
                                <i class="fas fa-border-all me-2"></i> Toggle Grid
                            </a></li>
                            <li><a class="dropdown-item" href="#" id="toggle-animation">
                                <i class="fas fa-play me-2"></i> Toggle Animation
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body p-3">
                <!-- Legend with custom styling -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="d-flex flex-wrap justify-content-center gap-3">
                            <div class="legend-item d-flex align-items-center">
                                <div class="legend-color" style="background: linear-gradient(45deg, #28a745, #20c997); width: 16px; height: 16px; border-radius: 50%; margin-right: 8px; box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);"></div>
                                <span class="badge bg-success-subtle text-success fw-medium">Sales Revenue</span>
                            </div>
                            <div class="legend-item d-flex align-items-center">
                                <div class="legend-color" style="background: linear-gradient(45deg, #dc3545, #fd7e14); width: 16px; height: 16px; border-radius: 50%; margin-right: 8px; box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);"></div>
                                <span class="badge bg-danger-subtle text-danger fw-medium">Total Expenses</span>
                            </div>
                            <div class="legend-item d-flex align-items-center">
                                <div class="legend-color" style="background: linear-gradient(45deg, #007bff, #6f42c1); width: 16px; height: 16px; border-radius: 50%; margin-right: 8px; box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);"></div>
                                <span class="badge bg-primary-subtle text-primary fw-medium">Net Revenue</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="height: 400px; position: relative;">
                    <canvas id="salesChart"></canvas>
                    <!-- Loading overlay -->
                    <div id="chart-loading" class="position-absolute top-50 start-50 translate-middle d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading chart data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Sales by Category</h5>
            </div>
            <div class="card-body">
                <div style="height: 350px;">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Product Performance</h5>
                <div class="d-flex gap-2 align-items-center">
                    <select class="form-select form-select-sm" id="products-sort" style="width: auto;">
                        <option value="orders">Sort by Orders</option>
                        <option value="delivered">Sort by Delivered</option>
                        <option value="revenue">Sort by Revenue</option>
                        <option value="name">Sort by Name</option>
                    </select>
                    <button class="btn btn-sm btn-outline-secondary" id="products-refresh">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Search and Date Filter Controls -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="products-search" placeholder="Search products...">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                            <input type="date" class="form-control" id="products-date-from" title="From Date">
                            <input type="date" class="form-control" id="products-date-to" title="To Date">
                        </div>
                    </div>
                </div>
                
                <!-- Results Summary -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted" id="products-summary">Loading products...</small>
                    <div class="d-flex gap-1">
                        <button class="btn btn-xs btn-outline-primary" id="products-clear-filters" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">
                            Clear Filters
                        </button>
                        <button class="btn btn-xs btn-outline-success" id="products-export" style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-sm table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th style="cursor: pointer;" data-sort="name">
                                    Product Name 
                                    <i class="fas fa-sort text-muted ms-1"></i>
                                </th>
                                <th style="cursor: pointer;" data-sort="orders" class="text-center">
                                    Orders 
                                    <i class="fas fa-sort text-muted ms-1"></i>
                                </th>
                                <th style="cursor: pointer;" data-sort="delivered" class="text-center">
                                    Delivered 
                                    <i class="fas fa-sort text-muted ms-1"></i>
                                </th>
                                <th style="cursor: pointer;" data-sort="revenue" class="text-end">
                                    Revenue 
                                    <i class="fas fa-sort text-muted ms-1"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="top-products-table">
                            <tr>
                                <td colspan="4" class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="ms-2">Loading product data...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <nav aria-label="Products pagination" class="mt-3">
                    <ul class="pagination pagination-sm justify-content-center mb-0" id="products-pagination">
                        <!-- Pagination will be generated by JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-gradient-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Order Status Breakdown
                    </h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light dropdown-toggle" type="button" id="statusChartDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-cog"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="statusChartDropdown">
                            <li><a class="dropdown-item status-chart-type" data-type="pie" href="#">
                                <i class="fas fa-chart-pie me-2"></i>Pie Chart
                            </a></li>
                            <li><a class="dropdown-item status-chart-type active" data-type="doughnut" href="#">
                                <i class="fas fa-dot-circle me-2"></i>Doughnut Chart
                            </a></li>
                            <li><a class="dropdown-item status-chart-type" data-type="bar" href="#">
                                <i class="fas fa-chart-bar me-2"></i>Bar Chart
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container position-relative" style="height: 280px;">
                            <canvas id="orderStatusChart"></canvas>
                            <!-- Loading overlay for chart -->
                            <div id="status-chart-loading" class="position-absolute top-50 start-50 translate-middle d-none">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- Status Summary Cards -->
                        <div class="mb-3">
                            <div class="row g-2" id="status-summary-cards">
                                <div class="col-12">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2 mb-0 text-muted">Loading status summary...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Detailed Status Table -->
                        <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th><i class="fas fa-tag me-1"></i>Status</th>
                                        <th class="text-center"><i class="fas fa-hashtag me-1"></i>Count</th>
                                        <th class="text-end"><i class="fas fa-percentage me-1"></i>%</th>
                                    </tr>
                                </thead>
                                <tbody id="order-status-table">
                                    <tr>
                                        <td colspan="3" class="text-center py-3">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <span class="ms-2">Loading data...</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Status Insights -->
                <div class="row mt-3 pt-3 border-top">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                Last updated: <span id="status-last-updated">-</span>
                            </small>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="refresh-status" title="Refresh Data">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm" id="export-status" title="Export Status Data">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Sales Analytics</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card border mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Customer Retention Rate</h6>
                                <div class="d-flex align-items-center">
                                    <div class="display-4 me-3" id="retention-rate">-%</div>
                                    <div class="flex-grow-1">
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 0%;" id="retention-progress"></div>
                                        </div>
                                    </div>
                                </div>
                                <small class="text-muted">Percentage of repeat customers</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card border mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Conversion Rate</h6>
                                <div class="d-flex align-items-center">
                                    <div class="display-4 me-3" id="conversion-rate">-%</div>
                                    <div class="flex-grow-1">
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar bg-primary" role="progressbar" style="width: 0%;" id="conversion-progress"></div>
                                        </div>
                                    </div>
                                </div>
                                <small class="text-muted">Orders to site visits ratio</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card border mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Inventory Turnover</h6>
                                <div class="d-flex align-items-center">
                                    <div class="display-4 me-3" id="inventory-turnover">-</div>
                                    <div class="flex-grow-1">
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar bg-info" role="progressbar" style="width: 0%;" id="inventory-progress"></div>
                                        </div>
                                    </div>
                                </div>
                                <small class="text-muted">Sales to inventory ratio</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="mb-3">Recommendations</h6>
                        <div class="list-group" id="recommendations-list">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Analyzing data for recommendations...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h6 class="mb-3">Download Reports</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" id="download-sales-report-btn">
                                <i class="fas fa-file-excel me-2"></i> Sales Report
                            </button>
                            <button class="btn btn-outline-primary" id="download-product-report-btn">
                                <i class="fas fa-file-excel me-2"></i> Product Performance Report
                            </button>
                            <button class="btn btn-outline-primary" id="download-customer-report-btn">
                                <i class="fas fa-file-excel me-2"></i> Customer Analysis Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Details Modal -->
<div class="modal fade" id="productDetailsModal" tabindex="-1" aria-labelledby="productDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="productDetailsModalLabel">
                    <i class="fas fa-box me-2"></i>Product Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="productDetailsContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading product details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editProductBtn" style="display: none;">
                    <i class="fas fa-edit me-2"></i>Edit Product
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Custom styles for the financial chart */
    .bg-gradient-primary {
        background: linear-gradient(135deg, #007bff 0%, #6f42c1 100%) !important;
    }
    
    .bg-gradient-info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
    }
    
    .legend-item {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .legend-item:hover {
        transform: translateY(-2px);
    }
    
    .badge {
        font-size: 0.75rem;
        padding: 0.5em 0.75em;
        border-radius: 0.5rem;
    }
    
    .bg-success-subtle {
        background-color: rgba(40, 167, 69, 0.1) !important;
    }
    
    .bg-danger-subtle {
        background-color: rgba(220, 53, 69, 0.1) !important;
    }
    
    .bg-primary-subtle {
        background-color: rgba(0, 123, 255, 0.1) !important;
    }
    
    .text-success {
        color: #28a745 !important;
    }
    
    .text-danger {
        color: #dc3545 !important;
    }
    
    .text-primary {
        color: #007bff !important;
    }
    
    .shadow-sm {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
    }
    
    .card-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .dropdown-menu {
        border: none;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border-radius: 0.5rem;
    }
    
    .dropdown-item {
        padding: 0.5rem 1rem;
        transition: all 0.2s ease;
    }
    
    .dropdown-item:hover {
        background-color: rgba(0, 123, 255, 0.1);
        color: #007bff;
    }
    
    .dropdown-header {
        color: #6c757d;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    #chart-loading, #status-chart-loading {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 0.5rem;
        padding: 2rem;
        text-align: center;
        backdrop-filter: blur(5px);
    }
    
    /* Order Status specific styles */
    .status-summary-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 249, 250, 0.9) 100%);
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 0.5rem;
        padding: 0.75rem;
        transition: all 0.3s ease;
        cursor: pointer;
        min-height: 60px;
        display: flex;
        align-items: center;
    }
    
    .status-summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
    }
    
    .status-summary-card.pending {
        border-left: 4px solid #ffc107;
    }
    
    .status-summary-card.processing {
        border-left: 4px solid #17a2b8;
    }
    
    .status-summary-card.shipped {
        border-left: 4px solid #20c997;
    }
    
    .status-summary-card.delivered {
        border-left: 4px solid #28a745;
    }
    
    .status-summary-card.cancelled {
        border-left: 4px solid #dc3545;
    }
    
    .status-summary-card.returned {
        border-left: 4px solid #6c757d;
    }
    
    .status-summary-card.partial_return {
        border-left: 4px solid #fd7e14;
    }
    
    .status-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
        font-size: 0.9rem;
    }
    
    .status-icon.pending {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
    }
    
    .status-icon.processing {
        background: rgba(23, 162, 184, 0.2);
        color: #17a2b8;
    }
    
    .status-icon.shipped {
        background: rgba(32, 201, 151, 0.2);
        color: #20c997;
    }
    
    .status-icon.delivered {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
    }
    
    .status-icon.cancelled {
        background: rgba(220, 53, 69, 0.2);
        color: #dc3545;
    }
    
    .status-icon.returned {
        background: rgba(108, 117, 125, 0.2);
        color: #6c757d;
    }
    
    .status-icon.partial_return {
        background: rgba(253, 126, 20, 0.2);
        color: #fd7e14;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .legend-item {
            margin-bottom: 0.5rem;
        }
        
        .d-flex.flex-wrap.justify-content-center {
            justify-content: flex-start !important;
        }
        
        .status-summary-card {
            margin-bottom: 0.5rem;
        }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .legend-item {
            margin-bottom: 0.5rem;
        }
        
        .d-flex.flex-wrap.justify-content-center {
            justify-content: flex-start !important;
        }
    }
    
    /* Animation for chart container */
    .card {
        transition: all 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    
    /* Product table enhancements */
    .table-dark th {
        background-color: #343a40 !important;
        border-color: #454d55 !important;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .btn-xs {
        padding: 0.2rem 0.4rem;
        font-size: 0.7rem;
        border-radius: 0.2rem;
    }
    
    .input-group-sm .input-group-text {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    
    .pagination-sm .page-link {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
    
    /* Sort icons */
    th[data-sort] {
        user-select: none;
        transition: background-color 0.2s ease;
    }
    
    th[data-sort]:hover {
        background-color: rgba(255, 255, 255, 0.1) !important;
    }
    
    /* Product image and modal styles */
    .product-thumbnail {
        transition: transform 0.2s ease;
    }
    
    .product-thumbnail:hover {
        transform: scale(1.05);
    }
    
    .product-name-link {
        color: #495057;
        transition: color 0.2s ease;
    }
    
    .product-name-link:hover {
        color: #007bff !important;
        text-decoration: underline !important;
    }
    
    .modal-lg {
        max-width: 900px;
    }
    
    .modal-body .table th {
        background-color: #f8f9fa;
        border-top: none;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .modal-body .badge {
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize chart objects
    let salesChart, categoryChart, orderStatusChart;
    
    // Current period selection
    let currentPeriod = 'week';
    let currentYear = new Date().getFullYear().toString();
    
    // Products filtering and pagination
    let productsCurrentPage = 1;
    let productsPerPage = 10;
    let productsAllData = [];
    let productsFilteredData = [];
    let productsSortBy = 'orders';
    let productsSortOrder = 'desc';
    
    // Set current year as default in dropdown
    document.getElementById('year-filter').value = currentYear;
    
    // Set default date range (current month)
    const today = new Date();
    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    document.getElementById('products-date-from').value = firstDayOfMonth.toISOString().split('T')[0];
    document.getElementById('products-date-to').value = today.toISOString().split('T')[0];
    
    // Load initial data
    loadStatistics(currentPeriod);
    
    // Set up event listeners for period buttons
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active class
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Load data for selected period
            currentPeriod = this.dataset.period;
            loadStatistics(currentPeriod);
        });
    });
    
    // Set up event listener for year filter
    document.getElementById('year-filter').addEventListener('change', function() {
        currentYear = this.value;
        loadStatistics(currentPeriod);
    });
    
    // Set up event listeners for status chart options
    document.querySelectorAll('.status-chart-type').forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update active class
            document.querySelectorAll('.status-chart-type').forEach(o => o.classList.remove('active'));
            this.classList.add('active');
            
            // Update chart type
            const chartType = this.dataset.type;
            updateOrderStatusChartType(chartType);
        });
    });
    
    // Status chart refresh and export
    document.getElementById('refresh-status').addEventListener('click', function() {
        loadStatistics(currentPeriod);
    });
    
    document.getElementById('export-status').addEventListener('click', function() {
        exportOrderStatusData();
    });
    
    // Set up event listeners for chart options
    document.querySelectorAll('.chart-type-option').forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update active class
            document.querySelectorAll('.chart-type-option').forEach(o => o.classList.remove('active'));
            this.classList.add('active');
            
            // Update chart type
            const chartType = this.dataset.type;
            updateSalesChartType(chartType);
        });
    });
    
    // Chart view options
    document.getElementById('toggle-grid').addEventListener('click', function(e) {
        e.preventDefault();
        if (salesChart) {
            const gridDisplay = salesChart.options.scales.x.grid.display;
            salesChart.options.scales.x.grid.display = !gridDisplay;
            salesChart.options.scales.y.grid.display = !gridDisplay;
            salesChart.update();
        }
    });
    
    document.getElementById('toggle-animation').addEventListener('click', function(e) {
        e.preventDefault();
        if (salesChart) {
            const animationEnabled = salesChart.options.animation.duration > 0;
            salesChart.options.animation.duration = animationEnabled ? 0 : 1000;
            salesChart.update();
        }
    });
    
    // Set up event listeners for report download buttons
    document.getElementById('download-sales-report-btn').addEventListener('click', function() {
        downloadReport('sales', currentPeriod);
    });
    
    document.getElementById('download-product-report-btn').addEventListener('click', function() {
        downloadReport('products', currentPeriod);
    });
    
    document.getElementById('download-customer-report-btn').addEventListener('click', function() {
        downloadReport('customers', currentPeriod);
    });
    
    // Set up event listeners for product filtering
    document.getElementById('products-sort').addEventListener('change', function() {
        productsSortBy = this.value;
        sortAndFilterProducts();
    });
    
    document.getElementById('products-search').addEventListener('input', function() {
        productsCurrentPage = 1; // Reset to first page
        sortAndFilterProducts();
    });
    
    document.getElementById('products-date-from').addEventListener('change', function() {
        productsCurrentPage = 1;
        loadProductsWithFilters();
    });
    
    document.getElementById('products-date-to').addEventListener('change', function() {
        productsCurrentPage = 1;
        loadProductsWithFilters();
    });
    
    document.getElementById('products-refresh').addEventListener('click', function() {
        loadProductsWithFilters();
    });
    
    document.getElementById('products-clear-filters').addEventListener('click', function() {
        document.getElementById('products-search').value = '';
        document.getElementById('products-sort').value = 'orders';
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById('products-date-from').value = firstDayOfMonth.toISOString().split('T')[0];
        document.getElementById('products-date-to').value = today.toISOString().split('T')[0];
        productsSortBy = 'orders';
        productsCurrentPage = 1;
        loadProductsWithFilters();
    });
    
    document.getElementById('products-export').addEventListener('click', function() {
        exportProductsData();
    });
    
    // Table header sorting - Fix the selector to target the table parent
    document.querySelector('.table-responsive').addEventListener('click', function(e) {
        if (e.target.closest('th[data-sort]')) {
            const sortField = e.target.closest('th').dataset.sort;
            if (productsSortBy === sortField) {
                productsSortOrder = productsSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                productsSortBy = sortField;
                productsSortOrder = 'desc';
            }
            document.getElementById('products-sort').value = sortField;
            sortAndFilterProducts();
        }
    });
    
    // Function to load statistics for the selected period
    function loadStatistics(period) {
        fetch(`/mb-admin/api/statistics/?period=${period}`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Update summary statistics
                updateSummaryStats(data);
                
                // Update charts with real data
                updateSalesChart(data, period);
                updateCategoryChart(data.sales_by_category || []);
                updateOrderStatusChart(data.orders_by_status || []);
                
                // Update tables
                updateTopProductsTable(data.popular_products || []);
                updateOrderStatusTable(data.orders_by_status || []);
                
                // Load detailed products data with current filters
                loadProductsWithFilters();
                
                // Update analytics metrics
                updateAnalyticsMetrics(data.analytics || {});
                
                // Update recommendations
                updateRecommendations(data.recommendations || []);
            })
            .catch(error => {
                console.error('Error loading statistics:', error);
                showAlert('Failed to load statistics data.', 'danger');
            });
    }
    
    // Update summary statistics
    function updateSummaryStats(data) {
        document.getElementById('total-sales-stat').textContent = `$${data.total_sales.toFixed(2)}`;
        document.getElementById('total-orders-stat').textContent = data.orders_count;
        document.getElementById('total-expenses-stat').textContent = `$${data.total_expenses.toFixed(2)}`;
        document.getElementById('total-revenue-stat').textContent = `$${data.total_revenue.toFixed(2)}`;
        
        // Update detailed expense breakdown
        document.getElementById('total-courier-charge-stat').textContent = `$${data.courier_expenses.toFixed(2)}`;
        document.getElementById('dashboard-expenses-stat').textContent = `$${data.dashboard_expenses.toFixed(2)}`;
        document.getElementById('product-cost-stat').textContent = `$${data.total_product_cost.toFixed(2)}`;
        document.getElementById('profit-margin-stat').textContent = `${data.profit_margin}%`;
        
        // Update revenue color based on positive/negative value
        const revenueElement = document.getElementById('total-revenue-stat');
        const revenueCard = revenueElement.closest('.card');
        const revenueIcon = revenueCard.querySelector('i');
        
        if (data.total_revenue < 0) {
            revenueElement.style.color = '#dc3545'; // Red for negative
            revenueIcon.className = 'fas fa-chart-line-down fa-2x text-danger';
        } else {
            revenueElement.style.color = '#28a745'; // Green for positive
            revenueIcon.className = 'fas fa-chart-line fa-2x text-success';
        }
        
        // Update profit margin color based on percentage
        const profitMarginElement = document.getElementById('profit-margin-stat');
        if (data.profit_margin < 0) {
            profitMarginElement.style.color = '#dc3545'; // Red for negative
        } else if (data.profit_margin < 10) {
            profitMarginElement.style.color = '#ffc107'; // Yellow for low margin
        } else {
            profitMarginElement.style.color = '#28a745'; // Green for healthy margin
        }
    }
    
    // Update financial comparison chart - ONLY REAL DATA
    function updateSalesChart(statisticsData, period) {
        const ctx = document.getElementById('salesChart').getContext('2d');
        
        // Show loading
        document.getElementById('chart-loading').classList.remove('d-none');
        
        // Use ONLY real data from API
        const currentSales = statisticsData.total_sales || 0;
        const currentExpenses = statisticsData.total_expenses || 0;
        const currentRevenue = statisticsData.total_revenue || 0;
        
        // For now, show only current period data (no historical mock data)
        const currentDate = new Date();
        let chartLabel = '';
        
        // Determine the appropriate label based on selected year and current date
        if (currentYear === 'all') {
            chartLabel = 'All Time';
        } else {
            const selectedYearInt = parseInt(currentYear);
            if (selectedYearInt === currentDate.getFullYear()) {
                chartLabel = `Current (${currentDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })})`;
            } else {
                chartLabel = `Year ${currentYear}`;
            }
        }
        
        // Single data point with actual API data
        const periods = [chartLabel];
        const salesValues = [Math.round(currentSales)];
        const expenseValues = [Math.round(currentExpenses)];
        const revenueValues = [Math.round(currentRevenue)];
        
        const chartData = {
            labels: periods,
            datasets: [
                {
                    label: 'Sales Revenue',
                    data: salesValues,
                    borderColor: 'rgba(40, 167, 69, 1)',
                    backgroundColor: 'rgba(40, 167, 69, 0.3)',
                    borderWidth: 3,
                    tension: 0.4,
                    pointBackgroundColor: 'rgba(40, 167, 69, 1)',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 3,
                    pointRadius: 8,
                    pointHoverRadius: 12,
                    pointHoverBackgroundColor: 'rgba(40, 167, 69, 1)',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 4,
                    fill: false
                },
                {
                    label: 'Total Expenses',
                    data: expenseValues,
                    borderColor: 'rgba(220, 53, 69, 1)',
                    backgroundColor: 'rgba(220, 53, 69, 0.3)',
                    borderWidth: 3,
                    tension: 0.4,
                    pointBackgroundColor: 'rgba(220, 53, 69, 1)',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 3,
                    pointRadius: 8,
                    pointHoverRadius: 12,
                    pointHoverBackgroundColor: 'rgba(220, 53, 69, 1)',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 4,
                    fill: false,
                    borderDash: [5, 5]
                },
                {
                    label: 'Net Revenue',
                    data: revenueValues,
                    borderColor: currentRevenue >= 0 ? 'rgba(0, 123, 255, 1)' : 'rgba(255, 99, 132, 1)',
                    backgroundColor: currentRevenue >= 0 ? 'rgba(0, 123, 255, 0.3)' : 'rgba(255, 99, 132, 0.3)',
                    borderWidth: 4,
                    tension: 0.4,
                    pointBackgroundColor: currentRevenue >= 0 ? 'rgba(0, 123, 255, 1)' : 'rgba(255, 99, 132, 1)',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 3,
                    pointRadius: 10,
                    pointHoverRadius: 14,
                    pointHoverBackgroundColor: currentRevenue >= 0 ? 'rgba(0, 123, 255, 1)' : 'rgba(255, 99, 132, 1)',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 4,
                    fill: false
                }
            ]
        };
        
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: false // We're using custom legend
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#333',
                    bodyColor: '#666',
                    borderColor: 'rgba(0, 0, 0, 0.1)',
                    borderWidth: 1,
                    cornerRadius: 12,
                    displayColors: true,
                    usePointStyle: true,
                    padding: 12,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        title: function(context) {
                            return `Current Data: ${context[0].label}`;
                        },
                        label: function(context) {
                            const value = context.parsed.y;
                            const label = context.dataset.label;
                            return `${label}: $${value.toLocaleString()}`;
                        },
                        afterLabel: function(context) {
                            if (context.datasetIndex === 2) { // Revenue
                                const salesValue = chartData.datasets[0].data[context.dataIndex];
                                if (salesValue > 0) {
                                    const margin = ((context.parsed.y / salesValue) * 100).toFixed(1);
                                    return `Profit Margin: ${margin}%`;
                                }
                            }
                            return null;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)',
                        lineWidth: 1
                    },
                    ticks: {
                        color: '#666',
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)',
                        lineWidth: 1
                    },
                    ticks: {
                        color: '#666',
                        font: {
                            size: 11
                        },
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            },
            elements: {
                line: {
                    tension: 0.4
                },
                point: {
                    hoverRadius: 12
                }
            }
        };
        
        // Destroy existing chart if it exists
        if (salesChart) {
            salesChart.destroy();
        }
        
        // Create new chart with a slight delay for smooth transition
        setTimeout(() => {
            salesChart = new Chart(ctx, {
                type: 'bar', // Use bar chart for single data points
                data: chartData,
                options: chartOptions
            });
            
            // Hide loading
            document.getElementById('chart-loading').classList.add('d-none');
        }, 300);
    }
    
    // Update chart type (line or bar) 
    function updateSalesChartType(chartType) {
        if (salesChart) {
            salesChart.config.type = chartType;
            
            // Adjust styling for different chart types
            if (chartType === 'bar') {
                // For bar chart, increase background opacity
                salesChart.data.datasets.forEach(dataset => {
                    dataset.backgroundColor = dataset.backgroundColor.replace('0.3', '0.7');
                });
            } else {
                // For line chart, reduce background opacity  
                salesChart.data.datasets.forEach(dataset => {
                    dataset.backgroundColor = dataset.backgroundColor.replace('0.7', '0.3');
                });
            }
            
            salesChart.update();
        }
    }
    
    // Update category chart
    function updateCategoryChart(categoryData) {
        const ctx = document.getElementById('categoryChart').getContext('2d');
        
        const chartData = {
            labels: categoryData.map(item => item.category_name),
            datasets: [{
                data: categoryData.map(item => item.sales),
                backgroundColor: [
                    'rgba(52, 152, 219, 0.7)',
                    'rgba(46, 204, 113, 0.7)',
                    'rgba(155, 89, 182, 0.7)',
                    'rgba(230, 126, 34, 0.7)',
                    'rgba(231, 76, 60, 0.7)',
                    'rgba(52, 73, 94, 0.7)',
                    'rgba(241, 196, 15, 0.7)'
                ],
                borderWidth: 1
            }]
        };
        
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        boxWidth: 15
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            return label + ': $' + value.toFixed(2);
                        }
                    }
                }
            }
        };
        
        // Destroy existing chart if it exists
        if (categoryChart) {
            categoryChart.destroy();
        }
        
        // Create new chart
        categoryChart = new Chart(ctx, {
            type: 'doughnut',
            data: chartData,
            options: chartOptions
        });
    }
    
    // Update order status chart
    function updateOrderStatusChart(statusData) {
        const ctx = document.getElementById('orderStatusChart').getContext('2d');
        
        // Show loading
        document.getElementById('status-chart-loading').classList.remove('d-none');
        
        // Define status colors and icons
        const statusConfig = {
            'pending': { color: 'rgba(255, 193, 7, 0.8)', icon: 'fas fa-clock' },
            'processing': { color: 'rgba(23, 162, 184, 0.8)', icon: 'fas fa-cog' },
            'shipped': { color: 'rgba(32, 201, 151, 0.8)', icon: 'fas fa-shipping-fast' },
            'delivered': { color: 'rgba(40, 167, 69, 0.8)', icon: 'fas fa-check-circle' },
            'cancelled': { color: 'rgba(220, 53, 69, 0.8)', icon: 'fas fa-times-circle' },
            'returned': { color: 'rgba(108, 117, 125, 0.8)', icon: 'fas fa-undo' },
            'partial_return': { color: 'rgba(253, 126, 20, 0.8)', icon: 'fas fa-exclamation-triangle' },
            'partially_returned': { color: 'rgba(253, 126, 20, 0.8)', icon: 'fas fa-exclamation-triangle' }
        };
        
        const chartData = {
            labels: statusData.map(item => item.status.charAt(0).toUpperCase() + item.status.slice(1).replace('_', ' ')),
            datasets: [{
                data: statusData.map(item => item.count),
                backgroundColor: statusData.map(item => {
                    const config = statusConfig[item.status] || statusConfig['pending'];
                    return config.color;
                }),
                borderColor: statusData.map(item => {
                    const config = statusConfig[item.status] || statusConfig['pending'];
                    return config.color.replace('0.8', '1');
                }),
                borderWidth: 2,
                hoverBorderWidth: 3,
                hoverBorderColor: '#ffffff'
            }]
        };
        
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12,
                        padding: 15,
                        font: {
                            size: 11
                        },
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#333',
                    bodyColor: '#666',
                    borderColor: 'rgba(0, 0, 0, 0.1)',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: true,
                    usePointStyle: true,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0';
                            return `${label}: ${value} orders (${percentage}%)`;
                        }
                    }
                },
                datalabels: false
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        };
        
        // Destroy existing chart if it exists
        if (orderStatusChart) {
            orderStatusChart.destroy();
        }
        
        // Create new chart with a slight delay for smooth transition
        setTimeout(() => {
            orderStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: chartData,
                options: chartOptions
            });
            
            // Hide loading
            document.getElementById('status-chart-loading').classList.add('d-none');
            
            // Update last updated timestamp
            document.getElementById('status-last-updated').textContent = new Date().toLocaleString();
        }, 300);
    }
    
    // Load products with filters
    function loadProductsWithFilters() {
        const dateFrom = document.getElementById('products-date-from').value;
        const dateTo = document.getElementById('products-date-to').value;
        
        // Show loading
        const tbody = document.getElementById('top-products-table');
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Loading filtered data...</span>
                </td>
            </tr>
        `;
        
        let url = `/mb-admin/api/products-performance/?period=${currentPeriod}`;
        if (dateFrom) url += `&date_from=${dateFrom}`;
        if (dateTo) url += `&date_to=${dateTo}`;
        
        fetch(url, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            productsAllData = data.products || [];
            sortAndFilterProducts();
        })
        .catch(error => {
            console.error('Error loading products:', error);
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Failed to load product data</td></tr>';
            document.getElementById('products-summary').textContent = 'Error loading data';
        });
    }
    
    // Sort and filter products based on current settings
    function sortAndFilterProducts() {
        const searchTerm = document.getElementById('products-search').value.toLowerCase().trim();
        
        // Filter by search term
        productsFilteredData = productsAllData.filter(product => {
            return product.product_name.toLowerCase().includes(searchTerm);
        });
        
        // Sort the data
        productsFilteredData.sort((a, b) => {
            let aVal, bVal;
            
            switch(productsSortBy) {
                case 'name':
                    aVal = a.product_name.toLowerCase();
                    bVal = b.product_name.toLowerCase();
                    return productsSortOrder === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                case 'orders':
                    aVal = a.orders || 0;
                    bVal = b.orders || 0;
                    break;
                case 'delivered':
                    aVal = a.delivered_quantity || 0;
                    bVal = b.delivered_quantity || 0;
                    break;
                case 'revenue':
                    aVal = a.revenue || 0;
                    bVal = b.revenue || 0;
                    break;
                default:
                    aVal = a.orders || 0;
                    bVal = b.orders || 0;
            }
            
            return productsSortOrder === 'asc' ? aVal - bVal : bVal - aVal;
        });
        
        updateProductsTable();
        updateProductsPagination();
        updateProductsSummary();
        updateSortIcons();
    }
    
    // Update products table with current page data
    function updateProductsTable() {
        const tbody = document.getElementById('top-products-table');
        
        if (productsFilteredData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">No products found</td></tr>';
            return;
        }
        
        const startIndex = (productsCurrentPage - 1) * productsPerPage;
        const endIndex = startIndex + productsPerPage;
        const pageData = productsFilteredData.slice(startIndex, endIndex);
        
        tbody.innerHTML = '';
        
        pageData.forEach((product, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <div class="me-2">
                            <img src="${product.image_url || '/media/default.webp'}" 
                                 alt="${product.product_name}" 
                                 class="product-thumbnail rounded"
                                 style="width: 40px; height: 40px; object-fit: cover; border: 1px solid #dee2e6;"
                                 onerror="this.src='/media/default.webp'">
                        </div>
                        <div>
                            <div class="fw-medium">
                                <a href="#" class="text-decoration-none product-name-link" 
                                   data-product-id="${product.id}" 
                                   data-product-name="${product.product_name}">
                                    ${product.product_name}
                                </a>
                            </div>
                            ${product.category ? `<small class="text-muted">${product.category}</small>` : ''}
                        </div>
                    </div>
                </td>
                <td class="text-center">
                    <span class="badge bg-info">${product.orders || 0}</span>
                </td>
                <td class="text-center">
                    <span class="badge bg-success">${product.delivered_quantity || 0}</span>
                </td>
                <td class="text-end">
                    <strong class="text-primary">$${(product.revenue || 0).toFixed(2)}</strong>
                    ${product.orders > 0 ? `<br><small class="text-muted">$${(product.revenue / product.orders).toFixed(2)}/order</small>` : ''}
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Add click event listeners to product names
        tbody.querySelectorAll('.product-name-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const productId = this.dataset.productId;
                const productName = this.dataset.productName;
                showProductDetailsModal(productId, productName);
            });
        });
    }
    
    // Show product details modal
    function showProductDetailsModal(productId, productName) {
        const modal = new bootstrap.Modal(document.getElementById('productDetailsModal'));
        const modalTitle = document.getElementById('productDetailsModalLabel');
        const modalContent = document.getElementById('productDetailsContent');
        
        modalTitle.innerHTML = `<i class="fas fa-box me-2"></i>${productName}`;
        modalContent.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading product details...</p>
            </div>
        `;
        
        modal.show();
        
        // Load product details
        loadProductDetails(productId);
    }
    
    // Load product details from API
    function loadProductDetails(productId) {
        fetch(`/mb-admin/api/products/${productId}/`, {
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            displayProductDetails(data);
        })
        .catch(error => {
            console.error('Error loading product details:', error);
            document.getElementById('productDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed to load product details. Please try again.
                </div>
            `;
        });
    }
    
    // Display product details in modal
    function displayProductDetails(product) {
        const modalContent = document.getElementById('productDetailsContent');
        
        let variantsHtml = '';
        if (product.variants && product.variants.length > 0) {
            variantsHtml = `
                <div class="row">
                    <div class="col-12">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-layer-group me-2"></i>Product Variants (${product.variants.length})
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead class="table-light">
                                    <tr>
                                        <th>Image</th>
                                        <th>Variant</th>
                                        <th>Price</th>
                                        <th>Cost Price</th>
                                        <th>Stock</th>
                                        <th>Sales Count</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${product.variants.map(variant => `
                                        <tr>
                                            <td>
                                                <img src="${variant.image_url || product.image_url || '/media/default.webp'}" 
                                                     alt="${variant.name || 'Variant'}" 
                                                     class="rounded"
                                                     style="width: 30px; height: 30px; object-fit: cover;"
                                                     onerror="this.src='/media/default.webp'">
                                            </td>
                                            <td>
                                                <strong>${variant.name || 'Default'}</strong>
                                                ${variant.size ? `<br><small class="text-muted">Size: ${variant.size}</small>` : ''}
                                                ${variant.color ? `<br><small class="text-muted">Color: ${variant.color}</small>` : ''}
                                            </td>
                                            <td>
                                                <span class="text-success fw-bold">$${parseFloat(variant.price || 0).toFixed(2)}</span>
                                            </td>
                                            <td>
                                                <span class="text-warning">$${parseFloat(variant.cost_price || 0).toFixed(2)}</span>
                                            </td>
                                            <td>
                                                <span class="badge ${variant.stock_quantity > 10 ? 'bg-success' : variant.stock_quantity > 0 ? 'bg-warning' : 'bg-danger'}">
                                                    ${variant.stock_quantity || 0}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">
                                                    ${variant.sales_count || 0} sold
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge ${variant.is_active ? 'bg-success' : 'bg-secondary'}">
                                                    ${variant.is_active ? 'Active' : 'Inactive'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        } else {
            variantsHtml = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    This product has no variants configured.
                </div>
            `;
        }
        
        modalContent.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <div class="position-relative">
                        <img src="${getProductMainImage(product)}" 
                             alt="${product.name}" 
                             class="img-fluid rounded border product-main-image"
                             style="max-height: 250px; object-fit: cover; width: 100%; cursor: pointer;"
                             onerror="handleImageError(this, '${product}')"
                             onclick="showImageFullScreen(this.src)">
                        <div class="position-absolute top-0 end-0 p-2">
                            <span class="badge bg-primary">Main Image</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <h5 class="text-primary">${product.name}</h5>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-sm-6">
                            <label class="form-label text-muted">Category</label>
                            <div class="fw-medium">${product.category_name || 'Uncategorized'}</div>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label text-muted">Status</label>
                            <div>
                                <span class="badge ${product.is_active ? 'bg-success' : 'bg-secondary'}">
                                    ${product.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label text-muted">Base Price</label>
                            <div class="fw-bold text-success">$${parseFloat(product.price || 0).toFixed(2)}</div>
                        </div>
                        <div class="col-sm-6">
                            <label class="form-label text-muted">Cost Price</label>
                            <div class="fw-bold text-warning">$${parseFloat(product.cost_price || 0).toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <hr class="my-4">
            
            ${variantsHtml}
        `;
        
        // Show edit button
        document.getElementById('editProductBtn').style.display = 'inline-block';
        document.getElementById('editProductBtn').onclick = function() {
            window.open(`/mb-admin/products/?edit=${product.id}`, '_blank');
        };
    }
    
    // Helper function to get the best available product image
    function getProductMainImage(product) {
        // Priority order for image selection:
        // 1. Product main image_url
        // 2. First variant image if available
        // 3. Default fallback image
        
        if (product.image_url && product.image_url !== 'null' && product.image_url !== null) {
            return product.image_url;
        }
        
        // Try to get first variant image
        if (product.variants && product.variants.length > 0) {
            for (let variant of product.variants) {
                if (variant.image_url && variant.image_url !== 'null' && variant.image_url !== null) {
                    return variant.image_url;
                }
            }
        }
        
        return '/media/default.webp';
    }
    
    // Handle image loading errors with multiple fallbacks
    function handleImageError(imgElement, productData) {
        const product = typeof productData === 'string' ? JSON.parse(productData) : productData;
        
        // If already showing default, don't try again
        if (imgElement.src.includes('default.webp')) {
            return;
        }
        
        // Try variant images as fallback
        if (product.variants && product.variants.length > 0) {
            for (let variant of product.variants) {
                if (variant.image_url && variant.image_url !== 'null' && 
                    variant.image_url !== null && !imgElement.src.includes(variant.image_url)) {
                    imgElement.src = variant.image_url;
                    return;
                }
            }
        }
        
        // Final fallback to default
        imgElement.src = '/media/default.webp';
    }
    
    // Show image in full screen (optional enhancement)
    function showImageFullScreen(imageSrc) {
        if (imageSrc.includes('default.webp')) return; // Don't show default image in fullscreen
        
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content bg-transparent border-0">
                    <div class="modal-body text-center p-0">
                        <img src="${imageSrc}" class="img-fluid rounded" style="max-height: 80vh;">
                        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" 
                                data-bs-dismiss="modal" aria-label="Close" style="filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));"></button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Remove modal from DOM when hidden
        modal.addEventListener('hidden.bs.modal', function() {
            document.body.removeChild(modal);
        });
    }
    
    // Update pagination
    function updateProductsPagination() {
        const totalPages = Math.ceil(productsFilteredData.length / productsPerPage);
        const pagination = document.getElementById('products-pagination');
        
        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }
        
        let paginationHTML = '';
        
        // Previous button
        paginationHTML += `
            <li class="page-item ${productsCurrentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${productsCurrentPage - 1}">Previous</a>
            </li>
        `;
        
        // Page numbers
        const startPage = Math.max(1, productsCurrentPage - 2);
        const endPage = Math.min(totalPages, productsCurrentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <li class="page-item ${i === productsCurrentPage ? 'active' : ''}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                </li>
            `;
        }
        
        // Next button
        paginationHTML += `
            <li class="page-item ${productsCurrentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${productsCurrentPage + 1}">Next</a>
            </li>
        `;
        
        pagination.innerHTML = paginationHTML;
        
        // Add event listeners to pagination links
        pagination.querySelectorAll('.page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                if (!this.closest('.page-item').classList.contains('disabled') && 
                    !this.closest('.page-item').classList.contains('active')) {
                    productsCurrentPage = parseInt(this.dataset.page);
                    updateProductsTable();
                    updateProductsPagination();
                }
            });
        });
    }
    
    // Update products summary
    function updateProductsSummary() {
        const totalProducts = productsFilteredData.length;
        const totalRevenue = productsFilteredData.reduce((sum, product) => sum + (product.revenue || 0), 0);
        const totalOrders = productsFilteredData.reduce((sum, product) => sum + (product.orders || 0), 0);
        const totalDelivered = productsFilteredData.reduce((sum, product) => sum + (product.delivered_quantity || 0), 0);
        
        const searchTerm = document.getElementById('products-search').value.trim();
        const hasFilters = searchTerm || 
                          document.getElementById('products-date-from').value || 
                          document.getElementById('products-date-to').value;
        
        let summaryText = `${totalProducts} products`;
        if (hasFilters) summaryText += ' (filtered)';
        summaryText += `  ${totalOrders} orders  ${totalDelivered} delivered  $${totalRevenue.toFixed(2)} revenue`;
        
        document.getElementById('products-summary').textContent = summaryText;
    }
    
    // Update sort icons in table headers
    function updateSortIcons() {
        document.querySelectorAll('th[data-sort] i').forEach(icon => {
            icon.className = 'fas fa-sort text-muted ms-1';
        });
        
        const activeHeader = document.querySelector(`th[data-sort="${productsSortBy}"] i`);
        if (activeHeader) {
            activeHeader.className = `fas fa-sort-${productsSortOrder === 'asc' ? 'up' : 'down'} text-primary ms-1`;
        }
    }
    
    // Export products data
    function exportProductsData() {
        const dateFrom = document.getElementById('products-date-from').value;
        const dateTo = document.getElementById('products-date-to').value;
        const searchTerm = document.getElementById('products-search').value;
        
        let url = `/mb-admin/api/export-products/?period=${currentPeriod}&sort=${productsSortBy}&order=${productsSortOrder}`;
        if (dateFrom) url += `&date_from=${dateFrom}`;
        if (dateTo) url += `&date_to=${dateTo}`;
        if (searchTerm) url += `&search=${encodeURIComponent(searchTerm)}`;
        
        // Create a temporary link to download
        const link = document.createElement('a');
        link.href = url;
        link.download = 'products_performance.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert('Products export started...', 'info');
    }
    
    // Legacy function for backward compatibility - now loads with filters
    function updateTopProductsTable(productsData) {
        // Store the data and apply current filters
        productsAllData = productsData || [];
        sortAndFilterProducts();
    }
    
    // Update order status table
    // Update order status table with enhanced styling and summary cards
    function updateOrderStatusTable(statusData) {
        const tbody = document.getElementById('order-status-table');
        const summaryContainer = document.getElementById('status-summary-cards');
        
        tbody.innerHTML = '';
        summaryContainer.innerHTML = '';
        
        if (statusData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">No status data available</td></tr>';
            summaryContainer.innerHTML = `
                <div class="col-12">
                    <div class="text-center py-3 text-muted">
                        <i class="fas fa-info-circle me-2"></i>No order status data available
                    </div>
                </div>
            `;
            return;
        }
        
        // Calculate total
        const totalOrders = statusData.reduce((sum, item) => sum + item.count, 0);
        
        // Status configuration for icons and colors
        const statusConfig = {
            'pending': { icon: 'fas fa-clock', class: 'pending', label: 'Pending' },
            'processing': { icon: 'fas fa-cog fa-spin', class: 'processing', label: 'Processing' },
            'shipped': { icon: 'fas fa-shipping-fast', class: 'shipped', label: 'Shipped' },
            'delivered': { icon: 'fas fa-check-circle', class: 'delivered', label: 'Delivered' },
            'cancelled': { icon: 'fas fa-times-circle', class: 'cancelled', label: 'Cancelled' },
            'returned': { icon: 'fas fa-undo', class: 'returned', label: 'Returned' },
            'partial_return': { icon: 'fas fa-exclamation-triangle', class: 'partial_return', label: 'Partial Return' },
            'partially_returned': { icon: 'fas fa-exclamation-triangle', class: 'partial_return', label: 'Partially Returned' }
        };
        
        // Create summary cards for top statuses
        const topStatuses = statusData.slice(0, 3); // Show top 3 statuses
        topStatuses.forEach(status => {
            const config = statusConfig[status.status] || statusConfig['pending'];
            const percentage = totalOrders > 0 ? ((status.count / totalOrders) * 100).toFixed(1) : 0;
            
            const cardDiv = document.createElement('div');
            cardDiv.className = 'col-12 mb-2';
            cardDiv.innerHTML = `
                <div class="status-summary-card ${config.class}" data-status="${status.status}">
                    <div class="status-icon ${config.class}">
                        <i class="${config.icon}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold text-dark" style="font-size: 0.9rem;">${config.label}</div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">${status.count} orders</small>
                            <span class="badge bg-secondary">${percentage}%</span>
                        </div>
                    </div>
                </div>
            `;
            summaryContainer.appendChild(cardDiv);
        });
        
        // Add total summary if there are more than 3 statuses
        if (statusData.length > 3) {
            const otherCount = statusData.slice(3).reduce((sum, item) => sum + item.count, 0);
            if (otherCount > 0) {
                const otherPercentage = ((otherCount / totalOrders) * 100).toFixed(1);
                const cardDiv = document.createElement('div');
                cardDiv.className = 'col-12 mb-2';
                cardDiv.innerHTML = `
                    <div class="status-summary-card" style="border-left: 4px solid #6c757d;">
                        <div class="status-icon" style="background: rgba(108, 117, 125, 0.2); color: #6c757d;">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-bold text-dark" style="font-size: 0.9rem;">Others</div>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">${otherCount} orders</small>
                                <span class="badge bg-secondary">${otherPercentage}%</span>
                            </div>
                        </div>
                    </div>
                `;
                summaryContainer.appendChild(cardDiv);
            }
        }
        
        // Populate detailed table
        statusData.forEach(status => {
            const config = statusConfig[status.status] || statusConfig['pending'];
            const percentage = totalOrders > 0 ? ((status.count / totalOrders) * 100).toFixed(1) : 0;
            
            const tr = document.createElement('tr');
            tr.className = 'table-row-hover';
            tr.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <i class="${config.icon} me-2 text-muted" style="width: 16px;"></i>
                        <span class="fw-medium">${config.label}</span>
                    </div>
                </td>
                <td class="text-center">
                    <span class="badge bg-light text-dark">${status.count}</span>
                </td>
                <td class="text-end">
                    <div class="d-flex align-items-center justify-content-end">
                        <div class="progress me-2" style="width: 50px; height: 8px;">
                            <div class="progress-bar bg-info" style="width: ${percentage}%"></div>
                        </div>
                        <small class="fw-bold text-info">${percentage}%</small>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Add total row
        if (statusData.length > 1) {
            const totalTr = document.createElement('tr');
            totalTr.className = 'table-info fw-bold';
            totalTr.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-calculator me-2"></i>
                        <span>Total Orders</span>
                    </div>
                </td>
                <td class="text-center">
                    <span class="badge bg-primary">${totalOrders}</span>
                </td>
                <td class="text-end">
                    <span class="fw-bold">100%</span>
                </td>
            `;
            tbody.appendChild(totalTr);
        }
        
        // Add click events to summary cards for filtering/highlighting
        summaryContainer.querySelectorAll('.status-summary-card').forEach(card => {
            card.addEventListener('click', function() {
                const statusName = this.dataset.status;
                highlightStatusInChart(statusName);
            });
        });
    }
    
    // Add helper functions for the enhanced order status features
    function updateOrderStatusChartType(chartType) {
        if (orderStatusChart) {
            orderStatusChart.config.type = chartType;
            
            // Adjust options based on chart type
            if (chartType === 'bar') {
                orderStatusChart.options.plugins.legend.position = 'top';
                orderStatusChart.options.scales = {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                };
            } else {
                orderStatusChart.options.plugins.legend.position = 'bottom';
                if (orderStatusChart.options.scales) {
                    delete orderStatusChart.options.scales;
                }
            }
            
            orderStatusChart.update();
        }
    }
    
    function highlightStatusInChart(statusName) {
        if (orderStatusChart && orderStatusChart.data.labels) {
            // Find the index of the status
            const statusIndex = orderStatusChart.data.labels.findIndex(label => 
                label.toLowerCase().replace(' ', '_') === statusName
            );
            
            if (statusIndex !== -1) {
                // Temporarily highlight the segment
                const originalColors = [...orderStatusChart.data.datasets[0].backgroundColor];
                const highlightColors = originalColors.map((color, index) => 
                    index === statusIndex ? color : color.replace('0.8', '0.3')
                );
                
                orderStatusChart.data.datasets[0].backgroundColor = highlightColors;
                orderStatusChart.update();
                
                // Restore original colors after 2 seconds
                setTimeout(() => {
                    orderStatusChart.data.datasets[0].backgroundColor = originalColors;
                    orderStatusChart.update();
                }, 2000);
            }
        }
    }
    
    function exportOrderStatusData() {
        if (!orderStatusChart || !orderStatusChart.data.labels) {
            showAlert('No status data available to export', 'warning');
            return;
        }
        
        const csvContent = "data:text/csv;charset=utf-8," + 
            "Status,Count,Percentage\n" +
            orderStatusChart.data.labels.map((label, index) => {
                const count = orderStatusChart.data.datasets[0].data[index];
                const total = orderStatusChart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0';
                return `${label},${count},${percentage}%`;
            }).join("\n");
            
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `order_status_breakdown_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert('Order status data exported successfully!', 'success');
    }
    
    // Update analytics metrics
    function updateAnalyticsMetrics(analytics) {
        // Default values if data is not available
        const retention = analytics.customer_retention_rate || 0;
        const conversion = analytics.conversion_rate || 0;
        const inventory = analytics.inventory_turnover || 0;
        
        // Update retention rate
        document.getElementById('retention-rate').textContent = `${retention}%`;
        document.getElementById('retention-progress').style.width = `${retention}%`;
        
        // Update conversion rate
        document.getElementById('conversion-rate').textContent = `${conversion}%`;
        document.getElementById('conversion-progress').style.width = `${conversion}%`;
        
        // Update inventory turnover
        document.getElementById('inventory-turnover').textContent = inventory.toFixed(1);
        document.getElementById('inventory-progress').style.width = `${Math.min(inventory * 10, 100)}%`;
    }
    
    // Update recommendations
    function updateRecommendations(recommendations) {
        const list = document.getElementById('recommendations-list');
        list.innerHTML = '';
        
        if (recommendations.length === 0) {
            list.innerHTML = '<div class="alert alert-info">No recommendations available at this time.</div>';
            return;
        }
        
        recommendations.forEach(recommendation => {
            const item = document.createElement('div');
            item.className = 'list-group-item';
            
            let iconClass = 'info';
            switch(recommendation.type) {
                case 'warning':
                    iconClass = 'warning text-warning';
                    break;
                case 'success':
                    iconClass = 'check-circle text-success';
                    break;
                case 'danger':
                    iconClass = 'exclamation-triangle text-danger';
                    break;
            }
            
            item.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${iconClass} me-3"></i>
                    <div>
                        <h6 class="mb-1">${recommendation.title}</h6>
                        <p class="mb-0 small">${recommendation.description}</p>
                    </div>
                </div>
            `;
            
            list.appendChild(item);
        });
    }
    
    // Download reports
    function downloadReport(reportType, period) {
        const url = `/mb-admin/api/reports/${reportType}/?period=${period}`;
        
        // Show a loading message
        showAlert(`Generating ${reportType} report...`, 'info');
        
        // Redirect to download URL
        window.location.href = url;
    }
    
    // Helper function to show alerts
    function showAlert(message, type) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Insert at the top of the content area
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                const bsAlert = bootstrap.Alert.getOrCreateInstance(alertDiv);
                bsAlert.close();
            }
        }, 5000);
    }
    
    // Helper function to get CSRF cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}
