{% extends 'dashboard/base.html' %}

{% block title %}Stock Management - MB Admin{% endblock %}

{% block page_title %}Stock Management{% endblock %}

{% block content %}
<!-- Stock Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card card-stats text-white">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-0" id="totalProducts">-</h5>
                    <p class="card-text">Total Products</p>
                </div>
                <div class="text-end">
                    <i class="fas fa-box fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white" style="background: linear-gradient(to right, var(--warning-color), #d97706);">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-0" id="lowStockProducts">-</h5>
                    <p class="card-text">Low Stock</p>
                </div>
                <div class="text-end">
                    <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white" style="background: linear-gradient(to right, var(--danger-color), #dc2626);">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-0" id="outOfStockProducts">-</h5>
                    <p class="card-text">Out of Stock</p>
                </div>
                <div class="text-end">
                    <i class="fas fa-times-circle fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white" style="background: linear-gradient(to right, var(--success-color), #059669);">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-0" id="totalStockValue">-</h5>
                    <p class="card-text">Stock Value</p>
                </div>
                <div class="text-end">
                    <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stock Management Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Stock Management</h5>
        <div>
            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#bulkStockModal">
                <i class="fas fa-layer-group me-1"></i> Bulk Adjust
            </button>
            <button class="btn btn-sm btn-warning" id="lowStockReportBtn">
                <i class="fas fa-exclamation-triangle me-1"></i> Low Stock Report
            </button>
            <button class="btn btn-sm btn-info" id="exportStockBtn">
                <i class="fas fa-download me-1"></i> Export CSV
            </button>
            <button class="btn btn-sm btn-outline-primary" id="toggleVariantView">
                <i class="fas fa-exchange-alt me-1"></i> Toggle Variant View
            </button>
            <button class="btn btn-sm btn-secondary" id="refreshStockBtn">
                <i class="fas fa-sync-alt me-1"></i> Refresh
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="mb-3">
            <div class="row g-2">
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" id="stockSearchInput" placeholder="Search by name or SKU...">
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="categoryFilter">
                        <option value="">All Categories</option>
                        <!-- Categories will be loaded dynamically -->
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="stockStatusFilter">
                        <option value="">All Status</option>
                        <option value="out_of_stock">Out of Stock</option>
                        <option value="low_stock">Low Stock</option>
                        <option value="in_stock">In Stock</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="activeFilter">
                        <option value="">All Products</option>
                        <option value="true">Active Only</option>
                        <option value="false">Inactive Only</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary btn-sm me-2" id="applyStockFiltersBtn">
                        <i class="fas fa-filter me-1"></i> Apply Filters
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" id="clearStockFiltersBtn">
                        <i class="fas fa-times me-1"></i> Clear
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Stock Table -->
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="stockTable">
                <thead>
                    <tr id="stockTableHeader">
                        <th>Product</th>
                        <th>SKU</th>
                        <th>Category</th>
                        <th>Current Stock</th>
                        <th>Low Stock Threshold</th>
                        <th>Stock Status</th>
                        <th>Stock Value</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="stockTableBody">
                    <!-- Stock data will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <!-- Loading indicator -->
        <div id="stockLoadingIndicator" class="text-center py-4" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading stock data...</p>
        </div>
        
        <!-- Empty state -->
        <div id="stockEmptyState" class="text-center py-4" style="display: none;">
            <i class="fas fa-box fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No products found</h5>
            <p class="text-muted">Try adjusting your search filters.</p>
        </div>
    </div>
</div>

<!-- Stock Adjustment Modal -->
<div class="modal fade" id="stockAdjustmentModal" tabindex="-1" aria-labelledby="stockAdjustmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="stockAdjustmentModalLabel">Adjust Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="stockAdjustmentForm">
                    <input type="hidden" id="adjustmentItemId">
                    <input type="hidden" id="adjustmentItemType"> <!-- 'product' or 'variant' -->
                    
                    <div class="mb-3">
                        <label class="form-label">Product:</label>
                        <p id="adjustmentProductName" class="fw-bold"></p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Current Stock:</label>
                        <p id="adjustmentCurrentStock" class="fw-bold"></p>
                    </div>
                    
                    <div class="mb-3">
                        <label for="adjustmentAction" class="form-label">Action</label>
                        <select class="form-select" id="adjustmentAction" required>
                            <option value="">Select Action</option>
                            <option value="increase">Increase Stock</option>
                            <option value="decrease">Decrease Stock</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="adjustmentQuantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="adjustmentQuantity" min="1" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="adjustmentReason" class="form-label">Reason</label>
                        <textarea class="form-control" id="adjustmentReason" rows="3" placeholder="Enter reason for stock adjustment..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveStockAdjustmentBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentView = 'products'; // 'products' or 'variants'
    let stockData = [];
    let variantData = [];
    let categories = [];
    
    // Initialize the page
    loadStockSummary();
    loadCategories();
    loadStockData();
    
    // Event listeners
    document.getElementById('refreshStockBtn').addEventListener('click', function() {
        loadStockSummary();
        loadStockData();
    });
    
    document.getElementById('toggleVariantView').addEventListener('click', toggleView);
    document.getElementById('applyStockFiltersBtn').addEventListener('click', applyFilters);
    document.getElementById('clearStockFiltersBtn').addEventListener('click', clearFilters);
    document.getElementById('saveStockAdjustmentBtn').addEventListener('click', saveStockAdjustment);
    document.getElementById('lowStockReportBtn').addEventListener('click', loadLowStockReport);
    document.getElementById('exportStockBtn').addEventListener('click', exportStockReport);
    
    // Search input with debounce
    let searchTimeout;
    document.getElementById('stockSearchInput').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            applyFilters();
        }, 500);
    });
    
    // CSRF token helper function
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function loadStockSummary() {
        fetch('/mb-admin/api/stock/stock_summary/')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('totalProducts').textContent = data.total_products;
                document.getElementById('lowStockProducts').textContent = data.low_stock_products;
                document.getElementById('outOfStockProducts').textContent = data.out_of_stock_products;
                document.getElementById('totalStockValue').textContent = '৳' + parseFloat(data.total_stock_value).toLocaleString();
            })
            .catch(error => {
                console.error('Failed to load stock summary:', error);
                // Show error in summary cards
                document.getElementById('totalProducts').textContent = 'Error';
                document.getElementById('lowStockProducts').textContent = 'Error';
                document.getElementById('outOfStockProducts').textContent = 'Error';
                document.getElementById('totalStockValue').textContent = 'Error';
            });
    }
    
    function loadCategories() {
        fetch('/mb-admin/api/categories/')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                categories = data.results || data;
                const categorySelect = document.getElementById('categoryFilter');
                categorySelect.innerHTML = '<option value="">All Categories</option>';
                categories.forEach(function(category) {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Failed to load categories:', error);
            });
    }
    
    function loadStockData() {
        showLoading();
        
        const endpoint = currentView === 'products' ? '/mb-admin/api/stock/' : '/mb-admin/api/stock-variants/';
        
        fetch(endpoint)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (currentView === 'products') {
                    stockData = data.results || data;
                    renderStockTable(stockData);
                } else {
                    variantData = data.results || data;
                    renderVariantTable(variantData);
                }
                hideLoading();
            })
            .catch(error => {
                console.error('Failed to load stock data:', error);
                hideLoading();
                showEmptyState();
            });
    }
    
    function toggleView() {
        currentView = currentView === 'products' ? 'variants' : 'products';
        
        const button = document.getElementById('toggleVariantView');
        if (currentView === 'variants') {
            button.innerHTML = '<i class="fas fa-box me-1"></i> Show Products';
            updateTableHeader('variants');
            if (variantData.length === 0) {
                loadStockData();
            } else {
                renderVariantTable(variantData);
            }
        } else {
            button.innerHTML = '<i class="fas fa-exchange-alt me-1"></i> Toggle Variant View';
            updateTableHeader('products');
            renderStockTable(stockData);
        }
    }
    
    function updateTableHeader(view) {
        const header = document.getElementById('stockTableHeader');
        if (view === 'variants') {
            header.innerHTML = `
                <th>Product</th>
                <th>Variant</th>
                <th>SKU</th>
                <th>Size/Color</th>
                <th>Current Stock</th>
                <th>Status</th>
                <th>Stock Value</th>
                <th>Actions</th>
            `;
        } else {
            header.innerHTML = `
                <th>Product</th>
                <th>SKU</th>
                <th>Category</th>
                <th>Current Stock</th>
                <th>Low Stock Threshold</th>
                <th>Stock Status</th>
                <th>Stock Value</th>
                <th>Actions</th>
            `;
        }
    }
    
    function renderStockTable(data) {
        const tbody = document.getElementById('stockTableBody');
        tbody.innerHTML = '';
        
        if (data.length === 0) {
            showEmptyState();
            return;
        }
        
        data.forEach(function(item) {
            const stockStatus = getStockStatusBadge(item.stock_status);
            const stockValue = item.stock_value ? '৳' + parseFloat(item.stock_value).toLocaleString() : '-';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div class="fw-bold">${item.name}</div>
                    ${item.variant_count > 0 ? `<small class="text-muted">${item.variant_count} variants</small>` : ''}
                </td>
                <td>${item.sku || '-'}</td>
                <td>${item.category_name || '-'}</td>
                <td>
                    <span class="fw-bold">${item.stock_quantity}</span>
                    ${item.variant_count > 0 ? `<br><small class="text-muted">Variants: ${item.total_variant_stock}</small>` : ''}
                </td>
                <td>${item.low_stock_threshold}</td>
                <td>${stockStatus}</td>
                <td>${stockValue}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="openStockAdjustment(${item.id}, 'product', '${item.name}', ${item.stock_quantity})">
                        <i class="fas fa-edit"></i> Adjust
                    </button>
                    ${item.variant_count > 0 ? `
                    <button class="btn btn-sm btn-outline-info" onclick="showProductVariants(${item.id})">
                        <i class="fas fa-list"></i> Variants
                    </button>
                    ` : ''}
                </td>
            `;
            tbody.appendChild(row);
        });
        
        hideEmptyState();
    }
    
    function renderVariantTable(data) {
        const tbody = document.getElementById('stockTableBody');
        tbody.innerHTML = '';
        
        if (data.length === 0) {
            showEmptyState();
            return;
        }
        
        data.forEach(function(item) {
            const stockStatus = getStockStatusBadge(item.stock_status);
            const stockValue = item.stock_value ? '৳' + parseFloat(item.stock_value).toLocaleString() : '-';
            const sizeColor = [item.size, item.color].filter(Boolean).join(' / ') || '-';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.product_name}</td>
                <td>${item.name}</td>
                <td>${item.sku || '-'}</td>
                <td>${sizeColor}</td>
                <td><span class="fw-bold">${item.stock_quantity}</span></td>
                <td>${stockStatus}</td>
                <td>${stockValue}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="openStockAdjustment(${item.id}, 'variant', '${item.product_name} - ${item.name}', ${item.stock_quantity})">
                        <i class="fas fa-edit"></i> Adjust
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        hideEmptyState();
    }
    
    function getStockStatusBadge(status) {
        switch (status) {
            case 'out_of_stock':
                return '<span class="badge bg-danger">Out of Stock</span>';
            case 'low_stock':
                return '<span class="badge bg-warning">Low Stock</span>';
            case 'in_stock':
                return '<span class="badge bg-success">In Stock</span>';
            case 'not_tracked':
                return '<span class="badge bg-secondary">Not Tracked</span>';
            default:
                return '<span class="badge bg-secondary">Unknown</span>';
        }
    }
    
    function applyFilters() {
        const search = document.getElementById('stockSearchInput').value;
        const category = document.getElementById('categoryFilter').value;
        const status = document.getElementById('stockStatusFilter').value;
        const active = document.getElementById('activeFilter').value;
        
        const params = new URLSearchParams();
        if (search) params.append('search', search);
        if (category) params.append('category', category);
        if (status === 'low_stock') params.append('low_stock', 'true');
        if (status === 'out_of_stock') params.append('out_of_stock', 'true');
        if (active) params.append('is_active', active);
        
        showLoading();
        
        const endpoint = currentView === 'products' ? '/mb-admin/api/stock/' : '/mb-admin/api/stock-variants/';
        const url = `${endpoint}?${params.toString()}`;
        
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (currentView === 'products') {
                    renderStockTable(data.results || data);
                } else {
                    renderVariantTable(data.results || data);
                }
                hideLoading();
            })
            .catch(error => {
                console.error('Failed to apply filters:', error);
                hideLoading();
            });
    }
    
    function clearFilters() {
        document.getElementById('stockSearchInput').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('stockStatusFilter').value = '';
        document.getElementById('activeFilter').value = '';
        applyFilters();
    }
    
    function openStockAdjustment(itemId, itemType, productName, currentStock) {
        document.getElementById('adjustmentItemId').value = itemId;
        document.getElementById('adjustmentItemType').value = itemType;
        document.getElementById('adjustmentProductName').textContent = productName;
        document.getElementById('adjustmentCurrentStock').textContent = currentStock;
        document.getElementById('adjustmentAction').value = '';
        document.getElementById('adjustmentQuantity').value = '';
        document.getElementById('adjustmentReason').value = '';
        
        const modal = new bootstrap.Modal(document.getElementById('stockAdjustmentModal'));
        modal.show();
    }
    
    function saveStockAdjustment() {
        const itemId = document.getElementById('adjustmentItemId').value;
        const itemType = document.getElementById('adjustmentItemType').value;
        const action = document.getElementById('adjustmentAction').value;
        const quantity = document.getElementById('adjustmentQuantity').value;
        const reason = document.getElementById('adjustmentReason').value;
        
        if (!action || !quantity) {
            alert('Please fill in all required fields.');
            return;
        }
        
        const endpoint = itemType === 'product' ? 
            `/mb-admin/api/stock/${itemId}/adjust_stock/` : 
            `/mb-admin/api/stock-variants/${itemId}/adjust_stock/`;
        
        const data = {
            action: action,
            quantity: parseInt(quantity),
            reason: reason
        };
        
        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(response => {
            if (response.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('stockAdjustmentModal'));
                modal.hide();
                loadStockSummary();
                loadStockData();
                
                // Show success message
                showSuccessMessage(`Stock ${action}d successfully. New stock: ${response.new_stock}`);
            } else {
                alert('Error: ' + (response.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Stock adjustment error:', error);
            alert('Error: ' + error.message);
        });
    }
    
    function loadLowStockReport() {
        fetch('/mb-admin/api/stock/low_stock_report/')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                let content = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>';
                content += `Found ${data.count} products with low stock.</div>`;
                
                if (data.count > 0) {
                    content += '<div class="table-responsive"><table class="table table-sm table-striped">';
                    content += '<thead><tr><th>Product</th><th>SKU</th><th>Current Stock</th><th>Threshold</th><th>Status</th></tr></thead><tbody>';
                    
                    data.products.forEach(function(product) {
                        const status = getStockStatusBadge(product.stock_status);
                        content += `<tr>
                            <td>${product.name}</td>
                            <td>${product.sku || '-'}</td>
                            <td>${product.stock_quantity}</td>
                            <td>${product.low_stock_threshold}</td>
                            <td>${status}</td>
                        </tr>`;
                    });
                    
                    content += '</tbody></table></div>';
                } else {
                    content += '<p class="text-center text-muted mt-3">No low stock products found.</p>';
                }
                
                // Create and show modal (simplified)
                alert(content.replace(/<[^>]*>/g, '')); // Strip HTML for alert
            })
            .catch(error => {
                console.error('Failed to load low stock report:', error);
                alert('Failed to load low stock report');
            });
    }
    
    function exportStockReport() {
        const currentFilters = new URLSearchParams();
        const search = document.getElementById('stockSearchInput').value;
        const category = document.getElementById('categoryFilter').value;
        const status = document.getElementById('stockStatusFilter').value;
        const active = document.getElementById('activeFilter').value;
        
        if (search) currentFilters.append('search', search);
        if (category) currentFilters.append('category', category);
        if (status === 'low_stock') currentFilters.append('low_stock', 'true');
        if (status === 'out_of_stock') currentFilters.append('out_of_stock', 'true');
        if (active) currentFilters.append('is_active', active);
        
        const url = `/mb-admin/api/stock/export_stock_report/?${currentFilters.toString()}`;
        window.open(url, '_blank');
    }
    
    function showLoading() {
        document.getElementById('stockLoadingIndicator').style.display = 'block';
        document.getElementById('stockTable').style.display = 'none';
        document.getElementById('stockEmptyState').style.display = 'none';
    }
    
    function hideLoading() {
        document.getElementById('stockLoadingIndicator').style.display = 'none';
        document.getElementById('stockTable').style.display = 'table';
    }
    
    function showEmptyState() {
        document.getElementById('stockEmptyState').style.display = 'block';
        document.getElementById('stockTable').style.display = 'none';
    }
    
    function hideEmptyState() {
        document.getElementById('stockEmptyState').style.display = 'none';
        document.getElementById('stockTable').style.display = 'table';
    }
    
    function showSuccessMessage(message) {
        // Simple alert for now - could be enhanced with toast notifications
        alert(message);
    }
    
    // Global function for showing product variants
    window.showProductVariants = function(productId) {
        if (currentView !== 'variants') {
            toggleView();
        }
        
        // Filter variants by product
        const params = new URLSearchParams();
        params.append('product', productId);
        
        showLoading();
        
        fetch(`/mb-admin/api/stock-variants/?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                renderVariantTable(data.results || data);
                hideLoading();
            })
            .catch(error => {
                console.error('Failed to load product variants:', error);
                hideLoading();
            });
    };
    
    // Make functions available globally for onclick handlers
    window.openStockAdjustment = openStockAdjustment;
});
</script>
{% endblock %}