{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Contact Management - Dashboard{% endblock %}

{% block extra_css %}
<style>
    .contact-status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
    }
    
    .status-new { 
        background-color: #dc3545; 
        color: white;
    }
    
    .status-read { 
        background-color: #ffc107; 
        color: #000;
    }
    
    .status-replied { 
        background-color: #198754; 
        color: white;
    }
    
    .status-resolved { 
        background-color: #6c757d; 
        color: white;
    }
    
    .status-spam { 
        background-color: #d63384; 
        color: white;
    }
    
    .priority-urgent { 
        background-color: #dc3545; 
        color: white;
    }
    
    .priority-high { 
        background-color: #fd7e14; 
        color: white;
    }
    
    .priority-medium { 
        background-color: #0dcaf0; 
        color: #000;
    }
    
    .priority-low { 
        background-color: #6c757d; 
        color: white;
    }
    
    .contact-table .table-row.urgent {
        border-left: 4px solid #dc3545;
    }
    
    .contact-table .table-row.unread {
        background-color: #f8f9fa;
        font-weight: 500;
    }
    
    .attachment-link {
        color: #0d6efd;
        text-decoration: none;
    }
    
    .attachment-link:hover {
        text-decoration: underline;
    }
    
    .contact-details-modal .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }
    
    .btn-action {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        margin-right: 0.25rem;
        margin-bottom: 0.25rem;
    }
    
    .filter-section {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
    }
    
    .stats-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
        margin-bottom: 1rem;
    }
    
    .stats-number {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .stats-label {
        color: #6c757d;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .contact-settings-form {
        background: white;
        padding: 2rem;
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h3 mb-0">Contact Management</h2>
            <p class="text-muted small mb-0">Manage customer inquiries and contact form submissions</p>
        </div>
        <div>
            <button class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#settingsModal">
                <i class="fas fa-cog"></i> Settings
            </button>
            <button class="btn btn-primary" onclick="refreshContacts()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number text-primary" id="total-contacts">0</div>
                <div class="stats-label">Total Contacts</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number text-danger" id="new-contacts">0</div>
                <div class="stats-label">New Messages</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number text-warning" id="pending-contacts">0</div>
                <div class="stats-label">Pending Reply</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number text-danger" id="urgent-contacts">0</div>
                <div class="stats-label">Urgent</div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-section">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select class="form-select" id="status-filter">
                    <option value="">All Status</option>
                    <option value="new">New</option>
                    <option value="read">Read</option>
                    <option value="replied">Replied</option>
                    <option value="resolved">Resolved</option>
                    <option value="spam">Spam</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Priority</label>
                <select class="form-select" id="priority-filter">
                    <option value="">All Priorities</option>
                    <option value="urgent">Urgent</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Search</label>
                <input type="text" class="form-control" id="search-input" placeholder="Search by name, email, phone...">
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button class="btn btn-outline-secondary" onclick="clearFilters()">Clear Filters</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Actions -->
    <div class="d-flex align-items-center mb-3">
        <div class="form-check me-3">
            <input class="form-check-input" type="checkbox" id="select-all">
            <label class="form-check-label" for="select-all">Select All</label>
        </div>
        <div class="btn-group me-3">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" id="bulk-actions-btn" disabled>
                Bulk Actions
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="bulkAction('mark_as_read')">Mark as Read</a></li>
                <li><a class="dropdown-item" href="#" onclick="bulkAction('mark_as_spam')">Mark as Spam</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="bulkAction('high')">Set High Priority</a></li>
                <li><a class="dropdown-item" href="#" onclick="bulkAction('medium')">Set Medium Priority</a></li>
                <li><a class="dropdown-item" href="#" onclick="bulkAction('low')">Set Low Priority</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="#" onclick="bulkAction('delete')">Delete Selected</a></li>
            </ul>
        </div>
        <span class="text-muted small" id="selected-count">0 selected</span>
    </div>

    <!-- Contacts Table -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 contact-table">
                    <thead class="table-light">
                        <tr>
                            <th width="50">
                                <input type="checkbox" id="header-checkbox">
                            </th>
                            <th>Contact</th>
                            <th>Subject</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Submitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="contacts-table-body">
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 mb-0">Loading contacts...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <nav aria-label="Contacts pagination" class="mt-4">
        <ul class="pagination justify-content-center" id="pagination">
        </ul>
    </nav>
</div>

<!-- Contact Details Modal -->
<div class="modal fade" id="contactDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content contact-details-modal">
            <div class="modal-header">
                <h5 class="modal-title">Contact Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="contact-details-content">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="save-contact-btn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Contact Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Contact Page Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="contact-settings-form" class="contact-settings-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Business Name</label>
                            <input type="text" class="form-control" name="business_name" id="business_name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-control" name="phone" id="phone">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" id="email">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Business Hours</label>
                            <input type="text" class="form-control" name="business_hours" id="business_hours" placeholder="Mon-Fri: 9AM-6PM">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" name="address" id="address" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Google Maps Embed URL</label>
                        <input type="url" class="form-control" name="map_embed_url" id="map_embed_url" placeholder="https://www.google.com/maps/embed?pb=...">
                        <div class="form-text">Get this from Google Maps > Share > Embed</div>
                    </div>
                    
                    <h6 class="mb-3">Social Media Links</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Facebook</label>
                            <input type="url" class="form-control" name="social_media_facebook" id="social_media_facebook">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Twitter</label>
                            <input type="url" class="form-control" name="social_media_twitter" id="social_media_twitter">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Instagram</label>
                            <input type="url" class="form-control" name="social_media_instagram" id="social_media_instagram">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">LinkedIn</label>
                            <input type="url" class="form-control" name="social_media_linkedin" id="social_media_linkedin">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Additional Information</label>
                        <textarea class="form-control" name="additional_info" id="additional_info" rows="3" placeholder="Any additional information to display on contact page"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveContactSettings()">Save Settings</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentFilters = {};
let contacts = [];
let selectedContacts = [];

document.addEventListener('DOMContentLoaded', function() {
    loadContacts();
    loadStats();
    loadContactSettings();
    setupEventListeners();
});

function setupEventListeners() {
    // Filter change events
    document.getElementById('status-filter').addEventListener('change', filterContacts);
    document.getElementById('priority-filter').addEventListener('change', filterContacts);
    
    // Search input with debounce
    let searchTimeout;
    document.getElementById('search-input').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(filterContacts, 300);
    });
    
    // Select all checkbox
    document.getElementById('select-all').addEventListener('change', function() {
        const isChecked = this.checked;
        const checkboxes = document.querySelectorAll('.contact-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        updateSelectedContacts();
    });
    
    // Header checkbox
    document.getElementById('header-checkbox').addEventListener('change', function() {
        const isChecked = this.checked;
        const checkboxes = document.querySelectorAll('.contact-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        updateSelectedContacts();
    });
}

function loadStats() {
    fetch('/contact/api/contacts/stats/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('total-contacts').textContent = data.total_contacts || 0;
            document.getElementById('new-contacts').textContent = data.new_contacts || 0;
            document.getElementById('pending-contacts').textContent = data.pending_contacts || 0;
            document.getElementById('urgent-contacts').textContent = data.urgent_contacts || 0;
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
}

function loadContacts(page = 1) {
    const params = new URLSearchParams({
        page: page,
        ...currentFilters
    });
    
    fetch(`/contact/api/contacts/?${params}`)
        .then(response => response.json())
        .then(data => {
            contacts = data.results || [];
            renderContactsTable(contacts);
            renderPagination(data);
        })
        .catch(error => {
            console.error('Error loading contacts:', error);
            document.getElementById('contacts-table-body').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4 text-danger">
                        Error loading contacts. Please try again.
                    </td>
                </tr>
            `;
        });
}

function renderContactsTable(contacts) {
    const tbody = document.getElementById('contacts-table-body');
    
    if (contacts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4">
                    <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                    <p class="mb-0">No contacts found</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = contacts.map(contact => {
        const submittedDate = new Date(contact.submitted_at).toLocaleDateString();
        const isUrgent = contact.is_urgent;
        const isUnread = contact.status === 'new';
        
        return `
            <tr class="table-row ${isUrgent ? 'urgent' : ''} ${isUnread ? 'unread' : ''}" data-contact-id="${contact.id}">
                <td>
                    <input type="checkbox" class="contact-checkbox" value="${contact.id}" onchange="updateSelectedContacts()">
                </td>
                <td>
                    <div>
                        <strong>${contact.name}</strong>
                        <br>
                        <small class="text-muted">${contact.email}</small>
                        <br>
                        <small class="text-muted">${contact.phone}</small>
                    </div>
                </td>
                <td>
                    <div>
                        ${contact.subject || 'No subject'}
                        ${contact.attachment_url ? '<i class="fas fa-paperclip text-primary ms-1" title="Has attachment"></i>' : ''}
                    </div>
                    <small class="text-muted">${contact.message.substring(0, 100)}${contact.message.length > 100 ? '...' : ''}</small>
                </td>
                <td>
                    <span class="badge contact-status-badge status-${contact.status}">
                        ${contact.status.charAt(0).toUpperCase() + contact.status.slice(1)}
                    </span>
                </td>
                <td>
                    <span class="badge contact-status-badge priority-${contact.priority}">
                        ${contact.priority.charAt(0).toUpperCase() + contact.priority.slice(1)}
                    </span>
                </td>
                <td>
                    <div>
                        ${submittedDate}
                        <br>
                        <small class="text-muted">${contact.days_since_submission} days ago</small>
                    </div>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary btn-action" onclick="viewContact(${contact.id})" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${contact.status === 'new' ? `
                        <button class="btn btn-sm btn-success btn-action" onclick="markAsRead(${contact.id})" title="Mark as Read">
                            <i class="fas fa-check"></i>
                        </button>
                    ` : ''}
                    <button class="btn btn-sm btn-info btn-action" onclick="markAsReplied(${contact.id})" title="Mark as Replied">
                        <i class="fas fa-reply"></i>
                    </button>
                    <div class="dropdown d-inline">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle btn-action" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="updatePriority(${contact.id}, 'urgent')">Set Urgent</a></li>
                            <li><a class="dropdown-item" href="#" onclick="updatePriority(${contact.id}, 'high')">Set High</a></li>
                            <li><a class="dropdown-item" href="#" onclick="updatePriority(${contact.id}, 'medium')">Set Medium</a></li>
                            <li><a class="dropdown-item" href="#" onclick="updatePriority(${contact.id}, 'low')">Set Low</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteContact(${contact.id})">Delete</a></li>
                        </ul>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function renderPagination(data) {
    const pagination = document.getElementById('pagination');
    if (!data.count || data.count <= 20) {
        pagination.innerHTML = '';
        return;
    }
    
    const totalPages = Math.ceil(data.count / 20);
    const currentPage = Math.ceil((data.count - data.results.length) / 20) + 1;
    
    let paginationHTML = '';
    
    // Previous button
    if (data.previous) {
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadContacts(${currentPage - 1})">Previous</a></li>`;
    }
    
    // Page numbers
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        paginationHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadContacts(${i})">${i}</a>
        </li>`;
    }
    
    // Next button
    if (data.next) {
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadContacts(${currentPage + 1})">Next</a></li>`;
    }
    
    pagination.innerHTML = paginationHTML;
}

function filterContacts() {
    currentFilters = {
        status: document.getElementById('status-filter').value,
        priority: document.getElementById('priority-filter').value,
        search: document.getElementById('search-input').value
    };
    
    // Remove empty filters
    Object.keys(currentFilters).forEach(key => {
        if (!currentFilters[key]) {
            delete currentFilters[key];
        }
    });
    
    loadContacts(1);
}

function clearFilters() {
    document.getElementById('status-filter').value = '';
    document.getElementById('priority-filter').value = '';
    document.getElementById('search-input').value = '';
    currentFilters = {};
    loadContacts(1);
}

function updateSelectedContacts() {
    const checkboxes = document.querySelectorAll('.contact-checkbox:checked');
    selectedContacts = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    document.getElementById('selected-count').textContent = `${selectedContacts.length} selected`;
    document.getElementById('bulk-actions-btn').disabled = selectedContacts.length === 0;
    
    // Update header checkbox state
    const allCheckboxes = document.querySelectorAll('.contact-checkbox');
    const headerCheckbox = document.getElementById('header-checkbox');
    
    if (selectedContacts.length === 0) {
        headerCheckbox.indeterminate = false;
        headerCheckbox.checked = false;
    } else if (selectedContacts.length === allCheckboxes.length) {
        headerCheckbox.indeterminate = false;
        headerCheckbox.checked = true;
    } else {
        headerCheckbox.indeterminate = true;
    }
}

function refreshContacts() {
    loadContacts(currentPage);
    loadStats();
}

function viewContact(contactId) {
    const contact = contacts.find(c => c.id === contactId);
    if (!contact) return;
    
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6>Contact Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Name:</strong></td><td>${contact.name}</td></tr>
                    <tr><td><strong>Email:</strong></td><td>${contact.email}</td></tr>
                    <tr><td><strong>Phone:</strong></td><td>${contact.phone}</td></tr>
                    <tr><td><strong>Subject:</strong></td><td>${contact.subject || 'No subject'}</td></tr>
                    <tr><td><strong>Status:</strong></td><td><span class="badge status-${contact.status}">${contact.status}</span></td></tr>
                    <tr><td><strong>Priority:</strong></td><td><span class="badge priority-${contact.priority}">${contact.priority}</span></td></tr>
                    <tr><td><strong>Submitted:</strong></td><td>${new Date(contact.submitted_at).toLocaleString()}</td></tr>
                    ${contact.replied_at ? `<tr><td><strong>Replied:</strong></td><td>${new Date(contact.replied_at).toLocaleString()}</td></tr>` : ''}
                </table>
            </div>
            <div class="col-md-6">
                <h6>Technical Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>IP Address:</strong></td><td>${contact.ip_address || 'N/A'}</td></tr>
                    <tr><td><strong>User Agent:</strong></td><td class="text-break small">${contact.user_agent || 'N/A'}</td></tr>
                    <tr><td><strong>Days Since:</strong></td><td>${contact.days_since_submission} days</td></tr>
                    <tr><td><strong>Urgent:</strong></td><td>${contact.is_urgent ? 'Yes' : 'No'}</td></tr>
                    ${contact.assigned_to_username ? `<tr><td><strong>Assigned To:</strong></td><td>${contact.assigned_to_username}</td></tr>` : ''}
                </table>
            </div>
        </div>
        
        <div class="mt-3">
            <h6>Message</h6>
            <div class="p-3 bg-light rounded">
                ${contact.message.replace(/\n/g, '<br>')}
            </div>
        </div>
        
        ${contact.attachment_url ? `
            <div class="mt-3">
                <h6>Attachment</h6>
                <a href="${contact.attachment_url}" class="attachment-link" target="_blank">
                    <i class="fas fa-paperclip"></i> ${contact.attachment_name || 'Download File'}
                </a>
            </div>
        ` : ''}
        
        <div class="mt-3">
            <h6>Admin Notes</h6>
            <textarea class="form-control" id="admin-notes" rows="3" placeholder="Add internal notes...">${contact.admin_notes || ''}</textarea>
        </div>
        
        <div class="mt-3">
            <h6>Quick Actions</h6>
            <button class="btn btn-success btn-sm me-2" onclick="markAsRead(${contact.id})">Mark as Read</button>
            <button class="btn btn-info btn-sm me-2" onclick="markAsReplied(${contact.id})">Mark as Replied</button>
            <button class="btn btn-warning btn-sm me-2" onclick="updatePriority(${contact.id}, 'urgent')">Set Urgent</button>
            <button class="btn btn-danger btn-sm" onclick="updateStatus(${contact.id}, 'spam')">Mark as Spam</button>
        </div>
    `;
    
    document.getElementById('contact-details-content').innerHTML = content;
    
    // Store current contact ID for saving
    document.getElementById('save-contact-btn').setAttribute('data-contact-id', contactId);
    
    new bootstrap.Modal(document.getElementById('contactDetailsModal')).show();
}

function markAsRead(contactId) {
    fetch(`/contact/api/contacts/${contactId}/mark_as_read/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Contact marked as read');
            refreshContacts();
        } else {
            showAlert('error', 'Failed to mark as read');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'An error occurred');
    });
}

function markAsReplied(contactId) {
    fetch(`/contact/api/contacts/${contactId}/mark_as_replied/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Contact marked as replied');
            refreshContacts();
        } else {
            showAlert('error', 'Failed to mark as replied');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'An error occurred');
    });
}

function updatePriority(contactId, priority) {
    fetch(`/contact/api/contacts/${contactId}/update_priority/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ priority: priority })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', `Priority updated to ${priority}`);
            refreshContacts();
        } else {
            showAlert('error', 'Failed to update priority');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'An error occurred');
    });
}

function updateStatus(contactId, status) {
    fetch(`/contact/api/contacts/${contactId}/`, {
        method: 'PATCH',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        showAlert('success', `Status updated to ${status}`);
        refreshContacts();
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'An error occurred');
    });
}

function deleteContact(contactId) {
    if (!confirm('Are you sure you want to delete this contact?')) return;
    
    fetch(`/contact/api/contacts/${contactId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        }
    })
    .then(response => {
        if (response.ok) {
            showAlert('success', 'Contact deleted');
            refreshContacts();
        } else {
            showAlert('error', 'Failed to delete contact');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'An error occurred');
    });
}

function bulkAction(action) {
    if (selectedContacts.length === 0) return;
    
    if (action === 'delete' && !confirm(`Are you sure you want to delete ${selectedContacts.length} contact(s)?`)) {
        return;
    }
    
    fetch('/contact/api/contacts/bulk_action/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            contact_ids: selectedContacts,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            selectedContacts = [];
            refreshContacts();
        } else {
            showAlert('error', data.error || 'Bulk action failed');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'An error occurred');
    });
}

function loadContactSettings() {
    fetch('/contact/api/contact-settings/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const settings = data.contact_settings;
                
                // Populate form
                document.getElementById('business_name').value = settings.business_name || '';
                document.getElementById('phone').value = settings.phone || '';
                document.getElementById('email').value = settings.email || '';
                document.getElementById('business_hours').value = settings.business_hours || '';
                document.getElementById('address').value = settings.address || '';
                document.getElementById('map_embed_url').value = settings.map_embed_url || '';
                document.getElementById('additional_info').value = settings.additional_info || '';
                
                // Social media
                const socialMedia = settings.social_media || {};
                document.getElementById('social_media_facebook').value = socialMedia.facebook || '';
                document.getElementById('social_media_twitter').value = socialMedia.twitter || '';
                document.getElementById('social_media_instagram').value = socialMedia.instagram || '';
                document.getElementById('social_media_linkedin').value = socialMedia.linkedin || '';
            }
        })
        .catch(error => {
            console.error('Error loading contact settings:', error);
        });
}

function saveContactSettings() {
    const formData = new FormData(document.getElementById('contact-settings-form'));
    const settings = {};
    
    // Basic fields
    settings.business_name = formData.get('business_name');
    settings.phone = formData.get('phone');
    settings.email = formData.get('email');
    settings.business_hours = formData.get('business_hours');
    settings.address = formData.get('address');
    settings.map_embed_url = formData.get('map_embed_url');
    settings.additional_info = formData.get('additional_info');
    
    // Social media
    settings.social_media = {
        facebook: formData.get('social_media_facebook'),
        twitter: formData.get('social_media_twitter'),
        instagram: formData.get('social_media_instagram'),
        linkedin: formData.get('social_media_linkedin')
    };
    
    fetch('/contact/api/contact-settings/update/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ contact_settings: settings })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Contact settings saved successfully');
            bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
        } else {
            showAlert('error', 'Failed to save settings');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'An error occurred');
    });
}

function showAlert(type, message) {
    // Implementation would depend on your alert system
    // For now, just use a simple alert
    if (type === 'success') {
        alert('Success: ' + message);
    } else {
        alert('Error: ' + message);
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}