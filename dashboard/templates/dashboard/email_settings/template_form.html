{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}{{ title }} - Dashboard{% endblock %}

{% block extra_css %}
{{ form.media.css }}
<style>
.copy-variable {
    padding: 2px 6px !important;
    border-radius: 3px !important;
    background-color: #f8f9fa !important;
    border: 1px solid #e9ecef !important;
    transition: all 0.2s ease !important;
}

.copy-variable:hover {
    background-color: #e9ecef !important;
    border-color: #007bff !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,123,255,0.2) !important;
}

.variable-category {
    margin-bottom: 1rem;
}

.variable-list {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}

#template-variables .small {
    font-size: 0.8rem !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{{ title }}</h1>
        <a href="{% url 'dashboard:email_template_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <!-- Basic Information -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.name.id_for_label }}">Template Name *</label>
                                    {{ form.name }}
                                    {% if form.name.errors %}
                                        <div class="invalid-feedback d-block">{{ form.name.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.template_type.id_for_label }}">Template Type *</label>
                                    {{ form.template_type }}
                                    {% if form.template_type.errors %}
                                        <div class="invalid-feedback d-block">{{ form.template_type.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="{{ form.subject.id_for_label }}">Email Subject *</label>
                            {{ form.subject }}
                            <small class="form-text text-muted">
                                You can use variables like: {{user_name}}, {{order_number}}, {{site_name}}
                            </small>
                            {% if form.subject.errors %}
                                <div class="invalid-feedback d-block">{{ form.subject.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Email Content -->
                        <fieldset>
                            <legend class="h5">Email Content</legend>
                            
                            <div class="form-group">
                                <label for="{{ form.html_content.id_for_label }}">HTML Content *</label>
                                {{ form.html_content }}
                                {% if form.html_content.help_text %}
                                    <small class="form-text text-muted">{{ form.html_content.help_text }}</small>
                                {% endif %}
                                {% if form.html_content.errors %}
                                    <div class="invalid-feedback d-block">{{ form.html_content.errors.0 }}</div>
                                {% endif %}
                            </div>

                            <div class="form-group">
                                <label for="{{ form.text_content.id_for_label }}">Plain Text Content (Optional)</label>
                                {{ form.text_content }}
                                <small class="form-text text-muted">
                                    If empty, plain text will be auto-generated from HTML content.
                                </small>
                                {% if form.text_content.errors %}
                                    <div class="invalid-feedback d-block">{{ form.text_content.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </fieldset>

                        <!-- Template Settings -->
                        <fieldset class="mt-4">
                            <legend class="h5">Template Settings</legend>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        {{ form.is_active }}
                                        <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                            <strong>Active Template</strong>
                                        </label>
                                        <small class="form-text text-muted">Enable this email template.</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        {{ form.send_to_user_email }}
                                        <label class="form-check-label" for="{{ form.send_to_user_email.id_for_label }}">
                                            Send to User Email
                                        </label>
                                        <small class="form-text text-muted">Send to logged-in user's email.</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        {{ form.send_to_checkout_email }}
                                        <label class="form-check-label" for="{{ form.send_to_checkout_email.id_for_label }}">
                                            Send to Checkout Email
                                        </label>
                                        <small class="form-text text-muted">Send to email from checkout form.</small>
                                    </div>
                                </div>
                            </div>
                        </fieldset>

                        <!-- Description -->
                        <fieldset class="mt-4">
                            <legend class="h5">Description</legend>
                            
                            <div class="form-group">
                                <label for="{{ form.description.id_for_label }}">Template Description (Optional)</label>
                                {{ form.description }}
                                <small class="form-text text-muted">
                                    Describe when and how this template is used.
                                </small>
                                {% if form.description.errors %}
                                    <div class="invalid-feedback d-block">{{ form.description.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </fieldset>

                        {% if form.non_field_errors %}
                            <div class="alert alert-danger mt-3">
                                {% for error in form.non_field_errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Template
                            </button>
                            <a href="{% url 'dashboard:email_template_list' %}" class="btn btn-secondary ml-2">
                                Cancel
                            </a>
                            {% if template %}
                                <a href="{% url 'dashboard:email_template_preview' template.pk %}" class="btn btn-info ml-2">
                                    <i class="fas fa-eye"></i> Preview
                                </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Available Variables</h6>
                </div>
                <div class="card-body">
                    <div id="template-variables">
                        <p class="text-muted">Select a template type to see available variables.</p>
                    </div>
                </div>
            </div>

            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Template Tips</h6>
                </div>
                <div class="card-body">
                    <ul class="text-sm">
                        <li>Use double curly braces for variables: <code>{{variable_name}}</code></li>
                        <li>HTML content supports full styling and images</li>
                        <li>Test your templates with the preview feature</li>
                        <li>Ensure both user and checkout email options are configured based on your needs</li>
                        <li>Keep subjects under 50 characters for better mobile display</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ form.media.js }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const templateTypeField = document.getElementById('{{ form.template_type.id_for_label }}');
    const variablesDiv = document.getElementById('template-variables');
    
    console.log('Template type field:', templateTypeField);
    console.log('Variables div:', variablesDiv);
    
    if (!templateTypeField || !variablesDiv) {
        console.error('Required elements not found');
        return;
    }
    
    const templateVariables = {
        'welcome': [
            // Actually used in template
            'user_name', 'site_name', 'site_url', 'current_year',
            // Additional available
            'user_email', 'user_full_name', 'current_date', 'current_time'
        ],
        'activation': [
            // Actually used in template
            'user_name', 'activation_url', 'site_name', 'site_url', 'current_year',
            // Additional available
            'user_email', 'user_full_name', 'activation_token', 'current_date', 'current_time'
        ],
        'password_reset': [
            // Actually used in template
            'user_name', 'user_email', 'reset_url', 'site_name', 'site_url', 'current_year',
            'current_date', 'current_time', 'expiry_date', 'expiry_time',
            // Additional available
            'user_full_name', 'reset_token'
        ],
        'order_confirmed': [
            // Actually used in template
            'user_name', 'order_number', 'order_total', 'site_name', 'site_url', 'current_year',
            'tax_amount', 'discount_amount',
            // Additional available from email service
            'user_email', 'user_full_name', 'order_subtotal', 'order_date', 'current_date', 'current_time', 
            'payment_method', 'shipping_cost', 'shipping_name', 'shipping_address', 'shipping_city',
            'shipping_state', 'shipping_zip', 'shipping_country', 'estimated_delivery', 'shipping_method', 
            'order_items'
        ],
        'order_shipped': [
            // Actually used in template
            'user_name', 'order_number', 'tracking_number', 'carrier', 'site_name', 'site_url', 
            'current_year', 'shipping_method', 'estimated_delivery', 'tracking_url',
            // Additional available
            'user_email', 'user_full_name', 'current_date', 'current_time', 'shipping_address'
        ],
        'order_delivered': [
            // Actually used in template
            'user_name', 'order_number', 'site_name', 'site_url', 'current_year', 'delivery_photo',
            // Additional available from email service
            'user_email', 'user_full_name', 'delivery_date', 'current_date', 'current_time',
            'delivery_location', 'received_by', 'signature_status', 'loyalty_points'
        ],
        'order_cancelled': [
            // Actually used in template
            'user_name', 'order_number', 'order_total', 'cancellation_reason', 'site_name', 'site_url', 'current_year',
            // Additional available from email service
            'user_email', 'user_full_name', 'order_date', 'cancellation_date', 'new_status',
            'current_date', 'current_time', 'refund_amount', 'payment_method', 'expected_refund_date'
        ],
        'newsletter': [
            // Common variables for newsletter
            'user_name', 'user_email', 'user_full_name', 'site_name', 'site_url', 
            'current_year', 'current_date', 'current_time'
        ],
        'custom': [
            // All commonly used variables for custom templates
            'user_name', 'user_email', 'user_full_name', 'site_name', 'site_url', 
            'current_year', 'current_date', 'current_time', 'order_number', 'order_total',
            'tracking_number', 'carrier', 'shipping_method', 'estimated_delivery', 'activation_url',
            'reset_url', 'cancellation_reason', 'tax_amount', 'discount_amount'
        ]
    };
    
    function updateVariables() {
        const selectedType = templateTypeField.value;
        const variables = templateVariables[selectedType] || [];
        
        console.log('Selected type:', selectedType);
        console.log('Variables:', variables);
        
        if (variables.length > 0) {
            // Categorize variables
            const userVars = variables.filter(v => v.includes('user_'));
            const siteVars = variables.filter(v => v.includes('site_') || v.includes('current_'));
            const orderVars = variables.filter(v => v.includes('order_') || v.includes('tracking_') || v.includes('carrier') || v.includes('shipping_') || v.includes('payment_') || v.includes('delivery_'));
            const actionVars = variables.filter(v => v.includes('activation_') || v.includes('reset_') || v.includes('cancellation_') || v.includes('refund_') || v.includes('expiry_'));
            const otherVars = variables.filter(v => !userVars.includes(v) && !siteVars.includes(v) && !orderVars.includes(v) && !actionVars.includes(v));
            
            let html = '<h6 class="mb-3">Available Variables:</h6>';
            
            if (userVars.length > 0) {
                html += '<div class="variable-category"><strong class="text-info">üë§ User Variables:</strong>';
                html += '<div class="variable-list mt-2">';
                userVars.forEach(variable => {
                    html += '<code class="text-primary small copy-variable">' + String.fromCharCode(123, 123) + variable + String.fromCharCode(125, 125) + '</code>';
                });
                html += '</div></div>';
            }
            
            if (siteVars.length > 0) {
                html += '<div class="variable-category"><strong class="text-success">üåê Site Variables:</strong>';
                html += '<div class="variable-list mt-2">';
                siteVars.forEach(variable => {
                    html += '<code class="text-primary small copy-variable">' + String.fromCharCode(123, 123) + variable + String.fromCharCode(125, 125) + '</code>';
                });
                html += '</div></div>';
            }
            
            if (orderVars.length > 0) {
                html += '<div class="variable-category"><strong class="text-warning">üì¶ Order Variables:</strong>';
                html += '<div class="variable-list mt-2">';
                orderVars.forEach(variable => {
                    html += '<code class="text-primary small copy-variable">' + String.fromCharCode(123, 123) + variable + String.fromCharCode(125, 125) + '</code>';
                });
                html += '</div></div>';
            }
            
            if (actionVars.length > 0) {
                html += '<div class="variable-category"><strong class="text-danger">üîê Action Variables:</strong>';
                html += '<div class="variable-list mt-2">';
                actionVars.forEach(variable => {
                    html += '<code class="text-primary small copy-variable">' + String.fromCharCode(123, 123) + variable + String.fromCharCode(125, 125) + '</code>';
                });
                html += '</div></div>';
            }
            
            if (otherVars.length > 0) {
                html += '<div class="variable-category"><strong class="text-secondary">üîß Other Variables:</strong>';
                html += '<div class="variable-list mt-2">';
                otherVars.forEach(variable => {
                    html += '<code class="text-primary small copy-variable">' + String.fromCharCode(123, 123) + variable + String.fromCharCode(125, 125) + '</code>';
                });
                html += '</div></div>';
            }
            
            html += '<small class="text-muted mt-2 d-block">Click any variable to copy it to clipboard. Use these in your email content and subject line.</small>';
            variablesDiv.innerHTML = html;
            
            // Add click to copy functionality
            variablesDiv.querySelectorAll('.copy-variable').forEach(code => {
                code.title = 'Click to copy variable';
                code.addEventListener('click', function() {
                    const variableText = this.textContent;
                    
                    // Try to copy to clipboard
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(variableText).then(() => {
                            showCopyFeedback(this, variableText);
                        }).catch(() => {
                            fallbackCopy(variableText, this);
                        });
                    } else {
                        fallbackCopy(variableText, this);
                    }
                });
            });
            
            function showCopyFeedback(element, originalText) {
                element.textContent = '‚úì Copied!';
                element.classList.remove('text-primary');
                element.classList.add('text-success');
                element.style.fontWeight = 'bold';
                
                setTimeout(() => {
                    element.textContent = originalText;
                    element.classList.remove('text-success');
                    element.classList.add('text-primary');
                    element.style.fontWeight = 'normal';
                }, 1500);
            }
            
            function fallbackCopy(text, element) {
                // Fallback method for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showCopyFeedback(element, text);
                } catch (err) {
                    console.error('Could not copy text: ', err);
                    element.textContent = 'Copy failed';
                    setTimeout(() => {
                        element.textContent = text;
                    }, 1000);
                }
                
                document.body.removeChild(textArea);
            }
        } else {
            // Show all available variables if no specific type is selected
            const allVariables = [
                // User variables
                'user_name', 'user_email', 'user_full_name',
                // Site variables
                'site_name', 'site_url', 'current_year', 'current_date', 'current_time',
                // Order variables
                'order_number', 'order_total', 'tracking_number', 'carrier', 'estimated_delivery', 
                'shipping_method', 'tracking_url', 'delivery_photo', 'discount_amount', 'tax_amount',
                // Action variables
                'activation_url', 'reset_url', 'cancellation_reason', 'expiry_date', 'expiry_time'
            ];
            
            let html = '<h6 class="mb-3">üìã Common Variables:</h6>';
            html += '<div class="variable-list">';
            allVariables.forEach(variable => {
                html += '<code class="text-primary small copy-variable">' + String.fromCharCode(123, 123) + variable + String.fromCharCode(125, 125) + '</code>';
            });
            html += '</div>';
            html += '<small class="text-muted mt-2 d-block">Select a template type above to see specific variables for that template.</small>';
            
            variablesDiv.innerHTML = html;
            
            // Add click to copy functionality for fallback variables too
            variablesDiv.querySelectorAll('.copy-variable').forEach(code => {
                code.title = 'Click to copy variable';
                code.addEventListener('click', function() {
                    const variableText = this.textContent;
                    
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(variableText).then(() => {
                            showCopyFeedback(this, variableText);
                        }).catch(() => {
                            fallbackCopy(variableText, this);
                        });
                    } else {
                        fallbackCopy(variableText, this);
                    }
                });
            });
        }
    }
    
    function showCopyFeedback(element, originalText) {
        element.textContent = '‚úì Copied!';
        element.classList.remove('text-primary');
        element.classList.add('text-success');
        element.style.fontWeight = 'bold';
        
        setTimeout(() => {
            element.textContent = originalText;
            element.classList.remove('text-success');
            element.classList.add('text-primary');
            element.style.fontWeight = 'normal';
        }, 1500);
    }
    
    function fallbackCopy(text, element) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        
        try {
            document.execCommand('copy');
            showCopyFeedback(element, text);
        } catch (err) {
            console.error('Could not copy text: ', err);
            element.textContent = 'Copy failed';
            setTimeout(() => {
                element.textContent = text;
            }, 1000);
        }
        
        document.body.removeChild(textArea);
    }
    
    templateTypeField.addEventListener('change', updateVariables);
    updateVariables(); // Initial call
});
</script>
{% endblock %}