{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Orders - MB Admin{% endblock %}

{% block page_title %}Orders Management{% endblock %}

{% block extra_css %}
<!-- SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<style>
    /* Order Details Modal Custom Styles */
    .modal-content {
        border-radius: var(--border-radius);
    }
    
    .modal-header {
        background-color: var(--secondary-color);
        color: var(--white);
        border-top-left-radius: var(--border-radius);
        border-top-right-radius: var(--border-radius);
    }
    
    .modal-header .btn-close-white:focus {
        box-shadow: none;
    }
    
    .card {
        transition: transform 0.2s;
        border-radius: var(--border-radius);
    }
    
    .card:hover {
        transform: translateY(-3px);
    }
    
    .badge {
        font-weight: 500;
        letter-spacing: 0.3px;
        padding: 0.5rem 0.75rem;
        border-radius: 4px;
    }
    
    /* Custom status badge colors */
    .bg-indigo {
        background-color: #6610f2;
    }
    
    .bg-orange {
        background-color: #fd7e14;
    }
    
    .bg-brown {
        background-color: #8B4513;
    }
    
    .bg-teal {
        background-color: #20c997;
    }
    
    /* Custom table styling */
    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    
    /* Order status badge sizes */
    #orderDetailStatus {
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
    }
    
    /* Card subtitles with icons */
    .card-subtitle {
        font-weight: 500;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.75rem;
        margin-bottom: 1rem;
    }
    
    .card-subtitle i {
        color: var(--primary-color);
    }
    
    /* Action buttons */
    .btn-outline-primary {
        color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .btn-outline-primary:hover {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }
    
    .btn-outline-secondary {
        border-color: var(--primary-color);
        color: var(--primary-color);
        opacity: 0.85;
    }
    
    .btn-outline-secondary:hover {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        opacity: 1;
    }
    
    /* Modal buttons */
    .modal .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .modal .btn-primary:hover {
        background-color: var(--primary-color-dark, var(--primary-color));
        border-color: var(--primary-color-dark, var(--primary-color));
        opacity: 0.9;
    }
    
    /* Copy functionality styles */
    .copy-text {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .copy-icon {
        cursor: pointer;
        color: var(--primary-color);
        opacity: 0.6;
        transition: all 0.2s;
    }
    
    .copy-icon:hover {
        opacity: 1;
        transform: scale(1.1);
    }
    
    .copy-success {
        animation: pulse 1s;
        color: var(--success-color, #28a745);
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    
    /* Courier Monitoring Status Indicator */
    .courier-monitor-status {
        font-size: 0.875rem;
    }
    
    .courier-monitor-indicator {
        position: relative;
    }
    
    .courier-monitor-indicator.active i {
        color: #28a745 !important;
        animation: pulse 2s infinite;
    }
    
    .courier-monitor-indicator.paused i {
        color: #ffc107 !important;
    }
    
    .courier-monitor-indicator.error i {
        color: #dc3545 !important;
    }
    
    .courier-monitor-text {
        font-weight: 500;
    }
    
    .courier-stats {
        background: rgba(0, 123, 255, 0.1);
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
    }
    
    .courier-monitor-controls .btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* Animate courier status updates */
    @keyframes courierUpdate {
        0% { background-color: transparent; }
        50% { background-color: rgba(40, 167, 69, 0.2); }
        100% { background-color: transparent; }
    }
    
    .courier-status-updated {
        animation: courierUpdate 1s ease-in-out;
    }
    
    /* Courier Sticker Styles */
    .courier-sticker {
        width: 288px; /* 2 inches at 144 DPI */
        height: 144px; /* 1 inch at 144 DPI */
        background: white;
        border: 2px solid #333;
        border-radius: 4px;
        display: flex;
        flex-direction: column;
        font-family: Arial, sans-serif;
        font-size: 8px;
        line-height: 1.1;
        overflow: hidden;
        padding: 4px;
    }
    
    .sticker-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 4px;
        height: 30px;
    }
    
    .logo-section {
        flex: 1;
    }
    
    .sticker-logo {
        max-width: 60px;
        max-height: 25px;
        object-fit: contain;
    }
    
    .logo-fallback {
        font-weight: bold;
        font-size: 12px;
        color: #333;
        background: #f0f0f0;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .barcode-section {
        text-align: right;
        flex: 1;
    }
    
    .barcode-canvas {
        max-width: 150px;
        height: 30px;
        border: 1px solid #ccc;
        display: block;
        margin-left: auto;
    }
    
    .courier-id-small {
        font-size: 6px;
        font-weight: bold;
        color: #333;
        text-align: right;
        margin-top: 2px;
    }
    
    .sticker-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 3px;
    }
    
    .customer-name {
        font-size: 14px;
        font-weight: bold;
        color: #333;
        line-height: 1.1;
    }
    
    .courier-id-main {
        font-size: 12px;
        font-weight: bold;
        color: #333;
    }
    
    .products-list {
        font-size: 10px;
        color: #555;
        line-height: 1.2;
        flex: 1;
    }
    
    .sticker-footer {
        margin-top: auto;
        padding-top: 2px;
        border-top: 1px solid #eee;
    }
    
    .contact-row {
        display: flex;
        justify-content: space-between;
        font-size: 6px;
        color: #666;
        line-height: 1.1;
    }
    
    .website, .phone {
        flex: 1;
    }
    
    .phone {
        text-align: right;
    }
    
    /* Print styles for courier sticker */
    @media print {
        .courier-sticker-print {
            width: 2in !important;
            height: 0.95in !important;
            margin: 0 !important;
            padding: 3px !important;
            border: 1px solid #000 !important;
            page-break-inside: avoid !important;
            display: flex !important;
            flex-direction: column !important;
            font-family: Arial, sans-serif !important;
            font-size: 8px !important;
            line-height: 1.0 !important;
        }
        
        .courier-sticker-print .sticker-header {
            display: flex !important;
            justify-content: space-between !important;
            align-items: flex-start !important;
            margin-bottom: 3px !important;
            height: 0.18in !important;
            min-height: 0.18in !important;
            flex-shrink: 0 !important;
        }
        
        .courier-sticker-print .sticker-content {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 1px !important;
            min-height: 0 !important;
            overflow: hidden !important;
        }
        
        .courier-sticker-print .sticker-footer {
            margin-top: auto !important;
            padding-top: 1px !important;
            border-top: 1px solid #000 !important;
            flex-shrink: 0 !important;
            min-height: 0.12in !important;
            max-height: 0.12in !important;
        }
        
        .courier-sticker-print .contact-row {
            display: flex !important;
            justify-content: space-between !important;
            font-size: 5px !important;
            color: #333 !important;
            line-height: 1.0 !important;
            white-space: nowrap !important;
            overflow: hidden !important;
        }
        
        .courier-sticker-print * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        body * {
            visibility: hidden;
        }
        
        .courier-sticker-print, .courier-sticker-print * {
            visibility: visible;
        }
        
        .courier-sticker-print {
            position: absolute;
            left: 0;
            top: 0;
        }
    }
    
    /* Fraud Check Progress Bar Styles */
    .fraud-check-container {
        position: relative;
        width: 120px;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .fraud-check-container:hover {
        transform: scale(1.05);
    }
    
    .fraud-progress-bar {
        height: 20px;
        border-radius: 10px;
        background-color: #e9ecef;
        position: relative;
        overflow: hidden;
        border: 1px solid #dee2e6;
    }
    
    .fraud-progress-fill {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: bold;
        color: white;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        position: relative;
        transition: width 0.3s ease;
    }
    
    .fraud-delivered-fill {
        background: #198754;
    }
    
    .fraud-cancelled-fill {
        background: linear-gradient(90deg, #dc3545, #e74c3c);
    }
    
    .fraud-count-label {
        font-size: 9px;
        color: #6c757d;
        margin-top: 2px;
        text-align: center;
    }
    
    .fraud-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        font-size: 11px;
    }
    
    .fraud-loading .spinner-border {
        width: 16px;
        height: 16px;
        border-width: 2px;
    }
    
    .fraud-error {
        color: #dc3545;
        font-size: 10px;
        text-align: center;
        cursor: help;
    }
    
    /* Status Filter Buttons */
    .status-filter-btn {
        transition: all 0.3s ease;
        border-radius: 25px;
        font-weight: 500;
        position: relative;
        overflow: hidden;
    }
    
    .status-filter-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .status-filter-btn.active {
        background-color: var(--primary-color) !important;
        border-color: var(--primary-color) !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(147, 0, 0, 0.3);
    }
    
    .status-filter-btn.active .badge {
        background-color: rgba(255, 255, 255, 0.2) !important;
        color: white !important;
    }
    
    .status-filter-btn .badge {
        font-size: 0.7rem;
        margin-left: 0.5rem;
        transition: all 0.3s ease;
    }
    
    /* Filter with status list container */
    .filter-with-status-list {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-radius: 0;
    }
    
    .filter-with-status-list .d-flex {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        margin: 0.5rem;
        padding: 1rem !important;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    /* Responsive improvements for status filters */
    @media (max-width: 768px) {
        .status-filter-btn {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            margin-bottom: 0.5rem;
        }
        
        .status-filter-btn .badge {
            font-size: 0.65rem;
            margin-left: 0.3rem;
        }
        
        .filter-with-status-list .d-flex {
            padding: 0.75rem !important;
            gap: 0.5rem !important;
        }
    }
    
    /* Bulk Actions Styles */
    .bulk-actions-row {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    #bulkActionSelect:disabled,
    #applyBulkActionBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    #applyBulkActionBtn:not(:disabled) {
        background-color: #ffc107;
        border-color: #ffc107;
        color: #000;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    #applyBulkActionBtn:not(:disabled):hover {
        background-color: #ffca2c;
        border-color: #ffca2c;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
    }
    
    /* Checkbox styles */
    .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .form-check-input:focus {
        border-color: var(--primary-color);
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(147, 0, 0, 0.25);
    }
    
    /* Selected row highlighting */
    tr.selected-row {
        background-color: rgba(147, 0, 0, 0.1) !important;
        border-left: 4px solid var(--primary-color);
    }
    
    /* Selection counter */
    .selection-counter {
        background: var(--primary-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
        margin-left: 0.5rem;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.8); }
        to { opacity: 1; transform: scale(1); }
    }
    
    /* Search Suggestions Styles */
    .search-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 0.375rem 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        z-index: 1000;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .search-suggestion-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f8f9fa;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .search-suggestion-item:hover {
        background-color: #f8f9fa;
    }
    
    .search-suggestion-item:last-child {
        border-bottom: none;
    }
    
    .search-suggestion-item.active {
        background-color: var(--primary-color);
        color: white;
    }
    
    .suggestion-main {
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    .suggestion-details {
        font-size: 0.8rem;
        color: #6c757d;
        display: flex;
        gap: 1rem;
    }
    
    .search-suggestion-item.active .suggestion-details {
        color: rgba(255, 255, 255, 0.8);
    }
    
    .search-loading {
        padding: 1rem;
        text-align: center;
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .search-no-results {
        padding: 1rem;
        text-align: center;
        color: #6c757d;
        font-size: 0.9rem;
        font-style: italic;
    }
    
    /* Enhanced input group for search */
    .input-group-sm .input-group-text {
        background-color: #f8f9fa;
        border-color: #dee2e6;
        color: #6c757d;
    }
    
    .input-group-sm .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(147, 0, 0, 0.25);
    }
    
    .input-group-sm .form-control:focus + .search-suggestions {
        border-color: var(--primary-color);
    }
    
    /* Live search loading indicator */
    .search-loading-inline {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10;
        color: var(--primary-color);
    }
    
    /* Clear filters button */
    #clearFiltersBtn {
        border-color: #dee2e6;
        color: #6c757d;
        transition: all 0.2s;
    }
    
    #clearFiltersBtn:hover {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
    }
    
    /* Custom date inputs animation */
    #customDateStart, #customDateEnd {
        transition: all 0.3s ease;
        opacity: 0;
        transform: scale(0.95);
    }
    
    #customDateStart.show, #customDateEnd.show {
        display: block !important;
        opacity: 1;
        transform: scale(1);
    }
    
    /* Product Search Dropdown Styles */
    .product-search-item {
        transition: background-color 0.2s;
    }
    
    .product-search-item:hover {
        background-color: #f8f9fa;
    }
    
    .product-search-item.active {
        background-color: var(--primary-color);
        color: white;
    }
    
    #addItemProductDropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 0.375rem 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        z-index: 1000;
    }
    
    #addItemProductSearch:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(147, 0, 0, 0.25);
    }
</style>
{% endblock %}

{% block content %}
<!-- Hidden CSRF Token for JavaScript use -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Orders</h5>
        <button class="btn btn-sm btn-secondary" id="refreshOrdersBtn">
            <i class="fas fa-sync-alt me-1"></i> Refresh
        </button>
    </div>
    <div class="filter-with-status-list">
        <div class="d-flex flex-wrap gap-2 p-3 border-bottom">
            <button class="btn btn-primary btn-sm status-filter-btn active" data-status="">
                All <span class="badge bg-primary-subtle text-primary rounded-pill" id="allOrdersCount">0</span>
            </button>
            <button class="btn btn-outline-primary btn-sm status-filter-btn" data-status="pending">
                Pending <span class="badge bg-primary-subtle text-primary rounded-pill" id="pendingOrdersCount">0</span>
            </button>
            <button class="btn btn-outline-primary btn-sm status-filter-btn" data-status="confirmed">
                Confirmed <span class="badge bg-primary-subtle text-primary rounded-pill" id="confirmedOrdersCount">0</span>
            </button>
            <button class="btn btn-outline-primary btn-sm status-filter-btn" data-status="processing">
                Processing <span class="badge bg-primary-subtle text-primary rounded-pill" id="processingOrdersCount">0</span>
            </button>
            <button class="btn btn-outline-primary btn-sm status-filter-btn" data-status="shipped">
                Shipped <span class="badge bg-primary-subtle text-primary rounded-pill" id="shippedOrdersCount">0</span>
            </button>
            <button class="btn btn-outline-primary btn-sm status-filter-btn" data-status="delivered">
                Delivered <span class="badge bg-primary-subtle text-primary rounded-pill" id="deliveredOrdersCount">0</span>
            </button>
            <button class="btn btn-outline-primary btn-sm status-filter-btn" data-status="returned">
                Returned <span class="badge bg-primary-subtle text-primary rounded-pill" id="returnedOrdersCount">0</span>
            </button>
            <button class="btn btn-outline-primary btn-sm status-filter-btn" data-status="partially_returned">
                Partially Returned <span class="badge bg-primary-subtle text-primary rounded-pill" id="partiallyReturnedOrdersCount">0</span>
            </button>
            <button class="btn btn-outline-primary btn-sm status-filter-btn" data-status="cancelled">
                Cancelled <span class="badge bg-primary-subtle text-primary rounded-pill" id="cancelledOrdersCount">0</span>
            </button>
            <button class="btn btn-outline-primary btn-sm status-filter-btn" data-status="courier_today">
                Today's Courier <span class="badge bg-primary-subtle text-primary rounded-pill" id="courierTodayOrdersCount">0</span>
            </button>
        </div>
        
    </div>
    <div class="card-body">
        <div class="mb-3">
            <div class="row g-2 align-items-center">
                <!-- Left side: Bulk Actions -->
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="bulkActionSelect" disabled>
                        <option value="">Bulk Actions</option>
                        <option value="pending">Change to Pending</option>
                        <option value="confirmed">Change to Confirmed</option>
                        <option value="processing">Change to Processing</option>
                        <option value="shipped">Change to Shipped</option>
                        <option value="delivered">Change to Delivered</option>
                        <option value="returned">Change to Returned</option>
                        <option value="partially_returned">Change to Partially Returned</option>
                        <option value="cancelled">Change to Cancelled</option>
                        <option value="delete">Delete Selected</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <button class="btn btn-warning btn-sm w-100" id="applyBulkActionBtn" disabled>
                        <i class="fas fa-check me-1"></i> Apply
                    </button>
                </div>
                
                <!-- Right side: Search and Filters -->
                <div class="col-md-3">
                    <div class="input-group input-group-sm position-relative">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="orderSearchInput" 
                               placeholder="Search by customer name, order ID, phone number, or address..." 
                               autocomplete="off">
                        <div id="searchSuggestions" class="search-suggestions" style="display: none;"></div>
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="dateFilter">
                        <option value="">All Dates</option>
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="this_week">This Week</option>
                        <option value="this_month">This Month</option>
                        <option value="custom">Custom Date</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <div class="d-flex gap-1">
                        <input type="date" class="form-control form-control-sm" id="customDateStart" 
                               style="display: none;" title="Start Date">
                        <input type="date" class="form-control form-control-sm" id="customDateEnd" 
                               style="display: none;" title="End Date">
                        <button class="btn btn-outline-secondary btn-sm" id="clearFiltersBtn" title="Clear all filters">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Courier Monitoring Status Indicator -->
        <div class="justify-content-between p-3 align-items-center bg-light border-bottom" style="display: flex; align-items: center;">
            <div class="align-items-center gap-2" style="display: flex;">
                <div class="flex-column" style="padding: 0px!important;">
                    <div class="d-flex align-items-center">
                        <div class="courier-monitor-indicator me-2" id="courierMonitorIndicator">
                            <i class="fas fa-circle text-secondary"></i>
                        </div>
                        <span class="courier-monitor-text small" id="courierMonitorText">Courier Monitoring: Initializing...</span>
                    </div>
                </div>
                <div class="courier-stats small text-muted" id="courierStats" style="display: none;">
                    <span id="shippedOrdersBeingMonitored">0</span> shipped orders being monitored
                </div>
            </div>
            <div class="courier-monitor-controls">
                <button class="btn btn-outline-secondary btn-sm" id="toggleCourierMonitoring" onclick="toggleCourierMonitoring()">
                    <i class="fas fa-pause me-1"></i> Pause Monitoring
                </button>
                <button class="btn btn-outline-warning btn-sm ms-1" onclick="manualMonitorCheck()">
                    <i class="fas fa-play me-1"></i> Manual Check
                </button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th width="50">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllOrders" title="Select/Deselect All">
                                <label class="form-check-label" for="selectAllOrders"></label>
                            </div>
                        </th>
                        <th>Order #</th>
                        <th>Date</th>
                        <th>Actions</th>
                        <th>Fraud Check</th>
                        <th>Total</th>
                        <th>Items</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading orders...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <span id="ordersTotalCount">0</span> orders
            </div>
            <div>
                <nav aria-label="Orders pagination">
                    <ul class="pagination pagination-sm" id="ordersPagination"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailsModalLabel">
                    Order #<span id="orderNumberDisplay"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Order Status Badge -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="d-flex align-items-center" style="gap: 0.5rem;">
                        <span id="orderDetailStatus" class="badge me-2"></span>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="changeStatusBtn" data-bs-toggle="dropdown" aria-expanded="false">
                                Change Status
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="changeStatusBtn" id="statusDropdown">
                                <li><a class="dropdown-item" data-status="pending" href="#">Pending</a></li>
                                <li><a class="dropdown-item" data-status="confirmed" href="#">Confirmed</a></li>
                                <li><a class="dropdown-item" data-status="processing" href="#">Processing</a></li>
                                <li><a class="dropdown-item" data-status="shipped" href="#">Shipped</a></li>
                                <li><a class="dropdown-item" data-status="delivered" href="#">Delivered</a></li>
                                <li><a class="dropdown-item" data-status="returned" href="#">Returned</a></li>
                                <li><a class="dropdown-item" data-status="partially_returned" href="#">Partially Returned</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" data-status="cancelled" href="#">Cancelled</a></li>
                            </ul>
                        </div>
                    </div>
                    <div>
                        <span class="badge" id="orderDetailPaymentStatus"></span>
                    </div>
                </div>
                
                <!-- Order Summary Cards -->
                <div class="row g-4 mb-4">
                    <!-- Order Info Card -->
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">
                                    <i class="fas fa-info-circle me-2"></i>Order Information
                                </h6>
                                <dl class="row mb-0">
                                    <dt class="col-sm-4 text-muted">Order Number</dt>
                                    <dd class="col-sm-8 fw-medium" id="orderDetailNumber"></dd>
                                    
                                    <dt class="col-sm-4 text-muted">Date & Time</dt>
                                    <dd class="col-sm-8" id="orderDetailDate"></dd>
                                    
                                    <dt class="col-sm-4 text-muted">Total Amount</dt>
                                    <dd class="col-sm-8 fw-bold" id="orderDetailTotal"></dd>
                                    
                                    <dt class="col-sm-4 text-muted">Courier ID</dt>
                                    <dd class="col-sm-8" id="orderDetailCourierId">
                                        <span id="courierIdDisplay"></span>
                                        <button class="btn btn-sm btn-outline-primary ms-2" id="editCourierBtn" style="display: none;">
                                            <i class="fas fa-edit me-1"></i> Edit
                                        </button>
                                    </dd>
                                    
                                    <dt class="col-sm-4 text-muted">Courier Date</dt>
                                    <dd class="col-sm-8" id="orderDetailCurierDate">
                                        <span id="courierDateDisplay"></span>
                                        <button class="btn btn-sm btn-outline-primary ms-2" id="editCourierDateBtn" style="display: none;">
                                            <i class="fas fa-edit me-1"></i> Edit
                                        </button>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Shipping Address -->
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-map-marker-alt me-2"></i>Shipping Address</span>
                                    <button class="btn btn-sm btn-outline-primary" id="editAddressBtn">
                                        <i class="fas fa-edit me-1"></i> Edit
                                    </button>
                                </h6>
                                <p class="border rounded p-3 bg-light mb-0" id="orderDetailShippingAddress"></p>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- Order Instructions & Shipping Address -->

                
                <div class="row g-4 mb-4">
                    <!-- Order Instructions - Only shown when there are instructions -->
                    <div class="col-md-6" id="orderInstructionsContainer" style="display: none;">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">
                                    <i class="fas fa-clipboard-list me-2"></i>Order Instructions
                                </h6>
                                <p class="border rounded p-3 bg-light mb-0" id="orderDetailInstructions">No special instructions provided.</p>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- Customer Info Card -->
                    <!-- <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">
                                    <i class="fas fa-user me-2"></i>Customer Information
                                </h6>
                                <dl class="row mb-0">
                                    <dt class="col-sm-4 text-muted">Name</dt>
                                    <dd class="col-sm-8" id="orderDetailCustomerName"></dd>
                                    
                                    <dt class="col-sm-4 text-muted">Email</dt>
                                    <dd class="col-sm-8" id="orderDetailCustomerEmail"></dd>
                                    
                                    <dt class="col-sm-4 text-muted">Phone</dt>
                                    <dd class="col-sm-8" id="orderDetailCustomerPhone"></dd>
                                </dl>
                            </div>
                        </div>
                    </div> -->
                </div>
                
                <!-- Order Items -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-3 text-muted d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-shopping-bag me-2"></i>Order Items</span>
                            <button class="btn btn-sm btn-outline-primary" id="addOrderItemBtn">
                                <i class="fas fa-plus me-1"></i> Add Item
                            </button>
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th width="40">Action</th>
                                        <th>Product</th>
                                        <th>Variant</th>
                                        <th class="text-center">Quantity</th>
                                        <th class="text-end">Price</th>
                                        <th class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="orderItemsTableBody"></tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="5" class="text-end">Subtotal:</td>
                                        <td class="text-end" id="orderDetailSubtotal"></td>
                                    </tr>
                                    <tr>
                                        <td colspan="5" class="text-end">Shipping:</td>
                                        <td class="text-end" id="orderDetailShipping"></td>
                                    </tr>
                                    <tr>
                                        <td colspan="5" class="text-end">Tax:</td>
                                        <td class="text-end" id="orderDetailTax"></td>
                                    </tr>
                                    <tr>
                                        <td colspan="5" class="text-end fw-bold">Total:</td>
                                        <td class="text-end fw-bold" id="orderDetailGrandTotal"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="d-flex justify-content-between">
                    <div>
                        <button class="btn btn-outline-secondary me-2" id="printOrderBtn">
                            <i class="fas fa-print me-1"></i> Print Order
                        </button>
                        <button class="btn btn-outline-success" id="modalAddToCurierBtn">
                            <i class="fas fa-truck me-1"></i> Add to Courier
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-outline-danger" id="deleteOrderBtn">
                            <i class="fas fa-trash me-1"></i> Delete Order
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden storage for order details card (for backwards compatibility) -->
<div id="orderDetailsCard" style="display: none;"></div>

<!-- Order status change modal -->
<div class="modal fade" id="statusChangeModal" tabindex="-1" aria-labelledby="statusChangeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusChangeModalLabel">Update Order Status</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to change the status of order <strong id="statusChangeOrderNumber"></strong> to <strong id="statusChangeNewStatus"></strong>?</p>
                
                <!-- Common fields -->
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="notifyCustomerCheck" checked>
                    <label class="form-check-label" for="notifyCustomerCheck">
                        Notify customer via email about this status change
                    </label>
                </div>
                
                <!-- Courier Charge field - shown for all status changes -->
                <div class="mb-3">
                    <label for="courierChargeInput" class="form-label">Courier Charge (optional)</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="courierChargeInput" placeholder="Enter courier charge" min="0" step="0.01">
                    </div>
                    <small class="text-muted">Leave empty to keep current charge</small>
                </div>
                
                <!-- Partially Returned Amount - shown only for partially_returned status -->
                <div class="mb-3" id="partiallyRefundedFieldContainer" style="display: none;">
                    <label for="partiallyRefundedInput" class="form-label">Patially Amount <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="partiallyRefundedInput" placeholder="Enter partially amount" min="0" step="0.01" required>
                    </div>
                    <small class="text-danger" id="partiallyRefundedError" style="display: none;">Please enter a Partially amount</small>
                </div>
                
                <div class="mb-3">
                    <label for="statusChangeComment" class="form-label">Additional Comments (optional)</label>
                    <textarea class="form-control" id="statusChangeComment" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmStatusChangeBtn">Confirm Status Change</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Order Item Quantity Modal -->
<div class="modal fade" id="editQuantityModal" tabindex="-1" aria-labelledby="editQuantityModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editQuantityModalLabel">Edit Item Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="editQuantityProductName" class="form-label">Product</label>
                    <input type="text" class="form-control" id="editQuantityProductName" readonly>
                </div>
                <div class="mb-3" id="editQuantityVariantContainer" style="display: none;">
                    <label for="editQuantityVariantSelect" class="form-label">Variant</label>
                    <select class="form-select" id="editQuantityVariantSelect">
                        <option value="">Select a variant...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="editQuantityInput" class="form-label">New Quantity</label>
                    <input type="number" class="form-control" id="editQuantityInput" min="1" step="1">
                    <small class="text-muted">Current stock: <span id="editQuantityStock">Loading...</span></small>
                </div>
                <div class="mb-3">
                    <label for="editQuantityPriceInput" class="form-label">Unit Price</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="editQuantityPriceInput" min="0" step="0.01">
                    </div>
                </div>
                <input type="hidden" id="editQuantityItemId">
                <input type="hidden" id="editQuantityCurrentVariantId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmEditQuantityBtn">Update Item</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Order Item Modal -->
<div class="modal fade" id="addOrderItemModal" tabindex="-1" aria-labelledby="addOrderItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addOrderItemModalLabel">Add Item to Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="addItemProductSelect" class="form-label">Product</label>
                    <div class="position-relative">
                        <input type="text" class="form-control" id="addItemProductSearch" 
                               placeholder="Search products..." autocomplete="off">
                        <div id="addItemProductDropdown" class="dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto;">
                            <!-- Product options will be populated here -->
                        </div>
                        <input type="hidden" id="addItemProductSelect" value="">
                    </div>
                </div>
                <div class="mb-3" id="addItemVariantContainer" style="display: none;">
                    <label for="addItemVariantSelect" class="form-label">Variant</label>
                    <select class="form-select" id="addItemVariantSelect">
                        <option value="">Select a variant...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="addItemQuantityInput" class="form-label">Quantity</label>
                    <input type="number" class="form-control" id="addItemQuantityInput" min="1" step="1" value="1">
                    <small class="text-muted">Available stock: <span id="addItemStock">0</span></small>
                </div>
                <div class="mb-3">
                    <label for="addItemPriceInput" class="form-label">Unit Price</label>
                    <input type="number" class="form-control" id="addItemPriceInput" min="0" step="0.01" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAddItemBtn">Add Item</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Shipping Address Modal -->
<div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="editAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAddressModalLabel">Edit Shipping Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editAddressForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editFirstName" class="form-label">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editFirstName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editLastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="editLastName">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editAddressLine1" class="form-label">Address<span class="text-danger">*</span></label>
                        <textarea class="form-control" id="editAddressLine1" rows="3" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editPhone" class="form-label">Phone <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="editPhone" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editEmail">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editDeliveryInstructions" class="form-label">Delivery Instructions</label>
                        <textarea class="form-control" id="editDeliveryInstructions" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmEditAddressBtn">Update Address</button>
            </div>
        </div>
    </div>
</div>

<!-- Courier Sticker Modal -->
<div class="modal fade" id="courierStickerModal" tabindex="-1" aria-labelledby="courierStickerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title" id="courierStickerModalLabel">
                    <i class="fas fa-tag me-2"></i>Courier Sticker Preview
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <p class="text-muted">Preview of the 2"  1" courier sticker for order #<span id="stickerOrderNumber"></span></p>
                </div>
                
                <!-- Sticker Preview -->
                <div class="d-flex justify-content-center mb-4">
                    <div id="courierSticker" class="courier-sticker border shadow-sm">
                        <!-- Top row: Logo and Barcode -->
                        <div class="sticker-header">
                            <div class="logo-section">
                                <img src="{% static 'images/MB-logo.png' %}" alt="Logo" class="sticker-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <div class="logo-fallback" style="display: none;">MB</div>
                            </div>
                            <div class="barcode-section">
                                <canvas id="stickerBarcodeCanvas" class="barcode-canvas"></canvas>
                                <div class="courier-id-small" id="stickerCourierIdSmall">ID: 12345</div>
                            </div>
                        </div>
                        
                        <!-- Content section -->
                        <div class="sticker-content">
                            <div class="customer-name" id="stickerCustomerName">John Doe</div>
                            <!-- <div class="courier-id-main" id="stickerCourierId">ID: 12345</div> -->
                            <div style="font-weight: bold; font-size: 8px; margin-bottom: 1px; color: #333;">Products:</div>
                            <div class="products-list" id="stickerProducts">
                                MW02-Black  2<br>
                                MW02-Chocolate  1
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div class="sticker-footer">
                            <div class="contact-row">
                                <span class="website"> www.manobbazar.com</span>
                                <span class="phone"> 01777173040</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Print Instructions -->
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Print Instructions:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Set paper size to 2"  1" (50.8mm  25.4mm)</li>
                        <li>Use label printer or cut regular paper to size</li>
                        <li>Ensure high quality print for barcode readability</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="printStickerBtn">
                    <i class="fas fa-print me-2"></i>Print Sticker
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Courier ID Modal -->
<div class="modal fade" id="editCourierModal" tabindex="-1" aria-labelledby="editCourierModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCourierModalLabel">Edit Courier ID</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="editCourierIdInput" class="form-label">Courier ID</label>
                    <input type="text" class="form-control" id="editCourierIdInput" placeholder="Enter courier ID">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmEditCourierBtn">Update Courier ID</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Courier Date Modal -->
<div class="modal fade" id="editCourierDateModal" tabindex="-1" aria-labelledby="editCourierDateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCourierDateModalLabel">Edit Courier Date</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="editCourierDateInput" class="form-label">Courier Date</label>
                    <input type="date" class="form-control" id="editCourierDateInput">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmEditCourierDateBtn">Update Courier Date</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<!-- JsBarcode for generating proper barcodes -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let currentOrderId = null;
    let orders = [];
    
    // Modal instance tracking
    let orderDetailsModalInstance = null;
    
    // Add event listener for modal backdrop cleanup
    document.getElementById('orderDetailsModal').addEventListener('hidden.bs.modal', function() {
        // Remove any lingering backdrops
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        
        // Reset modal instance
        orderDetailsModalInstance = null;
    });
    
    // Initialize status filter
    window.currentStatusFilter = ''; // Empty means "All"
    
    // Print Sticker Event Listener
    document.getElementById('printStickerBtn').addEventListener('click', function() {
        printCourierSticker();
    });
    
    // Helper function to format status names (converting snake_case to Title Case)
    function formatStatusName(status) {
        if (!status) return '';
        return status.split('_')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }
    
    // Helper function to format relative time (x min ago, x hours ago, or date)
    function formatRelativeTime(dateString) {
        const now = new Date();
        const date = new Date(dateString);
        const diffMs = now - date;
        const diffMinutes = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        
        if (diffMinutes < 60) {
            return `${diffMinutes} min ago`;
        } else if (diffHours < 24) {
            return `${diffHours} hours ago`;
        } else {
            // Format as "Sep 21, 2025"
            const options = { month: 'short', day: 'numeric', year: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }
    }
    
    // Helper function to initialize copy functionality for dynamically added elements
    function initCopyFunctionality() {
        document.querySelectorAll('.copy-icon').forEach(icon => {
            // Remove any existing listeners
            icon.removeEventListener('click', copyToClipboard);
            // Add fresh listener
            icon.addEventListener('click', copyToClipboard);
        });
    }
    
    // Copy to clipboard function
    function copyToClipboard(e) {
        const textToCopy = this.parentElement.dataset.value;
        navigator.clipboard.writeText(textToCopy)
            .then(() => {
                // Visual feedback
                this.classList.add('copy-success');
                this.classList.remove('fa-copy');
                this.classList.add('fa-check');
                setTimeout(() => {
                    this.classList.remove('copy-success');
                    this.classList.remove('fa-check');
                    this.classList.add('fa-copy');
                }, 1500);
            })
            .catch(err => {
                console.error('Could not copy text: ', err);
                alert('Failed to copy to clipboard');
            });
    }
    
    // Event listeners
    document.getElementById('refreshOrdersBtn').addEventListener('click', function() {
        loadOrders(1);
        loadOrderCounts(); // Also refresh counts
    });
    
    // Clear filters button
    document.getElementById('clearFiltersBtn').addEventListener('click', function() {
        // Clear search input
        document.getElementById('orderSearchInput').value = '';
        
        // Reset date filter
        document.getElementById('dateFilter').value = '';
        
        // Hide custom date inputs
        document.getElementById('customDateStart').style.display = 'none';
        document.getElementById('customDateEnd').style.display = 'none';
        document.getElementById('customDateStart').value = '';
        document.getElementById('customDateEnd').value = '';
        
        // Reset status filter to "All"
        document.querySelectorAll('.status-filter-btn').forEach(button => {
            button.classList.remove('active');
            button.classList.remove('btn-primary');
            button.classList.add('btn-outline-primary');
        });
        
        // Set "All" button as active
        document.querySelector('.status-filter-btn[data-status=""]').classList.add('active');
        document.querySelector('.status-filter-btn[data-status=""]').classList.remove('btn-outline-primary');
        document.querySelector('.status-filter-btn[data-status=""]').classList.add('btn-primary');
        
        // Reset global status filter
        window.currentStatusFilter = '';
        
        // Hide suggestions
        hideSuggestions();
        
        // Reload orders
        loadOrders(1);
    });
    
    // Date filter change handler
    document.getElementById('dateFilter').addEventListener('change', function() {
        const selectedValue = this.value;
        const customDateStart = document.getElementById('customDateStart');
        const customDateEnd = document.getElementById('customDateEnd');
        
        if (selectedValue === 'custom') {
            customDateStart.style.display = 'block';
            customDateEnd.style.display = 'block';
            setTimeout(() => {
                customDateStart.classList.add('show');
                customDateEnd.classList.add('show');
            }, 10);
        } else {
            customDateStart.classList.remove('show');
            customDateEnd.classList.remove('show');
            setTimeout(() => {
                customDateStart.style.display = 'none';
                customDateEnd.style.display = 'none';
                customDateStart.value = '';
                customDateEnd.value = '';
            }, 300);
            
            // Load orders immediately for predefined date filters
            loadOrders(1);
        }
    });
    
    // Custom date inputs change handlers
    document.getElementById('customDateStart').addEventListener('change', function() {
        if (this.value && document.getElementById('customDateEnd').value) {
            loadOrders(1);
        }
    });
    
    document.getElementById('customDateEnd').addEventListener('change', function() {
        if (this.value && document.getElementById('customDateStart').value) {
            loadOrders(1);
        }
    });
    
    // Status filter button event listeners
    document.querySelectorAll('.status-filter-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active class from all buttons
            document.querySelectorAll('.status-filter-btn').forEach(button => {
                button.classList.remove('active');
                button.classList.remove('btn-primary');
                button.classList.add('btn-outline-primary');
            });
            
            // Add active class to clicked button
            this.classList.add('active');
            this.classList.remove('btn-outline-primary');
            this.classList.add('btn-primary');
            
            // Get the status from data attribute
            const selectedStatus = this.dataset.status;
            
            // Store the current status filter
            window.currentStatusFilter = selectedStatus;
            
            // Load orders with the selected status filter
            loadOrdersWithStatus(1, selectedStatus);
        });
    });

    // Enhanced Live Search Functionality
    let searchTimeout;
    let currentSearchTerm = '';
    let selectedSuggestionIndex = -1;
    let isSearching = false;
    
    document.getElementById('orderSearchInput').addEventListener('input', function() {
        const searchTerm = this.value.trim();
        const suggestionsContainer = document.getElementById('searchSuggestions');
        
        // Clear previous timeout
        clearTimeout(searchTimeout);
        
        if (searchTerm.length === 0) {
            hideSuggestions();
            currentSearchTerm = '';
            // Load all orders when search is cleared
            loadOrders(1);
            return;
        }
        
        if (searchTerm.length < 2) {
            hideSuggestions();
            return;
        }
        
        // Show loading indicator in input field
        showSearchLoading();
        
        // Debounce search requests
        searchTimeout = setTimeout(() => {
            if (searchTerm !== currentSearchTerm) {
                currentSearchTerm = searchTerm;
                performLiveSearch(searchTerm);
            }
        }, 300);
    });
    
    function showSearchLoading() {
        const inputGroup = document.getElementById('orderSearchInput').closest('.input-group');
        let loadingIndicator = inputGroup.querySelector('.search-loading-inline');
        
        if (!loadingIndicator) {
            loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'search-loading-inline';
            loadingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            inputGroup.style.position = 'relative';
            inputGroup.appendChild(loadingIndicator);
        }
        
        loadingIndicator.style.display = 'block';
    }
    
    function hideSearchLoading() {
        const inputGroup = document.getElementById('orderSearchInput').closest('.input-group');
        const loadingIndicator = inputGroup.querySelector('.search-loading-inline');
        
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }
    }
    
    function performLiveSearch(searchTerm) {
        isSearching = true;
        
        // Immediately load orders with search term (live results)
        loadOrders(1);
        
        // Also fetch suggestions for dropdown
        fetchSearchSuggestions(searchTerm);
    }
    
    // Handle keyboard navigation in search suggestions
    document.getElementById('orderSearchInput').addEventListener('keydown', function(e) {
        const suggestionsContainer = document.getElementById('searchSuggestions');
        const suggestions = suggestionsContainer.querySelectorAll('.search-suggestion-item');
        
        if (suggestions.length === 0) return;
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
                updateSuggestionSelection(suggestions);
                break;
            case 'ArrowUp':
                e.preventDefault();
                selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                updateSuggestionSelection(suggestions);
                break;
            case 'Enter':
                e.preventDefault();
                if (selectedSuggestionIndex >= 0) {
                    selectSuggestion(suggestions[selectedSuggestionIndex]);
                } else {
                    loadOrders(1);
                    hideSuggestions();
                }
                break;
            case 'Escape':
                hideSuggestions();
                break;
        }
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.input-group')) {
            hideSuggestions();
        }
    });
    
    function fetchSearchSuggestions(searchTerm) {
        const suggestionsContainer = document.getElementById('searchSuggestions');
        
        // Show loading in suggestions
        suggestionsContainer.innerHTML = '<div class="search-loading"><i class="fas fa-spinner fa-spin me-2"></i>Searching...</div>';
        suggestionsContainer.style.display = 'block';
        
        // Fetch suggestions from API - for now we'll simulate this since the endpoint might not exist
        // In production, replace this with the actual API call
        setTimeout(() => {
            hideSearchLoading();
            
            // Simulate API response - in production, replace with actual fetch call
            // fetch(`/mb-admin/api/orders/search-suggestions/?q=${encodeURIComponent(searchTerm)}`)
            //     .then(response => response.json())
            //     .then(data => {
            //         displaySearchSuggestions(data.results || []);
            //     })
            //     .catch(error => {
            //         console.error('Search suggestions error:', error);
            //         suggestionsContainer.innerHTML = '<div class="search-no-results">Search suggestions temporarily unavailable</div>';
            //     });
            
            // For now, hide suggestions since we have live search in the main table
            hideSuggestions();
        }, 300);
    }
    
    function displaySearchSuggestions(suggestions) {
        const suggestionsContainer = document.getElementById('searchSuggestions');
        selectedSuggestionIndex = -1;
        
        if (suggestions.length === 0) {
            suggestionsContainer.innerHTML = '<div class="search-no-results">No matching orders found</div>';
            return;
        }
        
        const suggestionsHtml = suggestions.map((suggestion, index) => {
            const customerName = suggestion.customer_name || 'Guest';
            const phone = suggestion.phone || 'No phone';
            const orderDate = new Date(suggestion.created_at).toLocaleDateString();
            
            return `
                <div class="search-suggestion-item" data-order-id="${suggestion.id}" data-index="${index}">
                    <div class="suggestion-main">${customerName} - Order #${suggestion.order_number}</div>
                    <div class="suggestion-details">
                        <span> ${phone}</span>
                        <span> ${orderDate}</span>
                        <span> $${suggestion.total_amount}</span>
                        <span class="badge badge-sm ${getStatusBadgeClass(suggestion.status)}">${suggestion.status}</span>
                    </div>
                </div>
            `;
        }).join('');
        
        suggestionsContainer.innerHTML = suggestionsHtml;
        
        // Add click event listeners
        suggestionsContainer.querySelectorAll('.search-suggestion-item').forEach(item => {
            item.addEventListener('click', () => selectSuggestion(item));
        });
    }
    
    function updateSuggestionSelection(suggestions) {
        suggestions.forEach((item, index) => {
            item.classList.toggle('active', index === selectedSuggestionIndex);
        });
    }
    
    function selectSuggestion(suggestionItem) {
        const orderId = suggestionItem.dataset.orderId;
        const orderText = suggestionItem.querySelector('.suggestion-main').textContent;
        
        // Set the search input to the selected order
        document.getElementById('orderSearchInput').value = orderText;
        
        // Load orders with this specific search
        loadOrders(1);
        hideSuggestions();
    }
    
    function hideSuggestions() {
        document.getElementById('searchSuggestions').style.display = 'none';
        selectedSuggestionIndex = -1;
    }
    
    function getStatusBadgeClass(status) {
        const statusClasses = {
            'pending': 'bg-warning text-dark',
            'confirmed': 'bg-info text-white',
            'processing': 'bg-primary text-white',
            'shipped': 'bg-indigo text-white',
            'delivered': 'bg-success text-white',
            'returned': 'bg-brown text-white',
            'partially_returned': 'bg-orange text-white',
            'cancelled': 'bg-danger text-white'
        };
        return statusClasses[status] || 'bg-secondary text-white';
    }

    // Bulk Actions Event Listeners
    
    // Select/Deselect All checkbox
    document.getElementById('selectAllOrders').addEventListener('change', function() {
        const isChecked = this.checked;
        const checkboxes = document.querySelectorAll('.order-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
            toggleRowSelection(checkbox.closest('tr'), isChecked);
        });
        
        updateBulkActionControls();
    });
    
    // Function to handle individual checkbox changes
    function handleOrderCheckboxChange() {
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('order-checkbox')) {
                const isChecked = e.target.checked;
                const row = e.target.closest('tr');
                toggleRowSelection(row, isChecked);
                updateBulkActionControls();
                updateSelectAllCheckbox();
            }
        });
    }
    
    // Function to toggle row selection styling
    function toggleRowSelection(row, isSelected) {
        if (isSelected) {
            row.classList.add('selected-row');
        } else {
            row.classList.remove('selected-row');
        }
    }
    
    // Function to update bulk action controls
    function updateBulkActionControls() {
        const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
        const bulkActionSelect = document.getElementById('bulkActionSelect');
        const applyBulkActionBtn = document.getElementById('applyBulkActionBtn');
        
        const hasSelection = selectedCheckboxes.length > 0;
        
        bulkActionSelect.disabled = !hasSelection;
        applyBulkActionBtn.disabled = !hasSelection || !bulkActionSelect.value;
        
        // Update button text with selection count
        if (hasSelection) {
            applyBulkActionBtn.innerHTML = `
                <i class="fas fa-check me-1"></i> Apply (${selectedCheckboxes.length})
            `;
        } else {
            applyBulkActionBtn.innerHTML = `
                <i class="fas fa-check me-1"></i> Apply
            `;
        }
    }
    
    // Function to update select all checkbox state
    function updateSelectAllCheckbox() {
        const allCheckboxes = document.querySelectorAll('.order-checkbox');
        const checkedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
        const selectAllCheckbox = document.getElementById('selectAllOrders');
        
        if (checkedCheckboxes.length === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedCheckboxes.length === allCheckboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }
    
    // Bulk action dropdown change
    document.getElementById('bulkActionSelect').addEventListener('change', function() {
        updateBulkActionControls();
    });
    
    // Apply bulk action button
    document.getElementById('applyBulkActionBtn').addEventListener('click', function() {
        const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
        const selectedOrderIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.orderId);
        const action = document.getElementById('bulkActionSelect').value;
        
        if (selectedOrderIds.length === 0) {
            Swal.fire({
                title: 'No Orders Selected',
                text: 'Please select at least one order to perform bulk action.',
                icon: 'warning'
            });
            return;
        }
        
        if (!action) {
            Swal.fire({
                title: 'No Action Selected',
                text: 'Please select an action to perform.',
                icon: 'warning'
            });
            return;
        }
        
        // Show confirmation popup
        let actionText = '';
        let warningText = '';
        
        if (action === 'delete') {
            actionText = 'Delete';
            warningText = 'This action cannot be undone!';
        } else {
            actionText = `Change status to "${action.charAt(0).toUpperCase() + action.slice(1).replace('_', ' ')}"`;
            warningText = 'All selected orders will be updated.';
        }
        
        Swal.fire({
            title: `${actionText} Selected Orders?`,
            text: `Are you sure you want to ${actionText.toLowerCase()} ${selectedOrderIds.length} order(s)? ${warningText}`,
            icon: action === 'delete' ? 'error' : 'question',
            showCancelButton: true,
            confirmButtonColor: action === 'delete' ? '#dc3545' : '#930000',
            cancelButtonColor: '#6c757d',
            confirmButtonText: `Yes, ${actionText}!`,
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                performBulkAction(selectedOrderIds, action);
            }
        });
    });
    
    // Function to perform bulk action
    function performBulkAction(orderIds, action) {
        // Show loading
        Swal.fire({
            title: 'Processing...',
            text: 'Please wait while we process your request.',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        // Prepare the request based on action
        let requestData = {
            order_ids: orderIds,
            action: action
        };
        
        if (action !== 'delete') {
            requestData.new_status = action;
        }
        
        // Make the API call
        console.log(' Making bulk action request to:', '/mb-admin/api/orders/bulk_action/');
        console.log(' Request data:', requestData);
        
        fetch('/mb-admin/api/orders/bulk_action/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            console.log(' Response status:', response.status);
            console.log(' Response headers:', response.headers);
            
            if (!response.ok) {
                // Handle HTTP errors
                if (response.status === 404) {
                    throw new Error('Bulk action endpoint not found. Please contact your administrator.');
                } else if (response.status === 403) {
                    throw new Error('You do not have permission to perform bulk actions.');
                } else if (response.status === 405) {
                    throw new Error('Method not allowed. The bulk action endpoint may not be properly configured.');
                } else if (response.status >= 500) {
                    throw new Error('Server error occurred. Please try again later.');
                } else {
                    throw new Error(`HTTP Error: ${response.status}`);
                }
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                Swal.fire({
                    title: 'Success!',
                    text: data.message || `Successfully processed ${orderIds.length} order(s).`,
                    icon: 'success'
                }).then(() => {
                    // Refresh the orders list and counts
                    loadOrders(currentPage);
                    loadOrderCounts();
                    
                    // Reset bulk action controls
                    document.getElementById('bulkActionSelect').value = '';
                    document.getElementById('selectAllOrders').checked = false;
                    document.getElementById('selectAllOrders').indeterminate = false;
                    updateBulkActionControls();
                });
            } else {
                Swal.fire({
                    title: 'Error!',
                    text: data.message || 'An error occurred while processing your request.',
                    icon: 'error'
                });
            }
        })
        .catch(error => {
            console.error(' Bulk action error:', error);
            
            let errorMessage = 'An error occurred while processing your request.';
            
            if (error.message.includes('endpoint not found')) {
                errorMessage = 'Bulk actions feature is not yet implemented on the server. Please contact your administrator.';
            } else if (error.message.includes('permission')) {
                errorMessage = 'You do not have permission to perform bulk actions.';
            } else if (error.message.includes('Server error')) {
                errorMessage = 'Server error occurred. Please try again later.';
            } else if (error.message.includes('Method not allowed')) {
                errorMessage = 'The bulk action feature is not properly configured. Please contact your administrator.';
            } else if (error.message) {
                errorMessage = error.message;
            }
            
            console.error(' Final error message:', errorMessage);
            
            Swal.fire({
                title: 'Error!',
                text: errorMessage,
                icon: 'error',
                footer: 'If this problem persists, please contact support.',
                customClass: {
                    footer: 'text-muted'
                }
            });
        });
    }
    
    // Initialize checkbox handling
    handleOrderCheckboxChange();

    // Modal is handled by Bootstrap
    
    // Initial data loading
    loadOrders(1);
    loadOrderCounts(); // Load order counts for filter buttons
    
    // Start automatic courier status monitoring after page loads
    setTimeout(() => {
        startCourierMonitoring();
        console.log(' Automatic courier status monitoring initialized');
    }, 5000); // Wait 5 seconds for initial orders to load
    
    // Initialize monitoring status
    updateMonitoringStatus('initializing');
    
    // Load orders with pagination and filtering
    function loadOrders(page = 1) {
        currentPage = page;
        const searchTerm = document.getElementById('orderSearchInput').value.trim();
        const dateFilter = document.getElementById('dateFilter').value;
        const customDateStart = document.getElementById('customDateStart').value;
        const customDateEnd = document.getElementById('customDateEnd').value;
        
        let url = `/mb-admin/api/orders/?page=${page}&include_shipping_address=true`;
        
        console.log(' Loading orders with:', {
            page,
            searchTerm,
            dateFilter,
            customDateStart,
            customDateEnd,
            currentStatusFilter: window.currentStatusFilter
        });
        
        if (searchTerm) {
            url += `&search=${encodeURIComponent(searchTerm)}`;
            console.log(' Search term added:', searchTerm);
        }
        
        // Handle date filtering
        if (dateFilter) {
            console.log(' Processing date filter:', dateFilter);
            if (dateFilter === 'custom') {
                if (customDateStart && customDateEnd) {
                    url += `&created_at__date__gte=${customDateStart}`;
                    url += `&created_at__date__lte=${customDateEnd}`;
                    console.log(' Custom date range applied:', customDateStart, 'to', customDateEnd);
                } else {
                    console.log(' Custom date filter selected but dates not provided');
                }
            } else {
                // Calculate date range for predefined filters
                const dateRange = getDateRange(dateFilter);
                console.log(' Calculated date range:', dateRange);
                if (dateRange.start) {
                    url += `&created_at__date__gte=${dateRange.start}`;
                }
                if (dateRange.end) {
                    url += `&created_at__date__lte=${dateRange.end}`;
                }
            }
        }
        
        // Apply current status filter if exists
        if (window.currentStatusFilter !== undefined) {
            if (window.currentStatusFilter) {
                if (window.currentStatusFilter === 'courier_today') {
                    url += `&courier_date=today`;
                    console.log(' Courier today filter applied');
                } else {
                    url += `&status=${window.currentStatusFilter}`;
                    console.log(' Status filter applied:', window.currentStatusFilter);
                }
            }
        }
        
        console.log(' Final API URL:', url);
        
        // Show loading indicator
        document.getElementById('ordersTableBody').innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading orders...</p>
                </td>
            </tr>
        `;
        
        fetch(url)
            .then(response => {
                console.log(' API Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(' API Response data:', data);
                orders = data.results || [];
                console.log(' Orders count:', orders.length);
                displayOrders(orders);
                updatePagination(data);
                document.getElementById('ordersTotalCount').textContent = data.count || 0;
                
                // Hide search loading indicator
                hideSearchLoading();
                
                // Refresh order counts when loading the first page to ensure they stay accurate
                // This happens for any status filter on page 1 to keep counts synchronized
                if (page === 1) {
                    setTimeout(() => loadOrderCounts(), 100);
                }
                
                // Monitor courier status for shipped orders automatically
                if (orders && orders.length > 0) {
                    setTimeout(() => monitorCourierStatus(orders), 2000); // Wait 2 seconds after loading
                }
            })
            .catch(error => {
                console.error(' Error loading orders:', error);
                hideSearchLoading();
                document.getElementById('ordersTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>Error loading orders: ${error.message}</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="loadOrders(${page})">
                                <i class="fas fa-retry me-1"></i> Retry
                            </button>
                        </td>
                    </tr>
                `;
            });
    }
    
    // Helper function to get date ranges for predefined filters
    function getDateRange(filterType) {
        const today = new Date();
        const result = { start: null, end: null };
        
        console.log(' getDateRange called with:', filterType, 'Today:', today.toISOString().split('T')[0]);
        
        switch (filterType) {
            case 'today':
                result.start = today.toISOString().split('T')[0];
                result.end = today.toISOString().split('T')[0];
                break;
                
            case 'yesterday':
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                result.start = yesterday.toISOString().split('T')[0];
                result.end = yesterday.toISOString().split('T')[0];
                break;
                
            case 'this_week':
                const startOfWeek = new Date(today);
                const day = startOfWeek.getDay();
                const diff = startOfWeek.getDate() - day; // First day is Sunday (0)
                startOfWeek.setDate(diff);
                result.start = startOfWeek.toISOString().split('T')[0];
                result.end = today.toISOString().split('T')[0];
                break;
                
            case 'this_month':
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                result.start = startOfMonth.toISOString().split('T')[0];
                result.end = today.toISOString().split('T')[0];
                break;
        }
        
        console.log(' getDateRange result:', result);
        return result;
    }
    
    // Load orders with specific status filter
    function loadOrdersWithStatus(page = 1, status = '') {
        currentPage = page;
        const searchTerm = document.getElementById('orderSearchInput').value.trim();
        const dateFilter = document.getElementById('dateFilter').value;
        const customDateStart = document.getElementById('customDateStart').value;
        const customDateEnd = document.getElementById('customDateEnd').value;
        
        let url = `/mb-admin/api/orders/?page=${page}&include_shipping_address=true`;
        
        console.log(' Loading orders with status:', {
            page,
            status,
            searchTerm,
            dateFilter,
            customDateStart,
            customDateEnd
        });
        
        if (searchTerm) {
            url += `&search=${encodeURIComponent(searchTerm)}`;
            console.log(' Search term added:', searchTerm);
        }
        
        if (status) {
            if (status === 'courier_today') {
                url += `&courier_date=today`;
                console.log(' Courier today filter applied');
            } else {
                url += `&status=${status}`;
                console.log(' Status filter applied:', status);
            }
        }
        
        // Handle date filtering
        if (dateFilter) {
            console.log(' Processing date filter:', dateFilter);
            if (dateFilter === 'custom') {
                if (customDateStart && customDateEnd) {
                    url += `&created_at__date__gte=${customDateStart}`;
                    url += `&created_at__date__lte=${customDateEnd}`;
                    console.log(' Custom date range applied:', customDateStart, 'to', customDateEnd);
                } else {
                    console.log(' Custom date filter selected but dates not provided');
                }
            } else {
                // Calculate date range for predefined filters
                const dateRange = getDateRange(dateFilter);
                console.log(' Calculated date range:', dateRange);
                if (dateRange.start) {
                    url += `&created_at__date__gte=${dateRange.start}`;
                }
                if (dateRange.end) {
                    url += `&created_at__date__lte=${dateRange.end}`;
                }
            }
        }
        
        console.log(' Final API URL:', url);
        
        // Show loading indicator
        document.getElementById('ordersTableBody').innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading orders...</p>
                </td>
            </tr>
        `;
        
        fetch(url)
            .then(response => {
                console.log(' API Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(' API Response data:', data);
                orders = data.results || [];
                console.log(' Orders count:', orders.length);
                displayOrders(orders);
                updatePagination(data);
                document.getElementById('ordersTotalCount').textContent = data.count || 0;
                
                // Hide search loading indicator
                hideSearchLoading();
                
                // Refresh order counts when loading the first page to ensure they stay accurate
                if (page === 1) {
                    setTimeout(() => loadOrderCounts(), 100);
                }
            })
            .catch(error => {
                console.error(' Error loading orders:', error);
                hideSearchLoading();
                document.getElementById('ordersTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>Error loading orders: ${error.message}</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="loadOrdersWithStatus(${page}, '${status}')">
                                <i class="fas fa-retry me-1"></i> Retry
                            </button>
                        </td>
                    </tr>
                `;
            });
    }
    
    // Load order counts for filter buttons
    function loadOrderCounts() {
        console.log('Loading order counts...');
        // Fetch order counts for each status
        fetch('/mb-admin/api/orders/?count_by_status=true')
            .then(response => response.json())
            .then(data => {
                console.log('Order counts data received:', data);
                // Update count badges
                if (data.status_counts) {
                    console.log('Using API status_counts:', data.status_counts);
                    // Update all orders count
                    document.getElementById('allOrdersCount').textContent = data.total_count || 0;
                    
                    // Create a mapping between status names and element IDs
                    const statusElementMapping = {
                        'pending': 'pendingOrdersCount',
                        'confirmed': 'confirmedOrdersCount',
                        'processing': 'processingOrdersCount',
                        'shipped': 'shippedOrdersCount',
                        'delivered': 'deliveredOrdersCount',
                        'returned': 'returnedOrdersCount',
                        'partially_returned': 'partiallyReturnedOrdersCount',
                        'cancelled': 'cancelledOrdersCount',
                        'courier_today': 'courierTodayOrdersCount'
                    };
                    
                    // Update individual status counts using the mapping
                    Object.keys(data.status_counts).forEach(status => {
                        const elementId = statusElementMapping[status];
                        if (elementId) {
                            const countElement = document.getElementById(elementId);
                            if (countElement) {
                                console.log(`Updating ${status} count to ${data.status_counts[status]}`);
                                countElement.textContent = data.status_counts[status];
                            } else {
                                console.warn(`Element not found for status: ${status} (${elementId})`);
                            }
                        } else {
                            console.warn(`No mapping found for status: ${status}`);
                        }
                    });
                } else {
                    // Fallback: count orders manually if API doesn't support count_by_status
                    console.log('Using fallback manual counting method');
                    const statusCounts = {
                        pending: 0,
                        confirmed: 0,
                        processing: 0,
                        shipped: 0,
                        delivered: 0,
                        returned: 0,
                        partially_returned: 0,
                        cancelled: 0
                    };
                    
                    // If we have orders data, count them
                    if (data.results) {
                        console.log('Counting orders from results:', data.results.length);
                        data.results.forEach(order => {
                            if (statusCounts.hasOwnProperty(order.status)) {
                                statusCounts[order.status]++;
                            }
                        });
                        
                        console.log('Status counts calculated:', statusCounts);
                        
                        // Update count badges
                        document.getElementById('allOrdersCount').textContent = data.count || 0;
                        document.getElementById('pendingOrdersCount').textContent = statusCounts.pending;
                        document.getElementById('confirmedOrdersCount').textContent = statusCounts.confirmed;
                        document.getElementById('processingOrdersCount').textContent = statusCounts.processing;
                        document.getElementById('shippedOrdersCount').textContent = statusCounts.shipped;
                        document.getElementById('deliveredOrdersCount').textContent = statusCounts.delivered;
                        document.getElementById('returnedOrdersCount').textContent = statusCounts.returned;
                        document.getElementById('partiallyReturnedOrdersCount').textContent = statusCounts.partially_returned;
                        document.getElementById('cancelledOrdersCount').textContent = statusCounts.cancelled;
                    }
                }
            })
            .catch(error => {
                console.error('Error loading order counts:', error);
                // Set all counts to 0 on error
                document.getElementById('allOrdersCount').textContent = '0';
                document.getElementById('pendingOrdersCount').textContent = '0';
                document.getElementById('confirmedOrdersCount').textContent = '0';
                document.getElementById('processingOrdersCount').textContent = '0';
                document.getElementById('shippedOrdersCount').textContent = '0';
                document.getElementById('deliveredOrdersCount').textContent = '0';
                document.getElementById('returnedOrdersCount').textContent = '0';
                document.getElementById('partiallyReturnedOrdersCount').textContent = '0';
                document.getElementById('cancelledOrdersCount').textContent = '0';
            });
    }
    
    function displayOrders(orders) {
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = '';
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">No orders found.</td>
                </tr>
            `;
            return;
        }
        
        // Count orders by phone number for each customer
        const phoneNumberCounts = {};
        const customerPhoneMap = {};
        
        orders.forEach(order => {
            let phone = null;
            let customerName = 'Guest';
            
            // Get phone number and customer name
            if (order.shipping_address) {
                phone = order.shipping_address.phone;
                const firstName = order.shipping_address.first_name || '';
                const lastName = order.shipping_address.last_name || '';
                customerName = `${firstName} ${lastName}`.trim() || 'Guest';
            } else if (order.customer_phone) {
                phone = order.customer_phone;
                customerName = order.user_name || 'Guest';
            }
            
            // Count orders by phone number if phone exists
            if (phone && phone.trim()) {
                const cleanPhone = phone.trim();
                if (!phoneNumberCounts[cleanPhone]) {
                    phoneNumberCounts[cleanPhone] = 0;
                    customerPhoneMap[cleanPhone] = customerName;
                }
                phoneNumberCounts[cleanPhone]++;
            }
        });
        
        orders.forEach(order => {
            const tr = document.createElement('tr');
            
            let statusBadgeClass;
            switch (order.status.toLowerCase()) {
                case 'pending':
                    statusBadgeClass = 'bg-warning text-dark';
                    break;
                case 'confirmed':
                    statusBadgeClass = 'bg-info text-white';
                    break;
                case 'processing':
                    statusBadgeClass = 'bg-primary text-white';
                    break;
                case 'shipped':
                    statusBadgeClass = 'bg-success  text-white';
                    break;
                case 'delivered':
                    statusBadgeClass = 'bg-indigo text-white';
                    break;
                case 'returned':
                    statusBadgeClass = 'bg-orange text-white';
                    break;
                case 'partially_returned':
                    statusBadgeClass = 'bg-brown text-white';
                    break;
                case 'cancelled':
                    statusBadgeClass = 'bg-danger text-white';
                    break;
                default:
                    statusBadgeClass = 'bg-secondary text-white';
            }
            
            let paymentStatusBadgeClass;
            switch (order.payment_status) {
                case 'paid':
                    paymentStatusBadgeClass = 'bg-success';
                    break;
                case 'unpaid':
                    paymentStatusBadgeClass = 'bg-danger';
                    break;
                case 'refunded':
                    paymentStatusBadgeClass = 'bg-warning text-dark';
                    break;
                default:
                    paymentStatusBadgeClass = 'bg-secondary';
            }
            
            // Get customer name from shipping address if available
            let customerName = 'Guest';
            let customerPhone = null;
            
            if (order.shipping_address) {
                const firstName = order.shipping_address.first_name || '';
                const lastName = order.shipping_address.last_name || '';
                customerName = `${firstName} ${lastName}`.trim() || 'Guest';
                customerPhone = order.shipping_address.phone;
            } else if (order.user_name) {
                // Fallback to user_name if available
                customerName = order.user_name;
                customerPhone = order.customer_phone;
            }
            
            // Add order count to customer name if they have multiple orders with same phone
            let displayCustomerName = customerName;
            if (customerPhone && customerPhone.trim()) {
                const cleanPhone = customerPhone.trim();
                const orderCount = phoneNumberCounts[cleanPhone];
                if (orderCount && orderCount > 1) {
                    displayCustomerName = `${customerName} (${orderCount})`;
                }
            }
            
            // Format order number with customer name
            const formattedOrderNumber = `${order.order_number} (${displayCustomerName})`;
            
            tr.innerHTML = `
                <td>
                    <div class="form-check">
                        <input class="form-check-input order-checkbox" type="checkbox" value="${order.id}" data-order-id="${order.id}">
                    </div>
                </td>
                <td><span>${displayCustomerName}</span><br><span style="font-size: 0.8rem;">#${order.order_number}</span> </td>
                <td>${formatRelativeTime(order.created_at)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-primary view-order-btn me-1" data-order-id="${order.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-sm ${order.curier_id ? 'btn-success' : 'btn-outline-success'} add-curier-btn me-1" 
                        data-order-id="${order.id}" 
                        title="${order.curier_id ? 'Already added to curier (ID: ' + order.curier_id + ')' : 'Add to Curier'}"
                        ${order.curier_id ? 'disabled' : ''}>
                        <i class="fas fa-${order.curier_id ? 'check-circle' : 'truck'}" ${order.curier_id ? 'style="color: white;"' : ''}></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-warning courier-sticker-btn" 
                        data-order-id="${order.id}" 
                        title="Print Courier Sticker"
                        ${!order.curier_id ? 'disabled' : ''}>
                        <i class="fas fa-tag"></i>
                    </button>
                </td>
                <td>
                    <div class="fraud-check-container" data-phone="${customerPhone || ''}" data-order-id="${order.id}">
                        <div class="fraud-loading">
                            <span class="spinner-border spinner-border-sm me-1"></span>
                            Loading...
                        </div>
                    </div>
                </td>
                <td>$${order.total_amount}</td>
                <td>${order.total_items}</td>
                <td>
                    <span class="badge ${statusBadgeClass}">
                        ${formatStatusName(order.status)}
                    </span>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Add event listeners to view order buttons
        document.querySelectorAll('.view-order-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.dataset.orderId;
                currentOrderId = orderId;
                loadOrderDetails(orderId);
            });
        });
        
        // Add event listeners to add curier buttons
        document.querySelectorAll('.add-curier-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.dataset.orderId;
                
                // Show confirmation popup
                Swal.fire({
                    title: 'Add to Courier Service',
                    text: 'Do you want to add this order to courier service? Order status will be changed to "shipped".',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, add to courier',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d'
                }).then((result) => {
                    if (result.isConfirmed) {
                        addOrderToCurier(orderId);
                    }
                });
            });
        });
        
        // Add event listeners to courier sticker buttons
        document.querySelectorAll('.courier-sticker-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.dataset.orderId;
                showCourierStickerModal(orderId);
            });
        });
        
        // Initialize fraud checks for all orders
        performFraudChecks(orders);
        
        // Initialize bulk action controls
        updateBulkActionControls();
        updateSelectAllCheckbox();
    }
    
    function updatePagination(data) {
        const pagination = document.getElementById('ordersPagination');
        pagination.innerHTML = '';
        
        // Try to get page size from API response, fallback to default
        let pageSize = 20; // default page size
        
        // Check if API provides pagination metadata
        if (data.page_size) {
            pageSize = data.page_size;
        } else if (data.results && data.results.length > 0 && currentPage === 1) {
            // On first page, if we have less than 20 items and it's the total count, use that
            if (data.count <= 20) {
                pageSize = data.count;
            }
        }
        
        const totalPages = Math.ceil(data.count / pageSize);
        
        console.log(`Pagination: Total items: ${data.count}, Page size: ${pageSize}, Total pages: ${totalPages}, Current page: ${currentPage}`);
        
        if (totalPages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
        pagination.appendChild(prevLi);
        
        // Page numbers
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            pagination.appendChild(li);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
        pagination.appendChild(nextLi);
        
        // Add event listeners to pagination links
        document.querySelectorAll('#ordersPagination .page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.dataset.page);
                
                // Add validation to prevent invalid page requests
                if (page >= 1 && page <= totalPages && page !== currentPage) {
                    console.log(`Loading page ${page} of ${totalPages}`);
                    loadOrders(page);
                } else {
                    console.warn(`Invalid page request: ${page} (current: ${currentPage}, max: ${totalPages})`);
                }
            });
        });
    }
    
    // Order details
    function loadOrderDetails(orderId) {
        console.log(`Loading order details for ID: ${orderId}`);
        
        // First, load order data
        fetch(`/mb-admin/api/orders/${orderId}/`)
            .then(response => {
                console.log(`Order API response status: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(order => {
                console.log('Order data received:', order);
                displayOrderDetails(order);
                
                // Show the modal using tracked instance
                if (!orderDetailsModalInstance) {
                    orderDetailsModalInstance = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
                }
                orderDetailsModalInstance.show();
                
                // Initialize copy functionality after modal is shown
                setTimeout(initCopyFunctionality, 200);
                
                // Then load order items with delay to ensure proper loading
                setTimeout(() => {
                    console.log(`Loading items for order ${orderId}...`);
                    document.getElementById('orderItemsTableBody').innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span class="ms-2">Loading order items...</span>
                            </td>
                        </tr>
                    `;
                    
                    // Use the explicit route to fetch order items
                    fetch(`/mb-admin/api/orders/${orderId}/items/`)
                        .then(response => {
                            console.log(`Items API response status: ${response.status}`);
                            
                            // Debug the raw response
                            response.clone().text().then(text => {
                                console.log('Raw response text:', text.substring(0, 200) + '...');
                                try {
                                    // Try to parse as JSON to see if it's valid
                                    const jsonData = JSON.parse(text);
                                    console.log('Response parsed successfully as JSON:', jsonData);
                                } catch (err) {
                                    console.error('Response is not valid JSON:', err);
                                }
                            });
                            
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(items => {
                            console.log(`Received items:`, items);
                            if (Array.isArray(items)) {
                                console.log(`Found ${items.length} items`);
                                if (items.length > 0) {
                                    displayOrderItems(items);
                                } else {
                                    document.getElementById('orderItemsTableBody').innerHTML = 
                                        '<tr><td colspan="5" class="text-center">No items found in this order.</td></tr>';
                                }
                            } else if (typeof items === 'object' && items !== null && items.error) {
                                // Handle server-side error message
                                console.error('Server error:', items.error);
                                document.getElementById('orderItemsTableBody').innerHTML = 
                                    `<tr><td colspan="5" class="text-center text-danger">Error: ${items.error}</td></tr>`;
                            } else {
                                console.error('Items response is not an array:', items);
                                document.getElementById('orderItemsTableBody').innerHTML = 
                                    '<tr><td colspan="5" class="text-center text-warning">Invalid order items format received.</td></tr>';
                            }
                        })
                        .catch(error => {
                            console.error('Error loading order items:', error);
                            // Display a message in the items table
                            document.getElementById('orderItemsTableBody').innerHTML = 
                                `<tr><td colspan="5" class="text-center text-danger">
                                    <i class="fas fa-exclamation-circle me-2"></i>
                                    Failed to load order items: ${error.message || 'Unknown error'}
                                </td></tr>`;
                                
                            // Retry button
                            document.getElementById('orderItemsTableBody').innerHTML += 
                                `<tr><td colspan="5" class="text-center">
                                    <button class="btn btn-sm btn-outline-primary retry-items-btn mt-2">
                                        <i class="fas fa-sync-alt me-1"></i> Retry
                                    </button>
                                </td></tr>`;
                                
                            // Add event listener to retry button
                            document.querySelector('.retry-items-btn').addEventListener('click', function() {
                                loadOrderDetails(orderId);
                            });
                        });
                }, 500);
            })
            .catch(error => {
                console.error('Error loading order details:', error);
                showAlert('Failed to load order details.', 'danger');
            });
    }
    
    function displayOrderDetails(order) {
        // Log order data for debugging
        console.log('Order details:', order);
        
        // Store order data globally for access in other functions
        window.currentOrderData = order;
        
        // Set order header details
        document.getElementById('orderNumberDisplay').textContent = order.order_number;
        document.getElementById('orderDetailNumber').innerHTML = `
            <span class="copy-text" data-value="${order.order_number}">
                ${order.order_number} <i class="fas fa-copy copy-icon" title="Copy order number"></i>
            </span>
        `;
        document.getElementById('orderDetailDate').textContent = new Date(order.created_at).toLocaleString();
        
        // Handle Courier ID display and edit functionality
        const courierIdDisplay = document.getElementById('courierIdDisplay');
        const editCourierBtn = document.getElementById('editCourierBtn');
        
        if (order.curier_id) {
            courierIdDisplay.textContent = order.curier_id;
            editCourierBtn.style.display = 'inline-block';
        } else {
            courierIdDisplay.textContent = 'Not assigned';
            editCourierBtn.style.display = 'inline-block';
        }
        
        // Handle Courier Date display and edit functionality
        const courierDateDisplay = document.getElementById('courierDateDisplay');
        const editCourierDateBtn = document.getElementById('editCourierDateBtn');
        
        if (order.curier_date) {
            courierDateDisplay.textContent = new Date(order.curier_date).toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            editCourierDateBtn.style.display = 'inline-block';
        } else {
            courierDateDisplay.textContent = 'Not set';
            editCourierDateBtn.style.display = 'inline-block';
        }
        
        // Set order status with appropriate badge
        const statusElement = document.getElementById('orderDetailStatus');
        let statusBadgeClass;
        switch (order.status.toLowerCase()) {
            case 'pending':
                statusBadgeClass = 'bg-warning text-dark';
                break;
            case 'confirmed':
                statusBadgeClass = 'bg-info text-white';
                break;
            case 'processing':
                statusBadgeClass = 'bg-primary text-white';
                break;
            case 'shipped':
                statusBadgeClass = 'bg-success  text-white';
                break;
            case 'delivered':
                statusBadgeClass = 'bg-indigo text-white';
                break;
            case 'returned':
                statusBadgeClass = 'bg-orange text-white';
                break;
            case 'partially_returned':
                statusBadgeClass = 'bg-brown text-white';
                break;
            case 'cancelled':
                statusBadgeClass = 'bg-danger text-white';
                break;
            default:
                statusBadgeClass = 'bg-secondary text-white';
        }
        statusElement.className = `badge ${statusBadgeClass}`;
        statusElement.textContent = formatStatusName(order.status);
        
        // Set payment status with badge style
        const paymentStatusElement = document.getElementById('orderDetailPaymentStatus');
        let paymentStatusClass;
        switch (order.payment_status) {
            case 'paid':
                paymentStatusClass = 'bg-success text-white';
                break;
            case 'unpaid':
                paymentStatusClass = 'bg-danger text-white';
                break;
            case 'refunded':
                paymentStatusClass = 'bg-warning text-dark';
                break;
            default:
                paymentStatusClass = 'bg-secondary text-white';
        }
        paymentStatusElement.className = `badge ${paymentStatusClass}`;
        paymentStatusElement.textContent = order.payment_status.charAt(0).toUpperCase() + order.payment_status.slice(1);
        
        // Set total amount
        document.getElementById('orderDetailTotal').textContent = `$${order.total_amount}`;
        
        // Set customer information
        // const orderSku = order.order_number || '';
        // const firstName = order.shipping_address ? order.shipping_address.first_name || '' : '';
        // const lastName = order.shipping_address ? order.shipping_address.last_name || '' : '';
        // const customerName = `${firstName} ${lastName}`.trim() || 'Guest';
        // const formattedName = `${orderSku} (${customerName})`.trim();
        // const customerEmail = order.user_email || order.customer_email || 'N/A';
        // const customerPhone = order.customer_phone || (order.shipping_address && order.shipping_address.phone) || 'N/A';
        
        // document.getElementById('orderDetailCustomerName').innerHTML = `
        //     <span class="copy-text" data-value="${formattedName}">
        //         ${formattedName} <i class="fas fa-copy copy-icon" title="Copy name"></i>
        //     </span>
        // `;
        
        // document.getElementById('orderDetailCustomerEmail').innerHTML = `
        //     <span class="copy-text" data-value="${customerEmail}">
        //         ${customerEmail} <i class="fas fa-copy copy-icon" title="Copy email"></i>
        //     </span>
        // `;
        
        // document.getElementById('orderDetailCustomerPhone').innerHTML = `
        //     <span class="copy-text" data-value="${customerPhone}">
        //         ${customerPhone} <i class="fas fa-copy copy-icon" title="Copy phone"></i>
        //     </span>
        //     ${customerPhone !== 'N/A' ? `
        //     <a href="tel:${customerPhone}" class="ms-2 text-primary" title="Call customer">
        //         <i class="fas fa-phone-alt"></i>
        //     </a>` : ''}
        // `;
        
        // Set shipping address
        let addressText = 'No shipping address available';
        if (order.shipping_address) {
            try {
                const address = order.shipping_address;
                console.log('Shipping address:', address);
                
                const fullName = `${address.first_name || ''} ${address.last_name || ''}`;
                const addressLine1 = address.address_line_1 || '';
                const addressLine2 = address.address_line_2 || '';
                const cityStateZip = `${address.city || ''}, ${address.state || ''} ${address.postal_code || ''}`;
                const country = address.country || '';
                const phone = address.phone || '';
                const sku = order.sku || order.order_number || '';
                // Check multiple sources for order instructions:
                // 1. Order customer_notes (from checkout)
                // 2. Order instructions field 
                // 3. Shipping address delivery_instructions (from address edit)
                const orderInstruction = order.customer_notes || order.instructions || 
                    (order.shipping_address && order.shipping_address.delivery_instructions) || '';
                
                addressText = `
                    <div class="copy-text" data-value="${fullName}">
                        ${fullName} <i class="fas fa-copy copy-icon" title="Copy name"></i>
                    </div><br>
                    <div class="copy-text" data-value="${addressLine1}">
                        ${addressLine1} <i class="fas fa-copy copy-icon" title="Copy address"></i>
                    </div><br>
                    ${phone ? `<div class="copy-text" data-value="${phone}">Phone: ${phone} <i class="fas fa-copy copy-icon" title="Copy phone"></i>
                        <a href="tel:${phone}" class="ms-2 text-primary" title="Call customer">
                            <i class="fas fa-phone-alt"></i>
                        </a></div><br>` : ''}
                    <div id="orderProductsList">
                        <strong>Products:</strong> <span id="orderProductsText">Loading products...</span>
                    </div>

                `;
            } catch (error) {
                console.error('Error formatting shipping address:', error, order.shipping_address);
            }
        } else {
            console.log('No shipping address found in order data');
        }
        document.getElementById('orderDetailShippingAddress').innerHTML = addressText;
        
        // Initialize copy functionality for all copy buttons
        initCopyFunctionality();
        
        // Set order instructions (if available)
        const orderInstructionsContainer = document.getElementById('orderInstructionsContainer');
        // Check multiple sources for instructions:
        // 1. Order instructions field
        // 2. Order customer_notes (from checkout)  
        // 3. Shipping address delivery_instructions (from address edit)
        const instructionText = order.instructions || order.customer_notes || 
            (order.shipping_address && order.shipping_address.delivery_instructions) || '';
        
        if (instructionText && instructionText.trim()) {
            document.getElementById('orderDetailInstructions').textContent = instructionText;
            orderInstructionsContainer.style.display = 'block'; // Show the container
        } else {
            document.getElementById('orderDetailInstructions').textContent = 'No special instructions provided.';
            orderInstructionsContainer.style.display = 'none'; // Hide the container
        }
        
        // Set up status change dropdown
        document.querySelectorAll('#statusDropdown .dropdown-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const newStatus = this.dataset.status;
                
                // Set values for confirmation modal
                document.getElementById('statusChangeOrderNumber').textContent = order.order_number;
                document.getElementById('statusChangeNewStatus').textContent = formatStatusName(newStatus);
                
                // Reset form fields
                document.getElementById('courierChargeInput').value = '';
                document.getElementById('partiallyRefundedInput').value = '';
                document.getElementById('partiallyRefundedError').style.display = 'none';
                
                // Show/hide partially refunded amount field based on status
                const partiallyRefundedContainer = document.getElementById('partiallyRefundedFieldContainer');
                if (newStatus === 'partially_returned') {
                    partiallyRefundedContainer.style.display = 'block';
                } else {
                    partiallyRefundedContainer.style.display = 'none';
                }
                
                // If we have existing courier charge, pre-fill the field
                if (order.curier_charge) {
                    document.getElementById('courierChargeInput').value = order.curier_charge;
                }
                
                // Show confirmation modal
                const modal = new bootstrap.Modal(document.getElementById('statusChangeModal'));
                modal.show();
                
                // Set up confirmation button
                document.getElementById('confirmStatusChangeBtn').onclick = function() {
                    // Just call updateOrderStatus - it will handle the modal closing
                    updateOrderStatus(order.id, newStatus);
                    // Don't hide the modal here - let updateOrderStatus handle it
                };
            });
        });
        
        // Set up print button
        document.getElementById('printOrderBtn').onclick = function() {
            // Redirect to invoice print view
            window.open(`/orders/${order.id}/invoice/`, '_blank');
        };
        
        // Set up add to courier button with SweetAlert2 confirmation
        document.getElementById('modalAddToCurierBtn').onclick = function() {
            // Check if order already has a courier ID
            if (order.curier_id) {
                Swal.fire({
                    title: 'Already Added to Courier',
                    text: `This order has already been added to courier service with ID: ${order.curier_id}`,
                    icon: 'info',
                    confirmButtonColor: '#28a745'
                });
            } else {
                Swal.fire({
                    title: 'Add to Courier Service',
                    text: 'Do you want to add this order to courier service? Order status will be changed to "shipped".',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, add to courier',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d'
                }).then((result) => {
                    if (result.isConfirmed) {
                        addOrderToCurier(order.id);
                    }
                });
            }
        };
        
        // Set up delete order button with SweetAlert2 confirmation
        document.getElementById('deleteOrderBtn').onclick = function() {
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this deletion!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteOrder(order.id);
                }
            });
        };
    }
    
    function displayOrderItems(items) {
        // Log items data for debugging
        console.log('Order items:', items);
        
        const tbody = document.getElementById('orderItemsTableBody');
        tbody.innerHTML = '';
        
        if (!items || items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No items in this order.</td></tr>';
            return;
        }
        
        let subtotal = 0;
        
        // Safer processing of items
        items.forEach((item, index) => {
            try {
                console.log(`Processing item ${index}:`, item);
                
                // Default values if data is missing
                const productName = item.product_name || 'Unknown Product';
                const variantName = item.variant_name || 'N/A';
                const variantSku = item.variant_sku || '';
                const quantity = Number(item.quantity) || 0;
                
                // Handle price fields with multiple fallbacks
                let unitPrice = 0;
                if (item.unit_price) {
                    unitPrice = Number(item.unit_price);
                } else if (item.price) {
                    unitPrice = Number(item.price);
                }
                
                // Calculate total with fallbacks
                let itemTotal = 0;
                if (item.total_price) {
                    itemTotal = Number(item.total_price);
                } else {
                    itemTotal = unitPrice * quantity;
                }
                
                // Format for display
                const formattedPrice = unitPrice.toFixed(2);
                const formattedTotal = itemTotal.toFixed(2);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="align-middle">
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline-primary edit-quantity-btn" 
                                data-item-id="${item.id}" 
                                data-product-name="${productName}" 
                                data-current-quantity="${quantity}"
                                data-current-price="${unitPrice}"
                                data-current-variant-id="${item.variant_id || item.variant || ''}"
                                data-product-stock="${item.product_stock || 0}"
                                title="Edit Item Details">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-item-btn" 
                                data-item-id="${item.id}" 
                                data-product-name="${productName}"
                                title="Delete Item">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                    <td class="align-middle">${productName}</td>
                    <td class="align-middle">
                        ${variantName}
                        ${variantSku ? `<br><small class="text-muted">SKU: ${variantSku}</small>` : ''}
                    </td>
                    <td class="text-center align-middle">${quantity}</td>
                    <td class="text-end align-middle">$${formattedPrice}</td>
                    <td class="text-end align-middle">$${formattedTotal}</td>
                `;
                tbody.appendChild(tr);
                
                // Add to subtotal
                subtotal += itemTotal;
                console.log(`Added $${itemTotal} to subtotal, now: $${subtotal}`);
                
            } catch (error) {
                console.error(`Error rendering order item ${index}:`, error, item);
            }
        });
        
        // Add event listeners for edit and delete buttons
        document.querySelectorAll('.edit-quantity-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemId = this.dataset.itemId;
                const productName = this.dataset.productName;
                const currentQuantity = this.dataset.currentQuantity;
                const currentPrice = this.dataset.currentPrice;
                const currentVariantId = this.dataset.currentVariantId;
                const productStock = this.dataset.productStock;
                
                showEditQuantityModal(itemId, productName, currentQuantity, productStock, currentPrice, currentVariantId);
            });
        });
        
        document.querySelectorAll('.delete-item-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemId = this.dataset.itemId;
                const productName = this.dataset.productName;
                
                showDeleteItemConfirmation(itemId, productName);
            });
        });
        
        // Set subtotal
        document.getElementById('orderDetailSubtotal').textContent = `$${subtotal.toFixed(2)}`;
        
        // Get current order for shipping and tax info
        const currentOrder = window.currentOrderData;
        console.log('Current order for totals:', currentOrder);
        
        // Set shipping, tax, and grand total using order data
        const shipping = currentOrder && currentOrder.shipping_cost ? Number(currentOrder.shipping_cost) : 0;
        const tax = currentOrder && currentOrder.tax_amount ? Number(currentOrder.tax_amount) : 0;
        
        console.log(`Shipping: $${shipping}, Tax: $${tax}, Subtotal: $${subtotal}`);
        
        document.getElementById('orderDetailShipping').textContent = `$${shipping.toFixed(2)}`;
        document.getElementById('orderDetailTax').textContent = `$${tax.toFixed(2)}`;
        document.getElementById('orderDetailGrandTotal').textContent = `$${(subtotal + shipping + tax).toFixed(2)}`;
        
        // Update products list in the shipping address section
        const productsListElement = document.getElementById('orderProductsText');
        if (productsListElement && items && items.length > 0) {
            const productsList = items.map(item => {
                const quantity = Number(item.quantity) || 0;
                
                // Use the same logic as the sticker to get the display name
                let displayName;
                const possibleSkuFields = [
                    'variant_display_name',
                    'variant_sku', 
                    'sku',
                    'product_variant_sku',
                    'variant_code'
                ];
                
                let skuFound = false;
                for (let field of possibleSkuFields) {
                    if (item[field] && typeof item[field] === 'string' && item[field].trim() !== '') {
                        displayName = item[field].trim();
                        skuFound = true;
                        break;
                    }
                }
                
                if (!skuFound && item.variant_name && typeof item.variant_name === 'string' && item.variant_name.trim() !== '') {
                    displayName = item.variant_name.trim();
                } else if (!skuFound && item.product_name && typeof item.product_name === 'string' && item.product_name.trim() !== '') {
                    displayName = item.product_name.trim();
                } else if (!skuFound) {
                    displayName = 'Unknown Product';
                }
                
                return `${displayName}  ${quantity}`;
            });
            
            productsListElement.textContent = productsList.join(', ');
        }
    }
    
    // Courier Sticker Functions
    function showCourierStickerModal(orderId) {
        console.log(`Showing courier sticker for order ID: ${orderId}`);
        
        // Find the order data
        const order = orders.find(o => o.id == orderId);
        if (!order) {
            console.error('Order not found:', orderId);
            showAlert('Order not found', 'danger');
            return;
        }
        
        if (!order.curier_id) {
            showAlert('This order has not been added to courier service yet.', 'warning');
            return;
        }
        
        // Set order number in modal
        document.getElementById('stickerOrderNumber').textContent = order.order_number;
        
        // Get customer name from shipping address
        let customerName = 'Guest Customer';
        if (order.shipping_address) {
            const firstName = order.shipping_address.first_name || '';
            const lastName = order.shipping_address.last_name || '';
            customerName = `Name: ${firstName} ${lastName}`.trim() || 'Guest Customer';
        }
        document.getElementById('stickerCustomerName').textContent = customerName;
        
        // Set courier ID and generate barcode
        // document.getElementById('stickerCourierId').textContent = `ID: ${order.curier_id}`;
        document.getElementById('stickerCourierIdSmall').textContent = `ID: ${order.curier_id}`;
        
        // Generate real barcode using JsBarcode
        generateRealBarcode(order.curier_id);
        
        // Load order items to populate products list
        loadOrderItemsForSticker(orderId);
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('courierStickerModal'));
        modal.show();
    }
    
    function loadOrderItemsForSticker(orderId) {
        // Show loading text
        document.getElementById('stickerProducts').innerHTML = '<small>Loading products...</small>';
        
        fetch(`/mb-admin/api/orders/${orderId}/items/`)
            .then(response => response.json())
            .then(items => {
                if (Array.isArray(items) && items.length > 0) {
                    const productLines = items.map(item => {
                        // Extended debug logging to see all available fields
                        console.log('FULL Item data for sticker:', item);
                        console.log('Available fields:', Object.keys(item));
                        console.log('Specific fields:', {
                            variant_sku: item.variant_sku,
                            variant_name: item.variant_name,
                            product_name: item.product_name,
                            sku: item.sku,
                            variant: item.variant,
                            product_variant_sku: item.product_variant_sku
                        });
                        
                        // Try multiple possible field names for the SKU
                        let displayName;
                        
                        // Check all possible SKU field names
                        const possibleSkuFields = [
                            'variant_display_name',  // New field with full SKU or variant name
                            'variant_sku',
                            'sku', 
                            'product_variant_sku',
                            'variant_code'
                        ];
                        
                        let skuFound = false;
                        for (let field of possibleSkuFields) {
                            if (item[field] && typeof item[field] === 'string' && item[field].trim() !== '') {
                                displayName = item[field].trim();
                                console.log(`Using ${field}:`, displayName);
                                skuFound = true;
                                break;
                            }
                        }
                        
                        // If no SKU found, try variant_name
                        if (!skuFound && item.variant_name && typeof item.variant_name === 'string' && item.variant_name.trim() !== '') {
                            displayName = item.variant_name.trim();
                            console.log('Using variant_name:', displayName);
                        } 
                        // If still no luck, try product_name
                        else if (!skuFound && item.product_name && typeof item.product_name === 'string' && item.product_name.trim() !== '') {
                            displayName = item.product_name.trim();
                            console.log('Using product_name:', displayName);
                        } 
                        // Last resort
                        else if (!skuFound) {
                            displayName = 'UNKNOWN';
                            console.log('Using fallback: UNKNOWN');
                        }
                        
                        const quantity = item.quantity || 1;
                        
                        // Format the product line with better display
                        if (displayName.includes('-') || displayName.includes(' ')) {
                            // If it's a proper SKU format, use it as is
                            return `${displayName}  ${quantity}`;
                        } else {
                            // If it's just a name, add some context
                            return `${item.product_name || displayName} (${displayName})  ${quantity}`;
                        }
                    });
                    
                    // Join with line breaks for better readability in the sticker
                    document.getElementById('stickerProducts').innerHTML = productLines.join('<br>');
                } else {
                    document.getElementById('stickerProducts').innerHTML = '<small>No products found</small>';
                }
            })
            .catch(error => {
                console.error('Error loading order items for sticker:', error);
                document.getElementById('stickerProducts').innerHTML = '<small>Error loading products</small>';
            });
    }
    
    function generateRealBarcode(courierId) {
        try {
            const canvas = document.getElementById('stickerBarcodeCanvas');
            if (canvas && window.JsBarcode) {
                // Generate Code128 barcode
                JsBarcode(canvas, courierId.toString(), {
                    format: "CODE128",
                    width: 1,
                    height: 20,
                    displayValue: false,
                    background: "#ffffff",
                    lineColor: "#000000",
                    margin: 2
                });
            } else {
                console.warn('JsBarcode library not loaded or canvas not found');
                // Fallback to simple text representation
                document.getElementById('stickerBarcodeCanvas').style.display = 'none';
            }
        } catch (error) {
            console.error('Error generating barcode:', error);
            // Hide canvas on error
            document.getElementById('stickerBarcodeCanvas').style.display = 'none';
        }
    }
    
    function generateBarcode(courierId) {
        // Fallback function for old-style barcode (kept for compatibility)
        const barcodeChars = courierId.toString().split('');
        let barcode = '';
        
        // Add start pattern
        barcode += '|| ';
        
        // Convert each digit to barcode pattern
        barcodeChars.forEach(char => {
            switch(char) {
                case '0': barcode += '||| '; break;
                case '1': barcode += '||  '; break;
                case '2': barcode += '| | '; break;
                case '3': barcode += '|  |'; break;
                case '4': barcode += ' |||'; break;
                case '5': barcode += ' || '; break;
                case '6': barcode += ' | |'; break;
                case '7': barcode += '  ||'; break;
                case '8': barcode += '|||  '; break;
                case '9': barcode += '|| | '; break;
                default: barcode += '| | '; break;
            }
        });
        
        // Add end pattern
        barcode += ' ||';
        
        return barcode;
    }
    
    function printCourierSticker() {
        // Clone the sticker element
        const originalSticker = document.getElementById('courierSticker');
        const stickerClone = originalSticker.cloneNode(true);
        
        // Add print class
        stickerClone.classList.add('courier-sticker-print');
        stickerClone.removeAttribute('id');
        
        // Update barcode canvas ID to avoid conflicts
        const barcodeCanvas = stickerClone.querySelector('#stickerBarcodeCanvas');
        if (barcodeCanvas) {
            barcodeCanvas.id = 'printBarcodeCanvas';
        }
        
        // Create a new window for printing
        const printWindow = window.open('', '_blank', 'width=400,height=200');
        
        // Write the content to print window
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Courier Sticker</title>
                <style>
                    @page {
                        size: 2in 0.95in;
                        margin: 0;
                    }
                    
                    body {
                        margin: 0;
                        padding: 0;
                        font-family: Arial, sans-serif;
                    }
                    
                    .courier-sticker-print {
                        width: 2in !important;
                        height: 0.9in !important;
                        background: white;
                        border: 1px solid #333;
                        border-radius: 4px;
                        display: flex;
                        flex-direction: column;
                        font-size: 8px;
                        line-height: 1.0;
                        overflow: hidden;
                        padding: 3px;
                        -webkit-print-color-adjust: exact;
                        print-color-adjust: exact;
                        page-break-inside: avoid;
                    }
                    
                    .sticker-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        margin-bottom: 2px;
                        height: 0.18in;
                        min-height: 0.18in;
                    }
                    
                    .logo-section {
                        flex: 1;
                    }
                    
                    .sticker-logo {
                        max-width: 80px;
                        max-height: 25px;
                        object-fit: contain;
                    }
                    
                    .logo-fallback {
                        font-weight: bold;
                        font-size: 12px;
                        color: #333;
                        background: #f0f0f0;
                        border-radius: 50%;
                        width: 25px;
                        height: 25px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    
                    .barcode-section {
                        text-align: right;
                        flex: 1;
                    }
                    
                    .barcode-canvas {
                        max-width: 150px;
                        height: 18px;
                        border: 1px solid #ccc;
                        display: block;
                        margin-left: auto;
                    }
                    
                    .courier-id-small {
                        font-size: 10px;
                        font-weight: bold;
                        color: #333;
                        text-align: right;
                        margin-top: 2px;
                    }
                    
                    .sticker-content {
                        flex: 1;
                        display: flex;
                        flex-direction: column;
                        gap: 1px;
                        min-height: 0;
                        overflow: hidden;
                        margin-top: 12px;
                    }
                    
                    .customer-name {
                        font-size: 10px;
                        font-weight: 400;
                        color: #333;
                        line-height: 1.1;
                    }
                    
                    .courier-id-main {
                        font-size: 10px;
                        font-weight: bold;
                        color: #333;
                    }
                    
                    .products-list {
                        font-size: 7px;
                        color: #555;
                        line-height: 1.2;
                        flex: 1;
                    }
                    
                    .sticker-footer {
                        margin-top: auto;
                        padding-top: 1px;
                        border-top: 0.5px solid #000;
                        flex-shrink: 0;
                        min-height: 0.12in;
                        max-height: 0.12in;
                    }
                    
                    .contact-row {
                        display: flex;
                        justify-content: space-between;
                        font-size: 7px;
                        color: #333;
                        line-height: 1.0;
                        white-space: nowrap;
                        overflow: hidden;
                    }
                        color: #666;
                        line-height: 1.1;
                    }
                    
                    .website, .phone {
                        flex: 1;
                    }
                    
                    .phone {
                        text-align: right;
                    }
                </style>
            </head>
            <body>
                ${stickerClone.outerHTML}
            </body>
            </html>
        `);
        
        printWindow.document.close();
        
        // Wait for content to load, then regenerate barcode and print
        printWindow.onload = function() {
            // Regenerate barcode in print window if JsBarcode is available
            if (window.JsBarcode) {
                const printCanvas = printWindow.document.getElementById('printBarcodeCanvas');
                const originalCanvas = document.getElementById('stickerBarcodeCanvas');
                if (printCanvas && originalCanvas) {
                    // Copy the barcode from original canvas
                    const originalData = originalCanvas.toDataURL();
                    const img = new Image();
                    img.onload = function() {
                        const ctx = printCanvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, printCanvas.width, printCanvas.height);
                        setTimeout(() => {
                            printWindow.print();
                            printWindow.close();
                        }, 100);
                    };
                    img.src = originalData;
                } else {
                    setTimeout(() => {
                        printWindow.print();
                        printWindow.close();
                    }, 250);
                }
            } else {
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 250);
            }
        };
    }
    
    // Order actions
    function updateOrderStatus(orderId, newStatus) {
        const notifyCustomer = document.getElementById('notifyCustomerCheck').checked;
        const comment = document.getElementById('statusChangeComment').value.trim();
        const courierCharge = document.getElementById('courierChargeInput').value.trim();
        
        // Check if we need to validate the partially refunded amount
        let partiallyRefundedAmount = null;
        if (newStatus === 'partially_returned') {
            partiallyRefundedAmount = document.getElementById('partiallyRefundedInput').value.trim();
            
            // Validate that an amount is provided for partially_returned status
            if (!partiallyRefundedAmount) {
                document.getElementById('partiallyRefundedError').style.display = 'block';
                return; // Stop execution if validation fails
            } else {
                document.getElementById('partiallyRefundedError').style.display = 'none';
            }
        }
        
        console.log(`Updating order ${orderId} status to ${newStatus}`);
        console.log('CSRF Token:', getCookie('csrftoken'));
        
        const requestData = {
            status: newStatus,
            notify_customer: notifyCustomer,
            comment: comment
        };
        
        // Add courier charge if provided
        if (courierCharge) {
            requestData.curier_charge = parseFloat(courierCharge);
        }
        
        // Add partially refunded amount if applicable
        if (partiallyRefundedAmount) {
            requestData.partially_ammount = parseFloat(partiallyRefundedAmount);
        }
        
        console.log('Request data:', requestData);
        
        // Get the modal element reference for later cleanup
        const statusChangeModalElement = document.getElementById('statusChangeModal');
        
        fetch(`/mb-admin/api/orders/${orderId}/update_status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',  // Include cookies in the request
            body: JSON.stringify(requestData)
        })
        .then(response => {
            console.log('Update status response:', response.status);
            
            // Clone response to read it for debugging
            response.clone().text().then(text => {
                console.log('Raw update status response:', text);
                try {
                    const jsonData = JSON.parse(text);
                    console.log('Parsed update status response:', jsonData);
                } catch (err) {
                    console.log('Response is not JSON');
                }
            });
            
            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('Permission denied. CSRF token might be missing or invalid.');
                } else {
                    return response.text().then(text => {
                        throw new Error(`Failed to update status: ${text || response.statusText}`);
                    });
                }
            }
            return response.json();
        })
        .then(data => {
            console.log('Update successful, response data:', data);
            
            // Update status in UI
            document.getElementById('orderDetailStatus').textContent = formatStatusName(newStatus);
            
            // Update status badge class
            const statusElement = document.getElementById('orderDetailStatus');
            let statusBadgeClass;
            switch (newStatus.toLowerCase()) {
                case 'pending':
                    statusBadgeClass = 'bg-warning text-dark';
                    break;
                case 'processing':
                    statusBadgeClass = 'bg-info';
                    break;
                case 'shipped':
                    statusBadgeClass = 'bg-primary';
                    break;
                case 'delivered':
                    statusBadgeClass = 'bg-success';
                    break;
                case 'returned':
                    statusBadgeClass = 'bg-orange';
                    break;
                case 'partially_returned':
                    statusBadgeClass = 'bg-brown';
                    break;
                case 'cancelled':
                    statusBadgeClass = 'bg-danger';
                    break;
                default:
                    statusBadgeClass = 'bg-secondary';
            }
            statusElement.className = `badge ${statusBadgeClass}`;
            
            // Clean up the modal properly using our helper function
            cleanupModal(statusChangeModalElement);
            
            // Refresh orders list in background
            loadOrders(currentPage);
            
            // Show success notification with SweetAlert2 - use backend message if available
            const successMessage = data.message || `Order status has been changed to ${formatStatusName(newStatus)} with stock management applied`;
            Swal.fire({
                title: 'Status Updated',
                text: successMessage,
                icon: 'success',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 5000,
                timerProgressBar: true
            });
        })
        .catch(error => {
            console.error('Error updating order status:', error);
            showAlert(`Failed to update order status: ${error.message}`, 'danger');
            
            // Ensure modal is closed properly even on error
            cleanupModal(statusChangeModalElement);
        });
    }
    
    // Function removed: sendInvoiceEmail
    
    // Helper function to restock items when order is returned, partially returned, or cancelled
    function restockOrderItems(orderId, statusType) {
        console.log(`Restocking items for order ${orderId} due to ${statusType} status`);
        
        // Make API call to restock items
        fetch(`/mb-admin/api/orders/${orderId}/restock/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',
            body: JSON.stringify({ 
                status_type: statusType,
                // For partially_returned, we'd need to specify which items are returned
                // This simple implementation restocks all items
                restock_all: (statusType === 'returned' || statusType === 'cancelled')
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`Failed to restock items: ${text || response.statusText}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Restock successful:', data);
            // Show a notification about restocked items
            Swal.fire({
                title: 'Items Restocked',
                text: `Inventory has been updated for returned/cancelled items.`,
                icon: 'info',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 4000
            });
        })
        .catch(error => {
            console.error('Error restocking items:', error);
            showAlert(`Failed to restock items: ${error.message}`, 'warning');
        });
    }
    
    // Helper function to properly clean up a modal
    function cleanupModal(modalElement) {
        // Special handling for orderDetailsModal
        if (modalElement.id === 'orderDetailsModal' && orderDetailsModalInstance) {
            orderDetailsModalInstance.hide();
            orderDetailsModalInstance = null;
        } else {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
        }
        
        // Remove backdrop manually if it's still there
        setTimeout(() => {
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // Also remove any body classes that Bootstrap might have added
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }, 300);
    }
    
    function deleteOrder(orderId) {
        console.log(`Attempting to delete order ID: ${orderId}`);
        console.log('CSRF Token:', getCookie('csrftoken'));
        
        // Reference the modal element
        const orderModalElement = document.getElementById('orderDetailsModal');
        
        fetch(`/mb-admin/api/orders/${orderId}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin'  // Include cookies in the request
        })
        .then(response => {
            console.log('Delete response status:', response.status);
            
            // Clone response to read it for debugging
            response.clone().text().then(text => {
                console.log('Raw delete response:', text);
                try {
                    const jsonData = JSON.parse(text);
                    console.log('Parsed delete response:', jsonData);
                } catch (err) {
                    console.log('Response is not JSON');
                }
            });
            
            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('Permission denied. CSRF token might be missing or invalid.');
                } else if (response.status === 500) {
                    // Handle 500 internal server error separately to provide more useful information
                    return response.text().then(text => {
                        if (text.includes('no such table')) {
                            // Handle database table missing error
                            const errorMessage = 'Database table missing. The order will be deleted, but activity logging might fail.';
                            console.warn(errorMessage);
                            
                            // Close the modal properly even though there was an error
                            cleanupModal(orderModalElement);
                            
                            // Refresh orders list in case the delete actually worked
                            loadOrders(currentPage);
                            
                            showAlert('Order might have been deleted, but there was a database error. Please verify.', 'warning');
                            return; // Return early to avoid throwing error
                        }
                        throw new Error(`Failed to delete order: ${text || response.statusText}`);
                    });
                } else {
                    return response.text().then(text => {
                        throw new Error(`Failed to delete order: ${text || response.statusText}`);
                    });
                }
            }
            
            // Hide the modal properly using our cleanup function
            cleanupModal(orderModalElement);
            
            // Refresh orders list
            loadOrders(currentPage);
            
            // Show success notification with SweetAlert2
            Swal.fire({
                title: 'Deleted!',
                text: 'The order has been deleted successfully and stock has been restored.',
                icon: 'success',
                confirmButtonColor: '#28a745'
            });
        })
        .catch(error => {
            console.error('Error deleting order:', error);
            showAlert(`Failed to delete order: ${error.message}`, 'danger');
            
            // Ensure modal is closed properly even on error
            cleanupModal(orderModalElement);
        });
    }
    
    // Fraud Check Functions
    function performFraudChecks(orders) {
        // Create a map to track unique phone numbers to avoid duplicate API calls
        const phoneNumberMap = new Map();
        const fraudContainers = document.querySelectorAll('.fraud-check-container');
        
        fraudContainers.forEach(container => {
            const phone = container.dataset.phone;
            const orderId = container.dataset.orderId;
            
            if (phone && phone.trim()) {
                const cleanPhone = phone.trim();
                if (!phoneNumberMap.has(cleanPhone)) {
                    phoneNumberMap.set(cleanPhone, []);
                }
                phoneNumberMap.get(cleanPhone).push({container, orderId});
            } else {
                // Show no phone available
                container.innerHTML = `
                    <div class="fraud-error" title="No phone number available">
                        <i class="fas fa-exclamation-circle"></i>
                        No phone
                    </div>
                `;
            }
        });
        
        // Perform fraud checks for unique phone numbers
        phoneNumberMap.forEach((containers, phone) => {
            performFraudCheck(phone, containers);
        });
    }
    
    async function performFraudCheck(phoneNumber, containers) {
        try {
            const response = await fetch('/mb-admin/api/fraud-check/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    phone_number: phoneNumber
                })
            });
            
            const data = await response.json();
            
            if (data.success && data.summary) {
                // Update all containers with the same phone number
                containers.forEach(({container, orderId}) => {
                    updateFraudDisplay(container, data, phoneNumber);
                });
            } else {
                containers.forEach(({container}) => {
                    container.innerHTML = `
                        <div class="fraud-error" title="${data.error || 'Failed to check fraud status'}">
                            <i class="fas fa-exclamation-triangle"></i>
                            Check failed
                        </div>
                    `;
                });
            }
        } catch (error) {
            console.error('Fraud check error:', error);
            containers.forEach(({container}) => {
                container.innerHTML = `
                    <div class="fraud-error" title="Network error occurred">
                        <i class="fas fa-wifi" style="text-decoration: line-through;"></i>
                        Network error
                    </div>
                `;
            });
        }
    }
    
    function updateFraudDisplay(container, fraudData, phoneNumber) {
        const summary = fraudData.summary;
        const totalParcels = summary.total_parcels || 0;
        const totalDelivered = summary.total_delivered || 0;
        const totalCancelled = summary.total_cancelled || 0;
        
        if (totalParcels === 0) {
            container.innerHTML = `
                <div style="text-align: center; color: #6c757d; font-size: 10px;">
                    <i class="fas fa-info-circle"></i>
                    <div>No history</div>
                </div>
            `;
            return;
        }
        
        const deliveredPercentage = Math.round((totalDelivered / totalParcels) * 100);
        const cancelledPercentage = Math.round((totalCancelled / totalParcels) * 100);
        
        container.innerHTML = `
            <div class="fraud-progress-bar">
                <div class="fraud-delivered-fill" style="width: ${deliveredPercentage}%; color:white; position: absolute; left: 0; top: 0; height: 100%; display: flex; align-items: center; padding-left: 4px;">
                    ${deliveredPercentage > 15 ? deliveredPercentage + '%' : ''}
                </div>
                <div class="fraud-cancelled-fill" style="width: ${cancelledPercentage}%; position: absolute; right: 0; top: 0; height: 100%; display: flex; align-items: center; justify-content: end; padding-right: 4px;">
                    ${cancelledPercentage > 15 ? cancelledPercentage + '%' : ''}
                </div>
            </div>
            <div class="fraud-count-label"><span style="color: green;">${totalDelivered}</span> / <span style="color: red;">${totalCancelled}</span> (${totalParcels})</div>
        `;
        
        // Add click handler to show detailed popup
        container.style.cursor = 'pointer';
        container.addEventListener('click', function() {
            showFraudDetailsModal(fraudData, phoneNumber);
        });
    }
    
    function showFraudDetailsModal(fraudData, phoneNumber) {
        // Create a modal to show detailed fraud information
        const modalHtml = `
            <div class="modal fade" id="fraudDetailsModal" tabindex="-1" aria-labelledby="fraudDetailsModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="fraudDetailsModalLabel">
                                <i class="fas fa-shield-alt me-2"></i>Fraud Check Details - ${phoneNumber}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            ${generateFraudDetailsContent(fraudData)}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove any existing fraud modal
        const existingModal = document.getElementById('fraudDetailsModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add the modal to the page
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('fraudDetailsModal'));
        modal.show();
        
        // Clean up modal when hidden
        document.getElementById('fraudDetailsModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }
    
    function generateFraudDetailsContent(fraudData) {
        const summary = fraudData.summary;
        const couriers = fraudData.couriers;
        
        let content = `
            <div class="mb-4">
                <h6 class="text-primary"><i class="fas fa-chart-bar me-2"></i>Summary</h6>
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center p-3 bg-light rounded">
                            <h4 class="text-primary mb-1">${summary.total_parcels || 0}</h4>
                            <small class="text-muted">Total Parcels</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 bg-light rounded">
                            <h4 class="text-success mb-1">${summary.total_delivered || 0}</h4>
                            <small class="text-muted">Delivered</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 bg-light rounded">
                            <h4 class="text-danger mb-1">${summary.total_cancelled || 0}</h4>
                            <small class="text-muted">Cancelled</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center p-3 bg-light rounded">
                            <h4 class="text-warning mb-1">${summary.cancellation_rate || 0}%</h4>
                            <small class="text-muted">Cancel Rate</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mb-4">
                <h6 class="text-primary"><i class="fas fa-truck me-2"></i>Courier Details</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Courier</th>
                                <th>Status</th>
                                <th>Total Parcels</th>
                                <th>Delivered</th>
                                <th>Cancelled</th>
                                <th>Risk Level</th>
                                <th>Fraud Score</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        // Add courier details
        Object.entries(couriers).forEach(([courierKey, courierData]) => {
            const statusBadge = courierData.success 
                ? '<span class="badge bg-success">Success</span>'
                : '<span class="badge bg-danger">Failed</span>';
            
            const riskBadge = courierData.success 
                ? `<span class="badge bg-${courierData.risk_color || 'secondary'}">${courierData.risk_level || 'Unknown'}</span>`
                : '<span class="badge bg-secondary">N/A</span>';
            
            content += `
                <tr>
                    <td><strong>${courierData.courier_name || courierKey.charAt(0).toUpperCase() + courierKey.slice(1)}</strong></td>
                    <td>${statusBadge}</td>
                    <td>${courierData.total_parcels || 0}</td>
                    <td class="text-success">${courierData.total_delivered || 0}</td>
                    <td class="text-danger">${courierData.total_cancelled || 0}</td>
                    <td>${riskBadge}</td>
                    <td>${courierData.fraud_score || 0}</td>
                </tr>
            `;
        });
        
        content += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        return content;
    }
    
    // ============================================
    // AUTOMATIC COURIER STATUS MONITORING SYSTEM
    // ============================================
    
    // Monitor shipped orders for status updates
    function monitorCourierStatus(orders) {
        console.log(' Starting courier status monitoring...');
        
        // Filter orders that are shipped and have courier IDs
        const shippedOrders = orders.filter(order => 
            order.status === 'shipped' && 
            order.curier_id && 
            order.curier_id.trim() !== ''
        );
        
        console.log(` Found ${shippedOrders.length} shipped orders with courier IDs`);
        
        // Update monitoring status
        updateMonitoringStatus('active', shippedOrders.length);
        
        // Check status for each shipped order
        shippedOrders.forEach(order => {
            checkCourierStatusForOrder(order);
        });
    }
    
    async function checkCourierStatusForOrder(order) {
        const courierId = order.curier_id;
        console.log(` Checking courier status for order ${order.order_number} with courier ID: ${courierId}`);
        
        try {
            // Use the backend API endpoint that handles authentication
            const response = await fetch(`/mb-admin/api/orders/${order.id}/check_courier_status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            console.log(` Backend API Response Status: ${response.status} for order ${order.order_number}`);
            
            if (!response.ok) {
                const errorData = await response.json();
                console.warn(` Failed to check courier status for order ${order.order_number}: ${errorData.error}`);
                
                if (response.status === 400 && errorData.error.includes('API')) {
                    console.warn(` Courier API issue: ${errorData.error}`);
                } else {
                    console.warn(` Backend error: ${errorData.error}`);
                }
                return;
            }
            
            const result = await response.json();
            console.log(` Courier check result for order ${order.order_number}:`, result);
            
            // Update local order data if status changed
            if (result.order_status !== order.status) {
                console.log(` Order ${order.order_number} status updated: ${order.status}  ${result.order_status}`);
                order.status = result.order_status;
                
                // Show success notification if delivered
                if (result.is_delivered) {
                    showNotification('success', `Order ${order.order_number} automatically updated to delivered!`);
                    
                    // Refresh the orders table to show updated status
                    setTimeout(() => {
                        loadOrders(currentPage);
                        loadOrderCounts();
                    }, 1000);
                }
            }
            
            // Update courier status
            if (result.courier_status && result.courier_status !== order.curier_status) {
                console.log(` Courier status updated for order ${order.order_number}: ${order.curier_status}  ${result.courier_status}`);
                order.curier_status = result.courier_status;
            }
            
        } catch (error) {
            console.error(` Error checking courier status for order ${order.order_number}:`, error);
            
            // Provide helpful debug information
            if (error.name === 'TypeError' && error.message.includes('fetch')) {
                console.error(` Network error - check internet connection`);
            } else if (error.name === 'SyntaxError') {
                console.error(` JSON parsing error - backend response may not be valid JSON`);
            }
        }
    }
    
    async function processCourierStatus(order, courierData) {
        // Check if the courier status indicates delivery
        const isDelivered = checkIfDelivered(courierData);
        
        if (isDelivered && order.status === 'shipped') {
            console.log(` Order ${order.order_number} has been delivered according to courier. Updating status...`);
            
            // Update order status to delivered
            await updateOrderStatusToDelivered(order.id, courierData);
        } else {
            console.log(` Order ${order.order_number} courier status: ${getCourierStatusDescription(courierData)}`);
            
            // Update courier status in the order record
            await updateCourierStatus(order.id, courierData);
        }
    }
    
    function checkIfDelivered(courierData) {
        console.log(` Checking if delivered with data:`, courierData);
        
        // Check various possible fields that might indicate delivery
        const status = courierData.status || courierData.delivery_status || courierData.order_status;
        const statusText = (status || '').toString().toLowerCase();
        
        console.log(` Status value: "${status}", Status text: "${statusText}"`);
        
        // Common delivery status indicators
        const deliveryKeywords = [
            'delivered',
            'delivery_completed',
            'completed',
            'success',
            'delivered_successfully'
        ];
        
        const isDelivered = deliveryKeywords.some(keyword => {
            const matches = statusText.includes(keyword);
            if (matches) {
                console.log(` Found delivery keyword: "${keyword}" in "${statusText}"`);
            }
            return matches;
        });
        
        console.log(` Final delivery decision: ${isDelivered}`);
        return isDelivered;
    }
    
    function getCourierStatusDescription(courierData) {
        return courierData.status || 
               courierData.delivery_status || 
               courierData.order_status || 
               'Unknown status';
    }
    
    async function updateOrderStatusToDelivered(orderId, courierData) {
        try {
            console.log(` Updating order ${orderId} status to delivered...`);
            
            const response = await fetch(`/mb-admin/api/orders/${orderId}/update_status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    status: 'delivered',
                    notify_customer: true,
                    comment: `Automatically updated to delivered based on courier status: ${getCourierStatusDescription(courierData)}`
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log(` Successfully updated order ${orderId} to delivered:`, result);
                
                // Show success notification
                showNotification('success', `Order automatically updated to delivered based on courier status!`);
                
                // Refresh the orders table to show updated status
                setTimeout(() => {
                    loadOrders(currentPage);
                    loadOrderCounts();
                }, 1000);
                
            } else {
                const errorData = await response.json();
                console.error(` Failed to update order ${orderId} status:`, errorData);
                showNotification('error', `Failed to auto-update order status: ${errorData.error || 'Unknown error'}`);
            }
            
        } catch (error) {
            console.error(` Error updating order ${orderId} status:`, error);
            showNotification('error', `Error auto-updating order status: ${error.message}`);
        }
    }
    
    async function updateCourierStatus(orderId, courierData) {
        try {
            const newCourierStatus = getCourierStatusDescription(courierData);
            console.log(` Updating courier status for order ${orderId} to: ${newCourierStatus}`);
            
            // Call the backend API to update courier status
            const response = await fetch(`/mb-admin/api/orders/${orderId}/update_courier_status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    curier_status: newCourierStatus,
                    courier_data: courierData
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log(` Successfully updated courier status for order ${orderId}:`, result);
            } else {
                console.warn(` Failed to update courier status for order ${orderId}`);
            }
            
        } catch (error) {
            console.error(` Error updating courier status for order ${orderId}:`, error);
        }
    }
    
    function showNotification(type, message) {
        // Use SweetAlert2 for notifications
        const icon = type === 'success' ? 'success' : 'error';
        const title = type === 'success' ? 'Success!' : 'Error!';
        
        Swal.fire({
            title: title,
            text: message,
            icon: icon,
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 5000,
            timerProgressBar: true
        });
    }
    
    // Auto-monitor courier status every 30 seconds for shipped orders
    let courierMonitoringInterval;
    
    function startCourierMonitoring() {
        console.log(' Starting automatic courier status monitoring (30-second intervals)...');
        
        // Update status to initializing
        updateMonitoringStatus('initializing');
        
        // Clear any existing interval
        if (courierMonitoringInterval) {
            clearInterval(courierMonitoringInterval);
        }
        
        // Start monitoring
        courierMonitoringInterval = setInterval(() => {
            // Only monitor if we have orders loaded and there are shipped orders
            if (orders && orders.length > 0) {
                const shippedOrders = orders.filter(order => 
                    order.status === 'shipped' && order.curier_id
                );
                
                if (shippedOrders.length > 0) {
                    console.log(` Auto-checking ${shippedOrders.length} shipped orders...`);
                    monitorCourierStatus(orders);
                } else {
                    // No shipped orders to monitor
                    updateMonitoringStatus('active', 0);
                }
            } else {
                updateMonitoringStatus('active', 0);
            }
        }, 30000); // 30 seconds
        
        // Update toggle button
        const toggleBtn = document.getElementById('toggleCourierMonitoring');
        if (toggleBtn) {
            toggleBtn.innerHTML = '<i class="fas fa-pause me-1"></i> Pause Monitoring';
            toggleBtn.classList.remove('btn-outline-success');
            toggleBtn.classList.add('btn-outline-warning');
        }
    }
    
    function stopCourierMonitoring() {
        if (courierMonitoringInterval) {
            console.log(' Stopping courier status monitoring...');
            clearInterval(courierMonitoringInterval);
            courierMonitoringInterval = null;
            updateMonitoringStatus('stopped');
        }
    }
    
    // Toggle courier monitoring on/off
    function toggleCourierMonitoring() {
        const toggleBtn = document.getElementById('toggleCourierMonitoring');
        
        if (courierMonitoringInterval) {
            // Currently running, so stop it
            stopCourierMonitoring();
            toggleBtn.innerHTML = '<i class="fas fa-play me-1"></i> Start Monitoring';
            toggleBtn.classList.remove('btn-outline-warning');
            toggleBtn.classList.add('btn-outline-success');
        } else {
            // Currently stopped, so start it
            startCourierMonitoring();
            toggleBtn.innerHTML = '<i class="fas fa-pause me-1"></i> Pause Monitoring';
            toggleBtn.classList.remove('btn-outline-success');
            toggleBtn.classList.add('btn-outline-warning');
        }
    }
    
    // Update monitoring status indicator
    function updateMonitoringStatus(status, shippedCount = 0) {
        const indicator = document.getElementById('courierMonitorIndicator');
        const text = document.getElementById('courierMonitorText');
        const stats = document.getElementById('courierStats');
        const shippedCountSpan = document.getElementById('shippedOrdersBeingMonitored');
        
        // Remove all status classes
        indicator.classList.remove('active', 'paused', 'error');
        
        switch (status) {
            case 'active':
                indicator.classList.add('active');
                text.textContent = 'Courier Monitoring: Active';
                text.style.color = '#28a745';
                stats.style.display = 'inline-block';
                shippedCountSpan.textContent = shippedCount;
                break;
                
            case 'paused':
                indicator.classList.add('paused');
                text.textContent = 'Courier Monitoring: Paused';
                text.style.color = '#ffc107';
                stats.style.display = 'none';
                break;
                
            case 'stopped':
                text.textContent = 'Courier Monitoring: Stopped';
                text.style.color = '#6c757d';
                stats.style.display = 'none';
                break;
                
            case 'error':
                indicator.classList.add('error');
                text.textContent = 'Courier Monitoring: Error';
                text.style.color = '#dc3545';
                stats.style.display = 'none';
                break;
                
            case 'initializing':
            default:
                text.textContent = 'Courier Monitoring: Initializing...';
                text.style.color = '#6c757d';
                stats.style.display = 'none';
                break;
        }
    }
    
    // ============================================
    // COURIER MONITORING DEBUG FUNCTIONS
    // ============================================
    
    // Manual test function for debugging courier status
    async function testCourierStatus(courierId) {
        console.log(` Testing courier status for ID: ${courierId}`);
        
        try {
            const response = await fetch(`https://portal.packzy.com/api/v1/status_by_cid/${courierId}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });
            
            console.log(` API Response Status: ${response.status}`);
            
            if (!response.ok) {
                console.warn(` API returned error status: ${response.status}`);
                const errorText = await response.text();
                console.warn(` Error response: ${errorText}`);
                return { error: true, status: response.status, message: errorText };
            }
            
            const courierData = await response.json();
            console.log(` Courier data:`, courierData);
            
            // Check if this indicates delivery
            const isDelivered = checkIfDelivered(courierData);
            console.log(` Is delivered: ${isDelivered}`);
            
            return { error: false, data: courierData, isDelivered };
            
        } catch (error) {
            console.error(` Error testing courier status:`, error);
            return { error: true, message: error.message };
        }
    }
    
    // Enhanced delivery detection with more logging
    function checkIfDelivered(courierData) {
        console.log(` Checking if delivered with data:`, courierData);
        
        // Check various possible fields that might indicate delivery
        const status = courierData.status || courierData.delivery_status || courierData.order_status;
        const statusText = (status || '').toString().toLowerCase();
        
        console.log(` Status value: "${status}", Status text: "${statusText}"`);
        
        // Common delivery status indicators
        const deliveryKeywords = [
            'delivered',
            'delivery_completed',
            'completed',
            'success',
            'delivered_successfully'
        ];
        
        const isDelivered = deliveryKeywords.some(keyword => {
            const matches = statusText.includes(keyword);
            if (matches) {
                console.log(` Found delivery keyword: "${keyword}" in "${statusText}"`);
            }
            return matches;
        });
        
        console.log(` Final delivery decision: ${isDelivered}`);
        return isDelivered;
    }
    
    // Add to window for browser console access
    window.testCourierStatus = testCourierStatus;
    
    // Manual check function for button
    function manualMonitorCheck() {
        console.log(' Manual courier monitoring check triggered...');
        if (orders && orders.length > 0) {
            monitorCourierStatus(orders);
        } else {
            console.warn(' No orders loaded for monitoring check');
        }
    }
    
    // Add to window for button access
    window.manualMonitorCheck = manualMonitorCheck;
    window.toggleCourierMonitoring = toggleCourierMonitoring;
    
    // Manual override function for testing delivery status update
    async function manualDeliveryTest(orderNumber) {
        console.log(` Manual delivery test for order ${orderNumber}`);
        
        const order = orders.find(o => o.order_number === orderNumber);
        if (!order) {
            console.error(` Order ${orderNumber} not found`);
            return;
        }
        
        // Simulate delivered courier data
        const mockCourierData = {
            status: 'delivered',
            delivery_status: 'completed',
            message: 'Package delivered successfully (MANUAL TEST)'
        };
        
        console.log(` Simulating delivery for order ${orderNumber}...`);
        
        // Test the delivery detection
        const isDelivered = checkIfDelivered(mockCourierData);
        
        if (isDelivered && order.status === 'shipped') {
            console.log(` Delivery detected! Updating order status...`);
            await updateOrderStatusToDelivered(order.id, mockCourierData);
        } else {
            console.warn(` Delivery not detected or order not in shipped status. Order status: ${order.status}`);
        }
    }
    
    // Add to window for console access
    window.manualDeliveryTest = manualDeliveryTest;
    
    // ============================================
    // ORDER EDITING FUNCTIONALITY
    // ============================================
    
    // Global variables for order editing
    let availableProducts = [];
    
    // Add Order Item Button Event Listener
    document.getElementById('addOrderItemBtn').addEventListener('click', function() {
        loadAvailableProducts().then(() => {
            // Reset the modal form
            resetAddItemModal();
            
            const modal = new bootstrap.Modal(document.getElementById('addOrderItemModal'));
            modal.show();
        });
    });
    
    // Reset Add Item Modal
    function resetAddItemModal() {
        document.getElementById('addItemProductSearch').value = '';
        document.getElementById('addItemProductSelect').value = '';
        document.getElementById('addItemVariantContainer').style.display = 'none';
        document.getElementById('addItemVariantSelect').innerHTML = '<option value="">Select a variant...</option>';
        document.getElementById('addItemQuantityInput').value = '1';
        document.getElementById('addItemPriceInput').value = '';
        document.getElementById('addItemStock').textContent = '0';
        document.getElementById('addItemProductDropdown').style.display = 'none';
    }
    
    // Edit Address Button Event Listener
    document.getElementById('editAddressBtn').addEventListener('click', function() {
        showEditAddressModal();
    });
    
    // Edit Quantity Modal Functionality
    function showEditQuantityModal(itemId, productName, currentQuantity, productStock, currentPrice, currentVariantId) {
        document.getElementById('editQuantityItemId').value = itemId;
        document.getElementById('editQuantityProductName').value = productName;
        document.getElementById('editQuantityInput').value = currentQuantity;
        document.getElementById('editQuantityPriceInput').value = currentPrice || '';
        document.getElementById('editQuantityStock').textContent = 'Loading...';
        document.getElementById('editQuantityCurrentVariantId').value = currentVariantId || '';
        
        // Fetch item details and populate variants
        fetchItemDetailsAndVariants(itemId);
        
        // Fetch real stock data from API
        fetchProductStock(itemId);
        
        const modal = new bootstrap.Modal(document.getElementById('editQuantityModal'));
        modal.show();
    }
    
    // Function to fetch item details and load variants
    async function fetchItemDetailsAndVariants(itemId) {
        try {
            if (!currentOrderId) {
                console.error('No current order ID available');
                return;
            }
            
            // Get the item details
            const orderItemResponse = await fetch(`/mb-admin/api/orders/${currentOrderId}/items/`);
            if (!orderItemResponse.ok) throw new Error('Failed to fetch order items');
            
            const items = await orderItemResponse.json();
            const currentItem = items.find(item => item.id == itemId);
            
            if (!currentItem) {
                console.error('Item not found');
                return;
            }
            
            const productId = currentItem.product_id || currentItem.product;
            const currentVariantId = currentItem.variant_id || currentItem.variant;
            
            // Store current variant ID
            document.getElementById('editQuantityCurrentVariantId').value = currentVariantId || '';
            
            if (!productId) {
                console.error('No product ID found');
                return;
            }
            
            // Fetch product details to get variants
            const productResponse = await fetch(`/mb-admin/api/products/${productId}/`);
            if (!productResponse.ok) throw new Error('Failed to fetch product details');
            
            const productData = await productResponse.json();
            
            // Check if product has variants
            if (productData.variants && productData.variants.length > 0) {
                populateVariantsDropdown(productData.variants, currentVariantId);
                document.getElementById('editQuantityVariantContainer').style.display = 'block';
            } else {
                document.getElementById('editQuantityVariantContainer').style.display = 'none';
            }
            
        } catch (error) {
            console.error('Error fetching item details and variants:', error);
            document.getElementById('editQuantityVariantContainer').style.display = 'none';
        }
    }
    
    // Function to populate variants dropdown
    function populateVariantsDropdown(variants, currentVariantId) {
        const variantSelect = document.getElementById('editQuantityVariantSelect');
        variantSelect.innerHTML = '<option value="">No variant</option>';
        
        variants.forEach(variant => {
            const option = document.createElement('option');
            option.value = variant.id;
            option.textContent = variant.name || variant.display_name || `Variant ${variant.id}`;
            
            if (variant.id == currentVariantId) {
                option.selected = true;
            }
            
            variantSelect.appendChild(option);
        });
        
        // Remove any existing event listeners and add new one for variant change
        const newVariantSelect = variantSelect.cloneNode(true);
        variantSelect.parentNode.replaceChild(newVariantSelect, variantSelect);
        
        newVariantSelect.addEventListener('change', function() {
            const selectedVariantId = this.value;
            updateStockAndPriceForVariant(selectedVariantId);
        });
    }
    
    // Function to update stock and price when variant changes
    async function updateStockAndPriceForVariant(variantId) {
        try {
            if (!currentOrderId) return;
            
            // Get the current item details
            const orderItemResponse = await fetch(`/mb-admin/api/orders/${currentOrderId}/items/`);
            if (!orderItemResponse.ok) throw new Error('Failed to fetch order items');
            
            const items = await orderItemResponse.json();
            const itemId = document.getElementById('editQuantityItemId').value;
            const currentItem = items.find(item => item.id == itemId);
            
            if (!currentItem) return;
            
            const productId = currentItem.product_id || currentItem.product;
            
            if (variantId) {
                // Fetch variant details
                const variantResponse = await fetch(`/mb-admin/api/products/${productId}/variants/${variantId}/`);
                if (!variantResponse.ok) throw new Error('Failed to fetch variant details');
                
                const variantData = await variantResponse.json();
                document.getElementById('editQuantityStock').textContent = variantData.stock_quantity || variantData.stock || 0;
                document.getElementById('editQuantityPriceInput').value = variantData.price || 0;
            } else {
                // Fetch product details (no variant)
                const productResponse = await fetch(`/mb-admin/api/products/${productId}/`);
                if (!productResponse.ok) throw new Error('Failed to fetch product details');
                
                const productData = await productResponse.json();
                document.getElementById('editQuantityStock').textContent = productData.stock_quantity || productData.stock || 0;
                document.getElementById('editQuantityPriceInput').value = productData.price || 0;
            }
        } catch (error) {
            console.error('Error updating stock and price for variant:', error);
            document.getElementById('editQuantityStock').textContent = 'Error';
        }
    }
    
    // Function to fetch real stock data
    async function fetchProductStock(itemId) {
        try {
            // Check if we have a current order ID
            if (!currentOrderId) {
                document.getElementById('editQuantityStock').textContent = 'Unknown';
                return;
            }
            
            // First get the item details to find the product ID
            const orderItemResponse = await fetch(`/mb-admin/api/orders/${currentOrderId}/items/`);
            if (!orderItemResponse.ok) throw new Error('Failed to fetch order items');
            
            const items = await orderItemResponse.json();
            const currentItem = items.find(item => item.id == itemId);
            
            if (!currentItem) {
                document.getElementById('editQuantityStock').textContent = 'Unknown';
                return;
            }
            
            // Now fetch the product stock
            const productId = currentItem.product_id || currentItem.product;
            const variantId = currentItem.variant_id || currentItem.variant;
            
            if (!productId) {
                document.getElementById('editQuantityStock').textContent = 'Unknown';
                return;
            }
            
            let stockUrl = `/mb-admin/api/products/${productId}/`;
            if (variantId) {
                stockUrl += `variants/${variantId}/`;
            }
            
            const stockResponse = await fetch(stockUrl);
            if (!stockResponse.ok) throw new Error('Failed to fetch stock');
            
            const productData = await stockResponse.json();
            const stock = variantId ? (productData.stock_quantity || productData.stock) : (productData.stock_quantity || productData.stock);
            
            document.getElementById('editQuantityStock').textContent = stock || 0;
        } catch (error) {
            console.error('Error fetching stock:', error);
            document.getElementById('editQuantityStock').textContent = 'Error loading';
        }
    }
    
    // Confirm Edit Quantity
    document.getElementById('confirmEditQuantityBtn').addEventListener('click', function() {
        const itemId = document.getElementById('editQuantityItemId').value;
        const newQuantity = parseInt(document.getElementById('editQuantityInput').value);
        const newPrice = parseFloat(document.getElementById('editQuantityPriceInput').value);
        const newVariantId = document.getElementById('editQuantityVariantSelect').value;
        
        if (!newQuantity || newQuantity <= 0) {
            Swal.fire({
                title: 'Invalid Quantity',
                text: 'Please enter a valid quantity greater than 0.',
                icon: 'warning'
            });
            return;
        }
        
        if (!newPrice || newPrice <= 0) {
            Swal.fire({
                title: 'Invalid Price',
                text: 'Please enter a valid price greater than 0.',
                icon: 'warning'
            });
            return;
        }
        
        updateOrderItem(itemId, newQuantity, newPrice, newVariantId);
    });
    
    // Delete Item Confirmation
    function showDeleteItemConfirmation(itemId, productName) {
        Swal.fire({
            title: 'Delete Item?',
            text: `Are you sure you want to remove "${productName}" from this order?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                deleteOrderItem(itemId);
            }
        });
    }
    
    // Load Available Products
    async function loadAvailableProducts() {
        try {
            const response = await fetch('/mb-admin/api/orders/edit/available-products/', {
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                availableProducts = data.products;
                populateProductSelect();
            } else {
                throw new Error(data.error || 'Failed to load products');
            }
        } catch (error) {
            console.error('Error loading products:', error);
            Swal.fire({
                title: 'Error',
                text: 'Failed to load available products.',
                icon: 'error'
            });
        }
    }
    
    // Populate Product Search Dropdown
    function populateProductSelect() {
        const dropdown = document.getElementById('addItemProductDropdown');
        const searchInput = document.getElementById('addItemProductSearch');
        
        // Clear existing options
        dropdown.innerHTML = '';
        
        if (availableProducts.length === 0) {
            dropdown.innerHTML = '<div class="dropdown-item-text text-muted">No products available</div>';
            return;
        }
        
        // Create dropdown items for each product
        availableProducts.forEach(product => {
            const item = document.createElement('div');
            item.className = 'dropdown-item product-search-item';
            item.style.cursor = 'pointer';
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-medium">${product.name}</div>
                        <small class="text-muted">Price: $${product.price}</small>
                    </div>
                    <small class="text-success">Stock: ${product.stock_quantity}</small>
                </div>
            `;
            item.dataset.productId = product.id;
            item.dataset.productData = JSON.stringify(product);
            
            // Add click handler
            item.addEventListener('click', function() {
                selectProduct(product);
            });
            
            dropdown.appendChild(item);
        });
    }
    
    // Product Search Functionality
    let productSearchTimeout;
    document.getElementById('addItemProductSearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const dropdown = document.getElementById('addItemProductDropdown');
        
        clearTimeout(productSearchTimeout);
        
        if (searchTerm.length === 0) {
            dropdown.style.display = 'none';
            return;
        }
        
        productSearchTimeout = setTimeout(() => {
            // Filter products based on search term
            const filteredProducts = availableProducts.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                product.sku.toLowerCase().includes(searchTerm)
            );
            
            // Clear dropdown
            dropdown.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                dropdown.innerHTML = '<div class="dropdown-item-text text-muted">No products found</div>';
            } else {
                filteredProducts.forEach(product => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item product-search-item';
                    item.style.cursor = 'pointer';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-medium">${product.name}</div>
                                <small class="text-muted">Price: $${product.price}</small>
                            </div>
                            <small class="text-success">Stock: ${product.stock_quantity}</small>
                        </div>
                    `;
                    item.dataset.productId = product.id;
                    item.dataset.productData = JSON.stringify(product);
                    
                    // Add click handler
                    item.addEventListener('click', function() {
                        selectProduct(product);
                    });
                    
                    dropdown.appendChild(item);
                });
            }
            
            dropdown.style.display = 'block';
        }, 300);
    });
    
    // Function to select a product
    function selectProduct(product) {
        const searchInput = document.getElementById('addItemProductSearch');
        const hiddenSelect = document.getElementById('addItemProductSelect');
        const dropdown = document.getElementById('addItemProductDropdown');
        
        // Set input value
        searchInput.value = product.name;
        hiddenSelect.value = product.id;
        
        // Hide dropdown
        dropdown.style.display = 'none';
        
        // Trigger the product selection logic
        handleProductSelection(product);
    }
    
    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('addItemProductDropdown');
        const searchInput = document.getElementById('addItemProductSearch');
        
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
    
    // Show dropdown on focus
    document.getElementById('addItemProductSearch').addEventListener('focus', function() {
        if (this.value.trim().length > 0) {
            document.getElementById('addItemProductDropdown').style.display = 'block';
        }
    });
    
    // Product Selection Handler
    function handleProductSelection(product) {
        const variantContainer = document.getElementById('addItemVariantContainer');
        const variantSelect = document.getElementById('addItemVariantSelect');
        const priceInput = document.getElementById('addItemPriceInput');
        const stockSpan = document.getElementById('addItemStock');
        
        // Show variants if available
        if (product.variants && product.variants.length > 0) {
            variantContainer.style.display = 'block';
            variantSelect.innerHTML = '<option value="">Select a variant...</option>';
            
            product.variants.forEach(variant => {
                const option = document.createElement('option');
                option.value = variant.id;
                option.textContent = `${variant.name} (Stock: ${variant.stock_quantity})`;
                option.dataset.variantData = JSON.stringify(variant);
                variantSelect.appendChild(option);
            });
            
            // Clear price and stock until variant is selected
            priceInput.value = '';
            stockSpan.textContent = '0';
        } else {
            // No variants, use product data directly
            variantContainer.style.display = 'none';
            priceInput.value = product.price;
            stockSpan.textContent = product.stock_quantity;
        }
    }
    
    // Variant Select Change Handler
    document.getElementById('addItemVariantSelect').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const priceInput = document.getElementById('addItemPriceInput');
        const stockSpan = document.getElementById('addItemStock');
        
        if (selectedOption.value) {
            const variant = JSON.parse(selectedOption.dataset.variantData);
            priceInput.value = variant.price;
            stockSpan.textContent = variant.stock_quantity;
        } else {
            priceInput.value = '';
            stockSpan.textContent = '0';
        }
    });
    
    // Confirm Add Item
    document.getElementById('confirmAddItemBtn').addEventListener('click', function() {
        const productId = document.getElementById('addItemProductSelect').value;
        const variantId = document.getElementById('addItemVariantSelect').value || null;
        const quantity = parseInt(document.getElementById('addItemQuantityInput').value);
        
        if (!productId) {
            Swal.fire({
                title: 'Product Required',
                text: 'Please select a product.',
                icon: 'warning'
            });
            return;
        }
        
        if (!quantity || quantity <= 0) {
            Swal.fire({
                title: 'Invalid Quantity',
                text: 'Please enter a valid quantity greater than 0.',
                icon: 'warning'
            });
            return;
        }
        
        addOrderItem(productId, variantId, quantity);
    });
    
    // Show Edit Address Modal
    function showEditAddressModal() {
        const currentOrder = window.currentOrderData;
        if (!currentOrder || !currentOrder.shipping_address) {
            Swal.fire({
                title: 'No Address',
                text: 'No shipping address found for this order.',
                icon: 'warning'
            });
            return;
        }
        
        const address = currentOrder.shipping_address;
        
        // Populate form fields (only the fields that exist in the simplified form)
        document.getElementById('editFirstName').value = address.first_name || '';
        document.getElementById('editLastName').value = address.last_name || '';
        document.getElementById('editAddressLine1').value = address.address_line_1 || '';
        document.getElementById('editPhone').value = address.phone || '';
        document.getElementById('editEmail').value = address.email || '';
        
        // For delivery instructions, check multiple sources:
        // 1. Shipping address delivery_instructions
        // 2. Order customer_notes (from original checkout)
        // 3. Order instructions field
        const deliveryInstructions = address.delivery_instructions || 
            currentOrder.customer_notes || 
            currentOrder.instructions || '';
        document.getElementById('editDeliveryInstructions').value = deliveryInstructions;
        
        const modal = new bootstrap.Modal(document.getElementById('editAddressModal'));
        modal.show();
    }
    
    // Confirm Edit Address
    document.getElementById('confirmEditAddressBtn').addEventListener('click', function() {
        const formData = {
            first_name: document.getElementById('editFirstName').value,
            last_name: document.getElementById('editLastName').value,
            address_line_1: document.getElementById('editAddressLine1').value,
            phone: document.getElementById('editPhone').value,
            email: document.getElementById('editEmail').value,
            delivery_instructions: document.getElementById('editDeliveryInstructions').value
        };
        
        updateShippingAddress(formData);
    });
    
    // API Functions for Order Editing
    async function updateOrderItem(itemId, newQuantity, newPrice, newVariantId) {
        try {
            const requestData = {
                item_id: parseInt(itemId),
                quantity: newQuantity,
                price: newPrice
            };
            
            // Add variant_id - send null if no variant selected, or the variant ID if one is selected
            if (newVariantId !== undefined) {
                requestData.variant_id = newVariantId && newVariantId !== '' ? parseInt(newVariantId) : null;
            }
            
            console.log('Sending update request:', requestData); // For debugging
            
            // Try the comprehensive update endpoint first
            let response = await fetch(`/mb-admin/api/orders/${currentOrderId}/edit/update-item/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(requestData)
            });
            
            // If that doesn't exist, try the original quantity endpoint with additional data
            if (!response.ok && response.status === 404) {
                response = await fetch(`/mb-admin/api/orders/${currentOrderId}/edit/update-quantity/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        item_id: parseInt(itemId),
                        new_quantity: newQuantity,
                        new_price: newPrice,
                        variant_id: newVariantId || null
                    })
                });
            }
            
            const data = await response.json();
            
            console.log('Update item API Response:', data); // For debugging
            
            if (data.success) {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editQuantityModal'));
                modal.hide();
                
                // Refresh order items
                loadOrderDetails(currentOrderId);
                
                Swal.fire({
                    title: 'Success!',
                    text: 'Order item updated successfully.',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                throw new Error(data.message || 'Failed to update item');
            }
            
        } catch (error) {
            console.error('Error updating order item:', error);
            Swal.fire({
                title: 'Error!',
                text: `Failed to update item: ${error.message}`,
                icon: 'error'
            });
        }
    }
    
    // Keep the old function for backward compatibility
    async function updateOrderItemQuantity(itemId, newQuantity, newPrice) {
        return updateOrderItem(itemId, newQuantity, newPrice, null);
    }

    async function addOrderItem(productId, variantId, quantity) {
        try {
            const requestData = {
                product_id: parseInt(productId),
                quantity: quantity
            };
            
            if (variantId) {
                requestData.variant_id = parseInt(variantId);
            }
            
            const response = await fetch(`/mb-admin/api/orders/${currentOrderId}/edit/add-item/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(requestData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addOrderItemModal'));
                modal.hide();
                
                // Reset form using the new reset function
                resetAddItemModal();
                
                // Refresh order items
                loadOrderDetails(currentOrderId);
                
                Swal.fire({
                    title: 'Success!',
                    text: data.message,
                    icon: 'success',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
            } else {
                throw new Error(data.error || 'Failed to add item');
            }
        } catch (error) {
            console.error('Error adding item:', error);
            Swal.fire({
                title: 'Error',
                text: error.message,
                icon: 'error'
            });
        }
    }
    
    async function deleteOrderItem(itemId) {
        try {
            const response = await fetch(`/mb-admin/api/orders/${currentOrderId}/edit/delete-item/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    item_id: parseInt(itemId)
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Refresh order items
                loadOrderDetails(currentOrderId);
                
                Swal.fire({
                    title: 'Deleted!',
                    text: data.message,
                    icon: 'success',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
            } else {
                throw new Error(data.error || 'Failed to delete item');
            }
        } catch (error) {
            console.error('Error deleting item:', error);
            Swal.fire({
                title: 'Error',
                text: error.message,
                icon: 'error'
            });
        }
    }
    
    async function updateShippingAddress(addressData) {
        try {
            const response = await fetch(`/mb-admin/api/orders/${currentOrderId}/edit/update-address/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(addressData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editAddressModal'));
                modal.hide();
                
                // Refresh order details to reflect the changes
                loadOrderDetails(currentOrderId);
                
                Swal.fire({
                    title: 'Success!',
                    text: data.message,
                    icon: 'success',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
            } else {
                throw new Error(data.error || 'Failed to update address');
            }
        } catch (error) {
            console.error('Error updating address:', error);
            Swal.fire({
                title: 'Error',
                text: error.message,
                icon: 'error'
            });
        }
    }
    
    // Helper function to update note displays after address changes
    function updateNoteDisplays(order) {
        // Update separate order instructions container
        const orderInstructionsContainer = document.getElementById('orderInstructionsContainer');
        // Check multiple sources for instructions:
        // 1. Order instructions field
        // 2. Order customer_notes (from checkout)  
        // 3. Shipping address delivery_instructions (from address edit)
        const instructionText = order.instructions || order.customer_notes || 
            (order.shipping_address && order.shipping_address.delivery_instructions) || '';
        
        if (instructionText && instructionText.trim()) {
            document.getElementById('orderDetailInstructions').textContent = instructionText;
            orderInstructionsContainer.style.display = 'block';
        } else {
            document.getElementById('orderDetailInstructions').textContent = 'No special instructions provided.';
            orderInstructionsContainer.style.display = 'none';
        }
    }
    
    // ============================================
    // END ORDER EDITING FUNCTIONALITY
    // ============================================
    
    // ============================================
    // END COURIER MONITORING DEBUG FUNCTIONS
    // ============================================
    
    // Helper functions
    // Function to add order to curier service
    function addOrderToCurier(orderId) {
        console.log(`Adding order ${orderId} to curier service`);
        
        // Show loading indicator
        Swal.fire({
            title: 'Processing',
            text: 'Adding order to courier service...',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        fetch(`/mb-admin/api/orders/${orderId}/add_to_curier/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`Failed to add order to curier service: ${text || response.statusText}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Order added to curier service:', data);
            
            // Extract consignment ID if available
            const consignmentId = data.curier_id || 
                (data.response && data.response.consignment && data.response.consignment.consignment_id) || 
                'Generated';
            
            // Show success message with consignment ID
            Swal.fire({
                title: 'Success!',
                text: `Order has been successfully added to courier service! Consignment ID: ${consignmentId}`,
                icon: 'success',
                confirmButtonColor: '#28a745',
                confirmButtonText: 'Great!'
            });
            
            // Refresh orders list to update UI
            loadOrders(currentPage);
        })
        .catch(error => {
            console.error('Error adding order to curier service:', error);
            
            Swal.fire({
                title: 'Error!',
                text: `Failed to add order to courier service: ${error.message}`,
                icon: 'error',
                confirmButtonColor: '#dc3545',
                confirmButtonText: 'OK'
            });
        });
    }
    
    function showAlert(message, type) {
        // Map Bootstrap alert types to SweetAlert2 icons
        const iconMap = {
            'success': 'success',
            'danger': 'error',
            'warning': 'warning',
            'info': 'info'
        };
        
        // Map Bootstrap colors to SweetAlert2 button colors
        const buttonColorMap = {
            'success': '#28a745',
            'danger': '#dc3545',
            'warning': '#ffc107',
            'info': '#17a2b8'
        };
        
        // Use SweetAlert2 for modern alerts
        Swal.fire({
            title: type.charAt(0).toUpperCase() + type.slice(1),
            text: message,
            icon: iconMap[type] || 'info',
            confirmButtonColor: buttonColorMap[type] || '#6c757d',
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 5000,
            timerProgressBar: true
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        
        // First try to get from cookies
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        
        // If we couldn't find the CSRF token in cookies, try to get it from the hidden input field
        if (!cookieValue && name === 'csrftoken') {
            const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (csrfInput) {
                cookieValue = csrfInput.value;
                console.log('Got CSRF token from hidden input:', cookieValue);
            }
        }
        
        return cookieValue;
    }
    
    // Courier Editing Event Handlers
    
    // Edit Courier ID Button
    document.getElementById('editCourierBtn').addEventListener('click', function() {
        const currentValue = document.getElementById('courierIdDisplay').textContent;
        document.getElementById('editCourierIdInput').value = currentValue === 'Not assigned' ? '' : currentValue;
        
        const modal = new bootstrap.Modal(document.getElementById('editCourierModal'));
        modal.show();
    });
    
    // Confirm Edit Courier ID
    document.getElementById('confirmEditCourierBtn').addEventListener('click', function() {
        const newCourierId = document.getElementById('editCourierIdInput').value.trim();
        const orderId = window.currentOrderData.id;
        
        console.log('Updating courier ID for order:', orderId, 'New ID:', newCourierId);
        
        // Update courier ID via API
        fetch(`/mb-admin/api/orders/${orderId}/edit/courier-info/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                courier_id: newCourierId
            })
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (!response.ok) {
                return response.text().then(text => {
                    console.error('Non-JSON response:', text);
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('API Response:', data);
            
            if (data.success) {
                // Update display
                document.getElementById('courierIdDisplay').textContent = newCourierId || 'Not assigned';
                
                // Update global order data
                window.currentOrderData.curier_id = newCourierId;
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('editCourierModal')).hide();
                
                // Show success message
                Swal.fire({
                    title: 'Success!',
                    text: 'Courier ID updated successfully.',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                throw new Error(data.error || 'Failed to update courier ID');
            }
        })
        .catch(error => {
            console.error('Error updating courier ID:', error);
            Swal.fire({
                title: 'Error',
                text: error.message || 'Failed to update courier ID.',
                icon: 'error'
            });
        });
    });
    
    // Edit Courier Date Button
    document.getElementById('editCourierDateBtn').addEventListener('click', function() {
        const currentOrder = window.currentOrderData;
        let currentDate = '';
        
        if (currentOrder.curier_date) {
            // Convert to YYYY-MM-DD format for input
            const date = new Date(currentOrder.curier_date);
            currentDate = date.toISOString().split('T')[0];
        }
        
        document.getElementById('editCourierDateInput').value = currentDate;
        
        const modal = new bootstrap.Modal(document.getElementById('editCourierDateModal'));
        modal.show();
    });
    
    // Confirm Edit Courier Date
    document.getElementById('confirmEditCourierDateBtn').addEventListener('click', function() {
        const newCourierDate = document.getElementById('editCourierDateInput').value;
        const orderId = window.currentOrderData.id;
        
        console.log('Updating courier date for order:', orderId, 'New date:', newCourierDate);
        
        // Update courier date via API
        fetch(`/mb-admin/api/orders/${orderId}/edit/courier-info/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                curier_date: newCourierDate
            })
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (!response.ok) {
                return response.text().then(text => {
                    console.error('Non-JSON response:', text);
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('API Response:', data);
            
            if (data.success) {
                // Update display
                const courierDateDisplay = document.getElementById('courierDateDisplay');
                if (newCourierDate) {
                    const formattedDate = new Date(newCourierDate).toLocaleDateString('en-GB', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    });
                    courierDateDisplay.textContent = formattedDate;
                } else {
                    courierDateDisplay.textContent = 'Not set';
                }
                
                // Update global order data
                window.currentOrderData.curier_date = newCourierDate;
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('editCourierDateModal')).hide();
                
                // Show success message
                Swal.fire({
                    title: 'Success!',
                    text: 'Courier date updated successfully.',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                throw new Error(data.error || 'Failed to update courier date');
            }
        })
        .catch(error => {
            console.error('Error updating courier date:', error);
            Swal.fire({
                title: 'Error',
                text: error.message || 'Failed to update courier date.',
                icon: 'error'
            });
        });
    });
});
</script>
{% endblock %}