{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Orders - MB Admin{% endblock %}

{% block page_title %}Orders Management{% endblock %}

{% block extra_css %}
<!-- SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<style>
    /* Order Details Modal Custom Styles */
    .modal-content {
        border-radius: var(--border-radius);
    }
    
    .modal-header {
        background-color: var(--secondary-color);
        color: var(--white);
        border-top-left-radius: var(--border-radius);
        border-top-right-radius: var(--border-radius);
    }
    
    .modal-header .btn-close-white:focus {
        box-shadow: none;
    }
    
    .card {
        transition: transform 0.2s;
        border-radius: var(--border-radius);
    }
    
    .card:hover {
        transform: translateY(-3px);
    }
    
    .badge {
        font-weight: 500;
        letter-spacing: 0.3px;
        padding: 0.5rem 0.75rem;
        border-radius: 4px;
    }
    
    /* Custom status badge colors */
    .bg-indigo {
        background-color: #6610f2;
    }
    
    .bg-orange {
        background-color: #fd7e14;
    }
    
    /* Custom table styling */
    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    
    /* Order status badge sizes */
    #orderDetailStatus {
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
    }
    
    /* Card subtitles with icons */
    .card-subtitle {
        font-weight: 500;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.75rem;
        margin-bottom: 1rem;
    }
    
    .card-subtitle i {
        color: var(--primary-color);
    }
    
    /* Action buttons */
    .btn-outline-primary {
        color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .btn-outline-primary:hover {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }
    
    .btn-outline-secondary {
        border-color: var(--primary-color);
        color: var(--primary-color);
        opacity: 0.85;
    }
    
    .btn-outline-secondary:hover {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        opacity: 1;
    }
    
    /* Modal buttons */
    .modal .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .modal .btn-primary:hover {
        background-color: var(--primary-color-dark, var(--primary-color));
        border-color: var(--primary-color-dark, var(--primary-color));
        opacity: 0.9;
    }
    
    /* Copy functionality styles */
    .copy-text {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .copy-icon {
        cursor: pointer;
        color: var(--primary-color);
        opacity: 0.6;
        transition: all 0.2s;
    }
    
    .copy-icon:hover {
        opacity: 1;
        transform: scale(1.1);
    }
    
    .copy-success {
        animation: pulse 1s;
        color: var(--success-color, #28a745);
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hidden CSRF Token for JavaScript use -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Orders</h5>
        <button class="btn btn-sm btn-secondary" id="refreshOrdersBtn">
            <i class="fas fa-sync-alt me-1"></i> Refresh
        </button>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <div class="row g-2">
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" id="orderSearchInput" placeholder="Search by order # or customer...">
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="processing">Processing</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                        <option value="returned">Returned</option>
                        <option value="partially_returned">Partially Returned</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="paymentStatusFilter">
                        <option value="">All Payment Statuses</option>
                        <option value="paid">Paid</option>
                        <option value="unpaid">Unpaid</option>
                        <option value="refunded">Refunded</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="date" class="form-control form-control-sm" id="dateFilter">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary btn-sm w-100" id="applyOrderFiltersBtn">
                        <i class="fas fa-filter me-1"></i> Apply Filters
                    </button>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Order #</th>
                        <th>Actions</th>
                        <th>Date</th>
                        <th>Total</th>
                        <th>Items</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading orders...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <span id="ordersTotalCount">0</span> orders
            </div>
            <div>
                <nav aria-label="Orders pagination">
                    <ul class="pagination pagination-sm" id="ordersPagination"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailsModalLabel">
                    Order #<span id="orderNumberDisplay"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Order Status Badge -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="d-flex align-items-center" style="gap: 0.5rem;">
                        <span id="orderDetailStatus" class="badge me-2"></span>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="changeStatusBtn" data-bs-toggle="dropdown" aria-expanded="false">
                                Change Status
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="changeStatusBtn" id="statusDropdown">
                                <li><a class="dropdown-item" data-status="pending" href="#">Pending</a></li>
                                <li><a class="dropdown-item" data-status="confirmed" href="#">Confirmed</a></li>
                                <li><a class="dropdown-item" data-status="processing" href="#">Processing</a></li>
                                <li><a class="dropdown-item" data-status="shipped" href="#">Shipped</a></li>
                                <li><a class="dropdown-item" data-status="delivered" href="#">Delivered</a></li>
                                <li><a class="dropdown-item" data-status="returned" href="#">Returned</a></li>
                                <li><a class="dropdown-item" data-status="partially_returned" href="#">Partially Returned</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" data-status="cancelled" href="#">Cancelled</a></li>
                            </ul>
                        </div>
                    </div>
                    <div>
                        <span class="badge" id="orderDetailPaymentStatus"></span>
                    </div>
                </div>
                
                <!-- Order Summary Cards -->
                <div class="row g-4 mb-4">
                    <!-- Order Info Card -->
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">
                                    <i class="fas fa-info-circle me-2"></i>Order Information
                                </h6>
                                <dl class="row mb-0">
                                    <dt class="col-sm-4 text-muted">Order Number</dt>
                                    <dd class="col-sm-8 fw-medium" id="orderDetailNumber"></dd>
                                    
                                    <dt class="col-sm-4 text-muted">Date & Time</dt>
                                    <dd class="col-sm-8" id="orderDetailDate"></dd>
                                    
                                    <dt class="col-sm-4 text-muted">Total Amount</dt>
                                    <dd class="col-sm-8 fw-bold" id="orderDetailTotal"></dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customer Info Card -->
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">
                                    <i class="fas fa-user me-2"></i>Customer Information
                                </h6>
                                <dl class="row mb-0">
                                    <dt class="col-sm-4 text-muted">Name</dt>
                                    <dd class="col-sm-8" id="orderDetailCustomerName"></dd>
                                    
                                    <dt class="col-sm-4 text-muted">Email</dt>
                                    <dd class="col-sm-8" id="orderDetailCustomerEmail"></dd>
                                    
                                    <dt class="col-sm-4 text-muted">Phone</dt>
                                    <dd class="col-sm-8" id="orderDetailCustomerPhone"></dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Order Instructions & Shipping Address -->
                <div class="row g-4 mb-4">
                    <!-- Order Instructions -->
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">
                                    <i class="fas fa-clipboard-list me-2"></i>Order Instructions
                                </h6>
                                <p class="border rounded p-3 bg-light mb-0" id="orderDetailInstructions">No special instructions provided.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Shipping Address -->
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">
                                    <i class="fas fa-map-marker-alt me-2"></i>Shipping Address
                                </h6>
                                <p class="border rounded p-3 bg-light mb-0" id="orderDetailShippingAddress"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Order Items -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-3 text-muted">
                            <i class="fas fa-shopping-bag me-2"></i>Order Items
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Product</th>
                                        <th>Variant</th>
                                        <th class="text-center">Quantity</th>
                                        <th class="text-end">Price</th>
                                        <th class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="orderItemsTableBody"></tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="4" class="text-end">Subtotal:</td>
                                        <td class="text-end" id="orderDetailSubtotal"></td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" class="text-end">Shipping:</td>
                                        <td class="text-end" id="orderDetailShipping"></td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" class="text-end">Tax:</td>
                                        <td class="text-end" id="orderDetailTax"></td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" class="text-end fw-bold">Total:</td>
                                        <td class="text-end fw-bold" id="orderDetailGrandTotal"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="d-flex justify-content-between">
                    <div>
                        <button class="btn btn-outline-secondary me-2" id="printOrderBtn">
                            <i class="fas fa-print me-1"></i> Print Order
                        </button>
                        <button class="btn btn-outline-primary" id="sendInvoiceBtn">
                            <i class="fas fa-envelope me-1"></i> Send Invoice
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-outline-danger" id="deleteOrderBtn">
                            <i class="fas fa-trash me-1"></i> Delete Order
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden storage for order details card (for backwards compatibility) -->
<div id="orderDetailsCard" style="display: none;"></div>

<!-- Order status change modal -->
<div class="modal fade" id="statusChangeModal" tabindex="-1" aria-labelledby="statusChangeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusChangeModalLabel">Update Order Status</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to change the status of order <strong id="statusChangeOrderNumber"></strong> to <strong id="statusChangeNewStatus"></strong>?</p>
                
                <!-- Common fields -->
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="notifyCustomerCheck" checked>
                    <label class="form-check-label" for="notifyCustomerCheck">
                        Notify customer via email about this status change
                    </label>
                </div>
                
                <!-- Courier Charge field - shown for all status changes -->
                <div class="mb-3">
                    <label for="courierChargeInput" class="form-label">Courier Charge (optional)</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="courierChargeInput" placeholder="Enter courier charge" min="0" step="0.01">
                    </div>
                    <small class="text-muted">Leave empty to keep current charge</small>
                </div>
                
                <!-- Partially Returned Amount - shown only for partially_returned status -->
                <div class="mb-3" id="partiallyRefundedFieldContainer" style="display: none;">
                    <label for="partiallyRefundedInput" class="form-label">Refund Amount <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="partiallyRefundedInput" placeholder="Enter refund amount" min="0" step="0.01" required>
                    </div>
                    <small class="text-danger" id="partiallyRefundedError" style="display: none;">Please enter a refund amount</small>
                </div>
                
                <div class="mb-3">
                    <label for="statusChangeComment" class="form-label">Additional Comments (optional)</label>
                    <textarea class="form-control" id="statusChangeComment" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmStatusChangeBtn">Confirm Status Change</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let currentOrderId = null;
    let orders = [];
    
    // Helper function to format status names (converting snake_case to Title Case)
    function formatStatusName(status) {
        if (!status) return '';
        return status.split('_')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }
    
    // Helper function to initialize copy functionality for dynamically added elements
    function initCopyFunctionality() {
        document.querySelectorAll('.copy-icon').forEach(icon => {
            // Remove any existing listeners
            icon.removeEventListener('click', copyToClipboard);
            // Add fresh listener
            icon.addEventListener('click', copyToClipboard);
        });
    }
    
    // Copy to clipboard function
    function copyToClipboard(e) {
        const textToCopy = this.parentElement.dataset.value;
        navigator.clipboard.writeText(textToCopy)
            .then(() => {
                // Visual feedback
                this.classList.add('copy-success');
                this.classList.remove('fa-copy');
                this.classList.add('fa-check');
                setTimeout(() => {
                    this.classList.remove('copy-success');
                    this.classList.remove('fa-check');
                    this.classList.add('fa-copy');
                }, 1500);
            })
            .catch(err => {
                console.error('Could not copy text: ', err);
                alert('Failed to copy to clipboard');
            });
    }
    
    // Event listeners
    document.getElementById('refreshOrdersBtn').addEventListener('click', function() {
        loadOrders(1);
    });
    
    document.getElementById('applyOrderFiltersBtn').addEventListener('click', function() {
        loadOrders(1);
    });
    
    // Modal is handled by Bootstrap
    
    // Initial data loading
    loadOrders(1);
    
    // Load orders with pagination and filtering
    function loadOrders(page = 1) {
        currentPage = page;
        const searchTerm = document.getElementById('orderSearchInput').value.trim();
        const statusFilter = document.getElementById('statusFilter').value;
        const paymentStatusFilter = document.getElementById('paymentStatusFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;
        
        let url = `/mb-admin/api/orders/?page=${page}&include_shipping_address=true`;
        
        if (searchTerm) {
            url += `&search=${encodeURIComponent(searchTerm)}`;
        }
        
        if (statusFilter) {
            url += `&status=${statusFilter}`;
        }
        
        if (paymentStatusFilter) {
            url += `&payment_status=${paymentStatusFilter}`;
        }
        
        if (dateFilter) {
            url += `&created_at__date=${dateFilter}`;
        }
        
        // Show loading indicator
        document.getElementById('ordersTableBody').innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading orders...</p>
                </td>
            </tr>
        `;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                orders = data.results || [];
                displayOrders(orders);
                updatePagination(data);
                document.getElementById('ordersTotalCount').textContent = data.count || 0;
            })
            .catch(error => {
                console.error('Error loading orders:', error);
                document.getElementById('ordersTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>Error loading orders. Please try again.</p>
                        </td>
                    </tr>
                `;
            });
    }
    
    function displayOrders(orders) {
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = '';
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">No orders found.</td>
                </tr>
            `;
            return;
        }
        
        orders.forEach(order => {
            const tr = document.createElement('tr');
            
            let statusBadgeClass;
            switch (order.status) {
                case 'pending':
                    statusBadgeClass = 'bg-warning text-dark';
                    break;
                case 'confirmed':
                    statusBadgeClass = 'bg-info text-white';
                    break;
                case 'processing':
                    statusBadgeClass = 'bg-primary text-white';
                    break;
                case 'shipped':
                    statusBadgeClass = 'bg-indigo text-white';
                    break;
                case 'delivered':
                    statusBadgeClass = 'bg-success text-white';
                    break;
                case 'returned':
                    statusBadgeClass = 'bg-orange text-white';
                    break;
                case 'partially_returned':
                    statusBadgeClass = 'bg-warning text-dark';
                    break;
                case 'cancelled':
                    statusBadgeClass = 'bg-danger text-white';
                    break;
                default:
                    statusBadgeClass = 'bg-secondary text-white';
            }
            
            let paymentStatusBadgeClass;
            switch (order.payment_status) {
                case 'paid':
                    paymentStatusBadgeClass = 'bg-success';
                    break;
                case 'unpaid':
                    paymentStatusBadgeClass = 'bg-danger';
                    break;
                case 'refunded':
                    paymentStatusBadgeClass = 'bg-warning text-dark';
                    break;
                default:
                    paymentStatusBadgeClass = 'bg-secondary';
            }
            
            // Get customer name from shipping address if available
            let customerName = 'Guest';
            if (order.shipping_address) {
                const firstName = order.shipping_address.first_name || '';
                const lastName = order.shipping_address.last_name || '';
                customerName = `${firstName} ${lastName}`.trim() || 'Guest';
            } else if (order.user_name) {
                // Fallback to user_name if available
                customerName = order.user_name;
            }
            
            // Format order number with customer name
            const formattedOrderNumber = `${order.order_number} (${customerName})`;
            
            tr.innerHTML = `
                <td>${formattedOrderNumber}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-primary view-order-btn me-1" data-order-id="${order.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-sm ${order.curier_id ? 'btn-success' : 'btn-outline-success'} add-curier-btn" 
                        data-order-id="${order.id}" 
                        title="${order.curier_id ? 'Already added to curier (ID: ' + order.curier_id + ')' : 'Add to Curier'}"
                        ${order.curier_id ? 'disabled' : ''}>
                        <i class="fas fa-${order.curier_id ? 'check-circle' : 'truck'}" ${order.curier_id ? 'style="color: white;"' : ''}></i>
                    </button>
                </td>
                <td>${new Date(order.created_at).toLocaleDateString()}</td>
                <td>$${order.total_amount}</td>
                <td>${order.total_items}</td>
                <td>
                    <span class="badge ${statusBadgeClass}">
                        ${formatStatusName(order.status)}
                    </span>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Add event listeners to view order buttons
        document.querySelectorAll('.view-order-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.dataset.orderId;
                currentOrderId = orderId;
                loadOrderDetails(orderId);
            });
        });
        
        // Add event listeners to add curier buttons
        document.querySelectorAll('.add-curier-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.dataset.orderId;
                addOrderToCurier(orderId);
            });
        });
    }
    
    function updatePagination(data) {
        const pagination = document.getElementById('ordersPagination');
        pagination.innerHTML = '';
        
        const totalPages = Math.ceil(data.count / data.results.length);
        if (totalPages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
        pagination.appendChild(prevLi);
        
        // Page numbers
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            pagination.appendChild(li);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
        pagination.appendChild(nextLi);
        
        // Add event listeners to pagination links
        document.querySelectorAll('#ordersPagination .page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.dataset.page);
                loadOrders(page);
            });
        });
    }
    
    // Order details
    function loadOrderDetails(orderId) {
        console.log(`Loading order details for ID: ${orderId}`);
        
        // First, load order data
        fetch(`/mb-admin/api/orders/${orderId}/`)
            .then(response => {
                console.log(`Order API response status: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(order => {
                console.log('Order data received:', order);
                displayOrderDetails(order);
                
                // Show the modal after order data is loaded
                const orderModal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
                orderModal.show();
                
                // Initialize copy functionality after modal is shown
                setTimeout(initCopyFunctionality, 200);
                
                // Then load order items with delay to ensure proper loading
                setTimeout(() => {
                    console.log(`Loading items for order ${orderId}...`);
                    document.getElementById('orderItemsTableBody').innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span class="ms-2">Loading order items...</span>
                            </td>
                        </tr>
                    `;
                    
                    // Use the explicit route to fetch order items
                    fetch(`/mb-admin/api/orders/${orderId}/items/`)
                        .then(response => {
                            console.log(`Items API response status: ${response.status}`);
                            
                            // Debug the raw response
                            response.clone().text().then(text => {
                                console.log('Raw response text:', text.substring(0, 200) + '...');
                                try {
                                    // Try to parse as JSON to see if it's valid
                                    const jsonData = JSON.parse(text);
                                    console.log('Response parsed successfully as JSON:', jsonData);
                                } catch (err) {
                                    console.error('Response is not valid JSON:', err);
                                }
                            });
                            
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(items => {
                            console.log(`Received items:`, items);
                            if (Array.isArray(items)) {
                                console.log(`Found ${items.length} items`);
                                if (items.length > 0) {
                                    displayOrderItems(items);
                                } else {
                                    document.getElementById('orderItemsTableBody').innerHTML = 
                                        '<tr><td colspan="5" class="text-center">No items found in this order.</td></tr>';
                                }
                            } else if (typeof items === 'object' && items !== null && items.error) {
                                // Handle server-side error message
                                console.error('Server error:', items.error);
                                document.getElementById('orderItemsTableBody').innerHTML = 
                                    `<tr><td colspan="5" class="text-center text-danger">Error: ${items.error}</td></tr>`;
                            } else {
                                console.error('Items response is not an array:', items);
                                document.getElementById('orderItemsTableBody').innerHTML = 
                                    '<tr><td colspan="5" class="text-center text-warning">Invalid order items format received.</td></tr>';
                            }
                        })
                        .catch(error => {
                            console.error('Error loading order items:', error);
                            // Display a message in the items table
                            document.getElementById('orderItemsTableBody').innerHTML = 
                                `<tr><td colspan="5" class="text-center text-danger">
                                    <i class="fas fa-exclamation-circle me-2"></i>
                                    Failed to load order items: ${error.message || 'Unknown error'}
                                </td></tr>`;
                                
                            // Retry button
                            document.getElementById('orderItemsTableBody').innerHTML += 
                                `<tr><td colspan="5" class="text-center">
                                    <button class="btn btn-sm btn-outline-primary retry-items-btn mt-2">
                                        <i class="fas fa-sync-alt me-1"></i> Retry
                                    </button>
                                </td></tr>`;
                                
                            // Add event listener to retry button
                            document.querySelector('.retry-items-btn').addEventListener('click', function() {
                                loadOrderDetails(orderId);
                            });
                        });
                }, 500);
            })
            .catch(error => {
                console.error('Error loading order details:', error);
                showAlert('Failed to load order details.', 'danger');
            });
    }
    
    function displayOrderDetails(order) {
        // Log order data for debugging
        console.log('Order details:', order);
        
        // Store order data globally for access in other functions
        window.currentOrderData = order;
        
        // Set order header details
        document.getElementById('orderNumberDisplay').textContent = order.order_number;
        document.getElementById('orderDetailNumber').innerHTML = `
            <span class="copy-text" data-value="${order.order_number}">
                ${order.order_number} <i class="fas fa-copy copy-icon" title="Copy order number"></i>
            </span>
        `;
        document.getElementById('orderDetailDate').textContent = new Date(order.created_at).toLocaleString();
        
        // Set order status with appropriate badge
        const statusElement = document.getElementById('orderDetailStatus');
        let statusBadgeClass;
        switch (order.status) {
            case 'pending':
                statusBadgeClass = 'bg-warning text-dark';
                break;
            case 'confirmed':
                statusBadgeClass = 'bg-info text-white';
                break;
            case 'processing':
                statusBadgeClass = 'bg-primary text-white';
                break;
            case 'shipped':
                statusBadgeClass = 'bg-indigo text-white';
                break;
            case 'delivered':
                statusBadgeClass = 'bg-success text-white';
                break;
            case 'returned':
                statusBadgeClass = 'bg-orange text-white';
                break;
            case 'partially_returned':
                statusBadgeClass = 'bg-warning text-dark';
                break;
            case 'cancelled':
                statusBadgeClass = 'bg-danger text-white';
                break;
            default:
                statusBadgeClass = 'bg-secondary text-white';
        }
        statusElement.className = `badge ${statusBadgeClass}`;
        statusElement.textContent = formatStatusName(order.status);
        
        // Set payment status with badge style
        const paymentStatusElement = document.getElementById('orderDetailPaymentStatus');
        let paymentStatusClass;
        switch (order.payment_status) {
            case 'paid':
                paymentStatusClass = 'bg-success text-white';
                break;
            case 'unpaid':
                paymentStatusClass = 'bg-danger text-white';
                break;
            case 'refunded':
                paymentStatusClass = 'bg-warning text-dark';
                break;
            default:
                paymentStatusClass = 'bg-secondary text-white';
        }
        paymentStatusElement.className = `badge ${paymentStatusClass}`;
        paymentStatusElement.textContent = order.payment_status.charAt(0).toUpperCase() + order.payment_status.slice(1);
        
        // Set total amount
        document.getElementById('orderDetailTotal').textContent = `$${order.total_amount}`;
        
        // Set customer information
        const orderSku = order.order_number || '';
        const firstName = order.shipping_address ? order.shipping_address.first_name || '' : '';
        const lastName = order.shipping_address ? order.shipping_address.last_name || '' : '';
        const customerName = `${firstName} ${lastName}`.trim() || 'Guest';
        const formattedName = `${orderSku} (${customerName})`.trim();
        const customerEmail = order.user_email || order.customer_email || 'N/A';
        const customerPhone = order.customer_phone || (order.shipping_address && order.shipping_address.phone) || 'N/A';
        
        document.getElementById('orderDetailCustomerName').innerHTML = `
            <span class="copy-text" data-value="${formattedName}">
                ${formattedName} <i class="fas fa-copy copy-icon" title="Copy name"></i>
            </span>
        `;
        
        document.getElementById('orderDetailCustomerEmail').innerHTML = `
            <span class="copy-text" data-value="${customerEmail}">
                ${customerEmail} <i class="fas fa-copy copy-icon" title="Copy email"></i>
            </span>
        `;
        
        document.getElementById('orderDetailCustomerPhone').innerHTML = `
            <span class="copy-text" data-value="${customerPhone}">
                ${customerPhone} <i class="fas fa-copy copy-icon" title="Copy phone"></i>
            </span>
        `;
        
        // Set shipping address
        let addressText = 'No shipping address available';
        if (order.shipping_address) {
            try {
                const address = order.shipping_address;
                console.log('Shipping address:', address);
                
                const fullName = `${address.first_name || ''} ${address.last_name || ''}`;
                const addressLine1 = address.address_line_1 || '';
                const addressLine2 = address.address_line_2 || '';
                const cityStateZip = `${address.city || ''}, ${address.state || ''} ${address.postal_code || ''}`;
                const country = address.country || '';
                const phone = address.phone || '';
                const sku = order.sku || order.order_number || '';
                
                addressText = `
                    <div class="copy-text" data-value="${fullName}">
                        ${fullName} <i class="fas fa-copy copy-icon" title="Copy name"></i>
                    </div><br>
                    <div class="copy-text" data-value="${addressLine1}">
                        ${addressLine1} <i class="fas fa-copy copy-icon" title="Copy address"></i>
                    </div><br>
                    ${phone ? `<div class="copy-text" data-value="${phone}">Phone: ${phone} <i class="fas fa-copy copy-icon" title="Copy phone"></i></div><br>` : ''}
                    <div class="copy-text" data-value="${sku}">
                        <strong>Order SKU:</strong> ${sku} <i class="fas fa-copy copy-icon" title="Copy SKU"></i>
                    </div>
                `;
            } catch (error) {
                console.error('Error formatting shipping address:', error, order.shipping_address);
            }
        } else {
            console.log('No shipping address found in order data');
        }
        document.getElementById('orderDetailShippingAddress').innerHTML = addressText;
        
        // Initialize copy functionality for all copy buttons
        initCopyFunctionality();
        
        // Set order instructions (if available)
        if (order.instructions || order.customer_notes) {
            document.getElementById('orderDetailInstructions').textContent = order.instructions || order.customer_notes;
        } else {
            document.getElementById('orderDetailInstructions').textContent = 'No special instructions provided.';
        }
        
        // Set up status change dropdown
        document.querySelectorAll('#statusDropdown .dropdown-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const newStatus = this.dataset.status;
                
                // Set values for confirmation modal
                document.getElementById('statusChangeOrderNumber').textContent = order.order_number;
                document.getElementById('statusChangeNewStatus').textContent = formatStatusName(newStatus);
                
                // Reset form fields
                document.getElementById('courierChargeInput').value = '';
                document.getElementById('partiallyRefundedInput').value = '';
                document.getElementById('partiallyRefundedError').style.display = 'none';
                
                // Show/hide partially refunded amount field based on status
                const partiallyRefundedContainer = document.getElementById('partiallyRefundedFieldContainer');
                if (newStatus === 'partially_returned') {
                    partiallyRefundedContainer.style.display = 'block';
                } else {
                    partiallyRefundedContainer.style.display = 'none';
                }
                
                // If we have existing courier charge, pre-fill the field
                if (order.curier_charge) {
                    document.getElementById('courierChargeInput').value = order.curier_charge;
                }
                
                // Show confirmation modal
                const modal = new bootstrap.Modal(document.getElementById('statusChangeModal'));
                modal.show();
                
                // Set up confirmation button
                document.getElementById('confirmStatusChangeBtn').onclick = function() {
                    // Just call updateOrderStatus - it will handle the modal closing
                    updateOrderStatus(order.id, newStatus);
                    // Don't hide the modal here - let updateOrderStatus handle it
                };
            });
        });
        
        // Set up print button
        document.getElementById('printOrderBtn').onclick = function() {
            // Redirect to invoice print view
            window.open(`/orders/${order.id}/invoice/`, '_blank');
        };
        
        // Set up send invoice button with SweetAlert2 confirmation
        document.getElementById('sendInvoiceBtn').onclick = function() {
            Swal.fire({
                title: 'Send Invoice',
                text: 'Send invoice email to the customer?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#007bff',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, send it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    sendInvoiceEmail(order.id);
                }
            });
        };
        
        // Set up delete order button with SweetAlert2 confirmation
        document.getElementById('deleteOrderBtn').onclick = function() {
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this deletion!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteOrder(order.id);
                }
            });
        };
    }
    
    function displayOrderItems(items) {
        // Log items data for debugging
        console.log('Order items:', items);
        
        const tbody = document.getElementById('orderItemsTableBody');
        tbody.innerHTML = '';
        
        if (!items || items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No items in this order.</td></tr>';
            return;
        }
        
        let subtotal = 0;
        
        // Safer processing of items
        items.forEach((item, index) => {
            try {
                console.log(`Processing item ${index}:`, item);
                
                // Default values if data is missing
                const productName = item.product_name || 'Unknown Product';
                const variantName = item.variant_name || 'N/A';
                const variantSku = item.variant_sku || '';
                const quantity = Number(item.quantity) || 0;
                
                // Handle price fields with multiple fallbacks
                let unitPrice = 0;
                if (item.unit_price) {
                    unitPrice = Number(item.unit_price);
                } else if (item.price) {
                    unitPrice = Number(item.price);
                }
                
                // Calculate total with fallbacks
                let itemTotal = 0;
                if (item.total_price) {
                    itemTotal = Number(item.total_price);
                } else {
                    itemTotal = unitPrice * quantity;
                }
                
                // Format for display
                const formattedPrice = unitPrice.toFixed(2);
                const formattedTotal = itemTotal.toFixed(2);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="align-middle">${productName}</td>
                    <td class="align-middle">
                        ${variantName}
                        ${variantSku ? `<br><small class="text-muted">SKU: ${variantSku}</small>` : ''}
                    </td>
                    <td class="text-center align-middle">${quantity}</td>
                    <td class="text-end align-middle">$${formattedPrice}</td>
                    <td class="text-end align-middle">$${formattedTotal}</td>
                `;
                tbody.appendChild(tr);
                
                // Add to subtotal
                subtotal += itemTotal;
                console.log(`Added $${itemTotal} to subtotal, now: $${subtotal}`);
                
            } catch (error) {
                console.error(`Error rendering order item ${index}:`, error, item);
            }
        });
        
        // Set subtotal
        document.getElementById('orderDetailSubtotal').textContent = `$${subtotal.toFixed(2)}`;
        
        // Get current order for shipping and tax info
        const currentOrder = window.currentOrderData;
        console.log('Current order for totals:', currentOrder);
        
        // Set shipping, tax, and grand total using order data
        const shipping = currentOrder && currentOrder.shipping_cost ? Number(currentOrder.shipping_cost) : 0;
        const tax = currentOrder && currentOrder.tax_amount ? Number(currentOrder.tax_amount) : 0;
        
        console.log(`Shipping: $${shipping}, Tax: $${tax}, Subtotal: $${subtotal}`);
        
        document.getElementById('orderDetailShipping').textContent = `$${shipping.toFixed(2)}`;
        document.getElementById('orderDetailTax').textContent = `$${tax.toFixed(2)}`;
        document.getElementById('orderDetailGrandTotal').textContent = `$${(subtotal + shipping + tax).toFixed(2)}`;
    }
    
    // Order actions
    function updateOrderStatus(orderId, newStatus) {
        const notifyCustomer = document.getElementById('notifyCustomerCheck').checked;
        const comment = document.getElementById('statusChangeComment').value.trim();
        const courierCharge = document.getElementById('courierChargeInput').value.trim();
        
        // Check if we need to validate the partially refunded amount
        let partiallyRefundedAmount = null;
        if (newStatus === 'partially_returned') {
            partiallyRefundedAmount = document.getElementById('partiallyRefundedInput').value.trim();
            
            // Validate that an amount is provided for partially_returned status
            if (!partiallyRefundedAmount) {
                document.getElementById('partiallyRefundedError').style.display = 'block';
                return; // Stop execution if validation fails
            } else {
                document.getElementById('partiallyRefundedError').style.display = 'none';
            }
        }
        
        console.log(`Updating order ${orderId} status to ${newStatus}`);
        console.log('CSRF Token:', getCookie('csrftoken'));
        
        const requestData = {
            status: newStatus,
            notify_customer: notifyCustomer,
            comment: comment
        };
        
        // Add courier charge if provided
        if (courierCharge) {
            requestData.curier_charge = parseFloat(courierCharge);
        }
        
        // Add partially refunded amount if applicable
        if (partiallyRefundedAmount) {
            requestData.partially_ammount = parseFloat(partiallyRefundedAmount);
        }
        
        console.log('Request data:', requestData);
        
        // Get the modal element reference for later cleanup
        const statusChangeModalElement = document.getElementById('statusChangeModal');
        
        fetch(`/mb-admin/api/orders/${orderId}/update_status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',  // Include cookies in the request
            body: JSON.stringify(requestData)
        })
        .then(response => {
            console.log('Update status response:', response.status);
            
            // Clone response to read it for debugging
            response.clone().text().then(text => {
                console.log('Raw update status response:', text);
                try {
                    const jsonData = JSON.parse(text);
                    console.log('Parsed update status response:', jsonData);
                } catch (err) {
                    console.log('Response is not JSON');
                }
            });
            
            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('Permission denied. CSRF token might be missing or invalid.');
                } else {
                    return response.text().then(text => {
                        throw new Error(`Failed to update status: ${text || response.statusText}`);
                    });
                }
            }
            return response.json();
        })
        .then(data => {
            console.log('Update successful, response data:', data);
            
            // Update status in UI
            document.getElementById('orderDetailStatus').textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
            
            // Update status badge class
            const statusElement = document.getElementById('orderDetailStatus');
            let statusBadgeClass;
            switch (newStatus) {
                case 'pending':
                    statusBadgeClass = 'bg-warning text-dark';
                    break;
                case 'processing':
                    statusBadgeClass = 'bg-info';
                    break;
                case 'shipped':
                    statusBadgeClass = 'bg-primary';
                    break;
                case 'delivered':
                    statusBadgeClass = 'bg-success';
                    break;
                case 'cancelled':
                    statusBadgeClass = 'bg-danger';
                    break;
                default:
                    statusBadgeClass = 'bg-secondary';
            }
            statusElement.className = `badge ${statusBadgeClass}`;
            
            // Clean up the modal properly using our helper function
            cleanupModal(statusChangeModalElement);
            
            // Refresh orders list in background
            loadOrders(currentPage);
            
            // Show success notification with SweetAlert2
            Swal.fire({
                title: 'Status Updated',
                text: `Order status has been changed to ${formatStatusName(newStatus)}`,
                icon: 'success',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 5000,
                timerProgressBar: true
            });
        })
        .catch(error => {
            console.error('Error updating order status:', error);
            showAlert(`Failed to update order status: ${error.message}`, 'danger');
            
            // Ensure modal is closed properly even on error
            cleanupModal(statusChangeModalElement);
        });
    }
    
    function sendInvoiceEmail(orderId) {
        fetch(`/orders/${orderId}/send-invoice/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to send invoice');
            }
            return response.json();
        })
        .then(data => {
            Swal.fire({
                title: 'Sent!',
                text: 'Invoice email has been sent to the customer.',
                icon: 'success',
                confirmButtonColor: '#28a745'
            });
        })
        .catch(error => {
            console.error('Error sending invoice email:', error);
            Swal.fire({
                title: 'Error!',
                text: 'Failed to send invoice email. Please try again later.',
                icon: 'error',
                confirmButtonColor: '#dc3545'
            });
        });
    }
    
    // Helper function to properly clean up a modal
    function cleanupModal(modalElement) {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
            
            // Remove backdrop manually if it's still there
            setTimeout(() => {
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
                // Also remove any body classes that Bootstrap might have added
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }, 300);
        }
    }
    
    function deleteOrder(orderId) {
        console.log(`Attempting to delete order ID: ${orderId}`);
        console.log('CSRF Token:', getCookie('csrftoken'));
        
        // Reference the modal element
        const orderModalElement = document.getElementById('orderDetailsModal');
        
        fetch(`/mb-admin/api/orders/${orderId}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin'  // Include cookies in the request
        })
        .then(response => {
            console.log('Delete response status:', response.status);
            
            // Clone response to read it for debugging
            response.clone().text().then(text => {
                console.log('Raw delete response:', text);
                try {
                    const jsonData = JSON.parse(text);
                    console.log('Parsed delete response:', jsonData);
                } catch (err) {
                    console.log('Response is not JSON');
                }
            });
            
            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('Permission denied. CSRF token might be missing or invalid.');
                } else if (response.status === 500) {
                    // Handle 500 internal server error separately to provide more useful information
                    return response.text().then(text => {
                        if (text.includes('no such table')) {
                            // Handle database table missing error
                            const errorMessage = 'Database table missing. The order will be deleted, but activity logging might fail.';
                            console.warn(errorMessage);
                            
                            // Close the modal properly even though there was an error
                            cleanupModal(orderModalElement);
                            
                            // Refresh orders list in case the delete actually worked
                            loadOrders(currentPage);
                            
                            showAlert('Order might have been deleted, but there was a database error. Please verify.', 'warning');
                            return; // Return early to avoid throwing error
                        }
                        throw new Error(`Failed to delete order: ${text || response.statusText}`);
                    });
                } else {
                    return response.text().then(text => {
                        throw new Error(`Failed to delete order: ${text || response.statusText}`);
                    });
                }
            }
            
            // Hide the modal properly using our cleanup function
            cleanupModal(orderModalElement);
            
            // Refresh orders list
            loadOrders(currentPage);
            
            // Show success notification with SweetAlert2
            Swal.fire({
                title: 'Deleted!',
                text: 'The order has been deleted successfully.',
                icon: 'success',
                confirmButtonColor: '#28a745'
            });
        })
        .catch(error => {
            console.error('Error deleting order:', error);
            showAlert(`Failed to delete order: ${error.message}`, 'danger');
            
            // Ensure modal is closed properly even on error
            cleanupModal(orderModalElement);
        });
    }
    
    // Helper functions
    // Function to add order to curier service
    function addOrderToCurier(orderId) {
        console.log(`Adding order ${orderId} to curier service`);
        
        // Show loading indicator
        Swal.fire({
            title: 'Processing',
            text: 'Adding order to courier service...',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        fetch(`/mb-admin/api/orders/${orderId}/add_to_curier/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`Failed to add order to curier service: ${text || response.statusText}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Order added to curier service:', data);
            
            // Extract consignment ID if available
            const consignmentId = data.curier_id || 
                (data.response && data.response.consignment && data.response.consignment.consignment_id) || 
                'Generated';
            
            // Show success message with consignment ID
            Swal.fire({
                title: 'Success!',
                text: `Order has been successfully added to courier service! Consignment ID: ${consignmentId}`,
                icon: 'success',
                confirmButtonColor: '#28a745',
                confirmButtonText: 'Great!'
            });
            
            // Refresh orders list to update UI
            loadOrders(currentPage);
        })
        .catch(error => {
            console.error('Error adding order to curier service:', error);
            
            Swal.fire({
                title: 'Error!',
                text: `Failed to add order to courier service: ${error.message}`,
                icon: 'error',
                confirmButtonColor: '#dc3545',
                confirmButtonText: 'OK'
            });
        });
    }
    
    function showAlert(message, type) {
        // Map Bootstrap alert types to SweetAlert2 icons
        const iconMap = {
            'success': 'success',
            'danger': 'error',
            'warning': 'warning',
            'info': 'info'
        };
        
        // Map Bootstrap colors to SweetAlert2 button colors
        const buttonColorMap = {
            'success': '#28a745',
            'danger': '#dc3545',
            'warning': '#ffc107',
            'info': '#17a2b8'
        };
        
        // Use SweetAlert2 for modern alerts
        Swal.fire({
            title: type.charAt(0).toUpperCase() + type.slice(1),
            text: message,
            icon: iconMap[type] || 'info',
            confirmButtonColor: buttonColorMap[type] || '#6c757d',
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 5000,
            timerProgressBar: true
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        
        // First try to get from cookies
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        
        // If we couldn't find the CSRF token in cookies, try to get it from the hidden input field
        if (!cookieValue && name === 'csrftoken') {
            const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (csrfInput) {
                cookieValue = csrfInput.value;
                console.log('Got CSRF token from hidden input:', cookieValue);
            }
        }
        
        return cookieValue;
    }
});
</script>
{% endblock %}