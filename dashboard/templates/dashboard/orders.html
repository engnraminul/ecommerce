{% extends 'dashboard/base.html' %}

{% block title %}Orders - MB Admin{% endblock %}

{% block page_title %}Orders Management{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Orders</h5>
        <button class="btn btn-sm btn-secondary" id="refreshOrdersBtn">
            <i class="fas fa-sync-alt me-1"></i> Refresh
        </button>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <div class="row g-2">
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" id="orderSearchInput" placeholder="Search by order # or customer...">
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="processing">Processing</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="paymentStatusFilter">
                        <option value="">All Payment Statuses</option>
                        <option value="paid">Paid</option>
                        <option value="unpaid">Unpaid</option>
                        <option value="refunded">Refunded</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="date" class="form-control form-control-sm" id="dateFilter">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary btn-sm w-100" id="applyOrderFiltersBtn">
                        <i class="fas fa-filter me-1"></i> Apply Filters
                    </button>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Order #</th>
                        <th>Customer</th>
                        <th>Date</th>
                        <th>Total</th>
                        <th>Items</th>
                        <th>Status</th>
                        <th>Payment</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading orders...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <span id="ordersTotalCount">0</span> orders
            </div>
            <div>
                <nav aria-label="Orders pagination">
                    <ul class="pagination pagination-sm" id="ordersPagination"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Order details section -->
<div class="card" id="orderDetailsCard" style="display: none;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Order Details <span id="orderNumberDisplay" class="badge bg-secondary ms-2"></span></h5>
        <button type="button" class="btn-close" id="closeOrderDetailsBtn" aria-label="Close"></button>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-md-6">
                <h6 class="mb-3">Order Information</h6>
                <dl class="row">
                    <dt class="col-sm-4">Order Number</dt>
                    <dd class="col-sm-8" id="orderDetailNumber"></dd>
                    
                    <dt class="col-sm-4">Order Date</dt>
                    <dd class="col-sm-8" id="orderDetailDate"></dd>
                    
                    <dt class="col-sm-4">Status</dt>
                    <dd class="col-sm-8">
                        <div class="d-flex align-items-center">
                            <span id="orderDetailStatus" class="badge me-2"></span>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="changeStatusBtn" data-bs-toggle="dropdown" aria-expanded="false">
                                    Change
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="changeStatusBtn" id="statusDropdown">
                                    <li><a class="dropdown-item" data-status="pending" href="#">Pending</a></li>
                                    <li><a class="dropdown-item" data-status="processing" href="#">Processing</a></li>
                                    <li><a class="dropdown-item" data-status="shipped" href="#">Shipped</a></li>
                                    <li><a class="dropdown-item" data-status="delivered" href="#">Delivered</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" data-status="cancelled" href="#">Cancelled</a></li>
                                </ul>
                            </div>
                        </div>
                    </dd>
                    
                    <dt class="col-sm-4">Payment Status</dt>
                    <dd class="col-sm-8" id="orderDetailPaymentStatus"></dd>
                    
                    <dt class="col-sm-4">Total Amount</dt>
                    <dd class="col-sm-8" id="orderDetailTotal"></dd>
                </dl>
            </div>
            <div class="col-md-6">
                <h6 class="mb-3">Customer Information</h6>
                <dl class="row">
                    <dt class="col-sm-4">Customer Name</dt>
                    <dd class="col-sm-8" id="orderDetailCustomerName"></dd>
                    
                    <dt class="col-sm-4">Email</dt>
                    <dd class="col-sm-8" id="orderDetailCustomerEmail"></dd>
                    
                    <dt class="col-sm-4">Phone</dt>
                    <dd class="col-sm-8" id="orderDetailCustomerPhone"></dd>
                </dl>
                
                <h6 class="mb-2 mt-4">Shipping Address</h6>
                <p class="border rounded p-2 bg-light" id="orderDetailShippingAddress"></p>
            </div>
        </div>
        
        <h6 class="border-bottom pb-2 mb-3">Order Items</h6>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Variant</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="orderItemsTableBody"></tbody>
                <tfoot>
                    <tr>
                        <td colspan="4" class="text-end fw-bold">Subtotal:</td>
                        <td id="orderDetailSubtotal"></td>
                    </tr>
                    <tr>
                        <td colspan="4" class="text-end">Shipping:</td>
                        <td id="orderDetailShipping"></td>
                    </tr>
                    <tr>
                        <td colspan="4" class="text-end">Tax:</td>
                        <td id="orderDetailTax"></td>
                    </tr>
                    <tr>
                        <td colspan="4" class="text-end fw-bold">Total:</td>
                        <td class="fw-bold" id="orderDetailGrandTotal"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <div class="mt-4 d-flex justify-content-between">
            <div>
                <button class="btn btn-outline-secondary me-2" id="printOrderBtn">
                    <i class="fas fa-print me-1"></i> Print Order
                </button>
                <button class="btn btn-outline-primary" id="sendInvoiceBtn">
                    <i class="fas fa-envelope me-1"></i> Send Invoice
                </button>
            </div>
            <div>
                <button class="btn btn-outline-danger" id="deleteOrderBtn">
                    <i class="fas fa-trash me-1"></i> Delete Order
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Order status change modal -->
<div class="modal fade" id="statusChangeModal" tabindex="-1" aria-labelledby="statusChangeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusChangeModalLabel">Update Order Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to change the status of order <strong id="statusChangeOrderNumber"></strong> to <strong id="statusChangeNewStatus"></strong>?</p>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="notifyCustomerCheck" checked>
                    <label class="form-check-label" for="notifyCustomerCheck">
                        Notify customer via email about this status change
                    </label>
                </div>
                <div class="mb-3">
                    <label for="statusChangeComment" class="form-label">Additional Comments (optional)</label>
                    <textarea class="form-control" id="statusChangeComment" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmStatusChangeBtn">Confirm Status Change</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let currentOrderId = null;
    let orders = [];
    
    // Event listeners
    document.getElementById('refreshOrdersBtn').addEventListener('click', function() {
        loadOrders(1);
    });
    
    document.getElementById('applyOrderFiltersBtn').addEventListener('click', function() {
        loadOrders(1);
    });
    
    document.getElementById('closeOrderDetailsBtn').addEventListener('click', function() {
        document.getElementById('orderDetailsCard').style.display = 'none';
    });
    
    // Initial data loading
    loadOrders(1);
    
    // Load orders with pagination and filtering
    function loadOrders(page = 1) {
        currentPage = page;
        const searchTerm = document.getElementById('orderSearchInput').value.trim();
        const statusFilter = document.getElementById('statusFilter').value;
        const paymentStatusFilter = document.getElementById('paymentStatusFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;
        
        let url = `/mb-admin/api/orders/?page=${page}`;
        
        if (searchTerm) {
            url += `&search=${encodeURIComponent(searchTerm)}`;
        }
        
        if (statusFilter) {
            url += `&status=${statusFilter}`;
        }
        
        if (paymentStatusFilter) {
            url += `&payment_status=${paymentStatusFilter}`;
        }
        
        if (dateFilter) {
            url += `&created_at__date=${dateFilter}`;
        }
        
        // Show loading indicator
        document.getElementById('ordersTableBody').innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading orders...</p>
                </td>
            </tr>
        `;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                orders = data.results || [];
                displayOrders(orders);
                updatePagination(data);
                document.getElementById('ordersTotalCount').textContent = data.count || 0;
            })
            .catch(error => {
                console.error('Error loading orders:', error);
                document.getElementById('ordersTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>Error loading orders. Please try again.</p>
                        </td>
                    </tr>
                `;
            });
    }
    
    function displayOrders(orders) {
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = '';
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">No orders found.</td>
                </tr>
            `;
            return;
        }
        
        orders.forEach(order => {
            const tr = document.createElement('tr');
            
            let statusBadgeClass;
            switch (order.status) {
                case 'pending':
                    statusBadgeClass = 'bg-warning text-dark';
                    break;
                case 'processing':
                    statusBadgeClass = 'bg-info';
                    break;
                case 'shipped':
                    statusBadgeClass = 'bg-primary';
                    break;
                case 'delivered':
                    statusBadgeClass = 'bg-success';
                    break;
                case 'cancelled':
                    statusBadgeClass = 'bg-danger';
                    break;
                default:
                    statusBadgeClass = 'bg-secondary';
            }
            
            let paymentStatusBadgeClass;
            switch (order.payment_status) {
                case 'paid':
                    paymentStatusBadgeClass = 'bg-success';
                    break;
                case 'unpaid':
                    paymentStatusBadgeClass = 'bg-danger';
                    break;
                case 'refunded':
                    paymentStatusBadgeClass = 'bg-warning text-dark';
                    break;
                default:
                    paymentStatusBadgeClass = 'bg-secondary';
            }
            
            tr.innerHTML = `
                <td>${order.order_number}</td>
                <td>${order.user_name}</td>
                <td>${new Date(order.created_at).toLocaleDateString()}</td>
                <td>$${order.total_amount}</td>
                <td>${order.total_items}</td>
                <td>
                    <span class="badge ${statusBadgeClass}">
                        ${order.status.charAt(0).toUpperCase() + order.status.slice(1)}
                    </span>
                </td>
                <td>
                    <span class="badge ${paymentStatusBadgeClass}">
                        ${order.payment_status.charAt(0).toUpperCase() + order.payment_status.slice(1)}
                    </span>
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-primary view-order-btn" data-order-id="${order.id}">
                        <i class="fas fa-eye"></i> View
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Add event listeners to view order buttons
        document.querySelectorAll('.view-order-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.dataset.orderId;
                currentOrderId = orderId;
                loadOrderDetails(orderId);
            });
        });
    }
    
    function updatePagination(data) {
        const pagination = document.getElementById('ordersPagination');
        pagination.innerHTML = '';
        
        const totalPages = Math.ceil(data.count / data.results.length);
        if (totalPages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
        pagination.appendChild(prevLi);
        
        // Page numbers
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            pagination.appendChild(li);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
        pagination.appendChild(nextLi);
        
        // Add event listeners to pagination links
        document.querySelectorAll('#ordersPagination .page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.dataset.page);
                loadOrders(page);
            });
        });
    }
    
    // Order details
    function loadOrderDetails(orderId) {
        fetch(`/mb-admin/api/orders/${orderId}/`)
            .then(response => response.json())
            .then(order => {
                displayOrderDetails(order);
                
                // Also fetch order items
                return fetch(`/mb-admin/api/orders/${orderId}/items/`)
                    .then(response => response.json())
                    .then(items => {
                        displayOrderItems(items);
                    });
            })
            .catch(error => {
                console.error('Error loading order details:', error);
                showAlert('Failed to load order details.', 'danger');
            });
    }
    
    function displayOrderDetails(order) {
        // Show order details card
        document.getElementById('orderDetailsCard').style.display = 'block';
        
        // Set order header details
        document.getElementById('orderNumberDisplay').textContent = order.order_number;
        document.getElementById('orderDetailNumber').textContent = order.order_number;
        document.getElementById('orderDetailDate').textContent = new Date(order.created_at).toLocaleString();
        
        // Set order status with appropriate badge
        const statusElement = document.getElementById('orderDetailStatus');
        let statusBadgeClass;
        switch (order.status) {
            case 'pending':
                statusBadgeClass = 'bg-warning text-dark';
                break;
            case 'processing':
                statusBadgeClass = 'bg-info';
                break;
            case 'shipped':
                statusBadgeClass = 'bg-primary';
                break;
            case 'delivered':
                statusBadgeClass = 'bg-success';
                break;
            case 'cancelled':
                statusBadgeClass = 'bg-danger';
                break;
            default:
                statusBadgeClass = 'bg-secondary';
        }
        statusElement.className = `badge ${statusBadgeClass}`;
        statusElement.textContent = order.status.charAt(0).toUpperCase() + order.status.slice(1);
        
        // Set payment status
        let paymentStatusText;
        switch (order.payment_status) {
            case 'paid':
                paymentStatusText = '<span class="badge bg-success">Paid</span>';
                break;
            case 'unpaid':
                paymentStatusText = '<span class="badge bg-danger">Unpaid</span>';
                break;
            case 'refunded':
                paymentStatusText = '<span class="badge bg-warning text-dark">Refunded</span>';
                break;
            default:
                paymentStatusText = '<span class="badge bg-secondary">Unknown</span>';
        }
        document.getElementById('orderDetailPaymentStatus').innerHTML = paymentStatusText;
        
        // Set total amount
        document.getElementById('orderDetailTotal').textContent = `$${order.total_amount}`;
        
        // Set customer information
        document.getElementById('orderDetailCustomerName').textContent = order.user_name || 'Guest';
        document.getElementById('orderDetailCustomerEmail').textContent = order.user ? order.user.email : 'N/A';
        document.getElementById('orderDetailCustomerPhone').textContent = order.shipping_address && order.shipping_address.phone ? order.shipping_address.phone : 'N/A';
        
        // Set shipping address
        let addressText = 'No shipping address available';
        if (order.shipping_address) {
            const address = order.shipping_address;
            addressText = `
                ${address.name || ''}<br>
                ${address.address_line1 || ''}<br>
                ${address.address_line2 ? address.address_line2 + '<br>' : ''}
                ${address.city || ''}, ${address.state || ''} ${address.postal_code || ''}<br>
                ${address.country || ''}<br>
                ${address.phone || ''}
            `;
        }
        document.getElementById('orderDetailShippingAddress').innerHTML = addressText;
        
        // Set up status change dropdown
        document.querySelectorAll('#statusDropdown .dropdown-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const newStatus = this.dataset.status;
                
                // Set values for confirmation modal
                document.getElementById('statusChangeOrderNumber').textContent = order.order_number;
                document.getElementById('statusChangeNewStatus').textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                
                // Show confirmation modal
                const modal = new bootstrap.Modal(document.getElementById('statusChangeModal'));
                modal.show();
                
                // Set up confirmation button
                document.getElementById('confirmStatusChangeBtn').onclick = function() {
                    updateOrderStatus(order.id, newStatus);
                    modal.hide();
                };
            });
        });
        
        // Set up print button
        document.getElementById('printOrderBtn').onclick = function() {
            // Redirect to invoice print view
            window.open(`/orders/${order.id}/invoice/`, '_blank');
        };
        
        // Set up send invoice button
        document.getElementById('sendInvoiceBtn').onclick = function() {
            if (confirm('Send invoice email to the customer?')) {
                sendInvoiceEmail(order.id);
            }
        };
        
        // Set up delete order button
        document.getElementById('deleteOrderBtn').onclick = function() {
            if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
                deleteOrder(order.id);
            }
        };
    }
    
    function displayOrderItems(items) {
        const tbody = document.getElementById('orderItemsTableBody');
        tbody.innerHTML = '';
        
        if (!items || items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No items in this order.</td></tr>';
            return;
        }
        
        let subtotal = 0;
        
        items.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.product_name}</td>
                <td>${item.variant_name}</td>
                <td>${item.quantity}</td>
                <td>$${item.price.toFixed(2)}</td>
                <td>$${item.total_price.toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
            
            subtotal += item.total_price;
        });
        
        // Set subtotal
        document.getElementById('orderDetailSubtotal').textContent = `$${subtotal.toFixed(2)}`;
        
        // Get order for shipping and tax info
        const order = orders.find(o => o.id === parseInt(currentOrderId));
        
        // Set shipping, tax, and grand total (placeholder values if not available)
        const shipping = order && order.shipping_cost ? order.shipping_cost : 0;
        const tax = order && order.tax ? order.tax : 0;
        
        document.getElementById('orderDetailShipping').textContent = `$${shipping.toFixed(2)}`;
        document.getElementById('orderDetailTax').textContent = `$${tax.toFixed(2)}`;
        document.getElementById('orderDetailGrandTotal').textContent = `$${(subtotal + shipping + tax).toFixed(2)}`;
    }
    
    // Order actions
    function updateOrderStatus(orderId, newStatus) {
        const notifyCustomer = document.getElementById('notifyCustomerCheck').checked;
        const comment = document.getElementById('statusChangeComment').value.trim();
        
        fetch(`/mb-admin/api/orders/${orderId}/update_status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                status: newStatus,
                notify_customer: notifyCustomer,
                comment: comment
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to update status');
            }
            return response.json();
        })
        .then(data => {
            // Update status in UI
            document.getElementById('orderDetailStatus').textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
            
            // Update status badge class
            const statusElement = document.getElementById('orderDetailStatus');
            let statusBadgeClass;
            switch (newStatus) {
                case 'pending':
                    statusBadgeClass = 'bg-warning text-dark';
                    break;
                case 'processing':
                    statusBadgeClass = 'bg-info';
                    break;
                case 'shipped':
                    statusBadgeClass = 'bg-primary';
                    break;
                case 'delivered':
                    statusBadgeClass = 'bg-success';
                    break;
                case 'cancelled':
                    statusBadgeClass = 'bg-danger';
                    break;
                default:
                    statusBadgeClass = 'bg-secondary';
            }
            statusElement.className = `badge ${statusBadgeClass}`;
            
            // Refresh orders list in background
            loadOrders(currentPage);
            
            showAlert('Order status updated successfully!', 'success');
        })
        .catch(error => {
            console.error('Error updating order status:', error);
            showAlert('Failed to update order status.', 'danger');
        });
    }
    
    function sendInvoiceEmail(orderId) {
        fetch(`/orders/${orderId}/send-invoice/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to send invoice');
            }
            return response.json();
        })
        .then(data => {
            showAlert('Invoice email sent successfully!', 'success');
        })
        .catch(error => {
            console.error('Error sending invoice email:', error);
            showAlert('Failed to send invoice email.', 'danger');
        });
    }
    
    function deleteOrder(orderId) {
        fetch(`/mb-admin/api/orders/${orderId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete order');
            }
            
            // Hide order details
            document.getElementById('orderDetailsCard').style.display = 'none';
            
            // Refresh orders list
            loadOrders(currentPage);
            
            showAlert('Order deleted successfully!', 'success');
        })
        .catch(error => {
            console.error('Error deleting order:', error);
            showAlert('Failed to delete order.', 'danger');
        });
    }
    
    // Helper functions
    function showAlert(message, type) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Insert at the top of the content area
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                const bsAlert = bootstrap.Alert.getOrCreateInstance(alertDiv);
                bsAlert.close();
            }
        }, 5000);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}