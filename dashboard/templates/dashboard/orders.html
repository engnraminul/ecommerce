{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Orders - MB Admin{% endblock %}

{% block page_title %}Orders Management{% endblock %}

{% block extra_css %}
<!-- SweetAlert2 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<style>
    /* Order Details Modal Custom Styles */
    .modal-content {
        border-radius: var(--border-radius);
    }
    
    .modal-header {
        background-color: var(--secondary-color);
        color: var(--white);
        border-top-left-radius: var(--border-radius);
        border-top-right-radius: var(--border-radius);
    }
    
    .modal-header .btn-close-white:focus {
        box-shadow: none;
    }
    
    .card {
        transition: transform 0.2s;
        border-radius: var(--border-radius);
    }
    
    .card:hover {
        transform: translateY(-3px);
    }
    
    .badge {
        font-weight: 500;
        letter-spacing: 0.3px;
        padding: 0.5rem 0.75rem;
        border-radius: 4px;
    }
    
    /* Custom status badge colors */
    .bg-indigo {
        background-color: #6610f2;
    }
    
    .bg-orange {
        background-color: #fd7e14;
    }
    
    /* Custom table styling */
    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }
    
    /* Order status badge sizes */
    #orderDetailStatus {
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
    }
    
    /* Card subtitles with icons */
    .card-subtitle {
        font-weight: 500;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.75rem;
        margin-bottom: 1rem;
    }
    
    .card-subtitle i {
        color: var(--primary-color);
    }
    
    /* Action buttons */
    .btn-outline-primary {
        color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .btn-outline-primary:hover {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }
    
    .btn-outline-secondary {
        border-color: var(--primary-color);
        color: var(--primary-color);
        opacity: 0.85;
    }
    
    .btn-outline-secondary:hover {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        opacity: 1;
    }
    
    /* Modal buttons */
    .modal .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .modal .btn-primary:hover {
        background-color: var(--primary-color-dark, var(--primary-color));
        border-color: var(--primary-color-dark, var(--primary-color));
        opacity: 0.9;
    }
    
    /* Copy functionality styles */
    .copy-text {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .copy-icon {
        cursor: pointer;
        color: var(--primary-color);
        opacity: 0.6;
        transition: all 0.2s;
    }
    
    .copy-icon:hover {
        opacity: 1;
        transform: scale(1.1);
    }
    
    .copy-success {
        animation: pulse 1s;
        color: var(--success-color, #28a745);
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    
    /* Courier Sticker Styles */
    .courier-sticker {
        width: 288px; /* 2 inches at 144 DPI */
        height: 144px; /* 1 inch at 144 DPI */
        background: white;
        border: 2px solid #333;
        border-radius: 4px;
        display: flex;
        flex-direction: column;
        font-family: Arial, sans-serif;
        font-size: 8px;
        line-height: 1.1;
        overflow: hidden;
        padding: 4px;
    }
    
    .sticker-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 4px;
        height: 30px;
    }
    
    .logo-section {
        flex: 1;
    }
    
    .sticker-logo {
        max-width: 60px;
        max-height: 25px;
        object-fit: contain;
    }
    
    .logo-fallback {
        font-weight: bold;
        font-size: 12px;
        color: #333;
        background: #f0f0f0;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .barcode-section {
        text-align: right;
        flex: 1;
    }
    
    .barcode-canvas {
        max-width: 150px;
        height: 30px;
        border: 1px solid #ccc;
        display: block;
        margin-left: auto;
    }
    
    .courier-id-small {
        font-size: 6px;
        font-weight: bold;
        color: #333;
        text-align: right;
        margin-top: 2px;
    }
    
    .sticker-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 3px;
    }
    
    .customer-name {
        font-size: 14px;
        font-weight: bold;
        color: #333;
        line-height: 1.1;
    }
    
    .courier-id-main {
        font-size: 12px;
        font-weight: bold;
        color: #333;
    }
    
    .products-list {
        font-size: 10px;
        color: #555;
        line-height: 1.2;
        flex: 1;
    }
    
    .sticker-footer {
        margin-top: auto;
        padding-top: 2px;
        border-top: 1px solid #eee;
    }
    
    .contact-row {
        display: flex;
        justify-content: space-between;
        font-size: 6px;
        color: #666;
        line-height: 1.1;
    }
    
    .website, .phone {
        flex: 1;
    }
    
    .phone {
        text-align: right;
    }
    
    /* Print styles for courier sticker */
    @media print {
        .courier-sticker-print {
            width: 2in !important;
            height: 0.95in !important;
            margin: 0 !important;
            padding: 3px !important;
            border: 1px solid #000 !important;
            page-break-inside: avoid !important;
            display: flex !important;
            flex-direction: column !important;
            font-family: Arial, sans-serif !important;
            font-size: 8px !important;
            line-height: 1.0 !important;
        }
        
        .courier-sticker-print .sticker-header {
            display: flex !important;
            justify-content: space-between !important;
            align-items: flex-start !important;
            margin-bottom: 3px !important;
            height: 0.18in !important;
            min-height: 0.18in !important;
            flex-shrink: 0 !important;
        }
        
        .courier-sticker-print .sticker-content {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 1px !important;
            min-height: 0 !important;
            overflow: hidden !important;
        }
        
        .courier-sticker-print .sticker-footer {
            margin-top: auto !important;
            padding-top: 1px !important;
            border-top: 1px solid #000 !important;
            flex-shrink: 0 !important;
            min-height: 0.12in !important;
            max-height: 0.12in !important;
        }
        
        .courier-sticker-print .contact-row {
            display: flex !important;
            justify-content: space-between !important;
            font-size: 5px !important;
            color: #333 !important;
            line-height: 1.0 !important;
            white-space: nowrap !important;
            overflow: hidden !important;
        }
        
        .courier-sticker-print * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        body * {
            visibility: hidden;
        }
        
        .courier-sticker-print, .courier-sticker-print * {
            visibility: visible;
        }
        
        .courier-sticker-print {
            position: absolute;
            left: 0;
            top: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hidden CSRF Token for JavaScript use -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Orders</h5>
        <button class="btn btn-sm btn-secondary" id="refreshOrdersBtn">
            <i class="fas fa-sync-alt me-1"></i> Refresh
        </button>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <div class="row g-2">
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" id="orderSearchInput" placeholder="Search by order # or customer...">
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="processing">Processing</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                        <option value="returned">Returned</option>
                        <option value="partially_returned">Partially Returned</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm" id="paymentStatusFilter">
                        <option value="">All Payment Statuses</option>
                        <option value="paid">Paid</option>
                        <option value="unpaid">Unpaid</option>
                        <option value="refunded">Refunded</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="date" class="form-control form-control-sm" id="dateFilter">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary btn-sm w-100" id="applyOrderFiltersBtn">
                        <i class="fas fa-filter me-1"></i> Apply Filters
                    </button>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Order #</th>
                        <th>Date</th>
                        <th>Actions</th>
                        <th>Total</th>
                        <th>Items</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading orders...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <span id="ordersTotalCount">0</span> orders
            </div>
            <div>
                <nav aria-label="Orders pagination">
                    <ul class="pagination pagination-sm" id="ordersPagination"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailsModalLabel">
                    Order #<span id="orderNumberDisplay"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Order Status Badge -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="d-flex align-items-center" style="gap: 0.5rem;">
                        <span id="orderDetailStatus" class="badge me-2"></span>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="changeStatusBtn" data-bs-toggle="dropdown" aria-expanded="false">
                                Change Status
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="changeStatusBtn" id="statusDropdown">
                                <li><a class="dropdown-item" data-status="pending" href="#">Pending</a></li>
                                <li><a class="dropdown-item" data-status="confirmed" href="#">Confirmed</a></li>
                                <li><a class="dropdown-item" data-status="processing" href="#">Processing</a></li>
                                <li><a class="dropdown-item" data-status="shipped" href="#">Shipped</a></li>
                                <li><a class="dropdown-item" data-status="delivered" href="#">Delivered</a></li>
                                <li><a class="dropdown-item" data-status="returned" href="#">Returned</a></li>
                                <li><a class="dropdown-item" data-status="partially_returned" href="#">Partially Returned</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" data-status="cancelled" href="#">Cancelled</a></li>
                            </ul>
                        </div>
                    </div>
                    <div>
                        <span class="badge" id="orderDetailPaymentStatus"></span>
                    </div>
                </div>
                
                <!-- Order Summary Cards -->
                <div class="row g-4 mb-4">
                    <!-- Order Info Card -->
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">
                                    <i class="fas fa-info-circle me-2"></i>Order Information
                                </h6>
                                <dl class="row mb-0">
                                    <dt class="col-sm-4 text-muted">Order Number</dt>
                                    <dd class="col-sm-8 fw-medium" id="orderDetailNumber"></dd>
                                    
                                    <dt class="col-sm-4 text-muted">Date & Time</dt>
                                    <dd class="col-sm-8" id="orderDetailDate"></dd>
                                    
                                    <dt class="col-sm-4 text-muted">Total Amount</dt>
                                    <dd class="col-sm-8 fw-bold" id="orderDetailTotal"></dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Shipping Address -->
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">
                                    <i class="fas fa-map-marker-alt me-2"></i>Shipping Address
                                </h6>
                                <p class="border rounded p-3 bg-light mb-0" id="orderDetailShippingAddress"></p>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- Order Instructions & Shipping Address -->

                
                <div class="row g-4 mb-4">
                    <!-- Order Instructions - Only shown when there are instructions -->
                    <div class="col-md-6" id="orderInstructionsContainer" style="display: none;">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">
                                    <i class="fas fa-clipboard-list me-2"></i>Order Instructions
                                </h6>
                                <p class="border rounded p-3 bg-light mb-0" id="orderDetailInstructions">No special instructions provided.</p>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- Customer Info Card -->
                    <!-- <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">
                                    <i class="fas fa-user me-2"></i>Customer Information
                                </h6>
                                <dl class="row mb-0">
                                    <dt class="col-sm-4 text-muted">Name</dt>
                                    <dd class="col-sm-8" id="orderDetailCustomerName"></dd>
                                    
                                    <dt class="col-sm-4 text-muted">Email</dt>
                                    <dd class="col-sm-8" id="orderDetailCustomerEmail"></dd>
                                    
                                    <dt class="col-sm-4 text-muted">Phone</dt>
                                    <dd class="col-sm-8" id="orderDetailCustomerPhone"></dd>
                                </dl>
                            </div>
                        </div>
                    </div> -->
                </div>
                
                <!-- Order Items -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-3 text-muted">
                            <i class="fas fa-shopping-bag me-2"></i>Order Items
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Product</th>
                                        <th>Variant</th>
                                        <th class="text-center">Quantity</th>
                                        <th class="text-end">Price</th>
                                        <th class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="orderItemsTableBody"></tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="4" class="text-end">Subtotal:</td>
                                        <td class="text-end" id="orderDetailSubtotal"></td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" class="text-end">Shipping:</td>
                                        <td class="text-end" id="orderDetailShipping"></td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" class="text-end">Tax:</td>
                                        <td class="text-end" id="orderDetailTax"></td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" class="text-end fw-bold">Total:</td>
                                        <td class="text-end fw-bold" id="orderDetailGrandTotal"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="d-flex justify-content-between">
                    <div>
                        <button class="btn btn-outline-secondary me-2" id="printOrderBtn">
                            <i class="fas fa-print me-1"></i> Print Order
                        </button>
                        <button class="btn btn-outline-success" id="modalAddToCurierBtn">
                            <i class="fas fa-truck me-1"></i> Add to Courier
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-outline-danger" id="deleteOrderBtn">
                            <i class="fas fa-trash me-1"></i> Delete Order
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden storage for order details card (for backwards compatibility) -->
<div id="orderDetailsCard" style="display: none;"></div>

<!-- Order status change modal -->
<div class="modal fade" id="statusChangeModal" tabindex="-1" aria-labelledby="statusChangeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusChangeModalLabel">Update Order Status</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to change the status of order <strong id="statusChangeOrderNumber"></strong> to <strong id="statusChangeNewStatus"></strong>?</p>
                
                <!-- Common fields -->
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="notifyCustomerCheck" checked>
                    <label class="form-check-label" for="notifyCustomerCheck">
                        Notify customer via email about this status change
                    </label>
                </div>
                
                <!-- Courier Charge field - shown for all status changes -->
                <div class="mb-3">
                    <label for="courierChargeInput" class="form-label">Courier Charge (optional)</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="courierChargeInput" placeholder="Enter courier charge" min="0" step="0.01">
                    </div>
                    <small class="text-muted">Leave empty to keep current charge</small>
                </div>
                
                <!-- Partially Returned Amount - shown only for partially_returned status -->
                <div class="mb-3" id="partiallyRefundedFieldContainer" style="display: none;">
                    <label for="partiallyRefundedInput" class="form-label">Refund Amount <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="partiallyRefundedInput" placeholder="Enter refund amount" min="0" step="0.01" required>
                    </div>
                    <small class="text-danger" id="partiallyRefundedError" style="display: none;">Please enter a refund amount</small>
                </div>
                
                <div class="mb-3">
                    <label for="statusChangeComment" class="form-label">Additional Comments (optional)</label>
                    <textarea class="form-control" id="statusChangeComment" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmStatusChangeBtn">Confirm Status Change</button>
            </div>
        </div>
    </div>
</div>

<!-- Courier Sticker Modal -->
<div class="modal fade" id="courierStickerModal" tabindex="-1" aria-labelledby="courierStickerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title" id="courierStickerModalLabel">
                    <i class="fas fa-tag me-2"></i>Courier Sticker Preview
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <p class="text-muted">Preview of the 2" × 1" courier sticker for order #<span id="stickerOrderNumber"></span></p>
                </div>
                
                <!-- Sticker Preview -->
                <div class="d-flex justify-content-center mb-4">
                    <div id="courierSticker" class="courier-sticker border shadow-sm">
                        <!-- Top row: Logo and Barcode -->
                        <div class="sticker-header">
                            <div class="logo-section">
                                <img src="{% static 'images/MB-logo.png' %}" alt="Logo" class="sticker-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <div class="logo-fallback" style="display: none;">MB</div>
                            </div>
                            <div class="barcode-section">
                                <canvas id="stickerBarcodeCanvas" class="barcode-canvas"></canvas>
                                <div class="courier-id-small" id="stickerCourierIdSmall">ID: 12345</div>
                            </div>
                        </div>
                        
                        <!-- Content section -->
                        <div class="sticker-content">
                            <div class="customer-name" id="stickerCustomerName">John Doe</div>
                            <!-- <div class="courier-id-main" id="stickerCourierId">ID: 12345</div> -->
                            <div style="font-weight: bold; font-size: 8px; margin-bottom: 1px; color: #333;">Products:</div>
                            <div class="products-list" id="stickerProducts">
                                MW02-Black × 2<br>
                                MW02-Chocolate × 1
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div class="sticker-footer">
                            <div class="contact-row">
                                <span class="website">🌐 www.manobbazar.com</span>
                                <span class="phone">📞 01777173040</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Print Instructions -->
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Print Instructions:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Set paper size to 2" × 1" (50.8mm × 25.4mm)</li>
                        <li>Use label printer or cut regular paper to size</li>
                        <li>Ensure high quality print for barcode readability</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="printStickerBtn">
                    <i class="fas fa-print me-2"></i>Print Sticker
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<!-- JsBarcode for generating proper barcodes -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let currentOrderId = null;
    let orders = [];
    
    // Print Sticker Event Listener
    document.getElementById('printStickerBtn').addEventListener('click', function() {
        printCourierSticker();
    });
    
    // Helper function to format status names (converting snake_case to Title Case)
    function formatStatusName(status) {
        if (!status) return '';
        return status.split('_')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }
    
    // Helper function to format relative time (x min ago, x hours ago, or date)
    function formatRelativeTime(dateString) {
        const now = new Date();
        const date = new Date(dateString);
        const diffMs = now - date;
        const diffMinutes = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        
        if (diffMinutes < 60) {
            return `${diffMinutes} min ago`;
        } else if (diffHours < 24) {
            return `${diffHours} hours ago`;
        } else {
            // Format as "Sep 21, 2025"
            const options = { month: 'short', day: 'numeric', year: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }
    }
    
    // Helper function to initialize copy functionality for dynamically added elements
    function initCopyFunctionality() {
        document.querySelectorAll('.copy-icon').forEach(icon => {
            // Remove any existing listeners
            icon.removeEventListener('click', copyToClipboard);
            // Add fresh listener
            icon.addEventListener('click', copyToClipboard);
        });
    }
    
    // Copy to clipboard function
    function copyToClipboard(e) {
        const textToCopy = this.parentElement.dataset.value;
        navigator.clipboard.writeText(textToCopy)
            .then(() => {
                // Visual feedback
                this.classList.add('copy-success');
                this.classList.remove('fa-copy');
                this.classList.add('fa-check');
                setTimeout(() => {
                    this.classList.remove('copy-success');
                    this.classList.remove('fa-check');
                    this.classList.add('fa-copy');
                }, 1500);
            })
            .catch(err => {
                console.error('Could not copy text: ', err);
                alert('Failed to copy to clipboard');
            });
    }
    
    // Event listeners
    document.getElementById('refreshOrdersBtn').addEventListener('click', function() {
        loadOrders(1);
    });
    
    document.getElementById('applyOrderFiltersBtn').addEventListener('click', function() {
        loadOrders(1);
    });
    
    // Modal is handled by Bootstrap
    
    // Initial data loading
    loadOrders(1);
    
    // Load orders with pagination and filtering
    function loadOrders(page = 1) {
        currentPage = page;
        const searchTerm = document.getElementById('orderSearchInput').value.trim();
        const statusFilter = document.getElementById('statusFilter').value;
        const paymentStatusFilter = document.getElementById('paymentStatusFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;
        
        let url = `/mb-admin/api/orders/?page=${page}&include_shipping_address=true`;
        
        if (searchTerm) {
            url += `&search=${encodeURIComponent(searchTerm)}`;
        }
        
        if (statusFilter) {
            url += `&status=${statusFilter}`;
        }
        
        if (paymentStatusFilter) {
            url += `&payment_status=${paymentStatusFilter}`;
        }
        
        if (dateFilter) {
            url += `&created_at__date=${dateFilter}`;
        }
        
        // Show loading indicator
        document.getElementById('ordersTableBody').innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading orders...</p>
                </td>
            </tr>
        `;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                orders = data.results || [];
                displayOrders(orders);
                updatePagination(data);
                document.getElementById('ordersTotalCount').textContent = data.count || 0;
            })
            .catch(error => {
                console.error('Error loading orders:', error);
                document.getElementById('ordersTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>Error loading orders. Please try again.</p>
                        </td>
                    </tr>
                `;
            });
    }
    
    function displayOrders(orders) {
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = '';
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">No orders found.</td>
                </tr>
            `;
            return;
        }
        
        // Count orders by phone number for each customer
        const phoneNumberCounts = {};
        const customerPhoneMap = {};
        
        orders.forEach(order => {
            let phone = null;
            let customerName = 'Guest';
            
            // Get phone number and customer name
            if (order.shipping_address) {
                phone = order.shipping_address.phone;
                const firstName = order.shipping_address.first_name || '';
                const lastName = order.shipping_address.last_name || '';
                customerName = `${firstName} ${lastName}`.trim() || 'Guest';
            } else if (order.customer_phone) {
                phone = order.customer_phone;
                customerName = order.user_name || 'Guest';
            }
            
            // Count orders by phone number if phone exists
            if (phone && phone.trim()) {
                const cleanPhone = phone.trim();
                if (!phoneNumberCounts[cleanPhone]) {
                    phoneNumberCounts[cleanPhone] = 0;
                    customerPhoneMap[cleanPhone] = customerName;
                }
                phoneNumberCounts[cleanPhone]++;
            }
        });
        
        orders.forEach(order => {
            const tr = document.createElement('tr');
            
            let statusBadgeClass;
            switch (order.status) {
                case 'pending':
                    statusBadgeClass = 'bg-warning text-dark';
                    break;
                case 'confirmed':
                    statusBadgeClass = 'bg-info text-white';
                    break;
                case 'processing':
                    statusBadgeClass = 'bg-primary text-white';
                    break;
                case 'shipped':
                    statusBadgeClass = 'bg-success  text-white';
                    break;
                case 'delivered':
                    statusBadgeClass = 'bg-indigo text-white';
                    break;
                case 'returned':
                    statusBadgeClass = 'bg-orange text-white';
                    break;
                case 'partially_returned':
                    statusBadgeClass = 'bg-warning text-dark';
                    break;
                case 'cancelled':
                    statusBadgeClass = 'bg-danger text-white';
                    break;
                default:
                    statusBadgeClass = 'bg-secondary text-white';
            }
            
            let paymentStatusBadgeClass;
            switch (order.payment_status) {
                case 'paid':
                    paymentStatusBadgeClass = 'bg-success';
                    break;
                case 'unpaid':
                    paymentStatusBadgeClass = 'bg-danger';
                    break;
                case 'refunded':
                    paymentStatusBadgeClass = 'bg-warning text-dark';
                    break;
                default:
                    paymentStatusBadgeClass = 'bg-secondary';
            }
            
            // Get customer name from shipping address if available
            let customerName = 'Guest';
            let customerPhone = null;
            
            if (order.shipping_address) {
                const firstName = order.shipping_address.first_name || '';
                const lastName = order.shipping_address.last_name || '';
                customerName = `${firstName} ${lastName}`.trim() || 'Guest';
                customerPhone = order.shipping_address.phone;
            } else if (order.user_name) {
                // Fallback to user_name if available
                customerName = order.user_name;
                customerPhone = order.customer_phone;
            }
            
            // Add order count to customer name if they have multiple orders with same phone
            let displayCustomerName = customerName;
            if (customerPhone && customerPhone.trim()) {
                const cleanPhone = customerPhone.trim();
                const orderCount = phoneNumberCounts[cleanPhone];
                if (orderCount && orderCount > 1) {
                    displayCustomerName = `${customerName} (${orderCount})`;
                }
            }
            
            // Format order number with customer name
            const formattedOrderNumber = `${order.order_number} (${displayCustomerName})`;
            
            tr.innerHTML = `
                <td><span>${displayCustomerName}</span><br><span style="font-size: 0.8rem;">#${order.order_number}</span> </td>
                <td>${formatRelativeTime(order.created_at)}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-primary view-order-btn me-1" data-order-id="${order.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-sm ${order.curier_id ? 'btn-success' : 'btn-outline-success'} add-curier-btn me-1" 
                        data-order-id="${order.id}" 
                        title="${order.curier_id ? 'Already added to curier (ID: ' + order.curier_id + ')' : 'Add to Curier'}"
                        ${order.curier_id ? 'disabled' : ''}>
                        <i class="fas fa-${order.curier_id ? 'check-circle' : 'truck'}" ${order.curier_id ? 'style="color: white;"' : ''}></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-warning courier-sticker-btn" 
                        data-order-id="${order.id}" 
                        title="Print Courier Sticker"
                        ${!order.curier_id ? 'disabled' : ''}>
                        <i class="fas fa-tag"></i>
                    </button>
                </td>
                <td>$${order.total_amount}</td>
                <td>${order.total_items}</td>
                <td>
                    <span class="badge ${statusBadgeClass}">
                        ${formatStatusName(order.status)}
                    </span>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Add event listeners to view order buttons
        document.querySelectorAll('.view-order-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.dataset.orderId;
                currentOrderId = orderId;
                loadOrderDetails(orderId);
            });
        });
        
        // Add event listeners to add curier buttons
        document.querySelectorAll('.add-curier-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.dataset.orderId;
                
                // Show confirmation popup
                Swal.fire({
                    title: 'Add to Courier Service',
                    text: 'Do you want to add this order to courier service? Order status will be changed to "shipped".',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, add to courier',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d'
                }).then((result) => {
                    if (result.isConfirmed) {
                        addOrderToCurier(orderId);
                    }
                });
            });
        });
        
        // Add event listeners to courier sticker buttons
        document.querySelectorAll('.courier-sticker-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const orderId = this.dataset.orderId;
                showCourierStickerModal(orderId);
            });
        });
    }
    
    function updatePagination(data) {
        const pagination = document.getElementById('ordersPagination');
        pagination.innerHTML = '';
        
        // Try to get page size from API response, fallback to default
        let pageSize = 20; // default page size
        
        // Check if API provides pagination metadata
        if (data.page_size) {
            pageSize = data.page_size;
        } else if (data.results && data.results.length > 0 && currentPage === 1) {
            // On first page, if we have less than 20 items and it's the total count, use that
            if (data.count <= 20) {
                pageSize = data.count;
            }
        }
        
        const totalPages = Math.ceil(data.count / pageSize);
        
        console.log(`Pagination: Total items: ${data.count}, Page size: ${pageSize}, Total pages: ${totalPages}, Current page: ${currentPage}`);
        
        if (totalPages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
        pagination.appendChild(prevLi);
        
        // Page numbers
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            pagination.appendChild(li);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
        pagination.appendChild(nextLi);
        
        // Add event listeners to pagination links
        document.querySelectorAll('#ordersPagination .page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.dataset.page);
                
                // Add validation to prevent invalid page requests
                if (page >= 1 && page <= totalPages && page !== currentPage) {
                    console.log(`Loading page ${page} of ${totalPages}`);
                    loadOrders(page);
                } else {
                    console.warn(`Invalid page request: ${page} (current: ${currentPage}, max: ${totalPages})`);
                }
            });
        });
    }
    
    // Order details
    function loadOrderDetails(orderId) {
        console.log(`Loading order details for ID: ${orderId}`);
        
        // First, load order data
        fetch(`/mb-admin/api/orders/${orderId}/`)
            .then(response => {
                console.log(`Order API response status: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(order => {
                console.log('Order data received:', order);
                displayOrderDetails(order);
                
                // Show the modal after order data is loaded
                const orderModal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
                orderModal.show();
                
                // Initialize copy functionality after modal is shown
                setTimeout(initCopyFunctionality, 200);
                
                // Then load order items with delay to ensure proper loading
                setTimeout(() => {
                    console.log(`Loading items for order ${orderId}...`);
                    document.getElementById('orderItemsTableBody').innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span class="ms-2">Loading order items...</span>
                            </td>
                        </tr>
                    `;
                    
                    // Use the explicit route to fetch order items
                    fetch(`/mb-admin/api/orders/${orderId}/items/`)
                        .then(response => {
                            console.log(`Items API response status: ${response.status}`);
                            
                            // Debug the raw response
                            response.clone().text().then(text => {
                                console.log('Raw response text:', text.substring(0, 200) + '...');
                                try {
                                    // Try to parse as JSON to see if it's valid
                                    const jsonData = JSON.parse(text);
                                    console.log('Response parsed successfully as JSON:', jsonData);
                                } catch (err) {
                                    console.error('Response is not valid JSON:', err);
                                }
                            });
                            
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(items => {
                            console.log(`Received items:`, items);
                            if (Array.isArray(items)) {
                                console.log(`Found ${items.length} items`);
                                if (items.length > 0) {
                                    displayOrderItems(items);
                                } else {
                                    document.getElementById('orderItemsTableBody').innerHTML = 
                                        '<tr><td colspan="5" class="text-center">No items found in this order.</td></tr>';
                                }
                            } else if (typeof items === 'object' && items !== null && items.error) {
                                // Handle server-side error message
                                console.error('Server error:', items.error);
                                document.getElementById('orderItemsTableBody').innerHTML = 
                                    `<tr><td colspan="5" class="text-center text-danger">Error: ${items.error}</td></tr>`;
                            } else {
                                console.error('Items response is not an array:', items);
                                document.getElementById('orderItemsTableBody').innerHTML = 
                                    '<tr><td colspan="5" class="text-center text-warning">Invalid order items format received.</td></tr>';
                            }
                        })
                        .catch(error => {
                            console.error('Error loading order items:', error);
                            // Display a message in the items table
                            document.getElementById('orderItemsTableBody').innerHTML = 
                                `<tr><td colspan="5" class="text-center text-danger">
                                    <i class="fas fa-exclamation-circle me-2"></i>
                                    Failed to load order items: ${error.message || 'Unknown error'}
                                </td></tr>`;
                                
                            // Retry button
                            document.getElementById('orderItemsTableBody').innerHTML += 
                                `<tr><td colspan="5" class="text-center">
                                    <button class="btn btn-sm btn-outline-primary retry-items-btn mt-2">
                                        <i class="fas fa-sync-alt me-1"></i> Retry
                                    </button>
                                </td></tr>`;
                                
                            // Add event listener to retry button
                            document.querySelector('.retry-items-btn').addEventListener('click', function() {
                                loadOrderDetails(orderId);
                            });
                        });
                }, 500);
            })
            .catch(error => {
                console.error('Error loading order details:', error);
                showAlert('Failed to load order details.', 'danger');
            });
    }
    
    function displayOrderDetails(order) {
        // Log order data for debugging
        console.log('Order details:', order);
        
        // Store order data globally for access in other functions
        window.currentOrderData = order;
        
        // Set order header details
        document.getElementById('orderNumberDisplay').textContent = order.order_number;
        document.getElementById('orderDetailNumber').innerHTML = `
            <span class="copy-text" data-value="${order.order_number}">
                ${order.order_number} <i class="fas fa-copy copy-icon" title="Copy order number"></i>
            </span>
        `;
        document.getElementById('orderDetailDate').textContent = new Date(order.created_at).toLocaleString();
        
        // Set order status with appropriate badge
        const statusElement = document.getElementById('orderDetailStatus');
        let statusBadgeClass;
        switch (order.status) {
            case 'pending':
                statusBadgeClass = 'bg-warning text-dark';
                break;
            case 'confirmed':
                statusBadgeClass = 'bg-info text-white';
                break;
            case 'processing':
                statusBadgeClass = 'bg-primary text-white';
                break;
            case 'shipped':
                statusBadgeClass = 'bg-success  text-white';
                break;
            case 'delivered':
                statusBadgeClass = 'bg-indigo text-white';
                break;
            case 'returned':
                statusBadgeClass = 'bg-orange text-white';
                break;
            case 'partially_returned':
                statusBadgeClass = 'bg-warning text-dark';
                break;
            case 'cancelled':
                statusBadgeClass = 'bg-danger text-white';
                break;
            default:
                statusBadgeClass = 'bg-secondary text-white';
        }
        statusElement.className = `badge ${statusBadgeClass}`;
        statusElement.textContent = formatStatusName(order.status);
        
        // Set payment status with badge style
        const paymentStatusElement = document.getElementById('orderDetailPaymentStatus');
        let paymentStatusClass;
        switch (order.payment_status) {
            case 'paid':
                paymentStatusClass = 'bg-success text-white';
                break;
            case 'unpaid':
                paymentStatusClass = 'bg-danger text-white';
                break;
            case 'refunded':
                paymentStatusClass = 'bg-warning text-dark';
                break;
            default:
                paymentStatusClass = 'bg-secondary text-white';
        }
        paymentStatusElement.className = `badge ${paymentStatusClass}`;
        paymentStatusElement.textContent = order.payment_status.charAt(0).toUpperCase() + order.payment_status.slice(1);
        
        // Set total amount
        document.getElementById('orderDetailTotal').textContent = `$${order.total_amount}`;
        
        // Set customer information
        // const orderSku = order.order_number || '';
        // const firstName = order.shipping_address ? order.shipping_address.first_name || '' : '';
        // const lastName = order.shipping_address ? order.shipping_address.last_name || '' : '';
        // const customerName = `${firstName} ${lastName}`.trim() || 'Guest';
        // const formattedName = `${orderSku} (${customerName})`.trim();
        // const customerEmail = order.user_email || order.customer_email || 'N/A';
        // const customerPhone = order.customer_phone || (order.shipping_address && order.shipping_address.phone) || 'N/A';
        
        // document.getElementById('orderDetailCustomerName').innerHTML = `
        //     <span class="copy-text" data-value="${formattedName}">
        //         ${formattedName} <i class="fas fa-copy copy-icon" title="Copy name"></i>
        //     </span>
        // `;
        
        // document.getElementById('orderDetailCustomerEmail').innerHTML = `
        //     <span class="copy-text" data-value="${customerEmail}">
        //         ${customerEmail} <i class="fas fa-copy copy-icon" title="Copy email"></i>
        //     </span>
        // `;
        
        // document.getElementById('orderDetailCustomerPhone').innerHTML = `
        //     <span class="copy-text" data-value="${customerPhone}">
        //         ${customerPhone} <i class="fas fa-copy copy-icon" title="Copy phone"></i>
        //     </span>
        //     ${customerPhone !== 'N/A' ? `
        //     <a href="tel:${customerPhone}" class="ms-2 text-primary" title="Call customer">
        //         <i class="fas fa-phone-alt"></i>
        //     </a>` : ''}
        // `;
        
        // Set shipping address
        let addressText = 'No shipping address available';
        if (order.shipping_address) {
            try {
                const address = order.shipping_address;
                console.log('Shipping address:', address);
                
                const fullName = `${address.first_name || ''} ${address.last_name || ''}`;
                const addressLine1 = address.address_line_1 || '';
                const addressLine2 = address.address_line_2 || '';
                const cityStateZip = `${address.city || ''}, ${address.state || ''} ${address.postal_code || ''}`;
                const country = address.country || '';
                const phone = address.phone || '';
                const sku = order.sku || order.order_number || '';
                
                addressText = `
                    <div class="copy-text" data-value="${fullName}">
                        ${fullName} <i class="fas fa-copy copy-icon" title="Copy name"></i>
                    </div><br>
                    <div class="copy-text" data-value="${addressLine1}">
                        ${addressLine1} <i class="fas fa-copy copy-icon" title="Copy address"></i>
                    </div><br>
                    ${phone ? `<div class="copy-text" data-value="${phone}">Phone: ${phone} <i class="fas fa-copy copy-icon" title="Copy phone"></i>
                        <a href="tel:${phone}" class="ms-2 text-primary" title="Call customer">
                            <i class="fas fa-phone-alt"></i>
                        </a></div><br>` : ''}
                    <div id="orderProductsList">
                        <strong>Products:</strong> <span id="orderProductsText">Loading products...</span>
                    </div>
                `;
            } catch (error) {
                console.error('Error formatting shipping address:', error, order.shipping_address);
            }
        } else {
            console.log('No shipping address found in order data');
        }
        document.getElementById('orderDetailShippingAddress').innerHTML = addressText;
        
        // Initialize copy functionality for all copy buttons
        initCopyFunctionality();
        
        // Set order instructions (if available)
        const orderInstructionsContainer = document.getElementById('orderInstructionsContainer');
        if (order.instructions || order.customer_notes) {
            document.getElementById('orderDetailInstructions').textContent = order.instructions || order.customer_notes;
            orderInstructionsContainer.style.display = 'block'; // Show the container
        } else {
            document.getElementById('orderDetailInstructions').textContent = 'No special instructions provided.';
            orderInstructionsContainer.style.display = 'none'; // Hide the container
        }
        
        // Set up status change dropdown
        document.querySelectorAll('#statusDropdown .dropdown-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const newStatus = this.dataset.status;
                
                // Set values for confirmation modal
                document.getElementById('statusChangeOrderNumber').textContent = order.order_number;
                document.getElementById('statusChangeNewStatus').textContent = formatStatusName(newStatus);
                
                // Reset form fields
                document.getElementById('courierChargeInput').value = '';
                document.getElementById('partiallyRefundedInput').value = '';
                document.getElementById('partiallyRefundedError').style.display = 'none';
                
                // Show/hide partially refunded amount field based on status
                const partiallyRefundedContainer = document.getElementById('partiallyRefundedFieldContainer');
                if (newStatus === 'partially_returned') {
                    partiallyRefundedContainer.style.display = 'block';
                } else {
                    partiallyRefundedContainer.style.display = 'none';
                }
                
                // If we have existing courier charge, pre-fill the field
                if (order.curier_charge) {
                    document.getElementById('courierChargeInput').value = order.curier_charge;
                }
                
                // Show confirmation modal
                const modal = new bootstrap.Modal(document.getElementById('statusChangeModal'));
                modal.show();
                
                // Set up confirmation button
                document.getElementById('confirmStatusChangeBtn').onclick = function() {
                    // Just call updateOrderStatus - it will handle the modal closing
                    updateOrderStatus(order.id, newStatus);
                    // Don't hide the modal here - let updateOrderStatus handle it
                };
            });
        });
        
        // Set up print button
        document.getElementById('printOrderBtn').onclick = function() {
            // Redirect to invoice print view
            window.open(`/orders/${order.id}/invoice/`, '_blank');
        };
        
        // Set up add to courier button with SweetAlert2 confirmation
        document.getElementById('modalAddToCurierBtn').onclick = function() {
            // Check if order already has a courier ID
            if (order.curier_id) {
                Swal.fire({
                    title: 'Already Added to Courier',
                    text: `This order has already been added to courier service with ID: ${order.curier_id}`,
                    icon: 'info',
                    confirmButtonColor: '#28a745'
                });
            } else {
                Swal.fire({
                    title: 'Add to Courier Service',
                    text: 'Do you want to add this order to courier service? Order status will be changed to "shipped".',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, add to courier',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d'
                }).then((result) => {
                    if (result.isConfirmed) {
                        addOrderToCurier(order.id);
                    }
                });
            }
        };
        
        // Set up delete order button with SweetAlert2 confirmation
        document.getElementById('deleteOrderBtn').onclick = function() {
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this deletion!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteOrder(order.id);
                }
            });
        };
    }
    
    function displayOrderItems(items) {
        // Log items data for debugging
        console.log('Order items:', items);
        
        const tbody = document.getElementById('orderItemsTableBody');
        tbody.innerHTML = '';
        
        if (!items || items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No items in this order.</td></tr>';
            return;
        }
        
        let subtotal = 0;
        
        // Safer processing of items
        items.forEach((item, index) => {
            try {
                console.log(`Processing item ${index}:`, item);
                
                // Default values if data is missing
                const productName = item.product_name || 'Unknown Product';
                const variantName = item.variant_name || 'N/A';
                const variantSku = item.variant_sku || '';
                const quantity = Number(item.quantity) || 0;
                
                // Handle price fields with multiple fallbacks
                let unitPrice = 0;
                if (item.unit_price) {
                    unitPrice = Number(item.unit_price);
                } else if (item.price) {
                    unitPrice = Number(item.price);
                }
                
                // Calculate total with fallbacks
                let itemTotal = 0;
                if (item.total_price) {
                    itemTotal = Number(item.total_price);
                } else {
                    itemTotal = unitPrice * quantity;
                }
                
                // Format for display
                const formattedPrice = unitPrice.toFixed(2);
                const formattedTotal = itemTotal.toFixed(2);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="align-middle">${productName}</td>
                    <td class="align-middle">
                        ${variantName}
                        ${variantSku ? `<br><small class="text-muted">SKU: ${variantSku}</small>` : ''}
                    </td>
                    <td class="text-center align-middle">${quantity}</td>
                    <td class="text-end align-middle">$${formattedPrice}</td>
                    <td class="text-end align-middle">$${formattedTotal}</td>
                `;
                tbody.appendChild(tr);
                
                // Add to subtotal
                subtotal += itemTotal;
                console.log(`Added $${itemTotal} to subtotal, now: $${subtotal}`);
                
            } catch (error) {
                console.error(`Error rendering order item ${index}:`, error, item);
            }
        });
        
        // Set subtotal
        document.getElementById('orderDetailSubtotal').textContent = `$${subtotal.toFixed(2)}`;
        
        // Get current order for shipping and tax info
        const currentOrder = window.currentOrderData;
        console.log('Current order for totals:', currentOrder);
        
        // Set shipping, tax, and grand total using order data
        const shipping = currentOrder && currentOrder.shipping_cost ? Number(currentOrder.shipping_cost) : 0;
        const tax = currentOrder && currentOrder.tax_amount ? Number(currentOrder.tax_amount) : 0;
        
        console.log(`Shipping: $${shipping}, Tax: $${tax}, Subtotal: $${subtotal}`);
        
        document.getElementById('orderDetailShipping').textContent = `$${shipping.toFixed(2)}`;
        document.getElementById('orderDetailTax').textContent = `$${tax.toFixed(2)}`;
        document.getElementById('orderDetailGrandTotal').textContent = `$${(subtotal + shipping + tax).toFixed(2)}`;
        
        // Update products list in the shipping address section
        const productsListElement = document.getElementById('orderProductsText');
        if (productsListElement && items && items.length > 0) {
            const productsList = items.map(item => {
                const quantity = Number(item.quantity) || 0;
                
                // Use the same logic as the sticker to get the display name
                let displayName;
                const possibleSkuFields = [
                    'variant_display_name',
                    'variant_sku', 
                    'sku',
                    'product_variant_sku',
                    'variant_code'
                ];
                
                let skuFound = false;
                for (let field of possibleSkuFields) {
                    if (item[field] && typeof item[field] === 'string' && item[field].trim() !== '') {
                        displayName = item[field].trim();
                        skuFound = true;
                        break;
                    }
                }
                
                if (!skuFound && item.variant_name && typeof item.variant_name === 'string' && item.variant_name.trim() !== '') {
                    displayName = item.variant_name.trim();
                } else if (!skuFound && item.product_name && typeof item.product_name === 'string' && item.product_name.trim() !== '') {
                    displayName = item.product_name.trim();
                } else if (!skuFound) {
                    displayName = 'Unknown Product';
                }
                
                return `${displayName} × ${quantity}`;
            });
            
            productsListElement.textContent = productsList.join(', ');
        }
    }
    
    // Courier Sticker Functions
    function showCourierStickerModal(orderId) {
        console.log(`Showing courier sticker for order ID: ${orderId}`);
        
        // Find the order data
        const order = orders.find(o => o.id == orderId);
        if (!order) {
            console.error('Order not found:', orderId);
            showAlert('Order not found', 'danger');
            return;
        }
        
        if (!order.curier_id) {
            showAlert('This order has not been added to courier service yet.', 'warning');
            return;
        }
        
        // Set order number in modal
        document.getElementById('stickerOrderNumber').textContent = order.order_number;
        
        // Get customer name from shipping address
        let customerName = 'Guest Customer';
        if (order.shipping_address) {
            const firstName = order.shipping_address.first_name || '';
            const lastName = order.shipping_address.last_name || '';
            customerName = `Name: ${firstName} ${lastName}`.trim() || 'Guest Customer';
        }
        document.getElementById('stickerCustomerName').textContent = customerName;
        
        // Set courier ID and generate barcode
        // document.getElementById('stickerCourierId').textContent = `ID: ${order.curier_id}`;
        document.getElementById('stickerCourierIdSmall').textContent = `ID: ${order.curier_id}`;
        
        // Generate real barcode using JsBarcode
        generateRealBarcode(order.curier_id);
        
        // Load order items to populate products list
        loadOrderItemsForSticker(orderId);
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('courierStickerModal'));
        modal.show();
    }
    
    function loadOrderItemsForSticker(orderId) {
        // Show loading text
        document.getElementById('stickerProducts').innerHTML = '<small>Loading products...</small>';
        
        fetch(`/mb-admin/api/orders/${orderId}/items/`)
            .then(response => response.json())
            .then(items => {
                if (Array.isArray(items) && items.length > 0) {
                    const productLines = items.map(item => {
                        // Extended debug logging to see all available fields
                        console.log('FULL Item data for sticker:', item);
                        console.log('Available fields:', Object.keys(item));
                        console.log('Specific fields:', {
                            variant_sku: item.variant_sku,
                            variant_name: item.variant_name,
                            product_name: item.product_name,
                            sku: item.sku,
                            variant: item.variant,
                            product_variant_sku: item.product_variant_sku
                        });
                        
                        // Try multiple possible field names for the SKU
                        let displayName;
                        
                        // Check all possible SKU field names
                        const possibleSkuFields = [
                            'variant_display_name',  // New field with full SKU or variant name
                            'variant_sku',
                            'sku', 
                            'product_variant_sku',
                            'variant_code'
                        ];
                        
                        let skuFound = false;
                        for (let field of possibleSkuFields) {
                            if (item[field] && typeof item[field] === 'string' && item[field].trim() !== '') {
                                displayName = item[field].trim();
                                console.log(`Using ${field}:`, displayName);
                                skuFound = true;
                                break;
                            }
                        }
                        
                        // If no SKU found, try variant_name
                        if (!skuFound && item.variant_name && typeof item.variant_name === 'string' && item.variant_name.trim() !== '') {
                            displayName = item.variant_name.trim();
                            console.log('Using variant_name:', displayName);
                        } 
                        // If still no luck, try product_name
                        else if (!skuFound && item.product_name && typeof item.product_name === 'string' && item.product_name.trim() !== '') {
                            displayName = item.product_name.trim();
                            console.log('Using product_name:', displayName);
                        } 
                        // Last resort
                        else if (!skuFound) {
                            displayName = 'UNKNOWN';
                            console.log('Using fallback: UNKNOWN');
                        }
                        
                        const quantity = item.quantity || 1;
                        
                        // Format the product line with better display
                        if (displayName.includes('-') || displayName.includes(' ')) {
                            // If it's a proper SKU format, use it as is
                            return `${displayName} × ${quantity}`;
                        } else {
                            // If it's just a name, add some context
                            return `${item.product_name || displayName} (${displayName}) × ${quantity}`;
                        }
                    });
                    
                    // Join with line breaks for better readability in the sticker
                    document.getElementById('stickerProducts').innerHTML = productLines.join('<br>');
                } else {
                    document.getElementById('stickerProducts').innerHTML = '<small>No products found</small>';
                }
            })
            .catch(error => {
                console.error('Error loading order items for sticker:', error);
                document.getElementById('stickerProducts').innerHTML = '<small>Error loading products</small>';
            });
    }
    
    function generateRealBarcode(courierId) {
        try {
            const canvas = document.getElementById('stickerBarcodeCanvas');
            if (canvas && window.JsBarcode) {
                // Generate Code128 barcode
                JsBarcode(canvas, courierId.toString(), {
                    format: "CODE128",
                    width: 1,
                    height: 20,
                    displayValue: false,
                    background: "#ffffff",
                    lineColor: "#000000",
                    margin: 2
                });
            } else {
                console.warn('JsBarcode library not loaded or canvas not found');
                // Fallback to simple text representation
                document.getElementById('stickerBarcodeCanvas').style.display = 'none';
            }
        } catch (error) {
            console.error('Error generating barcode:', error);
            // Hide canvas on error
            document.getElementById('stickerBarcodeCanvas').style.display = 'none';
        }
    }
    
    function generateBarcode(courierId) {
        // Fallback function for old-style barcode (kept for compatibility)
        const barcodeChars = courierId.toString().split('');
        let barcode = '';
        
        // Add start pattern
        barcode += '|| ';
        
        // Convert each digit to barcode pattern
        barcodeChars.forEach(char => {
            switch(char) {
                case '0': barcode += '||| '; break;
                case '1': barcode += '||  '; break;
                case '2': barcode += '| | '; break;
                case '3': barcode += '|  |'; break;
                case '4': barcode += ' |||'; break;
                case '5': barcode += ' || '; break;
                case '6': barcode += ' | |'; break;
                case '7': barcode += '  ||'; break;
                case '8': barcode += '|||  '; break;
                case '9': barcode += '|| | '; break;
                default: barcode += '| | '; break;
            }
        });
        
        // Add end pattern
        barcode += ' ||';
        
        return barcode;
    }
    
    function printCourierSticker() {
        // Clone the sticker element
        const originalSticker = document.getElementById('courierSticker');
        const stickerClone = originalSticker.cloneNode(true);
        
        // Add print class
        stickerClone.classList.add('courier-sticker-print');
        stickerClone.removeAttribute('id');
        
        // Update barcode canvas ID to avoid conflicts
        const barcodeCanvas = stickerClone.querySelector('#stickerBarcodeCanvas');
        if (barcodeCanvas) {
            barcodeCanvas.id = 'printBarcodeCanvas';
        }
        
        // Create a new window for printing
        const printWindow = window.open('', '_blank', 'width=400,height=200');
        
        // Write the content to print window
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Courier Sticker</title>
                <style>
                    @page {
                        size: 2in 0.95in;
                        margin: 0;
                    }
                    
                    body {
                        margin: 0;
                        padding: 0;
                        font-family: Arial, sans-serif;
                    }
                    
                    .courier-sticker-print {
                        width: 2in !important;
                        height: 0.9in !important;
                        background: white;
                        border: 1px solid #333;
                        border-radius: 4px;
                        display: flex;
                        flex-direction: column;
                        font-size: 8px;
                        line-height: 1.0;
                        overflow: hidden;
                        padding: 3px;
                        -webkit-print-color-adjust: exact;
                        print-color-adjust: exact;
                        page-break-inside: avoid;
                    }
                    
                    .sticker-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        margin-bottom: 2px;
                        height: 0.18in;
                        min-height: 0.18in;
                    }
                    
                    .logo-section {
                        flex: 1;
                    }
                    
                    .sticker-logo {
                        max-width: 80px;
                        max-height: 25px;
                        object-fit: contain;
                    }
                    
                    .logo-fallback {
                        font-weight: bold;
                        font-size: 12px;
                        color: #333;
                        background: #f0f0f0;
                        border-radius: 50%;
                        width: 25px;
                        height: 25px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    
                    .barcode-section {
                        text-align: right;
                        flex: 1;
                    }
                    
                    .barcode-canvas {
                        max-width: 150px;
                        height: 18px;
                        border: 1px solid #ccc;
                        display: block;
                        margin-left: auto;
                    }
                    
                    .courier-id-small {
                        font-size: 10px;
                        font-weight: bold;
                        color: #333;
                        text-align: right;
                        margin-top: 2px;
                    }
                    
                    .sticker-content {
                        flex: 1;
                        display: flex;
                        flex-direction: column;
                        gap: 1px;
                        min-height: 0;
                        overflow: hidden;
                        margin-top: 12px;
                    }
                    
                    .customer-name {
                        font-size: 10px;
                        font-weight: 400;
                        color: #333;
                        line-height: 1.1;
                    }
                    
                    .courier-id-main {
                        font-size: 10px;
                        font-weight: bold;
                        color: #333;
                    }
                    
                    .products-list {
                        font-size: 7px;
                        color: #555;
                        line-height: 1.2;
                        flex: 1;
                    }
                    
                    .sticker-footer {
                        margin-top: auto;
                        padding-top: 1px;
                        border-top: 0.5px solid #000;
                        flex-shrink: 0;
                        min-height: 0.12in;
                        max-height: 0.12in;
                    }
                    
                    .contact-row {
                        display: flex;
                        justify-content: space-between;
                        font-size: 7px;
                        color: #333;
                        line-height: 1.0;
                        white-space: nowrap;
                        overflow: hidden;
                    }
                        color: #666;
                        line-height: 1.1;
                    }
                    
                    .website, .phone {
                        flex: 1;
                    }
                    
                    .phone {
                        text-align: right;
                    }
                </style>
            </head>
            <body>
                ${stickerClone.outerHTML}
            </body>
            </html>
        `);
        
        printWindow.document.close();
        
        // Wait for content to load, then regenerate barcode and print
        printWindow.onload = function() {
            // Regenerate barcode in print window if JsBarcode is available
            if (window.JsBarcode) {
                const printCanvas = printWindow.document.getElementById('printBarcodeCanvas');
                const originalCanvas = document.getElementById('stickerBarcodeCanvas');
                if (printCanvas && originalCanvas) {
                    // Copy the barcode from original canvas
                    const originalData = originalCanvas.toDataURL();
                    const img = new Image();
                    img.onload = function() {
                        const ctx = printCanvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, printCanvas.width, printCanvas.height);
                        setTimeout(() => {
                            printWindow.print();
                            printWindow.close();
                        }, 100);
                    };
                    img.src = originalData;
                } else {
                    setTimeout(() => {
                        printWindow.print();
                        printWindow.close();
                    }, 250);
                }
            } else {
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 250);
            }
        };
    }
    
    // Order actions
    function updateOrderStatus(orderId, newStatus) {
        const notifyCustomer = document.getElementById('notifyCustomerCheck').checked;
        const comment = document.getElementById('statusChangeComment').value.trim();
        const courierCharge = document.getElementById('courierChargeInput').value.trim();
        
        // Check if we need to validate the partially refunded amount
        let partiallyRefundedAmount = null;
        if (newStatus === 'partially_returned') {
            partiallyRefundedAmount = document.getElementById('partiallyRefundedInput').value.trim();
            
            // Validate that an amount is provided for partially_returned status
            if (!partiallyRefundedAmount) {
                document.getElementById('partiallyRefundedError').style.display = 'block';
                return; // Stop execution if validation fails
            } else {
                document.getElementById('partiallyRefundedError').style.display = 'none';
            }
        }
        
        console.log(`Updating order ${orderId} status to ${newStatus}`);
        console.log('CSRF Token:', getCookie('csrftoken'));
        
        const requestData = {
            status: newStatus,
            notify_customer: notifyCustomer,
            comment: comment
        };
        
        // Add courier charge if provided
        if (courierCharge) {
            requestData.curier_charge = parseFloat(courierCharge);
        }
        
        // Add partially refunded amount if applicable
        if (partiallyRefundedAmount) {
            requestData.partially_ammount = parseFloat(partiallyRefundedAmount);
        }
        
        console.log('Request data:', requestData);
        
        // Get the modal element reference for later cleanup
        const statusChangeModalElement = document.getElementById('statusChangeModal');
        
        fetch(`/mb-admin/api/orders/${orderId}/update_status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',  // Include cookies in the request
            body: JSON.stringify(requestData)
        })
        .then(response => {
            console.log('Update status response:', response.status);
            
            // Clone response to read it for debugging
            response.clone().text().then(text => {
                console.log('Raw update status response:', text);
                try {
                    const jsonData = JSON.parse(text);
                    console.log('Parsed update status response:', jsonData);
                } catch (err) {
                    console.log('Response is not JSON');
                }
            });
            
            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('Permission denied. CSRF token might be missing or invalid.');
                } else {
                    return response.text().then(text => {
                        throw new Error(`Failed to update status: ${text || response.statusText}`);
                    });
                }
            }
            return response.json();
        })
        .then(data => {
            console.log('Update successful, response data:', data);
            
            // Update status in UI
            document.getElementById('orderDetailStatus').textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
            
            // Update status badge class
            const statusElement = document.getElementById('orderDetailStatus');
            let statusBadgeClass;
            switch (newStatus) {
                case 'pending':
                    statusBadgeClass = 'bg-warning text-dark';
                    break;
                case 'processing':
                    statusBadgeClass = 'bg-info';
                    break;
                case 'shipped':
                    statusBadgeClass = 'bg-primary';
                    break;
                case 'delivered':
                    statusBadgeClass = 'bg-success';
                    break;
                case 'cancelled':
                    statusBadgeClass = 'bg-danger';
                    break;
                default:
                    statusBadgeClass = 'bg-secondary';
            }
            statusElement.className = `badge ${statusBadgeClass}`;
            
            // Clean up the modal properly using our helper function
            cleanupModal(statusChangeModalElement);
            
            // Handle inventory restocking for returned, partially returned, or cancelled orders
            if (['returned', 'partially_returned', 'cancelled'].includes(newStatus)) {
                // Call the restock function
                restockOrderItems(orderId, newStatus);
            }
            
            // Refresh orders list in background
            loadOrders(currentPage);
            
            // Show success notification with SweetAlert2
            Swal.fire({
                title: 'Status Updated',
                text: `Order status has been changed to ${formatStatusName(newStatus)}`,
                icon: 'success',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 5000,
                timerProgressBar: true
            });
        })
        .catch(error => {
            console.error('Error updating order status:', error);
            showAlert(`Failed to update order status: ${error.message}`, 'danger');
            
            // Ensure modal is closed properly even on error
            cleanupModal(statusChangeModalElement);
        });
    }
    
    // Function removed: sendInvoiceEmail
    
    // Helper function to restock items when order is returned, partially returned, or cancelled
    function restockOrderItems(orderId, statusType) {
        console.log(`Restocking items for order ${orderId} due to ${statusType} status`);
        
        // Make API call to restock items
        fetch(`/mb-admin/api/orders/${orderId}/restock/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',
            body: JSON.stringify({ 
                status_type: statusType,
                // For partially_returned, we'd need to specify which items are returned
                // This simple implementation restocks all items
                restock_all: (statusType === 'returned' || statusType === 'cancelled')
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`Failed to restock items: ${text || response.statusText}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Restock successful:', data);
            // Show a notification about restocked items
            Swal.fire({
                title: 'Items Restocked',
                text: `Inventory has been updated for returned/cancelled items.`,
                icon: 'info',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 4000
            });
        })
        .catch(error => {
            console.error('Error restocking items:', error);
            showAlert(`Failed to restock items: ${error.message}`, 'warning');
        });
    }
    
    // Helper function to properly clean up a modal
    function cleanupModal(modalElement) {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
            
            // Remove backdrop manually if it's still there
            setTimeout(() => {
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
                // Also remove any body classes that Bootstrap might have added
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }, 300);
        }
    }
    
    function deleteOrder(orderId) {
        console.log(`Attempting to delete order ID: ${orderId}`);
        console.log('CSRF Token:', getCookie('csrftoken'));
        
        // Reference the modal element
        const orderModalElement = document.getElementById('orderDetailsModal');
        
        fetch(`/mb-admin/api/orders/${orderId}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin'  // Include cookies in the request
        })
        .then(response => {
            console.log('Delete response status:', response.status);
            
            // Clone response to read it for debugging
            response.clone().text().then(text => {
                console.log('Raw delete response:', text);
                try {
                    const jsonData = JSON.parse(text);
                    console.log('Parsed delete response:', jsonData);
                } catch (err) {
                    console.log('Response is not JSON');
                }
            });
            
            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('Permission denied. CSRF token might be missing or invalid.');
                } else if (response.status === 500) {
                    // Handle 500 internal server error separately to provide more useful information
                    return response.text().then(text => {
                        if (text.includes('no such table')) {
                            // Handle database table missing error
                            const errorMessage = 'Database table missing. The order will be deleted, but activity logging might fail.';
                            console.warn(errorMessage);
                            
                            // Close the modal properly even though there was an error
                            cleanupModal(orderModalElement);
                            
                            // Refresh orders list in case the delete actually worked
                            loadOrders(currentPage);
                            
                            showAlert('Order might have been deleted, but there was a database error. Please verify.', 'warning');
                            return; // Return early to avoid throwing error
                        }
                        throw new Error(`Failed to delete order: ${text || response.statusText}`);
                    });
                } else {
                    return response.text().then(text => {
                        throw new Error(`Failed to delete order: ${text || response.statusText}`);
                    });
                }
            }
            
            // Hide the modal properly using our cleanup function
            cleanupModal(orderModalElement);
            
            // Refresh orders list
            loadOrders(currentPage);
            
            // Show success notification with SweetAlert2
            Swal.fire({
                title: 'Deleted!',
                text: 'The order has been deleted successfully.',
                icon: 'success',
                confirmButtonColor: '#28a745'
            });
        })
        .catch(error => {
            console.error('Error deleting order:', error);
            showAlert(`Failed to delete order: ${error.message}`, 'danger');
            
            // Ensure modal is closed properly even on error
            cleanupModal(orderModalElement);
        });
    }
    
    // Helper functions
    // Function to add order to curier service
    function addOrderToCurier(orderId) {
        console.log(`Adding order ${orderId} to curier service`);
        
        // Show loading indicator
        Swal.fire({
            title: 'Processing',
            text: 'Adding order to courier service...',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        fetch(`/mb-admin/api/orders/${orderId}/add_to_curier/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`Failed to add order to curier service: ${text || response.statusText}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Order added to curier service:', data);
            
            // Extract consignment ID if available
            const consignmentId = data.curier_id || 
                (data.response && data.response.consignment && data.response.consignment.consignment_id) || 
                'Generated';
            
            // Show success message with consignment ID
            Swal.fire({
                title: 'Success!',
                text: `Order has been successfully added to courier service! Consignment ID: ${consignmentId}`,
                icon: 'success',
                confirmButtonColor: '#28a745',
                confirmButtonText: 'Great!'
            });
            
            // Refresh orders list to update UI
            loadOrders(currentPage);
        })
        .catch(error => {
            console.error('Error adding order to curier service:', error);
            
            Swal.fire({
                title: 'Error!',
                text: `Failed to add order to courier service: ${error.message}`,
                icon: 'error',
                confirmButtonColor: '#dc3545',
                confirmButtonText: 'OK'
            });
        });
    }
    
    function showAlert(message, type) {
        // Map Bootstrap alert types to SweetAlert2 icons
        const iconMap = {
            'success': 'success',
            'danger': 'error',
            'warning': 'warning',
            'info': 'info'
        };
        
        // Map Bootstrap colors to SweetAlert2 button colors
        const buttonColorMap = {
            'success': '#28a745',
            'danger': '#dc3545',
            'warning': '#ffc107',
            'info': '#17a2b8'
        };
        
        // Use SweetAlert2 for modern alerts
        Swal.fire({
            title: type.charAt(0).toUpperCase() + type.slice(1),
            text: message,
            icon: iconMap[type] || 'info',
            confirmButtonColor: buttonColorMap[type] || '#6c757d',
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 5000,
            timerProgressBar: true
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        
        // First try to get from cookies
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        
        // If we couldn't find the CSRF token in cookies, try to get it from the hidden input field
        if (!cookieValue && name === 'csrftoken') {
            const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (csrfInput) {
                cookieValue = csrfInput.value;
                console.log('Got CSRF token from hidden input:', cookieValue);
            }
        }
        
        return cookieValue;
    }
});
</script>
{% endblock %}