{% extends 'dashboard/base.html' %}

{% block title %}Products - MB Admin{% endblock %}

{% block page_title %}Products Management{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">All Products</h5>
        <div>
            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="fas fa-plus-circle me-1"></i> Add Product
            </button>
            <button class="btn btn-sm btn-secondary" id="refreshProductsBtn">
                <i class="fas fa-sync-alt me-1"></i> Refresh
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <div class="row g-2">
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" id="productSearchInput" placeholder="Search products...">
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" id="categoryFilter">
                        <option value="">All Categories</option>
                        <!-- Categories will be loaded dynamically -->
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary btn-sm w-100" id="applyFiltersBtn">
                        <i class="fas fa-filter me-1"></i> Apply Filters
                    </button>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Base Price</th>
                        <th>Variants</th>
                        <th>Status</th>
                        <th>Last Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody">
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading products...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <span id="productsTotalCount">0</span> products
            </div>
            <div>
                <nav aria-label="Products pagination">
                    <ul class="pagination pagination-sm" id="productsPagination">
                        <!-- Pagination will be generated dynamically -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Product Variants Section -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Product Variants</h5>
        <button class="btn btn-sm btn-success" id="addVariantBtn" disabled data-bs-toggle="modal" data-bs-target="#addVariantModal">
            <i class="fas fa-plus-circle me-1"></i> Add Variant
        </button>
    </div>
    <div class="card-body">
        <div id="selectProductMessage" class="text-center py-4">
            <i class="fas fa-hand-pointer fa-2x mb-3 text-secondary"></i>
            <p>Select a product from the table above to manage its variants.</p>
        </div>
        
        <div id="variantsContainer" style="display: none;">
            <h6 id="selectedProductName" class="mb-3 border-bottom pb-2"></h6>
            
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>SKU</th>
                            <th>Name & Image</th>
                            <th>Color</th>
                            <th>Size</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="variantsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProductModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Add New Product
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm" enctype="multipart/form-data">
                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-8">
                            <!-- Basic Information -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-8">
                                            <label for="productName" class="form-label">Product Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="productName" name="name" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="productSlug" class="form-label">Slug</label>
                                            <input type="text" class="form-control" id="productSlug" name="slug" placeholder="Auto-generated">
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="productDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="productDescription" name="description" rows="4" placeholder="Detailed product description..."></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="productShortDescription" class="form-label">Short Description</label>
                                        <textarea class="form-control" id="productShortDescription" name="short_description" rows="2" placeholder="Brief description for product listings..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Product Identification -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-barcode me-2"></i>Product Identification</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="productSKU" class="form-label">SKU (Stock Keeping Unit)</label>
                                            <input type="text" class="form-control" id="productSKU" name="sku" placeholder="e.g., MB-001">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="productBarcode" class="form-label">Barcode</label>
                                            <input type="text" class="form-control" id="productBarcode" name="barcode" placeholder="Product barcode">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pricing -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Pricing</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="productPrice" class="form-label">Price <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="productPrice" name="price" step="0.01" min="0" required>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="productComparePrice" class="form-label">Compare Price</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="productComparePrice" name="compare_price" step="0.01" min="0" placeholder="Original price">
                                            </div>
                                            <small class="text-muted">Show discount compared to this price</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="productCostPrice" class="form-label">Cost Price</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="productCostPrice" name="cost_price" step="0.01" min="0" placeholder="Cost to you">
                                            </div>
                                            <small class="text-muted">For profit calculations</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Inventory -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-boxes me-2"></i>Inventory</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="productStockQuantity" class="form-label">Stock Quantity</label>
                                            <input type="number" class="form-control" id="productStockQuantity" name="stock_quantity" min="0" value="0">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="productLowStockThreshold" class="form-label">Low Stock Threshold</label>
                                            <input type="number" class="form-control" id="productLowStockThreshold" name="low_stock_threshold" min="0" value="5">
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox" id="productTrackInventory" name="track_inventory" checked>
                                                <label class="form-check-label" for="productTrackInventory">
                                                    Track Inventory
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Physical Attributes -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-weight me-2"></i>Physical Attributes</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="productWeight" class="form-label">Weight (kg)</label>
                                            <input type="number" class="form-control" id="productWeight" name="weight" step="0.01" min="0" placeholder="0.00">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="productDimensions" class="form-label">Dimensions</label>
                                            <input type="text" class="form-control" id="productDimensions" name="dimensions" placeholder="L x W x H (cm)">
                                            <small class="text-muted">Example: 20 x 15 x 5</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Shipping Options -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-shipping-fast me-2"></i>Shipping Options</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="productShippingType" class="form-label">Shipping Type</label>
                                        <select class="form-select" id="productShippingType" name="shipping_type">
                                            <option value="standard">Shipping with Charge (Dhaka: 70 Tk, Outside: 120 Tk)</option>
                                            <option value="free">Free Shipping</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="productHasExpressShipping" name="has_express_shipping">
                                        <label class="form-check-label" for="productHasExpressShipping">
                                            Enable Express Shipping (Same Day Delivery in Dhaka)
                                        </label>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="productCustomShippingDhaka" class="form-label">Custom Dhaka Shipping</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="productCustomShippingDhaka" name="custom_shipping_dhaka" step="0.01" min="0" placeholder="70">
                                            </div>
                                            <small class="text-muted">Leave blank for default (70 Tk)</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="productCustomShippingOutside" class="form-label">Custom Outside Dhaka</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="productCustomShippingOutside" name="custom_shipping_outside" step="0.01" min="0" placeholder="120">
                                            </div>
                                            <small class="text-muted">Leave blank for default (120 Tk)</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="productCustomExpressShipping" class="form-label">Custom Express Shipping</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="productCustomExpressShipping" name="custom_express_shipping" step="0.01" min="0" placeholder="150">
                                            </div>
                                            <small class="text-muted">Leave blank for default (150 Tk)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- SEO -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-search me-2"></i>SEO Settings</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="productMetaTitle" class="form-label">Meta Title</label>
                                        <input type="text" class="form-control" id="productMetaTitle" name="meta_title" maxlength="200" placeholder="SEO title for search engines">
                                        <small class="text-muted">Recommended: 50-60 characters</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="productMetaDescription" class="form-label">Meta Description</label>
                                        <textarea class="form-control" id="productMetaDescription" name="meta_description" rows="3" maxlength="300" placeholder="SEO description for search engines"></textarea>
                                        <small class="text-muted">Recommended: 150-160 characters</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Media -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-video me-2"></i>Media</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="productYoutubeUrl" class="form-label">YouTube Video URL</label>
                                        <input type="url" class="form-control" id="productYoutubeUrl" name="youtube_video_url" placeholder="https://www.youtube.com/watch?v=VIDEO_ID">
                                        <small class="text-muted">Add a YouTube video to showcase your product</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="col-md-4">
                            <!-- Product Status -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-toggle-on me-2"></i>Status</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="productStatus" class="form-label">Status</label>
                                        <select class="form-select" id="productStatus" name="is_active">
                                            <option value="true" selected>Active</option>
                                            <option value="false">Inactive</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="productIsFeatured" name="is_featured">
                                        <label class="form-check-label" for="productIsFeatured">
                                            Featured Product
                                        </label>
                                        <small class="form-text text-muted d-block">Show in featured product sections</small>
                                    </div>
                                    
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="productIsDigital" name="is_digital">
                                        <label class="form-check-label" for="productIsDigital">
                                            Digital Product
                                        </label>
                                        <small class="form-text text-muted d-block">No physical shipping required</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Category -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-tags me-2"></i>Category</h6>
                                </div>
                                <div class="card-body">
                                    <label for="productCategory" class="form-label">Category <span class="text-danger">*</span></label>
                                    <select class="form-select" id="productCategory" name="category" required>
                                        <option value="">Select Category</option>
                                        <!-- Categories will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>

                            <!-- Product Images -->
                            <div class="card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="fas fa-images me-2"></i>Product Images</h6>
                                    <small class="text-muted">Drag to reorder • First image is primary</small>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="productImages" class="form-label">Upload Images</label>
                                        <input type="file" class="form-control" id="productImages" name="images" multiple accept="image/*">
                                        <small class="text-muted">Select multiple images (JPG, PNG, WebP). Maximum 10 images per product.</small>
                                    </div>
                                    
                                    <div id="imagePreview" class="row g-2" style="display: none;">
                                        <!-- Image previews will be shown here -->
                                    </div>
                                    
                                    <!-- Image Management Container -->
                                    <div id="imageManagementContainer" style="display: none;">
                                        <hr>
                                        <h6 class="mb-3">Image Management</h6>
                                        <div id="imageManagementList" class="row g-3">
                                            <!-- Dynamic image management cards will be inserted here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-success" id="saveProductBtn">
                                    <i class="fas fa-save me-1"></i> Save Product
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProductModalLabel">
                    <i class="fas fa-edit me-2"></i>Edit Product
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm" enctype="multipart/form-data">
                    <input type="hidden" id="editProductId" name="id">
                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-8">
                            <!-- Basic Information -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-8">
                                            <label for="editProductName" class="form-label">Product Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="editProductName" name="name" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="editProductSlug" class="form-label">Slug</label>
                                            <input type="text" class="form-control" id="editProductSlug" name="slug" placeholder="Auto-generated">
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="editProductDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="editProductDescription" name="description" rows="4" placeholder="Detailed product description..."></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="editProductShortDescription" class="form-label">Short Description</label>
                                        <textarea class="form-control" id="editProductShortDescription" name="short_description" rows="2" placeholder="Brief description for product listings..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Product Identification -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-barcode me-2"></i>Product Identification</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="editProductSKU" class="form-label">SKU (Stock Keeping Unit)</label>
                                            <input type="text" class="form-control" id="editProductSKU" name="sku" placeholder="e.g., MB-001">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="editProductBarcode" class="form-label">Barcode</label>
                                            <input type="text" class="form-control" id="editProductBarcode" name="barcode" placeholder="Product barcode">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pricing -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Pricing</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="editProductPrice" class="form-label">Price <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="editProductPrice" name="price" step="0.01" min="0" required>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="editProductComparePrice" class="form-label">Compare Price</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="editProductComparePrice" name="compare_price" step="0.01" min="0" placeholder="Original price">
                                            </div>
                                            <small class="text-muted">Show discount compared to this price</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="editProductCostPrice" class="form-label">Cost Price</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="editProductCostPrice" name="cost_price" step="0.01" min="0" placeholder="Cost to you">
                                            </div>
                                            <small class="text-muted">For profit calculations</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Inventory -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-boxes me-2"></i>Inventory</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="editProductStockQuantity" class="form-label">Stock Quantity</label>
                                            <input type="number" class="form-control" id="editProductStockQuantity" name="stock_quantity" min="0" value="0">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="editProductLowStockThreshold" class="form-label">Low Stock Threshold</label>
                                            <input type="number" class="form-control" id="editProductLowStockThreshold" name="low_stock_threshold" min="0" value="5">
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox" id="editProductTrackInventory" name="track_inventory" checked>
                                                <label class="form-check-label" for="editProductTrackInventory">
                                                    Track Inventory
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Physical Attributes -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-weight me-2"></i>Physical Attributes</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="editProductWeight" class="form-label">Weight (kg)</label>
                                            <input type="number" class="form-control" id="editProductWeight" name="weight" step="0.01" min="0" placeholder="0.00">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="editProductDimensions" class="form-label">Dimensions</label>
                                            <input type="text" class="form-control" id="editProductDimensions" name="dimensions" placeholder="L x W x H (cm)">
                                            <small class="text-muted">Example: 20 x 15 x 5</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Shipping Options -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-shipping-fast me-2"></i>Shipping Options</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="editProductShippingType" class="form-label">Shipping Type</label>
                                        <select class="form-select" id="editProductShippingType" name="shipping_type">
                                            <option value="standard">Shipping with Charge (Dhaka: 70 Tk, Outside: 120 Tk)</option>
                                            <option value="free">Free Shipping</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="editProductHasExpressShipping" name="has_express_shipping">
                                        <label class="form-check-label" for="editProductHasExpressShipping">
                                            Enable Express Shipping (Same Day Delivery in Dhaka)
                                        </label>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="editProductCustomShippingDhaka" class="form-label">Custom Dhaka Shipping</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="editProductCustomShippingDhaka" name="custom_shipping_dhaka" step="0.01" min="0" placeholder="70">
                                            </div>
                                            <small class="text-muted">Leave blank for default (70 Tk)</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="editProductCustomShippingOutside" class="form-label">Custom Outside Dhaka</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="editProductCustomShippingOutside" name="custom_shipping_outside" step="0.01" min="0" placeholder="120">
                                            </div>
                                            <small class="text-muted">Leave blank for default (120 Tk)</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="editProductCustomExpressShipping" class="form-label">Custom Express Shipping</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="editProductCustomExpressShipping" name="custom_express_shipping" step="0.01" min="0" placeholder="150">
                                            </div>
                                            <small class="text-muted">Leave blank for default (150 Tk)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- SEO -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-search me-2"></i>SEO Settings</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="editProductMetaTitle" class="form-label">Meta Title</label>
                                        <input type="text" class="form-control" id="editProductMetaTitle" name="meta_title" maxlength="200" placeholder="SEO title for search engines">
                                        <small class="text-muted">Recommended: 50-60 characters</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="editProductMetaDescription" class="form-label">Meta Description</label>
                                        <textarea class="form-control" id="editProductMetaDescription" name="meta_description" rows="3" maxlength="300" placeholder="SEO description for search engines"></textarea>
                                        <small class="text-muted">Recommended: 150-160 characters</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Media -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-video me-2"></i>Media</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="editProductYoutubeUrl" class="form-label">YouTube Video URL</label>
                                        <input type="url" class="form-control" id="editProductYoutubeUrl" name="youtube_video_url" placeholder="https://www.youtube.com/watch?v=VIDEO_ID">
                                        <small class="text-muted">Add a YouTube video to showcase your product</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="col-md-4">
                            <!-- Product Status -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-toggle-on me-2"></i>Status</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="editProductStatus" class="form-label">Status</label>
                                        <select class="form-select" id="editProductStatus" name="is_active">
                                            <option value="true">Active</option>
                                            <option value="false">Inactive</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="editProductIsFeatured" name="is_featured">
                                        <label class="form-check-label" for="editProductIsFeatured">
                                            Featured Product
                                        </label>
                                        <small class="form-text text-muted d-block">Show in featured product sections</small>
                                    </div>
                                    
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="editProductIsDigital" name="is_digital">
                                        <label class="form-check-label" for="editProductIsDigital">
                                            Digital Product
                                        </label>
                                        <small class="form-text text-muted d-block">No physical shipping required</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Category -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-tags me-2"></i>Category</h6>
                                </div>
                                <div class="card-body">
                                    <label for="editProductCategory" class="form-label">Category <span class="text-danger">*</span></label>
                                    <select class="form-select" id="editProductCategory" name="category" required>
                                        <option value="">Select Category</option>
                                        <!-- Categories will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>

                            <!-- Product Images -->
                            <div class="card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="fas fa-images me-2"></i>Product Images</h6>
                                    <small class="text-muted">Drag to reorder • Click star for primary</small>
                                </div>
                                <div class="card-body">
                                    <!-- Current Images Management -->
                                    <div id="editCurrentImagesContainer" class="mb-3" style="display: none;">
                                        <label class="form-label">Current Images</label>
                                        <div id="editCurrentImages" class="row g-2">
                                            <!-- Current images will be shown here -->
                                        </div>
                                    </div>
                                    
                                    <!-- Add New Images -->
                                    <div class="mb-3">
                                        <label for="editProductImages" class="form-label">Upload New Images</label>
                                        <input type="file" class="form-control" id="editProductImages" name="images" multiple accept="image/*">
                                        <small class="text-muted">Select new images to add (JPG, PNG, WebP). Maximum 10 images total.</small>
                                    </div>
                                    
                                    <div id="editImagePreview" class="row g-2" style="display: none;">
                                        <!-- New image previews will be shown here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-success" id="updateProductBtn">
                                    <i class="fas fa-save me-1"></i> Update Product
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Variant Modal -->
<div class="modal fade" id="addVariantModal" tabindex="-1" aria-labelledby="addVariantModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addVariantModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Add Product Variant
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addVariantForm" enctype="multipart/form-data">
                    <input type="hidden" id="variantProductId">
                    
                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-8">
                            <!-- Basic Information -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="variantSKU" class="form-label">SKU <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="variantSKU" name="sku" required placeholder="e.g., MB-001-RED">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="variantName" class="form-label">Variant Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="variantName" name="name" required placeholder="e.g., Red - Large">
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="variantColor" class="form-label">Color</label>
                                            <input type="text" class="form-control" id="variantColor" name="color" placeholder="e.g., Red, Blue, Black">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="variantSize" class="form-label">Size</label>
                                            <input type="text" class="form-control" id="variantSize" name="size" placeholder="e.g., Small, Medium, Large">
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="variantMaterial" class="form-label">Material</label>
                                        <input type="text" class="form-control" id="variantMaterial" name="material" placeholder="e.g., Cotton, Polyester, Denim">
                                    </div>
                                </div>
                            </div>

                            <!-- Pricing & Inventory -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Pricing & Inventory</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="variantPrice" class="form-label">Price <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="variantPrice" name="price" step="0.01" min="0" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="variantStock" class="form-label">Stock Quantity</label>
                                            <input type="number" class="form-control" id="variantStock" name="stock_quantity" min="0" value="0">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="col-md-4">
                            <!-- Status -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-toggle-on me-2"></i>Status</h6>
                                </div>
                                <div class="card-body">
                                    <label for="variantStatus" class="form-label">Status</label>
                                    <select class="form-select" id="variantStatus" name="is_active">
                                        <option value="true" selected>Active</option>
                                        <option value="false">Inactive</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Variant Image -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-image me-2"></i>Variant Image</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="variantImage" class="form-label">Upload Image</label>
                                        <input type="file" class="form-control" id="variantImage" name="image" accept="image/*">
                                        <small class="text-muted">Optional: Specific image for this variant</small>
                                    </div>
                                    
                                    <div id="variantImagePreview" class="text-center" style="display: none;">
                                        <img id="variantImagePreviewImg" src="" alt="Variant Preview" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-success" id="saveVariantBtn">
                                    <i class="fas fa-save me-1"></i> Save Variant
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Variant Modal -->
<div class="modal fade" id="editVariantModal" tabindex="-1" aria-labelledby="editVariantModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editVariantModalLabel">
                    <i class="fas fa-edit me-2"></i>Edit Variant
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editVariantForm" enctype="multipart/form-data">
                    <input type="hidden" id="editVariantId">
                    <input type="hidden" id="editVariantProductId">
                    
                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-8">
                            <!-- Basic Information -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="editVariantSKU" class="form-label">SKU <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="editVariantSKU" name="sku" required placeholder="e.g., MB-001-RED">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="editVariantName" class="form-label">Variant Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="editVariantName" name="name" required placeholder="e.g., Red - Large">
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="editVariantColor" class="form-label">Color</label>
                                            <input type="text" class="form-control" id="editVariantColor" name="color" placeholder="e.g., Red, Blue, Black">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="editVariantSize" class="form-label">Size</label>
                                            <input type="text" class="form-control" id="editVariantSize" name="size" placeholder="e.g., Small, Medium, Large">
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="editVariantMaterial" class="form-label">Material</label>
                                        <input type="text" class="form-control" id="editVariantMaterial" name="material" placeholder="e.g., Cotton, Polyester, Denim">
                                    </div>
                                </div>
                            </div>

                            <!-- Pricing & Inventory -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Pricing & Inventory</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="editVariantPrice" class="form-label">Price <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="editVariantPrice" name="price" step="0.01" min="0" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="editVariantStock" class="form-label">Stock Quantity</label>
                                            <input type="number" class="form-control" id="editVariantStock" name="stock_quantity" min="0" required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="col-md-4">
                            <!-- Status -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-toggle-on me-2"></i>Status</h6>
                                </div>
                                <div class="card-body">
                                    <label for="editVariantStatus" class="form-label">Status</label>
                                    <select class="form-select" id="editVariantStatus" name="is_active">
                                        <option value="true">Active</option>
                                        <option value="false">Inactive</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Current Image -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-image me-2"></i>Variant Image</h6>
                                </div>
                                <div class="card-body">
                                    <!-- Current Image Display -->
                                    <div id="editCurrentImageContainer" class="mb-3" style="display: none;">
                                        <label class="form-label">Current Image</label>
                                        <div class="text-center">
                                            <img id="editCurrentImage" src="" alt="Current Variant Image" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                                            <br>
                                            <small class="text-muted">Current variant image</small>
                                        </div>
                                    </div>
                                    
                                    <!-- New Image Upload -->
                                    <div class="mb-3">
                                        <label for="editVariantImage" class="form-label">Upload New Image</label>
                                        <input type="file" class="form-control" id="editVariantImage" name="image" accept="image/*">
                                        <small class="text-muted">Leave empty to keep current image</small>
                                    </div>
                                    
                                    <div id="editVariantImagePreview" class="text-center" style="display: none;">
                                        <img id="editVariantImagePreviewImg" src="" alt="New Variant Preview" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                                        <br>
                                        <small class="text-success">New image preview</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-primary" id="updateVariantBtn">
                                    <i class="fas fa-save me-1"></i> Update Variant
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let selectedProductId = null;
    
    // Initial data loading
    loadCategories();
    loadProducts();
    
    // Event listeners
    document.getElementById('refreshProductsBtn').addEventListener('click', loadProducts);
    document.getElementById('applyFiltersBtn').addEventListener('click', loadProducts);
    document.getElementById('saveProductBtn').addEventListener('click', saveProduct);
    document.getElementById('updateProductBtn').addEventListener('click', updateProduct);
    document.getElementById('saveVariantBtn').addEventListener('click', saveVariant);
    document.getElementById('updateVariantBtn').addEventListener('click', updateVariant);
    
    // Image preview functionality
    document.getElementById('productImages').addEventListener('change', function() {
        handleImagePreview(this.files, 'imagePreview');
    });
    
    document.getElementById('editProductImages').addEventListener('change', function() {
        handleImagePreview(this.files, 'editImagePreview');
    });
    
    // Variant image preview functionality
    document.getElementById('variantImage').addEventListener('change', function() {
        handleVariantImagePreview(this, 'variantImagePreview', 'variantImagePreviewImg');
    });
    
    document.getElementById('editVariantImage').addEventListener('change', function() {
        handleVariantImagePreview(this, 'editVariantImagePreview', 'editVariantImagePreviewImg');
    });
    
    // Auto-generate slug from product name
    document.getElementById('productName').addEventListener('input', function() {
        const slug = generateSlug(this.value);
        document.getElementById('productSlug').value = slug;
    });
    
    document.getElementById('editProductName').addEventListener('input', function() {
        const slug = generateSlug(this.value);
        document.getElementById('editProductSlug').value = slug;
    });
    
    // Load categories for dropdowns
    function loadCategories() {
        fetch('/mb-admin/api/categories/')
            .then(response => response.json())
            .then(data => {
                const categories = data.results || data;
                populateCategoryDropdown('productCategory', categories);
                populateCategoryDropdown('editProductCategory', categories);
                populateCategoryDropdown('categoryFilter', categories);
            })
            .catch(error => console.error('Error loading categories:', error));
    }
    
    function populateCategoryDropdown(elementId, categories) {
        const dropdown = document.getElementById(elementId);
        const currentValue = dropdown.value;
        
        // Clear existing options except the first one if it's a filter
        if (elementId === 'categoryFilter') {
            dropdown.innerHTML = '<option value="">All Categories</option>';
        } else {
            dropdown.innerHTML = '';
        }
        
        // Add categories to dropdown
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            dropdown.appendChild(option);
        });
        
        // Restore selected value if there was one
        if (currentValue) {
            dropdown.value = currentValue;
        }
    }
    
    // Load products with pagination and filtering
    function loadProducts(page = 1) {
        currentPage = page;
        const searchTerm = document.getElementById('productSearchInput').value.trim();
        const categoryFilter = document.getElementById('categoryFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        
        let url = `/mb-admin/api/products/?page=${page}`;
        
        if (searchTerm) {
            url += `&search=${encodeURIComponent(searchTerm)}`;
        }
        
        if (categoryFilter) {
            url += `&category=${categoryFilter}`;
        }
        
        if (statusFilter !== '') {
            url += `&is_active=${statusFilter}`;
        }
        
        // Show loading indicator
        document.getElementById('productsTableBody').innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading products...</p>
                </td>
            </tr>
        `;
        
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Server responded with an error');
                }
                return response.json();
            })
            .then(data => {
                displayProducts(data.results);
                updatePagination(data);
                document.getElementById('productsTotalCount').textContent = data.count || 0;
            })
            .catch(error => {
                console.error('Error loading products:', error);
                document.getElementById('productsTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="alert alert-danger" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Error loading products. Please try again.</strong>
                            </div>
                        </td>
                    </tr>
                `;
                
                // Also display a top alert
                showAlert('Error loading products. Please try again.', 'danger');
            });
    }
    
    function displayProducts(products) {
        const tbody = document.getElementById('productsTableBody');
        tbody.innerHTML = '';
        
        if (!products || products.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">No products found.</td>
                </tr>
            `;
            return;
        }
        
        products.forEach(product => {
            const tr = document.createElement('tr');
            tr.dataset.productId = product.id;
            tr.innerHTML = `
                <td>${product.id}</td>
                <td>${product.name}</td>
                <td>${product.category_name}</td>
                <td>$${product.base_price}</td>
                <td>${product.variant_count || 0}</td>
                <td>
                    <span class="badge ${product.is_active ? 'bg-success' : 'bg-secondary'}">
                        ${product.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>${new Date(product.updated_at).toLocaleDateString()}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary edit-product-btn" data-product-id="${product.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger delete-product-btn" data-product-id="${product.id}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <button type="button" class="btn btn-outline-info view-variants-btn" data-product-id="${product.id}" data-product-name="${product.name}">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Add event listeners to the action buttons
        addProductActionListeners();
    }
    
    function addProductActionListeners() {
        document.querySelectorAll('.edit-product-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.dataset.productId;
                loadProductDetails(productId);
            });
        });
        
        document.querySelectorAll('.delete-product-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.dataset.productId;
                if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                    deleteProduct(productId);
                }
            });
        });
        
        document.querySelectorAll('.view-variants-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                selectedProductId = this.dataset.productId;
                const productName = this.dataset.productName;
                document.getElementById('selectedProductName').textContent = productName;
                document.getElementById('variantProductId').value = selectedProductId;
                document.getElementById('addVariantBtn').disabled = false;
                loadProductVariants(selectedProductId);
            });
        });
    }
    
    function updatePagination(data) {
        const pagination = document.getElementById('productsPagination');
        pagination.innerHTML = '';
        
        const totalPages = Math.ceil(data.count / data.results.length);
        if (totalPages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
        pagination.appendChild(prevLi);
        
        // Page numbers
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            pagination.appendChild(li);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
        pagination.appendChild(nextLi);
        
        // Add event listeners to pagination links
        document.querySelectorAll('#productsPagination .page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.dataset.page);
                loadProducts(page);
            });
        });
    }
    
    // Product CRUD operations
    function saveProduct() {
        const form = document.getElementById('addProductForm');
        const formData = new FormData(form);
        
        // Convert checkbox values to boolean
        formData.set('is_active', document.getElementById('productStatus').value === 'true');
        formData.set('is_featured', document.getElementById('productIsFeatured').checked);
        formData.set('is_digital', document.getElementById('productIsDigital').checked);
        formData.set('track_inventory', document.getElementById('productTrackInventory').checked);
        formData.set('has_express_shipping', document.getElementById('productHasExpressShipping').checked);
        
        // Convert numeric values
        const numericFields = ['price', 'compare_price', 'cost_price', 'stock_quantity', 'low_stock_threshold', 
                              'weight', 'custom_shipping_dhaka', 'custom_shipping_outside', 'custom_express_shipping'];
        numericFields.forEach(field => {
            const value = formData.get(field);
            if (value && value.trim() !== '') {
                formData.set(field, parseFloat(value));
            } else if (['price', 'stock_quantity', 'low_stock_threshold'].includes(field)) {
                // Required fields with defaults
                formData.set(field, field === 'price' ? 0 : (field.includes('stock') ? 0 : 5));
            } else {
                formData.delete(field); // Remove empty optional numeric fields
            }
        });

        // Store images separately (they'll be uploaded after product creation)
        const imageFiles = document.getElementById('productImages').files;
        const imageData = [];
        
        // Get alt text and primary info from preview cards
        document.querySelectorAll('.image-preview-card').forEach(card => {
            const fileIndex = parseInt(card.dataset.fileIndex);
            const altTextInput = card.querySelector('input[type="text"]');
            const isPrimary = card.querySelector('.primary-image-btn').classList.contains('btn-warning');
            
            if (imageFiles[fileIndex]) {
                imageData.push({
                    file: imageFiles[fileIndex],
                    alt_text: altTextInput ? altTextInput.value : '',
                    is_primary: isPrimary
                });
            }
        });

        // Remove images from formData for product creation
        formData.delete('images');

        fetch('/mb-admin/api/products/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(JSON.stringify(data));
                });
            }
            return response.json();
        })
        .then(product => {
            // Upload images after product creation
            if (imageData.length > 0) {
                return uploadProductImages(product.id, imageData).then(() => product);
            }
            return product;
        })
        .then(data => {
            // Close modal and refresh product list
            const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
            modal.hide();
            form.reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('imageManagementContainer').style.display = 'none';
            loadProducts();
            showAlert('Product added successfully!', 'success');
        })
        .catch(error => {
            console.error('Error saving product:', error);
            showAlert('Failed to add product. ' + error.message, 'danger');
        });
    }
    
    function uploadProductImages(productId, imageData) {
        const uploadPromises = imageData.map((imageInfo, index) => {
            const formData = new FormData();
            formData.append('product', productId);
            formData.append('image', imageInfo.file);
            formData.append('alt_text', imageInfo.alt_text);
            formData.append('is_primary', imageInfo.is_primary);
            
            return fetch('/mb-admin/api/product-images/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            });
        });
        
        return Promise.all(uploadPromises);
    }
    
    function loadProductDetails(productId) {
        fetch(`/mb-admin/api/products/${productId}/`)
            .then(response => response.json())
            .then(product => {
                // Basic information
                document.getElementById('editProductId').value = product.id;
                document.getElementById('editProductName').value = product.name || '';
                document.getElementById('editProductSlug').value = product.slug || '';
                document.getElementById('editProductDescription').value = product.description || '';
                document.getElementById('editProductShortDescription').value = product.short_description || '';
                
                // Product identification
                document.getElementById('editProductSKU').value = product.sku || '';
                document.getElementById('editProductBarcode').value = product.barcode || '';
                
                // Category
                document.getElementById('editProductCategory').value = product.category;
                
                // Pricing
                document.getElementById('editProductPrice').value = product.price || product.base_price || '';
                document.getElementById('editProductComparePrice').value = product.compare_price || '';
                document.getElementById('editProductCostPrice').value = product.cost_price || '';
                
                // Inventory
                document.getElementById('editProductStockQuantity').value = product.stock_quantity || 0;
                document.getElementById('editProductLowStockThreshold').value = product.low_stock_threshold || 5;
                document.getElementById('editProductTrackInventory').checked = product.track_inventory !== false;
                
                // Physical attributes
                document.getElementById('editProductWeight').value = product.weight || '';
                document.getElementById('editProductDimensions').value = product.dimensions || '';
                
                // Shipping options
                document.getElementById('editProductShippingType').value = product.shipping_type || 'standard';
                document.getElementById('editProductHasExpressShipping').checked = product.has_express_shipping || false;
                document.getElementById('editProductCustomShippingDhaka').value = product.custom_shipping_dhaka || '';
                document.getElementById('editProductCustomShippingOutside').value = product.custom_shipping_outside || '';
                document.getElementById('editProductCustomExpressShipping').value = product.custom_express_shipping || '';
                
                // SEO
                document.getElementById('editProductMetaTitle').value = product.meta_title || '';
                document.getElementById('editProductMetaDescription').value = product.meta_description || '';
                
                // Media
                document.getElementById('editProductYoutubeUrl').value = product.youtube_video_url || '';
                
                // Status
                document.getElementById('editProductStatus').value = product.is_active.toString();
                document.getElementById('editProductIsFeatured').checked = product.is_featured || false;
                document.getElementById('editProductIsDigital').checked = product.is_digital || false;
                
                // Load current images (if any)
                loadCurrentProductImages(product.id);
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading product details:', error);
                showAlert('Failed to load product details.', 'danger');
            });
    }
    
    function updateProduct() {
        const form = document.getElementById('editProductForm');
        const formData = new FormData(form);
        const productId = document.getElementById('editProductId').value;
        
        // Convert checkbox values to boolean
        formData.set('is_active', document.getElementById('editProductStatus').value === 'true');
        formData.set('is_featured', document.getElementById('editProductIsFeatured').checked);
        formData.set('is_digital', document.getElementById('editProductIsDigital').checked);
        formData.set('track_inventory', document.getElementById('editProductTrackInventory').checked);
        formData.set('has_express_shipping', document.getElementById('editProductHasExpressShipping').checked);
        
        // Convert numeric values
        const numericFields = ['price', 'compare_price', 'cost_price', 'stock_quantity', 'low_stock_threshold', 
                              'weight', 'custom_shipping_dhaka', 'custom_shipping_outside', 'custom_express_shipping'];
        numericFields.forEach(field => {
            const value = formData.get(field);
            if (value && value.trim() !== '') {
                formData.set(field, parseFloat(value));
            } else if (['price', 'stock_quantity', 'low_stock_threshold'].includes(field)) {
                // Required fields with defaults
                formData.set(field, field === 'price' ? 0 : (field.includes('stock') ? 0 : 5));
            } else {
                formData.delete(field); // Remove empty optional numeric fields
            }
        });

        // Store new images separately (they'll be uploaded after product update)
        const imageFiles = document.getElementById('editProductImages').files;
        const imageData = [];
        
        // Get alt text and primary info from preview cards
        document.querySelectorAll('#editImagePreview .image-preview-card').forEach(card => {
            const fileIndex = parseInt(card.dataset.fileIndex);
            const altTextInput = card.querySelector('input[type="text"]');
            const isPrimary = card.querySelector('.primary-image-btn').classList.contains('btn-warning');
            
            if (imageFiles[fileIndex]) {
                imageData.push({
                    file: imageFiles[fileIndex],
                    alt_text: altTextInput ? altTextInput.value : '',
                    is_primary: isPrimary
                });
            }
        });

        // Remove images from formData for product update
        formData.delete('images');

        fetch(`/mb-admin/api/products/${productId}/`, {
            method: 'PUT',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(JSON.stringify(data));
                });
            }
            return response.json();
        })
        .then(product => {
            // Upload new images after product update
            if (imageData.length > 0) {
                return uploadProductImages(product.id, imageData).then(() => product);
            }
            return product;
        })
        .then(data => {
            // Close modal and refresh product list
            const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
            modal.hide();
            loadProducts();
            showAlert('Product updated successfully!', 'success');
        })
        .catch(error => {
            console.error('Error updating product:', error);
            showAlert('Failed to update product. ' + error.message, 'danger');
        });
    }
    
    function deleteProduct(productId) {
        fetch(`/mb-admin/api/products/${productId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete product');
            }
            loadProducts();
            showAlert('Product deleted successfully!', 'success');
        })
        .catch(error => {
            console.error('Error deleting product:', error);
            showAlert('Failed to delete product.', 'danger');
        });
    }
    
    // Product Variants management
    function loadProductVariants(productId) {
        document.getElementById('selectProductMessage').style.display = 'none';
        document.getElementById('variantsContainer').style.display = 'block';
        
        // Show loading indicator
        document.getElementById('variantsTableBody').innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Loading variants...</span>
                </td>
            </tr>
        `;
        
        fetch(`/mb-admin/api/variants/?product=${productId}`)
            .then(response => response.json())
            .then(data => {
                displayProductVariants(data.results || data);
            })
            .catch(error => {
                console.error('Error loading variants:', error);
                document.getElementById('variantsTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-3 text-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Failed to load variants.
                        </td>
                    </tr>
                `;
            });
    }
    
    function displayProductVariants(variants) {
        const tbody = document.getElementById('variantsTableBody');
        tbody.innerHTML = '';
        
        if (!variants || variants.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center py-3">
                        No variants found for this product. 
                        <button class="btn btn-sm btn-link add-first-variant-btn">
                            Add your first variant
                        </button>
                    </td>
                </tr>
            `;
            
            document.querySelector('.add-first-variant-btn')?.addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('addVariantModal'));
                modal.show();
            });
            
            return;
        }
        
        variants.forEach(variant => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${variant.id}</td>
                <td>${variant.sku}</td>
                <td>
                    <div class="d-flex align-items-center">
                        ${variant.image ? 
                            `<img src="${variant.image}" alt="${variant.name}" class="me-2" style="width: 30px; height: 30px; object-fit: cover; border-radius: 4px;">` : 
                            `<div class="me-2 bg-light d-flex align-items-center justify-content-center" style="width: 30px; height: 30px; border-radius: 4px;"><i class="fas fa-image text-muted" style="font-size: 12px;"></i></div>`
                        }
                        <span>${variant.name}</span>
                    </div>
                </td>
                <td>
                    ${variant.color ? 
                        `<span class="badge bg-light text-dark" style="border: 1px solid #dee2e6;">${variant.color}</span>` : 
                        `<span class="text-muted">-</span>`
                    }
                </td>
                <td>
                    ${variant.size ? 
                        `<span class="badge bg-light text-dark" style="border: 1px solid #dee2e6;">${variant.size}</span>` : 
                        `<span class="text-muted">-</span>`
                    }
                </td>
                <td>৳${variant.price}</td>
                <td>${variant.stock_quantity}</td>
                <td>
                    <span class="badge ${variant.is_active ? 'bg-success' : 'bg-secondary'}">
                        ${variant.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary edit-variant-btn" data-variant-id="${variant.id}" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger delete-variant-btn" data-variant-id="${variant.id}" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Add event listeners to variant action buttons
        addVariantActionListeners();
    }
    
    function addVariantActionListeners() {
        document.querySelectorAll('.edit-variant-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const variantId = this.dataset.variantId;
                loadVariantDetails(variantId);
            });
        });
        
        document.querySelectorAll('.delete-variant-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const variantId = this.dataset.variantId;
                if (confirm('Are you sure you want to delete this variant? This action cannot be undone.')) {
                    deleteVariant(variantId);
                }
            });
        });
    }
    
    function saveVariant() {
        const form = document.getElementById('addVariantForm');
        const formData = new FormData(form);
        
        // Add the product ID
        formData.set('product', document.getElementById('variantProductId').value);
        
        // Convert string values to proper types for non-file fields
        formData.set('is_active', formData.get('is_active') === 'true');
        formData.set('price', parseFloat(formData.get('price')));
        formData.set('stock_quantity', parseInt(formData.get('stock_quantity')) || 0);
        
        fetch('/mb-admin/api/variants/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(JSON.stringify(data));
                });
            }
            return response.json();
        })
        .then(data => {
            // Close modal and refresh variants list
            const modal = bootstrap.Modal.getInstance(document.getElementById('addVariantModal'));
            modal.hide();
            form.reset();
            document.getElementById('variantImagePreview').style.display = 'none';
            loadProductVariants(selectedProductId);
            showAlert('Variant added successfully!', 'success');
        })
        .catch(error => {
            console.error('Error saving variant:', error);
            showAlert('Failed to add variant. ' + error.message, 'danger');
        });
    }
    
    function loadVariantDetails(variantId) {
        fetch(`/mb-admin/api/variants/${variantId}/`)
            .then(response => response.json())
            .then(variant => {
                document.getElementById('editVariantId').value = variant.id;
                document.getElementById('editVariantProductId').value = variant.product;
                document.getElementById('editVariantSKU').value = variant.sku;
                document.getElementById('editVariantName').value = variant.name;
                document.getElementById('editVariantColor').value = variant.color || '';
                document.getElementById('editVariantSize').value = variant.size || '';
                document.getElementById('editVariantMaterial').value = variant.material || '';
                document.getElementById('editVariantPrice').value = variant.price;
                document.getElementById('editVariantStock').value = variant.stock_quantity;
                document.getElementById('editVariantStatus').value = variant.is_active.toString();
                
                // Handle current variant image
                const currentImageContainer = document.getElementById('editCurrentImageContainer');
                const currentImage = document.getElementById('editCurrentImage');
                
                if (variant.image) {
                    currentImage.src = variant.image;
                    currentImageContainer.style.display = 'block';
                } else {
                    currentImageContainer.style.display = 'none';
                }
                
                // Reset the new image preview
                document.getElementById('editVariantImagePreview').style.display = 'none';
                document.getElementById('editVariantImage').value = '';
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('editVariantModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading variant details:', error);
                showAlert('Failed to load variant details.', 'danger');
            });
    }
    
    function updateVariant() {
        const form = document.getElementById('editVariantForm');
        const formData = new FormData(form);
        const variantId = document.getElementById('editVariantId').value;
        
        // Add the product ID
        formData.set('product', document.getElementById('editVariantProductId').value);
        
        // Convert string values to proper types for non-file fields
        formData.set('is_active', formData.get('is_active') === 'true');
        formData.set('price', parseFloat(formData.get('price')));
        formData.set('stock_quantity', parseInt(formData.get('stock_quantity')) || 0);
        
        fetch(`/mb-admin/api/variants/${variantId}/`, {
            method: 'PUT',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(JSON.stringify(data));
                });
            }
            return response.json();
        })
        .then(data => {
            // Close modal and refresh variants list
            const modal = bootstrap.Modal.getInstance(document.getElementById('editVariantModal'));
            modal.hide();
            loadProductVariants(selectedProductId);
            showAlert('Variant updated successfully!', 'success');
        })
        .catch(error => {
            console.error('Error updating variant:', error);
            showAlert('Failed to update variant. ' + error.message, 'danger');
        });
    }
    
    function deleteVariant(variantId) {
        fetch(`/mb-admin/api/variants/${variantId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete variant');
            }
            loadProductVariants(selectedProductId);
            showAlert('Variant deleted successfully!', 'success');
        })
        .catch(error => {
            console.error('Error deleting variant:', error);
            showAlert('Failed to delete variant.', 'danger');
        });
    }
    
    // Helper functions
    function showAlert(message, type) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Insert at the top of the content area
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                const bsAlert = bootstrap.Alert.getOrCreateInstance(alertDiv);
                bsAlert.close();
            }
        }, 5000);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function generateSlug(text) {
        return text
            .toLowerCase()
            .replace(/[^\w ]+/g, '')
            .replace(/ +/g, '-')
            .trim();
    }
    
    function handleImagePreview(files, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        if (files.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'block';
        
        Array.from(files).forEach((file, index) => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const col = document.createElement('div');
                    col.className = 'col-6 col-md-4 col-lg-3';
                    col.innerHTML = `
                        <div class="card image-preview-card" data-file-index="${index}">
                            <div class="position-relative">
                                <img src="${e.target.result}" class="card-img-top" style="height: 100px; object-fit: cover;">
                                <div class="position-absolute top-0 end-0 p-1">
                                    <button type="button" class="btn btn-sm btn-danger remove-image-btn" data-file-index="${index}">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="position-absolute top-0 start-0 p-1">
                                    <button type="button" class="btn btn-sm ${index === 0 ? 'btn-warning' : 'btn-outline-warning'} primary-image-btn" data-file-index="${index}" title="Set as primary">
                                        <i class="fas fa-star"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-2">
                                <small class="text-muted">${index === 0 ? 'Primary Image' : `Image ${index + 1}`}</small>
                                <div class="mb-2">
                                    <small class="text-muted">${(file.size / 1024).toFixed(1)} KB</small>
                                </div>
                                <div class="mb-2">
                                    <input type="text" class="form-control form-control-sm" placeholder="Alt text" data-file-index="${index}" maxlength="200">
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Show image management container for add modal
        if (containerId === 'imagePreview') {
            document.getElementById('imageManagementContainer').style.display = 'block';
        }
        
        // Add event listeners after a short delay to ensure DOM is ready
        setTimeout(() => {
            addImagePreviewListeners();
        }, 100);
    }
    
    function loadCurrentProductImages(productId) {
        const container = document.getElementById('editCurrentImages');
        const containerDiv = document.getElementById('editCurrentImagesContainer');
        
        fetch(`/mb-admin/api/product-images/?product=${productId}`)
            .then(response => response.json())
            .then(data => {
                const images = data.results || data;
                container.innerHTML = '';
                
                if (images.length === 0) {
                    containerDiv.style.display = 'none';
                    return;
                }
                
                containerDiv.style.display = 'block';
                
                images.forEach((image, index) => {
                    const col = document.createElement('div');
                    col.className = 'col-6';
                    col.innerHTML = `
                        <div class="card current-image-card" data-image-id="${image.id}">
                            <div class="position-relative">
                                <img src="${image.image}" class="card-img-top" style="height: 100px; object-fit: cover;">
                                <div class="position-absolute top-0 end-0 p-1">
                                    <button type="button" class="btn btn-sm btn-danger delete-current-image-btn" data-image-id="${image.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div class="position-absolute top-0 start-0 p-1">
                                    <button type="button" class="btn btn-sm ${image.is_primary ? 'btn-warning' : 'btn-outline-warning'} toggle-primary-btn" 
                                            data-image-id="${image.id}" 
                                            title="${image.is_primary ? 'Click to remove as primary' : 'Click to set as primary'}">
                                        <i class="fas ${image.is_primary ? 'fa-star' : 'fa-star'}"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-2">
                                <small class="text-muted">
                                    <i class="fas fa-star text-warning me-1" style="${image.is_primary ? '' : 'display:none;'}"></i>
                                    ${image.is_primary ? 'Primary Image' : 'Additional Image'}
                                </small>
                                <div class="mb-2">
                                    <input type="text" class="form-control form-control-sm alt-text-input" 
                                           value="${image.alt_text || ''}" 
                                           placeholder="Alt text" 
                                           data-image-id="${image.id}" 
                                           maxlength="200">
                                </div>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-sm btn-outline-primary update-alt-text-btn" data-image-id="${image.id}">
                                        <i class="fas fa-save me-1"></i>Update Alt Text
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                });
                
                // Add event listeners
                addCurrentImageListeners();
            })
            .catch(error => {
                console.error('Error loading product images:', error);
                containerDiv.style.display = 'none';
            });
    }
    
    function addImagePreviewListeners() {
        // Remove image from preview
        document.querySelectorAll('.remove-image-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const fileIndex = parseInt(this.dataset.fileIndex);
                removeImageFromPreview(fileIndex);
            });
        });
        
        // Set primary image
        document.querySelectorAll('.primary-image-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const fileIndex = parseInt(this.dataset.fileIndex);
                setPrimaryImageInPreview(fileIndex);
            });
        });
    }
    
    function addCurrentImageListeners() {
        // Delete current image
        document.querySelectorAll('.delete-current-image-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const imageId = this.dataset.imageId;
                if (confirm('Are you sure you want to delete this image?')) {
                    deleteProductImage(imageId);
                }
            });
        });
        
        // Toggle primary image
        document.querySelectorAll('.toggle-primary-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const imageId = this.dataset.imageId;
                togglePrimaryImage(imageId);
            });
        });
        
        // Update alt text
        document.querySelectorAll('.update-alt-text-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const imageId = this.dataset.imageId;
                const altTextInput = document.querySelector(`.alt-text-input[data-image-id="${imageId}"]`);
                updateImageAltText(imageId, altTextInput.value);
            });
        });
    }
    
    function removeImageFromPreview(fileIndex) {
        // Remove the preview card
        const card = document.querySelector(`.image-preview-card[data-file-index="${fileIndex}"]`);
        if (card) {
            card.parentElement.remove();
        }
        
        // Update the file input (this is complex as we can't directly modify FileList)
        // For now, we'll handle this in the form submission by checking which previews exist
    }
    
    function setPrimaryImageInPreview(fileIndex) {
        // Update all primary buttons
        document.querySelectorAll('.primary-image-btn').forEach(btn => {
            const btnIndex = parseInt(btn.dataset.fileIndex);
            if (btnIndex === fileIndex) {
                btn.className = 'btn btn-sm btn-warning primary-image-btn';
            } else {
                btn.className = 'btn btn-sm btn-outline-warning primary-image-btn';
            }
        });
        
        // Update labels
        document.querySelectorAll('.image-preview-card').forEach(card => {
            const cardIndex = parseInt(card.dataset.fileIndex);
            const label = card.querySelector('small');
            if (cardIndex === fileIndex) {
                label.textContent = 'Primary Image';
            } else {
                label.textContent = `Image ${cardIndex + 1}`;
            }
        });
    }
    
    function deleteProductImage(imageId) {
        fetch(`/mb-admin/api/product-images/${imageId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (response.ok) {
                showAlert('Image deleted successfully!', 'success');
                // Reload current images
                const editProductId = document.getElementById('editProductId');
                if (editProductId && editProductId.value) {
                    loadCurrentProductImages(editProductId.value);
                }
            } else {
                showAlert('Failed to delete image.', 'danger');
            }
        })
        .catch(error => {
            console.error('Error deleting image:', error);
            showAlert('Error deleting image.', 'danger');
        });
    }
    
    function togglePrimaryImage(imageId) {
        // Get the current state of the image
        const currentImageCard = document.querySelector(`.current-image-card[data-image-id="${imageId}"]`);
        const toggleBtn = currentImageCard?.querySelector('.toggle-primary-btn');
        const isPrimary = toggleBtn?.classList.contains('btn-warning');
        
        // Toggle the primary state
        const newPrimaryState = !isPrimary;
        
        fetch(`/mb-admin/api/product-images/${imageId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ is_primary: newPrimaryState })
        })
        .then(response => response.json())
        .then(data => {
            if (newPrimaryState) {
                showAlert('Image set as primary!', 'success');
            } else {
                showAlert('Primary status removed!', 'success');
            }
            // Reload current images to reflect the changes
            const editProductId = document.getElementById('editProductId');
            if (editProductId && editProductId.value) {
                loadCurrentProductImages(editProductId.value);
            }
        })
        .catch(error => {
            console.error('Error updating primary image:', error);
            showAlert('Error updating primary image.', 'danger');
        });
    }
    
    function updateImageAltText(imageId, altText) {
        fetch(`/mb-admin/api/product-images/${imageId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ alt_text: altText })
        })
        .then(response => response.json())
        .then(data => {
            showAlert('Alt text updated!', 'success');
        })
        .catch(error => {
            console.error('Error updating alt text:', error);
            showAlert('Error updating alt text.', 'danger');
        });
    }
    
    function handleVariantImagePreview(input, containerId, imgId) {
        const container = document.getElementById(containerId);
        const img = document.getElementById(imgId);
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                img.src = e.target.result;
                container.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        } else {
            container.style.display = 'none';
        }
    }
    
    function generateSlug(text) {
        return text
            .toLowerCase()
            .trim()
            .replace(/[^\w\s-]/g, '') // Remove special characters
            .replace(/[\s_-]+/g, '-') // Replace spaces, underscores, hyphens with single hyphen
            .replace(/^-+|-+$/g, ''); // Remove leading/trailing hyphens
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    function showAlert(message, type = 'info') {
        const alertContainer = document.createElement('div');
        alertContainer.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertContainer.style.top = '20px';
        alertContainer.style.right = '20px';
        alertContainer.style.zIndex = '9999';
        alertContainer.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertContainer);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alertContainer.parentNode) {
                alertContainer.parentNode.removeChild(alertContainer);
            }
        }, 5000);
    }
});
</script>
{% endblock %}