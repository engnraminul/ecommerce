{% extends 'dashboard/base.html' %}

{% block title %}Products - MB Admin{% endblock %}

{% block page_title %}Products Management{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">All Products</h5>
        <div>
            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="fas fa-plus-circle me-1"></i> Add Product
            </button>
            <button class="btn btn-sm btn-secondary" id="refreshProductsBtn">
                <i class="fas fa-sync-alt me-1"></i> Refresh
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <div class="row g-2">
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" id="productSearchInput" placeholder="Search products...">
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" id="categoryFilter">
                        <option value="">All Categories</option>
                        <!-- Categories will be loaded dynamically -->
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary btn-sm w-100" id="applyFiltersBtn">
                        <i class="fas fa-filter me-1"></i> Apply Filters
                    </button>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Base Price</th>
                        <th>Variants</th>
                        <th>Status</th>
                        <th>Last Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody">
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading products...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <span id="productsTotalCount">0</span> products
            </div>
            <div>
                <nav aria-label="Products pagination">
                    <ul class="pagination pagination-sm" id="productsPagination">
                        <!-- Pagination will be generated dynamically -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Product Variants Section -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Product Variants</h5>
        <button class="btn btn-sm btn-success" id="addVariantBtn" disabled data-bs-toggle="modal" data-bs-target="#addVariantModal">
            <i class="fas fa-plus-circle me-1"></i> Add Variant
        </button>
    </div>
    <div class="card-body">
        <div id="selectProductMessage" class="text-center py-4">
            <i class="fas fa-hand-pointer fa-2x mb-3 text-secondary"></i>
            <p>Select a product from the table above to manage its variants.</p>
        </div>
        
        <div id="variantsContainer" style="display: none;">
            <h6 id="selectedProductName" class="mb-3 border-bottom pb-2"></h6>
            
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>SKU</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="variantsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProductModalLabel">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="productName" class="form-label">Product Name</label>
                            <input type="text" class="form-control" id="productName" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="productCategory" class="form-label">Category</label>
                            <select class="form-select" id="productCategory" name="category" required>
                                <!-- Categories will be loaded dynamically -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="productDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="productDescription" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="productBasePrice" class="form-label">Base Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="productBasePrice" name="base_price" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="productStatus" class="form-label">Status</label>
                            <select class="form-select" id="productStatus" name="is_active">
                                <option value="true" selected>Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveProductBtn">Save Product</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProductModalLabel">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm">
                    <input type="hidden" id="editProductId">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editProductName" class="form-label">Product Name</label>
                            <input type="text" class="form-control" id="editProductName" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="editProductCategory" class="form-label">Category</label>
                            <select class="form-select" id="editProductCategory" name="category" required>
                                <!-- Categories will be loaded dynamically -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editProductDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editProductDescription" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editProductBasePrice" class="form-label">Base Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="editProductBasePrice" name="base_price" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="editProductStatus" class="form-label">Status</label>
                            <select class="form-select" id="editProductStatus" name="is_active">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateProductBtn">Update Product</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Variant Modal -->
<div class="modal fade" id="addVariantModal" tabindex="-1" aria-labelledby="addVariantModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addVariantModalLabel">Add Variant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addVariantForm">
                    <input type="hidden" id="variantProductId">
                    
                    <div class="mb-3">
                        <label for="variantSKU" class="form-label">SKU</label>
                        <input type="text" class="form-control" id="variantSKU" name="sku" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="variantName" class="form-label">Variant Name</label>
                        <input type="text" class="form-control" id="variantName" name="name" required>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="variantPrice" class="form-label">Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="variantPrice" name="price" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="variantStock" class="form-label">Stock Quantity</label>
                            <input type="number" class="form-control" id="variantStock" name="stock_quantity" min="0" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="variantStatus" class="form-label">Status</label>
                        <select class="form-select" id="variantStatus" name="is_active">
                            <option value="true" selected>Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveVariantBtn">Save Variant</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Variant Modal -->
<div class="modal fade" id="editVariantModal" tabindex="-1" aria-labelledby="editVariantModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editVariantModalLabel">Edit Variant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editVariantForm">
                    <input type="hidden" id="editVariantId">
                    <input type="hidden" id="editVariantProductId">
                    
                    <div class="mb-3">
                        <label for="editVariantSKU" class="form-label">SKU</label>
                        <input type="text" class="form-control" id="editVariantSKU" name="sku" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editVariantName" class="form-label">Variant Name</label>
                        <input type="text" class="form-control" id="editVariantName" name="name" required>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editVariantPrice" class="form-label">Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="editVariantPrice" name="price" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="editVariantStock" class="form-label">Stock Quantity</label>
                            <input type="number" class="form-control" id="editVariantStock" name="stock_quantity" min="0" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editVariantStatus" class="form-label">Status</label>
                        <select class="form-select" id="editVariantStatus" name="is_active">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateVariantBtn">Update Variant</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let selectedProductId = null;
    
    // Initial data loading
    loadCategories();
    loadProducts();
    
    // Event listeners
    document.getElementById('refreshProductsBtn').addEventListener('click', loadProducts);
    document.getElementById('applyFiltersBtn').addEventListener('click', loadProducts);
    document.getElementById('saveProductBtn').addEventListener('click', saveProduct);
    document.getElementById('updateProductBtn').addEventListener('click', updateProduct);
    document.getElementById('saveVariantBtn').addEventListener('click', saveVariant);
    document.getElementById('updateVariantBtn').addEventListener('click', updateVariant);
    
    // Load categories for dropdowns
    function loadCategories() {
        fetch('/mb-admin/api/categories/')
            .then(response => response.json())
            .then(data => {
                const categories = data.results || data;
                populateCategoryDropdown('productCategory', categories);
                populateCategoryDropdown('editProductCategory', categories);
                populateCategoryDropdown('categoryFilter', categories);
            })
            .catch(error => console.error('Error loading categories:', error));
    }
    
    function populateCategoryDropdown(elementId, categories) {
        const dropdown = document.getElementById(elementId);
        const currentValue = dropdown.value;
        
        // Clear existing options except the first one if it's a filter
        if (elementId === 'categoryFilter') {
            dropdown.innerHTML = '<option value="">All Categories</option>';
        } else {
            dropdown.innerHTML = '';
        }
        
        // Add categories to dropdown
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            dropdown.appendChild(option);
        });
        
        // Restore selected value if there was one
        if (currentValue) {
            dropdown.value = currentValue;
        }
    }
    
    // Load products with pagination and filtering
    function loadProducts(page = 1) {
        currentPage = page;
        const searchTerm = document.getElementById('productSearchInput').value.trim();
        const categoryFilter = document.getElementById('categoryFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        
        let url = `/mb-admin/api/products/?page=${page}`;
        
        if (searchTerm) {
            url += `&search=${encodeURIComponent(searchTerm)}`;
        }
        
        if (categoryFilter) {
            url += `&category=${categoryFilter}`;
        }
        
        if (statusFilter !== '') {
            url += `&is_active=${statusFilter}`;
        }
        
        // Show loading indicator
        document.getElementById('productsTableBody').innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading products...</p>
                </td>
            </tr>
        `;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                displayProducts(data.results);
                updatePagination(data);
                document.getElementById('productsTotalCount').textContent = data.count || 0;
            })
            .catch(error => {
                console.error('Error loading products:', error);
                document.getElementById('productsTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <p>Error loading products. Please try again.</p>
                        </td>
                    </tr>
                `;
            });
    }
    
    function displayProducts(products) {
        const tbody = document.getElementById('productsTableBody');
        tbody.innerHTML = '';
        
        if (!products || products.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">No products found.</td>
                </tr>
            `;
            return;
        }
        
        products.forEach(product => {
            const tr = document.createElement('tr');
            tr.dataset.productId = product.id;
            tr.innerHTML = `
                <td>${product.id}</td>
                <td>${product.name}</td>
                <td>${product.category_name}</td>
                <td>$${product.base_price}</td>
                <td>${product.variant_count || 0}</td>
                <td>
                    <span class="badge ${product.is_active ? 'bg-success' : 'bg-secondary'}">
                        ${product.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>${new Date(product.updated_at).toLocaleDateString()}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary edit-product-btn" data-product-id="${product.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger delete-product-btn" data-product-id="${product.id}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <button type="button" class="btn btn-outline-info view-variants-btn" data-product-id="${product.id}" data-product-name="${product.name}">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Add event listeners to the action buttons
        addProductActionListeners();
    }
    
    function addProductActionListeners() {
        document.querySelectorAll('.edit-product-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.dataset.productId;
                loadProductDetails(productId);
            });
        });
        
        document.querySelectorAll('.delete-product-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.dataset.productId;
                if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                    deleteProduct(productId);
                }
            });
        });
        
        document.querySelectorAll('.view-variants-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                selectedProductId = this.dataset.productId;
                const productName = this.dataset.productName;
                document.getElementById('selectedProductName').textContent = productName;
                document.getElementById('variantProductId').value = selectedProductId;
                document.getElementById('addVariantBtn').disabled = false;
                loadProductVariants(selectedProductId);
            });
        });
    }
    
    function updatePagination(data) {
        const pagination = document.getElementById('productsPagination');
        pagination.innerHTML = '';
        
        const totalPages = Math.ceil(data.count / data.results.length);
        if (totalPages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
        pagination.appendChild(prevLi);
        
        // Page numbers
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            pagination.appendChild(li);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
        pagination.appendChild(nextLi);
        
        // Add event listeners to pagination links
        document.querySelectorAll('#productsPagination .page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.dataset.page);
                loadProducts(page);
            });
        });
    }
    
    // Product CRUD operations
    function saveProduct() {
        const form = document.getElementById('addProductForm');
        const formData = new FormData(form);
        const productData = Object.fromEntries(formData.entries());
        
        // Convert string values to proper types
        productData.is_active = productData.is_active === 'true';
        productData.base_price = parseFloat(productData.base_price);
        
        fetch('/mb-admin/api/products/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(productData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(JSON.stringify(data));
                });
            }
            return response.json();
        })
        .then(data => {
            // Close modal and refresh product list
            const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
            modal.hide();
            form.reset();
            loadProducts();
            showAlert('Product added successfully!', 'success');
        })
        .catch(error => {
            console.error('Error saving product:', error);
            showAlert('Failed to add product. ' + error.message, 'danger');
        });
    }
    
    function loadProductDetails(productId) {
        fetch(`/mb-admin/api/products/${productId}/`)
            .then(response => response.json())
            .then(product => {
                document.getElementById('editProductId').value = product.id;
                document.getElementById('editProductName').value = product.name;
                document.getElementById('editProductCategory').value = product.category;
                document.getElementById('editProductDescription').value = product.description;
                document.getElementById('editProductBasePrice').value = product.base_price;
                document.getElementById('editProductStatus').value = product.is_active.toString();
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading product details:', error);
                showAlert('Failed to load product details.', 'danger');
            });
    }
    
    function updateProduct() {
        const form = document.getElementById('editProductForm');
        const formData = new FormData(form);
        const productData = Object.fromEntries(formData.entries());
        const productId = document.getElementById('editProductId').value;
        
        // Convert string values to proper types
        productData.is_active = productData.is_active === 'true';
        productData.base_price = parseFloat(productData.base_price);
        
        fetch(`/mb-admin/api/products/${productId}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(productData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(JSON.stringify(data));
                });
            }
            return response.json();
        })
        .then(data => {
            // Close modal and refresh product list
            const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
            modal.hide();
            loadProducts();
            showAlert('Product updated successfully!', 'success');
        })
        .catch(error => {
            console.error('Error updating product:', error);
            showAlert('Failed to update product. ' + error.message, 'danger');
        });
    }
    
    function deleteProduct(productId) {
        fetch(`/mb-admin/api/products/${productId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete product');
            }
            loadProducts();
            showAlert('Product deleted successfully!', 'success');
        })
        .catch(error => {
            console.error('Error deleting product:', error);
            showAlert('Failed to delete product.', 'danger');
        });
    }
    
    // Product Variants management
    function loadProductVariants(productId) {
        document.getElementById('selectProductMessage').style.display = 'none';
        document.getElementById('variantsContainer').style.display = 'block';
        
        // Show loading indicator
        document.getElementById('variantsTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Loading variants...</span>
                </td>
            </tr>
        `;
        
        fetch(`/mb-admin/api/variants/?product=${productId}`)
            .then(response => response.json())
            .then(data => {
                displayProductVariants(data.results || data);
            })
            .catch(error => {
                console.error('Error loading variants:', error);
                document.getElementById('variantsTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-3 text-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Failed to load variants.
                        </td>
                    </tr>
                `;
            });
    }
    
    function displayProductVariants(variants) {
        const tbody = document.getElementById('variantsTableBody');
        tbody.innerHTML = '';
        
        if (!variants || variants.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-3">
                        No variants found for this product. 
                        <button class="btn btn-sm btn-link add-first-variant-btn">
                            Add your first variant
                        </button>
                    </td>
                </tr>
            `;
            
            document.querySelector('.add-first-variant-btn')?.addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('addVariantModal'));
                modal.show();
            });
            
            return;
        }
        
        variants.forEach(variant => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${variant.id}</td>
                <td>${variant.sku}</td>
                <td>${variant.name}</td>
                <td>$${variant.price}</td>
                <td>${variant.stock_quantity}</td>
                <td>
                    <span class="badge ${variant.is_active ? 'bg-success' : 'bg-secondary'}">
                        ${variant.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary edit-variant-btn" data-variant-id="${variant.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger delete-variant-btn" data-variant-id="${variant.id}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Add event listeners to variant action buttons
        addVariantActionListeners();
    }
    
    function addVariantActionListeners() {
        document.querySelectorAll('.edit-variant-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const variantId = this.dataset.variantId;
                loadVariantDetails(variantId);
            });
        });
        
        document.querySelectorAll('.delete-variant-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const variantId = this.dataset.variantId;
                if (confirm('Are you sure you want to delete this variant? This action cannot be undone.')) {
                    deleteVariant(variantId);
                }
            });
        });
    }
    
    function saveVariant() {
        const form = document.getElementById('addVariantForm');
        const formData = new FormData(form);
        const variantData = Object.fromEntries(formData.entries());
        
        // Add the product ID
        variantData.product = document.getElementById('variantProductId').value;
        
        // Convert string values to proper types
        variantData.is_active = variantData.is_active === 'true';
        variantData.price = parseFloat(variantData.price);
        variantData.stock_quantity = parseInt(variantData.stock_quantity);
        
        fetch('/mb-admin/api/variants/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(variantData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(JSON.stringify(data));
                });
            }
            return response.json();
        })
        .then(data => {
            // Close modal and refresh variants list
            const modal = bootstrap.Modal.getInstance(document.getElementById('addVariantModal'));
            modal.hide();
            form.reset();
            loadProductVariants(selectedProductId);
            showAlert('Variant added successfully!', 'success');
        })
        .catch(error => {
            console.error('Error saving variant:', error);
            showAlert('Failed to add variant. ' + error.message, 'danger');
        });
    }
    
    function loadVariantDetails(variantId) {
        fetch(`/mb-admin/api/variants/${variantId}/`)
            .then(response => response.json())
            .then(variant => {
                document.getElementById('editVariantId').value = variant.id;
                document.getElementById('editVariantProductId').value = variant.product;
                document.getElementById('editVariantSKU').value = variant.sku;
                document.getElementById('editVariantName').value = variant.name;
                document.getElementById('editVariantPrice').value = variant.price;
                document.getElementById('editVariantStock').value = variant.stock_quantity;
                document.getElementById('editVariantStatus').value = variant.is_active.toString();
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('editVariantModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading variant details:', error);
                showAlert('Failed to load variant details.', 'danger');
            });
    }
    
    function updateVariant() {
        const form = document.getElementById('editVariantForm');
        const formData = new FormData(form);
        const variantData = Object.fromEntries(formData.entries());
        const variantId = document.getElementById('editVariantId').value;
        
        // Add the product ID
        variantData.product = document.getElementById('editVariantProductId').value;
        
        // Convert string values to proper types
        variantData.is_active = variantData.is_active === 'true';
        variantData.price = parseFloat(variantData.price);
        variantData.stock_quantity = parseInt(variantData.stock_quantity);
        
        fetch(`/mb-admin/api/variants/${variantId}/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(variantData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(JSON.stringify(data));
                });
            }
            return response.json();
        })
        .then(data => {
            // Close modal and refresh variants list
            const modal = bootstrap.Modal.getInstance(document.getElementById('editVariantModal'));
            modal.hide();
            loadProductVariants(selectedProductId);
            showAlert('Variant updated successfully!', 'success');
        })
        .catch(error => {
            console.error('Error updating variant:', error);
            showAlert('Failed to update variant. ' + error.message, 'danger');
        });
    }
    
    function deleteVariant(variantId) {
        fetch(`/mb-admin/api/variants/${variantId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete variant');
            }
            loadProductVariants(selectedProductId);
            showAlert('Variant deleted successfully!', 'success');
        })
        .catch(error => {
            console.error('Error deleting variant:', error);
            showAlert('Failed to delete variant.', 'danger');
        });
    }
    
    // Helper functions
    function showAlert(message, type) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Insert at the top of the content area
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                const bsAlert = bootstrap.Alert.getOrCreateInstance(alertDiv);
                bsAlert.close();
            }
        }, 5000);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}