{% extends 'dashboard/base.html' %}

{% block title %}Products - MB Admin{% endblock %}

{% block page_title %}Products Management{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">All Products</h5>
        <div>
            <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="fas fa-plus-circle me-1"></i> Add Product
            </button>
            <button class="btn btn-sm btn-secondary" id="refreshProductsBtn">
                <i class="fas fa-sync-alt me-1"></i> Refresh
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <div class="row g-2">
                <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" id="productSearchInput" placeholder="Search products...">
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" id="categoryFilter">
                        <option value="">All Categories</option>
                        <!-- Categories will be loaded dynamically -->
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary btn-sm w-100" id="applyFiltersBtn">
                        <i class="fas fa-filter me-1"></i> Apply Filters
                    </button>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Base Price</th>
                        <th>Variants</th>
                        <th>Status</th>
                        <th>Last Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody">
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading products...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <span id="productsTotalCount">0</span> products
            </div>
            <div>
                <nav aria-label="Products pagination">
                    <ul class="pagination pagination-sm" id="productsPagination">
                        <!-- Pagination will be generated dynamically -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Product Variants Modal -->
<div class="modal fade" id="productVariantsModal" tabindex="-1" aria-labelledby="productVariantsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productVariantsModalLabel">
                    <i class="fas fa-list me-2"></i>Product Variants
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 id="selectedProductName" class="mb-0"></h6>
                    <button class="btn btn-sm btn-success" id="addVariantBtn" disabled data-bs-toggle="modal" data-bs-target="#addVariantModal">
                        <i class="fas fa-plus-circle me-1"></i> Add Variant
                    </button>
                </div>
                
                <div id="selectProductMessage" class="text-center py-4">
                    <i class="fas fa-hand-pointer fa-2x mb-3 text-secondary"></i>
                    <p>Select a product from the table to manage its variants.</p>
                </div>
                
                <div id="variantsContainer" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>SKU</th>
                                    <th>Name & Image</th>
                                    <th>Color</th>
                                    <th>Size</th>
                                    <th>Selling Price</th>
                                    <th>Compare Price</th>
                                    <th>Cost Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="variantsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProductModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Add New Product
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm" enctype="multipart/form-data">
                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-8">
                            <!-- Basic Information -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-8">
                                            <label for="productName" class="form-label">Product Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="productName" name="name" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="productSlug" class="form-label">Slug</label>
                                            <input type="text" class="form-control" id="productSlug" name="slug" placeholder="Auto-generated">
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="productDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="productDescription" name="description" rows="4" placeholder="Detailed product description..."></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="productShortDescription" class="form-label">Short Description</label>
                                        <textarea class="form-control" id="productShortDescription" name="short_description" rows="2" placeholder="Brief description for product listings..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Product Identification -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-barcode me-2"></i>Product Identification</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="productSKU" class="form-label">SKU (Stock Keeping Unit)</label>
                                            <input type="text" class="form-control" id="productSKU" name="sku" placeholder="e.g., MB-001">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="productBarcode" class="form-label">Barcode</label>
                                            <input type="text" class="form-control" id="productBarcode" name="barcode" placeholder="Product barcode">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pricing -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Pricing</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="productPrice" class="form-label">Price <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="productPrice" name="price" step="0.01" min="0" required>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="productComparePrice" class="form-label">Compare Price</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="productComparePrice" name="compare_price" step="0.01" min="0" placeholder="Original price">
                                            </div>
                                            <small class="text-muted">Show discount compared to this price</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="productCostPrice" class="form-label">Cost Price</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="productCostPrice" name="cost_price" step="0.01" min="0" placeholder="Cost to you">
                                            </div>
                                            <small class="text-muted">For profit calculations</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Inventory -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-boxes me-2"></i>Inventory</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="productStockQuantity" class="form-label">Stock Quantity</label>
                                            <input type="number" class="form-control" id="productStockQuantity" name="stock_quantity" min="0" value="0" readonly>
                                            <small class="text-muted">Managed through Stock Management</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="productLowStockThreshold" class="form-label">Low Stock Threshold</label>
                                            <input type="number" class="form-control" id="productLowStockThreshold" name="low_stock_threshold" min="0" value="5">
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox" id="productTrackInventory" name="track_inventory" checked>
                                                <label class="form-check-label" for="productTrackInventory">
                                                    Track Inventory
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Physical Attributes -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-weight me-2"></i>Physical Attributes</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="productWeight" class="form-label">Weight (kg)</label>
                                            <input type="number" class="form-control" id="productWeight" name="weight" step="0.01" min="0" placeholder="0.00">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="productDimensions" class="form-label">Dimensions</label>
                                            <input type="text" class="form-control" id="productDimensions" name="dimensions" placeholder="L x W x H (cm)">
                                            <small class="text-muted">Example: 20 x 15 x 5</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Shipping Options -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-shipping-fast me-2"></i>Shipping Options</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="productShippingType" class="form-label">Shipping Type</label>
                                        <select class="form-select" id="productShippingType" name="shipping_type">
                                            <option value="standard">Shipping with Charge (Dhaka: 70 Tk, Outside: 120 Tk)</option>
                                            <option value="free">Free Shipping</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="productHasExpressShipping" name="has_express_shipping">
                                        <label class="form-check-label" for="productHasExpressShipping">
                                            Enable Express Shipping (Same Day Delivery in Dhaka)
                                        </label>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="productCustomShippingDhaka" class="form-label">Custom Dhaka Shipping</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="productCustomShippingDhaka" name="custom_shipping_dhaka" step="0.01" min="0" placeholder="70">
                                            </div>
                                            <small class="text-muted">Leave blank for default (70 Tk)</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="productCustomShippingOutside" class="form-label">Custom Outside Dhaka</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="productCustomShippingOutside" name="custom_shipping_outside" step="0.01" min="0" placeholder="120">
                                            </div>
                                            <small class="text-muted">Leave blank for default (120 Tk)</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="productCustomExpressShipping" class="form-label">Custom Express Shipping</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="productCustomExpressShipping" name="custom_express_shipping" step="0.01" min="0" placeholder="150">
                                            </div>
                                            <small class="text-muted">Leave blank for default (150 Tk)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- SEO -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-search me-2"></i>SEO Settings</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="productMetaTitle" class="form-label">Meta Title</label>
                                        <input type="text" class="form-control" id="productMetaTitle" name="meta_title" maxlength="200" placeholder="SEO title for search engines">
                                        <small class="text-muted">Recommended: 50-60 characters</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="productMetaDescription" class="form-label">Meta Description</label>
                                        <textarea class="form-control" id="productMetaDescription" name="meta_description" rows="3" maxlength="300" placeholder="SEO description for search engines"></textarea>
                                        <small class="text-muted">Recommended: 150-160 characters</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Media -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-video me-2"></i>Media</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="productYoutubeUrl" class="form-label">YouTube Video URL</label>
                                        <input type="url" class="form-control" id="productYoutubeUrl" name="youtube_video_url" placeholder="https://www.youtube.com/watch?v=VIDEO_ID">
                                        <small class="text-muted">Add a YouTube video to showcase your product</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="col-md-4">
                            <!-- Product Status -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-toggle-on me-2"></i>Status</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="productStatus" class="form-label">Status</label>
                                        <select class="form-select" id="productStatus" name="is_active">
                                            <option value="true" selected>Active</option>
                                            <option value="false">Inactive</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="productIsFeatured" name="is_featured">
                                        <label class="form-check-label" for="productIsFeatured">
                                            Featured Product
                                        </label>
                                        <small class="form-text text-muted d-block">Show in featured product sections</small>
                                    </div>
                                    
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="productIsDigital" name="is_digital">
                                        <label class="form-check-label" for="productIsDigital">
                                            Digital Product
                                        </label>
                                        <small class="form-text text-muted d-block">No physical shipping required</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Category -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-tags me-2"></i>Category</h6>
                                </div>
                                <div class="card-body">
                                    <label for="productCategory" class="form-label">Category <span class="text-danger">*</span></label>
                                    <select class="form-select" id="productCategory" name="category" required>
                                        <option value="">Select Category</option>
                                        <!-- Categories will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>

                            <!-- Product Images -->
                            <div class="card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="fas fa-images me-2"></i>Product Images</h6>
                                    <small class="text-muted">Drag to reorder • First image is primary</small>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="productImages" class="form-label">Upload Images</label>
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-outline-primary" id="openMediaLibraryBtn">
                                                <i class="fas fa-images me-2"></i>Choose from Media Library
                                            </button>
                                            <small class="text-muted">Select images from media library or upload new ones</small>
                                        </div>
                                        <input type="file" class="form-control d-none" id="productImages" name="images" multiple accept="image/*">
                                    </div>
                                    
                                    <div id="imagePreview" class="row g-2" style="display: none;">
                                        <!-- Image previews will be shown here -->
                                    </div>
                                    
                                    <!-- Image Management Container -->
                                    <div id="imageManagementContainer" style="display: none;">
                                        <hr>
                                        <h6 class="mb-3">Image Management</h6>
                                        <div id="imageManagementList" class="row g-3">
                                            <!-- Dynamic image management cards will be inserted here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-success" id="saveProductBtn">
                                    <i class="fas fa-save me-1"></i> Save Product
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProductModalLabel">
                    <i class="fas fa-edit me-2"></i>Edit Product
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm" enctype="multipart/form-data">
                    <input type="hidden" id="editProductId" name="id">
                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-8">
                            <!-- Basic Information -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-8">
                                            <label for="editProductName" class="form-label">Product Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="editProductName" name="name" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="editProductSlug" class="form-label">Slug</label>
                                            <input type="text" class="form-control" id="editProductSlug" name="slug" placeholder="Auto-generated">
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="editProductDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="editProductDescription" name="description" rows="4" placeholder="Detailed product description..."></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="editProductShortDescription" class="form-label">Short Description</label>
                                        <textarea class="form-control" id="editProductShortDescription" name="short_description" rows="2" placeholder="Brief description for product listings..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Product Identification -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-barcode me-2"></i>Product Identification</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="editProductSKU" class="form-label">SKU (Stock Keeping Unit)</label>
                                            <input type="text" class="form-control" id="editProductSKU" name="sku" placeholder="e.g., MB-001">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="editProductBarcode" class="form-label">Barcode</label>
                                            <input type="text" class="form-control" id="editProductBarcode" name="barcode" placeholder="Product barcode">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pricing -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Pricing</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="editProductPrice" class="form-label">Price <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="editProductPrice" name="price" step="0.01" min="0" required>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="editProductComparePrice" class="form-label">Compare Price</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="editProductComparePrice" name="compare_price" step="0.01" min="0" placeholder="Original price">
                                            </div>
                                            <small class="text-muted">Show discount compared to this price</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="editProductCostPrice" class="form-label">Cost Price</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="editProductCostPrice" name="cost_price" step="0.01" min="0" placeholder="Cost to you">
                                            </div>
                                            <small class="text-muted">For profit calculations</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Inventory -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-boxes me-2"></i>Inventory</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="editProductStockQuantity" class="form-label">Stock Quantity</label>
                                            <input type="number" class="form-control" id="editProductStockQuantity" name="stock_quantity" min="0" value="0" readonly>
                                            <small class="text-muted">Managed through Stock Management</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="editProductLowStockThreshold" class="form-label">Low Stock Threshold</label>
                                            <input type="number" class="form-control" id="editProductLowStockThreshold" name="low_stock_threshold" min="0" value="5">
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox" id="editProductTrackInventory" name="track_inventory" checked>
                                                <label class="form-check-label" for="editProductTrackInventory">
                                                    Track Inventory
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Physical Attributes -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-weight me-2"></i>Physical Attributes</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="editProductWeight" class="form-label">Weight (kg)</label>
                                            <input type="number" class="form-control" id="editProductWeight" name="weight" step="0.01" min="0" placeholder="0.00">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="editProductDimensions" class="form-label">Dimensions</label>
                                            <input type="text" class="form-control" id="editProductDimensions" name="dimensions" placeholder="L x W x H (cm)">
                                            <small class="text-muted">Example: 20 x 15 x 5</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Shipping Options -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-shipping-fast me-2"></i>Shipping Options</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="editProductShippingType" class="form-label">Shipping Type</label>
                                        <select class="form-select" id="editProductShippingType" name="shipping_type">
                                            <option value="standard">Shipping with Charge (Dhaka: 70 Tk, Outside: 120 Tk)</option>
                                            <option value="free">Free Shipping</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="editProductHasExpressShipping" name="has_express_shipping">
                                        <label class="form-check-label" for="editProductHasExpressShipping">
                                            Enable Express Shipping (Same Day Delivery in Dhaka)
                                        </label>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="editProductCustomShippingDhaka" class="form-label">Custom Dhaka Shipping</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="editProductCustomShippingDhaka" name="custom_shipping_dhaka" step="0.01" min="0" placeholder="70">
                                            </div>
                                            <small class="text-muted">Leave blank for default (70 Tk)</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="editProductCustomShippingOutside" class="form-label">Custom Outside Dhaka</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="editProductCustomShippingOutside" name="custom_shipping_outside" step="0.01" min="0" placeholder="120">
                                            </div>
                                            <small class="text-muted">Leave blank for default (120 Tk)</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="editProductCustomExpressShipping" class="form-label">Custom Express Shipping</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="editProductCustomExpressShipping" name="custom_express_shipping" step="0.01" min="0" placeholder="150">
                                            </div>
                                            <small class="text-muted">Leave blank for default (150 Tk)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- SEO -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-search me-2"></i>SEO Settings</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="editProductMetaTitle" class="form-label">Meta Title</label>
                                        <input type="text" class="form-control" id="editProductMetaTitle" name="meta_title" maxlength="200" placeholder="SEO title for search engines">
                                        <small class="text-muted">Recommended: 50-60 characters</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="editProductMetaDescription" class="form-label">Meta Description</label>
                                        <textarea class="form-control" id="editProductMetaDescription" name="meta_description" rows="3" maxlength="300" placeholder="SEO description for search engines"></textarea>
                                        <small class="text-muted">Recommended: 150-160 characters</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Media -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-video me-2"></i>Media</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="editProductYoutubeUrl" class="form-label">YouTube Video URL</label>
                                        <input type="url" class="form-control" id="editProductYoutubeUrl" name="youtube_video_url" placeholder="https://www.youtube.com/watch?v=VIDEO_ID">
                                        <small class="text-muted">Add a YouTube video to showcase your product</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="col-md-4">
                            <!-- Product Status -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-toggle-on me-2"></i>Status</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="editProductStatus" class="form-label">Status</label>
                                        <select class="form-select" id="editProductStatus" name="is_active">
                                            <option value="true">Active</option>
                                            <option value="false">Inactive</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="editProductIsFeatured" name="is_featured">
                                        <label class="form-check-label" for="editProductIsFeatured">
                                            Featured Product
                                        </label>
                                        <small class="form-text text-muted d-block">Show in featured product sections</small>
                                    </div>
                                    
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="editProductIsDigital" name="is_digital">
                                        <label class="form-check-label" for="editProductIsDigital">
                                            Digital Product
                                        </label>
                                        <small class="form-text text-muted d-block">No physical shipping required</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Category -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-tags me-2"></i>Category</h6>
                                </div>
                                <div class="card-body">
                                    <label for="editProductCategory" class="form-label">Category <span class="text-danger">*</span></label>
                                    <select class="form-select" id="editProductCategory" name="category" required>
                                        <option value="">Select Category</option>
                                        <!-- Categories will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>

                            <!-- Product Images -->
                            <div class="card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="fas fa-images me-2"></i>Product Images</h6>
                                    <small class="text-muted">Drag to reorder • Click star for primary</small>
                                </div>
                                <div class="card-body">
                                    <!-- Current Images Management -->
                                    <div id="editCurrentImagesContainer" class="mb-3" style="display: none;">
                                        <label class="form-label">Current Images</label>
                                        <div id="editCurrentImages" class="row g-2">
                                            <!-- Current images will be shown here -->
                                        </div>
                                    </div>
                                    
                                    <!-- Add New Images -->
                                    <div class="mb-3">
                                        <label for="editProductImages" class="form-label">Upload New Images</label>
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-outline-primary" id="editOpenMediaLibraryBtn">
                                                <i class="fas fa-images me-2"></i>Choose from Media Library
                                            </button>
                                            <small class="text-muted">Select images from media library or upload new ones</small>
                                        </div>
                                        <input type="file" class="form-control d-none" id="editProductImages" name="images" multiple accept="image/*">
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-success" id="updateProductBtn">
                                    <i class="fas fa-save me-1"></i> Update Product
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Variant Modal -->
<div class="modal fade" id="addVariantModal" tabindex="-1" aria-labelledby="addVariantModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addVariantModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Add Product Variant
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addVariantForm" enctype="multipart/form-data">
                    <input type="hidden" id="variantProductId">
                    
                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-8">
                            <!-- Basic Information -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="variantSKU" class="form-label">SKU <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="variantSKU" name="sku" required placeholder="e.g., MB-001-RED">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="variantName" class="form-label">Variant Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="variantName" name="name" required placeholder="e.g., Red - Large">
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="variantColor" class="form-label">Color</label>
                                            <input type="text" class="form-control" id="variantColor" name="color" placeholder="e.g., Red, Blue, Black">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="variantSize" class="form-label">Size</label>
                                            <input type="text" class="form-control" id="variantSize" name="size" placeholder="e.g., Small, Medium, Large">
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="variantMaterial" class="form-label">Material</label>
                                        <input type="text" class="form-control" id="variantMaterial" name="material" placeholder="e.g., Cotton, Polyester, Denim">
                                    </div>
                                </div>
                            </div>

                            <!-- Pricing & Inventory -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Pricing & Inventory</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label for="variantPrice" class="form-label">Selling Price <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="variantPrice" name="price" step="0.01" min="0" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label for="variantComparePrice" class="form-label">Compare Price (Optional)</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="variantComparePrice" name="compare_price" step="0.01" min="0">
                                            </div>
                                            <small class="text-muted">Original price for showing discounts</small>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="variantCostPrice" class="form-label">Cost Price (Optional)</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="variantCostPrice" name="cost_price" step="0.01" min="0">
                                            </div>
                                            <small class="text-muted">Your cost for profit tracking</small>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label for="variantStock" class="form-label">Stock Quantity</label>
                                            <input type="number" class="form-control" id="variantStock" name="stock_quantity" min="0" value="0" readonly>
                                            <small class="text-muted">Managed through Stock Management</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="col-md-4">
                            <!-- Status -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-toggle-on me-2"></i>Status</h6>
                                </div>
                                <div class="card-body">
                                    <label for="variantStatus" class="form-label">Status</label>
                                    <select class="form-select" id="variantStatus" name="is_active">
                                        <option value="true" selected>Active</option>
                                        <option value="false">Inactive</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Variant Image -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-image me-2"></i>Variant Image</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Choose Image</label>
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-outline-primary" id="variantOpenMediaLibraryBtn">
                                                <i class="fas fa-images me-2"></i>Choose from Media Library
                                            </button>
                                            <small class="text-muted">Select image from media library</small>
                                        </div>
                                        <input type="file" class="form-control d-none" id="variantImage" name="image" accept="image/*">
                                    </div>
                                    
                                    <div id="variantImagePreview" class="text-center" style="display: none;">
                                        <img id="variantImagePreviewImg" src="" alt="Variant Preview" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-sm btn-outline-danger" id="removeVariantImageBtn">
                                                <i class="fas fa-times me-1"></i>Remove Image
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-success" id="saveVariantBtn">
                                    <i class="fas fa-save me-1"></i> Save Variant
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Variant Modal -->
<div class="modal fade" id="editVariantModal" tabindex="-1" aria-labelledby="editVariantModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editVariantModalLabel">
                    <i class="fas fa-edit me-2"></i>Edit Variant
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editVariantForm" enctype="multipart/form-data">
                    <input type="hidden" id="editVariantId">
                    <input type="hidden" id="editVariantProductId">
                    
                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-8">
                            <!-- Basic Information -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="editVariantSKU" class="form-label">SKU <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="editVariantSKU" name="sku" required placeholder="e.g., MB-001-RED">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="editVariantName" class="form-label">Variant Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="editVariantName" name="name" required placeholder="e.g., Red - Large">
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="editVariantColor" class="form-label">Color</label>
                                            <input type="text" class="form-control" id="editVariantColor" name="color" placeholder="e.g., Red, Blue, Black">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="editVariantSize" class="form-label">Size</label>
                                            <input type="text" class="form-control" id="editVariantSize" name="size" placeholder="e.g., Small, Medium, Large">
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="editVariantMaterial" class="form-label">Material</label>
                                        <input type="text" class="form-control" id="editVariantMaterial" name="material" placeholder="e.g., Cotton, Polyester, Denim">
                                    </div>
                                </div>
                            </div>

                            <!-- Pricing & Inventory -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Pricing & Inventory</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label for="editVariantPrice" class="form-label">Selling Price <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="editVariantPrice" name="price" step="0.01" min="0" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label for="editVariantComparePrice" class="form-label">Compare Price (Optional)</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="editVariantComparePrice" name="compare_price" step="0.01" min="0">
                                            </div>
                                            <small class="text-muted">Original price for showing discounts</small>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="editVariantCostPrice" class="form-label">Cost Price (Optional)</label>
                                            <div class="input-group">
                                                <span class="input-group-text">৳</span>
                                                <input type="number" class="form-control" id="editVariantCostPrice" name="cost_price" step="0.01" min="0">
                                            </div>
                                            <small class="text-muted">Your cost for profit tracking</small>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label for="editVariantStock" class="form-label">Stock Quantity</label>
                                            <input type="number" class="form-control" id="editVariantStock" name="stock_quantity" min="0" required readonly>
                                            <small class="text-muted">Managed through Stock Management</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="col-md-4">
                            <!-- Status -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-toggle-on me-2"></i>Status & Options</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="editVariantStatus" class="form-label">Status</label>
                                        <select class="form-select" id="editVariantStatus" name="is_active">
                                            <option value="true">Active</option>
                                            <option value="false">Inactive</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="editVariantInStock" class="form-label">In Stock</label>
                                        <select class="form-select" id="editVariantInStock" name="in_stock">
                                            <option value="true">In Stock</option>
                                            <option value="false">Out of Stock</option>
                                        </select>
                                        <small class="text-muted">Control stock availability independently of quantity</small>
                                    </div>
                                    
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="editVariantIsDefault" name="is_default">
                                        <label class="form-check-label" for="editVariantIsDefault">
                                            <strong>Set as Default Variant</strong>
                                        </label>
                                        <small class="form-text text-muted d-block">This will be the default variant shown for the product. Only one variant can be default per product.</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Current Image -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-image me-2"></i>Variant Image</h6>
                                </div>
                                <div class="card-body">
                                    <!-- Current Image Display -->
                                    <div id="editCurrentImageContainer" class="mb-3" style="display: none;">
                                        <label class="form-label">Current Image</label>
                                        <div class="text-center">
                                            <img id="editCurrentImage" src="" alt="Current Variant Image" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                                            <br>
                                            <small class="text-muted">Current variant image</small>
                                            <br>
                                            <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="removeCurrentVariantImageBtn">
                                                <i class="fas fa-trash-alt me-1"></i> Remove Current Image
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- New Image Upload -->
                                    <div class="mb-3">
                                        <label class="form-label">Choose New Image</label>
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-outline-primary" id="editVariantOpenMediaLibraryBtn">
                                                <i class="fas fa-images me-2"></i>Choose from Media Library
                                            </button>
                                            <small class="text-muted">Select image from media library</small>
                                        </div>
                                        <input type="file" class="form-control d-none" id="editVariantImage" name="image" accept="image/*">
                                    </div>
                                    
                                    <div id="editVariantImagePreview" class="text-center" style="display: none;">
                                        <img id="editVariantImagePreviewImg" src="" alt="New Variant Preview" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-sm btn-outline-danger" id="removeNewVariantImageBtn">
                                                <i class="fas fa-times me-1"></i>Remove New Image
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-primary" id="updateVariantBtn">
                                    <i class="fas fa-save me-1"></i> Update Variant
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i> Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Media Library Modal -->
<div class="modal fade" id="mediaLibraryModal" tabindex="-1" aria-labelledby="mediaLibraryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mediaLibraryModalLabel">
                    <i class="fas fa-photo-video me-2"></i>Media Library
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Sidebar -->
                    <div class="col-md-3">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="mb-0">Upload New Files</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <input type="file" class="form-control" id="mediaUploadInput" multiple accept="image/*,video/*">
                                    <small class="text-muted">Select images or videos to upload</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="mediaUploadDirectory" class="form-label">Upload to:</label>
                                    <select class="form-select" id="mediaUploadDirectory">
                                        <option value="products">Products</option>
                                        <option value="variants">Variants</option>
                                        <option value="reviews">Reviews</option>
                                    </select>
                                </div>
                                
                                <button type="button" class="btn btn-primary w-100" id="uploadMediaBtn" disabled>
                                    <i class="fas fa-upload me-1"></i> Upload Files
                                </button>
                                
                                <div id="uploadProgress" class="mt-3" style="display: none;">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Main Content -->
                    <div class="col-md-9">
                        <!-- Filters -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-md-3">
                                        <input type="text" class="form-control" id="mediaSearchInput" placeholder="Search files...">
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="mediaTypeFilter">
                                            <option value="all">All Files</option>
                                            <option value="images">Images Only</option>
                                            <option value="videos">Videos Only</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="mediaDirectoryFilter">
                                            <option value="">All Directories</option>
                                            <option value="products">Products</option>
                                            <option value="variants">Variants</option>
                                            <option value="reviews">Reviews</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-primary w-100" id="applyMediaFiltersBtn">
                                            <i class="fas fa-filter me-1"></i> Apply
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Media Grid -->
                        <div class="card">
                            <div class="card-body">
                                <div id="mediaGridContainer">
                                    <div class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">Loading media files...</p>
                                    </div>
                                </div>
                                
                                <!-- Media Grid -->
                                <div id="mediaGrid" class="row g-3" style="display: none;">
                                    <!-- Media items will be loaded here -->
                                </div>
                                
                                <!-- Pagination -->
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <div>
                                        <span id="mediaTotalCount">0</span> files
                                    </div>
                                    <div>
                                        <nav aria-label="Media pagination">
                                            <ul class="pagination pagination-sm" id="mediaPagination">
                                                <!-- Pagination will be generated dynamically -->
                                            </ul>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100">
                    <div>
                        <span id="selectedMediaCount">0</span> files selected
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i> Cancel
                        </button>
                        <button type="button" class="btn btn-primary" id="useSelectedMediaBtn" disabled>
                            <i class="fas fa-check me-1"></i> Use Selected
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Readonly stock fields styling */
input[readonly] {
    background-color: #f8f9fa !important;
    cursor: not-allowed;
    border-color: #dee2e6;
}

input[readonly]:focus {
    box-shadow: none;
    border-color: #dee2e6;
}

/* Modal styling improvements */
.modal-xl {
    max-width: 75%;
}

@media (max-width: 768px) {
    .modal-xl {
        max-width: 98%;
        margin: 0.5rem;
    }
}

/* Media Library Styles */
.media-item {
    border: 2px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

.media-item:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.media-item.selected {
    border-color: #28a745;
    background-color: rgba(40, 167, 69, 0.1);
}

.media-item.selected::after {
    content: '\f00c';
    font-family: 'Font Awesome 5 Free';
    font-weight: 900;
    position: absolute;
    top: 8px;
    right: 8px;
    background: #28a745;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

.media-item-image {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 6px;
}

.media-item-info {
    padding: 8px;
    background: white;
    border-radius: 0 0 6px 6px;
}

.media-item-filename {
    font-size: 12px;
    font-weight: 500;
    color: #333;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
}

.media-item-meta {
    font-size: 10px;
    color: #666;
    margin-top: 2px;
}

.media-upload-area {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    transition: border-color 0.2s ease;
}

.media-upload-area.dragover {
    border-color: #007bff;
    background-color: rgba(0, 123, 255, 0.05);
}

.media-item-actions {
    position: absolute;
    top: 8px;
    left: 8px;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.media-item:hover .media-item-actions {
    opacity: 1;
}

.media-item-delete {
    background: rgba(220, 53, 69, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    cursor: pointer;
}

.media-item-delete:hover {
    background: #dc3545;
}

/* Loading animations */
.media-loading {
    opacity: 0.6;
    pointer-events: none;
}

.upload-progress-item {
    border: 1px dashed #ccc;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 10px;
    background: #f8f9fa;
}

.upload-progress-item .progress {
    height: 4px;
    margin-top: 8px;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- TinyMCE Script - With API Key -->
<script src="https://cdn.tiny.cloud/1/otaolz4vlw64z1nic5r4gpfpoe1zju4rtax994f61d5ilduq/tinymce/8/tinymce.min.js" referrerpolicy="origin" crossorigin="anonymous"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = 1;
    let selectedProductId = null;
    let currentMediaPage = 1;
    let selectedMediaFiles = [];
    let mediaLibraryCallback = null;
    let productDescriptionEditor = null;
    let editProductDescriptionEditor = null;
    
    // Initial data loading
    loadCategories();
    loadProducts();
    
    // Event listeners
    document.getElementById('refreshProductsBtn').addEventListener('click', loadProducts);
    document.getElementById('applyFiltersBtn').addEventListener('click', loadProducts);
    document.getElementById('saveProductBtn').addEventListener('click', saveProduct);
    document.getElementById('updateProductBtn').addEventListener('click', updateProduct);
    document.getElementById('saveVariantBtn').addEventListener('click', saveVariant);
    document.getElementById('updateVariantBtn').addEventListener('click', updateVariant);
    
    // Initialize TinyMCE when Add Product Modal is shown
    document.getElementById('addProductModal').addEventListener('shown.bs.modal', function() {
        initializeTinyMCE('productDescription');
    });
    
    // Destroy TinyMCE when Add Product Modal is hidden
    document.getElementById('addProductModal').addEventListener('hidden.bs.modal', function() {
        destroyTinyMCE('productDescription');
    });
    
    // Initialize TinyMCE when Edit Product Modal is shown
    document.getElementById('editProductModal').addEventListener('shown.bs.modal', function() {
        initializeTinyMCE('editProductDescription');
    });
    
    // Destroy TinyMCE when Edit Product Modal is hidden
    document.getElementById('editProductModal').addEventListener('hidden.bs.modal', function() {
        destroyTinyMCE('editProductDescription');
    });
    
    // Media Library Event Listeners
    document.getElementById('openMediaLibraryBtn').addEventListener('click', function() {
        openMediaLibrary('add');
    });
    
    document.getElementById('editOpenMediaLibraryBtn').addEventListener('click', function() {
        openMediaLibrary('edit');
    });
    
    document.getElementById('applyMediaFiltersBtn').addEventListener('click', function() {
        loadMediaFiles(1);
    });
    
    document.getElementById('mediaUploadInput').addEventListener('change', function() {
        document.getElementById('uploadMediaBtn').disabled = this.files.length === 0;
    });
    
    document.getElementById('uploadMediaBtn').addEventListener('click', uploadMediaFiles);
    document.getElementById('useSelectedMediaBtn').addEventListener('click', useSelectedMedia);
    
    // Variant Media Library Event Listeners
    document.getElementById('variantOpenMediaLibraryBtn').addEventListener('click', function() {
        openMediaLibrary('variant');
    });
    
    document.getElementById('editVariantOpenMediaLibraryBtn').addEventListener('click', function() {
        openMediaLibrary('editVariant');
    });
    
    // Remove variant image previews
    document.addEventListener('click', function(event) {
        if (event.target && event.target.id === 'removeVariantImageBtn') {
            const previewContainer = document.getElementById('variantImagePreview');
            previewContainer.style.display = 'none';
            previewContainer.dataset.selectedImageUrl = '';
            previewContainer.dataset.selectedImageAlt = '';
        }
        
        if (event.target && event.target.id === 'removeNewVariantImageBtn') {
            const previewContainer = document.getElementById('editVariantImagePreview');
            previewContainer.style.display = 'none';
            previewContainer.dataset.selectedImageUrl = '';
            previewContainer.dataset.selectedImageAlt = '';
        }
    });
    
    // Remove current variant image functionality
    document.addEventListener('click', function(event) {
        if (event.target && event.target.id === 'removeCurrentVariantImageBtn') {
            if (confirm('Are you sure you want to remove the current variant image?')) {
                const variantId = document.getElementById('editVariantId').value;
                
                // Call the API to remove the image
                fetch(`/mb-admin/api/variants/${variantId}/remove_image/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Hide the current image container
                        document.getElementById('editCurrentImageContainer').style.display = 'none';
                        
                        // Refresh the variants list to show updated state
                        if (selectedProductId) {
                            loadProductVariants(selectedProductId);
                        }
                        
                        showAlert('Variant image removed successfully!', 'success');
                    } else {
                        showAlert(data.message || 'Failed to remove image.', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error removing image:', error);
                    showAlert('Failed to remove image.', 'danger');
                });
            }
        }
    });
    
    // Image preview functionality
    document.getElementById('productImages').addEventListener('change', function() {
        handleImagePreview(this.files, 'imagePreview');
    });
    
    // Variant image preview functionality
    document.getElementById('variantImage').addEventListener('change', function() {
        handleVariantImagePreview(this, 'variantImagePreview', 'variantImagePreviewImg');
    });
    
    document.getElementById('editVariantImage').addEventListener('change', function() {
        handleVariantImagePreview(this, 'editVariantImagePreview', 'editVariantImagePreviewImg');
    });
    
    // Auto-generate slug from product name
    document.getElementById('productName').addEventListener('input', function() {
        const slug = generateSlug(this.value);
        document.getElementById('productSlug').value = slug;
    });
    
    document.getElementById('editProductName').addEventListener('input', function() {
        const slug = generateSlug(this.value);
        document.getElementById('editProductSlug').value = slug;
    });
    
    // Load categories for dropdowns
    function loadCategories() {
        fetch('/mb-admin/api/categories/')
            .then(response => response.json())
            .then(data => {
                const categories = data.results || data;
                populateCategoryDropdown('productCategory', categories);
                populateCategoryDropdown('editProductCategory', categories);
                populateCategoryDropdown('categoryFilter', categories);
            })
            .catch(error => console.error('Error loading categories:', error));
    }
    
    function populateCategoryDropdown(elementId, categories) {
        const dropdown = document.getElementById(elementId);
        const currentValue = dropdown.value;
        
        // Clear existing options except the first one if it's a filter
        if (elementId === 'categoryFilter') {
            dropdown.innerHTML = '<option value="">All Categories</option>';
        } else {
            dropdown.innerHTML = '';
        }
        
        // Add categories to dropdown
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            dropdown.appendChild(option);
        });
        
        // Restore selected value if there was one
        if (currentValue) {
            dropdown.value = currentValue;
        }
    }
    
    // Load products with pagination and filtering
    function loadProducts(page = 1) {
        currentPage = page;
        const searchTerm = document.getElementById('productSearchInput').value.trim();
        const categoryFilter = document.getElementById('categoryFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        
        let url = `/mb-admin/api/products/?page=${page}`;
        
        if (searchTerm) {
            url += `&search=${encodeURIComponent(searchTerm)}`;
        }
        
        if (categoryFilter) {
            url += `&category=${categoryFilter}`;
        }
        
        if (statusFilter !== '') {
            url += `&is_active=${statusFilter}`;
        }
        
        // Show loading indicator
        document.getElementById('productsTableBody').innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading products...</p>
                </td>
            </tr>
        `;
        
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Server responded with an error');
                }
                return response.json();
            })
            .then(data => {
                displayProducts(data.results);
                updatePagination(data);
                document.getElementById('productsTotalCount').textContent = data.count || 0;
            })
            .catch(error => {
                console.error('Error loading products:', error);
                document.getElementById('productsTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="alert alert-danger" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Error loading products. Please try again.</strong>
                            </div>
                        </td>
                    </tr>
                `;
                
                // Also display a top alert
                showAlert('Error loading products. Please try again.', 'danger');
            });
    }
    
    function displayProducts(products) {
        const tbody = document.getElementById('productsTableBody');
        tbody.innerHTML = '';
        
        if (!products || products.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">No products found.</td>
                </tr>
            `;
            return;
        }
        
        products.forEach(product => {
            const tr = document.createElement('tr');
            tr.dataset.productId = product.id;
            tr.innerHTML = `
                <td>${product.id}</td>
                <td>${product.name}</td>
                <td>${product.category_name}</td>
                <td>$${product.base_price}</td>
                <td>${product.variant_count || 0}</td>
                <td>
                    <span class="badge ${product.is_active ? 'bg-success' : 'bg-secondary'}">
                        ${product.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>${new Date(product.updated_at).toLocaleDateString()}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary edit-product-btn" data-product-id="${product.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger delete-product-btn" data-product-id="${product.id}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <button type="button" class="btn btn-outline-info view-variants-btn" data-product-id="${product.id}" data-product-name="${product.name}">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Add event listeners to the action buttons
        addProductActionListeners();
    }
    
    function addProductActionListeners() {
        document.querySelectorAll('.edit-product-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.dataset.productId;
                loadProductDetails(productId);
            });
        });
        
        document.querySelectorAll('.delete-product-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.dataset.productId;
                if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                    deleteProduct(productId);
                }
            });
        });
        
        document.querySelectorAll('.view-variants-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                selectedProductId = this.dataset.productId;
                const productName = this.dataset.productName;
                document.getElementById('selectedProductName').textContent = productName;
                document.getElementById('variantProductId').value = selectedProductId;
                document.getElementById('addVariantBtn').disabled = false;
                
                // Show the variants modal
                const modal = new bootstrap.Modal(document.getElementById('productVariantsModal'));
                modal.show();
                
                // Load variants after modal is shown
                loadProductVariants(selectedProductId);
            });
        });
    }
    
    function updatePagination(data) {
        const pagination = document.getElementById('productsPagination');
        pagination.innerHTML = '';
        
        const totalPages = Math.ceil(data.count / data.results.length);
        if (totalPages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
        pagination.appendChild(prevLi);
        
        // Page numbers
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            pagination.appendChild(li);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
        pagination.appendChild(nextLi);
        
        // Add event listeners to pagination links
        document.querySelectorAll('#productsPagination .page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.dataset.page);
                loadProducts(page);
            });
        });
    }
    
    // Product CRUD operations
    function saveProduct() {
        const form = document.getElementById('addProductForm');
        const formData = new FormData(form);
        
        // Get TinyMCE content for description
        const descriptionEditor = tinymce.get('productDescription');
        if (descriptionEditor) {
            const descriptionContent = descriptionEditor.getContent();
            formData.set('description', descriptionContent);
        }
        
        // Convert checkbox values to boolean
        formData.set('is_active', document.getElementById('productStatus').value === 'true');
        formData.set('is_featured', document.getElementById('productIsFeatured').checked);
        formData.set('is_digital', document.getElementById('productIsDigital').checked);
        formData.set('track_inventory', document.getElementById('productTrackInventory').checked);
        formData.set('has_express_shipping', document.getElementById('productHasExpressShipping').checked);
        
        // Convert numeric values
        const numericFields = ['price', 'compare_price', 'cost_price', 'stock_quantity', 'low_stock_threshold', 
                              'weight', 'custom_shipping_dhaka', 'custom_shipping_outside', 'custom_express_shipping'];
        numericFields.forEach(field => {
            const value = formData.get(field);
            if (value && value.trim() !== '') {
                formData.set(field, parseFloat(value));
            } else if (['price', 'stock_quantity', 'low_stock_threshold'].includes(field)) {
                // Required fields with defaults
                formData.set(field, field === 'price' ? 0 : (field.includes('stock') ? 0 : 5));
            } else {
                formData.delete(field); // Remove empty optional numeric fields
            }
        });

        // Store images separately (they'll be uploaded after product creation)
        const imageFiles = document.getElementById('productImages').files;
        const imageData = [];
        
        // Get alt text and primary info from preview cards
        document.querySelectorAll('.image-preview-card').forEach(card => {
            const fileIndex = parseInt(card.dataset.fileIndex);
            const altTextInput = card.querySelector('input[type="text"]');
            const primaryBtn = card.querySelector('.primary-image-btn');
            const isPrimary = primaryBtn.classList.contains('btn-warning');
            
            // Check if this is a media library file
            const mediaFileData = card.dataset.mediaFile;
            if (mediaFileData) {
                // This is from media library
                const mediaFile = JSON.parse(mediaFileData);
                imageData.push({
                    media_file: mediaFile,
                    alt_text: altTextInput ? altTextInput.value : mediaFile.filename,
                    is_primary: isPrimary,
                    is_from_library: true
                });
            } else if (imageFiles[fileIndex]) {
                // This is an uploaded file
                imageData.push({
                    file: imageFiles[fileIndex],
                    alt_text: altTextInput ? altTextInput.value : '',
                    is_primary: isPrimary,
                    is_from_library: false
                });
            }
        });

        // Remove images from formData for product creation
        formData.delete('images');

        fetch('/mb-admin/api/products/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(JSON.stringify(data));
                });
            }
            return response.json();
        })
        .then(product => {
            // Upload images after product creation
            if (imageData.length > 0) {
                return uploadProductImages(product.id, imageData).then(() => product);
            }
            return product;
        })
        .then(data => {
            // Close modal and refresh product list
            const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
            modal.hide();
            form.reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('imageManagementContainer').style.display = 'none';
            loadProducts();
            showAlert('Product added successfully!', 'success');
        })
        .catch(error => {
            console.error('Error saving product:', error);
            showAlert('Failed to add product. ' + error.message, 'danger');
        });
    }
    
    function uploadProductImages(productId, imageData) {
        // Ensure at least one image is marked as primary
        const hasPrimary = imageData.some(img => img.is_primary);
        if (!hasPrimary && imageData.length > 0) {
            imageData[0].is_primary = true;
        }
        
        const uploadPromises = imageData.map((imageInfo, index) => {
            const formData = new FormData();
            formData.append('product', productId);
            formData.append('alt_text', imageInfo.alt_text);
            formData.append('is_primary', imageInfo.is_primary);
            
            if (imageInfo.is_from_library) {
                // For media library files, send the URL directly
                formData.append('image_url', imageInfo.media_file.url);
                formData.append('filename', imageInfo.media_file.filename);
            } else {
                // For uploaded files, send the file
                formData.append('uploaded_image', imageInfo.file);
            }
            
            return fetch('/mb-admin/api/product-images/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            });
        });
        
        return Promise.all(uploadPromises);
    }
    
    function loadProductDetails(productId) {
        fetch(`/mb-admin/api/products/${productId}/`)
            .then(response => response.json())
            .then(product => {
                // Basic information
                document.getElementById('editProductId').value = product.id;
                document.getElementById('editProductName').value = product.name || '';
                document.getElementById('editProductSlug').value = product.slug || '';
                
                // Set TinyMCE content for description
                const descriptionEditor = tinymce.get('editProductDescription');
                if (descriptionEditor) {
                    descriptionEditor.setContent(product.description || '');
                } else {
                    document.getElementById('editProductDescription').value = product.description || '';
                }
                
                document.getElementById('editProductShortDescription').value = product.short_description || '';
                
                // Product identification
                document.getElementById('editProductSKU').value = product.sku || '';
                document.getElementById('editProductBarcode').value = product.barcode || '';
                
                // Category
                document.getElementById('editProductCategory').value = product.category;
                
                // Pricing
                document.getElementById('editProductPrice').value = product.price || product.base_price || '';
                document.getElementById('editProductComparePrice').value = product.compare_price || '';
                document.getElementById('editProductCostPrice').value = product.cost_price || '';
                
                // Inventory
                document.getElementById('editProductStockQuantity').value = product.stock_quantity || 0;
                document.getElementById('editProductLowStockThreshold').value = product.low_stock_threshold || 5;
                document.getElementById('editProductTrackInventory').checked = product.track_inventory !== false;
                
                // Physical attributes
                document.getElementById('editProductWeight').value = product.weight || '';
                document.getElementById('editProductDimensions').value = product.dimensions || '';
                
                // Shipping options
                document.getElementById('editProductShippingType').value = product.shipping_type || 'standard';
                document.getElementById('editProductHasExpressShipping').checked = product.has_express_shipping || false;
                document.getElementById('editProductCustomShippingDhaka').value = product.custom_shipping_dhaka || '';
                document.getElementById('editProductCustomShippingOutside').value = product.custom_shipping_outside || '';
                document.getElementById('editProductCustomExpressShipping').value = product.custom_express_shipping || '';
                
                // SEO
                document.getElementById('editProductMetaTitle').value = product.meta_title || '';
                document.getElementById('editProductMetaDescription').value = product.meta_description || '';
                
                // Media
                document.getElementById('editProductYoutubeUrl').value = product.youtube_video_url || '';
                
                // Status
                document.getElementById('editProductStatus').value = product.is_active.toString();
                document.getElementById('editProductIsFeatured').checked = product.is_featured || false;
                document.getElementById('editProductIsDigital').checked = product.is_digital || false;
                
                // Load current images (if any)
                loadCurrentProductImages(product.id);
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading product details:', error);
                showAlert('Failed to load product details.', 'danger');
            });
    }
    
    function updateProduct() {
        const form = document.getElementById('editProductForm');
        const formData = new FormData(form);
        const productId = document.getElementById('editProductId').value;
        
        // Get TinyMCE content for description
        const descriptionEditor = tinymce.get('editProductDescription');
        if (descriptionEditor) {
            const descriptionContent = descriptionEditor.getContent();
            formData.set('description', descriptionContent);
        }
        
        // Convert checkbox values to boolean
        formData.set('is_active', document.getElementById('editProductStatus').value === 'true');
        formData.set('is_featured', document.getElementById('editProductIsFeatured').checked);
        formData.set('is_digital', document.getElementById('editProductIsDigital').checked);
        formData.set('track_inventory', document.getElementById('editProductTrackInventory').checked);
        formData.set('has_express_shipping', document.getElementById('editProductHasExpressShipping').checked);
        
        // Convert numeric values
        const numericFields = ['price', 'compare_price', 'cost_price', 'stock_quantity', 'low_stock_threshold', 
                              'weight', 'custom_shipping_dhaka', 'custom_shipping_outside', 'custom_express_shipping'];
        numericFields.forEach(field => {
            const value = formData.get(field);
            if (value && value.trim() !== '') {
                formData.set(field, parseFloat(value));
            } else if (['price', 'stock_quantity', 'low_stock_threshold'].includes(field)) {
                // Required fields with defaults
                formData.set(field, field === 'price' ? 0 : (field.includes('stock') ? 0 : 5));
            } else {
                formData.delete(field); // Remove empty optional numeric fields
            }
        });

        // Remove images from formData for product update
        formData.delete('images');

        fetch(`/mb-admin/api/products/${productId}/`, {
            method: 'PUT',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(JSON.stringify(data));
                });
            }
            return response.json();
        })
        .then(product => {
            return product;
        })
        .then(data => {
            // Close modal and refresh product list
            const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
            modal.hide();
            loadProducts();
            showAlert('Product updated successfully!', 'success');
        })
        .catch(error => {
            console.error('Error updating product:', error);
            showAlert('Failed to update product. ' + error.message, 'danger');
        });
    }
    
    function deleteProduct(productId) {
        fetch(`/mb-admin/api/products/${productId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete product');
            }
            loadProducts();
            showAlert('Product deleted successfully!', 'success');
        })
        .catch(error => {
            console.error('Error deleting product:', error);
            showAlert('Failed to delete product.', 'danger');
        });
    }
    
    // Product Variants management
    function loadProductVariants(productId) {
        document.getElementById('selectProductMessage').style.display = 'none';
        document.getElementById('variantsContainer').style.display = 'block';
        
        // Show loading indicator
        document.getElementById('variantsTableBody').innerHTML = `
            <tr>
                <td colspan="11" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Loading variants...</span>
                </td>
            </tr>
        `;
        
        fetch(`/mb-admin/api/variants/?product=${productId}`)
            .then(response => response.json())
            .then(data => {
                displayProductVariants(data.results || data);
            })
            .catch(error => {
                console.error('Error loading variants:', error);
                document.getElementById('variantsTableBody').innerHTML = `
                    <tr>
                        <td colspan="11" class="text-center py-3 text-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Failed to load variants.
                        </td>
                    </tr>
                `;
            });
    }
    
    function displayProductVariants(variants) {
        const tbody = document.getElementById('variantsTableBody');
        tbody.innerHTML = '';
        
        if (!variants || variants.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="11" class="text-center py-3">
                        No variants found for this product. 
                        <button class="btn btn-sm btn-link add-first-variant-btn">
                            Add your first variant
                        </button>
                    </td>
                </tr>
            `;
            
            document.querySelector('.add-first-variant-btn')?.addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('addVariantModal'));
                modal.show();
            });
            
            return;
        }
        
        variants.forEach(variant => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${variant.id}</td>
                <td>${variant.sku}</td>
                <td>
                    <div class="d-flex align-items-center">
                        ${variant.image_url ? 
                            `<img src="${variant.image_url}" alt="${variant.name}" class="me-2" style="width: 30px; height: 30px; object-fit: cover; border-radius: 4px;">` : 
                            `<div class="me-2 bg-light d-flex align-items-center justify-content-center" style="width: 30px; height: 30px; border-radius: 4px;"><i class="fas fa-image text-muted" style="font-size: 12px;"></i></div>`
                        }
                        <span>${variant.name}</span>
                    </div>
                </td>
                <td>
                    ${variant.color ? 
                        `<span class="badge bg-light text-dark" style="border: 1px solid #dee2e6;">${variant.color}</span>` : 
                        `<span class="text-muted">-</span>`
                    }
                </td>
                <td>
                    ${variant.size ? 
                        `<span class="badge bg-light text-dark" style="border: 1px solid #dee2e6;">${variant.size}</span>` : 
                        `<span class="text-muted">-</span>`
                    }
                </td>
                <td>
                    <strong>৳${variant.price}</strong>
                    ${variant.discount_percentage ? 
                        `<br><small class="badge bg-success">${variant.discount_percentage}% OFF</small>` : 
                        ''
                    }
                </td>
                <td>
                    ${variant.compare_price ? 
                        `<span class="text-muted">৳${variant.compare_price}</span>` : 
                        `<span class="text-muted">-</span>`
                    }
                </td>
                <td>
                    ${variant.cost_price ? 
                        `<span class="text-muted">৳${variant.cost_price}</span>
                         ${variant.profit_margin ? `<br><small class="text-success">${variant.profit_margin.toFixed(1)}% profit</small>` : ''}` : 
                        `<span class="text-muted">-</span>`
                    }
                </td>
                <td>${variant.stock_quantity}</td>
                <td>
                    <div class="d-flex flex-column align-items-start">
                        <span class="badge ${variant.is_active ? 'bg-success' : 'bg-secondary'} mb-1">
                            ${variant.is_active ? 'Active' : 'Inactive'}
                        </span>
                        ${variant.is_default ? 
                            '<span class="badge bg-primary"><i class="fas fa-star me-1"></i>Default</span>' : 
                            ''
                        }
                        ${!variant.in_stock ? 
                            '<span class="badge bg-warning text-dark">Out of Stock</span>' : 
                            ''
                        }
                    </div>
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary edit-variant-btn" data-variant-id="${variant.id}" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger delete-variant-btn" data-variant-id="${variant.id}" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        // Add event listeners to variant action buttons
        addVariantActionListeners();
    }
    
    function addVariantActionListeners() {
        document.querySelectorAll('.edit-variant-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const variantId = this.dataset.variantId;
                loadVariantDetails(variantId);
            });
        });
        
        document.querySelectorAll('.delete-variant-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const variantId = this.dataset.variantId;
                if (confirm('Are you sure you want to delete this variant? This action cannot be undone.')) {
                    deleteVariant(variantId);
                }
            });
        });
    }
    
    function saveVariant() {
        const form = document.getElementById('addVariantForm');
        const formData = new FormData(form);
        
        // Add the product ID
        formData.set('product', document.getElementById('variantProductId').value);
        
        // Convert string values to proper types for non-file fields
        formData.set('is_active', formData.get('is_active') === 'true');
        formData.set('price', parseFloat(formData.get('price')));
        formData.set('stock_quantity', parseInt(formData.get('stock_quantity')) || 0);
        
        // Handle image from media library or file upload
        const imageInput = document.getElementById('variantImage');
        const variantImagePreview = document.getElementById('variantImagePreview');
        
        // Check if image was selected from media library
        if (variantImagePreview.dataset.selectedImageUrl) {
            formData.append('image_url_input', variantImagePreview.dataset.selectedImageUrl);
            formData.delete('image'); // Remove file input
        } else if (imageInput.files && imageInput.files.length > 0 && imageInput.files[0]) {
            // File upload - keep the file in formData
            formData.append('uploaded_image', imageInput.files[0]);
            formData.delete('image'); // Remove the original image field
        } else {
            // No image selected
            formData.delete('image');
        }
        
        fetch('/mb-admin/api/variants/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(JSON.stringify(data));
                });
            }
            return response.json();
        })
        .then(data => {
            // Close modal and refresh variants list
            const modal = bootstrap.Modal.getInstance(document.getElementById('addVariantModal'));
            modal.hide();
            form.reset();
            document.getElementById('variantImagePreview').style.display = 'none';
            loadProductVariants(selectedProductId);
            showAlert('Variant added successfully!', 'success');
        })
        .catch(error => {
            console.error('Error saving variant:', error);
            showAlert('Failed to add variant. ' + error.message, 'danger');
        });
    }
    
    function loadVariantDetails(variantId) {
        fetch(`/mb-admin/api/variants/${variantId}/`)
            .then(response => response.json())
            .then(variant => {
                console.log('Loading variant details:', variant);
                
                document.getElementById('editVariantId').value = variant.id;
                document.getElementById('editVariantProductId').value = variant.product;
                document.getElementById('editVariantSKU').value = variant.sku;
                document.getElementById('editVariantName').value = variant.name;
                document.getElementById('editVariantColor').value = variant.color || '';
                document.getElementById('editVariantSize').value = variant.size || '';
                document.getElementById('editVariantMaterial').value = variant.material || '';
                document.getElementById('editVariantPrice').value = variant.price;
                document.getElementById('editVariantComparePrice').value = variant.compare_price || '';
                document.getElementById('editVariantCostPrice').value = variant.cost_price || '';
                document.getElementById('editVariantStock').value = variant.stock_quantity;
                document.getElementById('editVariantStatus').value = variant.is_active.toString();
                document.getElementById('editVariantInStock').value = variant.in_stock ? variant.in_stock.toString() : 'true';
                document.getElementById('editVariantIsDefault').checked = variant.is_default || false;
                
                // Handle current variant image
                const currentImageContainer = document.getElementById('editCurrentImageContainer');
                const currentImage = document.getElementById('editCurrentImage');
                
                console.log('Variant image_url:', variant.image_url);
                
                if (variant.image_url) {
                    currentImage.src = variant.image_url;
                    currentImageContainer.style.display = 'block';
                } else {
                    currentImageContainer.style.display = 'none';
                }
                
                // Reset the new image preview and clear any previous media library selection
                const editVariantImagePreview = document.getElementById('editVariantImagePreview');
                editVariantImagePreview.style.display = 'none';
                editVariantImagePreview.dataset.selectedImageUrl = '';
                editVariantImagePreview.dataset.selectedImageAlt = '';
                document.getElementById('editVariantImage').value = '';
                
                // Clear any previous media selections
                selectedMediaFiles = [];
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('editVariantModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading variant details:', error);
                showAlert('Failed to load variant details.', 'danger');
            });
    }
    
    function updateVariant() {
        const form = document.getElementById('editVariantForm');
        const formData = new FormData(form);
        const variantId = document.getElementById('editVariantId').value;
        
        // Add the product ID
        formData.set('product', document.getElementById('editVariantProductId').value);
        
        // Convert string values to proper types for non-file fields
        formData.set('is_active', formData.get('is_active') === 'true');
        formData.set('in_stock', formData.get('in_stock') === 'true');
        formData.set('is_default', document.getElementById('editVariantIsDefault').checked);
        formData.set('price', parseFloat(formData.get('price')));
        formData.set('stock_quantity', parseInt(formData.get('stock_quantity')) || 0);
        
        // Handle image from media library or file upload
        const imageInput = document.getElementById('editVariantImage');
        const editVariantImagePreview = document.getElementById('editVariantImagePreview');
        
        console.log('updateVariant - checking image sources:');
        console.log('Media library URL:', editVariantImagePreview.dataset.selectedImageUrl);
        console.log('File input files:', imageInput.files?.length);
        
        // Check if image was selected from media library
        if (editVariantImagePreview.dataset.selectedImageUrl) {
            console.log('Using media library image:', editVariantImagePreview.dataset.selectedImageUrl);
            formData.append('image_url_input', editVariantImagePreview.dataset.selectedImageUrl);
            formData.delete('image'); // Remove file input
        } else if (imageInput.files && imageInput.files.length > 0 && imageInput.files[0]) {
            // File upload - keep the file in formData
            console.log('Using file upload:', imageInput.files[0].name);
            formData.append('uploaded_image', imageInput.files[0]);
            formData.delete('image'); // Remove the original image field
        } else {
            // No new image selected - keep current image
            console.log('No new image selected - keeping current');
            formData.delete('image');
        }
        
        fetch(`/mb-admin/api/variants/${variantId}/`, {
            method: 'PUT',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(JSON.stringify(data));
                });
            }
            return response.json();
        })
        .then(data => {
            // Close modal and refresh variants list
            const modal = bootstrap.Modal.getInstance(document.getElementById('editVariantModal'));
            modal.hide();
            loadProductVariants(selectedProductId);
            showAlert('Variant updated successfully!', 'success');
        })
        .catch(error => {
            console.error('Error updating variant:', error);
            showAlert('Failed to update variant. ' + error.message, 'danger');
        });
    }
    
    function deleteVariant(variantId) {
        fetch(`/mb-admin/api/variants/${variantId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete variant');
            }
            loadProductVariants(selectedProductId);
            showAlert('Variant deleted successfully!', 'success');
        })
        .catch(error => {
            console.error('Error deleting variant:', error);
            showAlert('Failed to delete variant.', 'danger');
        });
    }
    
    // Helper functions
    function showAlert(message, type) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Insert at the top of the content area
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                const bsAlert = bootstrap.Alert.getOrCreateInstance(alertDiv);
                bsAlert.close();
            }
        }, 5000);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        
        // Fallback to meta tag for CSRF token
        if (!cookieValue && name === 'csrftoken') {
            const csrfMeta = document.querySelector('meta[name="csrf-token"]');
            if (csrfMeta) {
                cookieValue = csrfMeta.getAttribute('content');
            }
        }
        
        return cookieValue;
    }
    
    function generateSlug(text) {
        return text
            .toLowerCase()
            .replace(/[^\w ]+/g, '')
            .replace(/ +/g, '-')
            .trim();
    }
    
    function handleImagePreview(files, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        
        if (files.length === 0) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'block';
        
        Array.from(files).forEach((file, index) => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const col = document.createElement('div');
                    col.className = 'col-6 col-md-4 col-lg-3';
                    col.innerHTML = `
                        <div class="card image-preview-card" data-file-index="${index}">
                            <div class="position-relative">
                                <img src="${e.target.result}" class="card-img-top" style="height: 100px; object-fit: cover;">
                                <div class="position-absolute top-0 end-0 p-1">
                                    <button type="button" class="btn btn-sm btn-danger remove-image-btn" data-file-index="${index}">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="position-absolute top-0 start-0 p-1">
                                    <button type="button" class="btn btn-sm ${index === 0 ? 'btn-warning' : 'btn-outline-warning'} primary-image-btn" data-file-index="${index}" title="Set as primary">
                                        <i class="fas fa-star"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-2">
                                <small class="text-muted">${index === 0 ? 'Primary Image' : `Image ${index + 1}`}</small>
                                <div class="mb-2">
                                    <small class="text-muted">${(file.size / 1024).toFixed(1)} KB</small>
                                </div>
                                <div class="mb-2">
                                    <input type="text" class="form-control form-control-sm" placeholder="Alt text" data-file-index="${index}" maxlength="200">
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Show image management container for add modal
        if (containerId === 'imagePreview') {
            document.getElementById('imageManagementContainer').style.display = 'block';
        }
        
        // Add event listeners after a short delay to ensure DOM is ready
        setTimeout(() => {
            addImagePreviewListeners();
        }, 100);
    }
    
    function loadCurrentProductImages(productId) {
        const container = document.getElementById('editCurrentImages');
        const containerDiv = document.getElementById('editCurrentImagesContainer');
        
        fetch(`/mb-admin/api/product-images/?product=${productId}`)
            .then(response => response.json())
            .then(data => {
                const images = data.results || data;
                container.innerHTML = '';
                
                if (images.length === 0) {
                    containerDiv.style.display = 'none';
                    return;
                }
                
                containerDiv.style.display = 'block';
                
                images.forEach((image, index) => {
                    const col = document.createElement('div');
                    col.className = 'col-6';
                    col.innerHTML = `
                        <div class="card current-image-card" data-image-id="${image.id}">
                            <div class="position-relative">
                                <img src="${image.image_url || image.image}" class="card-img-top" style="height: 100px; object-fit: cover;" alt="${image.alt_text || ''}">
                                <div class="position-absolute top-0 end-0 p-1">
                                    <button type="button" class="btn btn-sm btn-danger delete-current-image-btn" data-image-id="${image.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div class="position-absolute top-0 start-0 p-1">
                                    <button type="button" class="btn btn-sm ${image.is_primary ? 'btn-warning' : 'btn-outline-warning'} toggle-primary-btn" 
                                            data-image-id="${image.id}" 
                                            title="${image.is_primary ? 'Click to remove as primary' : 'Click to set as primary'}">
                                        <i class="fas ${image.is_primary ? 'fa-star' : 'fa-star'}"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-2">
                                <small class="text-muted">
                                    <i class="fas fa-star text-warning me-1" style="${image.is_primary ? '' : 'display:none;'}"></i>
                                    ${image.is_primary ? 'Primary Image' : 'Additional Image'}
                                </small>
                                <div class="mb-2">
                                    <input type="text" class="form-control form-control-sm alt-text-input" 
                                           value="${image.alt_text || ''}" 
                                           placeholder="Alt text" 
                                           data-image-id="${image.id}" 
                                           maxlength="200">
                                </div>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-sm btn-outline-primary update-alt-text-btn" data-image-id="${image.id}">
                                        <i class="fas fa-save me-1"></i>Update Alt Text
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                });
                
                // Add event listeners
                addCurrentImageListeners();
            })
            .catch(error => {
                console.error('Error loading product images:', error);
                containerDiv.style.display = 'none';
            });
    }
    
    function addImagePreviewListeners() {
        // Remove image from preview
        document.querySelectorAll('.remove-image-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const fileIndex = parseInt(this.dataset.fileIndex);
                removeImageFromPreview(fileIndex);
            });
        });
        
        // Set primary image
        document.querySelectorAll('.primary-image-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const fileIndex = parseInt(this.dataset.fileIndex);
                setPrimaryImageInPreview(fileIndex);
            });
        });
    }
    
    function addCurrentImageListeners() {
        // Delete current image
        document.querySelectorAll('.delete-current-image-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const imageId = this.dataset.imageId;
                if (confirm('Are you sure you want to delete this image?')) {
                    deleteProductImage(imageId);
                }
            });
        });
        
        // Toggle primary image
        document.querySelectorAll('.toggle-primary-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const imageId = this.dataset.imageId;
                togglePrimaryImage(imageId);
            });
        });
        
        // Update alt text
        document.querySelectorAll('.update-alt-text-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const imageId = this.dataset.imageId;
                const altTextInput = document.querySelector(`.alt-text-input[data-image-id="${imageId}"]`);
                updateImageAltText(imageId, altTextInput.value);
            });
        });
    }
    
    function removeImageFromPreview(fileIndex) {
        // Remove the preview card
        const card = document.querySelector(`.image-preview-card[data-file-index="${fileIndex}"]`);
        if (card) {
            card.parentElement.remove();
        }
        
        // Update the file input (this is complex as we can't directly modify FileList)
        // For now, we'll handle this in the form submission by checking which previews exist
    }
    
    function setPrimaryImageInPreview(fileIndex) {
        // Update all primary buttons
        document.querySelectorAll('.primary-image-btn').forEach(btn => {
            const btnIndex = parseInt(btn.dataset.fileIndex);
            if (btnIndex === fileIndex) {
                btn.className = 'btn btn-sm btn-warning primary-image-btn';
            } else {
                btn.className = 'btn btn-sm btn-outline-warning primary-image-btn';
            }
        });
        
        // Update labels
        document.querySelectorAll('.image-preview-card').forEach(card => {
            const cardIndex = parseInt(card.dataset.fileIndex);
            const label = card.querySelector('small');
            if (cardIndex === fileIndex) {
                label.textContent = 'Primary Image';
            } else {
                label.textContent = `Image ${cardIndex + 1}`;
            }
        });
    }
    
    function deleteProductImage(imageId) {
        fetch(`/mb-admin/api/product-images/${imageId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (response.ok) {
                showAlert('Image deleted successfully!', 'success');
                // Reload current images
                const editProductId = document.getElementById('editProductId');
                if (editProductId && editProductId.value) {
                    loadCurrentProductImages(editProductId.value);
                }
            } else {
                showAlert('Failed to delete image.', 'danger');
            }
        })
        .catch(error => {
            console.error('Error deleting image:', error);
            showAlert('Error deleting image.', 'danger');
        });
    }
    
    function togglePrimaryImage(imageId) {
        // Get the current state of the image
        const currentImageCard = document.querySelector(`.current-image-card[data-image-id="${imageId}"]`);
        const toggleBtn = currentImageCard?.querySelector('.toggle-primary-btn');
        const isPrimary = toggleBtn?.classList.contains('btn-warning');
        
        // Toggle the primary state
        const newPrimaryState = !isPrimary;
        
        fetch(`/mb-admin/api/product-images/${imageId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ is_primary: newPrimaryState })
        })
        .then(response => response.json())
        .then(data => {
            if (newPrimaryState) {
                showAlert('Image set as primary!', 'success');
            } else {
                showAlert('Primary status removed!', 'success');
            }
            // Reload current images to reflect the changes
            const editProductId = document.getElementById('editProductId');
            if (editProductId && editProductId.value) {
                loadCurrentProductImages(editProductId.value);
            }
        })
        .catch(error => {
            console.error('Error updating primary image:', error);
            showAlert('Error updating primary image.', 'danger');
        });
    }
    
    function updateImageAltText(imageId, altText) {
        fetch(`/mb-admin/api/product-images/${imageId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ alt_text: altText })
        })
        .then(response => response.json())
        .then(data => {
            showAlert('Alt text updated!', 'success');
        })
        .catch(error => {
            console.error('Error updating alt text:', error);
            showAlert('Error updating alt text.', 'danger');
        });
    }
    
    function handleVariantImagePreview(input, containerId, imgId) {
        const container = document.getElementById(containerId);
        const img = document.getElementById(imgId);
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                img.src = e.target.result;
                container.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        } else {
            container.style.display = 'none';
        }
    }
    
    function generateSlug(text) {
        return text
            .toLowerCase()
            .trim()
            .replace(/[^\w\s-]/g, '') // Remove special characters
            .replace(/[\s_-]+/g, '-') // Replace spaces, underscores, hyphens with single hyphen
            .replace(/^-+|-+$/g, ''); // Remove leading/trailing hyphens
    }
    
    function showAlert(message, type = 'info') {
        const alertContainer = document.createElement('div');
        alertContainer.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertContainer.style.top = '20px';
        alertContainer.style.right = '20px';
        alertContainer.style.zIndex = '9999';
        alertContainer.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertContainer);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alertContainer.parentNode) {
                alertContainer.parentNode.removeChild(alertContainer);
            }
        }, 5000);
    }
    
    // ================================
    // MEDIA LIBRARY FUNCTIONS
    // ================================
    
    function openMediaLibrary(mode = 'add') {
        selectedMediaFiles = [];
        mediaLibraryCallback = mode;
        updateSelectedMediaCount();
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('mediaLibraryModal'));
        modal.show();
        
        // Load media files
        loadMediaFiles(1);
    }
    
    function loadMediaFiles(page = 1) {
        currentMediaPage = page;
        const searchTerm = document.getElementById('mediaSearchInput').value.trim();
        const typeFilter = document.getElementById('mediaTypeFilter').value;
        const directoryFilter = document.getElementById('mediaDirectoryFilter').value;
        
        let url = `/mb-admin/api/media/?page=${page}&per_page=12`;
        
        if (searchTerm) {
            url += `&search=${encodeURIComponent(searchTerm)}`;
        }
        
        if (typeFilter && typeFilter !== 'all') {
            url += `&type=${typeFilter}`;
        }
        
        if (directoryFilter) {
            url += `&directory=${directoryFilter}`;
        }
        
        // Show loading
        document.getElementById('mediaGridContainer').style.display = 'block';
        document.getElementById('mediaGrid').style.display = 'none';
        document.getElementById('mediaGridContainer').innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading media files...</p>
            </div>
        `;
        
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load media files');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    displayMediaFiles(data.files);
                    updateMediaPagination(data);
                    document.getElementById('mediaTotalCount').textContent = data.total || 0;
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error loading media files:', error);
                document.getElementById('mediaGridContainer').innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                        <p>Error loading media files: ${error.message}</p>
                        <button class="btn btn-outline-primary" onclick="loadMediaFiles(${currentMediaPage})">
                            <i class="fas fa-redo me-1"></i> Retry
                        </button>
                    </div>
                `;
            });
    }
    
    function displayMediaFiles(files) {
        const mediaGrid = document.getElementById('mediaGrid');
        const mediaGridContainer = document.getElementById('mediaGridContainer');
        
        mediaGrid.innerHTML = '';
        
        if (!files || files.length === 0) {
            mediaGridContainer.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-images fa-3x text-muted mb-3"></i>
                    <h5>No media files found</h5>
                    <p class="text-muted">Upload some files to get started</p>
                </div>
            `;
            return;
        }
        
        files.forEach(file => {
            const mediaItem = createMediaItem(file);
            mediaGrid.appendChild(mediaItem);
        });
        
        mediaGridContainer.style.display = 'none';
        mediaGrid.style.display = 'flex';
    }
    
    function createMediaItem(file) {
        const col = document.createElement('div');
        col.className = 'col-md-3 col-sm-4 col-6';
        
        const isSelected = selectedMediaFiles.some(f => f.id === file.id);
        
        col.innerHTML = `
            <div class="media-item ${isSelected ? 'selected' : ''}" data-file-id="${file.id}" data-file-url="${file.url}" data-file-name="${file.filename}">
                <div class="media-item-actions">
                    <button type="button" class="media-item-delete" data-file-id="${file.id}" title="Delete file">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                ${file.is_image ? 
                    `<img src="${file.url}" alt="${file.filename}" class="media-item-image" loading="lazy">` :
                    `<div class="media-item-image d-flex align-items-center justify-content-center bg-light">
                        <i class="fas fa-file fa-2x text-muted"></i>
                    </div>`
                }
                <div class="media-item-info">
                    <div class="media-item-filename" title="${file.filename}">${file.filename}</div>
                    <div class="media-item-meta">
                        ${file.size_formatted} • ${file.modified_date_formatted}
                        ${file.dimensions ? ` • ${file.dimensions}` : ''}
                    </div>
                </div>
            </div>
        `;
        
        // Add event listeners
        const mediaItem = col.querySelector('.media-item');
        const deleteBtn = col.querySelector('.media-item-delete');
        
        // Delete button event listener
        deleteBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation(); // Prevent triggering the media item selection
            const fileId = this.dataset.fileId;
            deleteMediaFile(fileId);
        });
        
        // Media item selection event listener
        mediaItem.addEventListener('click', function(e) {
            // Don't trigger selection when clicking delete button
            if (e.target.closest('.media-item-delete')) {
                return;
            }
            
            toggleMediaSelection(file);
        });
        
        return col;
    }
    
    function toggleMediaSelection(file) {
        const existingIndex = selectedMediaFiles.findIndex(f => f.id === file.id);
        
        if (existingIndex > -1) {
            selectedMediaFiles.splice(existingIndex, 1);
        } else {
            selectedMediaFiles.push(file);
        }
        
        // Update UI
        const mediaItem = document.querySelector(`[data-file-id="${file.id}"]`);
        if (mediaItem) {
            mediaItem.classList.toggle('selected');
        }
        
        updateSelectedMediaCount();
    }
    
    function updateSelectedMediaCount() {
        const count = selectedMediaFiles.length;
        document.getElementById('selectedMediaCount').textContent = count;
        document.getElementById('useSelectedMediaBtn').disabled = count === 0;
    }
    
    function updateMediaPagination(data) {
        const pagination = document.getElementById('mediaPagination');
        pagination.innerHTML = '';
        
        if (data.total_pages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentMediaPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentMediaPage - 1}">Previous</a>`;
        pagination.appendChild(prevLi);
        
        // Page numbers
        let startPage = Math.max(1, currentMediaPage - 2);
        let endPage = Math.min(data.total_pages, startPage + 4);
        
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentMediaPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            pagination.appendChild(li);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentMediaPage === data.total_pages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentMediaPage + 1}">Next</a>`;
        pagination.appendChild(nextLi);
        
        // Add event listeners to pagination links
        document.querySelectorAll('#mediaPagination .page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.dataset.page);
                if (page && page !== currentMediaPage) {
                    loadMediaFiles(page);
                }
            });
        });
    }
    
    function uploadMediaFiles() {
        const fileInput = document.getElementById('mediaUploadInput');
        const directory = document.getElementById('mediaUploadDirectory').value;
        const files = Array.from(fileInput.files);
        
        if (files.length === 0) {
            showAlert('Please select files to upload', 'warning');
            return;
        }
        
        const uploadProgress = document.getElementById('uploadProgress');
        const progressBar = uploadProgress.querySelector('.progress-bar');
        
        uploadProgress.style.display = 'block';
        document.getElementById('uploadMediaBtn').disabled = true;
        
        let completed = 0;
        const total = files.length;
        
        // Upload files one by one
        const uploadPromises = files.map(file => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('directory', directory);
            
            return fetch('/mb-admin/api/media/upload/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                completed++;
                const progress = (completed / total) * 100;
                progressBar.style.width = progress + '%';
                
                if (!data.success) {
                    throw new Error(data.message || 'Upload failed');
                }
                
                return data;
            });
        });
        
        Promise.all(uploadPromises)
            .then(results => {
                showAlert(`Successfully uploaded ${results.length} file(s)!`, 'success');
                
                // Clear the file input
                fileInput.value = '';
                
                // Reload media files
                loadMediaFiles(1);
            })
            .catch(error => {
                console.error('Upload error:', error);
                showAlert('Error uploading files: ' + error.message, 'danger');
            })
            .finally(() => {
                uploadProgress.style.display = 'none';
                progressBar.style.width = '0%';
                document.getElementById('uploadMediaBtn').disabled = false;
            });
    }
    
    function deleteMediaFile(fileId) {
        if (!fileId) {
            showAlert('Invalid file ID', 'danger');
            return;
        }
        
        if (!confirm('Are you sure you want to delete this file? This action cannot be undone.')) {
            return;
        }
        
        // Get CSRF token
        const csrfToken = getCookie('csrftoken');
        
        if (!csrfToken) {
            showAlert('CSRF token not found. Please refresh the page and try again.', 'danger');
            return;
        }
        
        fetch(`/mb-admin/api/media/${fileId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('File deleted successfully!', 'success');
                
                // Remove from selected files if it was selected
                selectedMediaFiles = selectedMediaFiles.filter(f => f.id !== fileId);
                updateSelectedMediaCount();
                
                // Reload media files
                loadMediaFiles(currentMediaPage);
            } else {
                showAlert(data.message || 'Failed to delete file', 'danger');
            }
        })
        .catch(error => {
            console.error('Delete error:', error);
            showAlert('Error deleting file: ' + error.message, 'danger');
        });
    }
    
    function useSelectedMedia() {
        if (selectedMediaFiles.length === 0) {
            showAlert('Please select at least one file', 'warning');
            return;
        }
        
        // Process selected files based on the callback mode
        if (mediaLibraryCallback === 'add') {
            // For add product form
            processSelectedFilesForAdd();
        } else if (mediaLibraryCallback === 'edit') {
            // For edit product form
            processSelectedFilesForEdit();
        } else if (mediaLibraryCallback === 'variant') {
            // For add variant form
            processSelectedFilesForVariant();
        } else if (mediaLibraryCallback === 'editVariant') {
            // For edit variant form
            processSelectedFilesForEditVariant();
        }
        
        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('mediaLibraryModal'));
        modal.hide();
        
        // Reset selection
        selectedMediaFiles = [];
        updateSelectedMediaCount();
    }
    
    function processSelectedFilesForAdd() {
        const previewContainer = document.getElementById('imagePreview');
        previewContainer.innerHTML = '';
        previewContainer.style.display = 'block';
        
        selectedMediaFiles.forEach((file, index) => {
            if (file.is_image) {
                const previewCard = createImagePreviewCard(file, index, true);
                previewContainer.appendChild(previewCard);
            }
        });
        
        // Show image management container
        const imageManagementContainer = document.getElementById('imageManagementContainer');
        if (imageManagementContainer) {
            imageManagementContainer.style.display = 'block';
        }
        
        showAlert(`Added ${selectedMediaFiles.length} image(s) from media library!`, 'success');
    }
    
    function processSelectedFilesForEdit() {
        const productId = document.getElementById('editProductId').value;
        
        console.log('processSelectedFilesForEdit called');
        console.log('Product ID:', productId);
        console.log('Selected media files:', selectedMediaFiles);
        
        if (!productId) {
            showAlert('Product ID not found. Please close and reopen the edit modal.', 'danger');
            return;
        }
        
        if (selectedMediaFiles.length === 0) {
            showAlert('No media files selected.', 'warning');
            return;
        }
        
        // Create product images directly from selected media files
        const imagePromises = selectedMediaFiles.map(file => {
            const formData = new FormData();
            formData.append('product', productId);
            formData.append('image_url_input', file.url);
            formData.append('alt_text', file.filename);
            formData.append('is_primary', 'false');
            
            return fetch('/mb-admin/api/product-images/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            });
        });
        
        Promise.all(imagePromises)
            .then(responses => {
                // Check if all responses are successful
                const failedResponses = responses.filter(response => !response.ok);
                if (failedResponses.length > 0) {
                    console.error('Some requests failed:', failedResponses);
                    showAlert(`Failed to add ${failedResponses.length} image(s). Check console for details.`, 'danger');
                }
                
                return Promise.all(responses.map(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        return response.text().then(text => {
                            console.error('Failed response:', response.status, text);
                            throw new Error(`HTTP ${response.status}: ${text}`);
                        });
                    }
                }));
            })
            .then(results => {
                console.log('Successfully created images:', results);
                // Reload current images to show the newly added ones
                loadCurrentProductImages(productId);
                showAlert(`Added ${selectedMediaFiles.length} image(s) from media library!`, 'success');
            })
            .catch(error => {
                console.error('Error adding images:', error);
                showAlert('Failed to add some images. Check console for details.', 'danger');
            });
    }
    
    function processSelectedFilesForVariant() {
        // Only allow one image for variants
        const file = selectedMediaFiles[0];
        if (!file) {
            showAlert('Please select an image for the variant.', 'warning');
            return;
        }
        
        // Show preview and store the URL for when saving the variant
        const previewContainer = document.getElementById('variantImagePreview');
        const previewImg = document.getElementById('variantImagePreviewImg');
        
        previewImg.src = file.url;
        previewContainer.style.display = 'block';
        
        // Store the selected file URL in a data attribute for later use
        previewContainer.dataset.selectedImageUrl = file.url;
        previewContainer.dataset.selectedImageAlt = file.filename;
        
        showAlert('Variant image selected from media library!', 'success');
    }
    
    function processSelectedFilesForEditVariant() {
        console.log('processSelectedFilesForEditVariant called with files:', selectedMediaFiles);
        
        // Only allow one image for variants
        const file = selectedMediaFiles[0];
        if (!file) {
            showAlert('Please select an image for the variant.', 'warning');
            return;
        }
        
        // Show preview and store the URL for when updating the variant
        const previewContainer = document.getElementById('editVariantImagePreview');
        const previewImg = document.getElementById('editVariantImagePreviewImg');
        
        previewImg.src = file.url;
        previewContainer.style.display = 'block';
        
        // Store the selected file URL in a data attribute for later use
        previewContainer.dataset.selectedImageUrl = file.url;
        previewContainer.dataset.selectedImageAlt = file.filename;
        
        console.log('Preview set with URL:', file.url);
        showAlert('Variant image selected from media library!', 'success');
    }
    
    function createImagePreviewCard(file, index, isAdd = true) {
        const col = document.createElement('div');
        col.className = 'col-6 col-md-4 col-lg-3';
        col.dataset.fileIndex = index;
        col.dataset.mediaFile = JSON.stringify(file);
        
        col.innerHTML = `
            <div class="card image-preview-card">
                <div class="position-relative">
                    <img src="${file.url}" class="card-img-top" style="height: 100px; object-fit: cover;" alt="${file.filename}">
                    <div class="position-absolute top-0 end-0 p-1">
                        <button type="button" class="btn btn-sm btn-danger remove-image-btn" data-file-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="position-absolute top-0 start-0 p-1">
                        <button type="button" class="btn btn-sm ${index === 0 ? 'btn-warning' : 'btn-outline-warning'} primary-image-btn" data-file-index="${index}" title="Set as primary">
                            <i class="fas fa-star"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-2">
                    <small class="text-muted">${index === 0 ? 'Primary Image' : `Image ${index + 1}`}</small>
                    <div class="mb-2">
                        <small class="text-muted">${file.size_formatted || 'Unknown size'}</small>
                    </div>
                    <div class="mb-2">
                        <input type="text" class="form-control form-control-sm" placeholder="Alt text" value="${file.filename}" data-file-index="${index}" maxlength="200">
                    </div>
                </div>
            </div>
        `;
        
        // Add event listeners
        const primaryBtn = col.querySelector('.primary-image-btn');
        const removeBtn = col.querySelector('.remove-image-btn');
        
        primaryBtn.addEventListener('click', function() {
            // Remove primary status from all other images
            const allPrimaryBtns = document.querySelectorAll('.primary-image-btn');
            allPrimaryBtns.forEach(btn => {
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-outline-warning');
            });
            
            // Set this as primary
            this.classList.remove('btn-outline-warning');
            this.classList.add('btn-warning');
        });
        
        removeBtn.addEventListener('click', function() {
            col.remove();
            
            // If this was the primary image and there are other images, make the first one primary
            if (primaryBtn.classList.contains('btn-warning')) {
                const remainingCards = document.querySelectorAll('.image-preview-card');
                if (remainingCards.length > 0) {
                    const firstPrimaryBtn = remainingCards[0].querySelector('.primary-image-btn');
                    firstPrimaryBtn.classList.remove('btn-outline-warning');
                    firstPrimaryBtn.classList.add('btn-warning');
                }
            }
        });
        
        return col;
    }
    
    // TinyMCE initialization function
    function initializeTinyMCE(textareaId) {
        console.log('Initializing TinyMCE for:', textareaId);
        
        // Check if TinyMCE is loaded
        if (typeof tinymce === 'undefined') {
            console.error('TinyMCE not loaded');
            return false;
        }
        
        // Check if textarea exists
        const textarea = document.getElementById(textareaId);
        if (!textarea) {
            console.error('Textarea not found:', textareaId);
            return false;
        }
        
        // Remove existing instance if it exists
        const existingEditor = tinymce.get(textareaId);
        if (existingEditor) {
            console.log('Removing existing TinyMCE instance for:', textareaId);
            existingEditor.remove();
        }
        
        try {
            // Initialize TinyMCE with premium features
            tinymce.init({
                selector: '#' + textareaId,
                height: 500,
                
                // Core editing features + Premium features
                plugins: [
                    // Core editing features
                    'anchor', 'autolink', 'charmap', 'codesample', 'emoticons', 'link', 'lists', 
                    'media', 'searchreplace', 'table', 'visualblocks', 'wordcount', 'code', 'fullscreen',
                    'image', 'insertdatetime', 'preview', 'help',
                    
                    // Premium features (trial until Nov 13, 2025)
                    'checklist', 'mediaembed', 'casechange', 'formatpainter', 'pageembed', 
                    'a11ychecker', 'tinymcespellchecker', 'permanentpen', 'powerpaste', 
                    'advtable', 'advcode', 'advtemplate', 'ai', 'mentions', 
                    'tinycomments', 'tableofcontents', 'footnotes', 'mergetags', 
                    'autocorrect', 'typography', 'inlinecss', 'markdown', 
                    'importword', 'exportword', 'exportpdf'
                ],
                
                toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | ' +
                    'link image media table mergetags | addcomment showcomments | ' +
                    'spellcheckdialog a11ycheck typography | align lineheight | ' +
                    'checklist numlist bullist indent outdent | emoticons charmap | ' +
                    'codesample code | preview fullscreen | removeformat help',
                
                menubar: 'file edit view insert format tools table help',
                
                // Comments configuration
                tinycomments_mode: 'embedded',
                tinycomments_author: 'Admin',
                
                // Merge tags for dynamic content
                mergetags_list: [
                    { value: 'product.name', title: 'Product Name' },
                    { value: 'product.price', title: 'Product Price' },
                    { value: 'product.sku', title: 'Product SKU' },
                    { value: 'category.name', title: 'Category Name' },
                ],
                
                // AI Assistant configuration (placeholder - requires backend implementation)
                ai_request: (request, respondWith) => respondWith.string(() => 
                    Promise.reject('AI Assistant requires backend implementation')
                ),
                
                // Content styling
                content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; line-height: 1.6; }',
                
                // Branding
                branding: false,
                promotion: false,
                
                // URL handling
                relative_urls: false,
                remove_script_host: false,
                convert_urls: true,
                
                // Image upload handler
                images_upload_handler: function (blobInfo, success, failure) {
                    const formData = new FormData();
                    formData.append('file', blobInfo.blob(), blobInfo.filename());
                    
                    fetch('/mb-admin/api/media/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.file) {
                            success(data.file);
                        } else {
                            failure('Failed to upload image');
                        }
                    })
                    .catch(error => {
                        failure('Error uploading image: ' + error);
                    });
                },
                
                // Font options
                font_family_formats: 'Arial=arial,helvetica,sans-serif; Courier New=courier new,courier,monospace; Georgia=georgia,palatino; Tahoma=tahoma,arial,helvetica,sans-serif; Times New Roman=times new roman,times; Verdana=verdana,geneva',
                
                font_size_formats: '8pt 10pt 12pt 14pt 16pt 18pt 24pt 36pt 48pt',
                
                // Advanced table features
                table_toolbar: 'tableprops tabledelete | tableinsertrowbefore tableinsertrowafter tabledeleterow | tableinsertcolbefore tableinsertcolafter tabledeletecol',
                
                table_class_list: [
                    { title: 'None', value: '' },
                    { title: 'Table Bordered', value: 'table table-bordered' },
                    { title: 'Table Striped', value: 'table table-striped' },
                    { title: 'Table Hover', value: 'table table-hover' },
                ],
                
                // Setup callback
                setup: function(editor) {
                    editor.on('init', function() {
                        console.log('TinyMCE editor initialized:', textareaId);
                        if (textareaId === 'productDescription') {
                            productDescriptionEditor = editor;
                        } else if (textareaId === 'editProductDescription') {
                            editProductDescriptionEditor = editor;
                        }
                    });
                    
                    editor.on('change', function() {
                        editor.save(); // Save content back to textarea
                    });
                }
            });
            
            console.log('TinyMCE initialization started for:', textareaId);
            return true;
        } catch (error) {
            console.error('Error initializing TinyMCE:', error);
            return false;
        }
    }
    
    // TinyMCE destroy function
    function destroyTinyMCE(textareaId) {
        console.log('Destroying TinyMCE for:', textareaId);
        const editor = tinymce.get(textareaId);
        if (editor) {
            editor.remove();
            console.log('TinyMCE removed for:', textareaId);
        }
        
        // Clear references
        if (textareaId === 'productDescription') {
            productDescriptionEditor = null;
        } else if (textareaId === 'editProductDescription') {
            editProductDescriptionEditor = null;
        }
    }
});
</script>
{% endblock %}