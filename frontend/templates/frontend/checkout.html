{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}Checkout - Professional eCommerce{% endblock %}

{% block content %}
    <div class="container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <a href="{% url 'frontend:home' %}">Home</a>
            <span class="breadcrumb-separator">/</span>
            <a href="{% url 'frontend:cart' %}">Cart</a>
            <span class="breadcrumb-separator">/</span>
            <span class="current">Checkout</span>
        </nav>

        <div class="checkout-page">
            <div class="page-header">
                <h1 class="page-title">Checkout</h1>
                <p class="page-subtitle">Complete your order</p>
            </div>

            <form class="checkout-form" id="checkout-form">
                <div class="checkout-grid">
                    <!-- Checkout Form Section -->
                    <div class="checkout-form-section">
                        <!-- Customer Information -->
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-user"></i>
                                Customer Information
                            </h2>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="full_name">Full Name</label>
                                    <input type="text" id="full_name" name="full_name">
                                    <div class="field-error" id="full_name_error"></div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group half">
                                    <label for="email">Email Address</label>
                                    <input type="email" id="email" name="email">
                                    <div class="field-error" id="email_error"></div>
                                </div>
                                <div class="form-group half">
                                    <label for="phone_number">Phone Number *</label>
                                    <input type="tel" id="phone_number" name="phone_number" required>
                                    <div class="field-error" id="phone_number_error"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Shipping Information -->
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-shipping-fast"></i>
                                Shipping Address
                            </h2>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="address">Street Address</label>
                                    <textarea id="address" name="address" rows="3" placeholder="123 Main Street&#10;Apt 4B"></textarea>
                                    <div class="field-error" id="address_error"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Order Instructions -->
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-clipboard-list"></i>
                                Order Instructions
                            </h2>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="order_instruction">Special Instructions (Optional)</label>
                                    <textarea id="order_instruction" name="order_instruction" rows="4" 
                                              placeholder="Any special delivery instructions, gift messages, or notes for your order..."></textarea>
                                    <small class="help-text">Maximum 500 characters</small>
                                </div>
                            </div>
                        </div>

                        <!-- Shipping Method -->
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-truck"></i>
                                Shipping Method
                            </h2>
                            
                            <div class="shipping-options">
                                <div class="shipping-option">
                                    <input type="radio" id="standard_shipping" name="shipping_method" value="standard" checked>
                                    <label for="standard_shipping">
                                        <div class="shipping-info">
                                            <div class="shipping-name">Standard Shipping</div>
                                            <div class="shipping-description">2-3 business days</div>
                                        </div>
                                        <div class="shipping-price">FREE</div>
                                    </label>
                                </div>
                                
                                <div class="shipping-option">
                                    <input type="radio" id="express_shipping" name="shipping_method" value="express">
                                    <label for="express_shipping">
                                        <div class="shipping-info">
                                            <div class="shipping-name">Express Shipping (same Day)</div>
                                            <div class="shipping-description">Only Dhaka City</div>
                                        </div>
                                        <div class="shipping-price">$9.99</div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-credit-card"></i>
                                Payment Method
                            </h2>
                            
                            <div class="payment-options">
                                <div class="payment-option">
                                    <input type="radio" id="cod" name="payment_method" value="cod" checked>
                                    <label for="cod">
                                        <i class="fas fa-money-bill-wave"></i>
                                        Cash on Delivery
                                    </label>
                                </div>
                                
                                <div class="payment-option">
                                    <input type="radio" id="bkash" name="payment_method" value="bkash">
                                    <label for="bkash">
                                        <i class="fas fa-mobile-alt"></i>
                                        bKash
                                    </label>
                                </div>
                                
                                <div class="payment-option">
                                    <input type="radio" id="nagad" name="payment_method" value="nagad">
                                    <label for="nagad">
                                        <i class="fas fa-wallet"></i>
                                        Nagad
                                    </label>
                                </div>
                            </div>

                            <!-- bKash Form -->
                            <div class="payment-form" id="bkash-form" style="display: none;">
                                <div class="payment-method-info">
                                    <div class="info-header">
                                        <i class="fas fa-mobile-alt"></i>
                                        <h4>bKash Payment</h4>
                                    </div>
                                    <div class="payment-instructions">
                                        <p><strong>Follow these steps:</strong></p>
                                        <ol>
                                            <li>Go to your bKash Mobile Menu by dialing *247#</li>
                                            <li>Choose "Send Money"</li>
                                            <li>Enter Merchant bKash Account Number: <strong>01XXXXXXXXX</strong></li>
                                            <li>Enter the total amount: <strong id="bkash-amount">$0.00</strong></li>
                                            <li>Enter a reference: Your phone number</li>
                                            <li>Now enter your bKash Mobile Menu PIN and confirm</li>
                                        </ol>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="bkash_transaction_id">bKash Transaction ID *</label>
                                        <input type="text" id="bkash_transaction_id" name="bkash_transaction_id" placeholder="Enter transaction ID after payment">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="bkash_sender_number">Sender Mobile Number *</label>
                                        <input type="tel" id="bkash_sender_number" name="bkash_sender_number" placeholder="01XXXXXXXXX">
                                    </div>
                                </div>
                            </div>

                            <!-- Nagad Form -->
                            <div class="payment-form" id="nagad-form" style="display: none;">
                                <div class="payment-method-info">
                                    <div class="info-header">
                                        <i class="fas fa-wallet"></i>
                                        <h4>Nagad Payment</h4>
                                    </div>
                                    <div class="payment-instructions">
                                        <p><strong>Follow these steps:</strong></p>
                                        <ol>
                                            <li>Go to your Nagad Mobile Menu by dialing *167#</li>
                                            <li>Choose "Send Money"</li>
                                            <li>Enter Merchant Nagad Account Number: <strong>01XXXXXXXXX</strong></li>
                                            <li>Enter the total amount: <strong id="nagad-amount">$0.00</strong></li>
                                            <li>Enter a reference: Your phone number</li>
                                            <li>Now enter your Nagad PIN and confirm</li>
                                        </ol>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="nagad_transaction_id">Nagad Transaction ID *</label>
                                        <input type="text" id="nagad_transaction_id" name="nagad_transaction_id" placeholder="Enter transaction ID after payment">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="nagad_sender_number">Sender Mobile Number *</label>
                                        <input type="tel" id="nagad_sender_number" name="nagad_sender_number" placeholder="01XXXXXXXXX">
                                    </div>
                                </div>
                            </div>

                            <!-- COD Form -->
                            <div class="payment-form" id="cod-form">
                                <div class="payment-method-info">
                                    <div class="info-header">
                                        <i class="fas fa-money-bill-wave"></i>
                                        <h4>Cash on Delivery</h4>
                                    </div>
                                    <div class="payment-instructions">
                                        <p><strong>Payment Information:</strong></p>
                                        <ul>
                                            <li>Pay cash when you receive your order</li>
                                            <li>Make sure to have exact amount ready</li>
                                            <li>Our delivery person will collect the payment</li>
                                            <li>You can inspect the product before payment</li>
                                        </ul>
                                        <div class="cod-total">
                                            <strong>Total Amount to Pay: <span id="cod-amount">$0.00</span></strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary Section -->
                    <div class="order-summary-section">
                        <div class="order-summary">
                            <h3>Order Summary</h3>
                            
                            <div class="order-items" id="order-items">
                                <!-- Items will be populated here -->
                                <div class="summary-loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    Loading order items...
                                </div>
                            </div>
                            
                            <div class="order-totals">
                                <div class="total-line">
                                    <span>Subtotal:</span>
                                    <span id="order-subtotal">$0.00</span>
                                </div>
                                
                                <div class="total-line">
                                    <span>Shipping:</span>
                                    <span id="order-shipping">$0.00</span>
                                </div>
                                
                                <div class="total-line">
                                    <span>Tax:</span>
                                    <span id="order-tax">$0.00</span>
                                </div>
                                
                                <div class="total-divider"></div>
                                
                                <div class="total-line grand-total">
                                    <span>Total:</span>
                                    <span id="order-total">$0.00</span>
                                </div>
                            </div>
                            
                            <div class="checkout-actions">
                                <button type="submit" class="place-order-btn" id="place-order-btn">
                                    <i class="fas fa-lock"></i>
                                    Place Order
                                </button>
                                
                                <div class="security-badges">
                                    <div class="security-badge">
                                        <i class="fas fa-shield-alt"></i>
                                        <span>SSL Secured</span>
                                    </div>
                                    <div class="security-badge">
                                        <i class="fas fa-lock"></i>
                                        <span>Safe Checkout</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Trust Badges -->
                        <div class="trust-badges">
                            <h4>Why shop with us?</h4>
                            <div class="trust-item">
                                <i class="fas fa-shipping-fast"></i>
                                <div>
                                    <strong>Fast Shipping</strong>
                                    <p>Free shipping on orders over $50</p>
                                </div>
                            </div>
                            <div class="trust-item">
                                <i class="fas fa-undo"></i>
                                <div>
                                    <strong>Easy Returns</strong>
                                    <p>30-day return policy</p>
                                </div>
                            </div>
                            <div class="trust-item">
                                <i class="fas fa-headset"></i>
                                <div>
                                    <strong>24/7 Support</strong>
                                    <p>Customer service available</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
<style>
    /* Page Layout */
    .checkout-page {
        padding: 2rem 0;
        min-height: 80vh;
    }

    .page-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .page-title {
        font-size: 3rem;
        font-weight: 300;
        color: var(--dark-color);
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        color: var(--secondary-color);
        font-size: 1.2rem;
    }

    /* Checkout Grid */
    .checkout-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 3rem;
        align-items: start;
    }

    /* Form Section */
    .checkout-form-section {
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 2rem;
    }

    .form-section {
        margin-bottom: 3rem;
        padding-bottom: 2rem;
        border-bottom: 2px solid var(--border-color);
    }

    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 1.5rem;
    }

    .section-title i {
        color: var(--primary-color);
        font-size: 1.25rem;
    }

    /* Form Elements */
    .form-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .form-group {
        flex: 1;
        position: relative;
    }

    .form-group.half {
        flex: 0.5;
    }

    .form-group.quarter {
        flex: 0.25;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--dark-color);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.875rem;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: 1rem;
        transition: var(--transition);
        background: var(--white);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .form-group textarea {
        resize: vertical;
        font-family: inherit;
    }

    .help-text {
        color: var(--secondary-color);
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: block;
    }

    .field-error {
        color: var(--danger-color);
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: none;
    }

    /* Shipping Options */
    .shipping-options {
        display: grid;
        gap: 1rem;
    }

    .shipping-option {
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        transition: var(--transition);
        overflow: hidden;
    }

    .shipping-option:hover {
        border-color: var(--primary-color);
    }

    .shipping-option input[type="radio"] {
        display: none;
    }

    .shipping-option input[type="radio"]:checked + label {
        background: var(--light-color);
        border-left: 4px solid var(--primary-color);
    }

    .shipping-option label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.25rem;
        cursor: pointer;
        transition: var(--transition);
    }

    .shipping-info .shipping-name {
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 0.25rem;
    }

    .shipping-info .shipping-description {
        color: var(--secondary-color);
        font-size: 0.9rem;
    }

    .shipping-price {
        font-weight: bold;
        color: var(--primary-color);
        font-size: 1.1rem;
    }

    /* Payment Options */
    .payment-options {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .payment-option {
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        transition: var(--transition);
        text-align: center;
    }

    .payment-option:hover {
        border-color: var(--primary-color);
    }

    .payment-option input[type="radio"] {
        display: none;
    }

    .payment-option input[type="radio"]:checked + label {
        background: var(--primary-color);
        color: var(--white);
    }

    .payment-option label {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem;
        cursor: pointer;
        transition: var(--transition);
        font-weight: 600;
    }

    .payment-option label i {
        font-size: 1.5rem;
    }

    /* Credit Card Form */
    .credit-card-form,
    .payment-form {
        margin-top: 2rem;
        padding: 2rem;
        background: var(--light-color);
        border-radius: var(--border-radius);
    }

    .payment-method-info {
        margin-bottom: 1.5rem;
    }

    .info-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .info-header i {
        font-size: 1.5rem;
        color: var(--primary-color);
    }

    .info-header h4 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--dark-color);
        margin: 0;
    }

    .payment-instructions {
        background: var(--white);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        border-left: 4px solid var(--primary-color);
    }

    .payment-instructions p {
        margin-bottom: 1rem;
        color: var(--dark-color);
    }

    .payment-instructions ol,
    .payment-instructions ul {
        margin: 0;
        padding-left: 1.5rem;
    }

    .payment-instructions li {
        margin-bottom: 0.5rem;
        color: var(--secondary-color);
        line-height: 1.5;
    }

    .payment-instructions strong {
        color: var(--primary-color);
    }

    .cod-total {
        margin-top: 1rem;
        padding: 1rem;
        background: var(--success-color);
        color: var(--white);
        border-radius: var(--border-radius);
        text-align: center;
        font-size: 1.1rem;
    }

    .card-types {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        gap: 0.25rem;
    }

    .card-types i {
        font-size: 1.25rem;
        color: var(--secondary-color);
        opacity: 0.6;
    }

    .cvv-help {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--secondary-color);
        cursor: help;
    }

    /* Order Summary */
    .order-summary-section {
        position: sticky;
        top: 2rem;
    }

    .order-summary {
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .order-summary h3 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 1.5rem;
        text-align: center;
    }

    .summary-loading {
        text-align: center;
        padding: 2rem;
        color: var(--secondary-color);
    }

    .summary-loading i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        display: block;
    }

    /* Order Items */
    .order-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem 0;
        border-bottom: 1px solid var(--border-color);
    }

    .order-item:last-child {
        border-bottom: none;
    }

    .item-thumbnail {
        width: 60px;
        height: 60px;
        border-radius: var(--border-radius);
        overflow: hidden;
        background: var(--light-color);
        flex-shrink: 0;
    }

    .item-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .item-info {
        flex: 1;
    }

    .item-name {
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
    }

    .item-variant {
        color: var(--secondary-color);
        font-size: 0.8rem;
    }

    .item-quantity {
        background: var(--light-color);
        padding: 0.25rem 0.5rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--dark-color);
    }

    .item-price {
        font-weight: bold;
        color: var(--primary-color);
    }

    /* Order Totals */
    .order-totals {
        margin-top: 1.5rem;
    }

    .total-line {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        font-size: 1rem;
    }

    .total-line.grand-total {
        font-size: 1.3rem;
        font-weight: bold;
        color: var(--primary-color);
    }

    .total-divider {
        height: 2px;
        background: var(--border-color);
        margin: 1rem 0;
    }

    /* Checkout Actions */
    .checkout-actions {
        margin-top: 2rem;
    }

    .place-order-btn {
        width: 100%;
        background: var(--success-color);
        color: var(--white);
        border: none;
        padding: 1.25rem 2rem;
        border-radius: var(--border-radius);
        font-size: 1.2rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .place-order-btn:hover {
        background: #218838;
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .place-order-btn:disabled {
        background: var(--secondary-color);
        cursor: not-allowed;
        transform: none;
    }

    .security-badges {
        display: flex;
        justify-content: center;
        gap: 1rem;
    }

    .security-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--secondary-color);
        font-size: 0.9rem;
    }

    .security-badge i {
        color: var(--success-color);
    }

    /* Trust Badges */
    .trust-badges {
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 1.5rem;
    }

    .trust-badges h4 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 1rem;
        text-align: center;
    }

    .trust-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .trust-item:last-child {
        margin-bottom: 0;
    }

    .trust-item i {
        font-size: 1.5rem;
        color: var(--primary-color);
        width: 30px;
        text-align: center;
    }

    .trust-item strong {
        display: block;
        color: var(--dark-color);
        margin-bottom: 0.25rem;
    }

    .trust-item p {
        color: var(--secondary-color);
        font-size: 0.9rem;
        margin: 0;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .checkout-grid {
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .order-summary-section {
            position: static;
        }

        .form-row {
            flex-direction: column;
        }

        .form-group.half,
        .form-group.quarter {
            flex: 1;
        }

        .payment-options {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .page-title {
            font-size: 2rem;
        }

        .checkout-form-section,
        .order-summary {
            padding: 1.5rem;
        }

        .section-title {
            font-size: 1.25rem;
        }

        .shipping-option label {
            flex-direction: column;
            text-align: center;
            gap: 0.5rem;
        }
    }

    @media (max-width: 480px) {
        .checkout-form-section,
        .order-summary,
        .trust-badges {
            padding: 1rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem;
        }

        .place-order-btn {
            padding: 1rem;
            font-size: 1.1rem;
        }

        .security-badges {
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadOrderSummary();
        setupFormValidation();
        setupPaymentMethodToggle();
        
        // Load order summary
        function loadOrderSummary() {
            fetch('/api/v1/cart/', {
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(cartData => {
                displayOrderItems(cartData.items || []);
                updateOrderTotals(cartData);
            })
            .catch(error => {
                console.error('Error loading cart:', error);
                document.getElementById('order-items').innerHTML = `
                    <div style="text-align: center; color: var(--danger-color); padding: 2rem;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading cart items</p>
                    </div>
                `;
            });
        }
        
        function displayOrderItems(items) {
            const orderItemsContainer = document.getElementById('order-items');
            
            if (items.length === 0) {
                orderItemsContainer.innerHTML = `
                    <div style="text-align: center; color: var(--secondary-color); padding: 2rem;">
                        <p>No items in cart</p>
                        <a href="/" style="color: var(--primary-color);">Continue Shopping</a>
                    </div>
                `;
                return;
            }
            
            orderItemsContainer.innerHTML = items.map(item => {
                // Use flattened fields first, fall back to nested structure
                const productName = item.product_name || (item.product ? item.product.name : 'Unknown Product');
                const productImage = item.product_image || (item.product ? item.product.primary_image : null) || '/media/default.webp';
                
                // Extract variant information - use flattened fields first
                const variantName = item.variant_name || (item.variant ? item.variant.name : null);
                const variantColor = item.variant_color || (item.variant ? item.variant.color : null);
                const variantSize = item.variant_size || (item.variant ? item.variant.size : null);
                
                // Build variant display string
                let variantDisplay = '';
                if (variantName) {
                    variantDisplay = variantName;
                } else if (variantColor || variantSize) {
                    const parts = [];
                    if (variantColor) parts.push(variantColor);
                    if (variantSize) parts.push(variantSize);
                    variantDisplay = parts.join(', ');
                }
                
                return `
                    <div class="order-item">
                        <div class="item-thumbnail">
                            <img src="${productImage}" alt="${productName}" onerror="this.src='/media/default.webp'">
                        </div>
                        <div class="item-info">
                            <div class="item-name">${productName}</div>
                            ${variantDisplay ? `<div class="item-variant">${variantDisplay}</div>` : ''}
                        </div>
                        <div class="item-quantity">Ã—${item.quantity}</div>
                        <div class="item-price">$${item.total_price}</div>
                    </div>
                `;
            }).join('');
        }
        
        function updateOrderTotals(cartData) {
            const subtotal = parseFloat(cartData.subtotal || 0);
            const shippingMethod = document.querySelector('input[name="shipping_method"]:checked');
            let shipping = 0;
            
            if (shippingMethod) {
                switch(shippingMethod.value) {
                    case 'express': shipping = 9.99; break;
                    default: shipping = subtotal > 50 ? 0 : 9.99;
                }
            }
            
            const tax = parseFloat(cartData.tax || 0);
            const total = subtotal + shipping + tax;
            
            document.getElementById('order-subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('order-shipping').textContent = shipping === 0 ? 'FREE' : `$${shipping.toFixed(2)}`;
            document.getElementById('order-tax').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('order-total').textContent = `$${total.toFixed(2)}`;
            
            // Update payment amounts
            updatePaymentAmount();
        }
        
        // Update totals when shipping method changes
        document.querySelectorAll('input[name="shipping_method"]').forEach(radio => {
            radio.addEventListener('change', () => {
                loadOrderSummary(); // Reload to recalculate shipping
            });
        });
        
        // Payment method toggle
        function setupPaymentMethodToggle() {
            const paymentMethods = document.querySelectorAll('input[name="payment_method"]');
            const bkashForm = document.getElementById('bkash-form');
            const nagadForm = document.getElementById('nagad-form');
            const codForm = document.getElementById('cod-form');
            
            paymentMethods.forEach(method => {
                method.addEventListener('change', function() {
                    // Hide all payment forms
                    bkashForm.style.display = 'none';
                    nagadForm.style.display = 'none';
                    codForm.style.display = 'none';
                    
                    // Show the selected payment form
                    switch(this.value) {
                        case 'bkash':
                            bkashForm.style.display = 'block';
                            updatePaymentAmount();
                            break;
                        case 'nagad':
                            nagadForm.style.display = 'block';
                            updatePaymentAmount();
                            break;
                        case 'cod':
                            codForm.style.display = 'block';
                            updatePaymentAmount();
                            break;
                    }
                });
            });
        }
        
        // Update payment amount in forms
        function updatePaymentAmount() {
            const totalElement = document.getElementById('order-total');
            const total = totalElement ? totalElement.textContent : '$0.00';
            
            const bkashAmount = document.getElementById('bkash-amount');
            const nagadAmount = document.getElementById('nagad-amount');
            const codAmount = document.getElementById('cod-amount');
            
            if (bkashAmount) bkashAmount.textContent = total;
            if (nagadAmount) nagadAmount.textContent = total;
            if (codAmount) codAmount.textContent = total;
        }
        
        // Form validation
        function setupFormValidation() {
            const form = document.getElementById('checkout-form');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (validateForm()) {
                    processOrder();
                }
            });
        }
        
        function validateForm() {
            let isValid = true;
            
            // Required fields
            const requiredFields = [
                'phone_number'
            ];
            
            requiredFields.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                const errorElement = document.getElementById(fieldName + '_error');
                
                if (field && !field.value.trim()) {
                    showFieldError(field, errorElement, 'This field is required');
                    isValid = false;
                } else if (field && errorElement) {
                    hideFieldError(field, errorElement);
                }
            });
            
            // Email validation
            const emailField = document.getElementById('email');
            const emailError = document.getElementById('email_error');
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (emailField && emailField.value && !emailPattern.test(emailField.value)) {
                showFieldError(emailField, emailError, 'Please enter a valid email address');
                isValid = false;
            }
            
            // Payment method validation
            const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
            if (paymentMethod) {
                switch(paymentMethod.value) {
                    case 'bkash':
                        const bkashFields = ['bkash_transaction_id', 'bkash_sender_number'];
                        
                        bkashFields.forEach(fieldName => {
                            const field = document.getElementById(fieldName);
                            if (field && !field.value.trim()) {
                                field.style.borderColor = 'var(--danger-color)';
                                isValid = false;
                            } else if (field) {
                                field.style.borderColor = 'var(--border-color)';
                            }
                        });
                        break;
                        
                    case 'nagad':
                        const nagadFields = ['nagad_transaction_id', 'nagad_sender_number'];
                        
                        nagadFields.forEach(fieldName => {
                            const field = document.getElementById(fieldName);
                            if (field && !field.value.trim()) {
                                field.style.borderColor = 'var(--danger-color)';
                                isValid = false;
                            } else if (field) {
                                field.style.borderColor = 'var(--border-color)';
                            }
                        });
                        break;
                        
                    case 'cod':
                        // No additional validation needed for COD
                        break;
                }
            }
            
            return isValid;
        }
        
        function showFieldError(field, errorElement, message) {
            if (field) field.style.borderColor = 'var(--danger-color)';
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }
        
        function hideFieldError(field, errorElement) {
            if (field) field.style.borderColor = 'var(--border-color)';
            if (errorElement) errorElement.style.display = 'none';
        }
        
        function processOrder() {
            const placeOrderBtn = document.getElementById('place-order-btn');
            const originalText = placeOrderBtn.innerHTML;
            placeOrderBtn.disabled = true;
            placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            // Collect form data
            const formData = new FormData(document.getElementById('checkout-form'));
            
            // Prepare order data in the expected format for CreateOrderSerializer
            const orderData = {
                shipping_address: {
                    first_name: formData.get('full_name') ? formData.get('full_name').split(' ')[0] || 'Customer' : 'Customer',
                    last_name: formData.get('full_name') ? formData.get('full_name').split(' ').slice(1).join(' ') || 'Name' : 'Name',
                    company: '',
                    address_line_1: formData.get('address') || 'Address not provided',
                    address_line_2: '',
                    city: 'Dhaka',
                    state: 'Dhaka',
                    postal_code: '1000',
                    country: 'Bangladesh',
                    phone: formData.get('phone_number') || '',
                    email: formData.get('email') || '',
                    delivery_instructions: formData.get('order_instruction') || ''
                },
                customer_notes: formData.get('order_instruction') || '',
                coupon_code: ''
            };
            
            console.log('Order data being sent:', orderData);
            
            // Create order via API
            fetch('/api/v1/orders/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Order creation response:', data);
                
                if (data.error || data.errors) {
                    let errorMessage = data.error || data.detail || 'Please check your information and try again.';
                    
                    // If there are detailed validation errors, show them
                    if (data.errors) {
                        console.log('Validation errors:', data.errors);
                        if (typeof data.errors === 'object') {
                            const errorDetails = [];
                            for (const [field, errors] of Object.entries(data.errors)) {
                                if (Array.isArray(errors)) {
                                    errorDetails.push(`${field}: ${errors.join(', ')}`);
                                } else {
                                    errorDetails.push(`${field}: ${errors}`);
                                }
                            }
                            errorMessage += '<br>' + errorDetails.join('<br>');
                        }
                    }
                    
                    // Check if it's an authentication error
                    if (errorMessage.includes('Authentication required') || errorMessage.includes('unauthorized')) {
                        showNotification('Please log in to place an order', 'error');
                        setTimeout(() => {
                            window.location.href = '/login/?next=/checkout/';
                        }, 2000);
                        return;
                    }
                    
                    showNotification('Order failed: ' + errorMessage, 'error');
                    console.error('Order errors:', data);
                } else if (data.order && data.order.order_number) {
                    console.log('Order created successfully:', data.order.order_number);
                    // Success - clear cart and redirect to order confirmation
                    showNotification('Order placed successfully!', 'success');
                    
                    // Clear the cart
                    fetch('/api/v1/cart/clear/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    }).then(() => {
                        setTimeout(() => {
                            window.location.href = `/orders/${data.order.order_number}/`;
                        }, 1500);
                    });
                } else {
                    console.log('Unexpected response structure:', data);
                    showNotification('Order created but confirmation failed. Please check your orders.', 'warning');
                    setTimeout(() => {
                        window.location.href = '/orders/';
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error processing order:', error);
                showNotification('Error processing order. Please try again.', 'error');
            })
            .finally(() => {
                placeOrderBtn.disabled = false;
                placeOrderBtn.innerHTML = originalText;
            });
        }
        
        // Utility functions
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <div>${message}</div>
            `;
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : '#dc3545'};
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                display: flex;
                align-items: flex-start;
                gap: 10px;
                font-weight: 600;
                animation: slideIn 0.3s ease;
                max-width: 400px;
                word-wrap: break-word;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000); // Show for 5 seconds for error messages
        }
    });
</script>
{% endblock %}
