{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}Checkout - Professional eCommerce{% endblock %}

{% block content %}
    <div class="container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <a href="{% url 'frontend:home' %}">Home</a>
            <span class="breadcrumb-separator">/</span>
            <a href="{% url 'frontend:cart' %}">Cart</a>
            <span class="breadcrumb-separator">/</span>
            <span class="current">Checkout</span>
        </nav>

        <div class="checkout-page">
            <div class="page-header">
                <h1 class="page-title">Checkout</h1>
                <p class="page-subtitle">Complete your order</p>
            </div>

            <form class="checkout-form" id="checkout-form">
                <div class="checkout-grid">
                    <!-- Checkout Form Section -->
                    <div class="checkout-form-section">
                        <!-- Customer Information -->
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-user"></i>
                                Customer Information
                            </h2>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="full_name">Full Name *</label>
                                    <input type="text" id="full_name" name="full_name" required>
                                    <div class="field-error" id="full_name_error"></div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group half">
                                    <label for="email">Email Address *</label>
                                    <input type="email" id="email" name="email" required>
                                    <div class="field-error" id="email_error"></div>
                                </div>
                                <div class="form-group half">
                                    <label for="phone_number">Phone Number *</label>
                                    <input type="tel" id="phone_number" name="phone_number" required>
                                    <div class="field-error" id="phone_number_error"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Shipping Information -->
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-shipping-fast"></i>
                                Shipping Address
                            </h2>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="address">Street Address *</label>
                                    <input type="text" id="address" name="address" placeholder="123 Main Street" required>
                                    <div class="field-error" id="address_error"></div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group half">
                                    <label for="city">City *</label>
                                    <input type="text" id="city" name="city" required>
                                    <div class="field-error" id="city_error"></div>
                                </div>
                                <div class="form-group quarter">
                                    <label for="state">State/Province *</label>
                                    <select id="state" name="state" required>
                                        <option value="">Select State</option>
                                        <option value="AL">Alabama</option>
                                        <option value="CA">California</option>
                                        <option value="FL">Florida</option>
                                        <option value="NY">New York</option>
                                        <option value="TX">Texas</option>
                                        <!-- Add more states as needed -->
                                    </select>
                                    <div class="field-error" id="state_error"></div>
                                </div>
                                <div class="form-group quarter">
                                    <label for="zip_code">ZIP Code *</label>
                                    <input type="text" id="zip_code" name="zip_code" required>
                                    <div class="field-error" id="zip_code_error"></div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="country">Country *</label>
                                    <select id="country" name="country" required>
                                        <option value="">Select Country</option>
                                        <option value="US" selected>United States</option>
                                        <option value="CA">Canada</option>
                                        <option value="UK">United Kingdom</option>
                                        <option value="AU">Australia</option>
                                    </select>
                                    <div class="field-error" id="country_error"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Order Instructions -->
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-clipboard-list"></i>
                                Order Instructions
                            </h2>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="order_instruction">Special Instructions (Optional)</label>
                                    <textarea id="order_instruction" name="order_instruction" rows="4" 
                                              placeholder="Any special delivery instructions, gift messages, or notes for your order..."></textarea>
                                    <small class="help-text">Maximum 500 characters</small>
                                </div>
                            </div>
                        </div>

                        <!-- Shipping Method -->
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-truck"></i>
                                Shipping Method
                            </h2>
                            
                            <div class="shipping-options">
                                <div class="shipping-option">
                                    <input type="radio" id="standard_shipping" name="shipping_method" value="standard" checked>
                                    <label for="standard_shipping">
                                        <div class="shipping-info">
                                            <div class="shipping-name">Standard Shipping</div>
                                            <div class="shipping-description">5-7 business days</div>
                                        </div>
                                        <div class="shipping-price">FREE</div>
                                    </label>
                                </div>
                                
                                <div class="shipping-option">
                                    <input type="radio" id="express_shipping" name="shipping_method" value="express">
                                    <label for="express_shipping">
                                        <div class="shipping-info">
                                            <div class="shipping-name">Express Shipping</div>
                                            <div class="shipping-description">2-3 business days</div>
                                        </div>
                                        <div class="shipping-price">$9.99</div>
                                    </label>
                                </div>
                                
                                <div class="shipping-option">
                                    <input type="radio" id="overnight_shipping" name="shipping_method" value="overnight">
                                    <label for="overnight_shipping">
                                        <div class="shipping-info">
                                            <div class="shipping-name">Overnight Shipping</div>
                                            <div class="shipping-description">Next business day</div>
                                        </div>
                                        <div class="shipping-price">$24.99</div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-credit-card"></i>
                                Payment Method
                            </h2>
                            
                            <div class="payment-options">
                                <div class="payment-option">
                                    <input type="radio" id="credit_card" name="payment_method" value="credit_card" checked>
                                    <label for="credit_card">
                                        <i class="fas fa-credit-card"></i>
                                        Credit/Debit Card
                                    </label>
                                </div>
                                
                                <div class="payment-option">
                                    <input type="radio" id="paypal" name="payment_method" value="paypal">
                                    <label for="paypal">
                                        <i class="fab fa-paypal"></i>
                                        PayPal
                                    </label>
                                </div>
                                
                                <div class="payment-option">
                                    <input type="radio" id="apple_pay" name="payment_method" value="apple_pay">
                                    <label for="apple_pay">
                                        <i class="fab fa-apple-pay"></i>
                                        Apple Pay
                                    </label>
                                </div>
                            </div>

                            <!-- Credit Card Form -->
                            <div class="credit-card-form" id="credit-card-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="card_number">Card Number *</label>
                                        <input type="text" id="card_number" name="card_number" placeholder="1234 5678 9012 3456" maxlength="19">
                                        <div class="card-types">
                                            <i class="fab fa-cc-visa"></i>
                                            <i class="fab fa-cc-mastercard"></i>
                                            <i class="fab fa-cc-amex"></i>
                                            <i class="fab fa-cc-discover"></i>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group half">
                                        <label for="expiry_date">Expiry Date *</label>
                                        <input type="text" id="expiry_date" name="expiry_date" placeholder="MM/YY" maxlength="5">
                                    </div>
                                    <div class="form-group half">
                                        <label for="cvv">CVV *</label>
                                        <input type="text" id="cvv" name="cvv" placeholder="123" maxlength="4">
                                        <i class="fas fa-question-circle cvv-help" title="3 or 4 digits on the back of your card"></i>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="cardholder_name">Cardholder Name *</label>
                                        <input type="text" id="cardholder_name" name="cardholder_name" placeholder="John Doe">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary Section -->
                    <div class="order-summary-section">
                        <div class="order-summary">
                            <h3>Order Summary</h3>
                            
                            <div class="order-items" id="order-items">
                                <!-- Items will be populated here -->
                                <div class="summary-loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    Loading order items...
                                </div>
                            </div>
                            
                            <div class="order-totals">
                                <div class="total-line">
                                    <span>Subtotal:</span>
                                    <span id="order-subtotal">$0.00</span>
                                </div>
                                
                                <div class="total-line">
                                    <span>Shipping:</span>
                                    <span id="order-shipping">$0.00</span>
                                </div>
                                
                                <div class="total-line">
                                    <span>Tax:</span>
                                    <span id="order-tax">$0.00</span>
                                </div>
                                
                                <div class="total-divider"></div>
                                
                                <div class="total-line grand-total">
                                    <span>Total:</span>
                                    <span id="order-total">$0.00</span>
                                </div>
                            </div>
                            
                            <div class="checkout-actions">
                                <button type="submit" class="place-order-btn" id="place-order-btn">
                                    <i class="fas fa-lock"></i>
                                    Place Order
                                </button>
                                
                                <div class="security-badges">
                                    <div class="security-badge">
                                        <i class="fas fa-shield-alt"></i>
                                        <span>SSL Secured</span>
                                    </div>
                                    <div class="security-badge">
                                        <i class="fas fa-lock"></i>
                                        <span>Safe Checkout</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Trust Badges -->
                        <div class="trust-badges">
                            <h4>Why shop with us?</h4>
                            <div class="trust-item">
                                <i class="fas fa-shipping-fast"></i>
                                <div>
                                    <strong>Fast Shipping</strong>
                                    <p>Free shipping on orders over $50</p>
                                </div>
                            </div>
                            <div class="trust-item">
                                <i class="fas fa-undo"></i>
                                <div>
                                    <strong>Easy Returns</strong>
                                    <p>30-day return policy</p>
                                </div>
                            </div>
                            <div class="trust-item">
                                <i class="fas fa-headset"></i>
                                <div>
                                    <strong>24/7 Support</strong>
                                    <p>Customer service available</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
<style>
    /* Page Layout */
    .checkout-page {
        padding: 2rem 0;
        min-height: 80vh;
    }

    .page-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .page-title {
        font-size: 3rem;
        font-weight: 300;
        color: var(--dark-color);
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        color: var(--secondary-color);
        font-size: 1.2rem;
    }

    /* Checkout Grid */
    .checkout-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 3rem;
        align-items: start;
    }

    /* Form Section */
    .checkout-form-section {
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 2rem;
    }

    .form-section {
        margin-bottom: 3rem;
        padding-bottom: 2rem;
        border-bottom: 2px solid var(--border-color);
    }

    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 1.5rem;
    }

    .section-title i {
        color: var(--primary-color);
        font-size: 1.25rem;
    }

    /* Form Elements */
    .form-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .form-group {
        flex: 1;
        position: relative;
    }

    .form-group.half {
        flex: 0.5;
    }

    .form-group.quarter {
        flex: 0.25;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--dark-color);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.875rem;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: 1rem;
        transition: var(--transition);
        background: var(--white);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .form-group textarea {
        resize: vertical;
        font-family: inherit;
    }

    .help-text {
        color: var(--secondary-color);
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: block;
    }

    .field-error {
        color: var(--danger-color);
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: none;
    }

    /* Shipping Options */
    .shipping-options {
        display: grid;
        gap: 1rem;
    }

    .shipping-option {
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        transition: var(--transition);
        overflow: hidden;
    }

    .shipping-option:hover {
        border-color: var(--primary-color);
    }

    .shipping-option input[type="radio"] {
        display: none;
    }

    .shipping-option input[type="radio"]:checked + label {
        background: var(--light-color);
        border-left: 4px solid var(--primary-color);
    }

    .shipping-option label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.25rem;
        cursor: pointer;
        transition: var(--transition);
    }

    .shipping-info .shipping-name {
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 0.25rem;
    }

    .shipping-info .shipping-description {
        color: var(--secondary-color);
        font-size: 0.9rem;
    }

    .shipping-price {
        font-weight: bold;
        color: var(--primary-color);
        font-size: 1.1rem;
    }

    /* Payment Options */
    .payment-options {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .payment-option {
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        transition: var(--transition);
        text-align: center;
    }

    .payment-option:hover {
        border-color: var(--primary-color);
    }

    .payment-option input[type="radio"] {
        display: none;
    }

    .payment-option input[type="radio"]:checked + label {
        background: var(--primary-color);
        color: var(--white);
    }

    .payment-option label {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem;
        cursor: pointer;
        transition: var(--transition);
        font-weight: 600;
    }

    .payment-option label i {
        font-size: 1.5rem;
    }

    /* Credit Card Form */
    .credit-card-form {
        margin-top: 2rem;
        padding: 2rem;
        background: var(--light-color);
        border-radius: var(--border-radius);
    }

    .card-types {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        gap: 0.25rem;
    }

    .card-types i {
        font-size: 1.25rem;
        color: var(--secondary-color);
        opacity: 0.6;
    }

    .cvv-help {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--secondary-color);
        cursor: help;
    }

    /* Order Summary */
    .order-summary-section {
        position: sticky;
        top: 2rem;
    }

    .order-summary {
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .order-summary h3 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 1.5rem;
        text-align: center;
    }

    .summary-loading {
        text-align: center;
        padding: 2rem;
        color: var(--secondary-color);
    }

    .summary-loading i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        display: block;
    }

    /* Order Items */
    .order-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem 0;
        border-bottom: 1px solid var(--border-color);
    }

    .order-item:last-child {
        border-bottom: none;
    }

    .item-thumbnail {
        width: 60px;
        height: 60px;
        border-radius: var(--border-radius);
        overflow: hidden;
        background: var(--light-color);
        flex-shrink: 0;
    }

    .item-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .item-info {
        flex: 1;
    }

    .item-name {
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
    }

    .item-variant {
        color: var(--secondary-color);
        font-size: 0.8rem;
    }

    .item-quantity {
        background: var(--light-color);
        padding: 0.25rem 0.5rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--dark-color);
    }

    .item-price {
        font-weight: bold;
        color: var(--primary-color);
    }

    /* Order Totals */
    .order-totals {
        margin-top: 1.5rem;
    }

    .total-line {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        font-size: 1rem;
    }

    .total-line.grand-total {
        font-size: 1.3rem;
        font-weight: bold;
        color: var(--primary-color);
    }

    .total-divider {
        height: 2px;
        background: var(--border-color);
        margin: 1rem 0;
    }

    /* Checkout Actions */
    .checkout-actions {
        margin-top: 2rem;
    }

    .place-order-btn {
        width: 100%;
        background: var(--success-color);
        color: var(--white);
        border: none;
        padding: 1.25rem 2rem;
        border-radius: var(--border-radius);
        font-size: 1.2rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .place-order-btn:hover {
        background: #218838;
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .place-order-btn:disabled {
        background: var(--secondary-color);
        cursor: not-allowed;
        transform: none;
    }

    .security-badges {
        display: flex;
        justify-content: center;
        gap: 1rem;
    }

    .security-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--secondary-color);
        font-size: 0.9rem;
    }

    .security-badge i {
        color: var(--success-color);
    }

    /* Trust Badges */
    .trust-badges {
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 1.5rem;
    }

    .trust-badges h4 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 1rem;
        text-align: center;
    }

    .trust-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .trust-item:last-child {
        margin-bottom: 0;
    }

    .trust-item i {
        font-size: 1.5rem;
        color: var(--primary-color);
        width: 30px;
        text-align: center;
    }

    .trust-item strong {
        display: block;
        color: var(--dark-color);
        margin-bottom: 0.25rem;
    }

    .trust-item p {
        color: var(--secondary-color);
        font-size: 0.9rem;
        margin: 0;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .checkout-grid {
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .order-summary-section {
            position: static;
        }

        .form-row {
            flex-direction: column;
        }

        .form-group.half,
        .form-group.quarter {
            flex: 1;
        }

        .payment-options {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .page-title {
            font-size: 2rem;
        }

        .checkout-form-section,
        .order-summary {
            padding: 1.5rem;
        }

        .section-title {
            font-size: 1.25rem;
        }

        .shipping-option label {
            flex-direction: column;
            text-align: center;
            gap: 0.5rem;
        }
    }

    @media (max-width: 480px) {
        .checkout-form-section,
        .order-summary,
        .trust-badges {
            padding: 1rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem;
        }

        .place-order-btn {
            padding: 1rem;
            font-size: 1.1rem;
        }

        .security-badges {
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadOrderSummary();
        setupFormValidation();
        setupPaymentMethodToggle();
        setupCardInputFormatting();
        
        // Load order summary
        function loadOrderSummary() {
            fetch('/api/v1/cart/', {
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(cartData => {
                displayOrderItems(cartData.items || []);
                updateOrderTotals(cartData);
            })
            .catch(error => {
                console.error('Error loading cart:', error);
                document.getElementById('order-items').innerHTML = `
                    <div style="text-align: center; color: var(--danger-color); padding: 2rem;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading cart items</p>
                    </div>
                `;
            });
        }
        
        function displayOrderItems(items) {
            const orderItemsContainer = document.getElementById('order-items');
            
            if (items.length === 0) {
                orderItemsContainer.innerHTML = `
                    <div style="text-align: center; color: var(--secondary-color); padding: 2rem;">
                        <p>No items in cart</p>
                        <a href="/" style="color: var(--primary-color);">Continue Shopping</a>
                    </div>
                `;
                return;
            }
            
            orderItemsContainer.innerHTML = items.map(item => {
                // Use flattened fields first, fall back to nested structure
                const productName = item.product_name || (item.product ? item.product.name : 'Unknown Product');
                const productImage = item.product_image || (item.product ? item.product.primary_image : null) || '/media/default.webp';
                
                // Extract variant information - use flattened fields first
                const variantName = item.variant_name || (item.variant ? item.variant.name : null);
                const variantColor = item.variant_color || (item.variant ? item.variant.color : null);
                const variantSize = item.variant_size || (item.variant ? item.variant.size : null);
                
                // Build variant display string
                let variantDisplay = '';
                if (variantName) {
                    variantDisplay = variantName;
                } else if (variantColor || variantSize) {
                    const parts = [];
                    if (variantColor) parts.push(variantColor);
                    if (variantSize) parts.push(variantSize);
                    variantDisplay = parts.join(', ');
                }
                
                return `
                    <div class="order-item">
                        <div class="item-thumbnail">
                            <img src="${productImage}" alt="${productName}" onerror="this.src='/media/default.webp'">
                        </div>
                        <div class="item-info">
                            <div class="item-name">${productName}</div>
                            ${variantDisplay ? `<div class="item-variant">${variantDisplay}</div>` : ''}
                        </div>
                        <div class="item-quantity">×${item.quantity}</div>
                        <div class="item-price">$${item.total_price}</div>
                    </div>
                `;
            }).join('');
        }
        
        function updateOrderTotals(cartData) {
            const subtotal = parseFloat(cartData.subtotal || 0);
            const shippingMethod = document.querySelector('input[name="shipping_method"]:checked');
            let shipping = 0;
            
            if (shippingMethod) {
                switch(shippingMethod.value) {
                    case 'express': shipping = 9.99; break;
                    case 'overnight': shipping = 24.99; break;
                    default: shipping = subtotal > 50 ? 0 : 9.99;
                }
            }
            
            const tax = parseFloat(cartData.tax || 0);
            const total = subtotal + shipping + tax;
            
            document.getElementById('order-subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('order-shipping').textContent = shipping === 0 ? 'FREE' : `$${shipping.toFixed(2)}`;
            document.getElementById('order-tax').textContent = `$${tax.toFixed(2)}`;
            document.getElementById('order-total').textContent = `$${total.toFixed(2)}`;
        }
        
        // Update totals when shipping method changes
        document.querySelectorAll('input[name="shipping_method"]').forEach(radio => {
            radio.addEventListener('change', () => {
                loadOrderSummary(); // Reload to recalculate shipping
            });
        });
        
        // Payment method toggle
        function setupPaymentMethodToggle() {
            const paymentMethods = document.querySelectorAll('input[name="payment_method"]');
            const creditCardForm = document.getElementById('credit-card-form');
            
            paymentMethods.forEach(method => {
                method.addEventListener('change', function() {
                    if (this.value === 'credit_card') {
                        creditCardForm.style.display = 'block';
                    } else {
                        creditCardForm.style.display = 'none';
                    }
                });
            });
        }
        
        // Card input formatting
        function setupCardInputFormatting() {
            const cardNumberInput = document.getElementById('card_number');
            const expiryInput = document.getElementById('expiry_date');
            
            if (cardNumberInput) {
                // Format card number
                cardNumberInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                    let formattedValue = value.match(/.{1,4}/g)?.join(' ') ?? value;
                    if (formattedValue.length > 19) {
                        formattedValue = formattedValue.substring(0, 19);
                    }
                    e.target.value = formattedValue;
                });
            }
            
            if (expiryInput) {
                // Format expiry date
                expiryInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + '/' + value.substring(2, 4);
                    }
                    e.target.value = value;
                });
            }
        }
        
        // Form validation
        function setupFormValidation() {
            const form = document.getElementById('checkout-form');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (validateForm()) {
                    processOrder();
                }
            });
        }
        
        function validateForm() {
            let isValid = true;
            
            // Required fields
            const requiredFields = [
                'full_name', 'email', 'phone_number', 'address', 
                'city', 'state', 'zip_code', 'country'
            ];
            
            requiredFields.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                const errorElement = document.getElementById(fieldName + '_error');
                
                if (field && !field.value.trim()) {
                    showFieldError(field, errorElement, 'This field is required');
                    isValid = false;
                } else if (field && errorElement) {
                    hideFieldError(field, errorElement);
                }
            });
            
            // Email validation
            const emailField = document.getElementById('email');
            const emailError = document.getElementById('email_error');
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (emailField && emailField.value && !emailPattern.test(emailField.value)) {
                showFieldError(emailField, emailError, 'Please enter a valid email address');
                isValid = false;
            }
            
            // Credit card validation if selected
            const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
            if (paymentMethod && paymentMethod.value === 'credit_card') {
                const cardFields = ['card_number', 'expiry_date', 'cvv', 'cardholder_name'];
                
                cardFields.forEach(fieldName => {
                    const field = document.getElementById(fieldName);
                    if (field && !field.value.trim()) {
                        field.style.borderColor = 'var(--danger-color)';
                        isValid = false;
                    } else if (field) {
                        field.style.borderColor = 'var(--border-color)';
                    }
                });
                
                // Card number validation
                const cardNumber = document.getElementById('card_number');
                if (cardNumber && cardNumber.value.replace(/\s/g, '').length < 13) {
                    cardNumber.style.borderColor = 'var(--danger-color)';
                    isValid = false;
                }
                
                // Expiry date validation
                const expiryDate = document.getElementById('expiry_date');
                if (expiryDate && expiryDate.value.length < 5) {
                    expiryDate.style.borderColor = 'var(--danger-color)';
                    isValid = false;
                }
                
                // CVV validation
                const cvv = document.getElementById('cvv');
                if (cvv && (cvv.value.length < 3 || cvv.value.length > 4)) {
                    cvv.style.borderColor = 'var(--danger-color)';
                    isValid = false;
                }
            }
            
            return isValid;
        }
        
        function showFieldError(field, errorElement, message) {
            if (field) field.style.borderColor = 'var(--danger-color)';
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }
        
        function hideFieldError(field, errorElement) {
            if (field) field.style.borderColor = 'var(--border-color)';
            if (errorElement) errorElement.style.display = 'none';
        }
        
        function processOrder() {
            const placeOrderBtn = document.getElementById('place-order-btn');
            const originalText = placeOrderBtn.innerHTML;
            placeOrderBtn.disabled = true;
            placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            // Collect form data
            const formData = new FormData(document.getElementById('checkout-form'));
            
            // Prepare order data in the expected format for CreateOrderSerializer
            const orderData = {
                shipping_address: {
                    first_name: formData.get('full_name').split(' ')[0] || '',
                    last_name: formData.get('full_name').split(' ').slice(1).join(' ') || '',
                    company: formData.get('company') || '',
                    address_line_1: formData.get('address'),
                    address_line_2: formData.get('address_2') || '',
                    city: formData.get('city'),
                    state: formData.get('state'),
                    postal_code: formData.get('zip_code'),
                    country: formData.get('country'),
                    phone: formData.get('phone_number'),
                    email: formData.get('email'),
                    delivery_instructions: formData.get('order_instructions') || ''
                },
                customer_notes: formData.get('order_instructions') || '',
                coupon_code: formData.get('coupon_code') || ''
            };
            
            // Create order via API
            fetch('/api/v1/orders/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error || data.errors) {
                    const errorMessage = data.error || data.detail || 'Please check your information and try again.';
                    showNotification('Order failed: ' + errorMessage, 'error');
                    console.error('Order errors:', data);
                } else if (data.order && data.order.id) {
                    // Success - clear cart and redirect to order confirmation
                    showNotification('Order placed successfully!', 'success');
                    
                    // Clear the cart
                    fetch('/api/v1/cart/clear/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    }).then(() => {
                        setTimeout(() => {
                            window.location.href = `/orders/${data.order.order_number}/`;
                        }, 1500);
                    });
                } else {
                    showNotification('Order created but confirmation failed. Please check your orders.', 'warning');
                    setTimeout(() => {
                        window.location.href = '/orders/';
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error processing order:', error);
                showNotification('Error processing order. Please try again.', 'error');
            })
            .finally(() => {
                placeOrderBtn.disabled = false;
                placeOrderBtn.innerHTML = originalText;
            });
        }
        
        // Utility functions
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : '#dc3545'};
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    });
</script>
{% endblock %}
