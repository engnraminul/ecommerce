{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}Checkout - Professional eCommerce{% endblock %}

{% block content %}
    <div class="container">
        <!-- Breadcrumb -->
        {% if checkout_customization.show_breadcrumb %}
        <nav class="breadcrumb">
            <a href="{% url 'frontend:home' %}">{{ checkout_customization.breadcrumb_home|default:"Home" }}</a>
            <span class="breadcrumb-separator">/</span>
            <a href="{% url 'frontend:cart' %}">{{ checkout_customization.breadcrumb_cart|default:"Cart" }}</a>
            <span class="breadcrumb-separator">/</span>
            <span class="current">{{ checkout_customization.breadcrumb_checkout|default:"Checkout" }}</span>
        </nav>
        {% endif %}

        <div class="checkout-page">
            <div class="page-header">
                <h1 class="page-title">{{ checkout_customization.page_title|default:"Checkout" }}</h1>
                <p class="page-subtitle">{{ checkout_customization.page_subtitle|default:"Complete your order" }}</p>
            </div>

            <form class="checkout-form" id="checkout-form">
                <div class="checkout-grid">
                    <!-- Checkout Form Section -->
                    <div class="checkout-form-section">
                        <!-- Customer Information -->
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-user"></i>
                                {{ checkout_customization.customer_section_title|default:"Customer Information" }}
                            </h2>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="full_name">{{ checkout_customization.full_name_label|default:"Full Name" }}</label>
                                    <input type="text" id="full_name" name="full_name" 
                                           placeholder="{{ checkout_customization.full_name_placeholder|default:"" }}"
                                           value="{{ checkout_customization.full_name_default|default:"" }}">
                                    <div class="field-error" id="full_name_error"></div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group half">
                                    <label for="phone_number">{{ checkout_customization.phone_label|default:"Phone Number *" }}</label>
                                    <input type="tel" id="phone_number" name="phone_number" required
                                           placeholder="{{ checkout_customization.phone_placeholder|default:"01777173040 (11 digits)" }}"
                                           value="{{ checkout_customization.phone_default|default:"" }}"> 
                                    <div class="field-error" id="phone_number_error"></div>
                                </div>
                                <div class="form-group half">
                                    <label for="email">{{ checkout_customization.email_label|default:"Email Address (optional)" }}</label>
                                    <input type="email" id="email" name="email"
                                           placeholder="{{ checkout_customization.email_placeholder|default:"" }}"
                                           value="{{ checkout_customization.email_default|default:"" }}">
                                    <div class="field-error" id="email_error"></div>
                                </div>

                            </div>
                        </div>

                        <!-- Shipping Information -->
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-shipping-fast"></i>
                                {{ checkout_customization.shipping_section_title|default:"Shipping Address" }}
                            </h2>
                            
                            
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="address">{{ checkout_customization.address_label|default:"Street Address" }}</label>
                                    <textarea id="address" name="address" rows="3" 
                                              placeholder="{{ checkout_customization.address_placeholder|default:"" }}">{{ checkout_customization.address_default }}</textarea>
                                    <div class="field-error" id="address_error"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Order Instructions -->
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-clipboard-list"></i>
                                {{ checkout_customization.instructions_section_title|default:"Order Instructions" }}
                            </h2>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="order_instruction">{{ checkout_customization.instructions_label|default:"Special Instructions (Optional)" }}</label>
                                    <textarea id="order_instruction" name="order_instruction" rows="4" 
                                              placeholder="{{ checkout_customization.instructions_placeholder|default:"Any special delivery instructions, gift messages, or notes for your order..." }}"></textarea>
                                    <small class="help-text">{{ checkout_customization.instructions_help_text|default:"Maximum 500 characters" }}</small>
                                </div>
                            </div>
                        </div>

                        <!-- Shipping Method -->
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-truck"></i>
                                {{ checkout_customization.shipping_method_section_title|default:"Shipping Method" }}
                            </h2>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>{{ checkout_customization.delivery_location_label|default:"Delivery Location *" }}</label>
                                    <div class="location-options">
                                        <div class="location-option">
                                            <input type="radio" id="location_dhaka" name="location" value="dhaka" checked required>
                                            <label for="location_dhaka">
                                                <i class="fas fa-city"></i>
                                                <span>{{ checkout_customization.dhaka_location_label|default:"Dhaka City" }}</span>
                                            </label>
                                        </div>
                                        <div class="location-option">
                                            <input type="radio" id="location_outside" name="location" value="outside" required>
                                            <label for="location_outside">
                                                <i class="fas fa-map-marker-alt"></i>
                                                <span>{{ checkout_customization.outside_location_label|default:"Outside Dhaka" }}</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="field-error" id="location_error"></div>
                                </div>
                            </div>
                            <div class="shipping-options" id="shipping-options">
                                <!-- Shipping options will be loaded dynamically -->
                                <div class="shipping-loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    {{ checkout_customization.loading_shipping_message|default:"Loading shipping options..." }}
                                </div>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="form-section">
                            <h2 class="section-title">
                                <i class="fas fa-credit-card"></i>
                                {{ checkout_customization.payment_section_title|default:"Payment Method" }}
                            </h2>
                            
                            <div class="payment-options">
                                <div class="payment-option">
                                    <input type="radio" id="cod" name="payment_method" value="cod" checked>
                                    <label for="cod">
                                        <i class="fas fa-money-bill-wave"></i>
                                        {{ checkout_customization.cod_label|default:"Cash on Delivery" }}
                                    </label>
                                </div>
                                
                                <div class="payment-option">
                                    <input type="radio" id="bkash" name="payment_method" value="bkash">
                                    <label for="bkash">
                                        <i class="fas fa-mobile-alt"></i>
                                        {{ checkout_customization.bkash_label|default:"bKash" }}
                                    </label>
                                </div>
                                
                                <div class="payment-option">
                                    <input type="radio" id="nagad" name="payment_method" value="nagad">
                                    <label for="nagad">
                                        <i class="fas fa-wallet"></i>
                                        {{ checkout_customization.nagad_label|default:"Nagad" }}
                                    </label>
                                </div>
                            </div>

                            <!-- bKash Form -->
                            <div class="payment-form" id="bkash-form" style="display: none;">
                                <div class="payment-method-info">
                                    <div class="info-header">
                                        <i class="fas fa-mobile-alt"></i>
                                        <h4>{{ checkout_customization.bkash_label|default:"bKash" }} Payment</h4>
                                    </div>
                                    <div class="payment-instructions">
                                        <p><strong>Follow these steps:</strong></p>
                                        <ol>
                                            <li>Go to your bKash Mobile Menu by dialing *247#</li>
                                            <li>Choose "Send Money"</li>
                                            <li>Enter Merchant bKash Account Number: <strong>{{ checkout_customization.bkash_merchant_number|default:"01XXXXXXXXX" }}</strong></li>
                                            <li>Enter the total amount: <strong id="bkash-amount">$0.00</strong></li>
                                            <li>Enter a reference: Your phone number</li>
                                            <li>Now enter your bKash Mobile Menu PIN and confirm</li>
                                        </ol>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="bkash_sender_number">{{ checkout_customization.bkash_sender_label|default:"Your Mobile Number (From which you sent money) *" }}</label>
                                        <input type="tel" id="bkash_sender_number" name="bkash_sender_number" 
                                               placeholder="{{ checkout_customization.bkash_sender_placeholder|default:"01XXXXXXXXX - Your phone number" }}">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="bkash_transaction_id">{{ checkout_customization.bkash_transaction_label|default:"bKash Transaction ID (TrxID from SMS) *" }}</label>
                                        <input type="text" id="bkash_transaction_id" name="bkash_transaction_id" 
                                               placeholder="{{ checkout_customization.bkash_transaction_placeholder|default:"Example: 8A4D5F2C1B - From your SMS receipt" }}">
                                    </div>
                                </div>
                            </div>

                            <!-- Nagad Form -->
                            <div class="payment-form" id="nagad-form" style="display: none;">
                                <div class="payment-method-info">
                                    <div class="info-header">
                                        <i class="fas fa-wallet"></i>
                                        <h4>{{ checkout_customization.nagad_label|default:"Nagad" }} Payment</h4>
                                    </div>
                                    <div class="payment-instructions">
                                        <p><strong>Follow these steps:</strong></p>
                                        <ol>
                                            <li>Go to your Nagad Mobile Menu by dialing *167#</li>
                                            <li>Choose "Send Money"</li>
                                            <li>Enter Merchant Nagad Account Number: <strong>{{ checkout_customization.nagad_merchant_number|default:"01XXXXXXXXX" }}</strong></li>
                                            <li>Enter the total amount: <strong id="nagad-amount">$0.00</strong></li>
                                            <li>Enter a reference: Your phone number</li>
                                            <li>Now enter your Nagad PIN and confirm</li>
                                        </ol>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="nagad_sender_number">{{ checkout_customization.nagad_sender_label|default:"Your Mobile Number (From which you sent money) *" }}</label>
                                        <input type="tel" id="nagad_sender_number" name="nagad_sender_number" 
                                               placeholder="{{ checkout_customization.nagad_sender_placeholder|default:"01XXXXXXXXX - Your phone number" }}">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="nagad_transaction_id">{{ checkout_customization.nagad_transaction_label|default:"Nagad Transaction ID (TrxID from SMS) *" }}</label>
                                        <input type="text" id="nagad_transaction_id" name="nagad_transaction_id" 
                                               placeholder="{{ checkout_customization.nagad_transaction_placeholder|default:"Example: 8A4D5F2C1B - From your SMS receipt" }}">
                                    </div>
                                </div>
                            </div>

                            <!-- COD Form -->
                            <div class="payment-form" id="cod-form">
                                <div class="payment-method-info">
                                    <div class="info-header">
                                        <i class="fas fa-money-bill-wave"></i>
                                        <h4>{{ checkout_customization.cod_label|default:"Cash on Delivery" }}</h4>
                                    </div>
                                    <div class="payment-instructions">
                                        <p><strong>Payment Information:</strong></p>
                                        {{ checkout_customization.cod_instructions|default:"<ul><li>Pay cash when you receive your order</li><li>Make sure to have exact amount ready</li><li>Our delivery person will collect the payment</li><li>You can inspect the product before payment</li></ul>"|safe }}
                                        <div class="cod-total">
                                            <strong>Total Amount to Pay: <span id="cod-amount">৳0.00</span></strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary Section -->
                    {% if checkout_customization.show_order_summary %}
                    <div class="order-summary-section">
                        <div class="order-summary">
                            <h3>{{ checkout_customization.order_summary_title|default:"Order Summary" }}</h3>
                            
                            <div class="order-items" id="order-items">
                                <!-- Items will be populated here -->
                                <div class="summary-loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    {{ checkout_customization.loading_cart_message|default:"Loading order items..." }}
                                </div>
                            </div>
                            
                            <div class="order-totals">
                                <div class="total-line">
                                    <span>{{ checkout_customization.subtotal_label|default:"Subtotal:" }}</span>
                                    <span id="order-subtotal">৳0.00</span>
                                </div>
                                
                                <div class="total-line">
                                    <span>{{ checkout_customization.shipping_label|default:"Shipping:" }}</span>
                                    <span id="order-shipping">৳0.00</span>
                                </div>
                                
                                <div class="total-line">
                                    <span>{{ checkout_customization.tax_label|default:"Tax:" }}</span>
                                    <span id="order-tax">৳0.00</span>
                                </div>
                                
                                <!-- Coupon Section -->
                                <div class="coupon-section">
                                    <div class="coupon-input-container" id="coupon-input-container">
                                        <input type="text" id="coupon-code" placeholder="Enter coupon code" maxlength="50">
                                        <button type="button" id="apply-coupon-btn" class="apply-coupon-btn">Apply</button>
                                    </div>
                                    
                                    <div class="applied-coupon" id="applied-coupon" style="display: none;">
                                        <div class="coupon-details">
                                            <span class="coupon-name" id="applied-coupon-name"></span>
                                            <span class="coupon-code-display" id="applied-coupon-code"></span>
                                        </div>
                                        <button type="button" id="remove-coupon-btn" class="remove-coupon-btn">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    
                                    <div class="coupon-message" id="coupon-message" style="display: none;"></div>
                                </div>
                                
                                <div class="total-line discount" id="discount-line" style="display: none;">
                                    <span>{{ checkout_customization.discount_label|default:"Discount:" }}</span>
                                    <span id="order-discount">-৳0.00</span>
                                </div>
                                
                                <div class="total-divider"></div>
                                
                                <div class="total-line grand-total">
                                    <span>{{ checkout_customization.total_label|default:"Total:" }}</span>
                                    <span id="order-total">৳0.00</span>
                                </div>
                            </div>
                            
                            <div class="checkout-actions">
                                <button type="submit" class="place-order-btn" id="place-order-btn">
                                    <i class="fas fa-lock"></i>
                                    {{ checkout_customization.place_order_button_text|default:"Place Order" }}
                                </button>
                                
                                {% if checkout_customization.show_security_badges %}
                                <div class="security-badges">
                                    <div class="security-badge">
                                        <i class="fas fa-shield-alt"></i>
                                        <span>{{ checkout_customization.security_ssl_text|default:"SSL Secured" }}</span>
                                    </div>
                                    <div class="security-badge">
                                        <i class="fas fa-lock"></i>
                                        <span>{{ checkout_customization.security_safe_text|default:"Safe Checkout" }}</span>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Trust Badges -->
                        {% if checkout_customization.show_trust_badges %}
                        <div class="trust-badges">
                            <h4>{{ checkout_customization.trust_section_title|default:"Why shop with us?" }}</h4>
                            <div class="trust-item">
                                <i class="fas fa-shipping-fast"></i>
                                <div>
                                    <strong>{{ checkout_customization.fast_shipping_title|default:"Fast Shipping" }}</strong>
                                    <p>{{ checkout_customization.fast_shipping_description|default:"Free shipping on orders over $50" }}</p>
                                </div>
                            </div>
                            <div class="trust-item">
                                <i class="fas fa-undo"></i>
                                <div>
                                    <strong>{{ checkout_customization.easy_returns_title|default:"Easy Returns" }}</strong>
                                    <p>{{ checkout_customization.easy_returns_description|default:"30-day return policy" }}</p>
                                </div>
                            </div>
                            <div class="trust-item">
                                <i class="fas fa-headset"></i>
                                <div>
                                    <strong>{{ checkout_customization.support_title|default:"24/7 Support" }}</strong>
                                    <p>{{ checkout_customization.support_description|default:"Customer service available" }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
<style>
    /* Dynamic Customization Variables */
    :root {
        --checkout-primary-color: {{ checkout_customization.primary_color|default:"#930000" }};
        --checkout-button-color: {{ checkout_customization.button_color|default:"#930000" }};
        --checkout-background-color: {{ checkout_customization.background_color|default:"#f8fafc" }};
    }

    /* Page Layout */
    .checkout-page {
        padding: 2rem 0;
        min-height: 80vh;
        background: linear-gradient(135deg, var(--checkout-background-color) 0%, #e2e8f0 100%);
    }

    .page-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .page-title {
        font-size: 3rem;
        font-weight: 300;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(147, 0, 0, 0.1);
    }

    .page-subtitle {
        color: var(--secondary-color);
        font-size: 1.2rem;
        font-weight: 500;
    }

    /* Breadcrumb */
    .breadcrumb {
        margin-bottom: 2rem;
        padding: 1rem 0;
    }

    .breadcrumb a {
        color: var(--secondary-color);
        text-decoration: none;
        font-weight: 500;
        transition: var(--transition);
    }

    .breadcrumb a:hover {
        color: var(--primary-color);
    }

    .breadcrumb .current {
        color: var(--primary-color);
        font-weight: 600;
    }

    .breadcrumb-separator {
        color: var(--secondary-color);
        margin: 0 0.5rem;
    }

    /* Checkout Grid */
    .checkout-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 3rem;
        align-items: start;
    }

    /* Form Section */
    .checkout-form-section {
        background: var(--white);
        border-radius: 16px;
        box-shadow: 0 8px 25px rgba(147, 0, 0, 0.1);
        padding: 2.5rem;
        border: 1px solid rgba(147, 0, 0, 0.1);
    }

    .form-section {
        margin-bottom: 3rem;
        padding-bottom: 2rem;
        border-bottom: 2px solid #e2e8f0;
    }

    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 1.5rem;
    }

    .section-title i {
        color: var(--primary-color);
        font-size: 1.25rem;
        padding: 0.5rem;
        background: rgba(147, 0, 0, 0.1);
        border-radius: 8px;
    }

    /* Form Elements */
    .form-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .form-group {
        flex: 1;
        position: relative;
    }

    .form-group.half {
        flex: 0.5;
    }

    .form-group.quarter {
        flex: 0.25;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--secondary-color);
        font-size: 0.95rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.875rem;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: 1rem;
        transition: var(--transition);
        background: var(--white);
        color: var(--dark-color);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(147, 0, 0, 0.1);
    }

    .form-group textarea {
        resize: vertical;
        font-family: inherit;
    }

    .help-text {
        color: var(--secondary-color);
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: block;
    }

    .field-error {
        color: var(--danger-color);
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: none;
    }

    /* Shipping Options */
    .shipping-options {
        display: grid;
        gap: 1rem;
    }

    /* Location Options */
    .location-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-top: 0.5rem;
    }

    .location-option {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        transition: all 0.3s ease;
        text-align: center;
        background: #ffffff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .location-option:hover {
        border-color: #930000;
        box-shadow: 0 4px 12px rgba(147, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .location-option input[type="radio"] {
        display: none;
    }

    .location-option input[type="radio"]:checked + label {
        background: linear-gradient(135deg, #930000, #b91c1c);
        color: #ffffff;
        border-color: #930000;
    }

    .location-option input[type="radio"]:checked ~ .location-option {
        box-shadow: 0 6px 20px rgba(147, 0, 0, 0.25);
    }

    .location-option label {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
        padding: 1.25rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        border-radius: 10px;
        color: #334155;
        position: relative;
        overflow: hidden;
    }

    .location-option input[type="radio"]:checked + label {
        color: #ffffff;
    }

    .location-option label::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
    }

    .location-option:hover label::before {
        left: 100%;
    }

    .location-option label i {
        font-size: 2rem;
        margin-bottom: 0.25rem;
        transition: all 0.3s ease;
    }

    .location-option input[type="radio"]:checked + label i {
        color: #ffffff;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .location-option label span {
        font-size: 0.95rem;
        font-weight: 600;
        letter-spacing: 0.025em;
    }

    .shipping-option {
        border: 2px solid var(--border-color);
        border-radius: 12px;
        transition: var(--transition);
        overflow: hidden;
        background: var(--white);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .shipping-option:hover {
        border-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(147, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .shipping-option input[type="radio"] {
        display: none;
    }

    .shipping-option input[type="radio"]:checked + label {
        background: linear-gradient(135deg, rgba(147, 0, 0, 0.1), rgba(147, 0, 0, 0.05));
        border-left: 4px solid var(--primary-color);
    }

    .shipping-option label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.25rem;
        cursor: pointer;
        transition: var(--transition);
    }

    .shipping-info .shipping-name {
        font-weight: 600;
        color: var(--secondary-color);
        margin-bottom: 0.25rem;
        font-size: 1rem;
    }

    .shipping-info .shipping-description {
        color: var(--secondary-color);
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .shipping-price {
        font-weight: bold;
        color: var(--primary-color);
        font-size: 1.1rem;
    }
    
    .shipping-loading {
        text-align: center;
        padding: 2rem;
        color: var(--secondary-color);
    }
    
    .shipping-loading i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        display: block;
        color: var(--primary-color);
    }

    /* Payment Options */
    .payment-options {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .payment-option {
        border: 2px solid var(--border-color);
        border-radius: 12px;
        transition: var(--transition);
        text-align: center;
        background: var(--white);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .payment-option:hover {
        border-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(147, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .payment-option input[type="radio"] {
        display: none;
    }

    .payment-option input[type="radio"]:checked + label {
        background: linear-gradient(135deg, var(--primary-color), #b91c1c);
        color: var(--white);
    }

    .payment-option label {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        padding: 1.25rem;
        cursor: pointer;
        transition: var(--transition);
        font-weight: 600;
        color: var(--secondary-color);
        border-radius: 10px;
    }

    .payment-option input[type="radio"]:checked + label {
        color: var(--white);
    }

    .payment-option label i {
        font-size: 1.5rem;
        transition: var(--transition);
    }

    /* Credit Card Form */
    .credit-card-form,
    .payment-form {
        margin-top: 2rem;
        padding: 2rem;
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        border-radius: 12px;
        border: 1px solid rgba(147, 0, 0, 0.1);
    }

    .payment-method-info {
        margin-bottom: 1.5rem;
    }

    .info-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .info-header i {
        font-size: 1.5rem;
        color: var(--primary-color);
        padding: 0.5rem;
        background: rgba(147, 0, 0, 0.1);
        border-radius: 8px;
    }

    .info-header h4 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--primary-color);
        margin: 0;
    }

    .payment-instructions {
        background: var(--white);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        border-left: 4px solid var(--primary-color);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .payment-instructions p {
        margin-bottom: 1rem;
        color: var(--secondary-color);
        font-weight: 500;
    }

    .payment-instructions ol,
    .payment-instructions ul {
        margin: 0;
        padding-left: 1.5rem;
    }

    .payment-instructions li {
        margin-bottom: 0.5rem;
        color: var(--secondary-color);
        line-height: 1.5;
    }

    .payment-instructions strong {
        color: var(--primary-color);
    }

    .cod-total {
        margin-top: 1rem;
        padding: 1rem;
        background: linear-gradient(135deg, var(--primary-color), #b91c1c);
        color: var(--white);
        border-radius: var(--border-radius);
        text-align: center;
        font-size: 1.1rem;
        box-shadow: 0 4px 12px rgba(147, 0, 0, 0.3);
    }

    .card-types {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        gap: 0.25rem;
    }

    .card-types i {
        font-size: 1.25rem;
        color: var(--secondary-color);
        opacity: 0.6;
    }

    .cvv-help {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--secondary-color);
        cursor: help;
    }

    /* Order Summary */
    .order-summary-section {
        position: sticky;
        top: 2rem;
    }

    .order-summary {
        background: var(--white);
        border-radius: 16px;
        box-shadow: 0 8px 25px rgba(147, 0, 0, 0.1);
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid rgba(147, 0, 0, 0.1);
    }

    .order-summary h3 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 1.5rem;
        text-align: center;
        padding-bottom: 1rem;
        border-bottom: 2px solid rgba(147, 0, 0, 0.1);
    }

    .summary-loading {
        text-align: center;
        padding: 2rem;
        color: var(--secondary-color);
    }

    .summary-loading i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        display: block;
        color: var(--primary-color);
    }

    /* Order Items */
    .order-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem 0;
        border-bottom: 1px solid rgba(147, 0, 0, 0.1);
        transition: var(--transition);
    }

    .order-item:hover {
        background: rgba(147, 0, 0, 0.02);
        border-radius: 8px;
        padding: 1rem;
        margin: 0 -1rem;
    }

    .order-item:last-child {
        border-bottom: none;
    }

    .item-thumbnail {
        width: 60px;
        height: 60px;
        border-radius: var(--border-radius);
        overflow: hidden;
        background: var(--light-color);
        flex-shrink: 0;
        border: 2px solid rgba(147, 0, 0, 0.1);
    }

    .item-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .item-info {
        flex: 1;
    }

    .item-name {
        font-weight: 600;
        color: var(--secondary-color);
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
    }

    .item-variant {
        color: var(--secondary-color);
        font-size: 0.8rem;
        opacity: 0.8;
    }

    .item-quantity {
        background: linear-gradient(135deg, rgba(147, 0, 0, 0.1), rgba(147, 0, 0, 0.05));
        padding: 0.25rem 0.5rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--primary-color);
        border: 1px solid rgba(147, 0, 0, 0.2);
    }

    .item-price {
        font-weight: bold;
        color: var(--primary-color);
        font-size: 1rem;
    }

    /* Order Totals */
    .order-totals {
        margin-top: 1.5rem;
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        padding: 1.5rem;
        border-radius: 12px;
        border: 1px solid rgba(147, 0, 0, 0.1);
    }

    .total-line {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        font-size: 1rem;
        color: var(--secondary-color);
    }

    .total-line.grand-total {
        font-size: 1.3rem;
        font-weight: bold;
        color: var(--primary-color);
        padding-top: 1rem;
        border-top: 2px solid rgba(147, 0, 0, 0.2);
        margin-top: 1rem;
    }

    .total-divider {
        height: 2px;
        background: rgba(147, 0, 0, 0.2);
        margin: 1rem 0;
        border-radius: 1px;
    }

    /* Coupon Section */
    .coupon-section {
        margin: 1rem 0;
        padding: 1rem;
        background: rgba(147, 0, 0, 0.02);
        border-radius: 8px;
        border: 1px solid rgba(147, 0, 0, 0.1);
    }

    .coupon-input-container {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .coupon-input-container input {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid rgba(147, 0, 0, 0.2);
        border-radius: 6px;
        font-size: 0.9rem;
        text-transform: uppercase;
        font-family: monospace;
        font-weight: 600;
    }

    .coupon-input-container input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(147, 0, 0, 0.1);
    }

    .apply-coupon-btn {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
    }

    .apply-coupon-btn:hover {
        background: #b91c1c;
        transform: translateY(-1px);
    }

    .apply-coupon-btn:disabled {
        background: #6b7280;
        cursor: not-allowed;
        transform: none;
    }

    .applied-coupon {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #dcfce7;
        border: 1px solid #bbf7d0;
        border-radius: 6px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .coupon-details {
        display: flex;
        flex-direction: column;
    }

    .coupon-name {
        font-weight: 600;
        color: #15803d;
        font-size: 0.9rem;
    }

    .coupon-code-display {
        font-family: monospace;
        font-size: 0.8rem;
        color: #374151;
        background: rgba(255, 255, 255, 0.8);
        padding: 0.2rem 0.4rem;
        border-radius: 3px;
        margin-top: 0.2rem;
        display: inline-block;
        width: fit-content;
    }

    .remove-coupon-btn {
        background: none;
        border: none;
        color: #dc2626;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 50%;
        transition: all 0.3s ease;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .remove-coupon-btn:hover {
        background: rgba(220, 38, 38, 0.1);
        transform: scale(1.1);
    }

    .coupon-message {
        padding: 0.5rem;
        border-radius: 6px;
        font-size: 0.85rem;
        text-align: center;
        margin-top: 0.5rem;
    }

    .coupon-message.success {
        background: #dcfce7;
        color: #15803d;
        border: 1px solid #bbf7d0;
    }

    .coupon-message.error {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
    }

    .total-line.discount {
        color: #059669;
        font-weight: 600;
    }

    /* Checkout Actions */
    .checkout-actions {
        margin-top: 2rem;
    }

    .place-order-btn {
        width: 100%;
        background: linear-gradient(135deg, var(--primary-color), #b91c1c);
        color: var(--white);
        border: none;
        padding: 1.25rem 2rem;
        border-radius: 12px;
        font-size: 1.2rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 6px 20px rgba(147, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
        animation: pulseButton 2s infinite;
    }

    .place-order-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.6s ease;
    }

    .place-order-btn:hover::before {
        left: 100%;
    }

    .place-order-btn::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.6s ease, height 0.6s ease;
    }

    .place-order-btn:active::after {
        width: 300px;
        height: 300px;
    }

    .place-order-btn:hover {
        background: linear-gradient(135deg, #b91c1c, var(--primary-color));
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 10px 30px rgba(147, 0, 0, 0.5);
        animation: none;
    }

    .place-order-btn:disabled {
        background: var(--secondary-color);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        animation: none;
    }

    .place-order-btn i {
        animation: lockShake 2s infinite;
        font-size: 1.3rem;
    }

    .place-order-btn:hover i {
        animation: lockRotate 0.5s ease;
    }

    /* পালস এনিমেশন - বাটনের জন্য */
    @keyframes pulseButton {
        0% {
            box-shadow: 0 6px 20px rgba(147, 0, 0, 0.3), 0 0 0 0 rgba(147, 0, 0, 0.7);
        }
        50% {
            box-shadow: 0 8px 25px rgba(147, 0, 0, 0.4), 0 0 0 10px rgba(147, 0, 0, 0.2);
        }
        100% {
            box-shadow: 0 6px 20px rgba(147, 0, 0, 0.3), 0 0 0 0 rgba(147, 0, 0, 0);
        }
    }

    /* লক আইকনের জন্য ছোট কাঁপানো এনিমেশন */
    @keyframes lockShake {
        0%, 50%, 100% {
            transform: rotate(0deg);
        }
        10%, 30% {
            transform: rotate(-3deg);
        }
        20%, 40% {
            transform: rotate(3deg);
        }
    }

    /* হোভারে লক আইকন ঘোরানো */
    @keyframes lockRotate {
        0% {
            transform: rotate(0deg);
        }
        25% {
            transform: rotate(-10deg);
        }
        75% {
            transform: rotate(10deg);
        }
        100% {
            transform: rotate(0deg);
        }
    }

    /* গ্লো ইফেক্ট বাটনের চারপাশে */
    .place-order-btn {
        position: relative;
    }

    .place-order-btn::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
        border-radius: 14px;
        opacity: 0;
        z-index: -1;
        background-size: 400%;
        animation: glowing 3s linear infinite;
        transition: opacity 0.3s ease;
    }

    .place-order-btn:hover::before {
        opacity: 1;
    }

    @keyframes glowing {
        0% {
            background-position: 0 0;
        }
        50% {
            background-position: 400% 0;
        }
        100% {
            background-position: 0 0;
        }
    }

    .security-badges {
        display: flex;
        justify-content: center;
        gap: 1rem;
    }

    .security-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--secondary-color);
        font-size: 0.9rem;
    }

    .security-badge i {
        color: var(--success-color);
    }

    /* Trust Badges */
    .trust-badges {
        background: var(--white);
        border-radius: 16px;
        box-shadow: 0 8px 25px rgba(147, 0, 0, 0.1);
        padding: 1.5rem;
        border: 1px solid rgba(147, 0, 0, 0.1);
    }

    .trust-badges h4 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 1rem;
        text-align: center;
        padding-bottom: 1rem;
        border-bottom: 2px solid rgba(147, 0, 0, 0.1);
    }

    .trust-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 8px;
        transition: var(--transition);
    }

    .trust-item:hover {
        background: rgba(147, 0, 0, 0.05);
    }

    .trust-item:last-child {
        margin-bottom: 0;
    }

    .trust-item i {
        font-size: 1.5rem;
        color: var(--primary-color);
        width: 30px;
        text-align: center;
        padding: 0.5rem;
        background: rgba(147, 0, 0, 0.1);
        border-radius: 8px;
    }

    .trust-item strong {
        display: block;
        color: var(--secondary-color);
        margin-bottom: 0.25rem;
        font-weight: 600;
    }

    .trust-item p {
        color: var(--secondary-color);
        font-size: 0.9rem;
        margin: 0;
        opacity: 0.8;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .checkout-grid {
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .order-summary-section {
            position: static;
        }

        .form-row {
            flex-direction: column;
        }

        .form-group.half,
        .form-group.quarter {
            flex: 1;
        }

        .payment-options {
            grid-template-columns: repeat(2, 1fr);
        }

        .location-options {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        .location-option label {
            padding: 1rem;
        }

        .location-option label i {
            font-size: 1.75rem;
        }
    }

    @media (max-width: 768px) {
        .page-title {
            font-size: 2rem;
        }

        .checkout-form-section,
        .order-summary {
            padding: 1.5rem;
        }

        .section-title {
            font-size: 1.25rem;
        }

        .shipping-option label {
            flex-direction: column;
            text-align: center;
            gap: 0.5rem;
        }

        .payment-options {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 480px) {
        .checkout-form-section,
        .order-summary,
        .trust-badges {
            padding: 1rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem;
        }

        .place-order-btn {
            padding: 1rem;
            font-size: 1.1rem;
        }

        .security-badges {
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .order-totals {
            padding: 1rem;
        }
    }
    
    @keyframes pointingAnimation {
        0% {
            transform: translateY(0) scale(1) rotate(0deg);
            opacity: 1;
        }
        25% {
            transform: translateY(-5px) scale(1.1) rotate(-5deg);
            opacity: 0.9;
        }
        50% {
            transform: translateY(-10px) scale(1.2) rotate(0deg);
            opacity: 0.8;
        }
        75% {
            transform: translateY(-5px) scale(1.1) rotate(5deg);
            opacity: 0.9;
        }
        100% {
            transform: translateY(0) scale(1) rotate(0deg);
            opacity: 1;
        }
    }

    /* অতিরিক্ত এনিমেশন */
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateY(0) scale(1);
        }
        40% {
            transform: translateY(-8px) scale(1.05);
        }
        60% {
            transform: translateY(-4px) scale(1.02);
        }
    }

    @keyframes clickPulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(0.95);
        }
        100% {
            transform: scale(1);
        }
    }

    /* ফর্ম কমপ্লিট হলে বিশেষ ইফেক্ট */
    .place-order-btn.form-complete {
        background: linear-gradient(135deg, #28a745, #20c997) !important;
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
    }

    .place-order-btn.form-complete:hover {
        background: linear-gradient(135deg, #20c997, #28a745) !important;
        transform: translateY(-4px) scale(1.05);
        box-shadow: 0 12px 35px rgba(40, 167, 69, 0.6);
    }

    /* পালসিং ডট ইন্ডিকেটর */
    .place-order-btn.form-complete::after {
        content: '';
        position: absolute;
        top: 10px;
        right: 10px;
        width: 8px;
        height: 8px;
        background: #fff;
        border-radius: 50%;
        animation: pulsingDot 1s infinite;
    }

    @keyframes pulsingDot {
        0%, 100% {
            opacity: 1;
            transform: scale(1);
        }
        50% {
            opacity: 0.5;
            transform: scale(1.2);
        }
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    /* Additional animations and effects */
    @keyframes pulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
        100% {
            transform: scale(1);
        }
    }
    
    .location-option:hover,
    .payment-option:hover,
    .shipping-option:hover {
        animation: pulse 0.3s ease-in-out;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Checkout customization data for JavaScript
    window.checkoutCustomization = {
        loadingCartMessage: '{{ checkout_customization.loading_cart_message|default:"Loading order items..." }}',
        loadingShippingMessage: '{{ checkout_customization.loading_shipping_message|default:"Loading shipping options..." }}',
        processingOrderMessage: '{{ checkout_customization.processing_order_message|default:"Processing..." }}',
        orderSuccessMessage: '{{ checkout_customization.order_success_message|default:"Order placed successfully!" }}',
        orderErrorMessage: '{{ checkout_customization.order_error_message|default:"Error processing order. Please try again." }}',
        validationErrorMessage: '{{ checkout_customization.validation_error_message|default:"Please check your information and try again." }}',
        bkashMerchantNumber: '{{ checkout_customization.bkash_merchant_number|default:"01XXXXXXXXX" }}',
        nagadMerchantNumber: '{{ checkout_customization.nagad_merchant_number|default:"01XXXXXXXXX" }}'
    };

    // Delivery estimates data for JavaScript
    window.deliveryEstimates = {
        dhaka: {
            dateRange: '{{ delivery_estimates.dhaka.date_range|default:"1-2 days" }}',
            areaLabel: '{{ delivery_estimates.dhaka.area_label|default:"Inside Dhaka City" }}'
        },
        outside: {
            dateRange: '{{ delivery_estimates.outside.date_range|default:"2-4 days" }}',
            areaLabel: '{{ delivery_estimates.outside.area_label|default:"Outside Dhaka City" }}'
        }
    };
    
    // Debug: Log delivery estimates to console
    console.log('Delivery Estimates Loaded:', window.deliveryEstimates);

    document.addEventListener('DOMContentLoaded', function() {
        loadOrderSummary();
        setupFormValidation();
        setupPaymentMethodToggle();
        setupLocationChangeListener();
        setupPhoneValidation();
        setupButtonAnimation();
        
        // বাটন এনিমেশন সেটআপ
        function setupButtonAnimation() {
            const placeOrderBtn = document.getElementById('place-order-btn');
            const form = document.getElementById('checkout-form');
            
            // ফর্ম ফিল্ড চেক করার জন্য
            const requiredFields = [
                'phone_number',
                'address'
            ];
            
            // ফর্মের অবস্থা চেক করা
            function checkFormCompletion() {
                let isFormComplete = true;
                
                // প্রয়োজনীয় ফিল্ড চেক
                requiredFields.forEach(fieldName => {
                    const field = document.getElementById(fieldName);
                    if (field && !field.value.trim()) {
                        isFormComplete = false;
                    }
                });
                
                // পেমেন্ট মেথড চেক
                const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
                if (!paymentMethod) {
                    isFormComplete = false;
                }
                
                // লোকেশন চেক
                const location = document.querySelector('input[name="location"]:checked');
                if (!location) {
                    isFormComplete = false;
                }
                
                // বাটনের ক্লাস আপডেট
                if (isFormComplete) {
                    placeOrderBtn.classList.add('form-complete');
                    placeOrderBtn.style.animation = 'pulseButton 1.5s infinite, bounce 2s infinite';
                    
                    // আঙ্গুল আইকন যোগ করা
                    addPointingFinger();
                    
                    // টুলটিপ দেখানো
                    if (!placeOrderBtn.dataset.tooltipAdded) {
                        placeOrderBtn.title = 'এখনি অর্ডার করুন! ✨';
                        placeOrderBtn.dataset.tooltipAdded = 'true';
                    }
                } else {
                    placeOrderBtn.classList.remove('form-complete');
                    placeOrderBtn.style.animation = 'pulseButton 2s infinite';
                    placeOrderBtn.title = 'প্রথমে সব তথ্য পূরণ করুন';
                    
                    // আঙ্গুল আইকন সরানো
                    removePointingFinger();
                }
            }
            
            // আঙ্গুল আইকন যোগ করার ফাংশন
            function addPointingFinger() {
                // যদি ইতিমধ্যে থাকে তাহলে রিটার্ন
                if (document.getElementById('pointing-finger')) return;
                
                // মূল পয়েন্টিং কন্টেইনার
                const pointingContainer = document.createElement('div');
                pointingContainer.id = 'pointing-finger';
                pointingContainer.style.cssText = `
                    position: absolute;
                    top: 30%;
                    left: 90%;
                    transform: translateX(-50%);
                    z-index: 10000;
                    pointer-events: none;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    gap: 8px;
                `;
                
                // আঙ্গুল আইকন
                const finger = document.createElement('div');
                finger.innerHTML = '👆';
                finger.style.cssText = `
                    font-size: 2rem;
                    animation: pointingAnimation 1.5s infinite ease-in-out;
                    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
                `;
                
                pointingContainer.appendChild(finger);
                
                // বাটনের পজিশন relative করা
                placeOrderBtn.style.position = 'relative';
                placeOrderBtn.appendChild(pointingContainer);
                
                // বাটনের চারপাশে বিশেষ গ্লো ইফেক্ট
                placeOrderBtn.style.boxShadow = `
                    0 8px 25px rgba(40, 167, 69, 0.5), 
                    0 0 0 3px rgba(40, 167, 69, 0.3),
                    0 0 30px rgba(40, 167, 69, 0.2)
                `;
                
                // অতিরিক্ত ব্যাকগ্রাউন্ড গ্লো
                const glowEffect = document.createElement('div');
                glowEffect.id = 'button-glow';
                glowEffect.style.cssText = `
                    position: absolute;
                    top: -10px;
                    left: -10px;
                    right: -10px;
                    bottom: -10px;
                    background: radial-gradient(circle, rgba(40, 167, 69, 0.3) 0%, transparent 70%);
                    border-radius: 20px;
                    z-index: -1;
                    opacity: 0.6;
                `;
                
                placeOrderBtn.appendChild(glowEffect);
            }
            
            // আঙ্গুল আইকন সরানোর ফাংশন
            function removePointingFinger() {
                const finger = document.getElementById('pointing-finger');
                const glow = document.getElementById('button-glow');
                
                if (finger) {
                    finger.remove();
                }
                if (glow) {
                    glow.remove();
                }
                
                // গ্লো ইফেক্ট সরানো
                placeOrderBtn.style.boxShadow = '0 6px 20px rgba(147, 0, 0, 0.3)';
            }
            
            // ইভেন্ট লিসেনার যোগ করা
            requiredFields.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                if (field) {
                    field.addEventListener('input', checkFormCompletion);
                    field.addEventListener('change', checkFormCompletion);
                }
            });
            
            // পেমেন্ট মেথড এবং লোকেশনের জন্য
            document.addEventListener('change', function(e) {
                if (e.target.name === 'payment_method' || e.target.name === 'location') {
                    checkFormCompletion();
                }
            });
            
            // প্রাথমিক চেক
            checkFormCompletion();
            
            // বাটনে ক্লিক ইফেক্ট
            placeOrderBtn.addEventListener('click', function(e) {
                if (!this.disabled) {
                    this.style.animation = 'clickPulse 0.3s ease';
                    setTimeout(() => {
                        this.style.animation = 'pulseButton 1.5s infinite, bounce 2s infinite';
                    }, 300);
                }
            });
        }
        
        // Setup location change listener
        function setupLocationChangeListener() {
            const locationRadios = document.querySelectorAll('input[name="location"]');
            locationRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        const selectedLocation = this.value;
                        console.log('Location changed to:', selectedLocation);
                        loadShippingOptions(selectedLocation);
                    }
                });
            });
        }
        
        // Load order summary
        function loadOrderSummary() {
            const locationRadio = document.querySelector('input[name="location"]:checked');
            const location = locationRadio ? locationRadio.value : 'dhaka';
            
            fetch(`/api/v1/cart/summary/?location=${location}`, {
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(cartData => {
                // Store order summary data globally for order placement
                window.orderSummaryData = cartData;
                
                displayOrderItems(cartData.items || []);
                updateOrderTotals(cartData);
                loadShippingOptions(location);
            })
            .catch(error => {
                console.error('Error loading cart:', error);
                document.getElementById('order-items').innerHTML = `
                    <div style="text-align: center; color: var(--danger-color); padding: 2rem;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading cart items</p>
                    </div>
                `;
            });
        }
        
        // Load shipping options based on location
        function loadShippingOptions(location = 'dhaka') {
            fetch(`/api/v1/cart/shipping-options/?location=${location}`, {
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.available_options) {
                    updateShippingOptions({ available_options: data.available_options });
                } else {
                    console.error('No shipping options received:', data);
                    showDefaultShippingOptions(location);
                }
            })
            .catch(error => {
                console.error('Error loading shipping options:', error);
                showDefaultShippingOptions(location);
            });
        }
        
        // Show default shipping options if API fails
        function showDefaultShippingOptions(location) {
            console.log('showDefaultShippingOptions called for location:', location);
            console.log('Using delivery estimates:', window.deliveryEstimates);
            
            const shippingContainer = document.getElementById('shipping-options');
            let optionsHtml = '';
            
            if (location === 'dhaka') {
                optionsHtml = `
                    <div class="shipping-option">
                        <input type="radio" id="standard_dhaka" name="shipping_method" value="standard" data-cost="70" checked>
                        <label for="standard_dhaka">
                            <div class="shipping-info">
                                <div class="shipping-name">Standard Shipping (${window.deliveryEstimates.dhaka.areaLabel})</div>
                                <div class="shipping-description">${window.deliveryEstimates.dhaka.dateRange}</div>
                            </div>
                            <div class="shipping-price">70৳</div>
                        </label>
                    </div>
                    <div class="shipping-option">
                        <input type="radio" id="express_dhaka" name="shipping_method" value="express" data-cost="150">
                        <label for="express_dhaka">
                            <div class="shipping-info">
                                <div class="shipping-name">Express Shipping (Same Day)</div>
                                <div class="shipping-description">Same day delivery</div>
                            </div>
                            <div class="shipping-price">150৳</div>
                        </label>
                    </div>
                `;
            } else {
                optionsHtml = `
                    <div class="shipping-option">
                        <input type="radio" id="standard_outside" name="shipping_method" value="standard" data-cost="120" checked>
                        <label for="standard_outside">
                            <div class="shipping-info">
                                <div class="shipping-name">Standard Shipping (${window.deliveryEstimates.outside.areaLabel})</div>
                                <div class="shipping-description">${window.deliveryEstimates.outside.dateRange}</div>
                            </div>
                            <div class="shipping-price">120৳</div>
                        </label>
                    </div>
                `;
            }
            
            console.log('Generated shipping options HTML:', optionsHtml);
            
            shippingContainer.innerHTML = optionsHtml;
            setupShippingMethodListeners();
            updateShippingCost();
        }
        
        function displayOrderItems(items) {
            const orderItemsContainer = document.getElementById('order-items');
            
            if (items.length === 0) {
                orderItemsContainer.innerHTML = `
                    <div style="text-align: center; color: var(--secondary-color); padding: 2rem;">
                        <p>No items in cart</p>
                        <a href="/" style="color: var(--primary-color);">Continue Shopping</a>
                    </div>
                `;
                return;
            }
            
            orderItemsContainer.innerHTML = items.map(item => {
                // Use flattened fields first, fall back to nested structure
                const productName = item.product_name || (item.product ? item.product.name : 'Unknown Product');
                const productImage = item.product_image || (item.product ? item.product.primary_image : null) || '/media/default.webp';
                
                // Extract variant information - use flattened fields first
                const variantName = item.variant_name || (item.variant ? item.variant.name : null);
                const variantColor = item.variant_color || (item.variant ? item.variant.color : null);
                const variantSize = item.variant_size || (item.variant ? item.variant.size : null);
                
                // Build variant display string
                let variantDisplay = '';
                if (variantName) {
                    variantDisplay = variantName;
                } else if (variantColor || variantSize) {
                    const parts = [];
                    if (variantColor) parts.push(variantColor);
                    if (variantSize) parts.push(variantSize);
                    variantDisplay = parts.join(', ');
                }
                
                return `
                    <div class="order-item">
                        <div class="item-thumbnail">
                            <img src="${productImage}" alt="${productName}" onerror="this.src='/media/default.webp'">
                        </div>
                        <div class="item-info">
                            <div class="item-name">${productName}</div>
                            ${variantDisplay ? `<div class="item-variant">${variantDisplay}</div>` : ''}
                        </div>
                        <div class="item-quantity">×${item.quantity}</div>
                        <div class="item-price">৳${item.total_price}</div>
                    </div>
                `;
            }).join('');
        }
        
        function updateOrderTotals(cartData) {
            const subtotal = parseFloat(cartData.subtotal || 0);
            const shippingMethod = document.querySelector('input[name="shipping_method"]:checked');
            let shipping = 0;
            
            if (shippingMethod && shippingMethod.dataset.cost) {
                shipping = parseFloat(shippingMethod.dataset.cost);
            }
            
            const tax = parseFloat(cartData.tax_amount || cartData.tax || 0);
            const discount = parseFloat(cartData.discount_amount || 0);
            const couponDiscount = parseFloat(cartData.coupon_discount || 0);
            const couponCode = cartData.coupon_code || '';
            
            const total = subtotal + shipping + tax - discount - couponDiscount;
            
            document.getElementById('order-subtotal').textContent = `৳${subtotal.toFixed(2)}`;
            document.getElementById('order-shipping').textContent = shipping === 0 ? 'FREE' : `৳${shipping}`;
            document.getElementById('order-tax').textContent = `৳${tax.toFixed(2)}`;
            document.getElementById('order-total').textContent = `৳${total.toFixed(2)}`;
            
            // Handle coupon display
            const discountLine = document.getElementById('discount-line');
            const orderDiscount = document.getElementById('order-discount');
            const appliedCoupon = document.getElementById('applied-coupon');
            const couponInputContainer = document.getElementById('coupon-input-container');
            
            if (couponDiscount > 0 && couponCode) {
                // Show applied coupon
                discountLine.style.display = 'flex';
                orderDiscount.textContent = `-৳${couponDiscount.toFixed(2)}`;
                
                // Show applied coupon details
                appliedCoupon.style.display = 'flex';
                document.getElementById('applied-coupon-name').textContent = `Coupon Applied`;
                document.getElementById('applied-coupon-code').textContent = couponCode;
                
                // Hide coupon input
                couponInputContainer.style.display = 'none';
            } else {
                // Hide discount line
                discountLine.style.display = 'none';
                appliedCoupon.style.display = 'none';
                couponInputContainer.style.display = 'flex';
            }
            
            // Update payment amounts
            updatePaymentAmount();
        }
        
        function updateShippingOptions(shippingSummary) {
            if (!shippingSummary || !shippingSummary.available_options) {
                return;
            }
            
            const shippingContainer = document.getElementById('shipping-options');
            if (!shippingContainer) return;
            
            // Clear existing options
            shippingContainer.innerHTML = '';
            
            // Add available shipping options
            shippingSummary.available_options.forEach((option, index) => {
                const isChecked = index === 0 ? 'checked' : '';
                const cost = option.cost == 0 ? 'FREE' : `${option.cost}৳`;
                
                const optionHtml = `
                    <div class="shipping-option">
                        <input type="radio" id="shipping_${option.type}_${index}" name="shipping_method" 
                               value="${option.type}" data-cost="${option.cost}" ${isChecked}>
                        <label for="shipping_${option.type}_${index}">
                            <div class="shipping-info">
                                <div class="shipping-name">${option.name}</div>
                                <div class="shipping-description">${option.estimated_days}</div>
                            </div>
                            <div class="shipping-price">${cost}</div>
                        </label>
                    </div>
                `;
                
                shippingContainer.insertAdjacentHTML('beforeend', optionHtml);
            });
            
            // Re-attach event listeners for new shipping options
            setupShippingMethodListeners();
            updateShippingCost();
        }
        
        function setupShippingMethodListeners() {
            document.querySelectorAll('input[name="shipping_method"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    updateShippingCost();
                });
            });
        }
        
        function updateShippingCost() {
            const subtotalElement = document.getElementById('order-subtotal');
            const subtotal = parseFloat(subtotalElement.textContent.replace('৳', '').replace(',', '')) || 0;
            
            const shippingMethod = document.querySelector('input[name="shipping_method"]:checked');
            let shipping = 0;
            
            if (shippingMethod && shippingMethod.dataset.cost) {
                shipping = parseFloat(shippingMethod.dataset.cost);
            }
            
            const tax = 0; // You can add tax calculation here
            
            // Check for applied coupon discount
            const discountElement = document.getElementById('order-discount');
            let couponDiscount = 0;
            if (discountElement && discountElement.textContent) {
                // Extract discount amount (remove -৳ and parse)
                couponDiscount = parseFloat(discountElement.textContent.replace('-৳', '').replace(',', '')) || 0;
            }
            
            const total = subtotal + shipping + tax - couponDiscount;
            
            document.getElementById('order-shipping').textContent = shipping === 0 ? 'FREE' : `৳${shipping}`;
            document.getElementById('order-total').textContent = `৳${total.toFixed(2)}`;
            
            updatePaymentAmount();
        }
        
        // Setup initial shipping method listeners (will be replaced when options load)
        setupShippingMethodListeners();
        
        // Payment method toggle
        function setupPaymentMethodToggle() {
            const paymentMethods = document.querySelectorAll('input[name="payment_method"]');
            const bkashForm = document.getElementById('bkash-form');
            const nagadForm = document.getElementById('nagad-form');
            const codForm = document.getElementById('cod-form');
            
            paymentMethods.forEach(method => {
                method.addEventListener('change', function() {
                    // Hide all payment forms
                    bkashForm.style.display = 'none';
                    nagadForm.style.display = 'none';
                    codForm.style.display = 'none';
                    
                    // Show the selected payment form
                    switch(this.value) {
                        case 'bkash':
                            bkashForm.style.display = 'block';
                            updatePaymentAmount();
                            break;
                        case 'nagad':
                            nagadForm.style.display = 'block';
                            updatePaymentAmount();
                            break;
                        case 'cod':
                            codForm.style.display = 'block';
                            updatePaymentAmount();
                            break;
                    }
                });
            });
        }
        
        // Update payment amount in forms
        function updatePaymentAmount() {
            const totalElement = document.getElementById('order-total');
            const total = totalElement ? totalElement.textContent : '$0.00';
            
            const bkashAmount = document.getElementById('bkash-amount');
            const nagadAmount = document.getElementById('nagad-amount');
            const codAmount = document.getElementById('cod-amount');
            
            if (bkashAmount) bkashAmount.textContent = total;
            if (nagadAmount) nagadAmount.textContent = total;
            if (codAmount) codAmount.textContent = total;
        }
        
        // Form validation
        function setupFormValidation() {
            const form = document.getElementById('checkout-form');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (validateForm()) {
                    processOrder();
                }
            });
        }
        
        // Phone number validation and normalization
        function convertBanglaToEnglishDigits(text) {
            if (!text) return '';
            
            const banglaToEnglish = {
                '০': '0', '১': '1', '২': '2', '৩': '3', '৪': '4',
                '৫': '5', '৬': '6', '৭': '7', '৮': '8', '৯': '9'
            };
            
            // Convert each Bangla digit to English
            for (const [bangla, english] of Object.entries(banglaToEnglish)) {
                text = text.replace(new RegExp(bangla, 'g'), english);
            }
            
            return text;
        }
        
        function normalizePhoneNumber(phone) {
            if (!phone) return '';
            
            // First convert Bangla digits to English digits
            phone = convertBanglaToEnglishDigits(phone);
            
            // Remove all non-digit characters
            let digits = phone.replace(/\D/g, '');
            
            // Handle different formats
            if (digits.startsWith('880')) {
                // Remove country code 880 and add 0 prefix
                digits = '0' + digits.substring(3);
            } else if (digits.startsWith('88')) {
                // Remove country code 88 and add 0 prefix  
                digits = '0' + digits.substring(2);
            } else if (!digits.startsWith('0')) {
                // Add 0 prefix if not present
                digits = '0' + digits;
            }
            
            return digits;
        }
        
        function validatePhoneNumber(phone) {
            const normalized = normalizePhoneNumber(phone);
            
            // Check if normalized phone has at least 11 digits
            if (normalized.length < 11) {
                return {
                    isValid: false,
                    normalized: normalized,
                    error: 'নাম্বার ভূল হয়েছে। ১১ ডিজিটের সঠিক নাম্বার দিন।'
                };
            }
            
            // Check if it's a valid Bangladesh number (starts with 01)
            if (!normalized.startsWith('01')) {
                return {
                    isValid: false,
                    normalized: normalized,
                    error: 'দয়া করে একটি বৈধ বাংলাদেশী ফোন নম্বর দিন'
                };
            }
            
            // Limit to 11 digits for Bangladesh mobile numbers
            const finalNumber = normalized.substring(0, 11);
            
            return {
                isValid: true,
                normalized: finalNumber,
                error: null
            };
        }
        
        // Setup phone number validation
        function setupPhoneValidation() {
            const phoneFields = [
                'phone_number',
                'bkash_sender_number', 
                'nagad_sender_number'
            ];
            
            phoneFields.forEach(fieldId => {
                const phoneField = document.getElementById(fieldId);
                const phoneError = document.getElementById(fieldId + '_error');
                
                if (phoneField) {
                    // Real-time validation and conversion as user types
                    phoneField.addEventListener('input', function() {
                        // Convert Bangla digits to English in real-time
                        const originalValue = this.value;
                        const convertedValue = convertBanglaToEnglishDigits(originalValue);
                        
                        // Update field value if conversion happened
                        if (originalValue !== convertedValue) {
                            // Store cursor position
                            const cursorPosition = this.selectionStart;
                            this.value = convertedValue;
                            // Restore cursor position
                            this.setSelectionRange(cursorPosition, cursorPosition);
                        }
                        
                        // Validate the converted phone number
                        const validation = validatePhoneNumber(this.value);
                        
                        if (this.value && !validation.isValid) {
                            if (phoneError) {
                                showFieldError(phoneField, phoneError, validation.error);
                            } else {
                                phoneField.style.borderColor = 'var(--danger-color)';
                            }
                        } else {
                            if (phoneError) {
                                hideFieldError(phoneField, phoneError);
                            } else {
                                phoneField.style.borderColor = 'var(--border-color)';
                            }
                        }
                    });
                    
                    // Normalize on blur
                    phoneField.addEventListener('blur', function() {
                        if (this.value) {
                            // Convert Bangla digits first
                            this.value = convertBanglaToEnglishDigits(this.value);
                            
                            const validation = validatePhoneNumber(this.value);
                            this.value = validation.normalized;
                            
                            if (!validation.isValid) {
                                if (phoneError) {
                                    showFieldError(phoneField, phoneError, validation.error);
                                } else {
                                    phoneField.style.borderColor = 'var(--danger-color)';
                                }
                            } else {
                                if (phoneError) {
                                    hideFieldError(phoneField, phoneError);
                                } else {
                                    phoneField.style.borderColor = 'var(--border-color)';
                                }
                            }
                        }
                    });
                }
            });
        }
        
        function validateForm() {
            let isValid = true;
            
            // Required fields
            const requiredFields = [
                'phone_number'
            ];
            
            requiredFields.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                const errorElement = document.getElementById(fieldName + '_error');
                
                if (field && !field.value.trim()) {
                    showFieldError(field, errorElement, 'This field is required');
                    isValid = false;
                } else if (field && errorElement) {
                    hideFieldError(field, errorElement);
                }
            });
            
            // Phone number validation
            const phoneField = document.getElementById('phone_number');
            const phoneError = document.getElementById('phone_number_error');
            
            if (phoneField && phoneField.value) {
                const validation = validatePhoneNumber(phoneField.value);
                if (!validation.isValid) {
                    showFieldError(phoneField, phoneError, validation.error);
                    isValid = false;
                } else {
                    // Update field with normalized value
                    phoneField.value = validation.normalized;
                    hideFieldError(phoneField, phoneError);
                }
            }
            
            // Email validation
            const emailField = document.getElementById('email');
            const emailError = document.getElementById('email_error');
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (emailField && emailField.value && !emailPattern.test(emailField.value)) {
                showFieldError(emailField, emailError, 'Please enter a valid email address');
                isValid = false;
            }
            
            // Payment method validation
            const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
            if (paymentMethod) {
                switch(paymentMethod.value) {
                    case 'bkash':
                        // Validate bKash sender number
                        const bkashSenderField = document.getElementById('bkash_sender_number');
                        const bkashTransactionField = document.getElementById('bkash_transaction_id');
                        
                        if (bkashSenderField && !bkashSenderField.value.trim()) {
                            bkashSenderField.style.borderColor = 'var(--danger-color)';
                            isValid = false;
                        } else if (bkashSenderField) {
                            const validation = validatePhoneNumber(bkashSenderField.value);
                            if (!validation.isValid) {
                                bkashSenderField.style.borderColor = 'var(--danger-color)';
                                isValid = false;
                            } else {
                                bkashSenderField.value = validation.normalized;
                                bkashSenderField.style.borderColor = 'var(--border-color)';
                            }
                        }
                        
                        if (bkashTransactionField && !bkashTransactionField.value.trim()) {
                            bkashTransactionField.style.borderColor = 'var(--danger-color)';
                            isValid = false;
                        } else if (bkashTransactionField) {
                            bkashTransactionField.style.borderColor = 'var(--border-color)';
                        }
                        break;
                        
                    case 'nagad':
                        // Validate Nagad sender number
                        const nagadSenderField = document.getElementById('nagad_sender_number');
                        const nagadTransactionField = document.getElementById('nagad_transaction_id');
                        
                        if (nagadSenderField && !nagadSenderField.value.trim()) {
                            nagadSenderField.style.borderColor = 'var(--danger-color)';
                            isValid = false;
                        } else if (nagadSenderField) {
                            const validation = validatePhoneNumber(nagadSenderField.value);
                            if (!validation.isValid) {
                                nagadSenderField.style.borderColor = 'var(--danger-color)';
                                isValid = false;
                            } else {
                                nagadSenderField.value = validation.normalized;
                                nagadSenderField.style.borderColor = 'var(--border-color)';
                            }
                        }
                        
                        if (nagadTransactionField && !nagadTransactionField.value.trim()) {
                            nagadTransactionField.style.borderColor = 'var(--danger-color)';
                            isValid = false;
                        } else if (nagadTransactionField) {
                            nagadTransactionField.style.borderColor = 'var(--border-color)';
                        }
                        break;
                        
                    case 'cod':
                        // No additional validation needed for COD
                        break;
                }
            }
            
            return isValid;
        }
        
        function showFieldError(field, errorElement, message) {
            if (field) field.style.borderColor = 'var(--danger-color)';
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }
        
        function hideFieldError(field, errorElement) {
            if (field) field.style.borderColor = 'var(--border-color)';
            if (errorElement) errorElement.style.display = 'none';
        }
        
        function processOrder() {
            const placeOrderBtn = document.getElementById('place-order-btn');
            const originalText = placeOrderBtn.innerHTML;
            placeOrderBtn.disabled = true;
            placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + window.checkoutCustomization.processingOrderMessage;
            
            // Collect form data
            const formData = new FormData(document.getElementById('checkout-form'));
            
            // Get selected shipping option
            const selectedShippingMethod = document.querySelector('input[name="shipping_method"]:checked');
            const selectedLocationRadio = document.querySelector('input[name="location"]:checked');
            const selectedLocation = selectedLocationRadio ? selectedLocationRadio.value : 'dhaka';
            
            // Get selected payment method
            const selectedPaymentMethod = document.querySelector('input[name="payment_method"]:checked');
            const paymentMethod = selectedPaymentMethod ? selectedPaymentMethod.value : 'cod';
            
            // Get payment method display name
            let paymentMethodDisplayName = '';
            if (selectedPaymentMethod) {
                const label = selectedPaymentMethod.nextElementSibling;
                paymentMethodDisplayName = label ? label.textContent.trim() : '';
            }
            
            // Get applied coupon from the current cart summary
            let appliedCouponCode = '';
            
            // Check for coupon information in the order summary
            const orderSummaryData = window.orderSummaryData || {};
            if (orderSummaryData.coupon_code) {
                appliedCouponCode = orderSummaryData.coupon_code;
            }
            
            console.log('Applied coupon code:', appliedCouponCode);
            
            // Prepare order data in the expected format for CreateOrderSerializer
            const orderData = {
                shipping_address: {
                    first_name: formData.get('full_name') ? formData.get('full_name').split(' ')[0] || 'Customer' : 'Customer',
                    last_name: formData.get('full_name') ? formData.get('full_name').split(' ').slice(1).join(' ') || '' : '',
                    company: '',
                    address_line_1: formData.get('address') || 'Address not provided',
                    address_line_2: '',
                    city: 'Dhaka',
                    state: 'Dhaka',
                    postal_code: '1000',
                    country: 'Bangladesh',
                    phone: formData.get('phone_number') || '',
                    email: formData.get('email') || '',
                    delivery_instructions: formData.get('order_instruction') || ''
                },
                customer_notes: formData.get('order_instruction') || '',
                coupon_code: appliedCouponCode,
                shipping_option: selectedShippingMethod ? selectedShippingMethod.value : '',
                shipping_location: selectedLocation || 'dhaka',
                // Include guest order fields
                guest_email: formData.get('email') || '',
                guest_phone: formData.get('phone_number') || '',
                // Payment method data
                payment_method: paymentMethod,
                payment_method_display_name: paymentMethodDisplayName,
                bkash_transaction_id: formData.get('bkash_transaction_id') || '',
                bkash_sender_number: formData.get('bkash_sender_number') || '',
                nagad_transaction_id: formData.get('nagad_transaction_id') || '',
                nagad_sender_number: formData.get('nagad_sender_number') || ''
            };
            
            console.log('Order data being sent:', orderData);
            
            // Create order via API
            fetch('/api/v1/orders/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Order creation response:', data);
                
                if (data.error || data.errors) {
                    let errorMessage = data.error || data.detail || 'Please check your information and try again.';
                    
                    // If there are detailed validation errors, show them
                    if (data.errors) {
                        console.log('Validation errors:', data.errors);
                        if (typeof data.errors === 'object') {
                            const errorDetails = [];
                            for (const [field, errors] of Object.entries(data.errors)) {
                                if (Array.isArray(errors)) {
                                    errorDetails.push(`${field}: ${errors.join(', ')}`);
                                } else {
                                    errorDetails.push(`${field}: ${errors}`);
                                }
                            }
                            errorMessage += '<br>' + errorDetails.join('<br>');
                        }
                    }
                    
                    // Check if it's an authentication error
                    if (errorMessage.includes('Authentication required') || errorMessage.includes('unauthorized')) {
                        // For guest orders, we don't redirect to login
                        console.log('Guest order attempted, proceeding without authentication requirement');
                    }
                    
                    showNotification('Order failed: ' + errorMessage, 'error');
                    console.error('Order errors:', data);
                } else if (data.order && data.order.order_number) {
                    console.log('Order created successfully:', data.order.order_number);
                    // Success - clear cart and redirect to order confirmation
                    showNotification(window.checkoutCustomization.orderSuccessMessage, 'success');
                    
                    // Clear the cart
                    fetch('/api/v1/cart/clear/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    }).then(() => {
                        setTimeout(() => {
                            window.location.href = `/orders/${data.order.order_number}/`;
                        }, 1500);
                    });
                } else {
                    console.log('Unexpected response structure:', data);
                    showNotification('Order created but confirmation failed. Please check your orders.', 'warning');
                    setTimeout(() => {
                        window.location.href = '/orders/';
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error processing order:', error);
                showNotification(window.checkoutCustomization.orderErrorMessage, 'error');
            })
            .finally(() => {
                placeOrderBtn.disabled = false;
                placeOrderBtn.innerHTML = originalText;
            });
        }
        
        // Utility functions
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <div>${message}</div>
            `;
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : '#dc3545'};
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                display: flex;
                align-items: flex-start;
                gap: 10px;
                font-weight: 600;
                animation: slideIn 0.3s ease;
                max-width: 400px;
                word-wrap: break-word;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000); // Show for 5 seconds for error messages
        }
        
        // ====== CHECKOUT ABANDONMENT TRACKING ======
        
        let checkoutDataCache = {};
        let saveTimeout = null;
        let isFormSubmitting = false;
        
        // Function to get current form data
        function getCheckoutData() {
            return {
                full_name: document.getElementById('full_name')?.value || '',
                email: document.getElementById('email')?.value || '',
                phone_number: document.getElementById('phone_number')?.value || '',
                address: document.getElementById('address')?.value || '',
                order_instruction: document.getElementById('order_instruction')?.value || '',
                timestamp: new Date().toISOString()
            };
        }
        
        // Function to save checkout data to session
        function saveCheckoutData() {
            if (isFormSubmitting) return; // Don't save if form is being submitted
            
            const currentData = getCheckoutData();
            
            // Only save if data has changed or is significant
            if (JSON.stringify(currentData) === JSON.stringify(checkoutDataCache)) {
                return; // No changes
            }
            
            // Check if we have at least email or name filled
            if (!currentData.email && !currentData.full_name) {
                return; // Not enough data to be worth saving
            }
            
            checkoutDataCache = currentData;
            
            fetch('/api/incomplete-orders/save-checkout-data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                },
                body: JSON.stringify(currentData)
            }).catch(error => {
                console.log('Could not save checkout data:', error);
            });
        }
        
        // Function to track abandonment
        function trackAbandonmentIfNeeded() {
            if (isFormSubmitting) return; // Don't track if form is being submitted
            
            const currentData = getCheckoutData();
            
            // Only track if we have meaningful data
            if (!currentData.email && !currentData.full_name) {
                return;
            }
            
            fetch('/api/incomplete-orders/track-abandonment/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                }
            }).catch(error => {
                console.log('Could not track abandonment:', error);
            });
        }
        
        // Add event listeners to form fields for real-time saving
        const formFields = ['full_name', 'email', 'phone_number', 'address', 'order_instruction'];
        
        formFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                // Save data when user stops typing (debounced)
                field.addEventListener('input', function() {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(saveCheckoutData, 1000); // Save after 1 second of no typing
                });
                
                // Save immediately when field loses focus
                field.addEventListener('blur', saveCheckoutData);
            }
        });
        
        // Track when form is being submitted to prevent false abandonment tracking
        const checkoutForm = document.getElementById('checkout-form');
        if (checkoutForm) {
            checkoutForm.addEventListener('submit', function() {
                isFormSubmitting = true;
            });
        }
        
        // Track abandonment on page unload events
        window.addEventListener('beforeunload', function(e) {
            if (!isFormSubmitting) {
                trackAbandonmentIfNeeded();
            }
        });
        
        // Track abandonment when page becomes hidden (mobile browsers)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden' && !isFormSubmitting) {
                trackAbandonmentIfNeeded();
            }
        });
        
        // Track abandonment when user navigates away (modern browsers)
        window.addEventListener('pagehide', function(e) {
            if (!isFormSubmitting) {
                trackAbandonmentIfNeeded();
            }
        });
        
        // For older browsers, also track on window unload
        window.addEventListener('unload', function(e) {
            if (!isFormSubmitting) {
                trackAbandonmentIfNeeded();
            }
        });
        
        console.log('✅ Checkout abandonment tracking initialized');
        
        // Coupon functionality
        function setupCouponHandlers() {
            const applyCouponBtn = document.getElementById('apply-coupon-btn');
            const removeCouponBtn = document.getElementById('remove-coupon-btn');
            const couponCodeInput = document.getElementById('coupon-code');
            
            if (applyCouponBtn) {
                applyCouponBtn.addEventListener('click', applyCoupon);
            }
            
            if (removeCouponBtn) {
                removeCouponBtn.addEventListener('click', removeCoupon);
            }
            
            if (couponCodeInput) {
                couponCodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        applyCoupon();
                    }
                });
                
                // Auto-uppercase coupon code
                couponCodeInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.toUpperCase();
                });
            }
        }
        
        function applyCoupon() {
            const couponCodeInput = document.getElementById('coupon-code');
            const applyCouponBtn = document.getElementById('apply-coupon-btn');
            const couponMessage = document.getElementById('coupon-message');
            
            const code = couponCodeInput.value.trim().toUpperCase();
            
            if (!code) {
                showCouponMessage('Please enter a coupon code', 'error');
                return;
            }
            
            // Disable button and show loading
            applyCouponBtn.disabled = true;
            applyCouponBtn.textContent = 'Applying...';
            
            fetch('/api/v1/cart/apply-coupon/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin',
                body: JSON.stringify({ code: code })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    showCouponMessage(data.message, 'success');
                    showNotification(data.message, 'success');
                    
                    // Clear input and reload order summary
                    couponCodeInput.value = '';
                    setTimeout(() => {
                        loadOrderSummary();
                    }, 500);
                } else if (data.error) {
                    showCouponMessage(data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error applying coupon:', error);
                showCouponMessage('Error applying coupon. Please try again.', 'error');
            })
            .finally(() => {
                // Re-enable button
                applyCouponBtn.disabled = false;
                applyCouponBtn.textContent = 'Apply';
            });
        }
        
        function removeCoupon() {
            fetch('/api/v1/cart/remove-coupon/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    showNotification(data.message, 'success');
                    loadOrderSummary();
                } else if (data.error) {
                    showNotification(data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error removing coupon:', error);
                showNotification('Error removing coupon. Please try again.', 'error');
            });
        }
        
        function showCouponMessage(message, type) {
            const couponMessage = document.getElementById('coupon-message');
            couponMessage.textContent = message;
            couponMessage.className = `coupon-message ${type}`;
            couponMessage.style.display = 'block';
            
            // Hide message after 5 seconds
            setTimeout(() => {
                couponMessage.style.display = 'none';
            }, 5000);
        }
        
        function showNotification(message, type = 'success') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : '#dc3545'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // Initialize coupon handlers
        setupCouponHandlers();
        
    });
</script>
{% endblock %}
