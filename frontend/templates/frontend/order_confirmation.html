{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}Order Confirmation - Professional eCommerce{% endblock %}

{% block content %}
    <div class="container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <a href="{% url 'frontend:home' %}">Home</a>
            <span class="breadcrumb-separator">/</span>
            <span class="current">Order Confirmation</span>
        </nav>

        <div class="order-confirmation-page">
            <!-- Success Header -->
            <div class="success-header">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h1 class="success-title">Order Placed Successfully!</h1>
                <p class="success-subtitle">Thank you for your order. We'll send you a confirmation email shortly.</p>
            </div>

            <!-- Order Details -->
            <div class="order-details-section">
                <div class="order-summary-card">
                    <div class="card-header">
                        <h2>Order Invoice</h2>
                        <div class="order-number">Order #{{ order.order_number }}</div>
                    </div>

                    <div class="card-body">
                        <!-- Order Info -->
                        <div class="order-info-grid">
                            <div class="info-item">
                                <span class="label">Order Date:</span>
                                <span class="value">{{ order.created_at|date:"F j, Y" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Order Status:</span>
                                <span class="value status-{{ order.status|lower }}">{{ order.status|title }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Payment Method:</span>
                                <div class="value payment-method-details">
                                    <div class="payment-method-name">{{ order.payment_method_display_name|default:order.get_payment_method_display }}</div>
                                    {% if order.payment_method == 'bkash' and order.bkash_transaction_id %}
                                        <div class="payment-details">
                                            <small class="payment-account">Account: {{ order.bkash_sender_number }}</small>
                                            <small class="payment-transaction">TxnID: {{ order.bkash_transaction_id }}</small>
                                        </div>
                                    {% elif order.payment_method == 'nagad' and order.nagad_transaction_id %}
                                        <div class="payment-details">
                                            <small class="payment-account">Account: {{ order.nagad_sender_number }}</small>
                                            <small class="payment-transaction">TxnID: {{ order.nagad_transaction_id }}</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="info-item">
                                <span class="label">Total Amount:</span>
                                <span class="value order-total-amount">à§³{{ order.total_amount|floatformat:2 }}</span>
                            </div>
                        </div>

                        <!-- Order Items -->
                        <div class="order-items-section">
                            <h3>Items Ordered</h3>
                            <div class="items-list">
                                {% for item in order.items.all %}
                                <div class="order-item">
                                    <div class="item-image">
                                        {% if item.variant and item.variant.image %}
                                            <img src="{{ item.variant.image_url }}" alt="{{ item.product.name }} - {{ item.variant.color_name|default:item.variant.size }}" onerror="this.src='{% if item.product.images.first %}{{ item.product.images.first.image_url }}{% else %}/media/default.webp{% endif %}'">
                                        {% elif item.product.images.first %}
                                            <img src="{{ item.product.images.first.image_url }}" alt="{{ item.product.name }}" onerror="this.src='/media/default.webp'">
                                        {% else %}
                                            <img src="/media/default.webp" alt="{{ item.product.name }}">
                                        {% endif %}
                                    </div>
                                    <div class="item-details">
                                        <h4 class="item-name">{{ item.product.name }}</h4>
                                        {% if item.variant %}
                                            {% if item.variant.sku %}
                                                <div class="item-sku">SKU: {{ item.variant.sku }}</div>
                                            {% endif %}
                                        {% else %}
                                            {% if item.product.sku %}
                                                <div class="item-sku">SKU: {{ item.product.sku }}</div>
                                            {% endif %}
                                        {% endif %}
                                        <div class="item-price">
                                            <span class="unit-price">à§³{{ item.unit_price }} each</span>
                                            <span class="quantity">Qty: {{ item.quantity }}</span>
                                        </div>
                                    </div>
                                    <div class="item-total">
                                        à§³{{ item.total_price }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Order Totals -->
                        <div class="order-totals">
                            <div class="total-line">
                                <span>Subtotal:</span>
                                <span>à§³{{ order.subtotal|floatformat:2 }}</span>
                            </div>
                            <div class="total-line">
                                <span>Shipping:</span>
                                <span>à§³{{ order.shipping_cost|default:"0.00" }}</span>
                            </div>
                            {% if order.coupon_discount and order.coupon_discount > 0 %}
                            <div class="total-line coupon-discount">
                                <span>Coupon Discount {% if order.coupon_code %}({{ order.coupon_code }}){% endif %}:</span>
                                <span class="discount-amount">-à§³{{ order.coupon_discount|floatformat:2 }}</span>
                            </div>
                            {% endif %}
                            <div class="total-divider"></div>
                            <div class="total-line grand-total">
                                <span>Total:</span>
                                <span class="order-total-amount">à§³{{ order.total_amount|floatformat:2 }}</span>
                            </div>
                        </div>

                        <!-- Shipping Address -->
                        {% if order.shipping_address %}
                        <div class="shipping-address-section">
                            <h3>Shipping Address</h3>
                            <div class="address-card">
                                <div class="address-name">
                                    {{ order.shipping_address.first_name }} {{ order.shipping_address.last_name }}
                                </div>
                                <div class="address-details">
                                    {{ order.shipping_address.address_line_1 }}<br>
                                    {% if order.shipping_address.address_line_2 %}
                                        {{ order.shipping_address.address_line_2 }}<br>
                                    {% endif %}
                                    <!-- {% if order.shipping_address.city %}{{ order.shipping_address.city }}, {% endif %}
                                    {% if order.shipping_address.state %}{{ order.shipping_address.state }} {% endif %}
                                    {% if order.shipping_address.postal_code %}{{ order.shipping_address.postal_code }}{% endif %}
                                    {% if order.shipping_address.country %}<br>{{ order.shipping_address.country }}{% endif %} -->
                                </div>
                                {% if order.shipping_address.phone %}
                                <div class="address-phone">
                                    <i class="fas fa-phone"></i> {{ order.shipping_address.phone }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Save Order Invoice Section -->
                <div class="save-invoice-section">
                    <h3>Save Order Invoice</h3>
                    <p>Download your invoice for your records</p>
                    <div class="save-options">
                        <button onclick="saveAsPDF()" class="btn btn-save-pdf">
                            <i class="fas fa-file-pdf"></i>
                            Save as PDF
                        </button>
                        <button onclick="saveAsImage()" class="btn btn-save-image">
                            <i class="fas fa-image"></i>
                            Save as Image
                        </button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <a href="{% url 'frontend:home' %}" class="btn btn-primary">
                        <i class="fas fa-home"></i>
                        Continue Shopping
                    </a>
                </div>

                <!-- What's Next -->
                <div class="whats-next-section">
                    <h3>What's Next?</h3>
                    <div class="next-steps">
                        <div class="step">
                            <div class="step-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="step-content">
                                <h4>Confirmation Email</h4>
                                <p>You'll receive an order confirmation email with tracking details within 24 hours.</p>
                            </div>
                        </div>
                        <div class="step">
                            <div class="step-icon">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="step-content">
                                <h4>Processing</h4>
                                <p>We'll start processing your order within 1-2 business days.</p>
                            </div>
                        </div>
                        <div class="step">
                            <div class="step-icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="step-content">
                                <h4>Shipping</h4>
                                <p>Your order will be shipped according to the delivery method you selected.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
<style>
    /* Page Layout */
    .order-confirmation-page {
        padding: 2rem 0;
        min-height: 80vh;
    }

    /* Success Header */
    .success-header {
        text-align: center;
        margin-bottom: 3rem;
        padding: 3rem 0;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
    }

    .success-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.9;
    }

    .success-title {
        font-size: 2.5rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .success-subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
        max-width: 600px;
        margin: 0 auto;
    }

    /* Order Details Section */
    .order-details-section {
        max-width: 800px;
        margin: 0 auto;
    }

    .order-summary-card {
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .card-header {
        background: var(--light-color);
        padding: 2rem;
        border-bottom: 2px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .card-header h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--dark-color);
        margin: 0;
    }

    .order-number {
        background: var(--primary-color);
        color: var(--white);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .card-body {
        padding: 2rem;
    }

    /* Order Info Grid */
    .order-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: var(--light-color);
        border-radius: var(--border-radius);
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .info-item .label {
        color: var(--secondary-color);
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-item .value {
        color: var(--dark-color);
        font-weight: 600;
        font-size: 1rem;
    }

    /* Payment Method Details Styling */
    .payment-method-details {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .payment-method-name {
        font-weight: 600;
        color: var(--dark-color);
    }

    .payment-details {
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
        margin-top: 0.25rem;
    }

    .payment-account,
    .payment-transaction {
        color: var(--secondary-color);
        font-size: 0.85rem;
        font-weight: 500;
    }

    .payment-transaction {
        color: var(--primary-color);
        font-weight: 600;
    }

    .total-amount {
        color: var(--primary-color) !important;
        font-size: 1.25rem !important;
    }

    .status-pending {
        color: #856404 !important;
    }

    .status-processing {
        color: #0c5460 !important;
    }

    .status-shipped {
        color: #155724 !important;
    }

    /* Order Items */
    .order-items-section {
        margin-bottom: 2rem;
    }

    .order-items-section h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 0.5rem;
    }

    .items-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .order-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: var(--light-color);
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
    }

    .item-image {
        width: 80px;
        height: 80px;
        border-radius: var(--border-radius);
        overflow: hidden;
        background: var(--white);
        flex-shrink: 0;
    }

    .item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .item-details {
        flex: 1;
    }

    .item-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 0.5rem;
    }

    .item-variant {
        color: var(--secondary-color);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }

    .item-sku {
        color: var(--primary-color);
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        background: rgba(var(--primary-color-rgb, 147, 0, 0), 0.1);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        display: inline-block;
    }

    .item-price {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 0.9rem;
    }

    .unit-price {
        color: var(--secondary-color);
    }

    .quantity {
        background: var(--primary-color);
        color: var(--white);
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-weight: 600;
        font-size: 0.8rem;
    }

    .item-total {
        font-size: 1.25rem;
        font-weight: bold;
        color: var(--primary-color);
        text-align: right;
    }

    /* Order Totals */
    .order-totals {
        margin-top: 2rem;
        padding: 1.5rem;
        background: var(--light-color);
        border-radius: var(--border-radius);
    }

    .total-line {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        font-size: 1rem;
    }

    .total-line.grand-total {
        font-size: 1.3rem;
        font-weight: bold;
        color: var(--primary-color);
    }

    .total-line.coupon-discount {
        color: #28a745;
        font-weight: 600;
    }

    .discount-amount {
        color: #28a745;
        font-weight: bold;
    }

    .total-divider {
        height: 2px;
        background: var(--border-color);
        margin: 1rem 0;
    }

    /* Shipping Address */
    .shipping-address-section {
        margin-top: 2rem;
    }

    .shipping-address-section h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 0.5rem;
    }

    .address-card {
        background: var(--light-color);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
    }

    .address-name {
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }

    .address-details {
        color: var(--secondary-color);
        line-height: 1.6;
        margin-bottom: 0.5rem;
    }

    .address-phone {
        color: var(--primary-color);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin: 2rem 0;
        flex-wrap: wrap;
    }

    .btn {
        padding: 1rem 2rem;
        border: none;
        border-radius: var(--border-radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1rem;
    }

    .btn-primary {
        background: var(--primary-color);
        color: var(--white);
    }

    .btn-primary:hover {
        background: #0056b3;
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
        background: var(--secondary-color);
        color: var(--white);
    }

    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }

    /* Save Invoice Section */
    .save-invoice-section {
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 2rem;
        margin: 2rem 0;
        text-align: center;
        border: 2px solid var(--primary-color);
    }

    .save-invoice-section h3 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }

    .save-invoice-section p {
        color: var(--secondary-color);
        margin-bottom: 1.5rem;
        font-size: 1rem;
    }

    .save-options {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .btn-save-pdf {
        background: #dc3545;
        color: var(--white);
        border: 2px solid #dc3545;
    }

    .btn-save-pdf:hover {
        background: #c82333;
        border-color: #c82333;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }

    .btn-save-image {
        background: #28a745;
        color: var(--white);
        border: 2px solid #28a745;
    }

    .btn-save-image:hover {
        background: #218838;
        border-color: #218838;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }

    /* What's Next Section */
    .whats-next-section {
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 2rem;
        margin-top: 2rem;
    }

    .whats-next-section h3 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 2rem;
        text-align: center;
    }

    .next-steps {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 2rem;
    }

    .step {
        text-align: center;
    }

    .step-icon {
        width: 80px;
        height: 80px;
        background: var(--primary-color);
        color: var(--white);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        margin: 0 auto 1rem;
    }

    .step-content h4 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 0.5rem;
    }

    .step-content p {
        color: var(--secondary-color);
        line-height: 1.6;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .success-title {
            font-size: 2rem;
        }

        .card-header {
            flex-direction: column;
            text-align: center;
        }

        .order-info-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .order-item {
            flex-direction: column;
            text-align: center;
        }

        .item-price {
            justify-content: center;
        }

        .action-buttons {
            flex-direction: column;
            align-items: center;
        }

        .btn {
            width: 100%;
            max-width: 300px;
            justify-content: center;
        }
    }

    @media (max-width: 480px) {
        .order-confirmation-page,
        .card-body,
        .whats-next-section {
            padding: 1rem;
        }

        .success-header {
            padding: 2rem 1rem;
        }

        .success-title {
            font-size: 1.75rem;
        }

        .success-subtitle {
            font-size: 1rem;
        }
    }

    /* Print Styles - Match PDF Design Exactly */
    @media print {
        @page {
            size: A4;
            margin: 0.5in;
        }
        
        /* Reset everything for print */
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            box-sizing: border-box !important;
        }
        
        /* Hide everything except order details when printing */
        body * {
            visibility: hidden;
        }
        
        /* Show only the order summary card and its contents */
        .order-summary-card,
        .order-summary-card *,
        .container,
        .order-confirmation-page,
        .order-details-section {
            visibility: visible !important;
        }
        
        /* Hide navigation, buttons, and unnecessary sections */
        .breadcrumb,
        .success-header,
        .save-invoice-section,
        .action-buttons,
        .whats-next-section,
        nav,
        header,
        footer {
            display: none !important;
            visibility: hidden !important;
        }
        
        /* Print Layout - Match PDF Design */
        body, html {
            margin: 0 !important;
            padding: 0 !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
            font-size: 12px !important;
            background: white !important;
            color: #000 !important;
            line-height: 1.4 !important;
        }
        
        .container {
            margin: 0 !important;
            padding: 0 !important;
            max-width: none !important;
            width: 100% !important;
        }
        
        .order-confirmation-page {
            padding: 0 !important;
            margin: 0 !important;
        }
        
        .order-details-section {
            max-width: 800px !important;
            margin: 0 auto !important;
            padding: 20px !important;
        }
        
        /* Add PDF-style header */
        .order-details-section::before {
            content: '' !important;
            display: block !important;
            width: 100% !important;
            height: 60px !important;
            background: linear-gradient(135deg, #930000, #20c997) !important;
            margin: -20px -20px 20px -20px !important;
            border-radius: 8px !important;
            position: relative !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .order-details-section::after {
            content: 'www.manobbazar.com                                                ðŸ“ž ðŸ“± 01777173040' !important;
            display: block !important;
            position: absolute !important;
            top: 15px !important;
            left: 20px !important;
            right: 20px !important;
            color: white !important;
            font-size: 18px !important;
            font-weight: bold !important;
            z-index: 10 !important;
            white-space: pre !important;
        }
        
        /* Order Summary Card - Match PDF Design */
        .order-summary-card {
            background: white !important;
            border-radius: 8px !important;
            box-shadow: none !important;
            border: 1px solid #ddd !important;
            margin: 0 !important;
            overflow: visible !important;
        }
        
        /* Card Header - Match PDF Design */
        .card-header {
            background: #f8f9fa !important;
            padding: 20px !important;
            border-bottom: 2px solid #dee2e6 !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            flex-wrap: wrap !important;
            gap: 1rem !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .card-header h2 {
            font-size: 20px !important;
            font-weight: 600 !important;
            color: #333 !important;
            margin: 0 !important;
        }
        
        .order-number {
            background: #930000 !important;
            color: white !important;
            padding: 8px 16px !important;
            border-radius: 20px !important;
            font-weight: 600 !important;
            font-size: 14px !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        /* Card Body */
        .card-body {
            padding: 20px !important;
        }
        
        /* Order Info Grid - Match PDF Design */
        .order-info-grid {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 15px !important;
            margin-bottom: 20px !important;
            padding: 15px !important;
            background: #f8f9fa !important;
            border-radius: 8px !important;
            border: 1px solid #dee2e6 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .info-item {
            display: flex !important;
            flex-direction: column !important;
            gap: 5px !important;
        }
        
        .info-item .label {
            color: #6c757d !important;
            font-size: 12px !important;
            font-weight: 600 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }
        
        .info-item .value {
            color: #333 !important;
            font-weight: 600 !important;
            font-size: 14px !important;
        }
        
        .order-total-amount {
            color: #930000 !important;
            font-size: 16px !important;
            font-weight: bold !important;
        }
        
        /* Payment Method Details */
        .payment-method-details {
            display: flex !important;
            flex-direction: column !important;
            gap: 0.25rem !important;
        }
        
        .payment-method-name {
            font-weight: 600 !important;
            color: #333 !important;
        }
        
        .payment-details {
            display: flex !important;
            flex-direction: column !important;
            gap: 0.15rem !important;
            margin-top: 0.25rem !important;
        }
        
        .payment-account,
        .payment-transaction {
            color: #6c757d !important;
            font-size: 11px !important;
            font-weight: 500 !important;
        }
        
        .payment-transaction {
            color: #930000 !important;
            font-weight: 600 !important;
        }
        
        /* Order Items - Match PDF Design */
        .order-items-section h3 {
            font-size: 16px !important;
            font-weight: 600 !important;
            color: #333 !important;
            margin-bottom: 15px !important;
            border-bottom: 2px solid #dee2e6 !important;
            padding-bottom: 8px !important;
        }
        
        .items-list {
            display: flex !important;
            flex-direction: column !important;
            gap: 10px !important;
        }
        
        .order-item {
            display: flex !important;
            align-items: center !important;
            gap: 15px !important;
            padding: 15px !important;
            background: #f8f9fa !important;
            border-radius: 8px !important;
            border: 1px solid #dee2e6 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .item-image {
            width: 60px !important;
            height: 60px !important;
            border-radius: 8px !important;
            overflow: hidden !important;
            background: white !important;
            flex-shrink: 0 !important;
            border: 1px solid #dee2e6 !important;
        }
        
        .item-image img {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
        }
        
        .item-details {
            flex: 1 !important;
        }
        
        .item-name {
            font-size: 14px !important;
            font-weight: 600 !important;
            color: #333 !important;
            margin-bottom: 5px !important;
        }
        
        .item-variant {
            color: #6c757d !important;
            font-size: 12px !important;
            margin-bottom: 5px !important;
        }
        
        .item-sku {
            color: #930000 !important;
            font-size: 11px !important;
            font-weight: 600 !important;
            margin-bottom: 5px !important;
            background: rgba(147, 0, 0, 0.1) !important;
            padding: 2px 6px !important;
            border-radius: 3px !important;
            display: inline-block !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .item-price {
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
            font-size: 12px !important;
        }
        
        .unit-price {
            color: #6c757d !important;
        }
        
        .quantity {
            background: #930000 !important;
            color: white !important;
            padding: 3px 8px !important;
            border-radius: 12px !important;
            font-weight: 600 !important;
            font-size: 11px !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .item-total {
            font-size: 16px !important;
            font-weight: bold !important;
            color: #930000 !important;
            text-align: right !important;
            min-width: 80px !important;
        }
        
        /* Order Totals - Match PDF Design */
        .order-totals {
            margin-top: 20px !important;
            padding: 15px !important;
            background: #f8f9fa !important;
            border-radius: 8px !important;
            border: 1px solid #dee2e6 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .total-line {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 8px 0 !important;
            font-size: 14px !important;
        }
        
        .total-line.grand-total {
            font-size: 18px !important;
            font-weight: bold !important;
            color: #930000 !important;
            border-top: 2px solid #dee2e6 !important;
            margin-top: 10px !important;
            padding-top: 10px !important;
        }

        .total-line.coupon-discount {
            color: #28a745 !important;
            font-weight: 600 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .discount-amount {
            color: #28a745 !important;
            font-weight: bold !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .total-divider {
            height: 2px !important;
            background: #dee2e6 !important;
            margin: 10px 0 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        /* Shipping Address - Match PDF Design */
        .shipping-address-section {
            margin-top: 20px !important;
        }
        
        .shipping-address-section h3 {
            font-size: 16px !important;
            font-weight: 600 !important;
            color: #333 !important;
            margin-bottom: 15px !important;
            border-bottom: 2px solid #dee2e6 !important;
            padding-bottom: 8px !important;
        }
        
        .address-card {
            background: #f8f9fa !important;
            padding: 15px !important;
            border-radius: 8px !important;
            border: 1px solid #dee2e6 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
        
        .address-name {
            font-weight: 600 !important;
            color: #333 !important;
            margin-bottom: 8px !important;
            font-size: 14px !important;
        }
        
        .address-details {
            color: #6c757d !important;
            line-height: 1.5 !important;
            margin-bottom: 8px !important;
            font-size: 13px !important;
        }
        
        .address-phone {
            color: #930000 !important;
            font-weight: 600 !important;
            display: flex !important;
            align-items: center !important;
            gap: 5px !important;
            font-size: 13px !important;
        }
        
        /* Status colors */
        .status-pending,
        .status-processing,
        .status-shipped {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add any JavaScript functionality here if needed
        console.log('Order confirmation page loaded');
    });
    
    // Save as PDF function - Use same design as image function
    function saveAsPDF() {
        const orderCard = document.querySelector('.order-summary-card');
        if (!orderCard) return;
        
        // Get primary color from CSS variables
        const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color') || '#930000';
        
        // Create a temporary container with the same styling as image function
        const tempContainer = document.createElement('div');
        tempContainer.style.cssText = `
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 800px;
            background: white;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        `;
        
        // Clone the order card (same as image function)
        const clonedCard = orderCard.cloneNode(true);
        
        // Hide save buttons in the clone (same as image function)
        const saveSection = clonedCard.querySelector('.save-invoice-section');
        const actionButtons = clonedCard.querySelector('.action-buttons');
        const whatsNextSection = clonedCard.querySelector('.whats-next-section');
        
        if (saveSection) saveSection.style.display = 'none';
        if (actionButtons) actionButtons.style.display = 'none';
        if (whatsNextSection) whatsNextSection.style.display = 'none';
        
        // Add header and content to the temp container (same as image function)
        tempContainer.innerHTML = 
            '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px 20px; border-radius: 8px; background: linear-gradient(135deg, ' + primaryColor + ', #20c997); color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">' +
                '<div style="font-size: 18px; font-weight: bold; color: white;">www.manobbazar.com</div>' +
                '<div style="font-size: 14px; font-weight: bold; color: white; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px;">ðŸ“ž ðŸ“± 01777173040</div>' +
            '</div>';
        
        tempContainer.appendChild(clonedCard);
        document.body.appendChild(tempContainer);
        
        // Use html2canvas to generate the image first, then convert to PDF
        if (typeof html2canvas === 'undefined') {
            // Load html2canvas library if not already loaded
            const script = document.createElement('script');
            script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
            script.onload = function() {
                generatePDFFromCanvas();
            };
            document.head.appendChild(script);
        } else {
            generatePDFFromCanvas();
        }
        
        function generatePDFFromCanvas() {
            html2canvas(tempContainer, {
                backgroundColor: '#ffffff',
                scale: 2,
                useCORS: true,
                allowTaint: true,
                width: 800,
                height: tempContainer.scrollHeight + 40
            }).then(canvas => {
                // Clean up temp container
                document.body.removeChild(tempContainer);
                
                // Create a new window with the canvas content for PDF printing
                const printWindow = window.open('', '_blank', 'width=1024,height=768,scrollbars=yes,resizable=yes,toolbar=yes,menubar=yes');
                if (printWindow) {
                    const imgData = canvas.toDataURL('image/png');
                    
                    printWindow.document.write(`
                        <html>
                        <head>
                            <title>Invoice {{ order.order_number }} - www.manobbazar.com</title>
                            <meta charset="UTF-8">
                            <style>
                                @page { 
                                    size: A4; 
                                    margin: 0.5in;
                                }
                                
                                body { 
                                    margin: 0; 
                                    padding: 0; 
                                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                                    background: white; 
                                    display: flex;
                                    justify-content: center;
                                    align-items: flex-start;
                                    min-height: 100vh;
                                }
                                
                                .invoice-image {
                                    max-width: 100%;
                                    height: auto;
                                    margin: 20px;
                                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                                    border-radius: 8px;
                                }
                                
                                @media print {
                                    body {
                                        margin: 0;
                                        padding: 0;
                                    }
                                    
                                    .invoice-image {
                                        max-width: 100%;
                                        width: 100%;
                                        height: auto;
                                        margin: 0;
                                        box-shadow: none;
                                        border-radius: 0;
                                        page-break-inside: avoid;
                                    }
                                }
                            </style>
                        </head>
                        <body>
                            <img src="${imgData}" alt="Invoice" class="invoice-image">
                        </body>
                        </html>
                    `);
                    
                    printWindow.document.close();
                    printWindow.focus();
                    
                    // Trigger print after a short delay
                    setTimeout(function() {
                        printWindow.print();
                    }, 1000);
                } else {
                    alert('Unable to open print window. Please allow pop-ups for this site.');
                }
            }).catch(error => {
                // Clean up temp container
                document.body.removeChild(tempContainer);
                console.error('Error generating PDF preview:', error);
                alert('Error generating PDF preview. Please try again.');
            });
        }
    }
    
    // Save as Image function  
    function saveAsImage(isAutoDownload = false) {
        // Use html2canvas library for converting to image
        if (typeof html2canvas === 'undefined') {
            // Load html2canvas library if not already loaded
            const script = document.createElement('script');
            script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
            script.onload = function() {
                captureAsImage(isAutoDownload);
            };
            document.head.appendChild(script);
        } else {
            captureAsImage(isAutoDownload);
        }
    }
    
    function captureAsImage(isAutoDownload = false) {
        const orderCard = document.querySelector('.order-summary-card');
        if (!orderCard) return;
        
        // Show loading indicator if not auto-download and SweetAlert2 is available
        let loadingToast;
        if (!isAutoDownload && typeof Swal !== 'undefined') {
            loadingToast = Swal.fire({
                title: 'Generating Invoice...',
                text: 'Please wait while we prepare your invoice image.',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                willOpen: () => {
                    Swal.showLoading();
                }
            });
        }
        
        // Create a temporary container with proper styling
        const tempContainer = document.createElement('div');
        tempContainer.style.cssText = `
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 800px;
            background: white;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        `;
        
        // Get primary color from CSS variables
        const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color') || '#930000';
        
        // Clone the order card
        const clonedCard = orderCard.cloneNode(true);
        
        // Hide save buttons in the clone
        const saveSection = clonedCard.querySelector('.save-invoice-section');
        const actionButtons = clonedCard.querySelector('.action-buttons');
        const whatsNextSection = clonedCard.querySelector('.whats-next-section');
        
        if (saveSection) saveSection.style.display = 'none';
        if (actionButtons) actionButtons.style.display = 'none';
        if (whatsNextSection) whatsNextSection.style.display = 'none';
        
        // Add header and content to the temp container
        tempContainer.innerHTML = 
            '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px 20px; border-radius: 8px; background: ' + primaryColor + '; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">' +
                '<div style="font-size: 18px; font-weight: bold; color: white;">www.manobbazar.com</div>' +
                '<div style="font-size: 14px; font-weight: bold; color: white; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px;">ðŸ“ž ðŸ“± 01777173040</div>' +
            '</div>';
        
        tempContainer.appendChild(clonedCard);
        document.body.appendChild(tempContainer);
        
        html2canvas(tempContainer, {
            backgroundColor: '#ffffff',
            scale: 2,
            useCORS: true,
            allowTaint: true,
            width: 800,
            height: tempContainer.scrollHeight + 40
        }).then(canvas => {
            // Clean up temp container
            document.body.removeChild(tempContainer);
            
            // Convert canvas to blob and download
            canvas.toBlob(function(blob) {
                const link = document.createElement('a');
                link.download = `Invoice_{{ order.order_number }}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = URL.createObjectURL(blob);
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                
                // Close loading toast and show success
                if (!isAutoDownload && typeof Swal !== 'undefined') {
                    loadingToast.close();
                    Swal.fire({
                        icon: 'success',
                        title: 'Invoice Downloaded!',
                        text: 'Your invoice image has been saved to your device.',
                        timer: 3000,
                        showConfirmButton: false
                    });
                } else if (!isAutoDownload) {
                    // Fallback alert if SweetAlert2 is not available
                    alert('Invoice downloaded successfully!');
                }
                
                // Show console message for auto-download
                if (isAutoDownload) {
                    console.log('Invoice automatically downloaded for order {{ order.order_number }}');
                }
            }, 'image/png', 0.95);
        }).catch(error => {
            // Clean up temp container
            document.body.removeChild(tempContainer);
            
            console.error('Error generating invoice image:', error);
            if (!isAutoDownload && typeof Swal !== 'undefined') {
                loadingToast.close();
                Swal.fire({
                    icon: 'error',
                    title: 'Download Failed',
                    text: 'There was an error generating your invoice. Please try again.',
                });
            } else if (!isAutoDownload) {
                // Fallback alert if SweetAlert2 is not available
                alert('Error generating invoice. Please try again.');
            }
        });
    }
    
    // Automatic invoice download on page load
    function autoDownloadInvoice() {
        // Wait for page to fully load including all scripts and styles
        setTimeout(() => {
            try {
                // Check if this is a fresh order completion (not a reload)
                const urlParams = new URLSearchParams(window.location.search);
                const isComplete = urlParams.get('complete') === 'true';
                
                // Also check for common order completion indicators
                const isOrderComplete = isComplete || 
                                       window.location.pathname.includes('/order-confirmation/') ||
                                       document.querySelector('.success-header');
                
                // Check if we've already auto-downloaded for this order
                const orderNumber = '{{ order.order_number }}';
                const downloadKey = `auto_download_${orderNumber}`;
                const hasAutoDownloaded = localStorage.getItem(downloadKey);
                
                console.log('Auto-download check:', {
                    isComplete,
                    isOrderComplete,
                    hasAutoDownloaded,
                    orderNumber,
                    pathname: window.location.pathname,
                    search: window.location.search
                });
                
                if (isOrderComplete && !hasAutoDownloaded && orderNumber) {
                    // Mark as auto-downloaded to prevent multiple downloads
                    localStorage.setItem(downloadKey, 'true');
                    
                    // Clean up old download markers (keep only last 10)
                    const keys = Object.keys(localStorage).filter(key => key.startsWith('auto_download_'));
                    if (keys.length > 10) {
                        keys.slice(0, keys.length - 10).forEach(key => localStorage.removeItem(key));
                    }
                    
                    console.log('Starting automatic invoice download...');
                    
                    // Trigger automatic invoice image download
                    saveAsImage(true); // Pass true to indicate auto-download
                    
                    // Show notification
                    const notification = document.createElement('div');
                    notification.innerHTML = `
                        <div class="alert alert-success alert-dismissible fade show position-fixed" 
                             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px; background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <strong>âœ“ Invoice Downloaded!</strong><br>
                            Your invoice has been automatically saved to your device.
                            <button type="button" onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 18px; cursor: pointer;">&times;</button>
                        </div>
                    `;
                    document.body.appendChild(notification);
                    
                    // Auto-hide notification after 7 seconds
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 7000);
                } else {
                    console.log('Auto-download skipped:', {
                        reason: !isOrderComplete ? 'Not order complete page' : 
                               hasAutoDownloaded ? 'Already downloaded' : 
                               !orderNumber ? 'No order number' : 'Unknown'
                    });
                }
            } catch (error) {
                console.error('Error in auto-download function:', error);
            }
        }, 3000); // Wait 3 seconds for everything to load
    }
    
    // Initialize auto-download when page loads
    document.addEventListener('DOMContentLoaded', function() {
        autoDownloadInvoice();
    });
</script>
{% endblock %}
