{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}{{ product.name }} - Professional eCommerce{% endblock %}

{% block content %}
    <div class="container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <a href="{% url 'frontend:home' %}">Home</a>
            <span class="breadcrumb-separator">/</span>
            <a href="{% url 'frontend:categories' %}">Categories</a>
            <span class="breadcrumb-separator">/</span>
            <a href="{% url 'frontend:category_products' product.category.slug %}">{{ product.category.name }}</a>
            <span class="breadcrumb-separator">/</span>
            <span class="current">{{ product.name }}</span>
        </nav>

        <!-- Product Detail Section -->
        <div class="product-detail">
            <div class="product-detail-grid">
                <!-- Product Images -->
                <div class="product-images">
                    <div class="main-image-container">
                        {% if product.images.exists %}
                            <img src="{{ product.images.first.image.url }}" 
                                 alt="{{ product.name }}" 
                                 id="main-product-image"
                                 class="main-image"
                                 onerror="this.onerror=null; this.src='{{ MEDIA_URL }}default.webp';">
                        {% else %}
                            <img src="{{ MEDIA_URL }}default.webp" 
                                 alt="{{ product.name }}" 
                                 id="main-product-image"
                                 class="main-image"
                                 onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAwIiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOWZhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyNCIgZmlsbD0iIzZjNzU3ZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';">
                        {% endif %}
                        
                        <!-- Image Badge -->
                        {% if product.is_featured %}
                        <div class="image-badge featured">
                            <i class="fas fa-star"></i>
                            Featured
                        </div>
                        {% endif %}
                        
                        <!-- Zoom Button -->
                        <button class="zoom-btn" onclick="openImageModal()">
                            <i class="fas fa-search-plus"></i>
                        </button>
                    </div>
                    
                    <!-- Thumbnail Gallery -->
                    {% if product.images.count > 1 %}
                    <div class="thumbnail-gallery">
                        {% for image in product.images.all %}
                        <img src="{{ image.image.url }}" 
                             alt="{{ product.name }}" 
                             class="gallery-thumbnail {% if forloop.first %}active{% endif %}"
                             onclick="changeMainImage(this.src)"
                             onerror="this.onerror=null; this.src='{{ MEDIA_URL }}default.webp';">
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- Video Button -->
                    {% if product.youtube_video_url %}
                    <div class="video-button-container">
                        <button class="video-btn" onclick="openVideoModal('{{ product.youtube_video_url }}')">
                            <i class="fas fa-play"></i>
                            <span>Watch Product Video</span>
                        </button>
                    </div>
                    {% endif %}
                </div>

                <!-- Product Information -->
                <div class="product-info">
                    <div class="product-header">
                        <div class="product-category">
                            <a href="{% url 'frontend:category_products' product.category.slug %}">
                                {{ product.category.name }}
                            </a>
                        </div>
                        <h1 class="product-title">{{ product.name }}</h1>
                        
                        <!-- Product Rating -->
                        <div class="product-rating">
                            <div class="rating-stars">
                                {% for i in "12345" %}
                                    <i class="fas fa-star {% if i|add:0 <= product.average_rating %}filled{% endif %}"></i>
                                {% endfor %}
                            </div>
                            <span class="rating-text">({{ total_approved_reviews }} reviews)</span>
                        </div>
                        
                        <!-- Product Price -->
                        <div class="product-pricing">
                            <div class="price-container">
                                <span class="current-price" id="variant-current-price">${{ product.price }}</span>
                                {% if product.compare_price and product.compare_price > product.price %}
                                <span class="original-price" id="variant-original-price">${{ product.compare_price }}</span>
                                <span class="discount-badge" id="variant-discount-badge">
                                    <script>
                                        document.write(Math.round(({{ product.compare_price }} - {{ product.price }}) / {{ product.compare_price }} * 100) + '% OFF');
                                    </script>
                                </span>
                                {% endif %}
                            </div>
                            <div class="savings" id="variant-savings">
                                {% if product.compare_price and product.compare_price > product.price %}
                                <script>
                                    document.write('You save $' + ({{ product.compare_price }} - {{ product.price }}).toFixed(2));
                                </script>
                                {% endif %}
                            </div>
                            <div class="price-note" id="variant-price-note" style="display: none;">
                                <small>Price varies by variant selection</small>
                            </div>
                        </div>
                    </div>

                                        <!-- Product Variants -->
                    {% if product.variants.exists %}
                    <div class="product-variants">
                        <h3>Product Variants</h3>
                        
                        <!-- Debug info for default variant (remove in production) -->

                        <!-- Color Selector -->
                        {% with available_colors=product.variants.all %}
                        {% regroup available_colors by color as color_groups %}
                        {% if color_groups %}
                        <div class="variant-selector color-selector">
                            <label>Color: <span id="selected-color-label">
                                {% with default_variant=product.default_variant %}
                                    {% if default_variant %}{{ default_variant.color_name|default:default_variant.name }}{% else %}Please select{% endif %}
                                {% endwith %}
                            </span></label>
                            <div class="color-grid">
                                {% for color_group in color_groups %}
                                {% if color_group.grouper %}
                                {% with first_variant=color_group.list.0 %}
                                {% with default_variant=product.default_variant %}
                                <button class="color-btn{% if default_variant and default_variant.color == color_group.grouper %} selected{% endif %}" 
                                        data-color="{{ color_group.grouper }}" 
                                        data-color-name="{% for word in first_variant.name.split %}{% if forloop.first %}{{ word }}{% endif %}{% endfor %}"
                                        title="{% for word in first_variant.name.split %}{% if forloop.first %}{{ word }}{% endif %}{% endfor %}">
                                {% endwith %}
                                    {% if first_variant.image %}
                                    <img src="{{ first_variant.image.url }}" 
                                         alt="{% for word in first_variant.name.split %}{% if forloop.first %}{{ word }}{% endif %}{% endfor %}" 
                                         class="variant-thumbnail"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                    <span class="color-display" style="background-color: {{ color_group.grouper }}; display: none;"></span>
                                    {% else %}
                                    <span class="color-display" style="background-color: {{ color_group.grouper }};"></span>
                                    {% endif %}
                                    <span class="color-name">{% for word in first_variant.name.split %}{% if forloop.first %}{{ word }}{% endif %}{% endfor %}</span>
                                </button>
                                {% endwith %}
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% endwith %}
                        
                        <!-- Size Selector -->
                        {% comment %}Get all sizes and make them unique{% endcomment %}
                        {% with all_sizes=product.variants.all|dictsort:"size" %}
                            {% regroup all_sizes by size as size_groups %}
                            {% comment %}Check if we have any sizes{% endcomment %}
                            {% if size_groups.0.grouper %}
                                <label>Size: <span id="selected-size-label">
                                    {% with default_variant=product.default_variant %}
                                        {% if default_variant and default_variant.size %}{{ default_variant.size }}{% else %}Please select{% endif %}
                                    {% endwith %}
                                </span></label>
                                <div class="variant-selector size-selector"> 
                                    <div class="size-grid">
                                        {% comment %}Iterate through unique size groups only{% endcomment %}
                                        {% for size_group in size_groups %}
                                            {% if size_group.grouper %}
                                                {% with default_variant=product.default_variant %}
                                                <button class="size-btn{% if default_variant and default_variant.size == size_group.grouper %} selected{% else %} disabled{% endif %}" 
                                                        data-size="{{ size_group.grouper }}" 
                                                        title="{{ size_group.grouper }}"
                                                        {% if not default_variant or default_variant.size != size_group.grouper %}disabled{% endif %}>
                                                {% endwith %}
                                                    {{ size_group.grouper }}
                                                </button>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        {% endwith %}
                        
                        <!-- Hidden variants data for JavaScript -->
                        <script type="application/json" id="variants-data">
                        [
                            {% for variant in product.variants.all %}
                            {% if variant.is_active %}
                            {
                                "id": {{ variant.id }},
                                "name": "{{ variant.name|escapejs }}",
                                "color": "{{ variant.color|default:""|escapejs }}",
                                "colorName": "{% for word in variant.name.split %}{% if forloop.first %}{{ word }}{% endif %}{% endfor %}",
                                "size": "{{ variant.size|default:""|escapejs }}",
                                "price": "{{ variant.effective_price }}",
                                "comparePrice": "{{ product.compare_price|default:0 }}",
                                "stock": {{ variant.stock_quantity }},
                                "sku": "{{ variant.sku|escapejs }}",
                                "image": "{% if variant.image %}{{ variant.image.url }}{% else %}{{ MEDIA_URL }}default.webp{% endif %}",
                                "isDefault": {{ variant.is_default|yesno:"true,false" }}
                            }{% if not forloop.last %},{% endif %}
                            {% endif %}
                            {% endfor %}
                        ]
                        </script>
                    </div>
                    {% endif %}

                    <!-- Product Actions -->
                    <div class="product-actions">
                        {% if product.is_active %}
                        <div class="quantity_order_btn">
                            <div class="quantity-selector">
                            <label for="quantity">Quantity:</label>
                            <div class="quantity-controls">
                                <button type="button" onclick="changeQuantity(-1)">-</button>
                                <input type="number" id="quantity" value="1" min="1" max="10">
                                <button type="button" onclick="changeQuantity(1)">+</button>
                            </div>
                        </div>
                        <button class="buy-now-btn" data-product-id="{{ product.id }}">
                            <i class="fas fa-bolt"></i>
                            Buy Now
                        </button>
                        </div>
                        <div class="action-buttons">
                            <button class="add-to-cart-btn primary" data-product-id="{{ product.id }}">
                                <i class="fas fa-shopping-cart"></i>
                                Add to Cart
                            </button>
                            <button class="wishlist-btn secondary" data-product-id="{{ product.id }}">
                                <i class="far fa-heart"></i>
                                Wishlist
                            </button>
                        </div>
                        
                        {% else %}
                        <div class="out-of-stock">
                            <i class="fas fa-times-circle"></i>
                            <span>Currently Out of Stock</span>
                            <button class="notify-btn">Notify When Available</button>
                        </div>
                        {% endif %}
                    </div>



                    

                    <!-- Share Options -->
                    <div class="share-section">
                        <span>Share:</span>
                        <div class="share-buttons">
                            <button class="share-btn facebook">
                                <i class="fab fa-facebook-f"></i>
                            </button>
                            <button class="share-btn twitter">
                                <i class="fab fa-twitter"></i>
                            </button>
                            <button class="share-btn pinterest">
                                <i class="fab fa-pinterest"></i>
                            </button>
                            <button class="share-btn copy-link">
                                <i class="fas fa-link"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Details Tabs -->
        <div class="product-tabs">
            <div class="tab-navigation" id="product-tabs-nav">
                <button class="tab-btn active" data-tab="description">
                    <i class="fas fa-file-alt"></i>
                    <span>Description</span>
                </button>
                <button class="tab-btn" data-tab="specifications">
                    <i class="fas fa-list"></i>
                    <span>Specifications</span>
                </button>
                <button class="tab-btn" data-tab="reviews">
                    <i class="fas fa-star"></i>
                    <span>Reviews</span>
                    <span class="tab-badge">{{ total_approved_reviews }}</span>
                </button>
                <button class="tab-btn" data-tab="shipping">
                    <i class="fas fa-truck"></i>
                    <span>Shipping & Returns</span>
                </button>
            </div>
            
            <div class="tab-content">
                <!-- Description Tab -->
                <div class="tab-panel active" id="description">
                    <div class="description-content">
                        <h3>Product Description</h3>
                        <div class="description-text">
                            {{ product.description|linebreaks }}
                        </div>
                        {% if product.features %}
                        <h4>Key Features</h4>
                        <ul class="features-list">
                            {% for feature in product.features %}
                            <li>{{ feature }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Specifications Tab -->
                <div class="tab-panel" id="specifications">
                    <div class="specifications-content">
                        <h3>Product Specifications</h3>
                        <div class="spec-table">
                            <div class="spec-row">
                                <span class="spec-label">SKU:</span>
                                <span class="spec-value">{{ product.sku|default:"Not specified" }}</span>
                            </div>
                            <div class="spec-row">
                                <span class="spec-label">Category:</span>
                                <span class="spec-value">{{ product.category.name }}</span>
                            </div>
                            <div class="spec-row">
                                <span class="spec-label">Weight:</span>
                                <span class="spec-value">{{ product.weight|default:"Not specified" }}</span>
                            </div>
                            <div class="spec-row">
                                <span class="spec-label">Dimensions:</span>
                                <span class="spec-value">{{ product.dimensions|default:"Not specified" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Reviews Tab -->
                <div class="tab-panel" id="reviews">
                    <div class="reviews-content" id="reviews-section">
                        <div class="reviews-summary">
                            <div class="rating-overview">
                                <div class="average-rating">
                                    <span style="font-size: 2rem;" class="rating-number">{{ product.average_rating|floatformat:1 }}</span>
                                    <div class="rating-stars">
                                        {% for i in "12345" %}
                                            <i class="fas fa-star {% if i|add:0 <= product.average_rating %}filled{% endif %}"></i>
                                        {% endfor %}
                                    </div>
                                    <span class="total-reviews">Based on {{ total_approved_reviews }} reviews</span>
                                </div>

                                <div class="rating-distribution">
                                    <div class="distribution-row">
                                        <span class="stars">5 stars</span>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar simple-bar" style="width: {{ five_star_percentage|default:0 }}%"></div>
                                        </div>
                                        <span class="count">{{ five_star_count|default:0 }}</span>
                                    </div>
                                    <div class="distribution-row">
                                        <span class="stars">4 stars</span>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar simple-bar" style="width: {{ four_star_percentage|default:0 }}%"></div>
                                        </div>
                                        <span class="count">{{ four_star_count|default:0 }}</span>
                                    </div>
                                    <div class="distribution-row">
                                        <span class="stars">3 stars</span>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar simple-bar" style="width: {{ three_star_percentage|default:0 }}%"></div>
                                        </div>
                                        <span class="count">{{ three_star_count|default:0 }}</span>
                                    </div>
                                    <div class="distribution-row">
                                        <span class="stars">2 stars</span>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar simple-bar" style="width: {{ two_star_percentage|default:0 }}%"></div>
                                        </div>
                                        <span class="count">{{ two_star_count|default:0 }}</span>
                                    </div>
                                    <div class="distribution-row">
                                        <span class="stars">1 star</span>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar simple-bar" style="width: {{ one_star_percentage|default:0 }}%"></div>
                                        </div>
                                        <span class="count">{{ one_star_count|default:0 }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="add-review">
                            <h4>Write a Review</h4>
                            <form class="review-form" id="reviewForm" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="hidden" id="productId" value="{{ product.id }}">
                                
                                <!-- Guest user fields (shown only when not logged in) -->
                                {% if not user.is_authenticated %}
                                <div class="guest-fields">
                                    <div class="form-group">
                                        <label for="guestName">Your Name <span class="required">*</span></label>
                                        <input type="text" id="guestName" name="guest_name" required 
                                               placeholder="Enter your name" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label for="guestEmail">Email (optional)</label>
                                        <input type="email" id="guestEmail" name="guest_email" 
                                               placeholder="Enter your email" class="form-control">
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Rating input -->
                                <div class="rating-input">
                                    <label>Your Rating <span class="required">*</span></label>
                                    <div class="star-rating-input">
                                        {% for i in "12345" %}
                                        <i class="far fa-star rating-star" data-rating="{{ i }}" title="{{ i }} star{{ i|pluralize }}"></i>
                                        {% endfor %}
                                    </div>
                                    <input type="hidden" id="ratingValue" name="rating" required>
                                    <small class="rating-text">Click to rate this product</small>
                                </div>
                                
                                <!-- Review title -->
                                <div class="form-group">
                                    <label for="reviewTitle">Review Title (optional)</label>
                                    <input type="text" id="reviewTitle" name="title" 
                                           placeholder="Give your review a title" class="form-control">
                                </div>
                                
                                <!-- Review comment -->
                                <div class="form-group">
                                    <label for="reviewComment">Your Review <span class="required">*</span></label>
                                    <textarea id="reviewComment" name="comment" rows="3" required 
                                              placeholder="Share your experience with this product..." class="form-control"></textarea>
                                </div>
                                
                                <!-- Image upload -->
                                <div class="form-group">
                                    <label for="reviewImages">Add Photos (optional)</label>
                                    <div class="image-upload-area">
                                        <input type="file" id="reviewImages" name="uploaded_images" 
                                               multiple accept="image/*" class="file-input">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <p>Click to upload photos or drag & drop</p>
                                            <small>You can upload up to 5 images (Max 5MB each)</small>
                                        </div>
                                        <div class="image-preview-container"></div>
                                    </div>
                                </div>
                                
                                <!-- Submit button -->
                                <div class="form-actions">
                                    <button type="submit" class="submit-review-btn">
                                        <i class="fas fa-paper-plane"></i>
                                        Submit Review
                                    </button>
                                    <div class="loading-spinner" style="display: none;">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        Submitting...
                                    </div>
                                </div>
                                
                                <!-- Error/Success messages -->
                                <div class="form-messages"></div>
                            </form>
                        </div>
                        
                        <div class="reviews-list" id="reviewsList">
                            {% for review in reviews %}
                            <div class="review-item">
                                <div class="review-header">
                                    <div class="reviewer-info">
                                        <div class="reviewer-details">
                                            <strong class="reviewer-name">
                                                {% if review.user %}
                                                    {{ review.user.get_full_name|default:review.user.username }}
                                                {% else %}
                                                    {{ review.guest_name|default:"Anonymous" }}
                                                {% endif %}
                                                <span class="review-date">({{ review.created_at|date:"M d, Y" }})</span>
                                                {% if review.is_verified_purchase %}
                                                    <span class="verified-badge">
                                                        <i class="fas fa-check-circle"></i>
                                                        Verified Purchase
                                                    </span>
                                                {% endif %}
                                            </strong>
                                            <div class="review-rating">
                                                {% for i in "12345" %}
                                                    <i class="fas fa-star {% if i|add:0 <= review.rating %}filled{% endif %}"></i>
                                                {% endfor %}
                                                <span class="rating-number">({{ review.rating }}/5)</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <p class="review-text">{{ review.comment|linebreaks }}</p>
                                
                                <!-- Review Images -->
                                {% if review.images.exists %}
                                <div class="review-images">
                                    {% for image in review.images.all %}
                                    <div class="review-image-item">
                                        <img src="{{ image.image.url }}" 
                                             alt="Review image" 
                                             class="review-image"
                                             onclick="openReviewImageModal('{{ image.image.url }}', '{{ image.caption|default:"Review image"|escapejs }}')"
                                             loading="lazy">
                                        {% if image.caption %}
                                        <small class="image-caption">{{ image.caption }}</small>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                
                                <!-- Review Actions -->
                                <!-- <div class="review-actions">
                                    <button class="review-action-btn helpful-btn" data-review-id="{{ review.id }}">
                                        <i class="far fa-thumbs-up"></i>
                                        Helpful
                                    </button>
                                    <button class="review-action-btn report-btn" data-review-id="{{ review.id }}">
                                        <i class="far fa-flag"></i>
                                        Report
                                    </button>
                                </div> -->
                            </div>
                            {% empty %}
                            <div class="no-reviews">
                                <i class="fas fa-comment-dots"></i>
                                <h4>No reviews yet</h4>
                                <p>Be the first to review this product and help others make informed decisions!</p>
                            </div>
                            {% endfor %}
                            
                            <!-- Load More Reviews -->
                            {% if total_approved_reviews > 5 %}
                            <div class="load-more-reviews">
                                <button class="load-more-btn" onclick="loadMoreReviews()">
                                    <i class="fas fa-chevron-down"></i>
                                    Show More Reviews ({{ total_approved_reviews|add:"-5" }} remaining)
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Shipping Tab -->
                <div class="tab-panel" id="shipping">
                    <div class="shipping-content">
                        <h3>Shipping & Returns</h3>
                        <div class="shipping-info">
                            <div class="info-section">
                                <h4><i class="fas fa-truck"></i> Shipping Information</h4>
                                <ul>
                                    <li>Free standard shipping on orders over $50</li>
                                    <li>Express shipping available for $9.99</li>
                                    <li>Orders processed within 1-2 business days</li>
                                    <li>Delivery time: 3-7 business days</li>
                                </ul>
                            </div>
                            <div class="info-section">
                                <h4><i class="fas fa-undo"></i> Return Policy</h4>
                                <ul>
                                    <li>30-day return window from delivery date</li>
                                    <li>Items must be in original condition</li>
                                    <li>Free return shipping on defective items</li>
                                    <li>Refunds processed within 5-10 business days</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Related Products -->
        {% if related_products %}
        <div class="related-products-section">
            <div class="section-header">
                <h2>Related Products</h2>
                <p>You might also like these products</p>
            </div>
            
            <div class="related-products-grid">
                {% for related_product in related_products %}
                <div class="product-card">
                    <div class="product-image-container">
                        {% if related_product.images.exists %}
                            <img src="{{ related_product.images.first.image.url }}" 
                                 alt="{{ related_product.name }}" 
                                 class="product-image"
                                 onerror="this.onerror=null; this.src='{{ MEDIA_URL }}default.webp';">
                        {% else %}
                            <img src="{{ MEDIA_URL }}default.webp" 
                                 alt="{{ related_product.name }}" 
                                 class="product-image"
                                 onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjMyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOWZhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzZjNzU3ZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';">
                        {% endif %}
                        
                        {% if related_product.is_featured %}
                        <span class="product-badge featured">Featured</span>
                        {% endif %}
                        
                        <div class="product-overlay">
                            <a href="{% url 'frontend:product_detail' related_product.slug %}" class="view-product-btn">
                                View Product
                            </a>
                        </div>
                    </div>
                    
                    <div class="product-info-card">
                        <h3 class="product-name">
                            <a href="{% url 'frontend:product_detail' related_product.slug %}">
                                {{ related_product.name }}
                            </a>
                        </h3>
                        <div class="product-price">
                            <span class="current-price">${{ related_product.price }}</span>
                            {% if related_product.compare_price and related_product.compare_price > related_product.price %}
                            <span class="original-price">${{ related_product.compare_price }}</span>
                            {% endif %}
                        </div>
                        <button class="quick-add-btn" data-product-id="{{ related_product.id }}">
                            <i class="fas fa-plus"></i>
                            Quick Add
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Product Features -->
                <div class="container">
                    <div class="product-features">
                        <div class="feature-item">
                            <i class="fas fa-shipping-fast"></i>
                            <div>
                                <strong>Free Shipping</strong>
                                <span>On orders over $50</span>
                            </div>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-undo"></i>
                            <div>
                                <strong>30-Day Returns</strong>
                                <span>Easy return policy</span>
                            </div>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-shield-alt"></i>
                            <div>
                                <strong>Secure Payment</strong>
                                <span>SSL encrypted checkout</span>
                            </div>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-headset"></i>
                            <div>
                                <strong>24/7 Support</strong>
                                <span>Customer service</span>
                            </div>
                        </div>
                    </div>
                </div>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeImageModal()">&times;</span>
            <img id="modalImage" src="" alt="Product Image">
        </div>
    </div>

    <!-- Video Modal -->
    <div id="videoModal" class="video-modal">
        <div class="video-modal-content">
            <span class="close-video-modal" onclick="closeVideoModal()" title="Close Video">&times;</span>
            <div class="video-header">
                <button class="close-video-btn-inner" onclick="closeVideoModal()" title="Close Video">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="video-container">
                <iframe id="videoFrame" src="" frameborder="0" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <!-- Review Image Modal -->
    <div id="reviewImageModal" class="review-image-modal">
        <div class="review-modal-content">
            <button class="close-review-modal" onclick="closeReviewImageModal()">&times;</button>
            <img id="reviewModalImage" src="" alt="Review Image">
            <div class="modal-caption" id="reviewModalCaption"></div>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
<style>
    /* Review styling */
    .review-date {
        font-weight: normal;
        font-size: 0.9rem;
        color: var(--secondary-color);
        margin-left: 0.5rem;
    }
    
    .reviewer-name {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
    }
    
    /* Rating Distribution Styling */
    .rating-overview {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: flex-start;
        gap: 2rem;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background-color: #f8f9fa;
        border-radius: var(--border-radius);
    }
    
    .average-rating {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        min-width: 180px;
    }
    
    .rating-number {
        font-size: 3rem;
        font-weight: 700;
        line-height: 1;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
    }
    
    .total-reviews {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: var(--secondary-color);
    }
    
    .rating-distribution {
        flex: 1;
        min-width: 250px;
    }
    
    .distribution-row {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    
    .stars {
        flex: 0 0 60px;
        text-align: right;
        padding-right: 10px;
        font-size: 0.85rem;
        color: var(--secondary-color);
    }
    
    .progress-bar-container {
        flex: 1;
        background-color: #e9ecef;
        height: 12px;
        border-radius: 10px;
        overflow: hidden;
        margin: 0 10px;
    }
    
    .progress-bar {
        height: 100%;
        background-color: var(--primary-color);
        border-radius: 10px;
        transition: width 0.6s ease;
    }
    
    .progress-bar.simple-bar {
        background: var(--primary-color);
        box-shadow: none;
    }
    
    .count {
        flex: 0 0 40px;
        font-size: 1rem;
        font-weight: 600;
        color: var(--primary-color);
    }
    
    /* Enhanced Rating Input */
    .star-rating-input {
        display: flex;
        gap: 0.5rem;
        margin: 0.5rem 0;
    }
    
    .star-rating-input i {
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .star-rating-input i:hover {
        transform: scale(1.2);
    }
    
    .star-rating-input i.fas {
        color: #ffc107; /* Gold color for selected stars */
    }
    
    .rating-selection {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.25rem;
    }
    
    .rating-text {
        font-size: 0.85rem;
        color: var(--secondary-color);
    }
    
    .selected-rating {
        font-weight: 600;
        color: var(--primary-color);
    }
    
    /* Breadcrumb */
    .breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
        padding: 1rem 0;
        font-size: 0.9rem;
    }

    .breadcrumb a {
        color: var(--primary-color);
        text-decoration: none;
        transition: var(--transition);
    }

    .breadcrumb a:hover {
        color: var(--primary-dark);
    }

    .breadcrumb-separator {
        color: var(--secondary-color);
        opacity: 0.6;
    }

    .breadcrumb .current {
        color: var(--secondary-color);
    }

    /* Product Detail Grid */
    .product-detail {
        margin-bottom: 4rem;
    }

    .product-detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 4rem;
        margin-bottom: 4rem;
    }

    /* Product Images */
    .product-images {
        position: relative;
    }

    .main-image-container {
        position: relative;
        margin-bottom: 1rem;
        border-radius: var(--border-radius);
        overflow: hidden;
        background: var(--light-color);
    }

    .main-image {
        width: 100%;
        height: 500px;
        object-fit: cover;
        display: block;
        transition: transform 0.3s ease;
    }

    .main-image:hover {
        transform: scale(1.05);
    }

    .image-badge {
        position: absolute;
        top: 1rem;
        left: 1rem;
        background: var(--warning-color);
        color: var(--white);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        z-index: 2;
    }

    .zoom-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition);
        opacity: 0;
        z-index: 2;
    }

    .main-image-container:hover .zoom-btn {
        opacity: 1;
    }

    .zoom-btn:hover {
        background: var(--white);
        transform: scale(1.1);
    }

    .thumbnail-gallery {
        display: flex;
        gap: 1rem;
        overflow-x: auto;
        padding: 0.5rem 0;
    }

    .gallery-thumbnail {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: var(--border-radius);
        cursor: pointer;
        border: 2px solid transparent;
        transition: var(--transition);
        flex-shrink: 0;
    }

    .gallery-thumbnail:hover,
    .gallery-thumbnail.active {
        border-color: var(--primary-color);
        transform: scale(1.05);
    }

    /* Product Information */
    .product-info {
        padding: 1rem 0;
    }

    .product-category a {
        color: var(--primary-color);
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .product-title {
        font-size: 2.5rem;
        font-weight: 300;
        color: var(--dark-color);
        margin: 1rem 0;
        line-height: 1.2;
    }

    .product-rating {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.5rem;
    }

    .rating-stars {
        display: flex;
        gap: 0.25rem;
    }

    .rating-stars i {
        color: var(--border-color);
        font-size: 1.2rem;
    }

    .rating-stars i.filled {
        color: var(--warning-color);
    }

    .rating-text {
        color: var(--secondary-color);
        font-size: 0.9rem;
    }

    .product-pricing {
        margin-bottom: 0rem;
        padding: 1rem;
        background: var(--light-color);
        border-radius: var(--border-radius);
    }

    .price-container {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.5rem;
    }

    .current-price {
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--primary-color);
    }

    .original-price {
        font-size: 1.5rem;
        color: var(--secondary-color);
        text-decoration: line-through;
    }

    .discount-badge {
        background: var(--danger-color);
        color: var(--white);
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .savings {
        color: var(--success-color);
        font-weight: 600;
        font-size: 1.1rem;
    }

    .price-note {
        margin-top: 0.5rem;
        color: var(--secondary-color);
        font-style: italic;
    }

    .price-note small {
        font-size: 0.9rem;
    }

    /* Product Actions */
    .product-actions {
        margin-bottom: 1rem;
        display: flex;
        flex-direction: column;
    }

    .quantity-selector {
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap:1rem;

    }

    .quantity_order_btn {     
    display: flex;
    flex-direction: column;
    align-items: center;

    }

    .quantity-selector label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--dark-color);
    }

    .quantity-controls {
        display: flex;
        align-items: center;
        width: fit-content;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        overflow: hidden;
    }

    .quantity-controls button {
        width: 40px;
        height: 40px;
        background: var(--light-color);
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: 600;
        transition: var(--transition);
    }

    .quantity-controls button:hover {
        background: var(--primary-color);
        color: var(--white);
    }

    .quantity-controls input {
        width: 60px;
        height: 40px;
        border: none;
        text-align: center;
        font-size: 1rem;
        font-weight: 600;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .add-to-cart-btn {
        flex: 2;
        padding: 1rem 2rem;
        background: var(--primary-color);
        color: var(--white);
        border: none;
        border-radius: var(--border-radius);
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .add-to-cart-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
    }

    .wishlist-btn {
        flex: 1;
        padding: 1rem;
        background: var(--white);
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
        border-radius: var(--border-radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .wishlist-btn:hover {
        background: var(--primary-color);
        color: var(--white);
    }

    .buy-now-btn {
        width: 100%;
        padding: 1rem 2rem;
        background: var(--success-color);
        color: var(--white);
        border: none;
        border-radius: var(--border-radius);
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .buy-now-btn:hover {
        background: var(--success-dark);
        transform: translateY(-2px);
    }

    .out-of-stock {
        text-align: center;
        padding: 2rem;
        background: var(--light-color);
        border-radius: var(--border-radius);
        color: var(--danger-color);
    }

    .out-of-stock i {
        font-size: 2rem;
        margin-bottom: 1rem;
        display: block;
    }

    .out-of-stock span {
        display: block;
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .notify-btn {
        padding: 0.75rem 1.5rem;
        background: var(--primary-color);
        color: var(--white);
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: var(--transition);
    }

    .notify-btn:hover {
        background: var(--primary-dark);
    }

    /* Product Variants */
    .product-variants {
        margin-bottom: 3rem;
        padding: 2rem;
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
    }

    .product-variants h3 {
        margin-bottom: 0.5rem;
        color: var(--dark-color);
        font-size: 1.5rem;
    }

    .variant-selector {
        margin-bottom: 0rem;
    }

    .variant-selector label {
        display: block;
        margin-bottom: 0.75rem;
        font-weight: 600;
        color: var(--dark-color);
        font-size: 1.1rem;
    }

    /* Color Grid */
    .color-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
        margin-bottom: 1rem;
        max-width: 600px;
    }

    .color-btn {
        position: relative;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        background: var(--white);
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--dark-color);
        min-height: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .color-btn:hover {
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }

    .color-btn.selected {
        border-color: var(--primary-color);
        background: var(--light-color);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }

    .color-btn.selected::after {
        content: '✓';
        position: absolute;
        top: 4px;
        right: 6px;
        font-size: 0.8rem;
        font-weight: bold;
        color: var(--primary-color);
    }

    .color-display {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 2px solid #ddd;
        display: block;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .variant-thumbnail {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 2px solid #ddd;
        object-fit: cover;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .color-name {
        font-size: 0.85rem;
        font-weight: 600;
        margin-top: 0.25rem;
    }

    /* Size Grid */
    .size-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
        gap: 0.75rem;
        max-width: 400px;
    }

    .size-btn {
        padding: 0.75rem;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        background: var(--white);
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--dark-color);
        min-height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .size-btn:hover:not(.disabled):not(.out-of-stock) {
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }

    .size-btn.selected {
        border-color: var(--primary-color);
        background: var(--primary-color);
        color: var(--white);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }

    .size-btn.disabled {
        background: var(--light-color);
        color: var(--secondary-color);
        border-color: var(--border-color);
        cursor: not-allowed;
        opacity: 0.5;
    }

    .size-btn.out-of-stock {
        background: #fff5f5;
        color: var(--danger-color);
        border-color: #fed7d7;
        position: relative;
        cursor: not-allowed;
    }

    .size-btn.out-of-stock::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 10%;
        right: 10%;
        height: 2px;
        background: var(--danger-color);
        transform: translateY(-50%) rotate(-15deg);
    }

    /* Product Features */
    .product-features {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 3rem;
        padding: 2rem;
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
    }

    .feature-item {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .feature-item i {
        font-size: 1.5rem;
        color: var(--primary-color);
        width: 30px;
        text-align: center;
    }

    .feature-item strong {
        display: block;
        color: var(--dark-color);
        margin-bottom: 0.25rem;
    }

    .feature-item span {
        color: var(--secondary-color);
        font-size: 0.9rem;
    }

    /* Share Section */
    .share-section {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.5rem;
        background: var(--light-color);
        border-radius: var(--border-radius);
    }

    .share-section span {
        font-weight: 600;
        color: var(--dark-color);
    }

    .share-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .share-btn {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
    }

    .share-btn.facebook {
        background: #3b5998;
    }

    .share-btn.twitter {
        background: #1da1f2;
    }

    .share-btn.pinterest {
        background: #bd081c;
    }

    .share-btn.copy-link {
        background: var(--secondary-color);
    }

    .share-btn:hover {
        transform: scale(1.1);
    }

    /* Product Tabs */
    .product-tabs {
        margin-bottom: 4rem;
    }

    .tab-navigation {
        display: flex;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 2rem;
        position: relative;
        overflow-x: auto;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE/Edge */
        scroll-behavior: smooth;
    }
    
    .tab-navigation::-webkit-scrollbar {
        display: none; /* Chrome/Safari/Opera */
    }

    .tab-btn {
        padding: 1rem 1.5rem;
        background: none;
        border: none;
        font-size: 1rem;
        font-weight: 600;
        color: var(--secondary-color);
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        white-space: nowrap;
        flex-shrink: 0;
        position: relative;
    }
    
    .tab-btn i {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .tab-btn:hover,
    .tab-btn.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
    }
    
    .tab-btn.active i {
        opacity: 1;
    }
    
    .tab-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 20px;
        height: 20px;
        background: var(--primary-color);
        color: var(--white);
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 700;
        padding: 0 6px;
        margin-left: 4px;
    }

    .tab-content {
        background: var(--white);
        padding: 3rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
    }

    .tab-panel {
        display: none;
    }

    .tab-panel.active {
        display: block;
        animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .tab-panel h3 {
        margin-bottom: 2rem;
        color: var(--dark-color);
        font-size: 1.5rem;
    }

    .tab-panel h4 {
        margin: 2rem 0 1rem;
        color: var(--dark-color);
    }

    .description-text {
        line-height: 1.8;
        color: var(--secondary-color);
        margin-bottom: 2rem;
    }

    .features-list {
        list-style: none;
        padding: 0;
    }

    .features-list li {
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-color);
        position: relative;
        padding-left: 1.5rem;
    }

    .features-list li:before {
        content: '✓';
        position: absolute;
        left: 0;
        color: var(--success-color);
        font-weight: bold;
    }

    /* Specifications */
    .spec-table {
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        overflow: hidden;
    }

    .spec-row {
        display: grid;
        grid-template-columns: 1fr 2fr;
        border-bottom: 1px solid var(--border-color);
    }

    .spec-row:last-child {
        border-bottom: none;
    }

    .spec-label {
        padding: 1rem;
        background: var(--light-color);
        font-weight: 600;
        color: var(--dark-color);
        border-right: 1px solid var(--border-color);
    }

    .spec-value {
        padding: 1rem;
        color: var(--secondary-color);
    }

    /* Reviews */
    .reviews-summary {
        margin-bottom: 3rem;
        padding: 2rem;
        background: var(--light-color);
        border-radius: var(--border-radius);
        text-align: center;
    }

    .rating-number {
        font-size: 3rem;
        font-weight: bold;
        color: var(--primary-color);
        display: block;
        margin-bottom: 0.5rem;
    }

    .total-reviews {
        color: var(--secondary-color);
        margin-top: 0.5rem;
        display: block;
    }

    /* Enhanced Review Form - Compact Version */
    .add-review {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        border: 1px solid var(--border-color);
    }

    .add-review h4 {
        margin-bottom: 1.5rem;
        color: var(--dark-color);
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .add-review h4::before {
        content: '✍️';
        font-size: 1.2rem;
    }

    /* Guest Fields - Compact */
    .guest-fields {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: rgba(var(--primary-color-rgb), 0.05);
        border-radius: var(--border-radius);
        border-left: 3px solid var(--primary-color);
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.4rem;
        font-weight: 600;
        color: var(--dark-color);
        font-size: 0.9rem;
    }

    .required {
        color: var(--danger-color);
        font-weight: bold;
    }

    .form-control {
        width: 100%;
        padding: 0.6rem 0.8rem;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: var(--white);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.1);
    }

    /* Enhanced Rating Input - Compact */
    .rating-input {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: var(--white);
        border-radius: var(--border-radius);
        border: 2px solid var(--border-color);
        text-align: center;
    }

    .rating-input label {
        display: block;
        margin-bottom: 0.8rem;
        font-weight: 600;
        color: var(--dark-color);
        font-size: 1rem;
    }

    .star-rating-input {
        display: flex;
        justify-content: center;
        gap: 0.3rem;
        margin-bottom: 0.4rem;
    }

    .rating-star {
        font-size: 1.6rem;
        color: #e0e0e0;
        cursor: pointer;
        transition: all 0.3s ease;
        transform: scale(1);
    }

    .rating-star:hover,
    .rating-star.active {
        color: #ffc107;
        transform: scale(1.1);
        text-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
    }

    .rating-text {
        color: var(--secondary-color);
        font-style: italic;
        font-size: 0.9rem;
    }

    /* Image Upload Area */
    .image-upload-area {
        position: relative;
        margin-top: 1rem;
    }

    .file-input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
        z-index: 2;
    }

    .upload-placeholder {
        border: 2px dashed var(--border-color);
        border-radius: var(--border-radius);
        padding: 1.2rem;
        text-align: center;
        transition: all 0.3s ease;
        background: var(--light-color);
        cursor: pointer;
    }

    .upload-placeholder:hover {
        border-color: var(--primary-color);
        background: rgba(var(--primary-color-rgb), 0.05);
    }

    .upload-placeholder i {
        font-size: 1.6rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
        display: block;
    }

    .upload-placeholder p {
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 0.5rem;
    }

    .upload-placeholder small {
        color: var(--secondary-color);
    }

    /* Image Preview - Compact */
    .image-preview-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.8rem;
        margin-top: 1rem;
    }

    .image-preview {
        position: relative;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    .image-preview img {
        width: 100%;
        height: 100px;
        object-fit: cover;
    }

    .remove-image {
        position: absolute;
        top: 3px;
        right: 3px;
        background: var(--danger-color);
        color: var(--white);
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        font-weight: bold;
        transition: all 0.3s ease;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .remove-image:hover {
        background: #dc2626;
        transform: scale(1.1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    /* Form Actions - Compact */
    .form-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .submit-review-btn {
        padding: 0.8rem 1.5rem;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: var(--white);
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        min-width: 150px;
        justify-content: center;
    }

    .submit-review-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(var(--primary-color-rgb), 0.4);
    }

    .submit-review-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .loading-spinner {
        color: var(--primary-color);
        font-size: 0.9rem;
    }

    /* Form Messages */
    .form-messages {
        margin-top: 1rem;
    }

    .success-message {
        padding: 1rem;
        background: var(--success-color);
        color: var(--white);
        border-radius: var(--border-radius);
        margin-bottom: 1rem;
    }

    .error-message {
        padding: 1rem;
        background: var(--danger-color);
        color: var(--white);
        border-radius: var(--border-radius);
        margin-bottom: 1rem;
    }

    /* Enhanced Review Items - Compact & Responsive Design */
    .review-item {
        padding: 1.5rem;
        margin-bottom: 1rem;
        background: var(--white);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
    }

    .review-item:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .review-item:last-child {
        margin-bottom: 0;
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .reviewer-info {
        flex: 1;
        min-width: 0; /* Allow flex item to shrink */
    }

    .reviewer-details {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .reviewer-name {
        color: var(--dark-color);
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .verified-badge {
        background: var(--success-color);
        color: var(--white);
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
    }

    .review-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--secondary-color);
        font-size: 0.85rem;
    }

    .review-rating {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .review-rating i {
        font-size: 0.9rem;
        color: var(--border-color);
    }

    .review-rating i.filled {
        color: var(--warning-color);
    }

    .rating-number {
        font-size: 0.85rem;
        color: var(--secondary-color);
        font-weight: 500;
    }

    .review-date {
        color: var(--secondary-color);
        font-size: 0.85rem;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .review-text {
        line-height: 1.6;
        color: var(--secondary-color);
        margin-bottom: 1rem;
        font-size: 0.95rem;
    }

    /* Review Images - Compact Design */
    .review-images {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .review-image-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        aspect-ratio: 1;
    }

    .review-image-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .review-image {
        width: 100%;
        height: 150px;
        object-fit: cover;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .review-image:hover {
        transform: scale(1.05);
    }

    .image-caption {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.8);
        color: var(--white);
        padding: 0.25rem;
        font-size: 0.7rem;
        text-align: center;
        line-height: 1.2;
    }

    /* Review Actions - Compact */
    .review-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .review-action-btn {
        background: none;
        border: 1px solid var(--border-color);
        padding: 0.4rem 0.8rem;
        border-radius: 16px;
        cursor: pointer;
        font-size: 0.8rem;
        color: var(--secondary-color);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .review-action-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
        background: rgba(var(--primary-color-rgb), 0.05);
    }

    .review-action-btn i {
        font-size: 0.85rem;
    }

    /* No Reviews State */
    .no-reviews {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--secondary-color);
        background: var(--light-color);
        border-radius: var(--border-radius);
        border: 2px dashed var(--border-color);
    }

    .no-reviews i {
        font-size: 3rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
        display: block;
    }

    .no-reviews h4 {
        color: var(--dark-color);
        margin-bottom: 0.5rem;
        font-size: 1.3rem;
    }

    .no-reviews p {
        font-size: 1rem;
        line-height: 1.6;
    }

    /* Load More Reviews */
    .load-more-reviews {
        text-align: center;
        margin-top: 2rem;
    }

    /* Load More Button Styles */
    .load-more-reviews {
        display: flex;
        justify-content: center;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
    }

    .load-more-btn {
        background: transparent;
        color: var(--primary-color);
        border: 2px solid var(--primary-color);
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .load-more-btn:hover {
        background: var(--primary-color);
        color: var(--white);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(var(--primary-color-rgb), 0.3);
    }

    .load-more-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .load-more-btn i {
        transition: transform 0.3s ease;
    }

    .load-more-btn:hover i {
        transform: translateY(2px);
    }

    /* Responsive Design for Reviews */
    @media (max-width: 768px) {
        .review-item {
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .review-header {
            flex-direction: column;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .review-user {
            gap: 0.75rem;
        }

        .user-avatar {
            width: 2.5rem;
            height: 2.5rem;
            font-size: 1rem;
        }

        .user-name {
            font-size: 0.9rem;
        }

        .review-date {
            font-size: 0.75rem;
        }

        .review-rating {
            font-size: 0.85rem;
        }

        .review-images {
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 0.5rem;
        }

        .review-actions {
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .review-action-btn {
            padding: 0.35rem 0.7rem;
            font-size: 0.75rem;
        }

        .load-more-btn {
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
        }
    }

    @media (max-width: 480px) {
        .review-item {
            padding: 0.75rem;
        }

        .review-images {
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
        }

        .review-actions {
            justify-content: center;
        }

        .review-action-btn {
            flex: 1;
            min-width: 0;
            justify-content: center;
        }
    }
    .review-image-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        animation: fadeIn 0.3s ease;
    }

    .review-image-modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .review-modal-content {
        position: relative;
        max-width: 90%;
        max-height: 90%;
        background: var(--white);
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    .review-modal-content img {
        width: 800px;
        height: auto;
        display: block;
    }

    .close-review-modal {
        position: absolute;
        top: 15px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: var(--white);
        border: none;
        font-size: 2rem;
        cursor: pointer;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .close-review-modal:hover {
        background: rgba(0, 0, 0, 0.9);
        transform: scale(1.1);
    }

    .review-rating {
        display: flex;
        gap: 0.25rem;
    }

    .review-rating i {
        font-size: 0.9rem;
        color: var(--border-color);
    }

    .review-rating i.filled {
        color: var(--warning-color);
    }

    .review-date {
        color: var(--secondary-color);
        font-size: 0.9rem;
    }

    .review-text {
        line-height: 1.6;
        color: var(--secondary-color);
    }

    .no-reviews {
        text-align: center;
        color: var(--secondary-color);
        font-style: italic;
        padding: 2rem;
    }

    /* Shipping Info */
    .shipping-info {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 3rem;
    }

    .info-section h4 {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        color: var(--dark-color);
    }

    .info-section ul {
        list-style: none;
        padding: 0;
    }

    .info-section li {
        padding: 0.5rem 0;
        color: var(--secondary-color);
        position: relative;
        padding-left: 1.5rem;
    }

    .info-section li:before {
        content: '•';
        position: absolute;
        left: 0;
        color: var(--primary-color);
        font-weight: bold;
    }

    /* Related Products */
    .related-products-section {
        margin-top: 4rem;
    }

    .section-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .section-header h2 {
        font-size: 2.5rem;
        font-weight: 300;
        color: var(--dark-color);
        margin-bottom: 1rem;
    }

    .section-header p {
        color: var(--secondary-color);
        font-size: 1.1rem;
    }

    .related-products-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 2rem;
    }

    .product-card {
        background: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        overflow: hidden;
        transition: var(--transition);
        position: relative;
    }

    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .product-image-container {
        position: relative;
        height: 280px;
        overflow: hidden;
        background: var(--light-color);
    }

    .product-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .product-card:hover .product-image {
        transform: scale(1.05);
    }

    .product-badge {
        position: absolute;
        top: 1rem;
        left: 1rem;
        background: var(--warning-color);
        color: var(--white);
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .product-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.8);
        padding: 1rem;
        transform: translateY(100%);
        transition: var(--transition);
    }

    .product-card:hover .product-overlay {
        transform: translateY(0);
    }

    .view-product-btn {
        display: block;
        width: 100%;
        padding: 0.75rem;
        background: var(--primary-color);
        color: var(--white);
        text-align: center;
        text-decoration: none;
        border-radius: var(--border-radius);
        font-weight: 600;
        transition: var(--transition);
    }

    .view-product-btn:hover {
        background: var(--primary-dark);
        color: var(--white);
    }

    .product-info-card {
        padding: 1.5rem;
    }

    .product-name a {
        color: var(--dark-color);
        text-decoration: none;
        font-size: 1.1rem;
        font-weight: 600;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .product-name a:hover {
        color: var(--primary-color);
    }

    .product-price {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 1rem 0;
    }

    .current-price {
        font-size: 1.25rem;
        font-weight: bold;
        color: var(--primary-color);
    }

    .original-price {
        font-size: 0.9rem;
        color: var(--secondary-color);
        text-decoration: line-through;
    }

    .quick-add-btn {
        width: 100%;
        padding: 0.75rem;
        background: var(--light-color);
        color: var(--primary-color);
        border: 1px solid var(--primary-color);
        border-radius: var(--border-radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .quick-add-btn:hover {
        background: var(--primary-color);
        color: var(--white);
    }

    /* Image Modal */
    .image-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
    }

    .modal-content {
        position: relative;
        max-width: 90%;
        max-height: 90%;
        margin: auto;
        top: 50%;
        transform: translateY(-50%);
    }

    .modal-content img {
        width: 100%;
        height: auto;
        border-radius: var(--border-radius);
    }

    .close-modal {
        position: absolute;
        top: -40px;
        right: 0;
        color: var(--white);
        font-size: 2rem;
        font-weight: bold;
        cursor: pointer;
        background: rgba(0, 0, 0, 0.5);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .close-modal:hover {
        background: rgba(0, 0, 0, 0.8);
    }

    /* Video Button */
    .video-button-container {
        margin-top: 1rem;
        text-align: center;
    }

    .video-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.5rem;
        background: var(--primary-color);
        color: var(--white);
        border: none;
        border-radius: var(--border-radius);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3);
        position: relative;
        overflow: hidden;
    }

    .video-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s ease;
    }

    .video-btn:hover::before {
        left: 100%;
    }

    .video-btn:hover {
        background: linear-gradient(135deg, #ff3742, #ff2d3a);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
    }

    .video-btn:active {
        transform: translateY(0);
    }

    .video-btn i {
        font-size: 1.2rem;
        background: rgba(255, 255, 255, 0.2);
        padding: 0.5rem;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Video Modal */
    .video-modal {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.95);
        animation: fadeIn 0.3s ease;
        align-items: center;
        justify-content: center;
    }

    .video-modal.show {
        display: flex;
    }

    .video-modal-content {
        position: relative;
        width: 90%;
        max-width: 900px;
        background: var(--white);
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        margin: auto;
        /* Ensure perfect centering */
        display: flex;
        flex-direction: column;
    }

    .video-container {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
        background: #000;
    }

    .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
    }

    .close-video-modal {
        position: absolute;
        top: -50px;
        right: 0;
        color: var(--white);
        font-size: 2.5rem;
        font-weight: bold;
        cursor: pointer;
        background: rgba(255, 71, 87, 0.9);
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        z-index: 1002;
        border: 2px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        line-height: 1;
    }

    .close-video-modal:hover {
        background: rgba(255, 71, 87, 1);
        transform: scale(1.1);
        border-color: rgba(255, 255, 255, 0.6);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
    }

    .close-video-modal:active {
        transform: scale(0.95);
    }

    /* Video Header with Inner Close Button */
    .video-header {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1003;
    }

    .close-video-btn-inner {
        background: rgba(0, 0, 0, 0.7);
        color: var(--white);
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .close-video-btn-inner:hover {
        background: rgba(255, 71, 87, 0.9);
        transform: scale(1.1);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    }

    .close-video-btn-inner:active {
        transform: scale(0.9);
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* Notification animations */
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    /* Enhanced Notification Styles */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 18px 24px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 600;
        font-size: 15px;
        min-width: 320px;
        max-width: 450px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .product-detail-grid {
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .related-products-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        .product-features {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .shipping-info {
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .tab-navigation {
            overflow-x: auto;
            flex-wrap: nowrap;
        }

        .tab-btn {
            white-space: nowrap;
            min-width: 120px;
        }
    }

    @media (max-width: 768px) {
        .container {
            padding: 0 1rem;
        }

        .breadcrumb {
            font-size: 0.8rem;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
            overflow-x: auto;
            white-space: nowrap;
        }

        .product-detail {
            margin-bottom: 2rem;
        }

        .product-detail-grid {
            gap: 1.5rem;
        }

        .main-image {
            height: 350px;
        }
        
        .thumbnail-gallery {
            gap: 0.5rem;
        }

        .gallery-thumbnail {
            width: 60px;
            height: 60px;
        }

        .product-title {
            font-size: 1.8rem;
            margin: 0.5rem 0;
        }

        .current-price {
            font-size: 2rem;
        }

        .original-price {
            font-size: 1.2rem;
        }

        .product-pricing {
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .product-variants {
            padding: 1rem;
            margin-bottom: 2rem;
        }

        .product-variants h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }

        .variant-selector label {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .color-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        
        .size-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }
        
        .color-btn, .size-btn {
            font-size: 0.8rem;
            padding: 0.5rem;
            min-height: 45px;
        }

        .color-display, .variant-thumbnail {
            width: 50px;
            height: 50px;
        }

        .quantity_order_btn {
            flex-direction: row;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .quantity-selector {
            margin-bottom: 0;
        }

        .quantity-selector label {
            margin-bottom: 0;
            white-space: nowrap;
        }

        .quantity-controls {
            flex-shrink: 0;
        }

        .quantity-controls button {
            width: 35px;
            height: 35px;
            font-size: 1rem;
        }

        .quantity-controls input {
            width: 50px;
            height: 35px;
        }

        .action-buttons {
            flex-direction: column;
            gap: 0.75rem;
        }

        .add-to-cart-btn, .wishlist-btn, .buy-now-btn {
            padding: 0.875rem 1.5rem;
            font-size: 1rem;
        }

        .product-features {
            grid-template-columns: 1fr;
            padding: 1.5rem;
            gap: 1rem;
        }

        .feature-item {
            gap: 0.75rem;
        }

        .feature-item i {
            font-size: 1.25rem;
        }

        .share-section {
            padding: 1rem;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .share-buttons {
            justify-content: flex-start;
        }

        .related-products-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .product-image-container {
            height: 180px;
        }

        .product-info-card {
            padding: 1rem;
        }

        .product-name a {
            font-size: 0.95rem;
        }

        .current-price {
            font-size: 1.1rem;
        }

        .original-price {
            font-size: 0.85rem;
        }

        .tab-navigation {
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .tab-btn {
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            border-bottom: 2px solid transparent;
        }
        
        .tab-btn span:not(.tab-badge) {
            font-size: 0.85rem;
        }
        
        .tab-btn i {
            font-size: 1rem;
        }
        
        .tab-badge {
            min-width: 18px;
            height: 18px;
            font-size: 0.7rem;
        }

        .tab-content {
            padding: 1.5rem;
        }

        .tab-panel h3 {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
        }


        .spec-label {
            border-right: none;
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem;
        }

        .spec-value {
            padding: 0.75rem;
        }

        .reviews-summary {
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .rating-number {
            font-size: 1rem;
        }
        
        /* Rating Distribution Mobile */
        .rating-overview {
            flex-direction: column;
            align-items: center;
            padding: 1.5rem 1rem;
            gap: 1.5rem;
        }
        
        .rating-distribution {
            width: 100%;
        }
        
        .stars {
            flex: 0 0 50px;
            font-size: 0.8rem;
        }
        
        .progress-bar-container {
            margin: 0 8px;
            height: 10px;
        }
        
        .count {
            flex: 0 0 30px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .add-review {
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .review-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .section-header h2 {
            font-size: 2rem;
        }

        /* Video Button Mobile */
        .video-btn {
            padding: 0.875rem 1.25rem;
            font-size: 0.9rem;
            gap: 0.5rem;
        }

        .video-btn i {
            width: 28px;
            height: 28px;
            font-size: 1rem;
        }

        /* Video Modal Mobile */
        .video-modal-content {
            width: 95%;
            max-width: none;
            margin: 0;
            max-height: 90vh;
        }

        .video-container {
            padding-bottom: 56.25%; /* Maintain 16:9 aspect ratio */
        }

        .close-video-modal {
            top: -45px;
            right: 10px;
            width: 40px;
            height: 40px;
            font-size: 2rem;
        }

        .close-video-btn-inner {
            width: 30px;
            height: 30px;
            font-size: 1rem;
            top: 8px;
            right: 8px;
        }
    }

    @media (max-width: 480px) {
        .container {
            padding: 0 0.75rem;
        }

        .breadcrumb {
            font-size: 0.75rem;
            gap: 0.25rem;
        }

        .breadcrumb a, .breadcrumb .current {
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        .product-title {
            font-size: 1.5rem;
            line-height: 1.3;
        }

        .current-price {
            font-size: 1.8rem;
        }

        .main-image {
            height: 400px;
        }

        .gallery-thumbnail {
            width: 60px;
            height: 60px;
        }

        .product-pricing {
            padding: 0.75rem;
        }

        .price-container {
            align-items: flex-start;
            gap: 0.5rem;
        }

        .discount-badge {
            align-self: flex-start;
        }

        .product-variants {
            padding: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .variant-selector {
            margin-bottom: 1.5rem;
        }

        .variant-selector label {
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
        }

        .color-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            max-width: none;
        }
        
        .size-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            max-width: none;
        }

        .color-btn {
            min-height: 50px;
            padding: 0.75rem;
            flex-direction: row;
            gap: 0.75rem;
            justify-content: flex-start;
        }

        .size-btn {
            min-height: 40px;
            padding: 0.5rem;
        }

        .quantity_order_btn {
            flex-direction: column-reverse;
            gap: 1rem;
            align-items: stretch;
        }

        .quantity-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .quantity-controls {
            width: fit-content;
            align-self: center;
        }

        .buy-now-btn {
            order: -1;
        }

        .action-buttons {
            gap: 0.5rem;
        }

        .add-to-cart-btn, .wishlist-btn {
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
        }

        .product-features {
            padding: 1rem;
            gap: 0.75rem;
        }

        .feature-item {
            flex-direction: column;
            text-align: center;
            gap: 0.5rem;
        }

        .share-section {
            padding: 0.75rem;
            text-align: center;
        }

        .share-buttons {
            justify-content: center;
            flex-wrap: wrap;
        }

        .share-btn {
            width: 35px;
            height: 35px;
        }

        .related-products-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .product-image-container {
            height: 200px;
        }

        .tab-navigation {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.25rem;
            border-bottom: none;
            padding-bottom: 0;
        }

        .tab-btn {
            padding: 0.75rem 0.25rem;
            font-size: 0;
            min-width: 0;
            border: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            border-radius: 8px;
            flex-direction: column;
            text-align: center;
            height: 64px;
            justify-content: center;
        }
        
        .tab-btn i {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }
        
        .tab-btn span:not(.tab-badge) {
            font-size: 0.65rem;
            display: block;
        }
        
        .tab-btn.active {
            border-color: var(--primary-color);
            background-color: rgba(var(--primary-color-rgb), 0.05);
        }
        
        .tab-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            min-width: 16px;
            height: 16px;
            font-size: 0.65rem;
            padding: 0 4px;
        }

        .tab-content {
            padding: 1rem;
        }

        .tab-panel h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .tab-panel h4 {
            font-size: 1rem;
            margin: 1.5rem 0 0.75rem;
        }

        .description-text {
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .features-list li {
            padding: 0.4rem 0;
            font-size: 0.9rem;
        }

        .spec-label, .spec-value {
            padding: 0.5rem;
            font-size: 0.9rem;
        }

        .reviews-summary {
            padding: 1rem;
        }

        .rating-number {
            font-size: 1rem;
        }

        .add-review {
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .guest-fields {
            grid-template-columns: 1fr;
            gap: 0.8rem;
            padding: 0.8rem;
        }

        .rating-input {
            padding: 0.8rem;
        }

        .rating-star {
            font-size: 1.4rem;
        }

        .form-actions {
            margin-top: 1rem;
        }

        .submit-review-btn {
            padding: 0.7rem 1.2rem;
            font-size: 0.9rem;
            min-width: 130px;
        }

        .review-item {
            padding: 1rem 0;
        }

        .review-text {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .section-header {
            margin-bottom: 2rem;
        }

        .section-header h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .section-header p {
            font-size: 1rem;
        }

        .modal-content {
            max-width: 95%;
            max-height: 95%;
        }

        .close-modal {
            top: -35px;
            width: 35px;
            height: 35px;
            font-size: 1.5rem;
        }

        /* Hide some elements on very small screens */
        .zoom-btn {
            display: none;
        }

        .image-badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
        }

        .product-badge {
            font-size: 0.6rem;
            padding: 0.2rem 0.5rem;
        }

        /* Improve touch targets */
        .color-btn, .size-btn, .tab-btn, .share-btn {
            min-height: 44px;
            min-width: 44px;
        }

        /* Stack price elements vertically on very small screens */
        .price-container {
            align-items: center;
            text-align: center;
        }

        /* Improve readability */
        .variant-selector label {
            font-weight: 700;
        }

        /* Better spacing for mobile */
        .product-actions {
            margin-bottom: 2rem;
        }

        .product-tabs {
            margin-bottom: 2rem;
        }

        .related-products-section {
            margin-top: 2rem;
        }

        /* Video Button Mobile Small */
        .video-btn {
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
            gap: 0.5rem;
        }

        .video-btn i {
            width: 24px;
            height: 24px;
            font-size: 0.9rem;
        }

        .video-btn span {
            font-size: 0.85rem;
        }

        /* Video Modal Mobile Small */
        .video-modal-content {
            width: 98%;
            max-width: none;
            margin: 0;
            max-height: 95vh;
        }

        .video-container {
            padding-bottom: 56.25%; /* Maintain 16:9 aspect ratio */
        }

        .close-video-modal {
            top: -40px;
            right: 5px;
            width: 35px;
            height: 35px;
            font-size: 1.5rem;
        }

        .close-video-btn-inner {
            width: 28px;
            height: 28px;
            font-size: 0.9rem;
            top: 6px;
            right: 6px;
        }
    }

    /* Landscape orientation optimizations */
    @media (max-width: 768px) and (orientation: landscape) {
        .main-image {
            height: 250px;
        }

        .product-detail-grid {
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .quantity_order_btn {
            flex-direction: row;
            align-items: center;
        }
    }

    /* High DPI displays */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .main-image, .product-image, .thumbnail {
            image-rendering: -webkit-optimize-contrast;
        }
    }

    /* Touch-friendly improvements */
    @media (hover: none) and (pointer: coarse) {
        .color-btn:hover,
        .size-btn:hover,
        .tab-btn:hover,
        .add-to-cart-btn:hover,
        .wishlist-btn:hover,
        .buy-now-btn:hover {
            transform: none;
        }

        .gallery-thumbnail:hover,
        .gallery-thumbnail.active {
            transform: none;
            border-width: 3px;
        }

        .product-card:hover {
            transform: none;
        }

        .product-card:hover .product-image {
            transform: none;
        }

        .zoom-btn {
            opacity: 1;
        }
    }

    /* Prevent zoom on double tap */
    .color-btn,
    .size-btn,
    .add-to-cart-btn,
    .wishlist-btn,
    .buy-now-btn,
    .tab-btn,
    .gallery-thumbnail {
        touch-action: manipulation;
    }

    /* Smooth scrolling for mobile */
    @media (max-width: 768px) {
        .thumbnail-gallery,
        .tab-navigation {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Image gallery functionality
        window.changeMainImage = function(src) {
            const mainImage = document.getElementById('main-product-image');
            const thumbnails = document.querySelectorAll('.gallery-thumbnail');
            
            mainImage.src = src;
            
            thumbnails.forEach(thumb => {
                thumb.classList.remove('active');
                if (thumb.src === src) {
                    thumb.classList.add('active');
                }
            });
        };

        // Image modal functionality
        window.openImageModal = function() {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const mainImg = document.getElementById('main-product-image');
            
            modal.style.display = 'block';
            modalImg.src = mainImg.src;
        };

        window.closeImageModal = function() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
        };

        // Video modal functionality
        window.openVideoModal = function(videoUrl) {
            const modal = document.getElementById('videoModal');
            const videoFrame = document.getElementById('videoFrame');
            
            // Convert YouTube URL to embed format
            let embedUrl = '';
            let videoId = '';
            
            // Handle different YouTube URL formats
            if (videoUrl.includes('youtube.com/watch?v=')) {
                videoId = videoUrl.split('v=')[1].split('&')[0];
            } else if (videoUrl.includes('youtu.be/')) {
                videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
            } else if (videoUrl.includes('youtube.com/embed/')) {
                videoId = videoUrl.split('embed/')[1].split('?')[0];
            } else if (videoUrl.includes('youtube.com/shorts/')) {
                // YouTube Shorts - extract video ID and convert to regular format
                videoId = videoUrl.split('shorts/')[1].split('?')[0];
            } else if (videoUrl.includes('youtube.com/v/')) {
                videoId = videoUrl.split('v/')[1].split('?')[0];
            } else {
                // If it's already an embed URL or unknown format, use as is
                embedUrl = videoUrl;
            }
            
            // Create embed URL if we extracted a video ID
            if (videoId && !embedUrl) {
                embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1&iv_load_policy=3`;
            }
            
            // Fallback: if no valid URL, show error
            if (!embedUrl) {
                alert('Invalid video URL format. Please use a valid YouTube video URL.');
                return;
            }
            
            modal.classList.add('show');
            videoFrame.src = embedUrl;
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        };

        window.closeVideoModal = function() {
            const modal = document.getElementById('videoModal');
            const videoFrame = document.getElementById('videoFrame');
            
            modal.classList.remove('show');
            videoFrame.src = ''; // Stop video playback
            document.body.style.overflow = 'auto'; // Restore scrolling
        };

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const videoModal = document.getElementById('videoModal');
            const imageModal = document.getElementById('imageModal');
            
            if (event.target === videoModal) {
                closeVideoModal();
            }
            if (event.target === imageModal) {
                closeImageModal();
            }
        });

        // Close modal with Escape key
        window.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeVideoModal();
                closeImageModal();
            }
        });

        // Quantity controls
        window.changeQuantity = function(change) {
            const quantityInput = document.getElementById('quantity');
            const currentValue = parseInt(quantityInput.value);
            const newValue = currentValue + change;
            
            if (newValue >= 1 && newValue <= 10) {
                quantityInput.value = newValue;
            }
        };

        // Variant selection functionality with grid buttons
        let selectedVariant = null;
        let selectedColor = null;
        let selectedSize = null;
        let variantsData = [];
        
        // Parse variants data from JSON
        const variantsScript = document.getElementById('variants-data');
        if (variantsScript) {
            try {
                variantsData = JSON.parse(variantsScript.textContent);
                console.log('Parsed variants data:', variantsData); // Debug log
                
                // Auto-select default variant if exists
                initializeDefaultVariant();
            } catch (e) {
                console.error('Error parsing variants data:', e);
            }
        } else {
            console.error('Variants data script not found!');
        }
        
        const colorButtons = document.querySelectorAll('.color-btn');
        const sizeButtons = document.querySelectorAll('.size-btn');
        const selectedColorLabel = document.getElementById('selected-color-label');
        const selectedSizeLabel = document.getElementById('selected-size-label');
        const mainPriceElement = document.querySelector('.current-price');
        
        // Get DOM elements for main pricing section
        const variantCurrentPrice = document.getElementById('variant-current-price');
        const variantOriginalPrice = document.getElementById('variant-original-price');
        const variantDiscountBadge = document.getElementById('variant-discount-badge');
        const variantSavings = document.getElementById('variant-savings');
        const variantPriceNote = document.getElementById('variant-price-note');
        
        // Debug: Check if elements are found
        console.log('DOM Elements:', {
            variantCurrentPrice: variantCurrentPrice,
            variantOriginalPrice: variantOriginalPrice,
            variantDiscountBadge: variantDiscountBadge,
            variantSavings: variantSavings,
            variantPriceNote: variantPriceNote
        });

        // Initialize default variant selection
        function initializeDefaultVariant() {
            console.log('Initializing default variant...');
            
            // Find the default variant
            const defaultVariant = variantsData.find(v => v.isDefault === true);
            console.log('Default variant found:', defaultVariant);
            
            if (defaultVariant) {
                // Set the selectedVariant globally first
                selectedVariant = defaultVariant;
                console.log('Set selectedVariant to:', selectedVariant);
                
                // Auto-select the default variant's color
                if (defaultVariant.color) {
                    selectedColor = defaultVariant.color;
                    
                    // Find and select the color button
                    const colorBtn = document.querySelector(`[data-color="${defaultVariant.color}"]`);
                    if (colorBtn) {
                        colorBtn.classList.add('selected');
                        
                        // Update color label
                        if (selectedColorLabel) {
                            const colorName = colorBtn.dataset.colorName || defaultVariant.color;
                            selectedColorLabel.textContent = colorName;
                        }
                        
                        console.log('Auto-selected color:', defaultVariant.color);
                    }
                }
                
                // Auto-select the default variant's size if it has one
                if (defaultVariant.size) {
                    selectedSize = defaultVariant.size;
                    
                    // Find and select the size button
                    const sizeBtn = document.querySelector(`[data-size="${defaultVariant.size}"]`);
                    if (sizeBtn) {
                        sizeBtn.classList.remove('disabled');
                        sizeBtn.disabled = false;
                        sizeBtn.classList.add('selected');
                        
                        // Update size label
                        if (selectedSizeLabel) {
                            selectedSizeLabel.textContent = defaultVariant.size;
                        }
                        
                        console.log('Auto-selected size:', defaultVariant.size);
                    }
                } else {
                    // For products without sizes, clear size selection
                    selectedSize = null;
                    if (selectedSizeLabel) {
                        selectedSizeLabel.textContent = 'No size required';
                    }
                }
                
                // Update the main image with default variant image
                updateMainImageForColor(defaultVariant.color);
                
                // Update size buttons availability
                updateSizeButtons();
                
                // Update pricing and UI
                updateMainPricing(defaultVariant);
                
                // Update add to cart button
                updateAddToCartButton();
                
                console.log('Default variant initialization completed');
                console.log('Final state - selectedColor:', selectedColor, 'selectedSize:', selectedSize, 'selectedVariant:', selectedVariant);
            } else {
                console.log('No default variant found');
            }
        }

        // Update add to cart button based on current selection
        function updateAddToCartButton() {
            const addToCartBtn = document.querySelector('.add-to-cart-btn');
            if (!addToCartBtn) return;
            
            console.log('Updating add to cart button. selectedVariant:', selectedVariant);
            
            if (selectedVariant) {
                // Set variant ID
                addToCartBtn.dataset.variantId = selectedVariant.id;
                
                // Enable/disable based on stock
                if (selectedVariant.stock > 0) {
                    addToCartBtn.disabled = false;
                    addToCartBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Add to Cart';
                    addToCartBtn.style.backgroundColor = '';
                    console.log('Enabled add to cart button for variant:', selectedVariant.name);
                } else {
                    addToCartBtn.disabled = true;
                    addToCartBtn.innerHTML = '<i class="fas fa-times-circle"></i> Out of Stock';
                }
            } else {
                // No variant selected
                addToCartBtn.disabled = true;
                if (variantsData.length > 0) {
                    // Has variants but none selected
                    const hasSizes = variantsData.some(v => v.size && v.size.trim() !== '');
                    if (hasSizes && !selectedSize) {
                        addToCartBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Select Size';
                    } else if (!selectedColor) {
                        addToCartBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Select Color';
                    } else {
                        addToCartBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Select Options';
                    }
                } else {
                    // No variants at all
                    addToCartBtn.disabled = false;
                    addToCartBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Add to Cart';
                }
                console.log('Disabled add to cart button - no variant selected');
            }
        }

        // Color selection functionality
        colorButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove selected from all color buttons
                colorButtons.forEach(btn => btn.classList.remove('selected'));
                
                // Add selected to clicked button
                this.classList.add('selected');
                selectedColor = this.dataset.color;
                
                // Update color label
                if (selectedColorLabel) {
                    const colorName = this.dataset.colorName || selectedColor;
                    selectedColorLabel.textContent = colorName;
                }
                
                // Reset size selection
                selectedSize = null;
                sizeButtons.forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // Update size label
                if (selectedSizeLabel) {
                    selectedSizeLabel.textContent = 'Please select';
                }
                
                // Update main image with color variant image (if available)
                updateMainImageForColor(selectedColor);
                
                // Show price range for selected color
                updatePriceRangeForColor(selectedColor);
                
                // Enable/disable size buttons based on available combinations
                updateSizeButtons();
                
                // Update variant selection
                updateVariantSelection();
            });
        });

        // Size selection functionality
        sizeButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Don't select disabled or out-of-stock buttons
                if (this.classList.contains('disabled') || this.classList.contains('out-of-stock')) {
                    return;
                }
                
                // Remove selected from all size buttons
                sizeButtons.forEach(btn => btn.classList.remove('selected'));
                
                // Add selected to clicked button
                this.classList.add('selected');
                selectedSize = this.dataset.size;
                
                // Update size label
                if (selectedSizeLabel) {
                    selectedSizeLabel.textContent = selectedSize;
                }
                
                // Update variant selection
                updateVariantSelection();
            });
        });

        // Update main image based on selected color
        function updateMainImageForColor(color) {
            const mainImage = document.getElementById('main-product-image');
            if (!mainImage || !color) return;
            
            // Find any variant with this color that has an image
            const colorVariant = variantsData.find(v => 
                v.color === color && v.image && v.image !== '{{ MEDIA_URL }}default.webp'
            );
            
            if (colorVariant && colorVariant.image) {
                mainImage.src = colorVariant.image;
                mainImage.alt = colorVariant.name || colorVariant.colorName;
            }
        }

        // Update pricing to show range for selected color
        function updatePriceRangeForColor(color) {
            if (!color) {
                updateMainPricing(null);
                return;
            }

            // Get all variants for this color
            const colorVariants = variantsData.filter(v => v.color === color);
            
            if (colorVariants.length === 0) return;

            // Find min and max prices for this color
            const prices = colorVariants.map(v => parseFloat(v.price));
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);

            // Update pricing display
            if (variantCurrentPrice) {
                if (minPrice === maxPrice) {
                    variantCurrentPrice.textContent = '$' + minPrice.toFixed(2);
                } else {
                    variantCurrentPrice.textContent = '$' + minPrice.toFixed(2) + ' - $' + maxPrice.toFixed(2);
                }
            }

            // Handle compare prices
            const comparePrices = colorVariants.map(v => parseFloat(v.comparePrice) || 0).filter(p => p > 0);
            if (comparePrices.length > 0) {
                const minComparePrice = Math.min(...comparePrices);
                const maxComparePrice = Math.max(...comparePrices);
                
                if (variantOriginalPrice) {
                    variantOriginalPrice.style.display = 'inline';
                    if (minComparePrice === maxComparePrice) {
                        variantOriginalPrice.textContent = '$' + minComparePrice.toFixed(2);
                    } else {
                        variantOriginalPrice.textContent = '$' + minComparePrice.toFixed(2) + ' - $' + maxComparePrice.toFixed(2);
                    }
                }

                // Show discount badge if there are savings
                if (variantDiscountBadge) {
                    variantDiscountBadge.style.display = 'inline';
                    variantDiscountBadge.textContent = 'UP TO ' + Math.round((minPrice / minComparePrice) * 100) + '% OFF';
                }

                // Show savings
                if (variantSavings) {
                    variantSavings.style.display = 'block';
                    const maxSavings = maxComparePrice - minPrice;
                    variantSavings.textContent = 'Save up to $' + maxSavings.toFixed(2);
                }
            } else {
                // Hide discount elements
                if (variantOriginalPrice) variantOriginalPrice.style.display = 'none';
                if (variantDiscountBadge) variantDiscountBadge.style.display = 'none';
                if (variantSavings) variantSavings.style.display = 'none';
            }

            // Show price note
            // if (variantPriceNote) {
            //     variantPriceNote.style.display = 'block';
            //     if (minPrice !== maxPrice) {
            //         variantPriceNote.innerHTML = '<small>Price varies by size selection</small>';
            //     } else {
            //         variantPriceNote.innerHTML = '<small>Select size to continue</small>';
            //     }
            // }
        }

        // Update size buttons availability based on selected color
        function updateSizeButtons() {
            if (!selectedColor) {
                // If no color selected, disable all size buttons
                sizeButtons.forEach(btn => {
                    btn.classList.add('disabled');
                    btn.classList.remove('out-of-stock');
                    btn.disabled = true;
                });
                return;
            }
            
            // Enable/disable size buttons based on availability for selected color
            sizeButtons.forEach(btn => {
                const size = btn.dataset.size;
                
                // Find if this color-size combination exists and has stock
                const variant = variantsData.find(v => 
                    v.color === selectedColor && v.size === size
                );
                
                if (variant) {
                    btn.classList.remove('disabled');
                    btn.disabled = false;
                    
                    if (variant.stock > 0) {
                        btn.classList.remove('out-of-stock');
                    } else {
                        btn.classList.add('out-of-stock');
                    }
                } else {
                    // No variant found for this combination
                    btn.classList.add('disabled');
                    btn.classList.remove('out-of-stock');
                    btn.disabled = true;
                }
            });
        }

        // Update main pricing section based on variant
        function updateMainPricing(variant) {
            console.log('updateMainPricing called with variant:', variant);
            
            // Get DOM elements fresh each time to ensure they exist
            const currentPriceElement = document.getElementById('variant-current-price');
            const originalPriceElement = document.getElementById('variant-original-price');
            const discountBadgeElement = document.getElementById('variant-discount-badge');
            const savingsElement = document.getElementById('variant-savings');
            const priceNoteElement = document.getElementById('variant-price-note');
            
            console.log('DOM elements found:', {
                currentPriceElement: !!currentPriceElement,
                originalPriceElement: !!originalPriceElement,
                discountBadgeElement: !!discountBadgeElement,
                savingsElement: !!savingsElement,
                priceNoteElement: !!priceNoteElement
            });
            
            const basePrice = {{ product.price }};
            const baseComparePrice = {{ product.compare_price|default:0 }};
            
            if (!variant) {
                console.log('No variant selected, showing base price:', basePrice);
                // Reset to product base price
                if (currentPriceElement) {
                    currentPriceElement.textContent = '$' + basePrice.toFixed(2);
                    console.log('Set base price:', currentPriceElement.textContent);
                }
                if (originalPriceElement) {
                    if (baseComparePrice > basePrice) {
                        originalPriceElement.style.display = 'inline';
                        originalPriceElement.textContent = '$' + baseComparePrice.toFixed(2);
                    } else {
                        originalPriceElement.style.display = 'none';
                    }
                }
                if (discountBadgeElement) {
                    if (baseComparePrice > basePrice) {
                        discountBadgeElement.style.display = 'inline';
                        const discount = Math.round((basePrice / baseComparePrice) * 100);
                        discountBadgeElement.textContent = discount + '% OFF';
                    } else {
                        discountBadgeElement.style.display = 'none';
                    }
                }
                if (savingsElement) {
                    if (baseComparePrice > basePrice) {
                        savingsElement.style.display = 'block';
                        const savings = baseComparePrice - basePrice;
                        savingsElement.textContent = 'You save $' + savings.toFixed(2);
                    } else {
                        savingsElement.style.display = 'none';
                    }
                }
                if (priceNoteElement) priceNoteElement.style.display = 'none';
                return;
            }

            const price = parseFloat(variant.price);
            const comparePrice = parseFloat(variant.comparePrice) || 0;
            
            console.log('Updating to variant price:', price, 'comparePrice:', comparePrice);

            // Update current price
            if (currentPriceElement) {
                currentPriceElement.textContent = '$' + price.toFixed(2);
                console.log('Updated main price to:', currentPriceElement.textContent);
            } else {
                console.error('Current price element not found!');
            }

            // Handle original price and discount
            if (comparePrice > price) {
                console.log('Showing discount pricing');
                // Show discount elements
                if (originalPriceElement) {
                    originalPriceElement.style.display = 'inline';
                    originalPriceElement.textContent = '$' + comparePrice.toFixed(2);
                }
                if (discountBadgeElement) {
                    discountBadgeElement.style.display = 'inline';
                    const discount = Math.round((price / comparePrice) * 100);
                    discountBadgeElement.textContent = discount + '% OFF';
                }
                if (savingsElement) {
                    savingsElement.style.display = 'block';
                    const savings = comparePrice - price;
                    savingsElement.textContent = 'You save $' + savings.toFixed(2);
                }
            } else {
                console.log('Hiding discount pricing');
                // Hide discount elements
                if (originalPriceElement) originalPriceElement.style.display = 'none';
                if (discountBadgeElement) discountBadgeElement.style.display = 'none';
                if (savingsElement) savingsElement.style.display = 'none';
            }

            // Show variant price note
            if (priceNoteElement) priceNoteElement.style.display = 'block';
        }

        // Update variant selection and display info
        function updateVariantSelection() {
            console.log('updateVariantSelection called - selectedColor:', selectedColor, 'selectedSize:', selectedSize);
            
            if (!selectedColor) {
                // No color selected - reset everything
                selectedVariant = null;
                
                // Reset main pricing section
                updateMainPricing(null);

                return;
            }
            
            // Color is selected, check if we also have size
            if (selectedColor && selectedSize) {
                // Find the exact variant with both color and size
                const variant = variantsData.find(v => 
                    v.color === selectedColor && v.size === selectedSize
                );
                
                console.log('Found exact variant:', variant);
                
                if (variant) {
                    selectedVariant = variant;
                    
                    // Update main pricing section with variant data
                    updateMainPricing(variant);
                    
                    // Update main product image if variant has an image
                    const mainImage = document.getElementById('main-product-image');
                    if (mainImage && variant.image && variant.image !== '{{ MEDIA_URL }}default.webp') {
                        mainImage.src = variant.image;
                        mainImage.alt = variant.name;
                    }
                    
                    // Update add to cart button
                    const addToCartBtn = document.querySelector('.add-to-cart-btn');
                    if (addToCartBtn) {
                        addToCartBtn.dataset.variantId = variant.id;
                        
                        // Enable/disable based on stock
                        if (variant.stock > 0) {
                            addToCartBtn.disabled = false;
                            addToCartBtn.textContent = 'Add to Cart';
                        } else {
                            addToCartBtn.disabled = true;
                            addToCartBtn.textContent = 'Out of Stock';
                        }
                    }
                    
                    // Update quantity max based on stock
                    const quantityInput = document.getElementById('quantity');
                    if (quantityInput) {
                        quantityInput.max = Math.min(10, parseInt(variant.stock));
                        if (parseInt(quantityInput.value) > parseInt(variant.stock)) {
                            quantityInput.value = Math.max(1, variant.stock);
                        }
                    }
                } else {
                    console.log('Exact variant not found');
                    // Reset to color-only logic below
                    selectedVariant = null;
                }
            }
            
            // If only color is selected (no size), or exact variant not found
            if (selectedColor && (!selectedSize || !selectedVariant)) {
                console.log('Only color selected, finding color variants');
                
                // Find all variants for this color
                const colorVariants = variantsData.filter(v => v.color === selectedColor);
                console.log('Color variants found:', colorVariants);
                
                if (colorVariants.length > 0) {
                    // Check if this product has sizes at all
                    const hasSizes = variantsData.some(v => v.size && v.size.trim() !== '');
                    console.log('Product has sizes:', hasSizes);
                    
                    if (!hasSizes) {
                        // No sizes available for this product - use the first color variant
                        selectedVariant = colorVariants[0];
                        console.log('No sizes available, selected variant:', selectedVariant);
                        
                        // Update add to cart button
                        const addToCartBtn = document.querySelector('.add-to-cart-btn');
                        if (addToCartBtn) {
                            addToCartBtn.dataset.variantId = selectedVariant.id;
                            
                            // Enable/disable based on stock
                            if (selectedVariant.stock > 0) {
                                addToCartBtn.disabled = false;
                                addToCartBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Add to Cart';
                            } else {
                                addToCartBtn.disabled = true;
                                addToCartBtn.innerHTML = '<i class="fas fa-times-circle"></i> Out of Stock';
                            }
                        }
                        
                        // Update quantity max based on stock
                        const quantityInput = document.getElementById('quantity');
                        if (quantityInput) {
                            quantityInput.max = Math.min(10, parseInt(selectedVariant.stock));
                            if (parseInt(quantityInput.value) > parseInt(selectedVariant.stock)) {
                                quantityInput.value = Math.max(1, selectedVariant.stock);
                            }
                        }
                    } else {
                        // Product has sizes - need size selection
                        selectedVariant = null;
                        
                        // Disable add to cart button
                        const addToCartBtn = document.querySelector('.add-to-cart-btn');
                        if (addToCartBtn) {
                            addToCartBtn.disabled = true;
                            addToCartBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Select Size';
                        }
                    }
                    
                    // Use the first variant for this color to show pricing
                    const firstColorVariant = colorVariants[0];
                    
                    // Update main pricing section with color variant data
                    updateMainPricing(firstColorVariant);
                    
                    // Update main product image if variant has an image
                    const mainImage = document.getElementById('main-product-image');
                    if (mainImage && firstColorVariant.image && firstColorVariant.image !== '{{ MEDIA_URL }}default.webp') {
                        mainImage.src = firstColorVariant.image;
                        mainImage.alt = firstColorVariant.name;
                    }
                } else {
                    console.log('No variants found for color:', selectedColor);
                    // Reset main pricing section
                    updateMainPricing(null);
                    selectedVariant = null;
                }
            }
            
            // Always update the add to cart button at the end
            updateAddToCartButton();
        }

        // Initialize size buttons state
        updateSizeButtons();

        // Enhanced Tab functionality
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabPanels = document.querySelectorAll('.tab-panel');
        const tabNav = document.getElementById('product-tabs-nav');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const targetTab = this.dataset.tab;
                
                // Remove active class from all tabs and panels
                tabBtns.forEach(b => b.classList.remove('active'));
                tabPanels.forEach(p => p.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding panel
                this.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
                
                // Smooth scroll tab into view for better mobile UX
                if (window.innerWidth < 768) {
                    setTimeout(() => {
                        // Get the selected tab's position
                        const buttonLeft = this.offsetLeft;
                        const buttonWidth = this.offsetWidth;
                        const navWidth = tabNav.offsetWidth;
                        
                        // Calculate where to scroll to center the button
                        const scrollPos = buttonLeft - (navWidth / 2) + (buttonWidth / 2);
                        tabNav.scrollTo({
                            left: scrollPos,
                            behavior: 'smooth'
                        });
                    }, 100);
                }
                
                // Update URL hash for direct linking (without scrolling)
                history.replaceState(null, null, '#' + targetTab);
            });
        });
        
        // Check for URL hash to open specific tab on page load
        const hash = window.location.hash.substring(1);
        if (hash) {
            const targetTab = document.querySelector(`.tab-btn[data-tab="${hash}"]`);
            if (targetTab) {
                targetTab.click();
                // Small delay to ensure the page is fully loaded
                setTimeout(() => {
                    window.scrollTo({
                        top: tabNav.offsetTop - 20,
                        behavior: 'smooth'
                    });
                }, 300);
            }
        }

        // Star rating for reviews
        const starRating = document.querySelector('.star-rating');
        if (starRating) {
            const stars = starRating.querySelectorAll('i');
            
            stars.forEach((star, index) => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    
                    stars.forEach((s, i) => {
                        if (i < rating) {
                            s.classList.remove('far');
                            s.classList.add('fas', 'active');
                        } else {
                            s.classList.remove('fas', 'active');
                            s.classList.add('far');
                        }
                    });
                });
                
                star.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.dataset.rating);
                    
                    stars.forEach((s, i) => {
                        if (i < rating) {
                            s.style.color = 'var(--warning-color)';
                        } else {
                            s.style.color = 'var(--border-color)';
                        }
                    });
                });
            });
            
            starRating.addEventListener('mouseleave', function() {
                stars.forEach(s => {
                    if (!s.classList.contains('active')) {
                        s.style.color = 'var(--border-color)';
                    }
                });
            });
        }

        // Enhanced Rating System
        const ratingStars = document.querySelectorAll('.rating-star');
        const ratingValueInput = document.getElementById('ratingValue');
        const ratingText = document.querySelector('.rating-text');
        const selectedRatingText = document.getElementById('selectedRatingText');
        
        // Rating messages for each star value
        const ratingMessages = {
            1: 'Poor - Major issues that I can\'t ignore',
            2: 'Fair - Below average with some issues',
            3: 'Average - Meets basic expectations',
            4: 'Good - Above average quality',
            5: 'Excellent - Outstanding in every way'
        };
        
        // Rating star click event
        ratingStars.forEach(star => {
            star.addEventListener('click', function() {
                const rating = this.dataset.rating;
                ratingValueInput.value = rating;
                
                // Update star UI
                ratingStars.forEach(s => {
                    if (s.dataset.rating <= rating) {
                        s.classList.remove('far');
                        s.classList.add('fas');
                    } else {
                        s.classList.remove('fas');
                        s.classList.add('far');
                    }
                });
                
                // Update text
                ratingText.style.display = 'none';
                selectedRatingText.textContent = ratingMessages[rating] || `${rating} star${rating > 1 ? 's' : ''}`;
                selectedRatingText.style.display = 'block';
            });
            
            // Hover effects
            star.addEventListener('mouseenter', function() {
                const rating = this.dataset.rating;
                
                // Only apply hover effects if no rating is selected
                if (!ratingValueInput.value) {
                    // Update stars on hover
                    ratingStars.forEach(s => {
                        if (s.dataset.rating <= rating) {
                            s.classList.remove('far');
                            s.classList.add('fas');
                        } else {
                            s.classList.remove('fas');
                            s.classList.add('far');
                        }
                    });
                }
            });
            
            star.addEventListener('mouseleave', function() {
                // Only reset if no rating is selected
                if (!ratingValueInput.value) {
                    ratingStars.forEach(s => {
                        s.classList.remove('fas');
                        s.classList.add('far');
                    });
                } else {
                    // Restore selected rating
                    const rating = ratingValueInput.value;
                    ratingStars.forEach(s => {
                        if (s.dataset.rating <= rating) {
                            s.classList.remove('far');
                            s.classList.add('fas');
                        } else {
                            s.classList.remove('fas');
                            s.classList.add('far');
                        }
                    });
                }
            });
        });
        
        // Add to cart functionality
        const addToCartBtns = document.querySelectorAll('.add-to-cart-btn, .quick-add-btn');
        addToCartBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.dataset.productId;
                const variantId = this.dataset.variantId || selectedVariant?.id || null;
                const quantity = document.getElementById('quantity') ? 
                    document.getElementById('quantity').value : 1;
                
                // Check if variant is selected and has stock
                if (selectedVariant && parseInt(selectedVariant.stock) < parseInt(quantity)) {
                    alert(`Only ${selectedVariant.stock} items available for ${selectedVariant.name}`);
                    return;
                }
                
                // Add loading state
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
                this.disabled = true;
                
                // Prepare data for API call
                const cartData = {
                    product_id: productId,
                    variant_id: variantId,
                    quantity: quantity
                };
                
                console.log('Adding to cart:', cartData); // For debugging
                
                // Simulate API call (replace with actual implementation)
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-check"></i> Added!';
                    this.style.background = 'var(--success-color)';
                    
                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.style.background = '';
                        this.disabled = false;
                    }, 2000);
                }, 1000);
            });
        });

        // Wishlist functionality
        const wishlistBtns = document.querySelectorAll('.wishlist-btn');
        wishlistBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const icon = this.querySelector('i');
                if (icon.classList.contains('far')) {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    this.style.background = 'var(--danger-color)';
                    this.style.color = 'var(--white)';
                    this.style.borderColor = 'var(--danger-color)';
                } else {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    this.style.background = '';
                    this.style.color = '';
                    this.style.borderColor = '';
                }
            });
        });

        // Share functionality
        const shareBtns = document.querySelectorAll('.share-btn');
        shareBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const platform = this.classList[1]; // facebook, twitter, etc.
                const url = window.location.href;
                const title = document.querySelector('.product-title').textContent;
                
                let shareUrl = '';
                
                switch(platform) {
                    case 'facebook':
                        shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
                        break;
                    case 'twitter':
                        shareUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`;
                        break;
                    case 'pinterest':
                        const imageUrl = document.getElementById('main-product-image').src;
                        shareUrl = `https://pinterest.com/pin/create/button/?url=${encodeURIComponent(url)}&media=${encodeURIComponent(imageUrl)}&description=${encodeURIComponent(title)}`;
                        break;
                    case 'copy-link':
                        navigator.clipboard.writeText(url).then(() => {
                            this.innerHTML = '<i class="fas fa-check"></i>';
                            setTimeout(() => {
                                this.innerHTML = '<i class="fas fa-link"></i>';
                            }, 2000);
                        });
                        return;
                }
                
                if (shareUrl) {
                    window.open(shareUrl, '_blank', 'width=600,height=400');
                }
            });
        });

        // Close modal on outside click
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
        
        // Add to cart functionality
        function addToCart() {
            const productId = document.querySelector('.add-to-cart-btn').dataset.productId;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            
            console.log('addToCart called. selectedVariant:', selectedVariant);
            console.log('variantsData.length:', variantsData.length);
            
            // Check if variants exist and are selected
            if (variantsData.length > 0) {
                if (!selectedVariant) {
                    // Try to find and set default variant if none is selected
                    const defaultVariant = variantsData.find(v => v.isDefault === true);
                    if (defaultVariant) {
                        console.log('Using default variant for add to cart:', defaultVariant);
                        selectedVariant = defaultVariant;
                    } else {
                        alert('Please select product options before adding to cart.');
                        return;
                    }
                }
            }
            
            const data = {
                product_id: parseInt(productId),
                quantity: quantity
            };
            
            if (selectedVariant) {
                data.variant_id = selectedVariant.id;
            }
            
            // Show loading state
            const addToCartBtn = document.querySelector('.add-to-cart-btn');
            const originalText = addToCartBtn.innerHTML;
            addToCartBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            addToCartBtn.disabled = true;
            
            fetch('/api/v1/cart/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    // Success feedback
                    addToCartBtn.innerHTML = '<i class="fas fa-check"></i> Added!';
                    addToCartBtn.style.backgroundColor = '#28a745';
                    
                    // Update cart count
                    updateCartCount();
                    
                    // Reset button after 2 seconds
                    setTimeout(() => {
                        addToCartBtn.innerHTML = originalText;
                        addToCartBtn.style.backgroundColor = '';
                        addToCartBtn.disabled = false;
                    }, 2000);
                    
                    // Show success message
                    showNotification('Product added to cart successfully!', 'success');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding product to cart. Please try again.');
            })
            .finally(() => {
                if (addToCartBtn.disabled) {
                    addToCartBtn.innerHTML = originalText;
                    addToCartBtn.disabled = false;
                }
            });
        }
        
        // Buy now functionality
        function buyNow() {
            const productId = document.querySelector('.buy-now-btn').dataset.productId;
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            
            console.log('buyNow called. selectedVariant:', selectedVariant);
            
            // Check if variants exist and are selected
            if (variantsData.length > 0) {
                if (!selectedVariant) {
                    // Try to find and set default variant if none is selected
                    const defaultVariant = variantsData.find(v => v.isDefault === true);
                    if (defaultVariant) {
                        console.log('Using default variant for buy now:', defaultVariant);
                        selectedVariant = defaultVariant;
                    } else {
                        alert('Please select product options before proceeding.');
                        return;
                    }
                }
            }
            
            const data = {
                product_id: parseInt(productId),
                quantity: quantity
            };
            
            if (selectedVariant) {
                data.variant_id = selectedVariant.id;
            }
            
            // Add to cart first, then redirect to checkout
            fetch('/api/v1/cart/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    // Redirect to checkout
                    window.location.href = '/checkout/';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error processing your request. Please try again.');
            });
        }
        
        // Utility functions
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        function updateCartCount() {
            fetch('/api/v1/cart/', {
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                const cartCount = document.querySelector('.cart-count');
                if (cartCount && data.total_items) {
                    cartCount.textContent = data.total_items;
                }
            })
            .catch(error => console.error('Error updating cart count:', error));
        }
        
        function showNotification(message, type = 'success') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            // Choose icon based on type
            let icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            
            notification.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 4 seconds for success, 5 seconds for errors
            const duration = type === 'success' ? 4000 : 5000;
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, duration);
        }
        // Add event listeners
        document.querySelector('.add-to-cart-btn').addEventListener('click', addToCart);
        document.querySelector('.buy-now-btn').addEventListener('click', buyNow);
        
        // Update cart count on page load
        updateCartCount();
        
        // Initialize review functionality
        initializeReviewSystem();
    });

    // Review System JavaScript
    function initializeReviewSystem() {
        // Star rating functionality
        const ratingStars = document.querySelectorAll('.rating-star');
        const ratingValue = document.getElementById('ratingValue');
        const ratingText = document.querySelector('.rating-text');
        
        ratingStars.forEach((star, index) => {
            star.addEventListener('click', () => {
                const rating = index + 1;
                ratingValue.value = rating;
                
                // Update star display
                ratingStars.forEach((s, i) => {
                    if (i < rating) {
                        s.classList.remove('far');
                        s.classList.add('fas', 'active');
                    } else {
                        s.classList.remove('fas', 'active');
                        s.classList.add('far');
                    }
                });
                
                // Update rating text
                const ratingTexts = ['Terrible', 'Poor', 'Average', 'Good', 'Excellent'];
                ratingText.textContent = `You rated: ${rating}/5 - ${ratingTexts[rating - 1]}`;
            });
            
            star.addEventListener('mouseenter', () => {
                const rating = index + 1;
                ratingStars.forEach((s, i) => {
                    if (i < rating) {
                        s.style.color = '#ffc107';
                    } else {
                        s.style.color = '#e0e0e0';
                    }
                });
            });
        });
        
        // Reset on mouse leave
        document.querySelector('.star-rating-input').addEventListener('mouseleave', () => {
            const currentRating = parseInt(ratingValue.value) || 0;
            ratingStars.forEach((s, i) => {
                if (i < currentRating) {
                    s.style.color = '#ffc107';
                } else {
                    s.style.color = '#e0e0e0';
                }
            });
        });
        
        // Image upload functionality
        const fileInput = document.getElementById('reviewImages');
        const imagePreviewContainer = document.querySelector('.image-preview-container');
        const uploadPlaceholder = document.querySelector('.upload-placeholder');
        let selectedFiles = [];
        
        fileInput.addEventListener('change', handleImageSelection);
        
        // Drag and drop functionality
        uploadPlaceholder.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadPlaceholder.style.borderColor = 'var(--primary-color)';
            uploadPlaceholder.style.background = 'rgba(var(--primary-color-rgb), 0.05)';
        });
        
        uploadPlaceholder.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadPlaceholder.style.borderColor = 'var(--border-color)';
            uploadPlaceholder.style.background = 'var(--light-color)';
        });
        
        uploadPlaceholder.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadPlaceholder.style.borderColor = 'var(--border-color)';
            uploadPlaceholder.style.background = 'var(--light-color)';
            
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            handleFiles(files);
        });
        
        function handleImageSelection(e) {
            const files = Array.from(e.target.files);
            handleFiles(files);
        }
        
        function handleFiles(files) {
            // Limit to 5 images
            const remainingSlots = 5 - selectedFiles.length;
            const filesToAdd = files.slice(0, remainingSlots);
            
            filesToAdd.forEach((file, index) => {
                if (file.size > 5 * 1024 * 1024) {
                    showNotification(`Image "${file.name}" is too large. Maximum size is 5MB.`, 'error');
                    return;
                }
                
                selectedFiles.push(file);
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    createImagePreview(e.target.result, selectedFiles.length - 1);
                };
                reader.readAsDataURL(file);
            });
            
            if (files.length > remainingSlots) {
                showNotification(`Only ${remainingSlots} more images can be added. Limit is 5 images total.`, 'warning');
            }
            
            updateUploadPlaceholder();
        }
        
        function createImagePreview(src, index) {
            const preview = document.createElement('div');
            preview.className = 'image-preview';
            preview.setAttribute('data-index', index);
            preview.innerHTML = `
                <img src="${src}" alt="Preview">
                <button type="button" class="remove-image" data-index="${index}">×</button>
            `;
            imagePreviewContainer.appendChild(preview);
        }
        
        // Add event delegation for remove buttons
        imagePreviewContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-image')) {
                e.preventDefault();
                e.stopPropagation();
                const index = parseInt(e.target.getAttribute('data-index'));
                console.log('Remove button clicked, index:', index);
                removeImage(index);
            }
        });
        
        function updateUploadPlaceholder() {
            if (selectedFiles.length >= 5) {
                uploadPlaceholder.style.display = 'none';
            } else {
                uploadPlaceholder.style.display = 'block';
                uploadPlaceholder.querySelector('small').textContent = 
                    `You can upload ${5 - selectedFiles.length} more images (Max 5MB each)`;
            }
        }
        
        // Make removeImage function global
        window.removeImage = function(index) {
            try {
                console.log('Removing image at index:', index);
                console.log('Before removal - selectedFiles length:', selectedFiles.length);
                console.log('selectedFiles array:', selectedFiles);
                
                // Validate index
                if (index < 0 || index >= selectedFiles.length) {
                    console.error('Invalid index:', index);
                    return;
                }
                
                // Remove the file from the array
                selectedFiles.splice(index, 1);
                console.log('After removal - selectedFiles length:', selectedFiles.length);
                
                // Clear and rebuild all previews with correct indices
                imagePreviewContainer.innerHTML = '';
                selectedFiles.forEach((file, newIndex) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        createImagePreview(e.target.result, newIndex);
                    };
                    reader.readAsDataURL(file);
                });
                
                // Update the file input
                updateFileInput();
                
                // Update upload placeholder
                updateUploadPlaceholder();
                
                // Show notification
                showNotification('Image removed successfully', 'success');
                
            } catch (error) {
                console.error('Error removing image:', error);
                showNotification('Failed to remove image', 'error');
            }
        };
        
        // Function to update the file input with current selectedFiles
        function updateFileInput() {
            try {
                // Create a new FileList from selectedFiles
                const dt = new DataTransfer();
                selectedFiles.forEach(file => {
                    dt.items.add(file);
                });
                fileInput.files = dt.files;
                console.log('File input updated successfully');
            } catch (error) {
                console.warn('Could not update file input:', error);
                // Clear the file input as fallback
                fileInput.value = '';
            }
        }
        
        // Form submission
        const reviewForm = document.getElementById('reviewForm');
        reviewForm.addEventListener('submit', handleReviewSubmission);
        
        async function handleReviewSubmission(e) {
            e.preventDefault();
            
            const submitBtn = document.querySelector('.submit-review-btn');
            const loadingSpinner = document.querySelector('.loading-spinner');
            const formMessages = document.querySelector('.form-messages');
            
            // Validate form
            const rating = document.getElementById('ratingValue').value;
            const comment = document.getElementById('reviewComment').value;
            const guestName = document.getElementById('guestName');
            
            if (!rating) {
                showNotification('Please select a rating', 'error');
                return;
            }
            
            if (!comment.trim()) {
                showNotification('Please write a review comment', 'error');
                return;
            }
            
            if (guestName && !guestName.value.trim()) {
                showNotification('Please enter your name', 'error');
                return;
            }
            
            // Show loading state
            submitBtn.style.display = 'none';
            loadingSpinner.style.display = 'flex';
            
            try {
                const formData = new FormData();
                formData.append('rating', rating);
                formData.append('comment', comment);
                
                if (guestName) {
                    formData.append('guest_name', guestName.value);
                    const guestEmail = document.getElementById('guestEmail').value;
                    if (guestEmail) formData.append('guest_email', guestEmail);
                }
                
                // Add images
                selectedFiles.forEach((file, index) => {
                    formData.append('uploaded_images', file);
                });
                
                const productId = document.getElementById('productId').value;
                console.log('Submitting form data for product:', productId);
                
                const response = await fetch(`/frontend/submit-review/${productId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Accept': 'application/json',
                    },
                    body: formData
                });
                
                const result = await response.json();
                console.log('Response status:', response.status);
                console.log('Response data:', result);
                
                if (result.success) {
                    // Success message for review submission
                    const successMessage = result.message || 'Review submitted successfully!';
                    showNotification(successMessage, 'success');
                    
                    // Reset form
                    reviewForm.reset();
                    ratingValue.value = '';
                    selectedFiles = [];
                    imagePreviewContainer.innerHTML = '';
                    updateUploadPlaceholder();
                    
                    // Reset star rating
                    ratingStars.forEach(star => {
                        star.classList.remove('fas', 'active');
                        star.classList.add('far');
                        star.style.color = '#e0e0e0';
                    });
                    
                    ratingText.textContent = 'Click to rate this product';
                    
                    // Reload reviews after a short delay
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    // Handle validation errors
                    if (result.errors) {
                        let errorMessage = 'Please fix the following errors:\n';
                        for (const [field, error] of Object.entries(result.errors)) {
                            errorMessage += `• ${error}\n`;
                        }
                        showNotification(errorMessage, 'error');
                    } else {
                        showNotification(result.message || 'Failed to submit review', 'error');
                    }
                }
            } catch (error) {
                console.error('Error submitting review:', error);
                showNotification('Failed to submit review. Please try again.', 'error');
            } finally {
                submitBtn.style.display = 'flex';
                loadingSpinner.style.display = 'none';
            }
        }
    }

    // Review image modal functionality
    window.openReviewImageModal = function(imageSrc, caption) {
        let modal = document.getElementById('reviewImageModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'reviewImageModal';
            modal.className = 'review-image-modal';
            modal.innerHTML = `
                <div class="review-modal-content">
                    <button class="close-review-modal" onclick="closeReviewImageModal()">&times;</button>
                    <img id="reviewModalImage" src="" alt="">
                    <div class="modal-caption" id="reviewModalCaption"></div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        document.getElementById('reviewModalImage').src = imageSrc;
        document.getElementById('reviewModalCaption').textContent = caption;
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    };

    window.closeReviewImageModal = function() {
        const modal = document.getElementById('reviewImageModal');
        if (modal) {
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }
    };

    // Load more reviews functionality
    let currentReviewPage = 1;
    window.loadMoreReviews = async function() {
        try {
            currentReviewPage++;
            const productId = document.getElementById('productId').value;
            const response = await fetch(`/api/v1/products/${productId}/reviews/?page=${currentReviewPage}`);
            
            if (response.ok) {
                const data = await response.json();
                // Implementation for appending more reviews would go here
                console.log('More reviews loaded:', data);
            }
        } catch (error) {
            console.error('Error loading more reviews:', error);
        }
    };
</script>
{% endblock %}
