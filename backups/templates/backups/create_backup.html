{% extends 'backups/base.html' %}

{% block title %}Create New Backup{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-plus me-2"></i>
                    Create New Backup
                </h4>
            </div>
            <div class="card-body">
                <form id="createBackupForm" method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="name" class="form-label">Backup Name</label>
                        <input type="text" class="form-control" id="name" name="name" 
                               placeholder="Leave empty for auto-generated name">
                        <div class="form-text">
                            If not provided, a name will be automatically generated based on type and timestamp.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"
                                  placeholder="Optional description for this backup"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="backup_type" class="form-label">Backup Type</label>
                        <select class="form-select" id="backup_type" name="backup_type" required>
                            {% for value, label in backup_types %}
                                <option value="{{ value }}" {% if value == 'full' %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <strong>Full:</strong> Database + Media files<br>
                            <strong>Database:</strong> Only database content<br>
                            <strong>Media:</strong> Only media files
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="include_media" 
                                       name="include_media" checked>
                                <label class="form-check-label" for="include_media">
                                    Include Media Files
                                </label>
                                <div class="form-text">
                                    Include uploaded media files (images, documents, etc.)
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="compress" 
                                       name="compress" checked>
                                <label class="form-check-label" for="compress">
                                    Compress Backup
                                </label>
                                <div class="form-text">
                                    Compress backup files to save storage space
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Large backups may take several minutes to complete. 
                        You can monitor progress on the dashboard or backup list page.
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'backups:dashboard' %}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-arrow-left me-2"></i>
                            Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <span class="loading-text">
                                <i class="fas fa-play me-2"></i>
                                Start Backup
                            </span>
                            <span class="loading-spinner spinner-border spinner-border-sm" role="status"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Backup Progress (hidden initially) -->
        <div class="card mt-3" id="progressCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog fa-spin me-2"></i>
                    Backup in Progress
                </h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         id="progressBar" role="progressbar" style="width: 0%">
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <span id="progressStatus">Initializing backup...</span>
                    <span id="progressPercentage">0%</span>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>Backup ID:</strong> <span id="backupId">-</span>
                    </small>
                </div>
                
                <div class="mt-3">
                    <a href="{% url 'backups:backup_list' %}" class="btn btn-sm btn-outline-primary">
                        View in Backup List
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Handle backup type change
        $('#backup_type').change(function() {
            const backupType = $(this).val();
            const includeMedia = $('#include_media');
            
            if (backupType === 'database') {
                includeMedia.prop('checked', false).prop('disabled', true);
            } else if (backupType === 'media') {
                includeMedia.prop('checked', true).prop('disabled', true);
            } else {
                includeMedia.prop('disabled', false);
            }
        });
        
        // Handle form submission
        $('#createBackupForm').submit(function(e) {
            e.preventDefault();
            
            const form = $(this);
            const submitBtn = form.find('button[type="submit"]');
            
            // Show loading state
            showLoading(submitBtn[0]);
            
            // Submit form
            $.post(form.attr('action') || window.location.href, form.serialize())
                .done(function(response) {
                    if (response.success) {
                        // Hide form and show progress
                        form.closest('.card').slideUp();
                        $('#progressCard').slideDown();
                        $('#backupId').text(response.backup_id);
                        
                        // Start progress monitoring
                        monitorBackupProgress(response.backup_id);
                    } else {
                        alert('Error: ' + response.message);
                        hideLoading(submitBtn[0]);
                    }
                })
                .fail(function(xhr) {
                    let message = 'Failed to create backup';
                    
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        message = xhr.responseJSON.message;
                    }
                    
                    alert('Error: ' + message);
                    hideLoading(submitBtn[0]);
                });
        });
    });
    
    function monitorBackupProgress(backupId) {
        const progressInterval = startProgressMonitoring(backupId, function(data) {
            // Update progress bar
            const percentage = data.progress_percentage || 0;
            $('#progressBar').css('width', percentage + '%');
            $('#progressPercentage').text(percentage + '%');
            
            // Update status
            if (data.current_operation) {
                $('#progressStatus').text(data.current_operation);
            }
            
            // Handle completion
            if (data.status === 'completed') {
                $('#progressBar')
                    .removeClass('progress-bar-striped progress-bar-animated')
                    .addClass('bg-success');
                $('#progressStatus').html(
                    '<i class="fas fa-check-circle text-success me-2"></i>Backup completed successfully!'
                );
                
                // Show success actions
                setTimeout(function() {
                    $('#progressCard .card-body').append(`
                        <div class="alert alert-success mt-3">
                            <i class="fas fa-check-circle me-2"></i>
                            Backup completed successfully! 
                            <a href="/backups/backups/${backupId}/" class="alert-link">View Details</a>
                        </div>
                    `);
                }, 1000);
                
            } else if (data.status === 'failed') {
                $('#progressBar')
                    .removeClass('progress-bar-striped progress-bar-animated')
                    .addClass('bg-danger');
                $('#progressStatus').html(
                    '<i class="fas fa-exclamation-circle text-danger me-2"></i>Backup failed'
                );
                
                if (data.error_message) {
                    $('#progressCard .card-body').append(`
                        <div class="alert alert-danger mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error: ${data.error_message}
                        </div>
                    `);
                }
            }
        });
        
        return progressInterval;
    }
</script>
{% endblock %}