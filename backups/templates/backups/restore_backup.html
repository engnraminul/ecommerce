{% extends 'backups/base.html' %}

{% block title %}Restore Backup - {{ backup.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
        <a href="{% url 'backups:backup_detail' backup.id %}" class="btn btn-outline-secondary me-3">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="h2 mb-0">
            <i class="fas fa-undo me-2"></i>
            Restore Backup
        </h1>
    </div>
</div>

<!-- Backup Information -->
<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Backup Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">Name:</dt>
                            <dd class="col-sm-8">{{ backup.name }}</dd>
                            
                            <dt class="col-sm-4">Type:</dt>
                            <dd class="col-sm-8">
                                <span class="badge bg-secondary">{{ backup.get_backup_type_display }}</span>
                                {% if backup.include_media %}
                                    <span class="badge bg-info">Media</span>
                                {% endif %}
                            </dd>
                            
                            <dt class="col-sm-4">Created:</dt>
                            <dd class="col-sm-8">
                                {{ backup.created_at|date:"F d, Y H:i" }}
                                <small class="text-muted">({{ backup.created_at|timesince }} ago)</small>
                            </dd>
                            
                            <dt class="col-sm-4">Size:</dt>
                            <dd class="col-sm-8">{{ backup.formatted_size }}</dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <dl class="row">
                            {% if backup.total_files %}
                                <dt class="col-sm-4">Files:</dt>
                                <dd class="col-sm-8">{{ backup.total_files|floatformat:0 }}</dd>
                            {% endif %}
                            
                            {% if backup.total_records %}
                                <dt class="col-sm-4">Records:</dt>
                                <dd class="col-sm-8">{{ backup.total_records|floatformat:0 }}</dd>
                            {% endif %}
                            
                            <dt class="col-sm-4">Status:</dt>
                            <dd class="col-sm-8">
                                <span class="status-badge status-{{ backup.status }}">
                                    {{ backup.get_status_display }}
                                </span>
                            </dd>
                        </dl>
                    </div>
                </div>
                
                {% if backup.description %}
                    <hr>
                    <p class="mb-0"><strong>Description:</strong> {{ backup.description }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Restore Form -->
        <form id="restoreForm" method="post" onsubmit="return confirmRestore(event)">
            {% csrf_token %}
            
            <!-- Restore Options -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        Restore Options
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Restore Type -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">What to Restore</label>
                        
                        {% if backup.backup_type == 'full' or backup.backup_type == 'database' %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="restore_database" name="restore_database" checked>
                                <label class="form-check-label" for="restore_database">
                                    <strong>Database</strong>
                                    <small class="text-muted d-block">
                                        Restore all database tables and data
                                    </small>
                                </label>
                            </div>
                        {% endif %}
                        
                        {% if backup.include_media %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="restore_media" name="restore_media" checked>
                                <label class="form-check-label" for="restore_media">
                                    <strong>Media Files</strong>
                                    <small class="text-muted d-block">
                                        Restore uploaded files and media
                                    </small>
                                </label>
                            </div>
                        {% endif %}
                        
                        {% if backup.backup_type == 'media' %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="restore_files" name="restore_files" checked>
                                <label class="form-check-label" for="restore_files">
                                    <strong>Files</strong>
                                    <small class="text-muted d-block">
                                        Restore backed up files
                                    </small>
                                </label>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Restore Mode -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Restore Mode</label>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="radio" 
                                   id="mode_replace" name="restore_mode" value="replace" checked>
                            <label class="form-check-label" for="mode_replace">
                                <strong>Replace All Data</strong>
                                <small class="text-danger d-block">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    This will completely replace current data with backup data
                                </small>
                            </label>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="radio" 
                                   id="mode_merge" name="restore_mode" value="merge">
                            <label class="form-check-label" for="mode_merge">
                                <strong>Merge with Existing Data</strong>
                                <small class="text-muted d-block">
                                    Add backup data without replacing existing records (where possible)
                                </small>
                            </label>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="radio" 
                                   id="mode_selective" name="restore_mode" value="selective">
                            <label class="form-check-label" for="mode_selective">
                                <strong>Selective Restore</strong>
                                <small class="text-muted d-block">
                                    Choose specific models/tables to restore
                                </small>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Selective Models (hidden by default) -->
                    <div id="selective-models" class="mb-4" style="display: none;">
                        <label class="form-label fw-bold">Select Models to Restore</label>
                        <div class="row" id="model-checkboxes">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Safety Options -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Safety Options</label>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                   id="create_pre_restore_backup" name="create_pre_restore_backup" checked>
                            <label class="form-check-label" for="create_pre_restore_backup">
                                <strong>Create Pre-Restore Backup</strong>
                                <small class="text-success d-block">
                                    <i class="fas fa-shield-alt me-1"></i>
                                    Recommended: Create backup before restoring
                                </small>
                            </label>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                   id="verify_before_restore" name="verify_before_restore" checked>
                            <label class="form-check-label" for="verify_before_restore">
                                <strong>Verify Backup Integrity</strong>
                                <small class="text-muted d-block">
                                    Verify backup files before starting restore
                                </small>
                            </label>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                   id="dry_run" name="dry_run">
                            <label class="form-check-label" for="dry_run">
                                <strong>Dry Run</strong>
                                <small class="text-muted d-block">
                                    Test the restore process without making changes
                                </small>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Additional Options -->
                    <div class="mb-4">
                        <label for="restore_description" class="form-label fw-bold">Description (Optional)</label>
                        <textarea class="form-control" id="restore_description" 
                                  name="restore_description" rows="3" 
                                  placeholder="Add a note about this restore operation..."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Restore Actions -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Ready to Restore?</h6>
                            <small class="text-muted">
                                This action will modify your data. Make sure you understand the implications.
                            </small>
                        </div>
                        <div>
                            <a href="{% url 'backups:backup_detail' backup.id %}" 
                               class="btn btn-outline-secondary me-2">
                                Cancel
                            </a>
                            <button type="submit" class="btn btn-danger" id="restoreButton">
                                <i class="fas fa-undo me-2"></i>Start Restore
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Information Sidebar -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                    Important Warnings
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-danger small">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Data Loss Risk:</strong> Restoring will modify or replace your current data. 
                    This action cannot be undone without another backup.
                </div>
                
                <div class="alert alert-warning small">
                    <i class="fas fa-clock me-2"></i>
                    <strong>Downtime:</strong> Your application may be temporarily unavailable 
                    during the restore process.
                </div>
                
                <div class="alert alert-info small">
                    <i class="fas fa-shield-alt me-2"></i>
                    <strong>Safety First:</strong> We strongly recommend creating a pre-restore 
                    backup to allow rollback if needed.
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Restore Process
                </h5>
            </div>
            <div class="card-body">
                <ol class="small mb-0">
                    <li class="mb-2">
                        <strong>Verification:</strong> Check backup integrity and compatibility
                    </li>
                    <li class="mb-2">
                        <strong>Pre-Backup:</strong> Create safety backup of current data
                    </li>
                    <li class="mb-2">
                        <strong>Preparation:</strong> Stop services and prepare database
                    </li>
                    <li class="mb-2">
                        <strong>Restore:</strong> Import backup data with foreign key handling
                    </li>
                    <li class="mb-2">
                        <strong>Verification:</strong> Verify restored data integrity
                    </li>
                    <li class="mb-0">
                        <strong>Completion:</strong> Restart services and finalize
                    </li>
                </ol>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-question-circle me-2"></i>
                    Need Help?
                </h5>
            </div>
            <div class="card-body">
                <p class="small mb-3">
                    If you're unsure about any option or need assistance, 
                    consult your system administrator or review the backup documentation.
                </p>
                
                <div class="d-grid">
                    <button type="button" class="btn btn-outline-primary btn-sm" 
                            onclick="showHelp()">
                        <i class="fas fa-book me-2"></i>View Documentation
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                    Confirm Restore Operation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>WARNING:</strong> This operation will modify your data and cannot be easily undone.
                </div>
                
                <h6>You are about to restore:</h6>
                <ul id="restore-summary" class="mb-3">
                    <!-- Will be populated by JavaScript -->
                </ul>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirm-understanding" required>
                    <label class="form-check-label" for="confirm-understanding">
                        I understand this operation will modify my data and may cause downtime
                    </label>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirm-backup">
                    <label class="form-check-label" for="confirm-backup">
                        I have verified that a recent backup exists or will be created
                    </label>
                </div>
                
                <p class="mb-0 small text-muted">
                    Type <strong>RESTORE</strong> in the box below to confirm:
                </p>
                <input type="text" class="form-control mt-2" id="confirm-text" 
                       placeholder="Type RESTORE to confirm" required>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="button" class="btn btn-danger" id="final-confirm" disabled>
                    <i class="fas fa-undo me-2"></i>Start Restore
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-undo me-2"></i>
                    Restoring Backup
                </h5>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                
                <div class="progress mb-3" style="height: 10px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" id="restore-progress">
                    </div>
                </div>
                
                <div class="text-center">
                    <strong id="restore-status">Preparing restore...</strong>
                    <div class="text-muted mt-1" id="restore-operation">Initializing...</div>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Please do not close this window during the restore process.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Show/hide selective models based on restore mode
        $('input[name="restore_mode"]').change(function() {
            if ($(this).val() === 'selective') {
                $('#selective-models').show();
                loadSelectiveModels();
            } else {
                $('#selective-models').hide();
            }
        });
        
        // Confirmation modal validation
        $('#confirm-text, #confirm-understanding, #confirm-backup').on('input change', function() {
            const textConfirmed = $('#confirm-text').val().toUpperCase() === 'RESTORE';
            const understandingChecked = $('#confirm-understanding').is(':checked');
            const backupChecked = $('#confirm-backup').is(':checked');
            
            $('#final-confirm').prop('disabled', !(textConfirmed && understandingChecked && backupChecked));
        });
        
        // Final confirmation
        $('#final-confirm').click(function() {
            $('#confirmModal').modal('hide');
            startRestore();
        });
        
        // Clear confirmation when modal is hidden
        $('#confirmModal').on('hidden.bs.modal', function() {
            $('#confirm-text').val('');
            $('#confirm-understanding, #confirm-backup').prop('checked', false);
            $('#final-confirm').prop('disabled', true);
        });
    });
    
    function confirmRestore(event) {
        event.preventDefault();
        
        // Build restore summary
        const summary = [];
        
        if ($('#restore_database').is(':checked')) {
            summary.push('Database (all tables and data)');
        }
        if ($('#restore_media').is(':checked')) {
            summary.push('Media files');
        }
        if ($('#restore_files').is(':checked')) {
            summary.push('Files');
        }
        
        const mode = $('input[name="restore_mode"]:checked').val();
        summary.push(`Mode: ${mode.charAt(0).toUpperCase() + mode.slice(1)}`);
        
        if ($('#create_pre_restore_backup').is(':checked')) {
            summary.push('Pre-restore backup will be created');
        }
        
        if ($('#dry_run').is(':checked')) {
            summary.push('Dry run (no actual changes)');
        }
        
        // Populate summary
        const summaryHtml = summary.map(item => `<li>${item}</li>`).join('');
        $('#restore-summary').html(summaryHtml);
        
        // Show confirmation modal
        $('#confirmModal').modal('show');
        
        return false;
    }
    
    function startRestore() {
        // Show progress modal
        $('#progressModal').modal('show');
        
        // Collect form data
        const formData = new FormData($('#restoreForm')[0]);
        
        // Start restore process
        $.ajax({
            url: '{% url "backups:restore_backup" backup.id %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    // Start monitoring restore progress
                    monitorRestoreProgress(response.restore_id);
                } else {
                    alert('Failed to start restore: ' + response.message);
                    $('#progressModal').modal('hide');
                }
            },
            error: function() {
                alert('Failed to start restore operation');
                $('#progressModal').modal('hide');
            }
        });
    }
    
    function monitorRestoreProgress(restoreId) {
        const checkProgress = function() {
            $.get(`/backups/api/restores/${restoreId}/status/`)
                .done(function(data) {
                    // Update progress bar
                    $('#restore-progress').css('width', data.progress_percentage + '%');
                    
                    // Update status
                    $('#restore-status').text(data.status_display || 'Processing...');
                    $('#restore-operation').text(data.current_operation || '');
                    
                    // Continue monitoring if still in progress
                    if (data.status === 'in_progress') {
                        setTimeout(checkProgress, 2000);
                    } else {
                        // Restore completed or failed
                        setTimeout(function() {
                            $('#progressModal').modal('hide');
                            
                            if (data.status === 'completed') {
                                alert('Restore completed successfully!');
                                window.location.href = '{% url "backups:backup_list" %}';
                            } else {
                                alert('Restore failed: ' + (data.error_message || 'Unknown error'));
                            }
                        }, 2000);
                    }
                })
                .fail(function() {
                    setTimeout(checkProgress, 5000); // Retry on failure
                });
        };
        
        checkProgress();
    }
    
    function loadSelectiveModels() {
        $.get(`/backups/api/backups/{{ backup.id }}/models/`)
            .done(function(models) {
                const container = $('#model-checkboxes');
                container.empty();
                
                models.forEach(function(model, index) {
                    const html = `
                        <div class="col-md-6 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" 
                                       id="model_${index}" name="selected_models" 
                                       value="${model.app_label}.${model.model_name}" checked>
                                <label class="form-check-label" for="model_${index}">
                                    <strong>${model.verbose_name}</strong>
                                    <small class="text-muted d-block">
                                        ${model.count} records in backup
                                    </small>
                                </label>
                            </div>
                        </div>
                    `;
                    container.append(html);
                });
            })
            .fail(function() {
                $('#model-checkboxes').html('<p class="text-danger">Failed to load model information</p>');
            });
    }
    
    function showHelp() {
        // In a real implementation, this would show documentation
        alert('Help documentation would be shown here');
    }
</script>
{% endblock %}