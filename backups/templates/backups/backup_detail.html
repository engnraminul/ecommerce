{% extends 'backups/base.html' %}

{% block title %}{{ backup.name }} - Backup Details{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
        <a href="{% url 'backups:backup_list' %}" class="btn btn-outline-secondary me-3">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="h2 mb-0">
            <i class="fas fa-{% if backup.backup_type == 'full' %}database{% elif backup.backup_type == 'database' %}table{% else %}file{% endif %} me-2"></i>
            {{ backup.name }}
        </h1>
    </div>
    
    <div class="btn-group" role="group">
        {% if backup.status == 'completed' and backup.can_restore %}
            <a href="{% url 'backups:restore_backup' backup.id %}" 
               class="btn btn-success">
                <i class="fas fa-undo me-2"></i>Restore
            </a>
        {% endif %}
        
        {% if backup.status == 'completed' %}
            <button class="btn btn-outline-primary" onclick="verifyBackup('{{ backup.id }}')">
                <i class="fas fa-check-circle me-2"></i>Verify
            </button>
        {% endif %}
        
        {% if backup.backup_path %}
            <button class="btn btn-outline-info" onclick="downloadBackup('{{ backup.id }}')">
                <i class="fas fa-download me-2"></i>Download
            </button>
        {% endif %}
        
        <div class="btn-group" role="group">
            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-ellipsis-v"></i>
            </button>
            <ul class="dropdown-menu">
                <li>
                    <a class="dropdown-item text-danger" href="#"
                       onclick="deleteBackup('{{ backup.id }}', '{{ backup.name }}')">
                        <i class="fas fa-trash me-2"></i>Delete Backup
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>

<!-- Status Alert -->
{% if backup.status == 'in_progress' %}
    <div class="alert alert-info d-flex align-items-center" role="alert">
        <div class="spinner-border spinner-border-sm me-3" role="status"></div>
        <div class="flex-grow-1">
            <strong>Backup in Progress</strong>
            <div class="progress mt-2" style="height: 8px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" 
                     style="width: {{ backup.progress_percentage }}%"
                     id="progress-bar">
                </div>
            </div>
            <small class="text-muted mt-1" id="current-operation">{{ backup.current_operation }}</small>
        </div>
    </div>
{% elif backup.status == 'failed' %}
    <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Backup Failed</strong>
        {% if backup.error_message %}
            <div class="mt-2">{{ backup.error_message }}</div>
        {% endif %}
    </div>
{% endif %}

<div class="row">
    <!-- Basic Information -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Basic Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Name:</dt>
                            <dd class="col-sm-8">{{ backup.name }}</dd>
                            
                            <dt class="col-sm-4">Type:</dt>
                            <dd class="col-sm-8">
                                <span class="badge bg-secondary">{{ backup.get_backup_type_display }}</span>
                                {% if backup.include_media %}
                                    <span class="badge bg-info">Media Included</span>
                                {% endif %}
                            </dd>
                            
                            <dt class="col-sm-4">Status:</dt>
                            <dd class="col-sm-8">
                                <span class="status-badge status-{{ backup.status }}">
                                    {{ backup.get_status_display }}
                                </span>
                            </dd>
                            
                            <dt class="col-sm-4">Created:</dt>
                            <dd class="col-sm-8">
                                {{ backup.created_at|date:"F d, Y H:i" }}
                                <small class="text-muted">({{ backup.created_at|timesince }} ago)</small>
                            </dd>
                            
                            {% if backup.completed_at %}
                                <dt class="col-sm-4">Completed:</dt>
                                <dd class="col-sm-8">
                                    {{ backup.completed_at|date:"F d, Y H:i" }}
                                    <small class="text-muted">({{ backup.completed_at|timesince }} ago)</small>
                                </dd>
                            {% endif %}
                        </dl>
                    </div>
                    
                    <div class="col-md-6">
                        <dl class="row mb-0">
                            {% if backup.backup_size %}
                                <dt class="col-sm-4">Size:</dt>
                                <dd class="col-sm-8">
                                    {{ backup.formatted_size }}
                                    {% if backup.compressed_size %}
                                        <br>
                                        <small class="text-muted">
                                            Compressed: {{ backup.formatted_compressed_size }}
                                            ({{ backup.compression_ratio }}% ratio)
                                        </small>
                                    {% endif %}
                                </dd>
                            {% endif %}
                            
                            {% if backup.duration_formatted %}
                                <dt class="col-sm-4">Duration:</dt>
                                <dd class="col-sm-8">{{ backup.duration_formatted }}</dd>
                            {% endif %}
                            
                            {% if backup.total_files %}
                                <dt class="col-sm-4">Files:</dt>
                                <dd class="col-sm-8">{{ backup.total_files|floatformat:0 }}</dd>
                            {% endif %}
                            
                            {% if backup.total_records %}
                                <dt class="col-sm-4">Records:</dt>
                                <dd class="col-sm-8">{{ backup.total_records|floatformat:0 }}</dd>
                            {% endif %}
                            
                            <dt class="col-sm-4">Compression:</dt>
                            <dd class="col-sm-8">
                                {% if backup.compress_backup %}
                                    <span class="text-success">
                                        <i class="fas fa-check me-1"></i>Enabled
                                    </span>
                                {% else %}
                                    <span class="text-muted">
                                        <i class="fas fa-times me-1"></i>Disabled
                                    </span>
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                </div>
                
                {% if backup.description %}
                    <hr>
                    <div>
                        <strong>Description:</strong>
                        <p class="mb-0 mt-2">{{ backup.description }}</p>
                    </div>
                {% endif %}
                
                {% if backup.metadata %}
                    <hr>
                    <div>
                        <strong>Metadata:</strong>
                        <pre class="bg-light p-3 mt-2 small">{{ backup.formatted_metadata }}</pre>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Backup Files -->
        {% if backup.files.exists %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-archive me-2"></i>
                        Backup Files ({{ backup.files.count }})
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>File</th>
                                    <th>Type</th>
                                    <th>Size</th>
                                    <th>Checksum</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for file in backup.files.all %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-file-{% if file.file_type == 'database' %}database{% elif file.file_type == 'media' %}image{% else %}archive{% endif %} me-2 text-muted"></i>
                                            <span title="{{ file.file_path }}">
                                                {{ file.file_name|truncatechars:40 }}
                                            </span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark">{{ file.get_file_type_display }}</span>
                                    </td>
                                    <td>{{ file.formatted_size }}</td>
                                    <td>
                                        <code class="small">{{ file.checksum|truncatechars:12 }}</code>
                                    </td>
                                    <td>
                                        {% if file.is_verified %}
                                            <span class="text-success">
                                                <i class="fas fa-check-circle me-1"></i>Verified
                                            </span>
                                        {% else %}
                                            <span class="text-muted">
                                                <i class="fas fa-question-circle me-1"></i>Unverified
                                            </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- Logs -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list-alt me-2"></i>
                    Backup Logs
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="card-body p-0" id="logs-container">
                {% include 'backups/includes/log_entries.html' %}
            </div>
        </div>
    </div>
    
    <!-- Statistics Sidebar -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Quick Stats
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="text-muted">Progress</span>
                    <span class="fw-bold">{{ backup.progress_percentage|floatformat:1 }}%</span>
                </div>
                <div class="progress mb-3" style="height: 8px;">
                    <div class="progress-bar" 
                         style="width: {{ backup.progress_percentage }}%" 
                         id="stats-progress">
                    </div>
                </div>
                
                {% if backup.backup_size %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Total Size</span>
                        <span>{{ backup.formatted_size }}</span>
                    </div>
                {% endif %}
                
                {% if backup.compressed_size %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Compressed</span>
                        <span class="text-success">{{ backup.formatted_compressed_size }}</span>
                    </div>
                {% endif %}
                
                {% if backup.total_files %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Files</span>
                        <span>{{ backup.total_files|floatformat:0 }}</span>
                    </div>
                {% endif %}
                
                {% if backup.total_records %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Records</span>
                        <span>{{ backup.total_records|floatformat:0 }}</span>
                    </div>
                {% endif %}
                
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted">Log Entries</span>
                    <span>{{ backup.logs.count }}</span>
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if backup.status == 'completed' %}
                        {% if backup.can_restore %}
                            <a href="{% url 'backups:restore_backup' backup.id %}" 
                               class="btn btn-success">
                                <i class="fas fa-undo me-2"></i>Restore Backup
                            </a>
                        {% endif %}
                        
                        <button class="btn btn-outline-primary" onclick="verifyBackup('{{ backup.id }}')">
                            <i class="fas fa-check-circle me-2"></i>Verify Integrity
                        </button>
                        
                        {% if backup.backup_path %}
                            <button class="btn btn-outline-info" onclick="downloadBackup('{{ backup.id }}')">
                                <i class="fas fa-download me-2"></i>Download
                            </button>
                        {% endif %}
                    {% endif %}
                    
                    {% if backup.status == 'in_progress' %}
                        <button class="btn btn-outline-warning" disabled>
                            <i class="fas fa-spinner fa-spin me-2"></i>In Progress
                        </button>
                    {% endif %}
                    
                    <hr>
                    
                    <button class="btn btn-outline-danger" 
                            onclick="deleteBackup('{{ backup.id }}', '{{ backup.name }}')">
                        <i class="fas fa-trash me-2"></i>Delete Backup
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Information -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Information
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info small mb-3">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Tip:</strong> Regular backups help ensure your data is safe. 
                    Consider setting up automated backups for critical data.
                </div>
                
                {% if backup.backup_path %}
                    <div class="mb-3">
                        <small class="text-muted d-block">Backup Location:</small>
                        <code class="small">{{ backup.backup_path|truncatechars:60 }}</code>
                    </div>
                {% endif %}
                
                {% if backup.checksum %}
                    <div class="mb-3">
                        <small class="text-muted d-block">Checksum (SHA-256):</small>
                        <code class="small">{{ backup.checksum|truncatechars:20 }}...</code>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the backup "<strong id="deleteBackupName"></strong>"?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    This action cannot be undone. All backup files will be permanently deleted.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete Backup</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let backupId = '{{ backup.id }}';
    let backupToDelete = null;
    
    $(document).ready(function() {
        // Start monitoring if backup is in progress
        {% if backup.status == 'in_progress' %}
            startProgressMonitoring(backupId, function(data) {
                // Update progress bar
                $('#progress-bar, #stats-progress').css('width', data.progress_percentage + '%');
                
                // Update current operation
                $('#current-operation').text(data.current_operation || '');
                
                // If completed or failed, reload the page
                if (data.status === 'completed' || data.status === 'failed') {
                    location.reload();
                }
            });
        {% endif %}
        
        // Handle delete confirmation
        $('#confirmDelete').click(function() {
            if (backupToDelete) {
                $(this).prop('disabled', true).html(
                    '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...'
                );
                
                // In a real implementation, make AJAX call to delete
                setTimeout(function() {
                    alert('Backup deletion functionality would be implemented here');
                    // Redirect to backup list
                    window.location.href = '{% url "backups:backup_list" %}';
                }, 2000);
            }
        });
        
        $('#deleteModal').on('hidden.bs.modal', function() {
            backupToDelete = null;
        });
    });
    
    function refreshLogs() {
        const button = event.target.closest('button');
        const originalHtml = button.innerHTML;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        
        $.get(`/backups/${backupId}/logs/`)
            .done(function(html) {
                $('#logs-container').html(html);
            })
            .fail(function() {
                alert('Failed to refresh logs');
            })
            .always(function() {
                button.innerHTML = originalHtml;
            });
    }
    
    function verifyBackup(backupId) {
        const button = event.target.closest('button');
        const originalHtml = button.innerHTML;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Verifying...';
        button.disabled = true;
        
        $.post(`/backups/api/backups/${backupId}/verify/`)
            .done(function(response) {
                if (response.success) {
                    alert('Backup verification completed successfully!');
                    location.reload();
                } else {
                    alert('Backup verification failed: ' + response.message);
                }
            })
            .fail(function() {
                alert('Verification request failed');
            })
            .always(function() {
                button.innerHTML = originalHtml;
                button.disabled = false;
            });
    }
    
    function downloadBackup(backupId) {
        $.get(`/backups/api/backups/${backupId}/download/`)
            .done(function(response) {
                alert(`Download would start for: ${response.filename} (${formatBytes(response.size)})`);
            })
            .fail(function() {
                alert('Download information not available');
            });
    }
    
    function deleteBackup(backupId, backupName) {
        backupToDelete = backupId;
        $('#deleteBackupName').text(backupName);
        $('#deleteModal').modal('show');
    }
</script>
{% endblock %}