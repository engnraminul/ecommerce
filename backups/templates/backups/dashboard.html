{% extends "dashboard/base.html" %}
{% load static %}

{% block extra_css %}
<style>
    .backup-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .status-pending { background-color: #fff3cd; color: #856404; }
    .status-creating { background-color: #cce7ff; color: #004085; }
    .status-completed { background-color: #d4edda; color: #155724; }
    .status-failed { background-color: #f8d7da; color: #721c24; }
    .status-restoring { background-color: #cce7ff; color: #004085; }
    .status-restored { background-color: #e2e3e5; color: #383d41; }
    
    .backup-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    
    .backup-actions .btn {
        flex: 1;
        text-align: center;
    }
    
    .upload-area {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        background: #f9f9f9;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .upload-area:hover {
        border-color: #007bff;
        background: #f0f8ff;
    }
    
    .upload-area.dragover {
        border-color: #28a745;
        background: #f0fff0;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9em;
        margin-top: 5px;
    }
    
    .backup-list {
        max-height: 600px;
        overflow-y: auto;
    }
    
    .modal-backdrop {
        z-index: 1040;
    }
    
    .modal {
        z-index: 1050;
    }
    
    .progress {
        height: 20px;
        margin: 10px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="page-header d-flex justify-content-between align-items-center">
                <h1>Backup Management</h1>
                <div>
                    <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#createBackupModal">
                        <i class="fas fa-plus"></i> Create Backup
                    </button>
                    <button type="button" class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#uploadBackupModal">
                        <i class="fas fa-upload"></i> Upload Backup
                    </button>
                    <button type="button" class="btn btn-warning" onclick="cleanupOldBackups()">
                        <i class="fas fa-broom"></i> Cleanup
                    </button>
                </div>
            </div>
            
            <!-- Statistics -->
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be loaded here -->
            </div>
            
            <!-- Backup List -->
            <div class="backup-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Backups</h3>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="typeFilter" onchange="loadBackups()">
                            <option value="">All Types</option>
                            <option value="database">Database Only</option>
                            <option value="media">Media Only</option>
                            <option value="full">Full Backup</option>
                        </select>
                        <select class="form-select form-select-sm" id="statusFilter" onchange="loadBackups()">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="creating">Creating</option>
                            <option value="completed">Completed</option>
                            <option value="failed">Failed</option>
                        </select>
                        <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="Search backups..." onkeyup="debounceSearch()">
                    </div>
                </div>
                
                <div class="backup-list" id="backupList">
                    <!-- Backup items will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Backup Modal -->
<div class="modal fade" id="createBackupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="createBackupForm">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Backup</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="backupName" class="form-label">Backup Name (Optional)</label>
                        <input type="text" class="form-control" id="backupName" placeholder="Leave empty for auto-generated name">
                    </div>
                    <div class="mb-3">
                        <label for="backupType" class="form-label">Backup Type</label>
                        <select class="form-select" id="backupType" required>
                            <option value="full">Full Backup (Database + Media)</option>
                            <option value="database">Database Only</option>
                            <option value="media">Media Files Only</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <strong>Note:</strong> Creating a backup may take several minutes depending on your data size.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Backup</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Upload Backup Modal -->
<div class="modal fade" id="uploadBackupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="uploadBackupForm" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Backup File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="uploadName" class="form-label">Backup Name (Optional)</label>
                        <input type="text" class="form-control" id="uploadName" placeholder="Leave empty for auto-generated name">
                    </div>
                    <div class="mb-3">
                        <label for="uploadType" class="form-label">Backup Type</label>
                        <select class="form-select" id="uploadType" required>
                            <option value="full">Full Backup</option>
                            <option value="database">Database Only</option>
                            <option value="media">Media Files Only</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Backup File</label>
                        <div class="upload-area" id="uploadArea" onclick="document.getElementById('backupFile').click()">
                            <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                            <p class="mb-0">Click to select file or drag and drop</p>
                            <small class="text-muted">Max file size: 5GB</small>
                            <input type="file" id="backupFile" style="display: none;" accept=".sql,.zip,.gz,.tar" required>
                        </div>
                        <div id="uploadProgress" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted">Uploading...</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Restore Confirmation Modal -->
<div class="modal fade" id="restoreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">Restore Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <strong>Warning:</strong> Restoring a backup will replace your current data. This action cannot be undone.
                </div>
                <p>Are you sure you want to restore the backup: <strong id="restoreBackupName"></strong>?</p>
                <div class="mb-3">
                    <label for="restoreType" class="form-label">Restore Type</label>
                    <select class="form-select" id="restoreType">
                        <option value="">Same as backup</option>
                        <option value="database">Database Only</option>
                        <option value="media">Media Only</option>
                        <option value="full">Full Restore</option>
                    </select>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="validateOnly">
                    <label class="form-check-label" for="validateOnly">
                        Validate only (don't actually restore)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="confirmRestore()">Restore</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let currentBackupId = null;
let searchTimeout = null;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadBackups();
    setupEventListeners();
    
    // Auto-refresh every 30 seconds
    setInterval(() => {
        loadStats();
        loadBackups();
    }, 30000);
});

function setupEventListeners() {
    // File upload drag and drop
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('backupFile');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
    });
    
    uploadArea.addEventListener('drop', handleDrop, false);
    
    fileInput.addEventListener('change', function() {
        const fileName = this.files[0] ? this.files[0].name : 'No file selected';
        uploadArea.querySelector('p').textContent = fileName;
    });
    
    // Form submissions
    document.getElementById('createBackupForm').addEventListener('submit', handleCreateBackup);
    document.getElementById('uploadBackupForm').addEventListener('submit', handleUploadBackup);
}

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function highlight() {
    document.getElementById('uploadArea').classList.add('dragover');
}

function unhighlight() {
    document.getElementById('uploadArea').classList.remove('dragover');
}

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    if (files.length > 0) {
        document.getElementById('backupFile').files = files;
        document.getElementById('uploadArea').querySelector('p').textContent = files[0].name;
    }
}

async function loadStats() {
    try {
        const response = await fetch('/backups/api/backups/stats/');
        const data = await response.json();
        
        const statsHtml = `
            <div class="stat-card">
                <div class="stat-number">${data.total_backups}</div>
                <div class="stat-label">Total Backups</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${data.completed_backups}</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${data.failed_backups}</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">${data.formatted_total_size}</div>
                <div class="stat-label">Total Size</div>
            </div>
        `;
        
        document.getElementById('statsGrid').innerHTML = statsHtml;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function loadBackups() {
    try {
        const params = new URLSearchParams();
        
        const typeFilter = document.getElementById('typeFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const search = document.getElementById('searchInput').value;
        
        if (typeFilter) params.append('backup_type', typeFilter);
        if (statusFilter) params.append('status', statusFilter);
        if (search) params.append('search', search);
        
        const response = await fetch(`/backups/api/backups/?${params.toString()}`);
        const data = await response.json();
        
        const backupListHtml = data.results.map(backup => `
            <div class="backup-card">
                <div class="row">
                    <div class="col-md-8">
                        <h5>${backup.name}</h5>
                        <div class="mb-2">
                            <span class="badge bg-primary me-2">${backup.backup_type.toUpperCase()}</span>
                            <span class="status-badge status-${backup.status}">${backup.status_badge.text}</span>
                        </div>
                        <small class="text-muted">
                            Created: ${new Date(backup.created_at).toLocaleString()} by ${backup.created_by_name}
                            ${backup.completed_at ? `| Completed: ${new Date(backup.completed_at).toLocaleString()}` : ''}
                        </small>
                        <br>
                        <small class="text-muted">Size: ${backup.formatted_size} | Restored: ${backup.restoration_count} times</small>
                    </div>
                    <div class="col-md-4">
                        <div class="backup-actions">
                            ${backup.can_download ? `
                                <button class="btn btn-sm btn-outline-primary" onclick="downloadBackup(${backup.id})">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            ` : ''}
                            ${backup.can_restore ? `
                                <button class="btn btn-sm btn-outline-warning" onclick="showRestoreModal(${backup.id}, '${backup.name}')">
                                    <i class="fas fa-undo"></i> Restore
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteBackup(${backup.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
                ${backup.error_message ? `<div class="alert alert-danger mt-2 mb-0"><small>${backup.error_message}</small></div>` : ''}
            </div>
        `).join('');
        
        document.getElementById('backupList').innerHTML = backupListHtml || '<p class="text-muted text-center">No backups found.</p>';
    } catch (error) {
        console.error('Error loading backups:', error);
        document.getElementById('backupList').innerHTML = '<p class="text-danger text-center">Error loading backups.</p>';
    }
}

function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(loadBackups, 500);
}

async function handleCreateBackup(e) {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('backupName').value,
        backup_type: document.getElementById('backupType').value
    };
    
    try {
        const response = await fetch('/backups/api/backups/create_backup/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('createBackupModal')).hide();
            document.getElementById('createBackupForm').reset();
            showAlert('Backup creation started successfully!', 'success');
            loadBackups();
            loadStats();
        } else {
            const error = await response.json();
            showAlert('Error creating backup: ' + (error.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        console.error('Error creating backup:', error);
        showAlert('Error creating backup: ' + error.message, 'danger');
    }
}

async function handleUploadBackup(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('name', document.getElementById('uploadName').value);
    formData.append('backup_type', document.getElementById('uploadType').value);
    formData.append('file', document.getElementById('backupFile').files[0]);
    
    try {
        const progressDiv = document.getElementById('uploadProgress');
        const progressBar = progressDiv.querySelector('.progress-bar');
        
        progressDiv.style.display = 'block';
        
        const response = await fetch('/backups/api/backups/upload/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('uploadBackupModal')).hide();
            document.getElementById('uploadBackupForm').reset();
            document.getElementById('uploadArea').querySelector('p').textContent = 'Click to select file or drag and drop';
            progressDiv.style.display = 'none';
            showAlert('Backup uploaded successfully!', 'success');
            loadBackups();
            loadStats();
        } else {
            const error = await response.json();
            showAlert('Error uploading backup: ' + (error.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        console.error('Error uploading backup:', error);
        showAlert('Error uploading backup: ' + error.message, 'danger');
    }
}

function showRestoreModal(backupId, backupName) {
    currentBackupId = backupId;
    document.getElementById('restoreBackupName').textContent = backupName;
    new bootstrap.Modal(document.getElementById('restoreModal')).show();
}

async function confirmRestore() {
    if (!currentBackupId) return;
    
    const restoreData = {
        restore_type: document.getElementById('restoreType').value,
        validate_only: document.getElementById('validateOnly').checked
    };
    
    try {
        // Show loading state
        const restoreButton = document.querySelector('#restoreModal .btn-warning');
        const originalText = restoreButton.textContent;
        restoreButton.textContent = restoreData.validate_only ? 'Validating...' : 'Restoring...';
        restoreButton.disabled = true;
        
        const response = await fetch(`/backups/api/backups/${currentBackupId}/restore/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(restoreData)
        });
        
        // Reset button state
        restoreButton.textContent = originalText;
        restoreButton.disabled = false;
        
        if (response.ok) {
            const result = await response.json();
            bootstrap.Modal.getInstance(document.getElementById('restoreModal')).hide();
            
            if (result.success) {
                showAlert('Restore completed successfully! ' + (result.validation_notes || ''), 'success');
            } else if (restoreData.validate_only) {
                if (result.validation_passed) {
                    showAlert('Validation passed: ' + (result.validation_notes || 'Backup is ready for restore'), 'success');
                } else {
                    showAlert('Validation failed: ' + (result.validation_notes || 'Unknown validation error'), 'warning');
                }
            } else {
                showAlert('Restore failed: ' + (result.error_message || 'Check restore logs for details'), 'danger');
            }
            
            loadBackups();
            loadStats();
        } else {
            const error = await response.json();
            showAlert('Error during restore: ' + (error.error || error.detail || 'Unknown error'), 'danger');
        }
    } catch (error) {
        console.error('Error during restore:', error);
        showAlert('Network error during restore: ' + error.message, 'danger');
        
        // Reset button state on error
        const restoreButton = document.querySelector('#restoreModal .btn-warning');
        restoreButton.textContent = 'Restore';
        restoreButton.disabled = false;
    }
}

function downloadBackup(backupId) {
    window.open(`/backups/api/backups/${backupId}/download/`, '_blank');
}

async function deleteBackup(backupId) {
    if (!confirm('Are you sure you want to delete this backup? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/backups/api/backups/${backupId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        if (response.ok) {
            showAlert('Backup deleted successfully!', 'success');
            loadBackups();
            loadStats();
        } else {
            showAlert('Error deleting backup', 'danger');
        }
    } catch (error) {
        console.error('Error deleting backup:', error);
        showAlert('Error deleting backup: ' + error.message, 'danger');
    }
}

async function cleanupOldBackups() {
    const days = prompt('Delete backups older than how many days?', '30');
    if (!days || isNaN(days)) return;
    
    try {
        const response = await fetch('/backups/api/backups/cleanup/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ retention_days: parseInt(days) })
        });
        
        if (response.ok) {
            const result = await response.json();
            showAlert(result.message, 'success');
            loadBackups();
            loadStats();
        } else {
            const error = await response.json();
            showAlert('Error during cleanup: ' + (error.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        console.error('Error during cleanup:', error);
        showAlert('Error during cleanup: ' + error.message, 'danger');
    }
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.container-fluid').firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}