{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block page_title %}Contact Management{% endblock %}

{% block extra_css %}
<style>
    .contact-card {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        transition: all 0.3s ease;
        background: white;
    }
    
    .contact-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .status-new { background-color: #e3f2fd; color: #1976d2; }
    .status-in-progress { background-color: #fff3e0; color: #f57c00; }
    .status-resolved { background-color: #e8f5e8; color: #388e3c; }
    .status-closed { background-color: #f3e5f5; color: #7b1fa2; }
    
    .priority-high { border-left: 4px solid #f44336; }
    .priority-medium { border-left: 4px solid #ff9800; }
    .priority-low { border-left: 4px solid #4caf50; }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
    }
    
    .filter-controls {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }
    
    .contact-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }
    
    .contact-message {
        max-height: 100px;
        overflow-y: auto;
        background: #f8f9fa;
        padding: 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.9rem;
    }
    
    .attachment-link {
        color: #0d6efd;
        text-decoration: none;
    }
    
    .attachment-link:hover {
        text-decoration: underline;
    }
    
    @media (max-width: 768px) {
        .contact-actions {
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .contact-actions .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h3 mb-0">
        <i class="fas fa-envelope-open-text me-2"></i>
        Contact Management
    </h2>
    <div>
        <button class="btn btn-outline-primary me-2" id="refreshBtn">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#bulkActionsModal">
            <i class="fas fa-tasks"></i> Bulk Actions
        </button>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="stats-card">
            <div class="h4 mb-0" id="totalContacts">-</div>
            <small>Total Contacts</small>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stats-card">
            <div class="h4 mb-0" id="newContacts">-</div>
            <small>New Messages</small>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stats-card">
            <div class="h4 mb-0" id="inProgressContacts">-</div>
            <small>In Progress</small>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="stats-card">
            <div class="h4 mb-0" id="resolvedContacts">-</div>
            <small>Resolved</small>
        </div>
    </div>
</div>

<!-- Filter Controls -->
<div class="filter-controls">
    <div class="row align-items-end">
        <div class="col-md-3">
            <label for="statusFilter" class="form-label">Status</label>
            <select class="form-select" id="statusFilter">
                <option value="">All Statuses</option>
                <option value="new">New</option>
                <option value="in_progress">In Progress</option>
                <option value="resolved">Resolved</option>
                <option value="closed">Closed</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="priorityFilter" class="form-label">Priority</label>
            <select class="form-select" id="priorityFilter">
                <option value="">All Priorities</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="assignedFilter" class="form-label">Assigned To</label>
            <select class="form-select" id="assignedFilter">
                <option value="">All Assignments</option>
                <!-- Dynamic options will be populated by JavaScript -->
            </select>
        </div>
        <div class="col-md-3">
            <label for="searchInput" class="form-label">Search</label>
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search contacts...">
                <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div class="text-center my-5" id="loadingSpinner">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading contacts...</p>
</div>

<!-- Contacts List -->
<div id="contactsList" class="row" style="display: none;">
    <!-- Contacts will be loaded here by JavaScript -->
</div>

<!-- Pagination -->
<nav aria-label="Contacts pagination" id="paginationContainer" style="display: none;">
    <ul class="pagination justify-content-center">
        <!-- Pagination will be loaded here by JavaScript -->
    </ul>
</nav>

<!-- Contact Detail Modal -->
<div class="modal fade" id="contactDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Contact Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="contactDetailBody">
                <!-- Contact details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveContactBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions Modal -->
<div class="modal fade" id="bulkActionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Actions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="bulkAction" class="form-label">Select Action</label>
                    <select class="form-select" id="bulkAction">
                        <option value="">Choose action...</option>
                        <option value="mark_read">Mark as Read</option>
                        <option value="mark_in_progress">Mark as In Progress</option>
                        <option value="mark_resolved">Mark as Resolved</option>
                        <option value="assign">Assign to User</option>
                        <option value="delete">Delete</option>
                    </select>
                </div>
                <div class="mb-3" id="assignUserDiv" style="display: none;">
                    <label for="assignUser" class="form-label">Assign to</label>
                    <select class="form-select" id="assignUser">
                        <!-- Users will be populated by JavaScript -->
                    </select>
                </div>
                <div class="alert alert-info">
                    <strong>Selected contacts:</strong> <span id="selectedCount">0</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="executeBulkAction">Execute Action</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let currentPage = 1;
    let selectedContacts = new Set();
    
    // Load initial data
    loadContacts();
    loadStatistics();
    loadUsers();
    
    // Event listeners
    $('#statusFilter, #priorityFilter, #assignedFilter').change(function() {
        currentPage = 1;
        loadContacts();
    });
    
    $('#searchInput').on('input', debounce(function() {
        currentPage = 1;
        loadContacts();
    }, 500));
    
    $('#clearSearch').click(function() {
        $('#searchInput').val('');
        currentPage = 1;
        loadContacts();
    });
    
    $('#refreshBtn').click(function() {
        loadContacts();
        loadStatistics();
    });
    
    $('#bulkAction').change(function() {
        if ($(this).val() === 'assign') {
            $('#assignUserDiv').show();
        } else {
            $('#assignUserDiv').hide();
        }
    });
    
    $('#executeBulkAction').click(function() {
        executeBulkAction();
    });
    
    $('#saveContactBtn').click(function() {
        saveContactDetails();
    });
    
    // Load contacts function
    function loadContacts() {
        $('#loadingSpinner').show();
        $('#contactsList').hide();
        $('#paginationContainer').hide();
        
        const params = {
            page: currentPage,
            status: $('#statusFilter').val(),
            priority: $('#priorityFilter').val(),
            assigned_to: $('#assignedFilter').val(),
            search: $('#searchInput').val()
        };
        
        $.get('/contact/api/dashboard/', params)
            .done(function(data) {
                displayContacts(data.results);
                displayPagination(data);
                $('#loadingSpinner').hide();
                $('#contactsList').show();
                if (data.count > 0) {
                    $('#paginationContainer').show();
                }
            })
            .fail(function() {
                showAlert('Error loading contacts', 'danger');
                $('#loadingSpinner').hide();
            });
    }
    
    // Display contacts function
    function displayContacts(contacts) {
        const container = $('#contactsList');
        container.empty();
        
        if (contacts.length === 0) {
            container.html(`
                <div class="col-12">
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No contacts found</h5>
                        <p class="text-muted">No contacts match your current filters.</p>
                    </div>
                </div>
            `);
            return;
        }
        
        contacts.forEach(contact => {
            const contactCard = createContactCard(contact);
            container.append(contactCard);
        });
    }
    
    // Create contact card function
    function createContactCard(contact) {
        const statusClass = `status-${contact.status.replace('_', '-')}`;
        const priorityClass = `priority-${contact.priority}`;
        const attachmentHtml = contact.attachment ? 
            `<a href="${contact.attachment}" class="attachment-link" target="_blank">
                <i class="fas fa-paperclip"></i> View Attachment
            </a>` : '';
        
        return `
            <div class="col-lg-6 col-xl-4 mb-4">
                <div class="contact-card ${priorityClass} h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="form-check">
                                <input class="form-check-input contact-checkbox" type="checkbox" 
                                       value="${contact.id}" id="contact_${contact.id}">
                                <label class="form-check-label fw-bold" for="contact_${contact.id}">
                                    ${contact.name}
                                </label>
                            </div>
                            <span class="status-badge ${statusClass}">${contact.status_display}</span>
                        </div>
                        
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-envelope"></i> ${contact.email}
                            </small>
                        </div>
                        
                        ${contact.phone ? `
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-phone"></i> ${contact.phone}
                            </small>
                        </div>
                        ` : ''}
                        
                        <div class="mb-3">
                            <strong class="d-block mb-1">${contact.subject}</strong>
                            <div class="contact-message">${contact.message}</div>
                        </div>
                        
                        ${attachmentHtml}
                        
                        <div class="mt-3 pt-3 border-top">
                            <div class="row align-items-center">
                                <div class="col">
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> ${formatDate(contact.submitted_at)}
                                    </small>
                                    ${contact.assigned_to ? `
                                    <br><small class="text-muted">
                                        <i class="fas fa-user"></i> Assigned to ${contact.assigned_to_name}
                                    </small>
                                    ` : ''}
                                </div>
                                <div class="col-auto">
                                    <div class="contact-actions">
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="viewContact(${contact.id})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" 
                                                onclick="replyContact(${contact.id})">
                                            <i class="fas fa-reply"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Load statistics function
    function loadStatistics() {
        $.get('/contact/api/dashboard/statistics/')
            .done(function(data) {
                $('#totalContacts').text(data.total);
                $('#newContacts').text(data.new);
                $('#inProgressContacts').text(data.in_progress);
                $('#resolvedContacts').text(data.resolved);
            });
    }
    
    // Load users function
    function loadUsers() {
        $.get('/contact/api/dashboard/users/')
            .done(function(data) {
                const assignedFilter = $('#assignedFilter');
                const assignUser = $('#assignUser');
                
                data.forEach(user => {
                    assignedFilter.append(`<option value="${user.id}">${user.username}</option>`);
                    assignUser.append(`<option value="${user.id}">${user.username}</option>`);
                });
            });
    }
    
    // View contact function
    window.viewContact = function(contactId) {
        $.get(`/contact/api/dashboard/${contactId}/`)
            .done(function(contact) {
                displayContactDetails(contact);
                $('#contactDetailModal').modal('show');
            })
            .fail(function() {
                showAlert('Error loading contact details', 'danger');
            });
    };
    
    // Display contact details function
    function displayContactDetails(contact) {
        const attachmentHtml = contact.attachment ? 
            `<a href="${contact.attachment}" class="btn btn-sm btn-outline-primary" target="_blank">
                <i class="fas fa-download"></i> Download Attachment
            </a>` : 'No attachment';
        
        $('#contactDetailBody').html(`
            <div class="row">
                <div class="col-md-6">
                    <h6>Contact Information</h6>
                    <p><strong>Name:</strong> ${contact.name}</p>
                    <p><strong>Email:</strong> ${contact.email}</p>
                    <p><strong>Phone:</strong> ${contact.phone || 'Not provided'}</p>
                    <p><strong>Subject:</strong> ${contact.subject}</p>
                    <p><strong>Attachment:</strong> ${attachmentHtml}</p>
                </div>
                <div class="col-md-6">
                    <h6>Status & Assignment</h6>
                    <div class="mb-3">
                        <label for="detailStatus" class="form-label">Status</label>
                        <select class="form-select" id="detailStatus">
                            <option value="new" ${contact.status === 'new' ? 'selected' : ''}>New</option>
                            <option value="in_progress" ${contact.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                            <option value="resolved" ${contact.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                            <option value="closed" ${contact.status === 'closed' ? 'selected' : ''}>Closed</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="detailPriority" class="form-label">Priority</label>
                        <select class="form-select" id="detailPriority">
                            <option value="low" ${contact.priority === 'low' ? 'selected' : ''}>Low</option>
                            <option value="medium" ${contact.priority === 'medium' ? 'selected' : ''}>Medium</option>
                            <option value="high" ${contact.priority === 'high' ? 'selected' : ''}>High</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="detailAssigned" class="form-label">Assigned To</label>
                        <select class="form-select" id="detailAssigned">
                            <option value="">Unassigned</option>
                            <!-- Users will be populated -->
                        </select>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Message</h6>
                    <div class="border p-3 rounded bg-light">
                        ${contact.message}
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Admin Notes</h6>
                    <textarea class="form-control" id="detailAdminNotes" rows="3" 
                              placeholder="Add internal notes...">${contact.admin_notes || ''}</textarea>
                </div>
            </div>
        `);
        
        // Populate assigned user dropdown
        const detailAssigned = $('#detailAssigned');
        $('#assignUser option').each(function() {
            const option = $(this).clone();
            if ($(this).val() == contact.assigned_to) {
                option.attr('selected', 'selected');
            }
            detailAssigned.append(option);
        });
        
        // Store contact ID for saving
        $('#saveContactBtn').data('contact-id', contact.id);
    }
    
    // Save contact details function
    function saveContactDetails() {
        const contactId = $('#saveContactBtn').data('contact-id');
        const data = {
            status: $('#detailStatus').val(),
            priority: $('#detailPriority').val(),
            assigned_to: $('#detailAssigned').val() || null,
            admin_notes: $('#detailAdminNotes').val()
        };
        
        $.ajax({
            url: `/contact/api/dashboard/${contactId}/`,
            method: 'PATCH',
            data: data,
            success: function() {
                showAlert('Contact updated successfully', 'success');
                $('#contactDetailModal').modal('hide');
                loadContacts();
                loadStatistics();
            },
            error: function() {
                showAlert('Error updating contact', 'danger');
            }
        });
    }
    
    // Execute bulk action function
    function executeBulkAction() {
        const action = $('#bulkAction').val();
        const selectedIds = Array.from(selectedContacts);
        
        if (!action || selectedIds.length === 0) {
            showAlert('Please select an action and contacts', 'warning');
            return;
        }
        
        let data = { ids: selectedIds, action: action };
        
        if (action === 'assign') {
            const userId = $('#assignUser').val();
            if (!userId) {
                showAlert('Please select a user to assign', 'warning');
                return;
            }
            data.assigned_to = userId;
        }
        
        $.ajax({
            url: '/contact/api/dashboard/bulk_actions/',
            method: 'POST',
            data: data,
            success: function(response) {
                showAlert(`${response.updated} contacts updated successfully`, 'success');
                $('#bulkActionsModal').modal('hide');
                selectedContacts.clear();
                loadContacts();
                loadStatistics();
            },
            error: function() {
                showAlert('Error executing bulk action', 'danger');
            }
        });
    }
    
    // Utility functions
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }
    
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    function showAlert(message, type) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        // Remove existing alerts
        $('.alert').remove();
        
        // Add new alert at the top of the content
        $('.content').prepend(alertHtml);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            $('.alert').alert('close');
        }, 5000);
    }
    
    // Handle contact selection
    $(document).on('change', '.contact-checkbox', function() {
        const contactId = parseInt($(this).val());
        if ($(this).is(':checked')) {
            selectedContacts.add(contactId);
        } else {
            selectedContacts.delete(contactId);
        }
        $('#selectedCount').text(selectedContacts.size);
    });
    
    // Display pagination function
    function displayPagination(data) {
        const container = $('#paginationContainer ul');
        container.empty();
        
        const totalPages = Math.ceil(data.count / 12); // Assuming 12 items per page
        
        if (totalPages <= 1) {
            $('#paginationContainer').hide();
            return;
        }
        
        // Previous button
        if (data.previous) {
            container.append(`
                <li class="page-item">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
                </li>
            `);
        }
        
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            const activeClass = i === currentPage ? 'active' : '';
            container.append(`
                <li class="page-item ${activeClass}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>
            `);
        }
        
        // Next button
        if (data.next) {
            container.append(`
                <li class="page-item">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
                </li>
            `);
        }
    }
    
    // Change page function
    window.changePage = function(page) {
        currentPage = page;
        loadContacts();
    };
});
</script>
{% endblock %}